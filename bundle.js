(()=>{var Ti=[0,.25,.5,.75,1],_i=[0,.05,.15,.25,.5],Li={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",assffect:"sounds/spell/asseffect.wav"},io={menu:"music/mm.mp3",game:"sounds/amb1.wav"},co="soundSettings";function Bi(){try{let e=localStorage.getItem(co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ri(e){try{localStorage.setItem(co,JSON.stringify(e))}catch(o){console.debug("Failed to save sound settings:",o)}}function ao(){return{audioContext:null,buffers:{},settings:Bi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let o=window.AudioContext||window.webkitAudioContext;this.audioContext=new o,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(o){console.debug("Failed to create AudioContext:",o)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(o){console.debug("Failed to resume AudioContext:",o)}if(!this.unlocked&&this.audioContext.state==="running"){let o=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=o,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Ti[this.settings.soundVolume]},getMusicVolume(){return _i[this.settings.musicVolume]},async loadSound(o,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(l)).arrayBuffer(),i=await this.audioContext.decodeAudioData(c);this.buffers[o]=i}catch(d){console.debug(`Failed to load sound: ${o} from ${l}`,d)}},preload(){this.initContext();for(let[o,l]of Object.entries(Li))this.loadSound(o,l)},play(o,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=o;l!==null&&(d=`${o}${l}`);let c=this.buffers[d];if(c)try{let i=this.audioContext.createGain();i.gain.value=this.getSoundVolume(),i.connect(this.audioContext.destination);let a=this.audioContext.createBufferSource();a.buffer=c,a.connect(i),a.start(0),a.onended=()=>{a.disconnect(),i.disconnect()}}catch(i){console.debug("Sound play failed:",i)}},playRandom(o){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(o,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(io.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(o){console.debug("Menu music start failed:",o)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(io.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(o){console.debug("Game music start failed:",o)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(o){console.debug("Stop music failed:",o)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(o){if(this.settings={...this.settings,...o},Ri(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var ro="eb_highscore",lo="eb_highscore_quick",uo="eb_settings",go="eb_high_tower_rings",Ai={invertSwipe:!1,difficulty:"easy"};function mo(){return{loadHighscore(e="30_24"){try{let o=e==="25_20"?lo:ro,l=localStorage.getItem(o);if(l)return JSON.parse(l)}catch(o){console.debug("Failed to load highscore:",o)}return{score:0,time:0}},saveHighscore(e,o,l="30_24"){try{let d=this.loadHighscore(l);if(e>d.score||e===d.score&&o>d.time){let c=l==="25_20"?lo:ro;return localStorage.setItem(c,JSON.stringify({score:e,time:o})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(uo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Ai}},saveGameSettings(e){try{localStorage.setItem(uo,JSON.stringify(e))}catch(o){console.debug("Failed to save game settings:",o)}},loadHighTowerRings(){try{let e=localStorage.getItem(go);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(go,String(e))}catch(o){console.debug("Failed to save High Tower rings:",o)}},addHighTowerRings(e){let l=this.loadHighTowerRings()+e;return this.saveHighTowerRings(l),l}}}function fo(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function po(e){return document.getElementById("tab-"+e)}var Ii={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function ho(e={}){let{elementColors:o={}}=e,l=0;return{showBonus(d,c="score",i=null){let a=document.createElement("div");a.className=`bonus-popup ${c}`,a.textContent=d,i&&o[i]&&(a.style.color=o[i]);let r=window.innerWidth/2,g=window.innerHeight/2-40,p=(Math.random()-.5)*200,m=(Math.random()-.5)*100+l*36;a.style.left=`${r+p}px`,a.style.top=`${g+m}px`,a.style.transform="translate(-50%, -50%)",document.body.appendChild(a),l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{a.remove()},1800)},getElementIcon(d){return Ii[d]||"\u2726"}}}var yo={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function So(){return{spawnMagicOrb(e,o,l,d){if(!d)return;let c=document.createElement("div");c.className=`magic-orb ${e}`,c.textContent=yo[e]||"\u2726";let i=d.getBoundingClientRect(),a=i.left+i.width/2-o,r=i.top+i.height/2-l,g=Math.hypot(a,r),p=Math.atan2(r,a),m=g*.35*(Math.random()>.5?1:-1),h=p+Math.PI/2,L=a*.5+Math.cos(h)*m,Y=r*.5+Math.sin(h)*m;c.style.setProperty("--mid-x",`${L}px`),c.style.setProperty("--mid-y",`${Y}px`),c.style.setProperty("--end-x",`${a}px`),c.style.setProperty("--end-y",`${r}px`),c.style.left=`${o}px`,c.style.top=`${l}px`,document.body.appendChild(c),setTimeout(()=>{c.remove()},700)},spawnMagicShot(e,o,l,d,c){if(!o){c&&c();return}let i=o.getBoundingClientRect(),a=i.left+i.width/2,r=i.top+i.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=yo[e]||"\u2726";let p=l-a,m=d-r;g.style.setProperty("--end-x",`${p}px`),g.style.setProperty("--end-y",`${m}px`),g.style.left=`${a}px`,g.style.top=`${r}px`,document.body.appendChild(g);let h=setInterval(()=>{let L=g.getBoundingClientRect();this.spawnTrailParticle(e,L.left+L.width/2,L.top+L.height/2)},40);setTimeout(()=>{clearInterval(h),g.remove(),this.spawnExplosion(e,l,d),c&&c()},300)},spawnTrailParticle(e,o,l){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${o}px`,d.style.top=`${l}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,o,l){for(let c=0;c<12;c++){let i=document.createElement("div");i.className=`magic-explosion ${e}`;let a=c/12*Math.PI*2+(Math.random()-.5)*.5,r=40+Math.random()*40,g=Math.cos(a)*r,p=Math.sin(a)*r;i.style.setProperty("--px",`${g}px`),i.style.setProperty("--py",`${p}px`),i.style.left=`${o}px`,i.style.top=`${l}px`,document.body.appendChild(i),setTimeout(()=>i.remove(),500)}},spawnSpellBubbles(e,o=18){if(!e)return;let l=e.getBoundingClientRect(),d=l.left+l.width/2,c=l.top+l.height/2,i=Math.max(8,Math.round(o));for(let a=0;a<i;a++){let r=document.createElement("div");r.className="spell-bubble",r.textContent="\u25CF";let g=a/i*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,m=Math.cos(g)*p,h=Math.sin(g)*p-20;r.style.setProperty("--px",`${m}px`),r.style.setProperty("--py",`${h}px`),r.style.left=`${d}px`,r.style.top=`${c}px`,r.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(r),setTimeout(()=>r.remove(),800)}},spawnSpellOrb(e,o,l){if(!l)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let c=l.getBoundingClientRect(),i=c.left+c.width/2-e,a=c.top+c.height/2-o,r=Math.hypot(i,a),g=Math.atan2(a,i),p=r*.35*(Math.random()>.5?1:-1),m=g+Math.PI/2,h=i*.5+Math.cos(m)*p,L=a*.5+Math.sin(m)*p;d.style.setProperty("--mid-x",`${h}px`),d.style.setProperty("--mid-y",`${L}px`),d.style.setProperty("--end-x",`${i}px`),d.style.setProperty("--end-y",`${a}px`),d.style.left=`${e}px`,d.style.top=`${o}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}function Eo(e={}){let{buttons:o={},onActivate:l=null}=e,d={fire:3,water:3,lightning:3,earth:3},c=null;function i(){for(let[r,g]of Object.entries(o)){if(!g)continue;let p=d[r],m=g.querySelector(".charges");m&&(m.textContent=p),g.classList.toggle("empty",p<=0),g.classList.toggle("active",c===r&&p>0)}}function a(r){let g=o[r];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return d},get active(){return c},set active(r){c=r},select(r){if(d[r]<=0)return!1;let g=c===r;return c=g?null:r,i(),!g&&c===r&&l&&l(),!g},useCharge(){if(!c||d[c]<=0)return!1;let r=c;return d[r]--,c=null,i(),a(r),!0},addCharges(r,g){d[r]!==void 0&&(d[r]+=g,i(),a(r))},canUse(){return c!==null&&d[c]>0},deactivate(){c=null,i()},reset(){d.fire=3,d.water=3,d.lightning=3,d.earth=3,c=null,i()},updateButtons:i,initButtons(r){for(let[g,p]of Object.entries(o))p&&p.addEventListener("click",()=>{r&&r(g)})}}}var Ls={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:5,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:10,effect:{type:"chain_lightning"}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:8,effect:{type:"transmutation"}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:12,effect:{type:"horizontal_beam"}}};function Mo(e={}){let{button:o=null,onActivate:l=null,onProgress:d=null,onReady:c=null}=e,i="ice",a=0;function r(){return Ls[i]||Ls.ice}function g(){if(!o)return;let m=r(),h=Math.min(a/m.maxProgress,1)*100,L=a>=m.maxProgress;o.style.setProperty("--progress",`${h}%`);let Y=o.querySelector(".spell-icon");Y&&(Y.textContent=m.icon);let q=o.querySelector(".spell-counter");q&&(q.textContent=`${Math.min(a,m.maxProgress)}/${m.maxProgress}`),o.classList.toggle("ready",L),o.classList.toggle("charging",!L&&a>0),d&&d(a,m.maxProgress)}function p(){o&&(o.classList.remove("pulse"),o.offsetWidth,o.classList.add("pulse"),setTimeout(()=>o.classList.remove("pulse"),400))}return{get currentSpell(){return i},get progress(){return a},get maxProgress(){return r().maxProgress},get isReady(){return a>=r().maxProgress},get effect(){return r().effect},get button(){return o},selectSpell(m){Ls[m]&&(i=m,a=0,g())},addProgress(m=1){let h=r();if(a>=h.maxProgress)return!1;let L=a<h.maxProgress;return a=Math.min(a+m,h.maxProgress),g(),p(),L&&a>=h.maxProgress&&c&&c(),!0},canUse(){return a>=r().maxProgress},use(){if(!this.canUse())return null;let m=r().effect;return a=0,g(),p(),l&&l(i),m},reset(){a=0,g()},updateButton:g,initButton(m){o&&o.addEventListener("click",()=>{m&&m()})}}}var wi={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function xo(e={}){let{canvas:o}=e,l=e.rotDir||1,d=!1,c=0,i=0,a=0,r=0,g=0,p=1,m=null,h=0,L=0,Y=0,q=0,et=0,ct=0,Tt=0,Ee=0,ot=wi;return{get rotDir(){return l},set rotDir(z){l=z},get dragging(){return d},get dragMode(){return m},handlePointerDown(z,ht,Ie){if(ht.onMagicTap&&ht.onMagicTap(z.clientX,z.clientY))return!0;let Me=performance.now(),ce=Me-ct,ae=z.clientX-Tt,re=z.clientY-Ee,we=Math.hypot(ae,re);return ce<=ot.DOUBLE_TAP_MS&&we<=ot.DOUBLE_TAP_MAX_DIST?(ht.onDoubleTap&&ht.onDoubleTap(),ct=0):(ct=Me,Tt=z.clientX,Ee=z.clientY),d=!0,p=-1,c=z.clientX,i=z.clientY,a=Ie,r=0,g=0,m=null,h=Me,L=z.clientX,Y=z.clientY,q=h,et=0,o&&o.setPointerCapture(z.pointerId),!1},handlePointerMove(z,ht,Ie,Me){if(!d)return null;let ce=z.clientX-c,ae=z.clientY-i,re=performance.now();if(Math.abs(ce)<ot.DEADZONE_PX&&Math.abs(ae)<ot.DEADZONE_PX)return null;if(!m){let Jt=Math.abs(ce),Ft=Math.abs(ae);if(ae<0)Jt>=ot.DEADZONE_PX&&(m="rotate");else if(Ft>=Jt*ot.AXIS_DOMINANCE){if(Ft>=ot.DROP_SWIPE_MIN_DISTANCE){let At=Math.max(1,re-h);Ft/At*1e3>=ot.DROP_SWIPE_MIN_SPEED?m="drop":m="rotate"}}else Jt>=Ft*ot.AXIS_DOMINANCE&&(m="rotate");if(!m)return null}let we=null;if(m==="rotate"&&Math.abs(ce)>=ot.DEADZONE_PX){let Jt=Math.max(1,re-q),Ft=z.clientX-L,At=Math.max(1,Math.abs(Ft)/Jt*1e3),u=Math.max(ot.MIN_ROT_PX,Math.min(ot.MAX_ROT_PX,ot.PX_PER_STEP*(ot.SWIPE_SPEED_REF/At)));et+=-Ft/u*l*p;let nt=Math.trunc(et);nt!==0&&(et-=nt);let Q=r+nt;if(Q!==r&&ht.canRotateTo){let xe=Math.sign(Q-r),Wt=a+r;for(;r!==Q;){let Ue=r+xe,Je=a+Ue;if(!ht.canRotateTo(Math.floor(Ie),Je))break;r=Ue,Wt=Je,Me&&ht.onGroundedMove&&ht.onGroundedMove()}we={targetRot:Wt,rotFloat:Wt}}}if(m==="drop"&&ae>ot.DEADZONE_PX&&ht.onDrop){let Jt=Math.max(1,re-q),Ft=z.clientY-Y,At=Math.max(1,Ft/Jt*1e3),u=Math.max(ot.MIN_DROP_PX,Math.min(ot.MAX_DROP_PX,ot.PX_PER_DROP*(ot.SWIPE_SPEED_REF/At))),nt=Math.trunc(ae/u);if(nt>g){let Q=nt-g;for(let xe=0;xe<Q;xe++)ht.onDrop();g=nt}}return L=z.clientX,Y=z.clientY,q=re,we},handlePointerUp(z){if(d&&(d=!1,m=null,o&&z&&z.pointerId!==void 0))try{o.releasePointerCapture(z.pointerId)}catch{}},reset(){d=!1,m=null,r=0,g=0,et=0}}}var Bs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function bo(){let e="intro",o=0,l=0,d=0,c=0,i=0,a={...Bs};return{get state(){return e},get score(){return o},get elapsedMs(){return d},get startTime(){return l},get stats(){return a},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",o=0,l=performance.now(),d=0,c=0,i=0,a={...Bs}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(i+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){o+=r},setScore(r){o=r},updateTime(){e==="playing"&&l>0&&(d=performance.now()-l-i)},getFormattedTime(){let r=Math.floor(d/1e3),g=Math.floor(r/60),p=r%60;return`${g}:${p.toString().padStart(2,"0")}`},incrementStat(r,g=1){r in a&&(a[r]+=g)},updateMaxStat(r,g){r in a&&g>a[r]&&(a[r]=g)},reset(){e="intro",o=0,l=0,d=0,c=0,i=0,a={...Bs}}}}function dn(e,o){return e%=o,e<0&&(e+=o),e}function Co(e,o){return e[Math.min(o,e.length-1)]}function ts(e){let o=Math.max(0,Math.floor(e/1e3)),l=Math.floor(o/60),d=o%60;return`${l}:${d.toString().padStart(2,"0")}`}function vo(e,o){let l=e.map(({x:r,y:g},p)=>({x:g,y:-r,color:o[p]})),d=1/0,c=-1/0,i=1/0;for(let r of l)d=Math.min(d,r.x),c=Math.max(c,r.x),i=Math.min(i,r.y);let a=Math.round((d+c)/2);for(let r of l)r.x-=a,r.y-=i;return l.sort((r,g)=>r.y-g.y||r.x-g.x),{cells:l.map(r=>({x:r.x,y:r.y})),colors:l.map(r=>r.color)}}function Rs(e,o,l,d){let c=[];return e+1<l&&c.push({y:e+1,s:o}),e-1>=0&&c.push({y:e-1,s:o}),c.push({y:e,s:dn(o-1,d)}),c.push({y:e,s:dn(o+1,d)}),c}function To(e,o,l){let d=Array.from({length:o},()=>new Uint8Array(l)),c=[];for(let i=0;i<o;i++)for(let a=0;a<l;a++){if(!e[i][a]||d[i][a])continue;let r=[],g=[{y:i,s:a}];for(d[i][a]=1;g.length>0;){let p=g.shift();r.push(p);for(let m of Rs(p.y,p.s,o,l))e[m.y][m.s]&&!d[m.y][m.s]&&(d[m.y][m.s]=1,g.push(m))}c.push(r)}return c}function _o(e){return e.some(o=>o.y===0)}function As(e,o,l,d,c,i){if(!e)return!1;let a=dn(l,i);for(let r of e.cells){let g=o+r.y,p=dn(a+r.x,i);if(g<0)return!1;if(!(g>=c)&&d[g][p])return!1}return!0}function Lo(e,o,l,d,c,i){if(!e)return null;let a=Math.floor(o);for(;As(e,a-1,l,d,c,i);)a-=1;return a}function Bo(e,o,l){let d=[],c=[];for(let i=0;i<o;i++){let a=[],r=0,g=e[i][0],p=g?1:0;for(let m=1;m<=l;m++){let h=m<l?e[i][m]:0;h&&h===g?p++:(p>=1&&g&&a.push({start:r,length:p,color:g}),r=m,g=h,p=h?1:0)}if(a.length>=2){let m=a[0],h=a[a.length-1];if(m.start===0&&h.start+h.length===l&&m.color===h.color){let L=m.length+h.length;a[0]={start:h.start,length:L,color:m.color},a.pop()}}for(let m of a)if(m.length>=3){let h=[];for(let L=0;L<m.length;L++)h.push({y:i,s:(m.start+L)%l});d.push({color:m.color,length:m.length,cells:h})}}for(let i=0;i<l;i++){let a=0,r=e[0][i],g=r?1:0;for(let p=1;p<=o;p++){let m=p<o?e[p][i]:0;if(m&&m===r)g++;else{if(g>=3&&r){let h=[];for(let L=0;L<g;L++)h.push({y:a+L,s:i});d.push({color:r,length:g,cells:h})}a=p,r=m,g=m?1:0}}}for(let i=0;i<o;i++)for(let a=0;a<l;a++){let r=e[i][a],g=e[i][(a+1)%l],p=e[i][(a+2)%l],m=e[i][(a+3)%l];r&&r===g&&p&&p===m&&r!==p&&c.push({cells:[{y:i,s:a},{y:i,s:(a+1)%l},{y:i,s:(a+2)%l},{y:i,s:(a+3)%l}]})}for(let i=0;i<l;i++)for(let a=0;a<o-3;a++){let r=e[a][i],g=e[a+1][i],p=e[a+2][i],m=e[a+3][i];r&&r===g&&p&&p===m&&r!==p&&c.push({cells:[{y:a,s:i},{y:a+1,s:i},{y:a+2,s:i},{y:a+3,s:i}]})}return{lineMatches:d,pairMatches:c}}function Ro(e,o,l){let d=[];for(let c=0;c<o;c++){let i=!0;for(let a=0;a<l;a++)if(!e[c][a]){i=!1;break}i&&d.push(c)}return d}function Ao(e,o){let l=new Map;e.forEach((d,c)=>l.set(`${d.x},${d.y}`,o[c]));for(let d=0;d<e.length;d++){let c=e[d],i=o[d],a=1;for(let ct=1;ct<=2&&l.get(`${c.x+ct},${c.y}`)===i;ct++)a++;if(a>=3)return!0;let r=1;for(let ct=1;ct<=2&&l.get(`${c.x},${c.y+ct}`)===i;ct++)r++;if(r>=3)return!0;let g=i,p=l.get(`${c.x+1},${c.y}`),m=l.get(`${c.x+2},${c.y}`),h=l.get(`${c.x+3},${c.y}`);if(g&&p&&m&&h&&g===p&&m===h&&g!==m)return!0;let L=i,Y=l.get(`${c.x},${c.y+1}`),q=l.get(`${c.x},${c.y+2}`),et=l.get(`${c.x},${c.y+3}`);if(L&&Y&&q&&et&&L===Y&&q===et&&L!==q)return!0}return!1}function Io(e){let{getN:o,getH:l,FALL_INTERVAL:d,LOCK_DELAY_SEC:c,getKillRate:i,MATCH_HIGHLIGHT_SEC:a,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:g,getState:p,setState:m,funcs:h,ui:L}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(Y,q={}){let et=p();if(Y==="start_game")return et.gameState!=="playing"?(h.startGame(),!0):!1;if(et.gameState!=="playing")return!1;switch(Y){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:ct}=q;return typeof ct=="number"&&h.canPlaceAtRot(Math.floor(et.pieceY),ct)?(m({targetRot:ct,rotFloat:ct,rotVel:0}),et.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ct,y:Tt}=q;return h.shootMagic(ct,Tt)}case"select_magic":{let{element:ct}=q;return h.selectMagic(ct),!0}default:return console.warn("GameEngine: unknown command",Y),!1}},update(Y,q){let et=p();if(et.gameState!=="playing")return;let ct=q-et.startTime-et.totalPausedMs;m({elapsedMs:ct}),L.updateTimeHud();let Tt=et.killLevel+i()*Y;if(m({killLevel:Tt}),L.updateRemainingHud(),Tt>=l()){h.endGame();return}if(et.isHighlighting){let z=(q-et.highlightStartTime)/1e3,ht;et.isRingAnimation?ht=g:et.isMagicAnimation?ht=r:ht=a,z>=ht&&(et.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let Ee=et.fallTimer+Y;if(Ee>=d&&(Ee-=d,h.tryMoveDown()),m({fallTimer:Ee}),h.updateGroundedState()){let z=et.lockTimer+Y;m({lockTimer:z}),z>=c&&h.lockPiece()}},reset(){h.startGame()},canRotateTo(Y,q){return h.canPlaceAtRot(Y,q)},getRotation(){let Y=p();return{targetRot:Y.targetRot,rotFloat:Y.rotFloat,rotVel:Y.rotVel}},setRotation(Y){m({targetRot:Y,rotFloat:Y,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var ie=Math.PI*2;function wo(e){let{canvas:o,canvasCtx:l,getN:d,getH:c,TOP_PAD_PX:i,BOTTOM_PAD_PX:a,SIDE_MARGIN_PX:r,MAX_RADIUS_X:g,RADIUS_X_FACTOR:p,ANG_OFFSET:m,MATCH_HIGHLIGHT_SEC:h,MATCH_SHRINK_PHASE:L,MAGIC_SHRINK_SEC:Y,RING_HIGHLIGHT_SEC:q,LOCK_DELAY_SEC:et,getKillRate:ct,ELEMENT_COLORS:Tt,ELEMENT_TO_COLOR:Ee,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:z,ACTIVE_COLOR_FRONT:ht,GHOST_COLOR_FILL:Ie,GHOST_COLOR_STROKE:Me,GHOST_STROKE_WIDTH:ce,MAGIC_DIM_DOT_ALPHA:ae,MAGIC_DIM_DOT_SCALE:re,MAGIC_TARGET_DOT_SCALE:we,getState:Jt,getVisualSettings:Ft,funcs:At}=e,u=l,nt=d(),Q=c(),xe={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},Wt=[],Ue=40;function Je(k,I,w,B,R){let y=Math.max(3,Math.round(k)),Z=180;for(let J=0;J<y;J++)setTimeout(()=>{let V=Math.random()>.5?"left":"right",tt=15,b=V==="left"?tt+Math.random()*Math.max(10,I-tt*2):w+tt+Math.random()*Math.max(10,R-w-tt*2),C=B-10;Wt.push({x:b,baseX:b,y:C,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:tt,maxX:R-tt})},J*Z)}function _n(k,I,w){Wt=Wt.filter(B=>B.y>k+B.size&&B.y>-20);for(let B of Wt){B.y-=Ue*w,B.wobble+=B.wobbleSpeed*w;let R=B.baseX+Math.sin(B.wobble)*B.wobbleAmp;B.x=Math.max(B.minX,Math.min(B.maxX,R))}}function es(k){if(Wt.length!==0){u.fillStyle="rgba(255, 255, 255, 0.3)",u.strokeStyle="rgba(255, 255, 255, 0.5)",u.lineWidth=1;for(let I of Wt)I.y<k+I.size||(u.beginPath(),u.arc(I.x,I.y,I.size,0,Math.PI*2),u.fill(),u.stroke())}}let gn={left:0,right:0,h:0,w:0};function Mt(k,I,w){let B=1-w/Q;return k+B*I}function mn(k){return k=k%nt,k<0?k+nt:k}function tn(k,I,w,B,R,y){let Z=mn(y),J=(R-Z)/nt*ie+m;return{x:k+Math.cos(J)*w,y:I+Math.sin(J)*B,ang:J}}let Ln=.52,fn=1.02;function kt(k,I,w,B,R,y){let Z=mn(y),J=(R-Z)/nt*ie+m;return{x:k+Math.cos(J)*w,y:I+Math.sin(J)*B,ang:J}}function en(k,I,w,B,R,y,Z,J=1){let V=kt(k,I,w,B,R-Ln,y),tt=kt(k,I,w,B,R+Ln,y),b={x:V.x,y:V.y-Z*.5},C={x:V.x,y:V.y+Z*.5},x={x:tt.x,y:tt.y-Z*.5},Dt={x:tt.x,y:tt.y+Z*.5},v=(b.x+x.x+Dt.x+C.x)*.25,F=(b.y+x.y+Dt.y+C.y)*.25,D=fn*J,Ut=J,It=[b,x,Dt,C].map(te=>({x:v+(te.x-v)*D,y:F+(te.y-F)*Ut})),mt=Math.abs((tt.x-V.x)*D),Ht=Math.abs(Z*Ut);return{corners:It,cx:v,cy:F,wApprox:mt,hApprox:Ht,ang:kt(k,I,w,B,R,y).ang}}function _t(k,I,w,B,R,y,Z,J,V=1,tt=null,b=1,C=null,x=0,Dt=1,v=1){let F=en(k,I,w,B,R,y,Z,v),[D,Ut,It,mt]=F.corners;if(u.save(),u.globalAlpha=V,u.fillStyle=J,u.beginPath(),u.moveTo(D.x,D.y),u.lineTo(Ut.x,Ut.y),u.lineTo(It.x,It.y),u.lineTo(mt.x,mt.y),u.closePath(),u.fill(),C&&x>0&&(u.strokeStyle=C,u.lineWidth=x,u.stroke()),tt){let Ht=Math.min(F.wApprox,F.hApprox)*.28*Dt;u.globalAlpha=V*b,u.fillStyle=tt,u.beginPath(),u.arc(F.cx,F.cy,Ht,0,ie),u.fill()}u.restore(),u.globalAlpha=1}function ns(k,I,w,B,R,y){let Z=tn(k,I,w,B,R,y),J=tn(k,I,w,B,R+1,y),V=tn(k,I,w,B,R-1,y),tt=Math.abs(J.x-Z.x),b=Math.abs(Z.x-V.x),C=(tt+b)*.5*1.06;return Math.max(1,C)}function Bn(k,I,w,B,R,y){let Z=(R-y)/nt*ie+m;return{x:k+Math.cos(Z)*w,y:I+Math.sin(Z)*B,ang:Z}}function ss(k,I,w,B,R,y,Z,J=1,V=null,tt=1,b=null,C=0,x=1){u.save(),u.translate(k,I);let Dt=Math.atan2(B,w);if(u.rotate(Dt),u.globalAlpha=J,u.fillStyle=Z,u.fillRect(-R/2,-y/2,R,y),b&&C>0&&(u.strokeStyle=b,u.lineWidth=C,u.strokeRect(-R/2,-y/2,R,y)),V){let v=Math.min(R,y)*.28*x;u.globalAlpha=J*tt,u.fillStyle=V,u.beginPath(),u.arc(0,0,v,0,ie),u.fill()}u.restore(),u.globalAlpha=1}return{resize(){let k=Math.max(1,Math.min(2,window.devicePixelRatio||1)),I=Math.floor(o.clientWidth*k),w=Math.floor(o.clientHeight*k);(o.width!==I||o.height!==w)&&(o.width=I,o.height=w,u.setTransform(k,0,0,k,0,0))},render(k=.016,I=performance.now()){this.resize();let w=Jt();nt=d(),Q=c();let B=o.clientWidth,R=o.clientHeight;u.clearRect(0,0,B,R),u.fillStyle="#0b0f14",u.fillRect(0,0,B,R);let y=B*.5,Z=(B-2*r)/2,J=R-i-a,V=6,tt=nt*J/(V*Q),b,C,x,Dt;Dt=R-a,tt<=Math.min(Z,g)?(b=tt,C=J,x=i):(b=Math.min(Z,g),C=b*V*Q/nt,x=Dt-C);let v=b*.28,{killLevel:F,rotFloat:D,grid:Ut,gameState:It}=w,mt=Ft?Ft():{},Ht=mt.waterColor||"blue",te=mt.waterBubbles||!1,ge=xe[Ht]||xe.blue,$t=Mt(x,C,F),bt=.7,be=F/Q,yt={...ge.top},ft={...ge.bottom};if(be>bt){let M=(be-bt)/(1-bt);yt.r=Math.round(yt.r+(255-yt.r)*M*.5),yt.g=Math.round(yt.g+(150-yt.g)*M*.5),yt.b=Math.round(yt.b+(150-yt.b)*M*.5),ft.r=Math.round(ft.r+(180-ft.r)*M),ft.g=Math.round(ft.g*(1-M*.6)),ft.b=Math.round(ft.b*(1-M*.6))}let Ce=y-b-8,me=y+b+8,Rn=x,E=Dt+5,wt=u.createLinearGradient(0,$t,0,R);wt.addColorStop(0,`rgba(${yt.r},${yt.g},${yt.b},0.5)`),wt.addColorStop(1,`rgba(${ft.r},${ft.g},${ft.b},0.7)`),u.fillStyle=wt;let St=Math.round((yt.r+ft.r)/2),Gt=Math.round((yt.g+ft.g)/2),An=Math.round((yt.b+ft.b)/2),ve=b+8,Xe=v+4;u.fillRect(0,$t,Ce,R-$t),u.fillRect(me,$t,B-me,R-$t),u.beginPath();let nn=Math.max($t,E);u.moveTo(Ce,nn),$t<=E+Xe?u.ellipse(y,E,ve,Xe,0,Math.PI,0,!1):u.lineTo(me,nn),u.lineTo(me,R),u.lineTo(Ce,R),u.closePath(),u.fill(),u.strokeStyle="rgba(100,180,255,0.6)",u.lineWidth=3,u.lineCap="round",u.beginPath(),u.moveTo(Ce,Rn),u.lineTo(Ce,E),u.stroke(),u.beginPath(),u.moveTo(me,Rn),u.lineTo(me,E),u.stroke(),u.beginPath(),u.ellipse(y,E,b+8,v+4,0,0,Math.PI),u.stroke(),u.fillStyle="#0b0f14",u.beginPath(),u.ellipse(y,E,b+8,v+4,0,0,ie),u.fill(),F>.5&&(u.strokeStyle=`rgba(${Math.min(255,St+60)},${Math.min(255,Gt+40)},${Math.min(255,An+40)},0.6)`,u.lineWidth=2,u.beginPath(),u.moveTo(0,$t),u.lineTo(Ce,$t),u.moveTo(me,$t),u.lineTo(B,$t),u.stroke()),gn={left:Ce,right:me,h:R,w:B},(Wt.length>0||te)&&(_n($t,R,k),es($t)),u.strokeStyle="rgba(160,190,220,0.3)",u.lineWidth=1;let le=ie*b,j=10,In=le/j*.7,sn=le/j*.3;u.setLineDash([In,sn]);let Ot=le/nt;u.lineDashOffset=mn(D)*Ot;for(let M=0;M<=Q;M++){let H=Mt(x,C,M);u.beginPath(),u.ellipse(y,H,b,v,0,0,ie),u.stroke()}u.setLineDash([]);let pn=[],fe=[];for(let M=0;M<Q;M++){let H=Mt(x,C,M+.5);for(let N=0;N<nt;N++){let $=Ut[M][N];if(!$)continue;let P=tn(y,H,b,v,N,D),W=Math.sin(P.ang),O={y:M,s:N,yScr:H,p:P,depth:W,color:$};W<-.1?pn.push(O):fe.push(O)}}let os=At.getMagicTargetColor(),{isHighlighting:wn,highlightedCells:Kt,highlightStartTime:Pn,isMagicAnimation:hn}=w,Ye=null,Pe=1,Oe=1,is=!1;if(wn&&Kt.length>0){Ye=new Set(Kt.map(H=>`${H.y},${H.s}`));let M=(performance.now()-Pn)/1e3;if(hn){let H=Math.min(1,M/Y);Pe=1-H*.85,Oe=1-H*.9,is=!0}else{let H=Math.min(1,M/h),N=1-L;if(H>N){let $=(H-N)/L;Pe=1-$*.85,Oe=1-$*.9,is=!0}}}pn.sort((M,H)=>M.depth-H.depth);for(let M of pn){let H=C/Q*.9,N=Tt[M.color]||null,$=.35,P=1,W=`${M.y},${M.s}`;Ye&&Ye.has(W)&&($*=Oe,P=Pe),_t(y,M.yScr,b,v,M.s,D,H,z,$,N,.5,null,0,1,P)}let{isRingAnimation:qt}=w;if(wn&&Kt.length>0&&!hn){let M=(performance.now()-Pn)/1e3,N=Math.min(1,M/(qt?q:h)),$=1-L,P=N>$,W=P?(N-$)/L:0,O=qt?Math.floor(N*$*nt*2)%nt:-1,_=4+N/$*10,G=Math.sin(M*_*ie),it=P?1:.3+G*.3,at=P?1-W*.8:1,dt=P?1-W:1;for(let st of Kt){let xt=Mt(x,C,st.y+.5),Xt=kt(y,xt,b,v,st.s,D);if(Math.sin(Xt.ang)>=-.1)continue;let Ve=C/Q*.9,Nt,Lt,Ct;if(qt){let he=(st.s-O+nt)%nt,ue=he<3?1-he/3:0;Nt=(P?dt:.2+ue*.5)*.5,Lt=`rgba(255, 159, 67, ${Nt})`,Ct=P?at:1+ue*.15}else Nt=it*dt,Lt=st.isLine?`rgba(255, 255, 255, ${Nt*.5})`:`rgba(255, 220, 100, ${Nt*.4})`,Ct=P?at:1.1;_t(y,xt,b,v,st.s,D,Ve,Lt,1,null,1,null,0,1,Ct)}}fe.sort((M,H)=>M.depth-H.depth);for(let M of fe){let H=C/Q*.9,N=Tt[M.color]||null,$=1,P=1,W=1,O=1,_=`${M.y},${M.s}`,G=Ye&&Ye.has(_);G&&($=Oe,P=Pe),os!==null&&!G&&(M.color!==os?(W=ae,O=re):O=we),_t(y,M.yScr,b,v,M.s,D,H,ot,$,N,W,null,0,O,P)}if(wn&&Kt.length>0&&!hn){let M=(performance.now()-Pn)/1e3,N=Math.min(1,M/(qt?q:h)),$=1-L,P=N>$,W=P?(N-$)/L:0,O=qt?Math.floor(N*$*nt*2)%nt:-1,_=4+N/$*10,G=Math.sin(M*_*ie),it=P?1:.5+G*.5,at=P?1-W*.8:1,dt=P?1-W:1;for(let st of Kt){let xt=Mt(x,C,st.y+.5),Xt=kt(y,xt,b,v,st.s,D);if(Math.sin(Xt.ang)<-.1)continue;let Ve=C/Q*.9,Nt,Lt,Ct;if(qt){let he=(st.s-O+nt)%nt,ue=he<4?1-he/4:0;Nt=P?dt:.3+ue*.7,Lt=`rgba(255, 159, 67, ${Nt})`,Ct=P?at:1+ue*.2}else Nt=it*dt,Lt=st.isLine?`rgba(255, 255, 255, ${Nt*.7})`:`rgba(255, 220, 100, ${Nt*.6})`,Ct=P?at:1.15;_t(y,xt,b,v,st.s,D,Ve,Lt,1,null,1,null,0,1,Ct)}}let{transmuteState:Te,transmuteSourceBlock:On,transmuteTargetColor:cs,transmuteAreaCells:kn,transmuteBlocksToChange:ke}=w;if(Te==="selecting_source"){let M=C/Q*.9,H=.35+Math.sin(I/150)*.15;for(let N of fe){let $=Mt(x,C,N.y+.5);_t(y,$,b,v,N.s,D,M,`rgba(0, 40, 20, ${H})`,1,null,1,null,0,1,1)}}if(Te==="selecting_target"&&ke&&ke.length>0){let M=C/Q*.9,H=.4+Math.sin(I/120)*.25,N=.6+Math.sin(I/120)*.4;for(let $ of ke){if($.y<0||$.y>=Q)continue;let P=Mt(x,C,$.y+.5),W=kt(y,P,b,v,$.s,D);Math.sin(W.ang)<-.1||(_t(y,P,b,v,$.s,D,M,`rgba(0, 50, 30, ${H})`,1,null,1,null,0,1,1),_t(y,P,b,v,$.s,D,M,"transparent",1,null,1,`rgba(100, 255, 150, ${N})`,3,1,1.02))}}if(Te==="animating"&&At.getTransmuteAnimState){let M=At.getTransmuteAnimState(I);if(M){let H=C/Q*.9,{phase:N,progress:$,areaFlash:P}=M;if(P>0&&kn)for(let W of kn){if(W.y<0||W.y>=Q)continue;let O=Mt(x,C,W.y+.5),_=kt(y,O,b,v,W.s,D);Math.sin(_.ang)<-.1||_t(y,O,b,v,W.s,D,H,`rgba(150, 255, 200, ${P*.4})`,1,null,1,null,0,1,1)}if(ke&&ke.length>0){let W=On?On.color:1,O=cs||1;for(let _ of ke){if(_.y<0||_.y>=Q)continue;let G=Mt(x,C,_.y+.5),it=kt(y,G,b,v,_.s,D);if(Math.sin(it.ang)<-.1)continue;let dt=1,st=Tt[W],xt=0;if(N==="shrink"?(dt=1-$*.95,st=Tt[W],xt=.5+$*.3):N==="grow"&&(dt=$,st=Tt[O],xt=.8-$*.5),xt>0&&_t(y,G,b,v,_.s,D,H,`rgba(200, 255, 220, ${xt})`,1,null,1,null,0,1,1),dt>.05){let Xt=en(y,G,b,v,_.s,D,H,1),pe=Math.min(Xt.wApprox,Xt.hApprox)*.28*dt;u.save(),u.globalAlpha=1,u.fillStyle=st,u.beginPath(),u.arc(Xt.cx,Xt.cy,pe,0,ie),u.fill(),u.restore()}}}}}let{lightningState:on,lightningSourceBlock:Dn,lightningAreaCells:Hn,lightningBlocksToHit:_e}=w;if(on==="selecting_source"){let M=C/Q*.9,H=.35+Math.sin(I/150)*.15;for(let N of fe){let $=Mt(x,C,N.y+.5);_t(y,$,b,v,N.s,D,M,`rgba(20, 20, 60, ${H})`,1,null,1,null,0,1,1)}}if(on==="animating"&&At.getLightningAnimState){let M=At.getLightningAnimState(I);if(M&&_e&&_e.length>0){let H=C/Q*.9,{phase:N,flashProgress:$,currentTarget:P,jumpProgress:W,struckTargets:O}=M;if(N==="flash"&&$>0&&Hn)for(let _ of Hn){if(_.y<0||_.y>=Q)continue;let G=Mt(x,C,_.y+.5),it=kt(y,G,b,v,_.s,D);Math.sin(it.ang)<-.1||_t(y,G,b,v,_.s,D,H,`rgba(100, 150, 255, ${$*.5})`,1,null,1,null,0,1,1)}if(O&&O.length>0)for(let _ of O){let G=_e[_];if(!G||G.y<0||G.y>=Q)continue;let it=Mt(x,C,G.y+.5),at=kt(y,it,b,v,G.s,D);if(Math.sin(at.ang)<-.1)continue;let st=(O.length-1-O.indexOf(_))*.1,xt=Math.max(0,.8-st);_t(y,it,b,v,G.s,D,H,`rgba(255, 255, 255, ${xt})`,1,null,1,`rgba(150, 200, 255, ${xt})`,2,1,1.05)}if(N==="chain"&&P>=0&&P<_e.length){let _=_e[P];if(_&&_.y>=0&&_.y<Q){let G=Mt(x,C,_.y+.5),it=kt(y,G,b,v,_.s,D);if(Math.sin(it.ang)>=-.1){let dt=1-W;_t(y,G,b,v,_.s,D,H,`rgba(200, 220, 255, ${dt*.9})`,1,null,1,`rgba(100, 180, 255, ${dt})`,3,1,1.1-W*.05)}}if(P>0){let G=_e[P-1],it=_e[P];if(G&&it){let at=Mt(x,C,G.y+.5),dt=Mt(x,C,it.y+.5),st=en(y,at,b,v,G.s,D,H,1),xt=en(y,dt,b,v,it.s,D,H,1);u.save(),u.strokeStyle=`rgba(150, 200, 255, ${1-W*.5})`,u.lineWidth=2+(1-W)*2,u.lineCap="round",u.beginPath();let Xt=st.cx,pe=st.cy,Ve=xt.cx,Nt=xt.cy;u.moveTo(Xt,pe);let Lt=4;for(let Ct=1;Ct<=Lt;Ct++){let he=Ct/Lt,ue=Xt+(Ve-Xt)*he,ls=pe+(Nt-pe)*he,Gn=Ct<Lt?(Math.random()-.5)*8:0;u.lineTo(ue+Gn,ls+Gn)}u.stroke(),u.strokeStyle=`rgba(100, 150, 255, ${(1-W)*.3})`,u.lineWidth=6,u.stroke(),u.restore()}}}}}let{activePiece:Le,pieceY:as,isGrounded:rs,lockTimer:$n}=w;if(Le){let M=At.snappedRot(),H=M,N=At.computeGhostY(),$=C/Q*.9;if(N!==null){let O=[];for(let _=0;_<Le.cells.length;_++){let G=Le.cells[_],it=Le.colors[_],at=N+G.y,dt=At.normSector(M+G.x);if(at<0||at>=Q)continue;let st=Mt(x,C,at+.5),xt=kt(y,st,b,v,dt,H);O.push({cy:at,cs:dt,yScr:st,depth:Math.sin(xt.ang),color:it})}O.sort((_,G)=>_.depth-G.depth);for(let _ of O){let G=Tt[_.color]||null;_t(y,_.yScr,b,v,_.cs,H,$,Ie,1,G,.5,Me,ce,1,1)}}let P=ht;if(rs&&$n>0){let O=Math.min(1,$n/et),_=255,G=Math.round(170+85*O),it=Math.round(180+75*O),at=.75+(1-.75)*O;P=`rgba(${_},${G},${it},${at})`}let W=[];for(let O=0;O<Le.cells.length;O++){let _=Le.cells[O],G=Le.colors[O],it=At.normSector(M+_.x),at=as+_.y;if(at<0||at>=Q)continue;let dt=Mt(x,C,at+.5),st=kt(y,dt,b,v,it,H);W.push({cs:it,yScr:dt,depth:Math.sin(st.ang),color:G})}W.sort((O,_)=>O.depth-_.depth);for(let O of W){let _=Tt[O.color]||null;_t(y,O.yScr,b,v,O.cs,H,$,P,1,_,1,null,0,1,1)}}},drawNextPreview(k,I){if(!k)return;let w=k.getContext("2d"),B=k.width,R=k.height;if(w.clearRect(0,0,B,R),!I)return;let y=1/0,Z=-1/0,J=1/0,V=-1/0;for(let v of I.cells)y=Math.min(y,v.x),Z=Math.max(Z,v.x),J=Math.min(J,v.y),V=Math.max(V,v.y);let tt=Z-y+1,b=V-J+1,C=Math.min(B/(tt+.5),R/(b+.5)),x=(B-tt*C)/2,Dt=(R-b*C)/2;w.fillStyle=ot;for(let v=0;v<I.cells.length;v++){let F=I.cells[v],D=x+(F.x-y)*C,Ut=Dt+(b-1-(F.y-J))*C;w.fillRect(D+1,Ut+1,C-2,C-2);let It=I.colors[v],mt=Tt[It];if(mt){let Ht=(C-2)*.32;w.fillStyle=mt,w.beginPath(),w.arc(D+C/2,Ut+C/2,Ht,0,ie),w.fill(),w.fillStyle=ot}}},spawnBonusBubbles(k){let{left:I,right:w,h:B,w:R}=gn;R>0&&Je(k,I,w,B,R)}}}(()=>{let e=fo(),o=e.canvas,l=o.getContext("2d");o.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,c=30,i=24,a=120,r={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function g(t){let s=r[t]||r["30_24"];c=s.N,i=s.H,a=s.survivalTime}function p(){return i/a}let m=Math.PI/2,h=70,L=120,Y=30,q=320,et=.42,ct="rgb(235,240,250)",Tt="rgb(55,62,75)",Ee="rgba(255,170,180,0.75)",ot="rgba(110,255,150,0.15)",z="rgba(110,255,150,0.85)",ht=2,Ie={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Me={1:"fire",2:"water",3:"lightning",4:"earth"},ce={fire:1,water:2,lightning:3,earth:4},ae=1,re=.58,we=!0,Jt=12,Ft=25,At=1,u=2,nt=3,Q=5,xe=8,Wt=10,Ue=15,Je=30,_n=2,es=.3,gn=.5,Mt=1,mn=.3,tn=.5,Ln=1.3,fn=10,kt=500,en=[1,1.25,1.5,1.75,2],_t=10,ns=100,Bn=25,ss=6,k=10,I=.35,w=6,B=10,R=180,y=250,Z=[1,1.3,1.6,2],J=[1,1.5,2,2.5],V=mo(),tt=V.loadGameSettings(),b=tt.invertSwipe?-1:1,C=-1,x=Array.from({length:i},()=>new Uint8Array(c));function Dt(){x=Array.from({length:i},()=>new Uint8Array(c))}let v=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],F=null,D=i+3,Ut=0,It=0,mt=!1,Ht=0,te=0,ge=0,$t=3,bt=0,be=0,yt=0,ft=xo({canvas:o,rotDir:b}),Ce="0.14.4",me=!0,Rn="blue",E=ao();E.preload();let wt=bo(),St="intro",Gt=0,An=0,ve=0,Xe=0,nn=0,le=null,j=wt.stats,In=e.overlay,sn=ho({elementColors:Ie}),Ot=sn.showBonus.bind(sn),pn=sn.getElementIcon.bind(sn),fe=So(),os=e.overlayTitle,wn=e.overlayStats,Kt=e.startBtn,Pn=e.hud,hn=e.scoreHud,Ye=e.timeHud,Pe=e.remainingHud,Oe=e.nextCanvas,is=Oe.getContext("2d"),qt=e.pauseBtn,Te=e.pauseOverlay,On=e.resumeBtn,cs=e.restartBtn,kn=e.exitToMenuBtn,ke=e.pauseSettingsBtn,on=e.pauseSoundBtn,Dn=e.pauseMusicBtn,Hn=e.pauseBestScore,_e=e.pauseBestTime,Le=e.pauseBestMode,as=e.pauseCurrentScore,rs=e.pauseCurrentTime,$n=e.pauseCurrentMode,M=e.confirmDialog,H=e.confirmText,N=e.confirmCancel,$=e.confirmOk,P=e.settingsOverlay,W=e.settingsClose,O=e.fullscreenBtn,_=e.rotateBtn,G=e.startPanel,it=e.gameoverPanel,at=e.goScore,dt=e.goTime,st=e.goRing,xt=e.goMatches,Xt=e.goBonuses,pe=e.goNewRecord,Ve=e.goRestartBtn,Nt=e.goExitBtn,Lt=e.bestScore,Ct=e.bestTimeVal,he=e.startVersion,ue=e.modeBtns,ls=e.recordsBtn,Gn=e.startSettingsBtn,Po=e.helpBtn,zt="25_20",Yt=Eo({buttons:e.magicBtns,onActivate:()=>E.play("spells")}),us=e.magicBtns,Oi=Yt.charges,Oo=t=>Yt.select(t),ds=()=>Yt.updateButtons(),yn=e.spellWave;function ko(){yn&&(yn.classList.remove("active"),yn.offsetWidth,yn.classList.add("active"),setTimeout(()=>yn.classList.remove("active"),1200))}let ee=Mo({button:e.spellBtn,onActivate:t=>{if(t==="ice"){let s=ee.effect;ge+=s.duration*p(),E.play("wsseffect"),Ot(`\u{1F4A7} -${s.duration}s`,"time"),ko(),fe.spawnSpellBubbles(ee.button,s.duration),ln.spawnBonusBubbles(s.duration)}},onReady:()=>{E.play("readysuper")}});ee.initButton(()=>{if(St==="playing"&&ee.canUse()){let t=ee.currentSpell;if(t==="earth"){Vt==="idle"?Ho():rn();return}if(t==="air"){Qt==="idle"?Vo():xn();return}ee.use()}});function Is(){return zt==="30_24"}function Nn(){let t=e.spellBtn;t&&(t.style.display=Is()?"":"none")}let Be=[],Sn=0,Re=!1,We=!1,En=!1,ne=0,ye=0,Se=0,cn=[],Vt="idle",Ae=null,Ke=null,qe=[],De=[],gs=0,an=null,Qt="idle",He=null,ze=[],jt=[],ms=0,Mn=0;function Qe(t,s,n){let f=1-n/i;return t+f*s}function Fn(t,s,n,f,T,S){let A=(T-S)/c*d+m;return{x:t+Math.cos(A)*n,y:s+Math.sin(A)*f,ang:A}}function ws(t,s){let n=o.clientWidth,f=o.clientHeight,T=n*.5,S=(n-2*Y)/2,A=f-h-L,rt=6,vt=c*A/(rt*i),se=f-L,lt,U,X;vt<=Math.min(S,q)?(lt=vt,U=A,X=h):(lt=Math.min(S,q),U=lt*rt*i/c,X=se-U);let K=lt*.28,ut=Qe(X,U,t+.5),pt=Fn(T,ut,lt,K,s,bt),Et=o.getBoundingClientRect();return{x:Et.left+pt.x,y:Et.top+pt.y}}function Do(t,s){if(!Yt.canUse()||Re)return!1;let n=ce[Yt.active],f=o.clientWidth,T=o.clientHeight,S=f*.5,A=(f-2*Y)/2,rt=T-h-L,vt=6,se=c*rt/(vt*i),lt=T-L,U,X,K;se<=Math.min(A,q)?(U=se,X=rt,K=h):(U=Math.min(A,q),X=U*vt*i/c,K=lt-X);let ut=U*.28,pt=null,Et=1/0;for(let Bt=0;Bt<i;Bt++){let Pt=Qe(K,X,Bt+.5);for(let Rt=0;Rt<c;Rt++){let Ne=x[Bt][Rt];if(!Ne||Ne!==n)continue;let de=Fn(S,Pt,U,ut,Rt,bt);if(Math.sin(de.ang)<-.1)continue;let Zt=t-de.x,un=s-de.y,oe=Math.hypot(Zt,un),Fe=X/i*.9,_s=Fe*1.2;Math.abs(Zt)<_s/2&&Math.abs(un)<Fe/2&&oe<Et&&(Et=oe,pt={y:Bt,s:Rt})}}if(pt){let Bt=Qe(K,X,pt.y+.5),Pt=Fn(S,Bt,U,ut,pt.s,bt),Rt=o.getBoundingClientRect(),Ne=Rt.left+Pt.x,de=Rt.top+Pt.y,Ze=us[Yt.active];return fe.spawnMagicShot(Yt.active,Ze,Ne,de,()=>{let Zt=x[pt.y][pt.s];Be=[{y:pt.y,s:pt.s,color:Zt,isLine:!1,isMagic:!0}],Sn=performance.now(),Re=!0,We=!0,ne=0,ye=Bn,Ot(`+${Bn}`,"score")}),Se=0,Yt.useCharge(),j.magicUsed++,!0}return!1}function Ho(){Vt="selecting_source",Ae=null,Ke=null,qe=[],De=[],Qt!=="idle"&&xn(),Yt.deactivate(),E.play("ulta");let t=e.spellBtn;t&&t.classList.add("selecting")}function rn(){Vt!=="idle"&&E.play("cancel"),Vt="idle",Ae=null,Ke=null,qe=[],De=[],Un();let t=e.spellBtn;t&&t.classList.remove("selecting")}function $o(t,s){if(Vt!=="selecting_source")return!1;let n=Ps(t,s);if(!n)return rn(),!0;Ae={y:n.y,s:n.s,color:x[n.y][n.s]},qe=Ds(n.y,n.s,ss);let f=Ae.color,T=qe.filter(S=>x[S.y][S.s]===f);return De=Hs(T,n.y,n.s,k),Go(Ae.color,n.y),Vt="selecting_target",!0}function Ps(t,s){let n=o.clientWidth,f=o.clientHeight,T=n*.5,S=(n-2*Y)/2,A=f-h-L,rt=6,vt=c*A/(rt*i),se=f-L,lt,U,X;vt<=Math.min(S,q)?(lt=vt,U=A,X=h):(lt=Math.min(S,q),U=lt*rt*i/c,X=se-U);let K=lt*.28,ut=null,pt=1/0;for(let Et=0;Et<i;Et++){let Bt=Qe(X,U,Et+.5);for(let Pt=0;Pt<c;Pt++){if(!x[Et][Pt])continue;let Rt=Fn(T,Bt,lt,K,Pt,bt);if(Math.sin(Rt.ang)<-.1)continue;let de=t-Rt.x,Ze=s-Rt.y,Zt=Math.hypot(de,Ze),un=U/i*.9,oe=un*1.2;Math.abs(de)<oe/2&&Math.abs(Ze)<un/2&&Zt<pt&&(pt=Zt,ut={y:Et,s:Pt})}}return ut}function Go(t,s){Un();let n=document.createElement("div");n.className="transmute-popup";let f=o.clientWidth,T=o.clientHeight,S=(f-2*Y)/2,A=T-h-L,rt=6,vt=c*A/(rt*i),se=T-L,lt,U;vt<=Math.min(S,q)?(lt=A,U=h):(lt=Math.min(S,q)*rt*i/c,U=se-lt);let X=Qe(U,lt,s+.5),K=Math.floor(ss/2),ut=Qe(U,lt,Math.min(i,s+K)+.5),pt=Qe(U,lt,Math.max(0,s-K)+.5),Et=U+lt/2,Bt=document.getElementById("gameContainer"),Pt=Bt?Bt.getBoundingClientRect():{width:window.innerWidth,left:0},Rt=160,Ne=60,de=20,Ze=Pt.left+Pt.width/2-Rt/2,Zt;X<Et?Zt=Pt.top+pt+de:Zt=Pt.top+ut-Ne-de,Zt=Math.max(10,Math.min(window.innerHeight-Ne-10,Zt)),n.style.left=`${Ze}px`,n.style.top=`${Zt}px`,[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}].filter(oe=>oe.color!==t).forEach(oe=>{let Fe=document.createElement("button");Fe.className=`transmute-btn ${oe.name}`,Fe.innerHTML=oe.icon,Fe.setAttribute("data-color",oe.color),Fe.addEventListener("click",_s=>{_s.stopPropagation(),No(oe.color)}),n.appendChild(Fe)}),document.body.appendChild(n),an=n,Os=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",ks)},50)}let Os=0;function ks(t){performance.now()-Os<200||an&&!an.contains(t.target)&&rn()}function Un(){document.removeEventListener("pointerdown",ks),an&&(an.remove(),an=null)}function No(t){Un(),Ke=t,ee.use(),Fo()}function Fo(){if(!Ae){rn();return}if(De.length===0){rn();return}let t=e.spellBtn;t&&t.classList.remove("selecting"),Vt="animating",gs=performance.now(),E.play("esseffect")}function Ds(t,s,n){let f=[],T=Math.floor(n/2);for(let S=-T;S<=T;S++)for(let A=-T;A<=T;A++){let rt=t+S,vt=Xn(s+A);if(rt<0||rt>=i)continue;let se=S*S+A*A;f.push({y:rt,s:vt,distSq:se})}return f}function Hs(t,s,n,f){return[...t].sort((S,A)=>S.distSq!==A.distSq?S.distSq-A.distSq:S.y!==A.y?S.y-A.y:S.s-A.s).slice(0,f).map(S=>({y:S.y,s:S.s}))}function Uo(t){if(Vt!=="animating")return!1;let s=(t-gs)/1e3;return Math.min(s/I,1)>=1?(Yo(),!1):!0}function Xo(t){if(Vt!=="animating")return null;let s=(t-gs)/1e3,n=Math.min(s/I,1),f="flash",T=0,S=0;return n<.15?(f="flash",S=1-n/.15):n<.55?(f="shrink",T=(n-.15)/.4):(f="grow",T=(n-.55)/.45),{phase:f,progress:T,areaFlash:S}}function Yo(){for(let t of De)x[t.y][t.s]=Ke;Vt="idle",Ae=null,Ke=null,qe=[],De=[],Se=0,bn()}function Vo(){Qt="selecting_source",He=null,ze=[],jt=[],Mn=0,Vt!=="idle"&&rn(),Yt.deactivate(),E.play("ulta");let t=e.spellBtn;t&&t.classList.add("selecting")}function xn(){Qt!=="idle"&&E.play("cancel"),Qt="idle",He=null,ze=[],jt=[],Mn=0;let t=e.spellBtn;t&&t.classList.remove("selecting")}function Wo(t,s){if(Qt!=="selecting_source")return!1;let n=Ps(t,s);if(!n)return xn(),!0;He={y:n.y,s:n.s,color:x[n.y][n.s]},ze=Ds(n.y,n.s,w);let f=He.color,T=ze.filter(S=>x[S.y][S.s]===f);return jt=Hs(T,n.y,n.s,B),jt.length===0?(xn(),!0):(ee.use(),Ko(),!0)}function Ko(){if(!He||jt.length===0){xn();return}let t=e.spellBtn;t&&t.classList.remove("selecting"),Qt="animating",ms=performance.now(),Mn=0,E.play("asseffect")}function qo(t){if(Qt!=="animating")return!1;let s=t-ms,n=y+jt.length*R;return s>=n?(Qo(),!1):!0}function zo(t){if(Qt!=="animating")return null;let s=t-ms;if(s<y)return{phase:"flash",flashProgress:1-s/y,currentTarget:-1,jumpProgress:0,struckTargets:[]};let n=s-y,f=Math.floor(n/R),T=n%R/R,S=[];for(let A=0;A<Math.min(f,jt.length);A++)S.push(A);return{phase:"chain",flashProgress:0,currentTarget:Math.min(f,jt.length-1),jumpProgress:T,struckTargets:S}}function Qo(){let s=jt.length*Bn;wt.addScore(s),Gt=wt.score;for(let n of jt)x[n.y][n.s]=0;Qt="idle",He=null,ze=[],jt=[],Mn=0,Se=0,bn()}let ki=100;function Di(t,s){return Rs(t,s,i,c)}function jo(){return To(x,i,c)}let Zo=_o;function Jo(t){let s=t.map(f=>({...f,color:x[f.y][f.s]}));for(let f of t)x[f.y][f.s]=0;let n=i;for(let f of t){let T=f.y;for(let S=1;S<=f.y;S++){let A=f.y-S;if(x[A][f.s]){T=S-1;break}}n=Math.min(n,T)}for(let f of s)x[f.y-n][f.s]=f.color;return n>0}function ti(){let t=!0;for(;t;){t=!1;let s=jo();for(let n of s)Zo(n)||Jo(n)&&(t=!0)}}function ei(){bn()}let fs=Co;function $s(t,s){let n=new Map,f=0,T=0,S=0,A={},rt=t.length+s.length;for(let X of t){let K=Me[X.color],ut=0,pt=0;if(X.length>=5?(ut=nt,pt=Wt,j.lines5++):X.length===4?(ut=u,pt=xe,j.lines4++):X.length===3&&(ut=At,pt=Q,j.lines3++),K&&ut>0){Yt.addCharges(K,ut),A[K]=(A[K]||0)+ut;let Et=X.cells[Math.floor(X.cells.length/2)],Bt=ws(Et.y,Et.s),Pt=us[K];for(let Rt=0;Rt<ut;Rt++)setTimeout(()=>{fe.spawnMagicOrb(K,Bt.x,Bt.y,Pt)},Rt*100)}f+=pt*p(),S+=pt,T+=X.length*_t;for(let Et of X.cells){let Bt=`${Et.y},${Et.s}`;n.has(Bt)||n.set(Bt,{y:Et.y,s:Et.s,color:X.color,isLine:!0})}}for(let X of s){if(j.pairs++,f+=Ue*p(),S+=Ue,T+=ns,Is()&&ee.addProgress(1)){let K=X.cells[Math.floor(X.cells.length/2)],ut=ws(K.y,K.s);fe.spawnSpellOrb(ut.x,ut.y,ee.button)}for(let K of X.cells){let ut=`${K.y},${K.s}`;n.has(ut)||n.set(ut,{y:K.y,s:K.s,color:x[K.y][K.s],isLine:!1})}}let vt=fs(Z,rt-1),se=fs(J,Se),lt=Math.round(T*vt*se),U=0;rt>1&&(j.combos++,j.maxCombo=Math.max(j.maxCombo,rt),setTimeout(()=>Ot(`COMBO \xD7${rt}`,"combo"),U),U+=180,E.play("combo2")),Se>0&&(j.cascades++,j.maxCascade=Math.max(j.maxCascade,Se),setTimeout(()=>Ot(`CASCADE \xD7${Se}`,"cascade"),U),U+=180,E.play("cascade")),(t.length>0||s.length>0)&&E.play("combo");for(let X of t){let K=X.length,ut=K*_t;setTimeout(()=>Ot(`Line-${K} +${ut}`,"line",X.color),U),U+=100}for(let X of s){let K=X.cells.length>0?x[X.cells[0].y][X.cells[0].s]:null;setTimeout(()=>Ot(`Pair +${ns}`,"pair",K),U),U+=100}lt>0&&(setTimeout(()=>Ot(`+${lt}`,"score"),U),U+=120),S>0&&(setTimeout(()=>Ot(`+${S}s`,"time"),U),U+=120);for(let[X,K]of Object.entries(A))K>0&&(setTimeout(()=>Ot(`+${K}${pn(X)}`,"charge"),U),U+=120);Be=Array.from(n.values()),Sn=performance.now(),Re=!0,We=!1,ne=f,ye=lt,ds()}function ni(){for(let t of Be)x[t.y][t.s]=0;if(Be.length>0&&E.playRandom("disappear"),ne>0){ge+=ne;let t=ne/p();ln.spawnBonusBubbles(t)}wt.addScore(ye),Gt+=ye,Kn(),Be=[],Re=!1,We=!1,ne=0,ye=0,Se++,bn()}function bn(){ti();let{lineMatches:t,pairMatches:s}=gi();if(t.length>0||s.length>0)$s(t,s);else{let n=Ys();n.length>0?li(n):!F&&St==="playing"&&Xs()}}function Hi(t,s){$s(t,s)}function Xn(t){return dn(t,c)}function Yn(){return Xn(Math.round(bt))}function Gs(t,s){return As(F,t,s,x,i,c)}function Vn(t){return Gs(t,Yn())}let Wn=vo;function Ns(){we&&(Jt!==0&&Ht>=Jt||(It=0,Ht+=1))}function si(){if(!F)return;let t=F.cells,s=F.colors,n={cells:t,colors:s};if(C>=0||(n=Wn(n.cells,n.colors),n=Wn(n.cells,n.colors)),n=Wn(n.cells,n.colors),F.cells=n.cells,F.colors=n.colors,!Vn(Math.floor(D))){F.cells=t,F.colors=s;return}E.play("turn"),mt&&Ns()}function oi(){return Lo(F,D,Yn(),x,i,c)}function ii(){if(!F)return!1;let t=Math.floor(D)-1,s=!Vn(t);return s&&!mt?(mt=!0,It=0,Ht=0):!s&&mt&&(mt=!1,It=0,Ht=0),s}let je=ts;function Cn(){if(St==="playing"){In.classList.add("hidden"),qt.classList.remove("hidden");return}if(In.classList.remove("hidden"),qt.classList.add("hidden"),St==="intro"){G.classList.remove("hidden"),it.classList.add("hidden");let t=V.loadHighscore(zt);t.score>0?(Lt.textContent=t.score.toLocaleString(),Ct.textContent=je(t.time)):(Lt.textContent="0",Ct.textContent="0:00"),so(),he.textContent=`v${Ce}`,Kt.classList.remove("idlePulse"),Kt.offsetWidth,Kt.classList.add("idlePulse")}else{G.classList.add("hidden"),it.classList.remove("hidden"),at.textContent=Gt.toLocaleString(),dt.textContent=je(ve);let t=V.loadHighscore(zt);Gt>0&&Gt>=t.score?pe.classList.remove("hidden"):pe.classList.add("hidden");let s=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${j.rings}</span>
          <span class="count ring-max">${j.maxRing>0?"max \xD7"+j.maxRing:""}</span>
        </div>
      `;st.innerHTML=s;let n=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${j.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${j.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${j.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${j.pairs}</span>
        </div>
      `;xt.innerHTML=n;let f=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${j.combos}</span>
          <span class="count max-combo">${j.maxCombo>0?"max \xD7"+j.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${j.cascades}</span>
          <span class="count max-cascade">${j.maxCascade>0?"max \xD7"+j.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${j.magicUsed}</span>
        </div>
      `;Xt.innerHTML=f}}function Kn(){hn.textContent=`Score: ${Gt}`}function ps(){Ye.textContent=`Time: ${je(ve)}`}function Fs(){let t=Math.max(0,(i-te)/p()),s=Math.floor(t/60),n=Math.floor(t%60);Pe.textContent=`Left: ${s}:${n.toString().padStart(2,"0")}`,t<30?Pe.classList.add("warning"):Pe.classList.remove("warning")}function ci(){g(zt),Dt(),te=0,ge=0,bt=be=0,yt=0,wt.start(),j=wt.stats,Gt=0,An=performance.now(),ve=0,nn=0,Xe=0,St="playing",le=null,Yt.reset(),ee.reset(),Nn(),Be=[],cn=[],Re=!1,We=!1,En=!1,ne=0,ye=0,Se=0,Vt="idle",Ae=null,Ke=null,qe=[],De=[],Un(),Qt="idle",He=null,ze=[],jt=[],Mn=0,ds(),Kn(),ps(),Fs(),Xs(),ln.drawNextPreview(Oe,le),Cn(),E.getSettings().musicEnabled&&E.startGameMusic()}function hs(){wt.gameOver(),St="gameover",F=null,mt=!1,It=0,Ht=0;let t=V.saveHighscore(Gt,ve,zt);E.stopMusic(),E.play("gameover"),ps(),Cn(),t&&Gt>0&&setTimeout(()=>{Ot("\u{1F3C6} NEW RECORD!","score")},500)}function ai(t){for(let n=0;n<50;n++){let f=t.map(()=>1+(Math.random()*4|0));if(!ri(t,f))return f}return t.map((n,f)=>1+f%4)}let ri=Ao;function Us(t){let s=t.cells.map(f=>({x:f.x,y:f.y})),n=ai(s);return{name:t.name,cells:s,colors:n}}function Xs(){if(!le){let T=v[Math.random()*v.length|0];le=Us(T)}F=le;let t=v[Math.random()*v.length|0];le=Us(t),ln.drawNextPreview(Oe,le);let s=1/0,n=-1/0;for(let T of F.cells)T.x<s&&(s=T.x),T.x>n&&(n=T.x);let f=(s+n)/2;for(let T of F.cells)T.x=T.x-Math.round(f);D=i+3,Ut=0,mt=!1,It=0,Ht=0,Vn(Math.floor(D))?E.playRandom("appear"):hs()}function Ys(){return Ro(x,i,c)}function li(t){if(t.length===0)return;let s=[];for(let rt of t)for(let vt=0;vt<c;vt++)s.push({y:rt,s:vt,color:x[rt][vt],isLine:!1});cn=t,Be=s,Sn=performance.now(),Re=!0,En=!0,We=!1;let n=t.length;j.rings+=n,j.maxRing=Math.max(j.maxRing,n);let f=fs(en,n-1),T=Math.round(kt*n*f),S=Je*n;ye=T,ne=S*p(),E.play("ring");let A=`RING \xD7${n}`;Ot(A,"ring"),setTimeout(()=>Ot(`+${T}`,"score"),150),setTimeout(()=>Ot(`+${S}s`,"time"),300)}function ui(){let t=[...cn].sort((s,n)=>n-s);for(let s of t){for(let n=s;n<i-1;n++)x[n].set(x[n+1]);x[i-1].fill(0)}if(ne>0){ge+=ne;let s=ne/p();ln.spawnBonusBubbles(s)}wt.addScore(ye),Gt+=ye,Kn(),zt==="30_24"&&cn.length>0&&(Ge=V.addHighTowerRings(cn.length)),Be=[],cn=[],Re=!1,En=!1,ne=0,ye=0,bn()}function $i(){return Ys().length}function di(){if(!F)return;let t=Yn();bt=t,be=t,yt=0;let s=!1;for(let n=0;n<F.cells.length;n++){let f=F.cells[n],T=F.colors[n],S=Math.floor(D)+f.y,A=Xn(t+f.x);S>=i&&(s=!0),S>=0&&S<i&&(x[S][A]=T)}if(s){hs();return}wt.addScore(fn),Gt+=fn,Kn(),Ot(`+${fn}`,"score"),E.playRandom("drop"),F=null,Se=0,ei()}function gi(){return Bo(x,i,c)}function mi(){if(!F)return!1;let t=Math.floor(D)-1;return Vn(t)?(D=t,mt=!1,It=0,Ht=0,!0):(mt=!0,!1)}o.addEventListener("pointerdown",t=>{if(gt.state!=="playing")return;t.preventDefault?.();let s=o.getBoundingClientRect(),n=t.clientX-s.left,f=t.clientY-s.top;ft.handlePointerDown(t,{onMagicTap:()=>Vt==="selecting_source"?$o(n,f):Qt==="selecting_source"?Wo(n,f):gt.applyCommand("magic_shoot",{x:n,y:f}),onDoubleTap:()=>gt.applyCommand("rotate_piece")},be)||(yt=0)},{passive:!1}),o.addEventListener("pointermove",t=>{if(gt.state!=="playing"||!ft.dragging)return;t.preventDefault?.();let s=ft.handlePointerMove(t,{canRotateTo:(n,f)=>gt.canRotateTo(n,f),onDrop:()=>gt.applyCommand("move_down"),onGroundedMove:()=>gt.onGroundedMove()},gt.pieceY,gt.isGrounded);s&&gt.setRotation(s.targetRot)},{passive:!1}),o.addEventListener("pointerup",t=>{gt.state==="playing"&&ft.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointercancel",t=>{ft.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointerleave",t=>{ft.dragging&&ft.handlePointerUp(t)},{passive:!1}),_.addEventListener("click",()=>{gt.state==="playing"&&gt.applyCommand("rotate_piece")});let qn=e.dropBtn,zn=null;function fi(){gt.state==="playing"&&(gt.applyCommand("move_down"),zn=setInterval(()=>{if(gt.state!=="playing"){Qn();return}gt.applyCommand("move_down")},Ft))}function Qn(){zn&&(clearInterval(zn),zn=null)}qn.addEventListener("pointerdown",t=>{t.preventDefault(),fi()}),qn.addEventListener("pointerup",Qn),qn.addEventListener("pointerleave",Qn),qn.addEventListener("pointercancel",Qn);for(let[t,s]of Object.entries(us))s.addEventListener("click",()=>{gt.state==="playing"&&gt.applyCommand("select_magic",{element:t})});let ys=e.soundsToggle,Ss=e.musicToggle;function $e(){let t=E.getSettings();t.soundsEnabled?ys.classList.add("active"):ys.classList.remove("active"),t.musicEnabled?Ss.classList.add("active"):Ss.classList.remove("active");for(let s=0;s<=4;s++){let n=e.soundVolBtns[s],f=e.musicVolBtns[s];n&&n.classList.toggle("active",t.soundVolume===s),f&&f.classList.toggle("active",t.musicVolume===s)}}let Vs=e.tabBtns,pi=e.tabContents;Vs.forEach(t=>{t.addEventListener("click",()=>{let s=t.dataset.tab;Vs.forEach(n=>n.classList.remove("active")),pi.forEach(n=>n.classList.remove("active")),t.classList.add("active"),po(s).classList.add("active"),s==="sounds"&&$e()})});let Ws=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Ks=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,hi=e.iosHint,yi=e.standaloneBadge;function qs(){let t=document.fullscreenElement||document.webkitFullscreenElement;O.textContent=t?"Disable":"Enable"}Ws&&(Ks?(yi.style.display="block",O.style.display="none"):(hi.style.display="block",O.textContent="Not supported",O.style.opacity="0.5",O.style.cursor="default")),O.addEventListener("click",()=>{if(Ws&&!Ks)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let s=document.documentElement;s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",qs),document.addEventListener("webkitfullscreenchange",qs);let jn=e.invertSwipeToggle;tt.invertSwipe&&jn.classList.add("active"),jn.addEventListener("click",()=>{jn.classList.toggle("active");let t=jn.classList.contains("active");ft.rotDir=t?-1:1,tt.invertSwipe=t,V.saveGameSettings(tt)});let zs=e.diffBtns;zs.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(zs.forEach(s=>{s.classList.remove("active");let n=s.querySelector(".check-icon");n&&n.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let s=document.createElement("span");s.className="check-icon",s.textContent="\u2713",t.appendChild(s)}})}),ys.addEventListener("click",()=>{let s=!E.getSettings().soundsEnabled;E.updateSettings({soundsEnabled:s}),$e(),vn()}),Ss.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),$e(),vn(),St!=="paused"&&(s?St==="playing"?E.startGameMusic():E.startMenuMusic():E.stopMusic())});for(let t=0;t<=4;t++){let s=e.soundVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({soundVolume:t}),$e(),E.play("turn")})}for(let t=0;t<=4;t++){let s=e.musicVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({musicVolume:t}),$e()})}$e();function Qs(){St==="playing"&&(wt.pause(),Xe=performance.now(),St="paused",E.musicAudio&&E.musicAudio.pause())}function Zn(){St==="paused"&&(wt.resume(),nn+=performance.now()-Xe,Xe=0,St="playing",xs=performance.now(),E.getSettings().musicEnabled&&E.startGameMusic())}function vn(){let t=E.getSettings();on.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",on.classList.toggle("off",!t.soundsEnabled),Dn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Dn.classList.toggle("off",!t.musicEnabled)}function Si(){Te.classList.remove("hidden"),qt.classList.add("hidden");let t=V.loadHighscore(zt);Hn.textContent=t.score?t.score.toLocaleString():"0",_e.textContent=t.time?ts(t.time):"0:00",Le.textContent=zt==="30_24"?"High Tower":"Quick Tower",as.textContent=Gt.toLocaleString(),rs.textContent=ts(ve),$n.textContent=zt==="30_24"?"High Tower":"Quick Tower",vn()}function Tn(){Te.classList.add("hidden"),qt.classList.remove("hidden")}qt.addEventListener("click",()=>{Qs(),Si()}),On.addEventListener("click",()=>{Tn(),Zn()});let Es=null;function js(t,s){H.textContent=t,Es=s,M.classList.remove("hidden")}function Zs(){M.classList.add("hidden"),Es=null}N.addEventListener("click",()=>{Zs()}),$.addEventListener("click",()=>{let t=Es;Zs(),t&&t()}),cs.addEventListener("click",()=>{js("Restart game?",()=>{Tn(),gt.applyCommand("start_game")})}),kn.addEventListener("click",()=>{js("Exit to menu?",()=>{Tn(),qt.classList.add("hidden"),St="intro",wt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),Cn()})}),ke.addEventListener("click",()=>{P.classList.remove("hidden")}),on.addEventListener("click",()=>{let t=E.getSettings();E.updateSettings({soundsEnabled:!t.soundsEnabled}),vn(),$e()}),Dn.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),vn(),$e()}),Te.addEventListener("click",t=>{t.target===Te&&(Tn(),Zn())}),document.addEventListener("keydown",t=>{St==="paused"&&!Te.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Tn(),Zn())}),W.addEventListener("click",()=>{P.classList.add("hidden")}),P.addEventListener("click",t=>{t.target===P&&P.classList.add("hidden")});let Ms=!1;document.addEventListener("visibilitychange",()=>{document.hidden?St==="playing"&&(Qs(),Ms=!0):Ms&&St==="paused"&&(Zn(),Ms=!1)});let gt=Io({getN:()=>c,getH:()=>i,FALL_INTERVAL:ae,LOCK_DELAY_SEC:re,getKillRate:p,MATCH_HIGHLIGHT_SEC:_n,MAGIC_SHRINK_SEC:gn,RING_HIGHLIGHT_SEC:Mt,getState:()=>({gameState:St,score:Gt,elapsedMs:ve,startTime:An,totalPausedMs:nn,stats:j,activePiece:F,pieceY:D,targetRot:be,rotFloat:bt,rotVel:yt,isGrounded:mt,isHighlighting:Re,isMagicAnimation:We,isRingAnimation:En,highlightStartTime:Sn,killLevel:te,grid:x,fallTimer:Ut,lockTimer:It}),setState:t=>{"elapsedMs"in t&&(ve=t.elapsedMs),"killLevel"in t&&(te=t.killLevel),"fallTimer"in t&&(Ut=t.fallTimer),"lockTimer"in t&&(It=t.lockTimer),"targetRot"in t&&(be=t.targetRot),"rotFloat"in t&&(bt=t.rotFloat),"rotVel"in t&&(yt=t.rotVel)},funcs:{startGame:ci,endGame:hs,rotatePieceByDir:si,tryMoveDown:mi,canPlaceAtRot:Gs,maybeResetLockDelay:Ns,shootMagic:Do,selectMagic:Oo,updateGroundedState:ii,lockPiece:di,finishHighlight:ni,finishRingHighlight:ui},ui:{updateTimeHud:ps,updateRemainingHud:Fs}}),ln=wo({canvas:o,canvasCtx:l,getN:()=>c,getH:()=>i,TOP_PAD_PX:h,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:Y,MAX_RADIUS_X:q,RADIUS_X_FACTOR:et,ANG_OFFSET:m,MATCH_HIGHLIGHT_SEC:_n,MATCH_SHRINK_PHASE:es,MAGIC_SHRINK_SEC:gn,RING_HIGHLIGHT_SEC:Mt,LOCK_DELAY_SEC:re,getKillRate:p,ELEMENT_COLORS:Ie,ELEMENT_TO_COLOR:ce,BLOCK_COLOR_FRONT:ct,BLOCK_COLOR_BACK:Tt,ACTIVE_COLOR_FRONT:Ee,GHOST_COLOR_FILL:ot,GHOST_COLOR_STROKE:z,GHOST_STROKE_WIDTH:ht,MAGIC_DIM_DOT_ALPHA:mn,MAGIC_DIM_DOT_SCALE:tn,MAGIC_TARGET_DOT_SCALE:Ln,getState:()=>({gameState:St,grid:x,activePiece:F,pieceY:D,rotFloat:bt,killLevel:te,isHighlighting:Re,highlightedCells:Be,highlightStartTime:Sn,isMagicAnimation:We,isRingAnimation:En,isGrounded:mt,lockTimer:It,transmuteState:Vt,transmuteSourceBlock:Ae,transmuteTargetColor:Ke,transmuteAreaCells:qe,transmuteBlocksToChange:De,lightningState:Qt,lightningSourceBlock:He,lightningAreaCells:ze,lightningBlocksToHit:jt}),getVisualSettings:()=>({waterBubbles:me,waterColor:Rn}),funcs:{snappedRot:Yn,computeGhostY:oi,normSector:Xn,getMagicTargetColor:()=>Yt.canUse()?ce[Yt.active]:null,getTransmuteAnimState:Xo,getLightningAnimState:zo}}),xs=performance.now();function Js(t){let s=Math.min(.05,Math.max(.001,(t-xs)/1e3));if(xs=t,gt.update(s,t),Uo(t),qo(t),ge>0){let n=Math.min(ge,$t*s);te=Math.max(0,te-n),ge-=n}bt=be,bt>1e6&&(bt%=c),bt<-1e6&&(bt%=c),ln.render(s,t),requestAnimationFrame(Js)}Kt.addEventListener("click",()=>{gt.applyCommand("start_game")}),Ve.addEventListener("click",()=>{gt.applyCommand("start_game")}),Nt.addEventListener("click",()=>{St="intro",wt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),Cn()}),ue.forEach(t=>{t.addEventListener("click",s=>{ue.forEach(f=>f.classList.remove("active")),t.classList.add("active"),zt=t.dataset.mode,Nn();let n=V.loadHighscore(zt);n.score>0?(Lt.textContent=n.score.toLocaleString(),Ct.textContent=je(n.time)):(Lt.textContent="0",Ct.textContent="0:00"),Kt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>Kt.classList.add("idlePulse"),2e3)})});let bs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),to=document.getElementById("spellProgressFill"),vs=document.getElementById("spellProgressMarkers"),Jn={ice:0,earth:10,air:25,fire:40},eo=Object.values(Jn).sort((t,s)=>t-s),Ts=Math.max(...eo),Ei={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"},Ge=V.loadHighTowerRings();function Mi(){vs&&(vs.innerHTML="",eo.forEach(t=>{let s=document.createElement("span");s.className="marker",s.dataset.threshold=t;let n=t/Ts*100;s.style.left=`${n}%`,vs.appendChild(s)}))}function xi(t){return t<=0?0:t>=Ts?100:t/Ts*100}function no(t){if(!Cs)return;let s=Jn[t]||0,n=Ei[t]||"";s===0||Ge>=s?Cs.innerHTML=n:Cs.innerHTML=`${n} <span class="spell-progress-text">${Ge}/${s}</span>`}function so(){if(Ge=V.loadHighTowerRings(),bs.forEach(n=>{let f=n.dataset.spell,T=Jn[f]||0,S=Ge>=T;n.classList.toggle("locked",!S);let A=n.querySelector(".spell-lock");A&&(A.style.display=S?"none":"")}),to){let n=xi(Ge);to.style.width=`${n}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(n=>{let f=parseInt(n.dataset.threshold,10)||0;n.classList.toggle("reached",Ge>=f)});let s=document.querySelector(".spell-select-btn.active");s&&no(s.dataset.spell)}Mi(),so(),bs.forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation();let n=document.querySelector('.mode-btn[data-mode="30_24"]');if(n&&!n.classList.contains("active")){ue.forEach(rt=>rt.classList.remove("active")),n.classList.add("active"),zt="30_24",Nn();let A=V.loadHighscore(zt);A.score>0?(Lt.textContent=A.score.toLocaleString(),Ct.textContent=je(A.time)):(Lt.textContent="0",Ct.textContent="0:00")}let f=t.dataset.spell,T=Jn[f]||0,S=Ge>=T;no(f),S&&(bs.forEach(A=>A.classList.remove("active")),t.classList.add("active"),ee.selectSpell(f))})}),ls.addEventListener("click",()=>{let t=V.loadHighscore("30_24"),s=V.loadHighscore("25_20"),n=`Records

`;n+=`High Tower (30\xD724):
`,n+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${je(t.time)}
`:`  No record yet
`,n+=`
Quick Tower (25\xD720):
`,n+=s.score>0?`  Score: ${s.score.toLocaleString()}, Time: ${je(s.time)}
`:`  No record yet
`,alert(n)}),Gn.addEventListener("click",()=>{P.classList.remove("hidden")}),Po.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),ds(),Nn(),Cn(),E.startMenuMusic();let bi=()=>{if(E.unlock(),!E.getSettings().musicEnabled)return;let t=E.musicAudio;!t||t.paused||t.ended?gt.state==="playing"?E.startGameMusic():E.startMenuMusic():t.play().catch(s=>{console.debug("Music resume on interaction failed:",s)})},oo=0,Ci=10,vi=()=>{oo>=Ci||(oo++,bi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,vi,{passive:!0})}),requestAnimationFrame(Js)})();})();
