(()=>{var Di=[0,.25,.5,.75,1],Hi=[0,.05,.15,.25,.5],$i={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},yo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},So="soundSettings";function Fi(){try{let e=localStorage.getItem(So);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Gi(e){try{localStorage.setItem(So,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Eo(){return{audioContext:null,buffers:{},settings:Fi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Di[this.settings.soundVolume]},getMusicVolume(){return Hi[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(u){console.debug(`Failed to load sound: ${n} from ${c}`,u)}},preload(){this.initContext();for(let[n,c]of Object.entries($i))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;c!==null&&(u=`${n}${c}`);let i=this.buffers[u];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Gi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Mo="eb_highscore",bo="eb_highscore_quick",xo="eb_settings",vo="eb_high_tower_rings",Ni={invertSwipe:!1,hapticsEnabled:!0};function Co(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?bo:Mo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let u=this.loadHighscore(c);if(e>u.score||e===u.score&&n>u.time){let i=c==="25_20"?bo:Mo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(xo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Ni}},saveGameSettings(e){try{localStorage.setItem(xo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(vo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(vo,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function To(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function _o(e){return document.getElementById("tab-"+e)}var Ui={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Bo(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(u,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=u,s&&n[s]&&(r.style.color=n[s]);let m=window.innerWidth/2,g=window.innerHeight/2-40,f=(Math.random()-.5)*200,d=(Math.random()-.5)*100+c*36;r.style.left=`${m+f}px`,r.style.top=`${g+d}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(u){return Ui[u]||"\u2726"}}}var Ls={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Lo(){return{spawnMagicOrb(e,n,c,u){if(!u)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Ls[e]||"\u2726";let s=u.getBoundingClientRect(),r=s.left+s.width/2-n,m=s.top+s.height/2-c,g=Math.hypot(r,m),f=Math.atan2(m,r),d=g*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,A=r*.5+Math.cos(p)*d,z=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${A}px`),i.style.setProperty("--mid-y",`${z}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,u,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,m=s.top+s.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=Ls[e]||"\u2726";let f=c-r,d=u-m;g.style.setProperty("--end-x",`${f}px`),g.style.setProperty("--end-y",`${d}px`),g.style.left=`${r}px`,g.style.top=`${m}px`,document.body.appendChild(g);let p=setInterval(()=>{let A=g.getBoundingClientRect();this.spawnTrailParticle(e,A.left+A.width/2,A.top+A.height/2)},40);setTimeout(()=>{clearInterval(p),g.remove(),this.spawnExplosion(e,c,u),i&&i()},300)},spawnTrailParticle(e,n,c){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${c}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,g=Math.cos(r)*m,f=Math.sin(r)*m;s.style.setProperty("--px",`${g}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let u=n;typeof n=="number"&&(c=n,u="water"),Ls[u]||(u="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,m=Math.max(8,Math.round(c));for(let g=0;g<m;g++){let f=document.createElement("div");f.className=`spell-bubble ${u}`,f.textContent="\u25CF";let d=g/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,A=Math.cos(d)*p,z=Math.sin(d)*p-20;f.style.setProperty("--px",`${A}px`),f.style.setProperty("--py",`${z}px`),f.style.left=`${s}px`,f.style.top=`${r}px`,f.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,m=Math.hypot(s,r),g=Math.atan2(r,s),f=m*.35*(Math.random()>.5?1:-1),d=g+Math.PI/2,p=s*.5+Math.cos(d)*f,A=r*.5+Math.sin(d)*f;u.style.setProperty("--mid-x",`${p}px`),u.style.setProperty("--mid-y",`${A}px`),u.style.setProperty("--end-x",`${s}px`),u.style.setProperty("--end-y",`${r}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}var Xi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Yi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},As=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Ro({enabled:e=!0,patterns:n=Xi}={}){let c=Yi(),u=c?new As(c):new Rs,i=u.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let m=n[r];return m?u.trigger({name:r,...m}):!1}}}function Ao(e={}){let{buttons:n={},onActivate:c=null,onChange:u=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[g,f]of Object.entries(n)){if(!f)continue;let d=i[g],p=f.querySelector(".charges");p&&(p.textContent=d),f.classList.toggle("empty",d<=0),f.classList.toggle("active",s===g&&d>0)}u&&u({...i},s)}function m(g){let f=n[g];f&&(f.classList.remove("pulse"),f.offsetWidth,f.classList.add("pulse"),setTimeout(()=>f.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(g){s=g},select(g){if(i[g]<=0)return!1;let f=s===g;return s=f?null:g,r(),!f&&s===g&&c&&c(),!f},useCharge(){if(!s||i[s]<=0)return!1;let g=s;return i[g]--,s=null,r(),m(g),!0},addCharges(g,f){i[g]!==void 0&&(i[g]+=f,r(),m(g))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(g){for(let[f,d]of Object.entries(n))d&&d.addEventListener("click",()=>{g&&g(f)})}}}var Ne={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Io(e={}){let{button:n=null,onActivate:c=null,onProgress:u=null,onReady:i=null}=e,s="ice",r=0;function m(){return Ne[s]||Ne.ice}function g({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),A=Number.isFinite(p.maxProgress)?p.maxProgress:0,z=A>0?Math.min(r/A,1)*100:0,F=A>0&&r>=A;n.style.setProperty("--progress",`${z}%`);let V=n.querySelector(".spell-icon");V&&(V.textContent=p.icon);let ot=n.querySelector(".spell-counter");ot&&(ot.textContent=A>0?`${Math.min(r,A)}/${A}`:""),n.classList.toggle("ready",F),n.classList.toggle("charging",!F&&r>0),u&&!d&&A>0&&u(r,A)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},get effect(){return m().effect},getUnlockRings(d){return(Ne[d]||Ne.ice).unlockRings??0},getCost(d){return(Ne[d]||Ne.ice).cost??0},getDescription(d){return(Ne[d]||Ne.ice).description||""},getEffect(d){return(Ne[d]||Ne.ice).effect},get button(){return n},selectSpell(d){Ne[d]&&(s=d,r=0,g())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let A=r<p.maxProgress;return r=Math.min(r+d,p.maxProgress),g(),f(),A&&r>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){r=Math.max(0,d),g({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},use(){if(!this.canUse())return null;let d=m().effect;return r=0,g(),f(),c&&c(s),d},reset(){r=0,g()},pulse(){f()},updateButton:g,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function Is({centerY:e,centerS:n,size:c,H:u,normSector:i}){let s=[],r=Math.floor(c/2);for(let m=-r;m<=r;m++)for(let g=-r;g<=r;g++){let f=e+m,d=i(n+g);if(f<0||f>=u)continue;let p=m*m+g*g;s.push({y:f,s:d,distSq:p})}return s}function as(e,n,c){return n.filter(u=>e[u.y][u.s]===c)}function ls(e,n){return[...e].sort((u,i)=>u.distSq!==i.distSq?u.distSq-i.distSq:u.y!==i.y?u.y-i.y:u.s-i.s).slice(0,n).map(u=>({y:u.y,s:u.s}))}function wo({centerY:e,centerS:n,beamLength:c,beamWidth:u,N:i,H:s,normSector:r}){if(e<0||e>=s||u<=0||c<0||i<=0)return[];let m=Math.min(u,s),g=[],f=new Set,d=F=>F<0||F>=s||f.has(F)?!1:(f.add(F),g.push(F),!0);d(e);for(let F=1;g.length<m&&(e+F<s||e-F>=0)&&(d(e+F),!(g.length>=m));F++)d(e-F);g.sort((F,V)=>V-F);let p=Math.min(i,c*2+1),A=c%2===0,z=[];for(let F of g){let V=new Set,ot=(gt,ge)=>{let Z=r(gt);return V.has(Z)?!1:(V.add(Z),z.push({y:F,s:Z,dist:ge}),!0)};ot(n,0);for(let gt=1;V.size<p&&gt<i;gt++)if(A){if(ot(n+gt,gt),V.size>=p)break;ot(n-gt,gt)}else{if(ot(n-gt,gt),V.size>=p)break;ot(n+gt,gt)}}return z}function Po(e){let{canvas:n,dom:c,getGrid:u,getN:i,getH:s,getRotFloat:r,constants:m,helpers:g,Spell:f,Magic:d,SoundModule:p,State:A,isGamePlaying:z,addPendingKzDrop:F,getKillRate:V,triggerSpellWave:ot,spawnSpellBubbles:gt,spawnBonusBubbles:ge,getTransmuteEffect:Z,getLightningEffect:W,getFireEffect:Et,continueMatchProcessing:Ae,updateScoreHud:Me,showBonus:Qt,getSpellCost:jt,getSpellElement:Zt,onUltimateApplied:Jt,isSpellBlocked:te,setScore:Pt,setCascadeLevel:vt}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:it,SIDE_MARGIN_PX:Q,MAX_RADIUS_X:me,SCORE_MAGIC_DESTROY:oe}=m,{normSector:He,levelYToScreenY:$e,sectorCenterXY:Sn}=g,An=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],pt="idle",J=null,re=null,Gt=[],Xt=[],Qe=0,Ct=null,Ue=0,j="idle",be=null,xe=[],ee=[],G=0,v=0,b="idle",I=null,w=[],S=[],tt=0;function q(y){if(typeof jt!="function"||typeof Zt!="function")return!1;let R=Zt(y),x=jt(y);return!R||!x?!1:(d.charges[R]??0)>=x}function H(y){if(typeof jt!="function"||typeof Zt!="function")return!1;let R=Zt(y),x=jt(y);return!R||!x||(d.charges[R]??0)<x?!1:(d.charges[R]-=x,d.updateButtons(),f.pulse(),!0)}let ht=0,C=350;function h(){return typeof te=="function"?te():!1}function _(){let y=performance.now();y-ht<C||(ht=y,p.play("cancel"))}function kt(){pt="selecting_source",J=null,re=null,Gt=[],Xt=[],j!=="idle"&&T(),b!=="idle"&&rt(),d.deactivate(),p.play("ulta");let y=c.spellBtn;y&&y.classList.add("selecting")}function M(){pt!=="idle"&&p.play("cancel"),pt="idle",J=null,re=null,Gt=[],Xt=[],Nt();let y=c.spellBtn;y&&y.classList.remove("selecting")}function yt(y,R){if(pt!=="selecting_source")return!1;if(h())return _(),!0;let x=O(y,R);if(!x)return M(),!0;let nt=u();J={y:x.y,s:x.s,color:nt[x.y][x.s]},Gt=Is({centerY:x.y,centerS:x.s,size:Z().areaSize,H:s(),normSector:He});let Mt=J.color,St=as(nt,Gt,Mt);return Xt=ls(St,Z().maxBlocks),Ot(J.color,x.y),pt="selecting_target",!0}function O(y,R){let x=n.clientWidth,nt=n.clientHeight,Mt=x*.5,St=(x-2*Q)/2,wt=nt-l-it,Ge=6,Ht=s(),ce=i(),we=r(),Ve=ce*wt/(Ge*Ht),ae=nt-it,ne,Te,_e;Ve<=Math.min(St,me)?(ne=Ve,Te=wt,_e=l):(ne=Math.min(St,me),Te=ne*Ge*Ht/ce,_e=ae-Te);let Pe=ne*.28,Ze=null,mn=1/0,Je=u();for(let $t=0;$t<Ht;$t++){let cn=$e(_e,Te,$t+.5);for(let pe=0;pe<ce;pe++){if(!Je[$t][pe])continue;let Be=Sn(Mt,cn,ne,Pe,pe,we);if(Math.sin(Be.ang)<-.1)continue;let zt=y-Be.x,ke=R-Be.y,he=Math.hypot(zt,ke),qt=Te/Ht*.9,B=qt*1.2;Math.abs(zt)<B/2&&Math.abs(ke)<qt/2&&he<mn&&(mn=he,Ze={y:$t,s:pe})}}return Ze}function Ot(y,R){Nt();let x=document.createElement("div");x.className="transmute-popup";let nt=n.clientWidth,Mt=n.clientHeight,St=(nt-2*Q)/2,wt=Mt-l-it,Ge=6,Ht=s(),ce=i(),we=ce*wt/(Ge*Ht),Ve=Mt-it,ae,ne;we<=Math.min(St,me)?(ae=wt,ne=l):(ae=Math.min(St,me)*Ge*Ht/ce,ne=Ve-ae);let Te=$e(ne,ae,R+.5),_e=Math.floor(Z().areaSize/2),Pe=$e(ne,ae,Math.min(Ht,R+_e)+.5),Ze=$e(ne,ae,Math.max(0,R-_e)+.5),mn=ne+ae/2,Je=document.getElementById("gameContainer"),$t=Je?Je.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},cn=160,pe=60,Be=20,an=$t.left+$t.width/2-cn/2,zt;Te<mn?zt=$t.top+Ze+Be:zt=$t.top+Pe-pe-Be,zt=Math.max(10,Math.min(window.innerHeight-pe-10,zt)),x.style.left=`${an}px`,x.style.top=`${zt}px`,An.filter(he=>he.color!==y).forEach(he=>{let qt=document.createElement("button");qt.className=`transmute-btn ${he.name}`,qt.innerHTML=he.icon,qt.setAttribute("data-color",he.color),qt.addEventListener("click",B=>{B.stopPropagation(),Tt(he.color)}),x.appendChild(qt)}),document.body.appendChild(x),Ct=x,Ue=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Yt)},50)}function Yt(y){performance.now()-Ue<200||Ct&&!Ct.contains(y.target)&&M()}function Nt(){document.removeEventListener("pointerdown",Yt),Ct&&(Ct.remove(),Ct=null)}function Tt(y){if(h()){_();return}if(!q(f.currentSpell)){_();return}if(Nt(),re=y,Xt.length===0){M();return}ve()}function ve(){if(!J){M();return}if(Xt.length===0){M();return}if(!H(f.currentSpell)){_(),M();return}let y=c.spellBtn;y&&y.classList.remove("selecting"),pt="animating",Qe=performance.now(),p.play("esseffect")}function Xe(){if(pt!=="selecting_target"&&pt!=="animating"||!J||!Gt||Gt.length===0)return;let y=u(),R=y[J.y]?.[J.s]??0;if(!R||R!==J.color){M();return}let x=as(y,Gt,R),nt=Z().maxBlocks??x.length;Xt=ls(x,nt),Xt.length===0&&M()}function Bt(y){if(pt!=="animating")return!1;let R=(y-Qe)/1e3;return Math.min(R/Z().animSec,1)>=1?(En(),!1):!0}function dn(y){if(pt!=="animating")return null;let R=(y-Qe)/1e3,x=Math.min(R/Z().animSec,1),nt="flash",Mt=0,St=0;return x<.15?(nt="flash",St=1-x/.15):x<.55?(nt="shrink",Mt=(x-.15)/.4):(nt="grow",Mt=(x-.55)/.45),{phase:nt,progress:Mt,areaFlash:St}}function En(){let y=u();for(let R of Xt)y[R.y][R.s]=re;pt="idle",J=null,re=null,Gt=[],Xt=[],vt(0),Ae(),typeof Jt=="function"&&Jt("earth")}function Dt(){p.play("ulta"),j="selecting_source",be=null,xe=[],ee=[],v=0,pt!=="idle"&&(pt="idle",J=null,re=null,Gt=[],Xt=[],Nt()),b!=="idle"&&(b="idle",I=null,w=[],S=[],tt=0),d.deactivate();let y=c.spellBtn;y&&y.classList.add("selecting")}function T(){j!=="idle"&&p.play("cancel"),j="idle",be=null,xe=[],ee=[],v=0;let y=c.spellBtn;y&&y.classList.remove("selecting")}function Rt(){b="selecting_source",I=null,w=[],S=[],tt=0,pt!=="idle"&&(pt="idle",J=null,re=null,Gt=[],Xt=[],Nt()),j!=="idle"&&(j="idle",be=null,xe=[],ee=[],v=0),d.deactivate(),p.play("ulta");let y=c.spellBtn;y&&y.classList.add("selecting")}function rt(){b!=="idle"&&p.play("cancel"),b="idle",I=null,w=[],S=[],tt=0;let y=c.spellBtn;y&&y.classList.remove("selecting")}function Vt(y,R){if(j!=="selecting_source")return!1;if(h())return _(),!0;let x=O(y,R);if(!x)return T(),!0;let nt=u();be={y:x.y,s:x.s,color:nt[x.y][x.s]},xe=Is({centerY:x.y,centerS:x.s,size:W().areaSize,H:s(),normSector:He});let Mt=be.color,St=as(nt,xe,Mt);return ee=ls(St,W().maxBlocks),ee.length===0?(T(),!0):q(f.currentSpell)?(Ce(),!0):(_(),!0)}function Ie(y,R){if(b!=="selecting_source")return!1;if(h())return _(),!0;let x=O(y,R);if(!x)return rt(),!0;let nt=u();return I={y:x.y,s:x.s,color:nt[x.y][x.s]},w=wo({centerY:x.y,centerS:x.s,beamLength:Et().beamLength,beamWidth:Et().beamWidth,N:i(),H:s(),normSector:He}),S=w.filter(Mt=>nt[Mt.y][Mt.s]),S.length===0?(rt(),!0):q(f.currentSpell)?(lt(),!0):(_(),!0)}function Ce(){if(!be||ee.length===0){T();return}if(!H(f.currentSpell)){_(),T();return}let y=c.spellBtn;y&&y.classList.remove("selecting"),j="animating",G=performance.now(),v=0,p.play("asseffect")}function rn(y){if(j!=="animating")return!1;let R=y-G,x=W().flashMs+ee.length*W().jumpMs;return R>=x?(Fe(),!1):!0}function fn(y){if(j!=="animating")return null;let R=y-G;if(R<W().flashMs)return{phase:"flash",flashProgress:1-R/W().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let x=R-W().flashMs,nt=Math.floor(x/W().jumpMs),Mt=x%W().jumpMs/W().jumpMs,St=[];for(let wt=0;wt<Math.min(nt,ee.length);wt++)St.push(wt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(nt,ee.length-1),jumpProgress:Mt,struckTargets:St}}function Fe(){let y=u(),R=ee.length,x=R*oe;A.addScore(x),Pt(A.score),Me(),Qt(`+${x}`,"score");for(let wt of ee)y[wt.y][wt.s]=0;let nt=W(),Mt=Math.abs(nt.kzDropSecPerBlock??0),St=R*Mt;St>0&&typeof F=="function"&&typeof V=="function"&&(F(St*V()),Qt(`\u26A1 -${St}s`,"time")),j="idle",be=null,xe=[],ee=[],v=0,vt(0),Ae(),typeof Jt=="function"&&Jt("air")}function lt(){if(!I||S.length===0){rt();return}if(!H(f.currentSpell)){_(),rt();return}let y=c.spellBtn;y&&y.classList.remove("selecting"),b="animating",tt=performance.now(),p.play("fsseffect")}function Wt(y){return b!=="animating"?!1:(y-tt)/1e3>=Et().animSec?(Mn(),!1):!0}function gn(y){if(b!=="animating")return null;let R=Math.max(.001,Et().animSec),x=(y-tt)/1e3,nt=Math.min(x/R,1),Mt=.25,St=nt<Mt?1-nt/Mt:0;return{progress:nt,flashProgress:St}}function Mn(){let y=u(),R=S.length;if(R>0){let x=R*oe;A.addScore(x),Pt(A.score),Me(),Qt(`+${x}`,"score")}for(let x of S)y[x.y][x.s]=0;b="idle",I=null,w=[],S=[],tt=0,vt(0),Ae(),typeof Jt=="function"&&Jt("fire")}function je(){let y=typeof z=="function"?z():A.isPlaying(),R=f.currentSpell;if(!y)return!1;if(R==="ice"){if(h()||!q(R)||!H(f.currentSpell))return _(),!1;let x=f.effect;return typeof F=="function"&&typeof V=="function"&&F(x.duration*V()),p.play("wsseffect"),Qt(`\u{1F4A7} -${x.duration}s`,"time"),typeof ot=="function"&&ot(),typeof ge=="function"&&ge(x.duration),typeof Jt=="function"&&Jt(R),!0}return R==="earth"?pt==="selecting_source"||pt==="selecting_target"?(M(),!0):pt!=="idle"||h()||!q(R)?(_(),!1):(pt==="idle"&&kt(),!0):R==="air"?j==="selecting_source"?(T(),!0):j!=="idle"||h()||!q(R)?(_(),!1):(j==="idle"&&Dt(),!0):R==="fire"?b==="selecting_source"?(rt(),!0):b!=="idle"||h()||!q(R)?(_(),!1):(b==="idle"&&Rt(),!0):!1}function Kt(y){Xe(),Bt(y),rn(y),Wt(y)}function bn(y,R){return h()&&(pt==="selecting_source"||j==="selecting_source"||b==="selecting_source")?(_(),!0):pt==="selecting_source"?yt(y,R):j==="selecting_source"?Vt(y,R):b==="selecting_source"?Ie(y,R):!1}function Ye(){pt="idle",J=null,re=null,Gt=[],Xt=[],Nt(),j="idle",be=null,xe=[],ee=[],v=0,b="idle",I=null,w=[],S=[],tt=0;let y=c.spellBtn;y&&y.classList.remove("selecting")}function xn(){return{transmuteState:pt,transmuteSourceBlock:J,transmuteTargetColor:re,transmuteAreaCells:Gt,transmuteBlocksToChange:Xt,lightningState:j,lightningSourceBlock:be,lightningAreaCells:xe,lightningBlocksToHit:ee,fireState:b,fireSourceBlock:I,fireLineCells:w,fireTargets:S}}return{startTransmuteSourceSelection:kt,cancelTransmutation:M,startLightningSourceSelection:Dt,cancelLightning:T,startFireSourceSelection:Rt,cancelFire:rt,handleTap:bn,update:Kt,reset:Ye,getRenderState:xn,getTransmuteAnimState:dn,getLightningAnimState:fn,getFireAnimState:gn,handleSpellButtonClick:je,isTransmuteSelecting:()=>pt==="selecting_source",isLightningSelecting:()=>j==="selecting_source"}}var Vi={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function ko(e={}){let{canvas:n}=e,c=e.rotDir||1,u=!1,i=0,s=0,r=0,m=0,g=0,f=1,d=null,p=0,A=0,z=0,F=0,V=0,ot=0,gt=0,ge=0,Z=Vi;return{get rotDir(){return c},set rotDir(W){c=W},get dragging(){return u},get dragMode(){return d},handlePointerDown(W,Et,Ae){if(Et.onMagicTap&&Et.onMagicTap(W.clientX,W.clientY))return!0;let Me=performance.now(),Qt=Me-ot,jt=W.clientX-gt,Zt=W.clientY-ge,Jt=Math.hypot(jt,Zt);return Qt<=Z.DOUBLE_TAP_MS&&Jt<=Z.DOUBLE_TAP_MAX_DIST?(Et.onDoubleTap&&Et.onDoubleTap(),ot=0):(ot=Me,gt=W.clientX,ge=W.clientY),u=!0,f=-1,i=W.clientX,s=W.clientY,r=Ae,m=0,g=0,d=null,p=Me,A=W.clientX,z=W.clientY,F=p,V=0,n&&n.setPointerCapture(W.pointerId),!1},handlePointerMove(W,Et,Ae,Me){if(!u)return null;let Qt=W.clientX-i,jt=W.clientY-s,Zt=performance.now();if(Math.abs(Qt)<Z.DEADZONE_PX&&Math.abs(jt)<Z.DEADZONE_PX)return null;if(d){if(d==="rotate"){let te=Math.abs(Qt),Pt=Math.abs(jt);if(Pt>=te*Z.AXIS_DOMINANCE&&Pt>=Z.DROP_SWIPE_MIN_DISTANCE){let vt=Math.max(1,Zt-p);Pt/vt*1e3>=Z.DROP_SWIPE_MIN_SPEED&&(d="drop",g=0)}}}else{let te=Math.abs(Qt),Pt=Math.abs(jt);if(jt<0)te>=Z.DEADZONE_PX&&(d="rotate");else if(Pt>=te*Z.AXIS_DOMINANCE){if(Pt>=Z.DROP_SWIPE_MIN_DISTANCE){let vt=Math.max(1,Zt-p);Pt/vt*1e3>=Z.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else te>=Pt*Z.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let Jt=null;if(d==="rotate"&&Math.abs(Qt)>=Z.DEADZONE_PX){let te=Math.max(1,Zt-F),Pt=W.clientX-A,vt=Math.max(1,Math.abs(Pt)/te*1e3),l=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/vt)));V+=-Pt/l*c*f;let it=Math.trunc(V);it!==0&&(V-=it);let Q=m+it;if(Q!==m&&Et.canRotateTo){let me=Math.sign(Q-m),oe=r+m;for(;m!==Q;){let He=m+me,$e=r+He;if(!Et.canRotateTo(Math.floor(Ae),$e))break;m=He,oe=$e,Et.onRotateStep&&Et.onRotateStep(),Me&&Et.onGroundedMove&&Et.onGroundedMove()}Jt={targetRot:oe,rotFloat:oe}}}if(d==="drop"&&jt>=Z.DROP_SWIPE_MIN_DISTANCE&&Et.onDrop){let te=Math.max(1,Zt-F),Pt=W.clientY-z,vt=Math.max(1,Pt/te*1e3),l=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/vt))),it=Math.trunc(jt/l);if(it>g){let Q=it-g;for(let me=0;me<Q;me++)Et.onDrop();g=it}}return A=W.clientX,z=W.clientY,F=Zt,Jt},handlePointerUp(W){if(u&&(u=!1,d=null,n&&W&&W.pointerId!==void 0))try{n.releasePointerCapture(W.pointerId)}catch{}},reset(){u=!1,d=null,m=0,g=0,V=0}}}var ws={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Oo(){let e="intro",n=0,c=0,u=0,i=0,s=0,r={...ws};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),u=0,i=0,s=0,r={...ws}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&c>0&&(u=performance.now()-c-s)},getFormattedTime(){let m=Math.floor(u/1e3),g=Math.floor(m/60),f=m%60;return`${g}:${f.toString().padStart(2,"0")}`},incrementStat(m,g=1){m in r&&(r[m]+=g)},updateMaxStat(m,g){m in r&&g>r[m]&&(r[m]=g)},reset(){e="intro",n=0,c=0,u=0,i=0,s=0,r={...ws}}}}function Rn(e,n){return e%=n,e<0&&(e+=n),e}function Do(e,n){return e[Math.min(n,e.length-1)]}function us(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),u=n%60;return`${c}:${u.toString().padStart(2,"0")}`}function Ho(e,n){let c=e.map(({x:m,y:g},f)=>({x:g,y:-m,color:n[f]})),u=1/0,i=-1/0,s=1/0;for(let m of c)u=Math.min(u,m.x),i=Math.max(i,m.x),s=Math.min(s,m.y);let r=Math.round((u+i)/2);for(let m of c)m.x-=r,m.y-=s;return c.sort((m,g)=>m.y-g.y||m.x-g.x),{cells:c.map(m=>({x:m.x,y:m.y})),colors:c.map(m=>m.color)}}function Ps(e,n,c,u){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Rn(n-1,u)}),i.push({y:e,s:Rn(n+1,u)}),i}function $o(e,n,c){let u=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||u[s][r])continue;let m=[],g=[{y:s,s:r}];for(u[s][r]=1;g.length>0;){let f=g.shift();m.push(f);for(let d of Ps(f.y,f.s,n,c))e[d.y][d.s]&&!u[d.y][d.s]&&(u[d.y][d.s]=1,g.push(d))}i.push(m)}return i}function Fo(e){return e.some(n=>n.y===0)}function ks(e,n,c,u,i,s){if(!e)return!1;let r=Rn(c,s);for(let m of e.cells){let g=n+m.y,f=Rn(r+m.x,s);if(g<0)return!1;if(!(g>=i)&&u[g][f])return!1}return!0}function Go(e,n,c,u,i,s){if(!e)return null;let r=Math.floor(n);for(;ks(e,r-1,c,u,i,s);)r-=1;return r}function No(e,n,c){let u=[],i=[];for(let s=0;s<n;s++){let r=[],m=0,g=e[s][0],f=g?1:0;for(let d=1;d<=c;d++){let p=d<c?e[s][d]:0;p&&p===g?f++:(f>=1&&g&&r.push({start:m,length:f,color:g}),m=d,g=p,f=p?1:0)}if(r.length>=2){let d=r[0],p=r[r.length-1];if(d.start===0&&p.start+p.length===c&&d.color===p.color){let A=d.length+p.length;r[0]={start:p.start,length:A,color:d.color},r.pop()}}for(let d of r)if(d.length>=3){let p=[];for(let A=0;A<d.length;A++)p.push({y:s,s:(d.start+A)%c});u.push({color:d.color,length:d.length,cells:p})}}for(let s=0;s<c;s++){let r=0,m=e[0][s],g=m?1:0;for(let f=1;f<=n;f++){let d=f<n?e[f][s]:0;if(d&&d===m)g++;else{if(g>=3&&m){let p=[];for(let A=0;A<g;A++)p.push({y:r+A,s});u.push({color:m,length:g,cells:p})}r=f,m=d,g=d?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let m=e[s][r],g=e[s][(r+1)%c],f=e[s][(r+2)%c],d=e[s][(r+3)%c];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let m=e[r][s],g=e[r+1][s],f=e[r+2][s],d=e[r+3][s];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:u,pairMatches:i}}function Uo(e,n,c){let u=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&u.push(i)}return u}function Xo(e,n){let c=new Map;e.forEach((u,i)=>c.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],s=n[u],r=1;for(let ot=1;ot<=2&&c.get(`${i.x+ot},${i.y}`)===s;ot++)r++;if(r>=3)return!0;let m=1;for(let ot=1;ot<=2&&c.get(`${i.x},${i.y+ot}`)===s;ot++)m++;if(m>=3)return!0;let g=s,f=c.get(`${i.x+1},${i.y}`),d=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(g&&f&&d&&p&&g===f&&d===p&&g!==d)return!0;let A=s,z=c.get(`${i.x},${i.y+1}`),F=c.get(`${i.x},${i.y+2}`),V=c.get(`${i.x},${i.y+3}`);if(A&&z&&F&&V&&A===z&&F===V&&A!==F)return!0}return!1}function Yo(e){let{getN:n,getH:c,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:g,getState:f,setState:d,funcs:p,ui:A}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(z,F={}){let V=f();if(z==="start_game")return V.gameState!=="playing"?(p.startGame(),!0):!1;if(V.gameState!=="playing")return!1;switch(z){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:ot}=F;return typeof ot=="number"&&p.canPlaceAtRot(Math.floor(V.pieceY),ot)?(d({targetRot:ot,rotFloat:ot,rotVel:0}),V.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ot,y:gt}=F;return p.shootMagic(ot,gt)}case"select_magic":{let{element:ot}=F;return p.selectMagic(ot),!0}default:return console.warn("GameEngine: unknown command",z),!1}},update(z,F){let V=f();if(V.gameState!=="playing")return;let ot=F-V.startTime-V.totalPausedMs;d({elapsedMs:ot}),A.updateTimeHud();let gt=V.killLevel+s()*z;if(d({killLevel:gt}),A.updateRemainingHud(),gt>=c()){p.endGame();return}if(V.isHighlighting){let W=(F-V.highlightStartTime)/1e3,Et;V.isRingAnimation?Et=g:V.isMagicAnimation?Et=m:Et=r,W>=Et&&(V.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ge=V.fallTimer+z;if(ge>=u&&(ge-=u,p.tryMoveDown()),d({fallTimer:ge}),p.updateGroundedState()){let W=V.lockTimer+z;d({lockTimer:W}),W>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(z,F){return p.canPlaceAtRot(z,F)},getRotation(){let z=f();return{targetRot:z.targetRot,rotFloat:z.rotFloat,rotVel:z.rotVel}},setRotation(z){d({targetRot:z,rotFloat:z,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var De=Math.PI*2;function Vo(e){let{canvas:n,canvasCtx:c,getN:u,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:m,MAX_RADIUS_X:g,RADIUS_X_FACTOR:f,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:A,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:F,LOCK_DELAY_SEC:V,getKillRate:ot,ELEMENT_COLORS:gt,ELEMENT_TO_COLOR:ge,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:W,ACTIVE_COLOR_FRONT:Et,GHOST_COLOR_FILL:Ae,GHOST_COLOR_STROKE:Me,GHOST_STROKE_WIDTH:Qt,MAGIC_DIM_DOT_ALPHA:jt,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:Jt,getState:te,getVisualSettings:Pt,funcs:vt}=e,l=c,it=u(),Q=i(),me={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},oe=[],He=40;function $e(G,v,b,I,w){let S=Math.max(3,Math.round(G)),tt=180;for(let q=0;q<S;q++)setTimeout(()=>{let H=Math.random()>.5?"left":"right",ht=15,C=H==="left"?ht+Math.random()*Math.max(10,v-ht*2):b+ht+Math.random()*Math.max(10,w-b-ht*2),h=I-10;oe.push({x:C,baseX:C,y:h,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:ht,maxX:w-ht})},q*tt)}function Sn(G,v,b){oe=oe.filter(I=>I.y>G+I.size&&I.y>-20);for(let I of oe){I.y-=He*b,I.wobble+=I.wobbleSpeed*b;let w=I.baseX+Math.sin(I.wobble)*I.wobbleAmp;I.x=Math.max(I.minX,Math.min(I.maxX,w))}}function An(G){if(oe.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let v of oe)v.y<G+v.size||(l.beginPath(),l.arc(v.x,v.y,v.size,0,Math.PI*2),l.fill(),l.stroke())}}let pt={left:0,right:0,h:0,w:0};function J(G,v,b){let I=1-b/Q;return G+I*v}function re(G){return G=G%it,G<0?G+it:G}function Gt(G,v,b,I,w,S){let tt=re(S),q=(w-tt)/it*De+d;return{x:G+Math.cos(q)*b,y:v+Math.sin(q)*I,ang:q}}let Xt=.52,Qe=1.02;function Ct(G,v,b,I,w,S){let tt=re(S),q=(w-tt)/it*De+d;return{x:G+Math.cos(q)*b,y:v+Math.sin(q)*I,ang:q}}function Ue(G,v,b,I,w,S,tt,q=1){let H=Ct(G,v,b,I,w-Xt,S),ht=Ct(G,v,b,I,w+Xt,S),C={x:H.x,y:H.y-tt*.5},h={x:H.x,y:H.y+tt*.5},_={x:ht.x,y:ht.y-tt*.5},kt={x:ht.x,y:ht.y+tt*.5},M=(C.x+_.x+kt.x+h.x)*.25,yt=(C.y+_.y+kt.y+h.y)*.25,O=Qe*q,Ot=q,Yt=[C,_,kt,h].map(ve=>({x:M+(ve.x-M)*O,y:yt+(ve.y-yt)*Ot})),Nt=Math.abs((ht.x-H.x)*O),Tt=Math.abs(tt*Ot);return{corners:Yt,cx:M,cy:yt,wApprox:Nt,hApprox:Tt,ang:Ct(G,v,b,I,w,S).ang}}function j(G,v,b,I,w,S,tt,q,H=1,ht=null,C=1,h=null,_=0,kt=1,M=1){let yt=Ue(G,v,b,I,w,S,tt,M),[O,Ot,Yt,Nt]=yt.corners;if(l.save(),l.globalAlpha=H,l.fillStyle=q,l.beginPath(),l.moveTo(O.x,O.y),l.lineTo(Ot.x,Ot.y),l.lineTo(Yt.x,Yt.y),l.lineTo(Nt.x,Nt.y),l.closePath(),l.fill(),h&&_>0&&(l.strokeStyle=h,l.lineWidth=_,l.stroke()),ht){let Tt=Math.min(yt.wApprox,yt.hApprox)*.28*kt;l.globalAlpha=H*C,l.fillStyle=ht,l.beginPath(),l.arc(yt.cx,yt.cy,Tt,0,De),l.fill()}l.restore(),l.globalAlpha=1}function be(G,v,b,I,w,S){let tt=Gt(G,v,b,I,w,S),q=Gt(G,v,b,I,w+1,S),H=Gt(G,v,b,I,w-1,S),ht=Math.abs(q.x-tt.x),C=Math.abs(tt.x-H.x),h=(ht+C)*.5*1.06;return Math.max(1,h)}function xe(G,v,b,I,w,S){let tt=(w-S)/it*De+d;return{x:G+Math.cos(tt)*b,y:v+Math.sin(tt)*I,ang:tt}}function ee(G,v,b,I,w,S,tt,q=1,H=null,ht=1,C=null,h=0,_=1){l.save(),l.translate(G,v);let kt=Math.atan2(I,b);if(l.rotate(kt),l.globalAlpha=q,l.fillStyle=tt,l.fillRect(-w/2,-S/2,w,S),C&&h>0&&(l.strokeStyle=C,l.lineWidth=h,l.strokeRect(-w/2,-S/2,w,S)),H){let M=Math.min(w,S)*.28*_;l.globalAlpha=q*ht,l.fillStyle=H,l.beginPath(),l.arc(0,0,M,0,De),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let G=Math.max(1,Math.min(2,window.devicePixelRatio||1)),v=Math.floor(n.clientWidth*G),b=Math.floor(n.clientHeight*G);(n.width!==v||n.height!==b)&&(n.width=v,n.height=b,l.setTransform(G,0,0,G,0,0))},render(G=.016,v=performance.now()){this.resize();let b=te();it=u(),Q=i();let I=n.clientWidth,w=n.clientHeight;l.clearRect(0,0,I,w),l.fillStyle="#0b0f14",l.fillRect(0,0,I,w);let S=I*.5,tt=(I-2*m)/2,q=w-s-r,H=6,ht=it*q/(H*Q),C,h,_,kt;kt=w-r,ht<=Math.min(tt,g)?(C=ht,h=q,_=s):(C=Math.min(tt,g),h=C*H*Q/it,_=kt-h);let M=C*.28,{killLevel:yt,rotFloat:O,grid:Ot,gameState:Yt}=b,Nt=Pt?Pt():{},Tt=Nt.waterColor||"blue",ve=Nt.waterBubbles||!1,Xe=me[Tt]||me.blue,Bt=J(_,h,yt),dn=.7,En=yt/Q,Dt={...Xe.top},T={...Xe.bottom};if(En>dn){let B=(En-dn)/(1-dn);Dt.r=Math.round(Dt.r+(255-Dt.r)*B*.5),Dt.g=Math.round(Dt.g+(150-Dt.g)*B*.5),Dt.b=Math.round(Dt.b+(150-Dt.b)*B*.5),T.r=Math.round(T.r+(180-T.r)*B),T.g=Math.round(T.g*(1-B*.6)),T.b=Math.round(T.b*(1-B*.6))}let Rt=S-C-8,rt=S+C+8,Vt=_,Ie=kt+5,Ce=l.createLinearGradient(0,Bt,0,w);Ce.addColorStop(0,`rgba(${Dt.r},${Dt.g},${Dt.b},0.5)`),Ce.addColorStop(1,`rgba(${T.r},${T.g},${T.b},0.7)`),l.fillStyle=Ce;let rn=Math.round((Dt.r+T.r)/2),fn=Math.round((Dt.g+T.g)/2),Fe=Math.round((Dt.b+T.b)/2),lt=C+8,Wt=M+4;l.fillRect(0,Bt,Rt,w-Bt),l.fillRect(rt,Bt,I-rt,w-Bt),l.beginPath();let gn=Math.max(Bt,Ie);l.moveTo(Rt,gn),Bt<=Ie+Wt?l.ellipse(S,Ie,lt,Wt,0,Math.PI,0,!1):l.lineTo(rt,gn),l.lineTo(rt,w),l.lineTo(Rt,w),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(Rt,Vt),l.lineTo(Rt,Ie),l.stroke(),l.beginPath(),l.moveTo(rt,Vt),l.lineTo(rt,Ie),l.stroke(),l.beginPath(),l.ellipse(S,Ie,C+8,M+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(S,Ie,C+8,M+4,0,0,De),l.fill(),yt>.5&&(l.strokeStyle=`rgba(${Math.min(255,rn+60)},${Math.min(255,fn+40)},${Math.min(255,Fe+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Bt),l.lineTo(Rt,Bt),l.moveTo(rt,Bt),l.lineTo(I,Bt),l.stroke()),pt={left:Rt,right:rt,h:w,w:I},(oe.length>0||ve)&&(Sn(Bt,w,G),An(Bt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Mn=De*C,je=10,Kt=Mn/je*.7,bn=Mn/je*.3;l.setLineDash([Kt,bn]);let Ye=Mn/it;l.lineDashOffset=re(O)*Ye;for(let B=0;B<=Q;B++){let P=J(_,h,B);l.beginPath(),l.ellipse(S,P,C,M,0,0,De),l.stroke()}l.setLineDash([]);let xn=[],y=[];for(let B=0;B<Q;B++){let P=J(_,h,B+.5);for(let X=0;X<it;X++){let N=Ot[B][X];if(!N)continue;let Y=Gt(S,P,C,M,X,O),U=Math.sin(Y.ang),k={y:B,s:X,yScr:P,p:Y,depth:U,color:N};U<-.1?xn.push(k):y.push(k)}}let R=vt.getMagicTargetColor(),{isHighlighting:x,highlightedCells:nt,highlightStartTime:Mt,isMagicAnimation:St}=b,wt=null,Ge=1,Ht=1,ce=!1;if(x&&nt.length>0){wt=new Set(nt.map(P=>`${P.y},${P.s}`));let B=(performance.now()-Mt)/1e3;if(St){let P=Math.min(1,B/z);Ge=1-P*.85,Ht=1-P*.9,ce=!0}else{let P=Math.min(1,B/p),X=1-A;if(P>X){let N=(P-X)/A;Ge=1-N*.85,Ht=1-N*.9,ce=!0}}}xn.sort((B,P)=>B.depth-P.depth);for(let B of xn){let P=h/Q*.9,X=gt[B.color]||null,N=.35,Y=1,U=`${B.y},${B.s}`;wt&&wt.has(U)&&(N*=Ht,Y=Ge),j(S,B.yScr,C,M,B.s,O,P,W,N,X,.5,null,0,1,Y)}let{isRingAnimation:we}=b;if(x&&nt.length>0&&!St){let B=(performance.now()-Mt)/1e3,X=Math.min(1,B/(we?F:p)),N=1-A,Y=X>N,U=Y?(X-N)/A:0,k=we?Math.floor(X*N*it*2)%it:-1,L=4+X/N*10,$=Math.sin(B*L*De),ct=Y?1:.3+$*.3,ft=Y?1-U*.8:1,ut=Y?1-U:1;for(let st of nt){let Lt=J(_,h,st.y+.5),ie=Ct(S,Lt,C,M,st.s,O);if(Math.sin(ie.ang)>=-.1)continue;let pn=h/Q*.9,le,bt,ye;if(we){let We=(st.s-k+it)%it,K=We<3?1-We/3:0;le=(Y?ut:.2+K*.5)*.5,bt=`rgba(255, 159, 67, ${le})`,ye=Y?ft:1+K*.15}else le=ct*ut,bt=st.isLine?`rgba(255, 255, 255, ${le*.5})`:`rgba(255, 220, 100, ${le*.4})`,ye=Y?ft:1.1;j(S,Lt,C,M,st.s,O,pn,bt,1,null,1,null,0,1,ye)}}y.sort((B,P)=>B.depth-P.depth);for(let B of y){let P=h/Q*.9,X=gt[B.color]||null,N=1,Y=1,U=1,k=1,L=`${B.y},${B.s}`,$=wt&&wt.has(L);$&&(N=Ht,Y=Ge),R!==null&&!$&&(B.color!==R?(U=jt,k=Zt):k=Jt),j(S,B.yScr,C,M,B.s,O,P,Z,N,X,U,null,0,k,Y)}if(x&&nt.length>0&&!St){let B=(performance.now()-Mt)/1e3,X=Math.min(1,B/(we?F:p)),N=1-A,Y=X>N,U=Y?(X-N)/A:0,k=we?Math.floor(X*N*it*2)%it:-1,L=4+X/N*10,$=Math.sin(B*L*De),ct=Y?1:.5+$*.5,ft=Y?1-U*.8:1,ut=Y?1-U:1;for(let st of nt){let Lt=J(_,h,st.y+.5),ie=Ct(S,Lt,C,M,st.s,O);if(Math.sin(ie.ang)<-.1)continue;let pn=h/Q*.9,le,bt,ye;if(we){let We=(st.s-k+it)%it,K=We<4?1-We/4:0;le=Y?ut:.3+K*.7,bt=`rgba(255, 159, 67, ${le})`,ye=Y?ft:1+K*.2}else le=ct*ut,bt=st.isLine?`rgba(255, 255, 255, ${le*.7})`:`rgba(255, 220, 100, ${le*.6})`,ye=Y?ft:1.15;j(S,Lt,C,M,st.s,O,pn,bt,1,null,1,null,0,1,ye)}}let Ve=b.spellState||b,{transmuteState:ae,transmuteSourceBlock:ne,transmuteTargetColor:Te,transmuteAreaCells:_e,transmuteBlocksToChange:Pe}=Ve;if(ae==="selecting_source"){let B=h/Q*.9,P=.35+Math.sin(v/150)*.15;for(let X of y){let N=J(_,h,X.y+.5);j(S,N,C,M,X.s,O,B,`rgba(0, 40, 20, ${P})`,1,null,1,null,0,1,1)}}if(ae==="selecting_target"&&Pe&&Pe.length>0){let B=h/Q*.9,P=.4+Math.sin(v/120)*.25,X=.6+Math.sin(v/120)*.4;for(let N of Pe){if(N.y<0||N.y>=Q)continue;let Y=J(_,h,N.y+.5),U=Ct(S,Y,C,M,N.s,O);Math.sin(U.ang)<-.1||(j(S,Y,C,M,N.s,O,B,`rgba(0, 50, 30, ${P})`,1,null,1,null,0,1,1),j(S,Y,C,M,N.s,O,B,"transparent",1,null,1,`rgba(100, 255, 150, ${X})`,3,1,1.02))}}if(ae==="animating"&&vt.getTransmuteAnimState){let B=vt.getTransmuteAnimState(v);if(B){let P=h/Q*.9,{phase:X,progress:N,areaFlash:Y}=B;if(Y>0&&_e)for(let U of _e){if(U.y<0||U.y>=Q)continue;let k=J(_,h,U.y+.5),L=Ct(S,k,C,M,U.s,O);Math.sin(L.ang)<-.1||j(S,k,C,M,U.s,O,P,`rgba(150, 255, 200, ${Y*.4})`,1,null,1,null,0,1,1)}if(Pe&&Pe.length>0){let U=ne?ne.color:1,k=Te||1;for(let L of Pe){if(L.y<0||L.y>=Q)continue;let $=J(_,h,L.y+.5),ct=Ct(S,$,C,M,L.s,O);if(Math.sin(ct.ang)<-.1)continue;let ut=1,st=gt[U],Lt=0;if(X==="shrink"?(ut=1-N*.95,st=gt[U],Lt=.5+N*.3):X==="grow"&&(ut=N,st=gt[k],Lt=.8-N*.5),Lt>0&&j(S,$,C,M,L.s,O,P,`rgba(200, 255, 220, ${Lt})`,1,null,1,null,0,1,1),ut>.05){let ie=Ue(S,$,C,M,L.s,O,P,1),tn=Math.min(ie.wApprox,ie.hApprox)*.28*ut;l.save(),l.globalAlpha=1,l.fillStyle=st,l.beginPath(),l.arc(ie.cx,ie.cy,tn,0,De),l.fill(),l.restore()}}}}}let{lightningState:Ze,lightningSourceBlock:mn,lightningAreaCells:Je,lightningBlocksToHit:$t}=Ve;if(Ze==="selecting_source"){let B=h/Q*.9,P=.35+Math.sin(v/150)*.15;for(let X of y){let N=J(_,h,X.y+.5);j(S,N,C,M,X.s,O,B,`rgba(20, 20, 60, ${P})`,1,null,1,null,0,1,1)}}if(Ze==="animating"&&vt.getLightningAnimState){let B=vt.getLightningAnimState(v);if(B&&$t&&$t.length>0){let P=h/Q*.9,{phase:X,flashProgress:N,currentTarget:Y,jumpProgress:U,struckTargets:k}=B;if(X==="flash"&&N>0&&Je)for(let L of Je){if(L.y<0||L.y>=Q)continue;let $=J(_,h,L.y+.5),ct=Ct(S,$,C,M,L.s,O);Math.sin(ct.ang)<-.1||j(S,$,C,M,L.s,O,P,`rgba(100, 150, 255, ${N*.5})`,1,null,1,null,0,1,1)}if(k&&k.length>0)for(let L of k){let $=$t[L];if(!$||$.y<0||$.y>=Q)continue;let ct=J(_,h,$.y+.5),ft=Ct(S,ct,C,M,$.s,O);if(Math.sin(ft.ang)<-.1)continue;let st=(k.length-1-k.indexOf(L))*.1,Lt=Math.max(0,.8-st);j(S,ct,C,M,$.s,O,P,`rgba(255, 255, 255, ${Lt})`,1,null,1,`rgba(150, 200, 255, ${Lt})`,2,1,1.05)}if(X==="chain"&&Y>=0&&Y<$t.length){let L=$t[Y];if(L&&L.y>=0&&L.y<Q){let $=J(_,h,L.y+.5),ct=Ct(S,$,C,M,L.s,O);if(Math.sin(ct.ang)>=-.1){let ut=1-U;j(S,$,C,M,L.s,O,P,`rgba(200, 220, 255, ${ut*.9})`,1,null,1,`rgba(100, 180, 255, ${ut})`,3,1,1.1-U*.05)}}if(Y>0){let $=$t[Y-1],ct=$t[Y];if($&&ct){let ft=J(_,h,$.y+.5),ut=J(_,h,ct.y+.5),st=Ue(S,ft,C,M,$.s,O,P,1),Lt=Ue(S,ut,C,M,ct.s,O,P,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-U*.5})`,l.lineWidth=2+(1-U)*2,l.lineCap="round",l.beginPath();let ie=st.cx,tn=st.cy,pn=Lt.cx,le=Lt.cy;l.moveTo(ie,tn);let bt=4;for(let ye=1;ye<=bt;ye++){let We=ye/bt,K=ie+(pn-ie)*We,hn=tn+(le-tn)*We,ds=ye<bt?(Math.random()-.5)*8:0;l.lineTo(K+ds,hn+ds)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-U)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:cn,fireSourceBlock:pe,fireLineCells:Be,fireTargets:an}=Ve;if(cn==="selecting_source"){let B=h/Q*.9,P=.3+Math.sin(v/140)*.2;for(let X of y){let N=J(_,h,X.y+.5);j(S,N,C,M,X.s,O,B,`rgba(70, 25, 10, ${P})`,1,null,1,null,0,1,1)}}if(cn==="animating"&&vt.getFireAnimState){let B=vt.getFireAnimState(v);if(B&&Be&&Be.length>0){let P=h/Q*.9,{progress:X,flashProgress:N}=B,Y=Math.sin(X*Math.PI);if(N>0)for(let U of Be){if(U.y<0||U.y>=Q)continue;let k=J(_,h,U.y+.5),L=Ct(S,k,C,M,U.s,O);Math.sin(L.ang)<-.1||j(S,k,C,M,U.s,O,P,`rgba(255, 120, 50, ${N*.45})`,1,null,1,`rgba(255, 200, 140, ${N*.5})`,2,1,1.03)}if(pe){let U=new Map;for(let L of Be){if(L.y<0||L.y>=Q)continue;let $=J(_,h,L.y+.5),ct=Ct(S,$,C,M,L.s,O);if(Math.sin(ct.ang)<-.1)continue;let ut=Ue(S,$,C,M,L.s,O,P,1),st=L.s-pe.s;st>it/2&&(st-=it),st<-it/2&&(st+=it);let Lt=L.y;U.has(Lt)||U.set(Lt,[]),U.get(Lt).push({x:ut.cx,y:ut.cy,offset:st})}let k=Array.from(U.keys()).sort((L,$)=>$-L);if(k.length>0){let L=.35+.3*Math.sin(v/60)+Y*.2;l.save(),l.lineCap="round";for(let $ of k){let ct=U.get($)||[];if(ct.sort((ft,ut)=>ft.offset-ut.offset),ct.length!==0){l.beginPath(),l.moveTo(ct[0].x,ct[0].y);for(let ft=1;ft<ct.length;ft++)l.lineTo(ct[ft].x,ct[ft].y);l.strokeStyle=`rgba(255, 140, 60, ${L})`,l.lineWidth=Math.max(2,P*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${L*.35})`,l.lineWidth=Math.max(6,P*.35),l.stroke()}}l.restore()}}if(an&&an.length>0){let U=.2+Y*.6;for(let k of an){if(k.y<0||k.y>=Q)continue;let L=J(_,h,k.y+.5),$=Ct(S,L,C,M,k.s,O);Math.sin($.ang)<-.1||j(S,L,C,M,k.s,O,P,`rgba(255, 160, 70, ${U})`,1,null,1,`rgba(255, 230, 180, ${Y*.6})`,2,1,1.05)}}}}let{activePiece:zt,pieceY:ke,isGrounded:he,lockTimer:qt}=b;if(zt){let B=vt.snappedRot(),P=B,X=vt.computeGhostY(),N=h/Q*.9;if(X!==null){let k=[];for(let L=0;L<zt.cells.length;L++){let $=zt.cells[L],ct=zt.colors[L],ft=X+$.y,ut=vt.normSector(B+$.x);if(ft<0||ft>=Q)continue;let st=J(_,h,ft+.5),Lt=Ct(S,st,C,M,ut,P);k.push({cy:ft,cs:ut,yScr:st,depth:Math.sin(Lt.ang),color:ct})}k.sort((L,$)=>L.depth-$.depth);for(let L of k){let $=gt[L.color]||null;j(S,L.yScr,C,M,L.cs,P,N,Ae,1,$,.5,Me,Qt,1,1)}}let Y=Et;if(he&&qt>0){let k=Math.min(1,qt/V),L=255,$=Math.round(170+85*k),ct=Math.round(180+75*k),ft=.75+(1-.75)*k;Y=`rgba(${L},${$},${ct},${ft})`}let U=[];for(let k=0;k<zt.cells.length;k++){let L=zt.cells[k],$=zt.colors[k],ct=vt.normSector(B+L.x),ft=ke+L.y;if(ft<0||ft>=Q)continue;let ut=J(_,h,ft+.5),st=Ct(S,ut,C,M,ct,P);U.push({cs:ct,yScr:ut,depth:Math.sin(st.ang),color:$})}U.sort((k,L)=>k.depth-L.depth);for(let k of U){let L=gt[k.color]||null;j(S,k.yScr,C,M,k.cs,P,N,Y,1,L,1,null,0,1,1)}}},drawNextPreview(G,v){if(!G)return;let b=G.getContext("2d"),I=G.width,w=G.height;if(b.clearRect(0,0,I,w),!v)return;let S=1/0,tt=-1/0,q=1/0,H=-1/0;for(let M of v.cells)S=Math.min(S,M.x),tt=Math.max(tt,M.x),q=Math.min(q,M.y),H=Math.max(H,M.y);let ht=tt-S+1,C=H-q+1,h=Math.min(I/(ht+.5),w/(C+.5)),_=(I-ht*h)/2,kt=(w-C*h)/2;b.fillStyle=Z;for(let M=0;M<v.cells.length;M++){let yt=v.cells[M],O=_+(yt.x-S)*h,Ot=kt+(C-1-(yt.y-q))*h;b.fillRect(O+1,Ot+1,h-2,h-2);let Yt=v.colors[M],Nt=gt[Yt];if(Nt){let Tt=(h-2)*.32;b.fillStyle=Nt,b.beginPath(),b.arc(O+h/2,Ot+h/2,Tt,0,De),b.fill(),b.fillStyle=Z}}},spawnBonusBubbles(G){let{left:v,right:b,h:I,w}=pt;w>0&&$e(G,v,b,I,w)}}}(()=>{let e=To(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,s=24,r=120,m={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function g(t){let o=m[t]||m["30_24"];i=o.N,s=o.H,r=o.survivalTime}function f(){return s/r}let d=Math.PI/2,p=70,A=120,z=30,F=320,V=.42,ot="rgb(235,240,250)",gt="rgb(55,62,75)",ge="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",W="rgba(110,255,150,0.85)",Et=2,Ae={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Me={1:"fire",2:"water",3:"lightning",4:"earth"},Qt={fire:1,water:2,lightning:3,earth:4},jt=1,Zt=.58,Jt=!0,te=12,Pt=25,vt=1,l=2,it=3,Q=5,me=7,oe=10,He=3,$e=50,Sn=2,An=.3,pt=.5,J=1,re=.3,Gt=.5,Xt=1.3,Qe=10,Ct=1e3,Ue=[1,1.25,1.5,1.75,2],j=10,be=50,xe=25,ee=[1,1.3,1.6,2],G=[1,1.5,2,2.5],v=Co(),b=v.loadGameSettings();b.hapticsEnabled===void 0&&(b.hapticsEnabled=!0);let I=b.invertSwipe?-1:1,S=!1,tt=-1,q=Ro({enabled:b.hapticsEnabled}),H=Array.from({length:s},()=>new Uint8Array(i));function ht(){H=Array.from({length:s},()=>new Uint8Array(i))}let C=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],h=null,_=s+3,kt=0,M=0,yt=!1,O=0,Ot=0,Yt=0,Nt=3,Tt=0,ve=0,Xe=0,Bt=ko({canvas:n,rotDir:I}),dn="0.16.6",En=!0,Dt="blue",T=Eo();T.preload();let Rt=Oo(),rt="intro",Vt=0,Ie=0,Ce=0,rn=0,fn=0,Fe=null,lt=Rt.stats,Wt=0,gn=e.overlay,Mn=e.gameContainer,je=Bo({elementColors:Ae}),Kt=je.showBonus.bind(je),bn=je.getElementIcon.bind(je),Ye=Lo(),xn=e.overlayTitle,y=e.overlayStats,R=e.startBtn,x=e.hud,nt=e.scoreHud,Mt=e.timeHud,St=e.remainingHud,wt=e.nextCanvas,Ge=wt.getContext("2d"),Ht=e.pauseBtn,ce=e.pauseOverlay,we=e.resumeBtn,Ve=e.restartBtn,ae=e.exitToMenuBtn,ne=e.pauseSettingsBtn,Te=e.pauseSoundBtn,_e=e.pauseMusicBtn,Pe=e.pauseBestScore,Ze=e.pauseBestTime,mn=e.pauseBestMode,Je=e.pauseCurrentScore,$t=e.pauseCurrentTime,cn=e.pauseCurrentMode,pe=e.confirmDialog,Be=e.confirmText,an=e.confirmCancel,zt=e.confirmOk,ke=e.settingsOverlay,he=e.settingsClose,qt=e.fullscreenBtn,B=e.rotateBtn,P=e.startPanel,X=e.gameoverPanel,N=e.goScore,Y=e.goTime,U=e.goRing,k=e.goMatches,L=e.goBonuses,$=e.goNewRecord,ct=e.goRestartBtn,ft=e.goExitBtn,ut=e.bestScore,st=e.bestTimeVal,Lt=e.startVersion,ie=e.modeBtns,tn=e.recordsBtn,pn=e.startSettingsBtn,le=e.helpBtn,bt="25_20";function ye(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function We(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let a=o.dataset.mode,E=m[a];if(!E)return;let D=o.querySelector(".mode-tag.time-tag");if(!D)return;let et=ye(E.survivalTime);et&&(D.textContent=et)})}We();let K=Ao({buttons:e.magicBtns,onActivate:()=>T.play("spells"),onChange:(t,o)=>{ms()}}),hn=e.magicBtns,ds=K.charges,Wo=t=>Se()?K.select(t):!1,In=()=>K.updateButtons(),Os=e.magicRow,At=e.magicActiveIndicator,Ds=e.magicActiveIcon,Hs=e.magicActiveCost,Ko={ice:"water",air:"lightning",earth:"earth",fire:"fire"},fs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},zo=["ice","earth","air","fire"];Wt=v.loadHighTowerRings();function wn(t){return typeof se?.getUnlockRings=="function"?se.getUnlockRings(t):0}function Un(t){let o=wn(t);return o===0||Wt>=o}let $s=["fire","water","lightning","earth"],vn=null,Xn=!1,qo=500,Qo=30,jo=220,Cn=null,gs=null,Fs={fire:!1,water:!1,lightning:!1,earth:!1};function Gs(){if(!At)return;let t=At.getBoundingClientRect();t.width>0&&t.height>0&&(gs=t)}function Zo(){if(!At)return null;let t=At.getBoundingClientRect();return t.width>0&&t.height>0?At:gs?{getBoundingClientRect:()=>gs}:null}function Pn(t=K.active){if(!At||!Ds)return;t?(vn=t,Xn=!1):Xn||(vn=null);let o=vn;if(!o||!Se()||(K.charges[o]??0)<=0){Gs(),At.classList.add("hidden"),At.classList.remove("active","ult-ready",...$s),At.style.setProperty("--progress","0%"),Cn&&clearTimeout(Cn),Cn=setTimeout(()=>{At.classList.add("gone")},jo);return}Cn&&(clearTimeout(Cn),Cn=null),At.classList.remove("gone"),At.classList.contains("hidden")?requestAnimationFrame(()=>At.classList.remove("hidden")):At.classList.remove("hidden"),Ds.textContent=bn(o);let E=fs[o];E&&se.selectSpell(E);let D=E?On(E):0,et=K.charges[o]??0,at=!!E&&Wn()&&Un(E),Ut=!!E&&Wn()&&!at,Ee=at&&D>0?Math.min(et/D,1):0,qe=at&&D>0,Le=qe&&et>=D;Hs&&(Hs.textContent=qe?`-${D}`:Ut?"\u{1F512}":""),At.classList.toggle("no-cost",!qe&&!Ut),At.classList.toggle("locked",Ut),At.classList.toggle("ult-ready",Le),At.style.setProperty("--progress",`${Math.round(Ee*100)}%`),At.classList.remove("hidden",...$s),At.classList.add("active",o),Gs()}function Jo(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),qo))}function Yn(){for(let[t,o]of Object.entries(hn)){if(!o)continue;let a=fs[t],E=On(a),D=Wn()&&Se()&&a,et=typeof Un=="function"?Un(a):!0,at=D&&et&&E>0&&(K.charges[t]??0)>=E;o.classList.toggle("ult-ready",at),at&&!Fs[t]&&(Jo(o),rt==="playing"&&T.play("readysuper")),Fs[t]=at}}function Se(t=bt){return t==="30_24"?!0:S}function ms(){Pn(K.active),Yn()}function Ki(t){S=t,bt==="25_20"&&(S?K.reset():(K.deactivate(),Object.keys(K.charges).forEach(o=>{K.charges[o]=0})),In()),Vn(),ms()}function Vn(){Os&&(Os.style.display=Se()?"":"none",Pn(K.active),Yn())}function zi(t){let o=Tn(t),a=On(t);return!o||a<=0?!1:K.charges[o]>=a}function qi(t){let o=Tn(t),a=On(t);return!o||a<=0||K.charges[o]<a?!1:(K.charges[o]-=a,K.updateButtons(),se.pulse(),!0)}let kn=e.spellWave;function ti(){kn&&(kn.classList.remove("active"),kn.offsetWidth,kn.classList.add("active"),setTimeout(()=>kn.classList.remove("active"),1200))}let en=null,se=Io({button:At,onReady:()=>{T.play("readysuper")}}),ei=()=>se.getEffect("earth"),ni=()=>se.getEffect("air"),si=()=>se.getEffect("fire"),On=t=>typeof se?.getCost=="function"?se.getCost(t):0,Tn=t=>Ko[t]??null;en=Po({canvas:n,dom:e,getGrid:()=>H,getN:()=>i,getH:()=>s,getRotFloat:()=>Tt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:A,SIDE_MARGIN_PX:z,MAX_RADIUS_X:F,SCORE_MAGIC_DESTROY:xe},helpers:{normSector:jn,levelYToScreenY:zn,sectorCenterXY:qn},Spell:se,Magic:K,SoundModule:T,State:Rt,isGamePlaying:()=>rt==="playing",addPendingKzDrop:t=>{Yt+=t},getKillRate:f,triggerSpellWave:ti,spawnSpellBubbles:t=>{let o=Tn(se.currentSpell)??"water";Ye.spawnSpellBubbles(se.button,o,t)},spawnBonusBubbles:t=>{Ln.spawnBonusBubbles(t)},getTransmuteEffect:ei,getLightningEffect:ni,getFireEffect:si,continueMatchProcessing:Qn,updateScoreHud:$n,showBonus:Kt,getSpellCost:On,getSpellElement:Tn,onUltimateApplied:t=>{let o=Tn(t)??Tn(se.currentSpell)??"water";if(typeof Ye?.spawnSpellBubbles=="function"){let a=Zo();a&&Ye.spawnSpellBubbles(a,o,Qo)}Xn=!1,vn=null,Pn(null),Yn()},isSpellBlocked:oi,setScore:t=>{Vt=t},setCascadeLevel:t=>{sn=t}});function Wn(){return bt==="30_24"}function Kn(){Pn(K.active),Yn()}let nn=[],Dn=0,Ke=!1,ln=!1,_n=!1,Oe=0,ze=0,sn=0,Bn=[];function oi(){return Ke||ln||_n}function zn(t,o,a){let E=1-a/s;return t+E*o}function qn(t,o,a,E,D,et){let at=(D-et)/i*u+d;return{x:t+Math.cos(at)*a,y:o+Math.sin(at)*E,ang:at}}function Ns(t,o){let a=n.clientWidth,E=n.clientHeight,D=a*.5,et=(a-2*z)/2,at=E-p-A,Ut=6,Ee=i*at/(Ut*s),qe=E-A,Le,xt,dt;Ee<=Math.min(et,F)?(Le=Ee,xt=at,dt=p):(Le=Math.min(et,F),xt=Le*Ut*s/i,dt=qe-xt);let mt=Le*.28,It=zn(dt,xt,t+.5),Ft=qn(D,It,Le,mt,o,Tt),ue=n.getBoundingClientRect();return{x:ue.left+Ft.x,y:ue.top+Ft.y}}function ii(t,o){if(!Se()||!K.canUse()||Ke)return!1;let a=Qt[K.active],E=n.clientWidth,D=n.clientHeight,et=E*.5,at=(E-2*z)/2,Ut=D-p-A,Ee=6,qe=i*Ut/(Ee*s),Le=D-A,xt,dt,mt;qe<=Math.min(at,F)?(xt=qe,dt=Ut,mt=p):(xt=Math.min(at,F),dt=xt*Ee*s/i,mt=Le-dt);let It=xt*.28,Ft=null,ue=1/0;for(let de=0;de<s;de++){let Re=zn(mt,dt,de+.5);for(let fe=0;fe<i;fe++){let rs=H[de][fe];if(!rs||rs!==a)continue;let Nn=qn(et,Re,xt,It,fe,Tt);if(Math.sin(Nn.ang)<-.1)continue;let cs=t-Nn.x,mo=o-Nn.y,po=Math.hypot(cs,mo),ho=dt/s*.9,Oi=ho*1.2;Math.abs(cs)<Oi/2&&Math.abs(mo)<ho/2&&po<ue&&(ue=po,Ft={y:de,s:fe})}}if(Ft){let de=zn(mt,dt,Ft.y+.5),Re=qn(et,de,xt,It,Ft.s,Tt),fe=n.getBoundingClientRect(),rs=fe.left+Re.x,Nn=fe.top+Re.y,go=hn[K.active];return Ye.spawnMagicShot(K.active,go,rs,Nn,()=>{let cs=H[Ft.y][Ft.s];nn=[{y:Ft.y,s:Ft.s,color:cs,isLine:!1,isMagic:!0}],Dn=performance.now(),Ke=!0,ln=!0,Oe=0,ze=xe,Kt(`+${xe}`,"score")}),sn=0,K.useCharge(),lt.magicUsed++,!0}return!1}let Qi=100;function ji(t,o){return Ps(t,o,s,i)}function ri(){return $o(H,s,i)}let ci=Fo;function ai(t){let o=t.map(E=>({...E,color:H[E.y][E.s]}));for(let E of t)H[E.y][E.s]=0;let a=s;for(let E of t){let D=E.y;for(let et=1;et<=E.y;et++){let at=E.y-et;if(H[at][E.s]){D=et-1;break}}a=Math.min(a,D)}for(let E of o)H[E.y-a][E.s]=E.color;return a>0}function li(){let t=!0;for(;t;){t=!1;let o=ri();for(let a of o)ci(a)||ai(a)&&(t=!0)}}function ui(){Qn()}let ps=Do;function Us(t,o){let a=new Map,E=0,D=0,et=0,at={},Ut=t.length+o.length;for(let dt of t){let mt=Me[dt.color],It=0,Ft=0;if(dt.length>=5?(It=it,Ft=oe,lt.lines5++):dt.length===4?(It=l,Ft=me,lt.lines4++):dt.length===3&&(It=vt,Ft=Q,lt.lines3++),Se()&&mt&&It>0){K.addCharges(mt,It),at[mt]=(at[mt]||0)+It;let ue=dt.cells[Math.floor(dt.cells.length/2)],de=Ns(ue.y,ue.s),Re=hn[mt];for(let fe=0;fe<It;fe++)setTimeout(()=>{Ye.spawnMagicOrb(mt,de.x,de.y,Re)},fe*100)}E+=Ft*f(),et+=Ft,D+=dt.length*j;for(let ue of dt.cells){let de=`${ue.y},${ue.s}`;a.has(de)||a.set(de,{y:ue.y,s:ue.s,color:dt.color,isLine:!0})}}for(let dt of o){if(lt.pairs++,E+=He*f(),et+=He,D+=be,Se()){let mt=[...new Set(dt.cells.map(It=>H[It.y][It.s]).filter(Boolean))];if(mt.length>0){let It=dt.cells[Math.floor(dt.cells.length/2)],Ft=Ns(It.y,It.s);mt.forEach((ue,de)=>{let Re=Me[ue];if(!Re)return;K.addCharges(Re,1),at[Re]=(at[Re]||0)+1;let fe=hn[Re];fe&&setTimeout(()=>{Ye.spawnMagicOrb(Re,Ft.x,Ft.y,fe)},de*100)})}}for(let mt of dt.cells){let It=`${mt.y},${mt.s}`;a.has(It)||a.set(It,{y:mt.y,s:mt.s,color:H[mt.y][mt.s],isLine:!1})}}let Ee=ps(ee,Ut-1),qe=ps(G,sn),Le=Math.round(D*Ee*qe),xt=0;Ut>1&&(lt.combos++,lt.maxCombo=Math.max(lt.maxCombo,Ut),setTimeout(()=>Kt(`COMBO \xD7${Ut}`,"combo"),xt),xt+=180,T.play("combo2")),sn>0&&(lt.cascades++,lt.maxCascade=Math.max(lt.maxCascade,sn),setTimeout(()=>Kt(`CASCADE \xD7${sn}`,"cascade"),xt),xt+=180,T.play("cascade")),(t.length>0||o.length>0)&&T.play("combo");for(let dt of t){let mt=dt.length,It=mt*j;setTimeout(()=>Kt(`Line-${mt} +${It}`,"line",dt.color),xt),xt+=100}for(let dt of o){let mt=dt.cells.length>0?H[dt.cells[0].y][dt.cells[0].s]:null;setTimeout(()=>Kt(`Pair +${be}`,"pair",mt),xt),xt+=100}Le>0&&(setTimeout(()=>Kt(`+${Le}`,"score"),xt),xt+=120),et>0&&(setTimeout(()=>Kt(`+${et}s`,"time"),xt),xt+=120);for(let[dt,mt]of Object.entries(at))mt>0&&(setTimeout(()=>Kt(`+${mt}${bn(dt)}`,"charge"),xt),xt+=120);nn=Array.from(a.values()),Dn=performance.now(),Ke=!0,ln=!1,Oe=E,ze=Le,In()}function di(){for(let t of nn)H[t.y][t.s]=0;if(nn.length>0&&T.playRandom("disappear"),Oe>0){Yt+=Oe;let t=Oe/f();Ln.spawnBonusBubbles(t)}Rt.addScore(ze),Vt+=ze,$n(),nn=[],Ke=!1,ln=!1,Oe=0,ze=0,sn++,Qn()}function Qn(){li();let{lineMatches:t,pairMatches:o}=bi();if(t.length>0||o.length>0)Us(t,o);else{let a=zs();a.length>0?Si(a):!h&&rt==="playing"&&Ks()}}function Zi(t,o){Us(t,o)}function jn(t){return Rn(t,i)}function Zn(){return jn(Math.round(Tt))}function Xs(t,o){return ks(h,t,o,H,s,i)}function Jn(t){return Xs(t,Zn())}let ts=Ho;function Ys(){Jt&&(te!==0&&O>=te||(M=0,O+=1))}function fi(){if(!h)return;let t=h.cells,o=h.colors,a={cells:t,colors:o};if(tt>=0||(a=ts(a.cells,a.colors),a=ts(a.cells,a.colors)),a=ts(a.cells,a.colors),h.cells=a.cells,h.colors=a.colors,!Jn(Math.floor(_))){h.cells=t,h.colors=o;return}T.play("turn"),yt&&Ys()}function gi(){return Go(h,_,Zn(),H,s,i)}function mi(){if(!h)return!1;let t=Math.floor(_)-1,o=!Jn(t);return o&&!yt?(yt=!0,M=0,O=0):!o&&yt&&(yt=!1,M=0,O=0),o}let yn=us;function Hn(){if(rt==="playing"){gn.classList.add("hidden"),Ht.classList.remove("hidden");return}if(gn.classList.remove("hidden"),Ht.classList.add("hidden"),rt==="intro"){P.classList.remove("hidden"),X.classList.add("hidden");let t=v.loadHighscore(bt);t.score>0?(ut.textContent=t.score.toLocaleString(),st.textContent=yn(t.time)):(ut.textContent="0",st.textContent="0:00"),Bs(),Lt.textContent=`v${dn}`,R.classList.remove("idlePulse"),R.offsetWidth,R.classList.add("idlePulse")}else{P.classList.add("hidden"),X.classList.remove("hidden"),N.textContent=Vt.toLocaleString(),Y.textContent=yn(Ce);let t=v.loadHighscore(bt);Vt>0&&Vt>=t.score?$.classList.remove("hidden"):$.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${lt.rings}</span>
          <span class="count ring-max">${lt.maxRing>0?"max \xD7"+lt.maxRing:""}</span>
        </div>
      `;U.innerHTML=o;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${lt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${lt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${lt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${lt.pairs}</span>
        </div>
      `;k.innerHTML=a;let E=Se()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${lt.magicUsed}</span>
        </div>
      `:"",D=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${lt.combos}</span>
          <span class="count max-combo">${lt.maxCombo>0?"max \xD7"+lt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${lt.cascades}</span>
          <span class="count max-cascade">${lt.maxCascade>0?"max \xD7"+lt.maxCascade:""}</span>
        </div>
        ${E}
      `;L.innerHTML=D}}function $n(){nt.textContent=`Score: ${Vt}`}function hs(){Mt.textContent=`Time: ${yn(Ce)}`}function Vs(){let t=Math.max(0,(s-Ot)/f()),o=Math.floor(t/60),a=Math.floor(t%60);St.textContent=`Left: ${o}:${a.toString().padStart(2,"0")}`,t<30?St.classList.add("warning"):St.classList.remove("warning")}function pi(){g(bt),ht(),Ot=0,Yt=0,Tt=ve=0,Xe=0,Rt.start(),lt=Rt.stats,Vt=0,Ie=performance.now(),Ce=0,fn=0,rn=0,rt="playing",Fe=null,Se()?K.reset():(K.deactivate(),Object.keys(K.charges).forEach(t=>{K.charges[t]=0}),In()),se.reset(),Kn(),nn=[],Bn=[],Ke=!1,ln=!1,_n=!1,Oe=0,ze=0,sn=0,en.reset(),In(),$n(),hs(),Vs(),ms(),Ks(),Ln.drawNextPreview(wt,Fe),Hn(),T.getSettings().musicEnabled&&T.startGameMusic()}function ys(){Rt.gameOver(),rt="gameover",h=null,yt=!1,M=0,O=0;let t=v.saveHighscore(Vt,Ce,bt);T.stopMusic(),T.play("gameover"),hs(),Hn(),t&&Vt>0&&setTimeout(()=>{Kt("\u{1F3C6} NEW RECORD!","score")},500)}function hi(t){for(let a=0;a<50;a++){let E=t.map(()=>1+(Math.random()*4|0));if(!yi(t,E))return E}return t.map((a,E)=>1+E%4)}let yi=Xo;function Ws(t){let o=t.cells.map(E=>({x:E.x,y:E.y})),a=hi(o);return{name:t.name,cells:o,colors:a}}function Ks(){if(!Fe){let D=C[Math.random()*C.length|0];Fe=Ws(D)}h=Fe;let t=C[Math.random()*C.length|0];Fe=Ws(t),Ln.drawNextPreview(wt,Fe);let o=1/0,a=-1/0;for(let D of h.cells)D.x<o&&(o=D.x),D.x>a&&(a=D.x);let E=(o+a)/2;for(let D of h.cells)D.x=D.x-Math.round(E);_=s+3,kt=0,yt=!1,M=0,O=0,Jn(Math.floor(_))?T.playRandom("appear"):ys()}function zs(){return Uo(H,s,i)}function Si(t){if(t.length===0)return;let o=[];for(let Ut of t)for(let Ee=0;Ee<i;Ee++)o.push({y:Ut,s:Ee,color:H[Ut][Ee],isLine:!1});Bn=t,nn=o,Dn=performance.now(),Ke=!0,_n=!0,ln=!1;let a=t.length;lt.rings+=a,lt.maxRing=Math.max(lt.maxRing,a);let E=ps(Ue,a-1),D=Math.round(Ct*a*E),et=$e*a;ze=D,Oe=et*f(),T.play("ring");let at=`RING \xD7${a}`;Kt(at,"ring"),setTimeout(()=>Kt(`+${D}`,"score"),150),setTimeout(()=>Kt(`+${et}s`,"time"),300)}function Ei(){let t=[...Bn].sort((o,a)=>a-o);for(let o of t){for(let a=o;a<s-1;a++)H[a].set(H[a+1]);H[s-1].fill(0)}if(Oe>0){Yt+=Oe;let o=Oe/f();Ln.spawnBonusBubbles(o)}Rt.addScore(ze),Vt+=ze,$n(),bt==="30_24"&&Bn.length>0&&(Wt=v.addHighTowerRings(Bn.length)),nn=[],Bn=[],Ke=!1,_n=!1,Oe=0,ze=0,Qn()}function Ji(){return zs().length}function Mi(){if(!h)return;let t=Zn();Tt=t,ve=t,Xe=0;let o=!1;for(let a=0;a<h.cells.length;a++){let E=h.cells[a],D=h.colors[a],et=Math.floor(_)+E.y,at=jn(t+E.x);et>=s&&(o=!0),et>=0&&et<s&&(H[et][at]=D)}if(o){ys();return}Rt.addScore(Qe),Vt+=Qe,$n(),Kt(`+${Qe}`,"score"),T.playRandom("drop"),h=null,sn=0,ui()}function bi(){return No(H,s,i)}function xi(){if(!h)return!1;let t=Math.floor(_)-1;return Jn(t)?(_=t,yt=!1,M=0,O=0,!0):(yt=!0,!1)}n.addEventListener("pointerdown",t=>{if(_t.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),a=t.clientX-o.left,E=t.clientY-o.top;Bt.handlePointerDown(t,{onMagicTap:Se()?()=>en.handleTap(a,E)?!0:_t.applyCommand("magic_shoot",{x:a,y:E}):null,onDoubleTap:()=>_t.applyCommand("rotate_piece")},ve)||(Xe=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(_t.state!=="playing"||!Bt.dragging)return;t.preventDefault?.();let o=Bt.handlePointerMove(t,{canRotateTo:(a,E)=>_t.canRotateTo(a,E),onDrop:()=>_t.applyCommand("move_down"),onGroundedMove:()=>_t.onGroundedMove(),onRotateStep:()=>q.trigger("tower_rotate")},_t.pieceY,_t.isGrounded);o&&_t.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{_t.state==="playing"&&Bt.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Bt.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Bt.dragging&&Bt.handlePointerUp(t)},{passive:!1}),B.addEventListener("click",()=>{_t.state==="playing"&&_t.applyCommand("rotate_piece")});let es=e.dropBtn,ns=null;function vi(){_t.state==="playing"&&(_t.applyCommand("move_down"),ns=setInterval(()=>{if(_t.state!=="playing"){ss();return}_t.applyCommand("move_down")},Pt))}function ss(){ns&&(clearInterval(ns),ns=null)}es.addEventListener("pointerdown",t=>{t.preventDefault(),vi()}),es.addEventListener("pointerup",ss),es.addEventListener("pointerleave",ss),es.addEventListener("pointercancel",ss);for(let[t,o]of Object.entries(hn))o.addEventListener("click",()=>{_t.state==="playing"&&Se()&&_t.applyCommand("select_magic",{element:t})});At&&At.addEventListener("click",()=>{if(_t.state!=="playing"||!Wn()||!Se())return;let t=K.active??vn;if(!t)return;let o=fs[t];!o||!Un(o)||(se.selectSpell(o),K.active&&(vn=K.active,Xn=!0,K.deactivate()),en.handleSpellButtonClick())});let Ss=e.soundsToggle,Es=e.musicToggle;function un(){let t=T.getSettings();t.soundsEnabled?Ss.classList.add("active"):Ss.classList.remove("active"),t.musicEnabled?Es.classList.add("active"):Es.classList.remove("active");for(let o=0;o<=4;o++){let a=e.soundVolBtns[o],E=e.musicVolBtns[o];a&&a.classList.toggle("active",t.soundVolume===o),E&&E.classList.toggle("active",t.musicVolume===o)}}let qs=e.tabBtns,Ci=e.tabContents;qs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;qs.forEach(a=>a.classList.remove("active")),Ci.forEach(a=>a.classList.remove("active")),t.classList.add("active"),_o(o).classList.add("active"),o==="sounds"&&un()})});let Qs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,js=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Ti=e.iosHint,_i=e.standaloneBadge;function Zs(){let t=document.fullscreenElement||document.webkitFullscreenElement;qt.textContent=t?"Disable":"Enable"}Qs&&(js?(_i.style.display="block",qt.style.display="none"):(Ti.style.display="block",qt.textContent="Not supported",qt.style.opacity="0.5",qt.style.cursor="default")),qt.addEventListener("click",()=>{if(Qs&&!js)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Zs),document.addEventListener("webkitfullscreenchange",Zs);let os=e.invertSwipeToggle,on=e.hapticsToggle;b.invertSwipe&&os.classList.add("active"),on&&(q.supports()?b.hapticsEnabled&&on.classList.add("active"):(on.classList.add("disabled"),on.classList.remove("active"),b.hapticsEnabled=!1,q.setEnabled(!1),v.saveGameSettings(b))),os.addEventListener("click",()=>{os.classList.toggle("active");let t=os.classList.contains("active");Bt.rotDir=t?-1:1,b.invertSwipe=t,v.saveGameSettings(b)}),on&&on.addEventListener("click",()=>{if(on.classList.contains("disabled"))return;on.classList.toggle("active");let t=on.classList.contains("active");b.hapticsEnabled=t,v.saveGameSettings(b),q.setEnabled(t)}),Ss.addEventListener("click",()=>{let o=!T.getSettings().soundsEnabled;T.updateSettings({soundsEnabled:o}),un(),Fn()}),Es.addEventListener("click",()=>{let o=!T.getSettings().musicEnabled;T.updateSettings({musicEnabled:o}),un(),Fn(),rt!=="paused"&&(o?rt==="playing"?T.startGameMusic():T.startMenuMusic():T.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{T.updateSettings({soundVolume:t}),un(),T.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{T.updateSettings({musicVolume:t}),un()})}un();function Js(){rt==="playing"&&(Rt.pause(),rn=performance.now(),rt="paused",T.musicAudio&&T.musicAudio.pause())}function is(){rt==="paused"&&(Rt.resume(),fn+=performance.now()-rn,rn=0,rt="playing",xs=performance.now(),T.getSettings().musicEnabled&&T.startGameMusic())}function Fn(){let t=T.getSettings();Te.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Te.classList.toggle("off",!t.soundsEnabled),_e.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",_e.classList.toggle("off",!t.musicEnabled)}function Bi(){ce.classList.remove("hidden"),Ht.classList.add("hidden");let t=v.loadHighscore(bt);if(Pe.textContent=t.score?t.score.toLocaleString():"0",Ze.textContent=t.time?us(t.time):"0:00",mn.textContent=bt==="30_24"?"High Tower":"Quick Tower",Je.textContent=Vt.toLocaleString(),$t.textContent=us(Ce),cn.textContent=bt==="30_24"?"High Tower":"Quick Tower",Fn(),oo){let o=bt==="30_24";oo.style.display=o?"":"none",o&&Bs()}}function Gn(){ce.classList.add("hidden"),Ht.classList.remove("hidden")}Ht.addEventListener("click",()=>{Js(),Bi()}),we.addEventListener("click",()=>{Gn(),is()});let Ms=null;function to(t,o){Be.textContent=t,Ms=o,pe.classList.remove("hidden")}function eo(){pe.classList.add("hidden"),Ms=null}an.addEventListener("click",()=>{eo()}),zt.addEventListener("click",()=>{let t=Ms;eo(),t&&t()}),Ve.addEventListener("click",()=>{to("Restart game?",()=>{Gn(),_t.applyCommand("start_game")})}),ae.addEventListener("click",()=>{to("Exit to menu?",()=>{Gn(),Ht.classList.add("hidden"),rt="intro",Rt.reset(),T.stopMusic(),T.getSettings().musicEnabled&&T.startMenuMusic(),Hn()})}),ne.addEventListener("click",()=>{ke.classList.remove("hidden")}),Te.addEventListener("click",()=>{let t=T.getSettings();T.updateSettings({soundsEnabled:!t.soundsEnabled}),Fn(),un()}),_e.addEventListener("click",()=>{let o=!T.getSettings().musicEnabled;T.updateSettings({musicEnabled:o}),Fn(),un()}),ce.addEventListener("click",t=>{t.target===ce&&(Gn(),is())}),document.addEventListener("keydown",t=>{rt==="paused"&&!ce.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Gn(),is())}),he.addEventListener("click",()=>{ke.classList.add("hidden")}),ke.addEventListener("click",t=>{t.target===ke&&ke.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?rt==="playing"&&(Js(),bs=!0):bs&&rt==="paused"&&(is(),bs=!1)});let _t=Yo({getN:()=>i,getH:()=>s,FALL_INTERVAL:jt,LOCK_DELAY_SEC:Zt,getKillRate:f,MATCH_HIGHLIGHT_SEC:Sn,MAGIC_SHRINK_SEC:pt,RING_HIGHLIGHT_SEC:J,getState:()=>({gameState:rt,score:Vt,elapsedMs:Ce,startTime:Ie,totalPausedMs:fn,stats:lt,activePiece:h,pieceY:_,targetRot:ve,rotFloat:Tt,rotVel:Xe,isGrounded:yt,isHighlighting:Ke,isMagicAnimation:ln,isRingAnimation:_n,highlightStartTime:Dn,killLevel:Ot,grid:H,fallTimer:kt,lockTimer:M}),setState:t=>{"elapsedMs"in t&&(Ce=t.elapsedMs),"killLevel"in t&&(Ot=t.killLevel),"fallTimer"in t&&(kt=t.fallTimer),"lockTimer"in t&&(M=t.lockTimer),"targetRot"in t&&(ve=t.targetRot),"rotFloat"in t&&(Tt=t.rotFloat),"rotVel"in t&&(Xe=t.rotVel)},funcs:{startGame:pi,endGame:ys,rotatePieceByDir:fi,tryMoveDown:xi,canPlaceAtRot:Xs,maybeResetLockDelay:Ys,shootMagic:ii,selectMagic:Wo,updateGroundedState:mi,lockPiece:Mi,finishHighlight:di,finishRingHighlight:Ei},ui:{updateTimeHud:hs,updateRemainingHud:Vs}}),Ln=Vo({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:A,SIDE_MARGIN_PX:z,MAX_RADIUS_X:F,RADIUS_X_FACTOR:V,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:Sn,MATCH_SHRINK_PHASE:An,MAGIC_SHRINK_SEC:pt,RING_HIGHLIGHT_SEC:J,LOCK_DELAY_SEC:Zt,getKillRate:f,ELEMENT_COLORS:Ae,ELEMENT_TO_COLOR:Qt,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:gt,ACTIVE_COLOR_FRONT:ge,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:W,GHOST_STROKE_WIDTH:Et,MAGIC_DIM_DOT_ALPHA:re,MAGIC_DIM_DOT_SCALE:Gt,MAGIC_TARGET_DOT_SCALE:Xt,getState:()=>({gameState:rt,grid:H,activePiece:h,pieceY:_,rotFloat:Tt,killLevel:Ot,isHighlighting:Ke,highlightedCells:nn,highlightStartTime:Dn,isMagicAnimation:ln,isRingAnimation:_n,isGrounded:yt,lockTimer:M,spellState:en.getRenderState()}),getVisualSettings:()=>({waterBubbles:En,waterColor:Dt}),funcs:{snappedRot:Zn,computeGhostY:gi,normSector:jn,getMagicTargetColor:()=>Se()&&K.canUse()?Qt[K.active]:null,getTransmuteAnimState:t=>en.getTransmuteAnimState(t),getLightningAnimState:t=>en.getLightningAnimState(t),getFireAnimState:t=>en.getFireAnimState(t)}}),xs=performance.now();function no(t){let o=Math.min(.05,Math.max(.001,(t-xs)/1e3));if(xs=t,_t.update(o,t),en.update(t),Yt>0){let a=Math.min(Yt,Nt*o);Ot=Math.max(0,Ot-a),Yt-=a}Tt=ve,Tt>1e6&&(Tt%=i),Tt<-1e6&&(Tt%=i),Ln.render(o,t),requestAnimationFrame(no)}R.addEventListener("click",()=>{_t.applyCommand("start_game")}),ct.addEventListener("click",()=>{_t.applyCommand("start_game")}),ft.addEventListener("click",()=>{rt="intro",Rt.reset(),T.stopMusic(),T.getSettings().musicEnabled&&T.startMenuMusic(),Hn()}),ie.forEach(t=>{t.addEventListener("click",o=>{ie.forEach(E=>E.classList.remove("active")),t.classList.add("active"),bt=t.dataset.mode,Kn(),Vn();let a=v.loadHighscore(bt);a.score>0?(ut.textContent=a.score.toLocaleString(),st.textContent=yn(a.time)):(ut.textContent="0",st.textContent="0:00"),R.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>R.classList.add("idlePulse"),2e3)})});let vs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),Li=document.getElementById("spellProgressFill"),so=document.getElementById("spellProgressMarkers"),oo=document.getElementById("pauseSpellProgress"),Ri=document.getElementById("pauseSpellProgressFill"),io=document.getElementById("pauseSpellProgressMarkers"),ro=document.getElementById("pauseSpellProgressLabel");function Ts(){return zo.map(t=>wn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function Ai(t){let o=Ts(),a=_s(o);return a<=0?"":`${Math.min(t,a)}/${a}`}function co(t){if(!t)return;t.innerHTML="";let o=Ts(),a=_s(o);o.forEach(E=>{let D=document.createElement("span");D.className="marker",D.dataset.threshold=E;let et=a>0?E/a*100:0;D.style.left=`${et}%`,t.appendChild(D)})}function ao(t,o){if(!t)return;let a=Ii(o);t.style.width=`${a}%`}function lo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(E=>{let D=parseInt(E.dataset.threshold,10)||0;E.classList.toggle("reached",o>=D)})}function Ii(t){let o=Ts(),a=_s(o);return t<=0||a<=0?0:t>=a?100:t/a*100}function uo(t){if(!Cs)return;let o=wn(t),a=se.getDescription(t);o===0||Wt>=o?Cs.innerHTML=a:Cs.innerHTML=`${a} <span class="spell-progress-text">${Wt}/${o}</span>`}function Bs(){Wt=v.loadHighTowerRings(),vs.forEach(o=>{let a=o.dataset.spell,E=wn(a),D=Wt>=E;o.classList.toggle("locked",!D);let et=o.querySelector(".spell-lock");et&&(et.style.display=D?"none":"")}),ao(Li,Wt),ao(Ri,Wt),lo(so,Wt),lo(io,Wt),ro&&(ro.textContent=Ai(Wt));let t=document.querySelector(".spell-select-btn.active");t&&uo(t.dataset.spell)}co(so),co(io),Bs(),vs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){ie.forEach(Ut=>Ut.classList.remove("active")),a.classList.add("active"),bt="30_24",Kn(),Vn();let at=v.loadHighscore(bt);at.score>0?(ut.textContent=at.score.toLocaleString(),st.textContent=yn(at.time)):(ut.textContent="0",st.textContent="0:00")}let E=t.dataset.spell,D=wn(E),et=Wt>=D;uo(E),et&&(vs.forEach(at=>at.classList.remove("active")),t.classList.add("active"),se.selectSpell(E),Pn(K.active))})}),tn.addEventListener("click",()=>{let t=v.loadHighscore("30_24"),o=v.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${yn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${yn(o.time)}
`:`  No record yet
`,alert(a)}),pn.addEventListener("click",()=>{ke.classList.remove("hidden")}),le.addEventListener("click",()=>{let t=Se()?`6) Use magic: tap element button, then tap matching block

`:`6) Magic is disabled in settings (Quick Tower)

`;alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
`+t+"Survive as long as you can!")}),In(),Vn(),Kn(),Hn(),T.startMenuMusic();let wi=()=>{if(T.unlock(),!T.getSettings().musicEnabled)return;let t=T.musicAudio;!t||t.paused||t.ended?_t.state==="playing"?T.startGameMusic():T.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},fo=0,Pi=10,ki=()=>{fo>=Pi||(fo++,wi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ki,{passive:!0})}),requestAnimationFrame(no)})();})();
