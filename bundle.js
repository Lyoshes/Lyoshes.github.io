(()=>{var $i=[0,.25,.5,.75,1],Fi=[0,.05,.15,.25,.5],Gi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},yo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},So="soundSettings";function Ni(){try{let e=localStorage.getItem(So);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ui(e){try{localStorage.setItem(So,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function vo(){return{audioContext:null,buffers:{},settings:Ni(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return $i[this.settings.soundVolume]},getMusicVolume(){return Fi[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${c}`,l)}},preload(){this.initContext();for(let[n,c]of Object.entries(Gi))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;c!==null&&(l=`${n}${c}`);let i=this.buffers[l];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ui(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Eo="eb_highscore",bo="eb_highscore_quick",Mo="eb_settings",xo="eb_high_tower_rings",Xi={invertSwipe:!1,hapticsEnabled:!0};function Co(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?bo:Eo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let l=this.loadHighscore(c);if(e>l.score||e===l.score&&n>l.time){let i=c==="25_20"?bo:Eo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Mo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Xi}},saveGameSettings(e){try{localStorage.setItem(Mo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(xo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(xo,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function To(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function _o(e){return document.getElementById("tab-"+e)}var Yi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Bo(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(l,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=l,s&&n[s]&&(r.style.color=n[s]);let m=window.innerWidth/2,g=window.innerHeight/2-40,f=(Math.random()-.5)*200,d=(Math.random()-.5)*100+c*36;r.style.left=`${m+f}px`,r.style.top=`${g+d}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(l){return Yi[l]||"\u2726"}}}var Ls={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Lo(){return{spawnMagicOrb(e,n,c,l){if(!l)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Ls[e]||"\u2726";let s=l.getBoundingClientRect(),r=s.left+s.width/2-n,m=s.top+s.height/2-c,g=Math.hypot(r,m),f=Math.atan2(m,r),d=g*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,_=r*.5+Math.cos(p)*d,D=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${_}px`),i.style.setProperty("--mid-y",`${D}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,l,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,m=s.top+s.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=Ls[e]||"\u2726";let f=c-r,d=l-m;g.style.setProperty("--end-x",`${f}px`),g.style.setProperty("--end-y",`${d}px`),g.style.left=`${r}px`,g.style.top=`${m}px`,document.body.appendChild(g);let p=setInterval(()=>{let _=g.getBoundingClientRect();this.spawnTrailParticle(e,_.left+_.width/2,_.top+_.height/2)},40);setTimeout(()=>{clearInterval(p),g.remove(),this.spawnExplosion(e,c,l),i&&i()},300)},spawnTrailParticle(e,n,c){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${c}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,g=Math.cos(r)*m,f=Math.sin(r)*m;s.style.setProperty("--px",`${g}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let l=n;typeof n=="number"&&(c=n,l="water"),Ls[l]||(l="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,m=Math.max(8,Math.round(c));for(let g=0;g<m;g++){let f=document.createElement("div");f.className=`spell-bubble ${l}`,f.textContent="\u25CF";let d=g/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,_=Math.cos(d)*p,D=Math.sin(d)*p-20;f.style.setProperty("--px",`${_}px`),f.style.setProperty("--py",`${D}px`),f.style.left=`${s}px`,f.style.top=`${r}px`,f.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,m=Math.hypot(s,r),g=Math.atan2(r,s),f=m*.35*(Math.random()>.5?1:-1),d=g+Math.PI/2,p=s*.5+Math.cos(d)*f,_=r*.5+Math.sin(d)*f;l.style.setProperty("--mid-x",`${p}px`),l.style.setProperty("--mid-y",`${_}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${r}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}var Ro=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"></div>
          <div class="b s2"></div>
          <div class="b s22"></div>

          <div class="b s3 match1"></div>
          <div class="b s4 match1"></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"></div>
            <div class="b f1 grav12"></div>
            <div class="b f2 gravPair"></div>
            <div class="b f2r gravPair"></div>
            <div class="b f3 match1"></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"></div>
            <div class="b pR0 grav2"></div>
            <div class="b pR1 grav2"></div>
            <div class="b pB0 pair2"></div>
            <div class="b pB1 pair2"></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"></div>
          <div class="b s2"></div>
          <div class="b s22"></div>

          <div class="b s3"></div>
          <div class="b s4"></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"></div>
            <div class="b f1"></div>
            <div class="b f2"></div>
            <div class="b f2r"></div>
            <div class="b f3"></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"></div>
            <div class="b pR0"></div>
            <div class="b pR1"></div>
            <div class="b pB0"></div>
            <div class="b pB1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Vi=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Swipe down to speed up the falling piece.`,illustrationHtml:""},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Ro},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:""}];function Ao(e={}){let{helpBtn:n,mount:c=document.body,combosTemplate:l}=e;if(!n||!c)return{open(){},close(){},setCombosTemplate(){}};let i=Vi.map(P=>({...P}));typeof l=="string"&&l.trim()&&(i[1].illustrationHtml=l);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,c.appendChild(s);let r=s.querySelector(".help-next-btn"),m=s.querySelector(".help-slide-title"),g=s.querySelector(".help-slide-text"),f=s.querySelector(".help-illustration"),d=s.querySelector(".help-dots"),p=i.map(()=>{let P=document.createElement("span");return P.className="help-dot",d.appendChild(P),P}),_=0,D=!1,k=null,W=180,et=560,at=P=>{let xt=i[P];xt&&(_=P,m.textContent=xt.title,g.textContent=xt.text,f.innerHTML=xt.illustrationHtml||"",p.forEach(($t,Vt)=>{$t.classList.toggle("active",Vt===P)}),r.textContent=P===i.length-1?"Done":"Next",jt())},jt=()=>{if(!D||s.classList.contains("hidden"))return;let P=f.querySelector(".help-combos");if(!P)return;let xt=f.getBoundingClientRect();if(!xt.width||!xt.height)return;let $t=Math.min(1,Math.min(xt.width,xt.height)/et);P.style.setProperty("--help-combos-scale",$t.toFixed(3))},z=()=>{D&&jt()},V=P=>{D&&P.stopPropagation()},mt=P=>{if(D){if(P.key==="Escape"){P.preventDefault(),P.stopPropagation(),P.stopImmediatePropagation?.(),Qt();return}P.preventDefault(),P.stopPropagation(),P.stopImmediatePropagation?.()}},ue=()=>{D||(D=!0,k&&(clearTimeout(k),k=null),at(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),jt()}),document.addEventListener("keydown",mt,!0),window.addEventListener("resize",z))},Qt=()=>{D&&(D=!1,s.classList.remove("is-visible"),document.removeEventListener("keydown",mt,!0),window.removeEventListener("resize",z),k=window.setTimeout(()=>{s.classList.add("hidden")},W))};return s.addEventListener("click",P=>{D&&(P.target===s&&Qt(),P.stopPropagation())}),s.addEventListener("pointerdown",V),s.addEventListener("pointerup",V),s.addEventListener("touchstart",V,{passive:!0}),s.addEventListener("touchmove",P=>{D&&(P.preventDefault(),P.stopPropagation())},{passive:!1}),s.addEventListener("wheel",P=>{D&&(P.preventDefault(),P.stopPropagation())},{passive:!1}),r.addEventListener("click",P=>{P.stopPropagation(),_<i.length-1?at(_+1):Qt()}),n.addEventListener("click",P=>{P.preventDefault(),ue()}),{open:ue,close:Qt,setCombosTemplate(P){typeof P=="string"&&(i[1].illustrationHtml=P.trim()||Ro,D&&_===1&&at(1))}}}var Wi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Ki(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},As=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Io({enabled:e=!0,patterns:n=Wi}={}){let c=Ki(),l=c?new As(c):new Rs,i=l.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let m=n[r];return m?l.trigger({name:r,...m}):!1}}}function wo(e={}){let{buttons:n={},onActivate:c=null,onChange:l=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[g,f]of Object.entries(n)){if(!f)continue;let d=i[g],p=f.querySelector(".charges");p&&(p.textContent=d),f.classList.toggle("empty",d<=0),f.classList.toggle("active",s===g&&d>0)}l&&l({...i},s)}function m(g){let f=n[g];f&&(f.classList.remove("pulse"),f.offsetWidth,f.classList.add("pulse"),setTimeout(()=>f.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(g){s=g},select(g){if(i[g]<=0)return!1;let f=s===g;return s=f?null:g,r(),!f&&s===g&&c&&c(),!f},useCharge(){if(!s||i[s]<=0)return!1;let g=s;return i[g]--,s=null,r(),m(g),!0},addCharges(g,f){i[g]!==void 0&&(i[g]+=f,r(),m(g))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(g){for(let[f,d]of Object.entries(n))d&&d.addEventListener("click",()=>{g&&g(f)})}}}var Xe={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Po(e={}){let{button:n=null,onActivate:c=null,onProgress:l=null,onReady:i=null}=e,s="ice",r=0;function m(){return Xe[s]||Xe.ice}function g({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),_=Number.isFinite(p.maxProgress)?p.maxProgress:0,D=_>0?Math.min(r/_,1)*100:0,k=_>0&&r>=_;n.style.setProperty("--progress",`${D}%`);let W=n.querySelector(".spell-icon");W&&(W.textContent=p.icon);let et=n.querySelector(".spell-counter");et&&(et.textContent=_>0?`${Math.min(r,_)}/${_}`:""),n.classList.toggle("ready",k),n.classList.toggle("charging",!k&&r>0),l&&!d&&_>0&&l(r,_)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},get effect(){return m().effect},getUnlockRings(d){return(Xe[d]||Xe.ice).unlockRings??0},getCost(d){return(Xe[d]||Xe.ice).cost??0},getDescription(d){return(Xe[d]||Xe.ice).description||""},getEffect(d){return(Xe[d]||Xe.ice).effect},get button(){return n},selectSpell(d){Xe[d]&&(s=d,r=0,g())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let _=r<p.maxProgress;return r=Math.min(r+d,p.maxProgress),g(),f(),_&&r>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){r=Math.max(0,d),g({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},use(){if(!this.canUse())return null;let d=m().effect;return r=0,g(),f(),c&&c(s),d},reset(){r=0,g()},pulse(){f()},updateButton:g,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function Is({centerY:e,centerS:n,size:c,H:l,normSector:i}){let s=[],r=Math.floor(c/2);for(let m=-r;m<=r;m++)for(let g=-r;g<=r;g++){let f=e+m,d=i(n+g);if(f<0||f>=l)continue;let p=m*m+g*g;s.push({y:f,s:d,distSq:p})}return s}function ls(e,n,c){return n.filter(l=>e[l.y][l.s]===c)}function us(e,n){return[...e].sort((l,i)=>l.distSq!==i.distSq?l.distSq-i.distSq:l.y!==i.y?l.y-i.y:l.s-i.s).slice(0,n).map(l=>({y:l.y,s:l.s}))}function ko({centerY:e,centerS:n,beamLength:c,beamWidth:l,N:i,H:s,normSector:r}){if(e<0||e>=s||l<=0||c<0||i<=0)return[];let m=Math.min(l,s),g=[],f=new Set,d=k=>k<0||k>=s||f.has(k)?!1:(f.add(k),g.push(k),!0);d(e);for(let k=1;g.length<m&&(e+k<s||e-k>=0)&&(d(e+k),!(g.length>=m));k++)d(e-k);g.sort((k,W)=>W-k);let p=Math.min(i,c*2+1),_=c%2===0,D=[];for(let k of g){let W=new Set,et=(at,jt)=>{let z=r(at);return W.has(z)?!1:(W.add(z),D.push({y:k,s:z,dist:jt}),!0)};et(n,0);for(let at=1;W.size<p&&at<i;at++)if(_){if(et(n+at,at),W.size>=p)break;et(n-at,at)}else{if(et(n-at,at),W.size>=p)break;et(n+at,at)}}return D}function Oo(e){let{canvas:n,dom:c,getGrid:l,getN:i,getH:s,getRotFloat:r,constants:m,helpers:g,Spell:f,Magic:d,SoundModule:p,State:_,isGamePlaying:D,addPendingKzDrop:k,getKillRate:W,triggerSpellWave:et,spawnSpellBubbles:at,spawnBonusBubbles:jt,getTransmuteEffect:z,getLightningEffect:V,getFireEffect:mt,continueMatchProcessing:ue,updateScoreHud:Qt,showBonus:P,getSpellCost:xt,getSpellElement:$t,onUltimateApplied:Vt,isSpellBlocked:se,setScore:Ft,setCascadeLevel:Lt}=e,{TOP_PAD_PX:u,BOTTOM_PAD_PX:it,SIDE_MARGIN_PX:j,MAX_RADIUS_X:he,SCORE_MAGIC_DESTROY:re}=m,{normSector:Ye,levelYToScreenY:we,sectorCenterXY:An}=g,En=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],ht="idle",Z=null,ce=null,Wt=[],Zt=[],mn=0,Ct=null,Ve=0,J="idle",Ce=null,Pe=[],Kt=[],U=0,I=0,b="idle",T=null,O=[],y=[],Q=0;function nt(h){if(typeof xt!="function"||typeof $t!="function")return!1;let R=$t(h),E=xt(h);return!R||!E?!1:(d.charges[R]??0)>=E}function gt(h){if(typeof xt!="function"||typeof $t!="function")return!1;let R=$t(h),E=xt(h);return!R||!E||(d.charges[R]??0)<E?!1:(d.charges[R]-=E,d.updateButtons(),f.pulse(),!0)}let G=0,L=350;function M(){return typeof se=="function"?se():!1}function S(){let h=performance.now();h-G<L||(G=h,p.play("cancel"))}function Tt(){ht="selecting_source",Z=null,ce=null,Wt=[],Zt=[],J!=="idle"&&wt(),b!=="idle"&&yt(),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function C(){ht!=="idle"&&p.play("cancel"),ht="idle",Z=null,ce=null,Wt=[],Zt=[],Rt();let h=c.spellBtn;h&&h.classList.remove("selecting")}function bt(h,R){if(ht!=="selecting_source")return!1;if(M())return S(),!0;let E=w(h,R);if(!E)return C(),!0;let rt=l();Z={y:E.y,s:E.s,color:rt[E.y][E.s]},Wt=Is({centerY:E.y,centerS:E.s,size:z().areaSize,H:s(),normSector:Ye});let Mt=Z.color,_t=ls(rt,Wt,Mt);return Zt=us(_t,z().maxBlocks),Nt(Z.color,E.y),ht="selecting_target",!0}function w(h,R){let E=n.clientWidth,rt=n.clientHeight,Mt=E*.5,_t=(E-2*j)/2,Ht=rt-u-it,Se=6,ve=s(),ae=i(),le=r(),We=ae*Ht/(Se*ve),de=rt-it,oe,Ne,Te;We<=Math.min(_t,he)?(oe=We,Ne=Ht,Te=u):(oe=Math.min(_t,he),Ne=oe*Se*ve/ae,Te=de-Ne);let Ee=oe*.28,Qe=null,hn=1/0,Ze=l();for(let Xt=0;Xt<ve;Xt++){let ln=we(Te,Ne,Xt+.5);for(let _e=0;_e<ae;_e++){if(!Ze[Xt][_e])continue;let be=An(Mt,ln,oe,Ee,_e,le);if(Math.sin(be.ang)<-.1)continue;let ne=h-be.x,yn=R-be.y,qt=Math.hypot(ne,yn),Be=Ne/ve*.9,x=Be*1.2;Math.abs(ne)<x/2&&Math.abs(yn)<Be/2&&qt<hn&&(hn=qt,Qe={y:Xt,s:_e})}}return Qe}function Nt(h,R){Rt();let E=document.createElement("div");E.className="transmute-popup";let rt=n.clientWidth,Mt=n.clientHeight,_t=(rt-2*j)/2,Ht=Mt-u-it,Se=6,ve=s(),ae=i(),le=ae*Ht/(Se*ve),We=Mt-it,de,oe;le<=Math.min(_t,he)?(de=Ht,oe=u):(de=Math.min(_t,he)*Se*ve/ae,oe=We-de);let Ne=we(oe,de,R+.5),Te=Math.floor(z().areaSize/2),Ee=we(oe,de,Math.min(ve,R+Te)+.5),Qe=we(oe,de,Math.max(0,R-Te)+.5),hn=oe+de/2,Ze=document.getElementById("gameContainer"),Xt=Ze?Ze.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},ln=160,_e=60,be=20,un=Xt.left+Xt.width/2-ln/2,ne;Ne<hn?ne=Xt.top+Qe+be:ne=Xt.top+Ee-_e-be,ne=Math.max(10,Math.min(window.innerHeight-_e-10,ne)),E.style.left=`${un}px`,E.style.top=`${ne}px`,En.filter(qt=>qt.color!==h).forEach(qt=>{let Be=document.createElement("button");Be.className=`transmute-btn ${qt.name}`,Be.innerHTML=qt.icon,Be.setAttribute("data-color",qt.color),Be.addEventListener("click",x=>{x.stopPropagation(),He(qt.color)}),E.appendChild(Be)}),document.body.appendChild(E),Ct=E,Ve=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Jt)},50)}function Jt(h){performance.now()-Ve<200||Ct&&!Ct.contains(h.target)&&C()}function Rt(){document.removeEventListener("pointerdown",Jt),Ct&&(Ct.remove(),Ct=null)}function He(h){if(M()){S();return}if(!nt(f.currentSpell)){S();return}if(Rt(),ce=h,Zt.length===0){C();return}Dt()}function Dt(){if(!Z){C();return}if(Zt.length===0){C();return}if(!gt(f.currentSpell)){S(),C();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),ht="animating",mn=performance.now(),p.play("esseffect")}function $e(){if(ht!=="selecting_target"&&ht!=="animating"||!Z||!Wt||Wt.length===0)return;let h=l(),R=h[Z.y]?.[Z.s]??0;if(!R||R!==Z.color){C();return}let E=ls(h,Wt,R),rt=z().maxBlocks??E.length;Zt=us(E,rt),Zt.length===0&&C()}function Gt(h){if(ht!=="animating")return!1;let R=(h-mn)/1e3;return Math.min(R/z().animSec,1)>=1?(bn(),!1):!0}function ye(h){if(ht!=="animating")return null;let R=(h-mn)/1e3,E=Math.min(R/z().animSec,1),rt="flash",Mt=0,_t=0;return E<.15?(rt="flash",_t=1-E/.15):E<.55?(rt="shrink",Mt=(E-.15)/.4):(rt="grow",Mt=(E-.55)/.45),{phase:rt,progress:Mt,areaFlash:_t}}function bn(){let h=l();for(let R of Zt)h[R.y][R.s]=ce;ht="idle",Z=null,ce=null,Wt=[],Zt=[],Lt(0),ue(),typeof Vt=="function"&&Vt("earth")}function Ut(){p.play("ulta"),J="selecting_source",Ce=null,Pe=[],Kt=[],I=0,ht!=="idle"&&(ht="idle",Z=null,ce=null,Wt=[],Zt=[],Rt()),b!=="idle"&&(b="idle",T=null,O=[],y=[],Q=0),d.deactivate();let h=c.spellBtn;h&&h.classList.add("selecting")}function wt(){J!=="idle"&&p.play("cancel"),J="idle",Ce=null,Pe=[],Kt=[],I=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function A(){b="selecting_source",T=null,O=[],y=[],Q=0,ht!=="idle"&&(ht="idle",Z=null,ce=null,Wt=[],Zt=[],Rt()),J!=="idle"&&(J="idle",Ce=null,Pe=[],Kt=[],I=0),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function yt(){b!=="idle"&&p.play("cancel"),b="idle",T=null,O=[],y=[],Q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function At(h,R){if(J!=="selecting_source")return!1;if(M())return S(),!0;let E=w(h,R);if(!E)return wt(),!0;let rt=l();Ce={y:E.y,s:E.s,color:rt[E.y][E.s]},Pe=Is({centerY:E.y,centerS:E.s,size:V().areaSize,H:s(),normSector:Ye});let Mt=Ce.color,_t=ls(rt,Pe,Mt);return Kt=us(_t,V().maxBlocks),Kt.length===0?(wt(),!0):nt(f.currentSpell)?(on(),!0):(S(),!0)}function Pt(h,R){if(b!=="selecting_source")return!1;if(M())return S(),!0;let E=w(h,R);if(!E)return yt(),!0;let rt=l();return T={y:E.y,s:E.s,color:rt[E.y][E.s]},O=ko({centerY:E.y,centerS:E.s,beamLength:mt().beamLength,beamWidth:mt().beamWidth,N:i(),H:s(),normSector:Ye}),y=O.filter(Mt=>rt[Mt.y][Mt.s]),y.length===0?(yt(),!0):nt(f.currentSpell)?(Ge(),!0):(S(),!0)}function on(){if(!Ce||Kt.length===0){wt();return}if(!gt(f.currentSpell)){S(),wt();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),J="animating",U=performance.now(),I=0,p.play("asseffect")}function Fe(h){if(J!=="animating")return!1;let R=h-U,E=V().flashMs+Kt.length*V().jumpMs;return R>=E?(pn(),!1):!0}function rn(h){if(J!=="animating")return null;let R=h-U;if(R<V().flashMs)return{phase:"flash",flashProgress:1-R/V().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let E=R-V().flashMs,rt=Math.floor(E/V().jumpMs),Mt=E%V().jumpMs/V().jumpMs,_t=[];for(let Ht=0;Ht<Math.min(rt,Kt.length);Ht++)_t.push(Ht);return{phase:"chain",flashProgress:0,currentTarget:Math.min(rt,Kt.length-1),jumpProgress:Mt,struckTargets:_t}}function pn(){let h=l(),R=Kt.length,E=R*re;_.addScore(E),Ft(_.score),Qt(),P(`+${E}`,"score");for(let Ht of Kt)h[Ht.y][Ht.s]=0;let rt=V(),Mt=Math.abs(rt.kzDropSecPerBlock??0),_t=R*Mt;_t>0&&typeof k=="function"&&typeof W=="function"&&(k(_t*W()),P(`\u26A1 -${_t}s`,"time")),J="idle",Ce=null,Pe=[],Kt=[],I=0,Lt(0),ue(),typeof Vt=="function"&&Vt("air")}function Ge(){if(!T||y.length===0){yt();return}if(!gt(f.currentSpell)){S(),yt();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),b="animating",Q=performance.now(),p.play("fsseffect")}function lt(h){return b!=="animating"?!1:(h-Q)/1e3>=mt().animSec?(cn(),!1):!0}function te(h){if(b!=="animating")return null;let R=Math.max(.001,mt().animSec),E=(h-Q)/1e3,rt=Math.min(E/R,1),Mt=.25,_t=rt<Mt?1-rt/Mt:0;return{progress:rt,flashProgress:_t}}function cn(){let h=l(),R=y.length;if(R>0){let E=R*re;_.addScore(E),Ft(_.score),Qt(),P(`+${E}`,"score")}for(let E of y)h[E.y][E.s]=0;b="idle",T=null,O=[],y=[],Q=0,Lt(0),ue(),typeof Vt=="function"&&Vt("fire")}function In(){let h=typeof D=="function"?D():_.isPlaying(),R=f.currentSpell;if(!h)return!1;if(R==="ice"){if(M()||!nt(R)||!gt(f.currentSpell))return S(),!1;let E=f.effect;return typeof k=="function"&&typeof W=="function"&&k(E.duration*W()),p.play("wsseffect"),P(`\u{1F4A7} -${E.duration}s`,"time"),typeof et=="function"&&et(),typeof jt=="function"&&jt(E.duration),typeof Vt=="function"&&Vt(R),!0}return R==="earth"?ht==="selecting_source"||ht==="selecting_target"?(C(),!0):ht!=="idle"||M()||!nt(R)?(S(),!1):(ht==="idle"&&Tt(),!0):R==="air"?J==="selecting_source"?(wt(),!0):J!=="idle"||M()||!nt(R)?(S(),!1):(J==="idle"&&Ut(),!0):R==="fire"?b==="selecting_source"?(yt(),!0):b!=="idle"||M()||!nt(R)?(S(),!1):(b==="idle"&&A(),!0):!1}function an(h){$e(),Gt(h),Fe(h),lt(h)}function ee(h,R){return M()&&(ht==="selecting_source"||J==="selecting_source"||b==="selecting_source")?(S(),!0):ht==="selecting_source"?bt(h,R):J==="selecting_source"?At(h,R):b==="selecting_source"?Pt(h,R):!1}function Mn(){ht="idle",Z=null,ce=null,Wt=[],Zt=[],Rt(),J="idle",Ce=null,Pe=[],Kt=[],I=0,b="idle",T=null,O=[],y=[],Q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function ke(){return{transmuteState:ht,transmuteSourceBlock:Z,transmuteTargetColor:ce,transmuteAreaCells:Wt,transmuteBlocksToChange:Zt,lightningState:J,lightningSourceBlock:Ce,lightningAreaCells:Pe,lightningBlocksToHit:Kt,fireState:b,fireSourceBlock:T,fireLineCells:O,fireTargets:y}}return{startTransmuteSourceSelection:Tt,cancelTransmutation:C,startLightningSourceSelection:Ut,cancelLightning:wt,startFireSourceSelection:A,cancelFire:yt,handleTap:ee,update:an,reset:Mn,getRenderState:ke,getTransmuteAnimState:ye,getLightningAnimState:rn,getFireAnimState:te,handleSpellButtonClick:In,isTransmuteSelecting:()=>ht==="selecting_source",isLightningSelecting:()=>J==="selecting_source"}}var qi={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Do(e={}){let{canvas:n}=e,c=e.rotDir||1,l=!1,i=0,s=0,r=0,m=0,g=0,f=1,d=null,p=0,_=0,D=0,k=0,W=0,et=0,at=0,jt=0,z=qi;return{get rotDir(){return c},set rotDir(V){c=V},get dragging(){return l},get dragMode(){return d},handlePointerDown(V,mt,ue){if(mt.onMagicTap&&mt.onMagicTap(V.clientX,V.clientY))return!0;let Qt=performance.now(),P=Qt-et,xt=V.clientX-at,$t=V.clientY-jt,Vt=Math.hypot(xt,$t);return P<=z.DOUBLE_TAP_MS&&Vt<=z.DOUBLE_TAP_MAX_DIST?(mt.onDoubleTap&&mt.onDoubleTap(),et=0):(et=Qt,at=V.clientX,jt=V.clientY),l=!0,f=-1,i=V.clientX,s=V.clientY,r=ue,m=0,g=0,d=null,p=Qt,_=V.clientX,D=V.clientY,k=p,W=0,n&&n.setPointerCapture(V.pointerId),!1},handlePointerMove(V,mt,ue,Qt){if(!l)return null;let P=V.clientX-i,xt=V.clientY-s,$t=performance.now();if(Math.abs(P)<z.DEADZONE_PX&&Math.abs(xt)<z.DEADZONE_PX)return null;if(d){if(d==="rotate"){let se=Math.abs(P),Ft=Math.abs(xt);if(Ft>=se*z.AXIS_DOMINANCE&&Ft>=z.DROP_SWIPE_MIN_DISTANCE){let Lt=Math.max(1,$t-p);Ft/Lt*1e3>=z.DROP_SWIPE_MIN_SPEED&&(d="drop",g=0)}}}else{let se=Math.abs(P),Ft=Math.abs(xt);if(xt<0)se>=z.DEADZONE_PX&&(d="rotate");else if(Ft>=se*z.AXIS_DOMINANCE){if(Ft>=z.DROP_SWIPE_MIN_DISTANCE){let Lt=Math.max(1,$t-p);Ft/Lt*1e3>=z.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else se>=Ft*z.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let Vt=null;if(d==="rotate"&&Math.abs(P)>=z.DEADZONE_PX){let se=Math.max(1,$t-k),Ft=V.clientX-_,Lt=Math.max(1,Math.abs(Ft)/se*1e3),u=Math.max(z.MIN_ROT_PX,Math.min(z.MAX_ROT_PX,z.PX_PER_STEP*(z.SWIPE_SPEED_REF/Lt)));W+=-Ft/u*c*f;let it=Math.trunc(W);it!==0&&(W-=it);let j=m+it;if(j!==m&&mt.canRotateTo){let he=Math.sign(j-m),re=r+m;for(;m!==j;){let Ye=m+he,we=r+Ye;if(!mt.canRotateTo(Math.floor(ue),we))break;m=Ye,re=we,mt.onRotateStep&&mt.onRotateStep(),Qt&&mt.onGroundedMove&&mt.onGroundedMove()}Vt={targetRot:re,rotFloat:re}}}if(d==="drop"&&xt>=z.DROP_SWIPE_MIN_DISTANCE&&mt.onDrop){let se=Math.max(1,$t-k),Ft=V.clientY-D,Lt=Math.max(1,Ft/se*1e3),u=Math.max(z.MIN_DROP_PX,Math.min(z.MAX_DROP_PX,z.PX_PER_DROP*(z.SWIPE_SPEED_REF/Lt))),it=Math.trunc(xt/u);if(it>g){let j=it-g;for(let he=0;he<j;he++)mt.onDrop();g=it}}return _=V.clientX,D=V.clientY,k=$t,Vt},handlePointerUp(V){if(l&&(l=!1,d=null,n&&V&&V.pointerId!==void 0))try{n.releasePointerCapture(V.pointerId)}catch{}},reset(){l=!1,d=null,m=0,g=0,W=0}}}var ws={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ho(){let e="intro",n=0,c=0,l=0,i=0,s=0,r={...ws};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),l=0,i=0,s=0,r={...ws}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&c>0&&(l=performance.now()-c-s)},getFormattedTime(){let m=Math.floor(l/1e3),g=Math.floor(m/60),f=m%60;return`${g}:${f.toString().padStart(2,"0")}`},incrementStat(m,g=1){m in r&&(r[m]+=g)},updateMaxStat(m,g){m in r&&g>r[m]&&(r[m]=g)},reset(){e="intro",n=0,c=0,l=0,i=0,s=0,r={...ws}}}}function Rn(e,n){return e%=n,e<0&&(e+=n),e}function $o(e,n){return e[Math.min(n,e.length-1)]}function ds(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),l=n%60;return`${c}:${l.toString().padStart(2,"0")}`}function Fo(e,n){let c=e.map(({x:m,y:g},f)=>({x:g,y:-m,color:n[f]})),l=1/0,i=-1/0,s=1/0;for(let m of c)l=Math.min(l,m.x),i=Math.max(i,m.x),s=Math.min(s,m.y);let r=Math.round((l+i)/2);for(let m of c)m.x-=r,m.y-=s;return c.sort((m,g)=>m.y-g.y||m.x-g.x),{cells:c.map(m=>({x:m.x,y:m.y})),colors:c.map(m=>m.color)}}function Ps(e,n,c,l){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Rn(n-1,l)}),i.push({y:e,s:Rn(n+1,l)}),i}function Go(e,n,c){let l=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||l[s][r])continue;let m=[],g=[{y:s,s:r}];for(l[s][r]=1;g.length>0;){let f=g.shift();m.push(f);for(let d of Ps(f.y,f.s,n,c))e[d.y][d.s]&&!l[d.y][d.s]&&(l[d.y][d.s]=1,g.push(d))}i.push(m)}return i}function No(e){return e.some(n=>n.y===0)}function ks(e,n,c,l,i,s){if(!e)return!1;let r=Rn(c,s);for(let m of e.cells){let g=n+m.y,f=Rn(r+m.x,s);if(g<0)return!1;if(!(g>=i)&&l[g][f])return!1}return!0}function Uo(e,n,c,l,i,s){if(!e)return null;let r=Math.floor(n);for(;ks(e,r-1,c,l,i,s);)r-=1;return r}function Xo(e,n,c){let l=[],i=[];for(let s=0;s<n;s++){let r=[],m=0,g=e[s][0],f=g?1:0;for(let d=1;d<=c;d++){let p=d<c?e[s][d]:0;p&&p===g?f++:(f>=1&&g&&r.push({start:m,length:f,color:g}),m=d,g=p,f=p?1:0)}if(r.length>=2){let d=r[0],p=r[r.length-1];if(d.start===0&&p.start+p.length===c&&d.color===p.color){let _=d.length+p.length;r[0]={start:p.start,length:_,color:d.color},r.pop()}}for(let d of r)if(d.length>=3){let p=[];for(let _=0;_<d.length;_++)p.push({y:s,s:(d.start+_)%c});l.push({color:d.color,length:d.length,cells:p})}}for(let s=0;s<c;s++){let r=0,m=e[0][s],g=m?1:0;for(let f=1;f<=n;f++){let d=f<n?e[f][s]:0;if(d&&d===m)g++;else{if(g>=3&&m){let p=[];for(let _=0;_<g;_++)p.push({y:r+_,s});l.push({color:m,length:g,cells:p})}r=f,m=d,g=d?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let m=e[s][r],g=e[s][(r+1)%c],f=e[s][(r+2)%c],d=e[s][(r+3)%c];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let m=e[r][s],g=e[r+1][s],f=e[r+2][s],d=e[r+3][s];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:l,pairMatches:i}}function Yo(e,n,c){let l=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&l.push(i)}return l}function Vo(e,n){let c=new Map;e.forEach((l,i)=>c.set(`${l.x},${l.y}`,n[i]));for(let l=0;l<e.length;l++){let i=e[l],s=n[l],r=1;for(let et=1;et<=2&&c.get(`${i.x+et},${i.y}`)===s;et++)r++;if(r>=3)return!0;let m=1;for(let et=1;et<=2&&c.get(`${i.x},${i.y+et}`)===s;et++)m++;if(m>=3)return!0;let g=s,f=c.get(`${i.x+1},${i.y}`),d=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(g&&f&&d&&p&&g===f&&d===p&&g!==d)return!0;let _=s,D=c.get(`${i.x},${i.y+1}`),k=c.get(`${i.x},${i.y+2}`),W=c.get(`${i.x},${i.y+3}`);if(_&&D&&k&&W&&_===D&&k===W&&_!==k)return!0}return!1}function Wo(e){let{getN:n,getH:c,FALL_INTERVAL:l,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:g,getState:f,setState:d,funcs:p,ui:_}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(D,k={}){let W=f();if(D==="start_game")return W.gameState!=="playing"?(p.startGame(),!0):!1;if(W.gameState!=="playing")return!1;switch(D){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:et}=k;return typeof et=="number"&&p.canPlaceAtRot(Math.floor(W.pieceY),et)?(d({targetRot:et,rotFloat:et,rotVel:0}),W.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:et,y:at}=k;return p.shootMagic(et,at)}case"select_magic":{let{element:et}=k;return p.selectMagic(et),!0}default:return console.warn("GameEngine: unknown command",D),!1}},update(D,k){let W=f();if(W.gameState!=="playing")return;let et=k-W.startTime-W.totalPausedMs;d({elapsedMs:et}),_.updateTimeHud();let at=W.killLevel+s()*D;if(d({killLevel:at}),_.updateRemainingHud(),at>=c()){p.endGame();return}if(W.isHighlighting){let V=(k-W.highlightStartTime)/1e3,mt;W.isRingAnimation?mt=g:W.isMagicAnimation?mt=m:mt=r,V>=mt&&(W.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let jt=W.fallTimer+D;if(jt>=l&&(jt-=l,p.tryMoveDown()),d({fallTimer:jt}),p.updateGroundedState()){let V=W.lockTimer+D;d({lockTimer:V}),V>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(D,k){return p.canPlaceAtRot(D,k)},getRotation(){let D=f();return{targetRot:D.targetRot,rotFloat:D.rotFloat,rotVel:D.rotVel}},setRotation(D){d({targetRot:D,rotFloat:D,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var De=Math.PI*2;function Ko(e){let{canvas:n,canvasCtx:c,getN:l,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:m,MAX_RADIUS_X:g,RADIUS_X_FACTOR:f,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:_,MAGIC_SHRINK_SEC:D,RING_HIGHLIGHT_SEC:k,LOCK_DELAY_SEC:W,getKillRate:et,ELEMENT_COLORS:at,ELEMENT_TO_COLOR:jt,BLOCK_COLOR_FRONT:z,BLOCK_COLOR_BACK:V,ACTIVE_COLOR_FRONT:mt,GHOST_COLOR_FILL:ue,GHOST_COLOR_STROKE:Qt,GHOST_STROKE_WIDTH:P,MAGIC_DIM_DOT_ALPHA:xt,MAGIC_DIM_DOT_SCALE:$t,MAGIC_TARGET_DOT_SCALE:Vt,getState:se,getVisualSettings:Ft,funcs:Lt}=e,u=c,it=l(),j=i(),he={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},re=[],Ye=40;function we(U,I,b,T,O){let y=Math.max(3,Math.round(U)),Q=180;for(let nt=0;nt<y;nt++)setTimeout(()=>{let gt=Math.random()>.5?"left":"right",G=15,L=gt==="left"?G+Math.random()*Math.max(10,I-G*2):b+G+Math.random()*Math.max(10,O-b-G*2),M=T-10;re.push({x:L,baseX:L,y:M,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:G,maxX:O-G})},nt*Q)}function An(U,I,b){re=re.filter(T=>T.y>U+T.size&&T.y>-20);for(let T of re){T.y-=Ye*b,T.wobble+=T.wobbleSpeed*b;let O=T.baseX+Math.sin(T.wobble)*T.wobbleAmp;T.x=Math.max(T.minX,Math.min(T.maxX,O))}}function En(U){if(re.length!==0){u.fillStyle="rgba(255, 255, 255, 0.3)",u.strokeStyle="rgba(255, 255, 255, 0.5)",u.lineWidth=1;for(let I of re)I.y<U+I.size||(u.beginPath(),u.arc(I.x,I.y,I.size,0,Math.PI*2),u.fill(),u.stroke())}}let ht={left:0,right:0,h:0,w:0};function Z(U,I,b){let T=1-b/j;return U+T*I}function ce(U){return U=U%it,U<0?U+it:U}function Wt(U,I,b,T,O,y){let Q=ce(y),nt=(O-Q)/it*De+d;return{x:U+Math.cos(nt)*b,y:I+Math.sin(nt)*T,ang:nt}}let Zt=.52,mn=1.02;function Ct(U,I,b,T,O,y){let Q=ce(y),nt=(O-Q)/it*De+d;return{x:U+Math.cos(nt)*b,y:I+Math.sin(nt)*T,ang:nt}}function Ve(U,I,b,T,O,y,Q,nt=1){let gt=Ct(U,I,b,T,O-Zt,y),G=Ct(U,I,b,T,O+Zt,y),L={x:gt.x,y:gt.y-Q*.5},M={x:gt.x,y:gt.y+Q*.5},S={x:G.x,y:G.y-Q*.5},Tt={x:G.x,y:G.y+Q*.5},C=(L.x+S.x+Tt.x+M.x)*.25,bt=(L.y+S.y+Tt.y+M.y)*.25,w=mn*nt,Nt=nt,Jt=[L,S,Tt,M].map(Dt=>({x:C+(Dt.x-C)*w,y:bt+(Dt.y-bt)*Nt})),Rt=Math.abs((G.x-gt.x)*w),He=Math.abs(Q*Nt);return{corners:Jt,cx:C,cy:bt,wApprox:Rt,hApprox:He,ang:Ct(U,I,b,T,O,y).ang}}function J(U,I,b,T,O,y,Q,nt,gt=1,G=null,L=1,M=null,S=0,Tt=1,C=1){let bt=Ve(U,I,b,T,O,y,Q,C),[w,Nt,Jt,Rt]=bt.corners;if(u.save(),u.globalAlpha=gt,u.fillStyle=nt,u.beginPath(),u.moveTo(w.x,w.y),u.lineTo(Nt.x,Nt.y),u.lineTo(Jt.x,Jt.y),u.lineTo(Rt.x,Rt.y),u.closePath(),u.fill(),M&&S>0&&(u.strokeStyle=M,u.lineWidth=S,u.stroke()),G){let He=Math.min(bt.wApprox,bt.hApprox)*.28*Tt;u.globalAlpha=gt*L,u.fillStyle=G,u.beginPath(),u.arc(bt.cx,bt.cy,He,0,De),u.fill()}u.restore(),u.globalAlpha=1}function Ce(U,I,b,T,O,y){let Q=Wt(U,I,b,T,O,y),nt=Wt(U,I,b,T,O+1,y),gt=Wt(U,I,b,T,O-1,y),G=Math.abs(nt.x-Q.x),L=Math.abs(Q.x-gt.x),M=(G+L)*.5*1.06;return Math.max(1,M)}function Pe(U,I,b,T,O,y){let Q=(O-y)/it*De+d;return{x:U+Math.cos(Q)*b,y:I+Math.sin(Q)*T,ang:Q}}function Kt(U,I,b,T,O,y,Q,nt=1,gt=null,G=1,L=null,M=0,S=1){u.save(),u.translate(U,I);let Tt=Math.atan2(T,b);if(u.rotate(Tt),u.globalAlpha=nt,u.fillStyle=Q,u.fillRect(-O/2,-y/2,O,y),L&&M>0&&(u.strokeStyle=L,u.lineWidth=M,u.strokeRect(-O/2,-y/2,O,y)),gt){let C=Math.min(O,y)*.28*S;u.globalAlpha=nt*G,u.fillStyle=gt,u.beginPath(),u.arc(0,0,C,0,De),u.fill()}u.restore(),u.globalAlpha=1}return{resize(){let U=Math.max(1,Math.min(2,window.devicePixelRatio||1)),I=Math.floor(n.clientWidth*U),b=Math.floor(n.clientHeight*U);(n.width!==I||n.height!==b)&&(n.width=I,n.height=b,u.setTransform(U,0,0,U,0,0))},render(U=.016,I=performance.now()){this.resize();let b=se();it=l(),j=i();let T=n.clientWidth,O=n.clientHeight;u.clearRect(0,0,T,O),u.fillStyle="#0b0f14",u.fillRect(0,0,T,O);let y=T*.5,Q=(T-2*m)/2,nt=O-s-r,gt=6,G=it*nt/(gt*j),L,M,S,Tt;Tt=O-r,G<=Math.min(Q,g)?(L=G,M=nt,S=s):(L=Math.min(Q,g),M=L*gt*j/it,S=Tt-M);let C=L*.28,{killLevel:bt,rotFloat:w,grid:Nt,gameState:Jt}=b,Rt=Ft?Ft():{},He=Rt.waterColor||"blue",Dt=Rt.waterBubbles||!1,$e=he[He]||he.blue,Gt=Z(S,M,bt),ye=.7,bn=bt/j,Ut={...$e.top},wt={...$e.bottom};if(bn>ye){let x=(bn-ye)/(1-ye);Ut.r=Math.round(Ut.r+(255-Ut.r)*x*.5),Ut.g=Math.round(Ut.g+(150-Ut.g)*x*.5),Ut.b=Math.round(Ut.b+(150-Ut.b)*x*.5),wt.r=Math.round(wt.r+(180-wt.r)*x),wt.g=Math.round(wt.g*(1-x*.6)),wt.b=Math.round(wt.b*(1-x*.6))}let A=y-L-8,yt=y+L+8,At=S,Pt=Tt+5,on=u.createLinearGradient(0,Gt,0,O);on.addColorStop(0,`rgba(${Ut.r},${Ut.g},${Ut.b},0.5)`),on.addColorStop(1,`rgba(${wt.r},${wt.g},${wt.b},0.7)`),u.fillStyle=on;let Fe=Math.round((Ut.r+wt.r)/2),rn=Math.round((Ut.g+wt.g)/2),pn=Math.round((Ut.b+wt.b)/2),Ge=L+8,lt=C+4;u.fillRect(0,Gt,A,O-Gt),u.fillRect(yt,Gt,T-yt,O-Gt),u.beginPath();let te=Math.max(Gt,Pt);u.moveTo(A,te),Gt<=Pt+lt?u.ellipse(y,Pt,Ge,lt,0,Math.PI,0,!1):u.lineTo(yt,te),u.lineTo(yt,O),u.lineTo(A,O),u.closePath(),u.fill(),u.strokeStyle="rgba(100,180,255,0.6)",u.lineWidth=3,u.lineCap="round",u.beginPath(),u.moveTo(A,At),u.lineTo(A,Pt),u.stroke(),u.beginPath(),u.moveTo(yt,At),u.lineTo(yt,Pt),u.stroke(),u.beginPath(),u.ellipse(y,Pt,L+8,C+4,0,0,Math.PI),u.stroke(),u.fillStyle="#0b0f14",u.beginPath(),u.ellipse(y,Pt,L+8,C+4,0,0,De),u.fill(),bt>.5&&(u.strokeStyle=`rgba(${Math.min(255,Fe+60)},${Math.min(255,rn+40)},${Math.min(255,pn+40)},0.6)`,u.lineWidth=2,u.beginPath(),u.moveTo(0,Gt),u.lineTo(A,Gt),u.moveTo(yt,Gt),u.lineTo(T,Gt),u.stroke()),ht={left:A,right:yt,h:O,w:T},(re.length>0||Dt)&&(An(Gt,O,U),En(Gt)),u.strokeStyle="rgba(160,190,220,0.3)",u.lineWidth=1;let cn=De*L,In=10,an=cn/In*.7,ee=cn/In*.3;u.setLineDash([an,ee]);let Mn=cn/it;u.lineDashOffset=ce(w)*Mn;for(let x=0;x<=j;x++){let $=Z(S,M,x);u.beginPath(),u.ellipse(y,$,L,C,0,0,De),u.stroke()}u.setLineDash([]);let ke=[],h=[];for(let x=0;x<j;x++){let $=Z(S,M,x+.5);for(let K=0;K<it;K++){let N=Nt[x][K];if(!N)continue;let q=Wt(y,$,L,C,K,w),Y=Math.sin(q.ang),H={y:x,s:K,yScr:$,p:q,depth:Y,color:N};Y<-.1?ke.push(H):h.push(H)}}let R=Lt.getMagicTargetColor(),{isHighlighting:E,highlightedCells:rt,highlightStartTime:Mt,isMagicAnimation:_t}=b,Ht=null,Se=1,ve=1,ae=!1;if(E&&rt.length>0){Ht=new Set(rt.map($=>`${$.y},${$.s}`));let x=(performance.now()-Mt)/1e3;if(_t){let $=Math.min(1,x/D);Se=1-$*.85,ve=1-$*.9,ae=!0}else{let $=Math.min(1,x/p),K=1-_;if($>K){let N=($-K)/_;Se=1-N*.85,ve=1-N*.9,ae=!0}}}ke.sort((x,$)=>x.depth-$.depth);for(let x of ke){let $=M/j*.9,K=at[x.color]||null,N=.35,q=1,Y=`${x.y},${x.s}`;Ht&&Ht.has(Y)&&(N*=ve,q=Se),J(y,x.yScr,L,C,x.s,w,$,V,N,K,.5,null,0,1,q)}let{isRingAnimation:le}=b;if(E&&rt.length>0&&!_t){let x=(performance.now()-Mt)/1e3,K=Math.min(1,x/(le?k:p)),N=1-_,q=K>N,Y=q?(K-N)/_:0,H=le?Math.floor(K*N*it*2)%it:-1,B=4+K/N*10,X=Math.sin(x*B*De),ct=q?1:.3+X*.3,ft=q?1-Y*.8:1,St=q?1-Y:1;for(let ot of rt){let vt=Z(S,M,ot.y+.5),Me=Ct(y,vt,L,C,ot.s,w);if(Math.sin(Me.ang)>=-.1)continue;let Sn=M/j*.9,fe,Le,Et;if(le){let Ke=(ot.s-H+it)%it,Je=Ke<3?1-Ke/3:0;fe=(q?St:.2+Je*.5)*.5,Le=`rgba(255, 159, 67, ${fe})`,Et=q?ft:1+Je*.15}else fe=ct*St,Le=ot.isLine?`rgba(255, 255, 255, ${fe*.5})`:`rgba(255, 220, 100, ${fe*.4})`,Et=q?ft:1.1;J(y,vt,L,C,ot.s,w,Sn,Le,1,null,1,null,0,1,Et)}}h.sort((x,$)=>x.depth-$.depth);for(let x of h){let $=M/j*.9,K=at[x.color]||null,N=1,q=1,Y=1,H=1,B=`${x.y},${x.s}`,X=Ht&&Ht.has(B);X&&(N=ve,q=Se),R!==null&&!X&&(x.color!==R?(Y=xt,H=$t):H=Vt),J(y,x.yScr,L,C,x.s,w,$,z,N,K,Y,null,0,H,q)}if(E&&rt.length>0&&!_t){let x=(performance.now()-Mt)/1e3,K=Math.min(1,x/(le?k:p)),N=1-_,q=K>N,Y=q?(K-N)/_:0,H=le?Math.floor(K*N*it*2)%it:-1,B=4+K/N*10,X=Math.sin(x*B*De),ct=q?1:.5+X*.5,ft=q?1-Y*.8:1,St=q?1-Y:1;for(let ot of rt){let vt=Z(S,M,ot.y+.5),Me=Ct(y,vt,L,C,ot.s,w);if(Math.sin(Me.ang)<-.1)continue;let Sn=M/j*.9,fe,Le,Et;if(le){let Ke=(ot.s-H+it)%it,Je=Ke<4?1-Ke/4:0;fe=q?St:.3+Je*.7,Le=`rgba(255, 159, 67, ${fe})`,Et=q?ft:1+Je*.2}else fe=ct*St,Le=ot.isLine?`rgba(255, 255, 255, ${fe*.7})`:`rgba(255, 220, 100, ${fe*.6})`,Et=q?ft:1.15;J(y,vt,L,C,ot.s,w,Sn,Le,1,null,1,null,0,1,Et)}}let We=b.spellState||b,{transmuteState:de,transmuteSourceBlock:oe,transmuteTargetColor:Ne,transmuteAreaCells:Te,transmuteBlocksToChange:Ee}=We;if(de==="selecting_source"){let x=M/j*.9,$=.35+Math.sin(I/150)*.15;for(let K of h){let N=Z(S,M,K.y+.5);J(y,N,L,C,K.s,w,x,`rgba(0, 40, 20, ${$})`,1,null,1,null,0,1,1)}}if(de==="selecting_target"&&Ee&&Ee.length>0){let x=M/j*.9,$=.4+Math.sin(I/120)*.25,K=.6+Math.sin(I/120)*.4;for(let N of Ee){if(N.y<0||N.y>=j)continue;let q=Z(S,M,N.y+.5),Y=Ct(y,q,L,C,N.s,w);Math.sin(Y.ang)<-.1||(J(y,q,L,C,N.s,w,x,`rgba(0, 50, 30, ${$})`,1,null,1,null,0,1,1),J(y,q,L,C,N.s,w,x,"transparent",1,null,1,`rgba(100, 255, 150, ${K})`,3,1,1.02))}}if(de==="animating"&&Lt.getTransmuteAnimState){let x=Lt.getTransmuteAnimState(I);if(x){let $=M/j*.9,{phase:K,progress:N,areaFlash:q}=x;if(q>0&&Te)for(let Y of Te){if(Y.y<0||Y.y>=j)continue;let H=Z(S,M,Y.y+.5),B=Ct(y,H,L,C,Y.s,w);Math.sin(B.ang)<-.1||J(y,H,L,C,Y.s,w,$,`rgba(150, 255, 200, ${q*.4})`,1,null,1,null,0,1,1)}if(Ee&&Ee.length>0){let Y=oe?oe.color:1,H=Ne||1;for(let B of Ee){if(B.y<0||B.y>=j)continue;let X=Z(S,M,B.y+.5),ct=Ct(y,X,L,C,B.s,w);if(Math.sin(ct.ang)<-.1)continue;let St=1,ot=at[Y],vt=0;if(K==="shrink"?(St=1-N*.95,ot=at[Y],vt=.5+N*.3):K==="grow"&&(St=N,ot=at[H],vt=.8-N*.5),vt>0&&J(y,X,L,C,B.s,w,$,`rgba(200, 255, 220, ${vt})`,1,null,1,null,0,1,1),St>.05){let Me=Ve(y,X,L,C,B.s,w,$,1),Ue=Math.min(Me.wApprox,Me.hApprox)*.28*St;u.save(),u.globalAlpha=1,u.fillStyle=ot,u.beginPath(),u.arc(Me.cx,Me.cy,Ue,0,De),u.fill(),u.restore()}}}}}let{lightningState:Qe,lightningSourceBlock:hn,lightningAreaCells:Ze,lightningBlocksToHit:Xt}=We;if(Qe==="selecting_source"){let x=M/j*.9,$=.35+Math.sin(I/150)*.15;for(let K of h){let N=Z(S,M,K.y+.5);J(y,N,L,C,K.s,w,x,`rgba(20, 20, 60, ${$})`,1,null,1,null,0,1,1)}}if(Qe==="animating"&&Lt.getLightningAnimState){let x=Lt.getLightningAnimState(I);if(x&&Xt&&Xt.length>0){let $=M/j*.9,{phase:K,flashProgress:N,currentTarget:q,jumpProgress:Y,struckTargets:H}=x;if(K==="flash"&&N>0&&Ze)for(let B of Ze){if(B.y<0||B.y>=j)continue;let X=Z(S,M,B.y+.5),ct=Ct(y,X,L,C,B.s,w);Math.sin(ct.ang)<-.1||J(y,X,L,C,B.s,w,$,`rgba(100, 150, 255, ${N*.5})`,1,null,1,null,0,1,1)}if(H&&H.length>0)for(let B of H){let X=Xt[B];if(!X||X.y<0||X.y>=j)continue;let ct=Z(S,M,X.y+.5),ft=Ct(y,ct,L,C,X.s,w);if(Math.sin(ft.ang)<-.1)continue;let ot=(H.length-1-H.indexOf(B))*.1,vt=Math.max(0,.8-ot);J(y,ct,L,C,X.s,w,$,`rgba(255, 255, 255, ${vt})`,1,null,1,`rgba(150, 200, 255, ${vt})`,2,1,1.05)}if(K==="chain"&&q>=0&&q<Xt.length){let B=Xt[q];if(B&&B.y>=0&&B.y<j){let X=Z(S,M,B.y+.5),ct=Ct(y,X,L,C,B.s,w);if(Math.sin(ct.ang)>=-.1){let St=1-Y;J(y,X,L,C,B.s,w,$,`rgba(200, 220, 255, ${St*.9})`,1,null,1,`rgba(100, 180, 255, ${St})`,3,1,1.1-Y*.05)}}if(q>0){let X=Xt[q-1],ct=Xt[q];if(X&&ct){let ft=Z(S,M,X.y+.5),St=Z(S,M,ct.y+.5),ot=Ve(y,ft,L,C,X.s,w,$,1),vt=Ve(y,St,L,C,ct.s,w,$,1);u.save(),u.strokeStyle=`rgba(150, 200, 255, ${1-Y*.5})`,u.lineWidth=2+(1-Y)*2,u.lineCap="round",u.beginPath();let Me=ot.cx,Ue=ot.cy,Sn=vt.cx,fe=vt.cy;u.moveTo(Me,Ue);let Le=4;for(let Et=1;Et<=Le;Et++){let Ke=Et/Le,Je=Me+(Sn-Me)*Ke,st=Ue+(fe-Ue)*Ke,dn=Et<Le?(Math.random()-.5)*8:0;u.lineTo(Je+dn,st+dn)}u.stroke(),u.strokeStyle=`rgba(100, 150, 255, ${(1-Y)*.3})`,u.lineWidth=6,u.stroke(),u.restore()}}}}}let{fireState:ln,fireSourceBlock:_e,fireLineCells:be,fireTargets:un}=We;if(ln==="selecting_source"){let x=M/j*.9,$=.3+Math.sin(I/140)*.2;for(let K of h){let N=Z(S,M,K.y+.5);J(y,N,L,C,K.s,w,x,`rgba(70, 25, 10, ${$})`,1,null,1,null,0,1,1)}}if(ln==="animating"&&Lt.getFireAnimState){let x=Lt.getFireAnimState(I);if(x&&be&&be.length>0){let $=M/j*.9,{progress:K,flashProgress:N}=x,q=Math.sin(K*Math.PI);if(N>0)for(let Y of be){if(Y.y<0||Y.y>=j)continue;let H=Z(S,M,Y.y+.5),B=Ct(y,H,L,C,Y.s,w);Math.sin(B.ang)<-.1||J(y,H,L,C,Y.s,w,$,`rgba(255, 120, 50, ${N*.45})`,1,null,1,`rgba(255, 200, 140, ${N*.5})`,2,1,1.03)}if(_e){let Y=new Map;for(let B of be){if(B.y<0||B.y>=j)continue;let X=Z(S,M,B.y+.5),ct=Ct(y,X,L,C,B.s,w);if(Math.sin(ct.ang)<-.1)continue;let St=Ve(y,X,L,C,B.s,w,$,1),ot=B.s-_e.s;ot>it/2&&(ot-=it),ot<-it/2&&(ot+=it);let vt=B.y;Y.has(vt)||Y.set(vt,[]),Y.get(vt).push({x:St.cx,y:St.cy,offset:ot})}let H=Array.from(Y.keys()).sort((B,X)=>X-B);if(H.length>0){let B=.35+.3*Math.sin(I/60)+q*.2;u.save(),u.lineCap="round";for(let X of H){let ct=Y.get(X)||[];if(ct.sort((ft,St)=>ft.offset-St.offset),ct.length!==0){u.beginPath(),u.moveTo(ct[0].x,ct[0].y);for(let ft=1;ft<ct.length;ft++)u.lineTo(ct[ft].x,ct[ft].y);u.strokeStyle=`rgba(255, 140, 60, ${B})`,u.lineWidth=Math.max(2,$*.15),u.stroke(),u.strokeStyle=`rgba(255, 210, 140, ${B*.35})`,u.lineWidth=Math.max(6,$*.35),u.stroke()}}u.restore()}}if(un&&un.length>0){let Y=.2+q*.6;for(let H of un){if(H.y<0||H.y>=j)continue;let B=Z(S,M,H.y+.5),X=Ct(y,B,L,C,H.s,w);Math.sin(X.ang)<-.1||J(y,B,L,C,H.s,w,$,`rgba(255, 160, 70, ${Y})`,1,null,1,`rgba(255, 230, 180, ${q*.6})`,2,1,1.05)}}}}let{activePiece:ne,pieceY:yn,isGrounded:qt,lockTimer:Be}=b;if(ne){let x=Lt.snappedRot(),$=x,K=Lt.computeGhostY(),N=M/j*.9;if(K!==null){let H=[];for(let B=0;B<ne.cells.length;B++){let X=ne.cells[B],ct=ne.colors[B],ft=K+X.y,St=Lt.normSector(x+X.x);if(ft<0||ft>=j)continue;let ot=Z(S,M,ft+.5),vt=Ct(y,ot,L,C,St,$);H.push({cy:ft,cs:St,yScr:ot,depth:Math.sin(vt.ang),color:ct})}H.sort((B,X)=>B.depth-X.depth);for(let B of H){let X=at[B.color]||null;J(y,B.yScr,L,C,B.cs,$,N,ue,1,X,.5,Qt,P,1,1)}}let q=mt;if(qt&&Be>0){let H=Math.min(1,Be/W),B=255,X=Math.round(170+85*H),ct=Math.round(180+75*H),ft=.75+(1-.75)*H;q=`rgba(${B},${X},${ct},${ft})`}let Y=[];for(let H=0;H<ne.cells.length;H++){let B=ne.cells[H],X=ne.colors[H],ct=Lt.normSector(x+B.x),ft=yn+B.y;if(ft<0||ft>=j)continue;let St=Z(S,M,ft+.5),ot=Ct(y,St,L,C,ct,$);Y.push({cs:ct,yScr:St,depth:Math.sin(ot.ang),color:X})}Y.sort((H,B)=>H.depth-B.depth);for(let H of Y){let B=at[H.color]||null;J(y,H.yScr,L,C,H.cs,$,N,q,1,B,1,null,0,1,1)}}},drawNextPreview(U,I){if(!U)return;let b=U.getContext("2d"),T=U.width,O=U.height;if(b.clearRect(0,0,T,O),!I)return;let y=1/0,Q=-1/0,nt=1/0,gt=-1/0;for(let C of I.cells)y=Math.min(y,C.x),Q=Math.max(Q,C.x),nt=Math.min(nt,C.y),gt=Math.max(gt,C.y);let G=Q-y+1,L=gt-nt+1,M=Math.min(T/(G+.5),O/(L+.5)),S=(T-G*M)/2,Tt=(O-L*M)/2;b.fillStyle=z;for(let C=0;C<I.cells.length;C++){let bt=I.cells[C],w=S+(bt.x-y)*M,Nt=Tt+(L-1-(bt.y-nt))*M;b.fillRect(w+1,Nt+1,M-2,M-2);let Jt=I.colors[C],Rt=at[Jt];if(Rt){let He=(M-2)*.32;b.fillStyle=Rt,b.beginPath(),b.arc(w+M/2,Nt+M/2,He,0,De),b.fill(),b.fillStyle=z}}},spawnBonusBubbles(U){let{left:I,right:b,h:T,w:O}=ht;O>0&&we(U,I,b,T,O)}}}(()=>{let e=To(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,i=30,s=24,r=120,m={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function g(t){let o=m[t]||m["30_24"];i=o.N,s=o.H,r=o.survivalTime}function f(){return s/r}let d=Math.PI/2,p=70,_=120,D=30,k=320,W=.42,et="rgb(235,240,250)",at="rgb(55,62,75)",jt="rgba(255,170,180,0.75)",z="rgba(110,255,150,0.15)",V="rgba(110,255,150,0.85)",mt=2,ue={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Qt={1:"fire",2:"water",3:"lightning",4:"earth"},P={fire:1,water:2,lightning:3,earth:4},xt=1,$t=.58,Vt=!0,se=12,Ft=25,Lt=1,u=2,it=3,j=1,he=5,re=7,Ye=10,we=3,An=50,En=2,ht=.3,Z=.5,ce=1,Wt=.3,Zt=.5,mn=1.3,Ct=10,Ve=1e3,J=[1,1.25,1.5,1.75,2],Ce=10,Pe=20,Kt=5,U=[1,1.3,1.6,2],I=[1,1.5,2,2.5],b=Co(),T=b.loadGameSettings();T.hapticsEnabled===void 0&&(T.hapticsEnabled=!0);let O=T.invertSwipe?-1:1,Q=!1,nt=-1,gt=Io({enabled:T.hapticsEnabled}),G=Array.from({length:s},()=>new Uint8Array(i));function L(){G=Array.from({length:s},()=>new Uint8Array(i))}let M=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],S=null,Tt=s+3,C=0,bt=0,w=!1,Nt=0,Jt=0,Rt=0,He=3,Dt=0,$e=0,Gt=0,ye=Do({canvas:n,rotDir:O}),bn="0.16.8",Ut=!0,wt="blue",A=vo();A.preload();let yt=Ho(),At="intro",Pt=0,on=0,Fe=0,rn=0,pn=0,Ge=null,lt=yt.stats,te=0,cn=e.overlay,In=e.gameContainer,an=Bo({elementColors:ue}),ee=an.showBonus.bind(an),Mn=an.getElementIcon.bind(an),ke=Lo(),h=e.overlayTitle,R=e.overlayStats,E=e.startBtn,rt=e.hud,Mt=e.scoreHud,_t=e.timeHud,Ht=e.remainingHud,Se=e.nextCanvas,ve=Se.getContext("2d"),ae=e.pauseBtn,le=e.pauseOverlay,We=e.resumeBtn,de=e.restartBtn,oe=e.exitToMenuBtn,Ne=e.pauseSettingsBtn,Te=e.pauseSoundBtn,Ee=e.pauseMusicBtn,Qe=e.pauseBestScore,hn=e.pauseBestTime,Ze=e.pauseBestMode,Xt=e.pauseCurrentScore,ln=e.pauseCurrentTime,_e=e.pauseCurrentMode,be=e.confirmDialog,un=e.confirmText,ne=e.confirmCancel,yn=e.confirmOk,qt=e.settingsOverlay,Be=e.settingsClose,x=e.fullscreenBtn,$=e.rotateBtn,K=e.startPanel,N=e.gameoverPanel,q=e.goScore,Y=e.goTime,H=e.goRing,B=e.goMatches,X=e.goBonuses,ct=e.goNewRecord,ft=e.goRestartBtn,St=e.goExitBtn,ot=e.bestScore,vt=e.bestTimeVal,Me=e.startVersion,Ue=e.modeBtns,Sn=e.recordsBtn,fe=e.startSettingsBtn,Le=e.helpBtn;Ao({helpBtn:Le});let Et="25_20";function Ke(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function Je(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let a=o.dataset.mode,v=m[a];if(!v)return;let F=o.querySelector(".mode-tag.time-tag");if(!F)return;let tt=Ke(v.survivalTime);tt&&(F.textContent=tt)})}Je();let st=wo({buttons:e.magicBtns,onActivate:()=>A.play("spells"),onChange:(t,o)=>{ms()}}),dn=e.magicBtns,ji=st.charges,qo=t=>Re()?st.select(t):!1,wn=()=>st.updateButtons(),Os=e.magicRow,kt=e.magicActiveIndicator,Ds=e.magicActiveIcon,Hs=e.magicActiveCost,zo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},fs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},jo=["ice","earth","air","fire"];te=b.loadHighTowerRings();function Pn(t){return typeof ie?.getUnlockRings=="function"?ie.getUnlockRings(t):0}function Xn(t){let o=Pn(t);return o===0||te>=o}let $s=["fire","water","lightning","earth"],xn=null,Yn=!1,Qo=500,Zo=30,Jo=220,Cn=null,gs=null,Fs={fire:!1,water:!1,lightning:!1,earth:!1};function Gs(){if(!kt)return;let t=kt.getBoundingClientRect();t.width>0&&t.height>0&&(gs=t)}function ti(){if(!kt)return null;let t=kt.getBoundingClientRect();return t.width>0&&t.height>0?kt:gs?{getBoundingClientRect:()=>gs}:null}function kn(t=st.active){if(!kt||!Ds)return;t?(xn=t,Yn=!1):Yn||(xn=null);let o=xn;if(!o||!Re()||(st.charges[o]??0)<=0){Gs(),kt.classList.add("hidden"),kt.classList.remove("active","ult-ready",...$s),kt.style.setProperty("--progress","0%"),Cn&&clearTimeout(Cn),Cn=setTimeout(()=>{kt.classList.add("gone")},Jo);return}Cn&&(clearTimeout(Cn),Cn=null),kt.classList.remove("gone"),kt.classList.contains("hidden")?requestAnimationFrame(()=>kt.classList.remove("hidden")):kt.classList.remove("hidden"),Ds.textContent=Mn(o);let v=fs[o];v&&ie.selectSpell(v);let F=v?Dn(v):0,tt=st.charges[o]??0,ut=!!v&&Kn()&&Xn(v),zt=!!v&&Kn()&&!ut,xe=ut&&F>0?Math.min(tt/F,1):0,je=ut&&F>0,Ae=je&&tt>=F;Hs&&(Hs.textContent=je?`-${F}`:zt?"\u{1F512}":""),kt.classList.toggle("no-cost",!je&&!zt),kt.classList.toggle("locked",zt),kt.classList.toggle("ult-ready",Ae),kt.style.setProperty("--progress",`${Math.round(xe*100)}%`),kt.classList.remove("hidden",...$s),kt.classList.add("active",o),Gs()}function ei(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Qo))}function Vn(){for(let[t,o]of Object.entries(dn)){if(!o)continue;let a=fs[t],v=Dn(a),F=Kn()&&Re()&&a,tt=typeof Xn=="function"?Xn(a):!0,ut=F&&tt&&v>0&&(st.charges[t]??0)>=v;o.classList.toggle("ult-ready",ut),ut&&!Fs[t]&&(ei(o),At==="playing"&&A.play("readysuper")),Fs[t]=ut}}function Re(t=Et){return t==="30_24"?!0:Q}function ms(){kn(st.active),Vn()}function Qi(t){Q=t,Et==="25_20"&&(Q?st.reset():(st.deactivate(),Object.keys(st.charges).forEach(o=>{st.charges[o]=0})),wn()),Wn(),ms()}function Wn(){Os&&(Os.style.display=Re()?"":"none",kn(st.active),Vn())}function Zi(t){let o=Tn(t),a=Dn(t);return!o||a<=0?!1:st.charges[o]>=a}function Ji(t){let o=Tn(t),a=Dn(t);return!o||a<=0||st.charges[o]<a?!1:(st.charges[o]-=a,st.updateButtons(),ie.pulse(),!0)}let On=e.spellWave;function ni(){On&&(On.classList.remove("active"),On.offsetWidth,On.classList.add("active"),setTimeout(()=>On.classList.remove("active"),1200))}let tn=null,ie=Po({button:kt,onReady:()=>{A.play("readysuper")}}),si=()=>ie.getEffect("earth"),oi=()=>ie.getEffect("air"),ii=()=>ie.getEffect("fire"),Dn=t=>typeof ie?.getCost=="function"?ie.getCost(t):0,Tn=t=>zo[t]??null;tn=Oo({canvas:n,dom:e,getGrid:()=>G,getN:()=>i,getH:()=>s,getRotFloat:()=>Dt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:D,MAX_RADIUS_X:k,SCORE_MAGIC_DESTROY:Kt},helpers:{normSector:Zn,levelYToScreenY:zn,sectorCenterXY:jn},Spell:ie,Magic:st,SoundModule:A,State:yt,isGamePlaying:()=>At==="playing",addPendingKzDrop:t=>{Rt+=t},getKillRate:f,triggerSpellWave:ni,spawnSpellBubbles:t=>{let o=Tn(ie.currentSpell)??"water";ke.spawnSpellBubbles(ie.button,o,t)},spawnBonusBubbles:t=>{Ln.spawnBonusBubbles(t)},getTransmuteEffect:si,getLightningEffect:oi,getFireEffect:ii,continueMatchProcessing:Qn,updateScoreHud:Fn,showBonus:ee,getSpellCost:Dn,getSpellElement:Tn,onUltimateApplied:t=>{let o=Tn(t)??Tn(ie.currentSpell)??"water";if(typeof ke?.spawnSpellBubbles=="function"){let a=ti();a&&ke.spawnSpellBubbles(a,o,Zo)}Yn=!1,xn=null,kn(null),Vn()},isSpellBlocked:ri,setScore:t=>{Pt=t},setCascadeLevel:t=>{nn=t}});function Kn(){return Et==="30_24"}function qn(){kn(st.active),Vn()}let en=[],Hn=0,qe=!1,fn=!1,_n=!1,Oe=0,ze=0,nn=0,Bn=[];function ri(){return qe||fn||_n}function zn(t,o,a){let v=1-a/s;return t+v*o}function jn(t,o,a,v,F,tt){let ut=(F-tt)/i*l+d;return{x:t+Math.cos(ut)*a,y:o+Math.sin(ut)*v,ang:ut}}function Ns(t,o){let a=n.clientWidth,v=n.clientHeight,F=a*.5,tt=(a-2*D)/2,ut=v-p-_,zt=6,xe=i*ut/(zt*s),je=v-_,Ae,Bt,dt;xe<=Math.min(tt,k)?(Ae=xe,Bt=ut,dt=p):(Ae=Math.min(tt,k),Bt=Ae*zt*s/i,dt=je-Bt);let pt=Ae*.28,Ot=zn(dt,Bt,t+.5),Yt=jn(F,Ot,Ae,pt,o,Dt),ge=n.getBoundingClientRect();return{x:ge.left+Yt.x,y:ge.top+Yt.y}}function ci(t,o){if(!Re()||!st.canUse()||qe)return!1;let a=P[st.active],v=n.clientWidth,F=n.clientHeight,tt=v*.5,ut=(v-2*D)/2,zt=F-p-_,xe=6,je=i*zt/(xe*s),Ae=F-_,Bt,dt,pt;je<=Math.min(ut,k)?(Bt=je,dt=zt,pt=p):(Bt=Math.min(ut,k),dt=Bt*xe*s/i,pt=Ae-dt);let Ot=Bt*.28,Yt=null,ge=1/0;for(let me=0;me<s;me++){let Ie=zn(pt,dt,me+.5);for(let pe=0;pe<i;pe++){let cs=G[me][pe];if(!cs||cs!==a)continue;let Un=jn(tt,Ie,Bt,Ot,pe,Dt);if(Math.sin(Un.ang)<-.1)continue;let as=t-Un.x,mo=o-Un.y,po=Math.hypot(as,mo),ho=dt/s*.9,Hi=ho*1.2;Math.abs(as)<Hi/2&&Math.abs(mo)<ho/2&&po<ge&&(ge=po,Yt={y:me,s:pe})}}if(Yt){let me=zn(pt,dt,Yt.y+.5),Ie=jn(tt,me,Bt,Ot,Yt.s,Dt),pe=n.getBoundingClientRect(),cs=pe.left+Ie.x,Un=pe.top+Ie.y,go=dn[st.active];return ke.spawnMagicShot(st.active,go,cs,Un,()=>{let as=G[Yt.y][Yt.s];en=[{y:Yt.y,s:Yt.s,color:as,isLine:!1,isMagic:!0}],Hn=performance.now(),qe=!0,fn=!0,Oe=0,ze=Kt,ee(`+${Kt}`,"score")}),nn=0,st.useCharge(),lt.magicUsed++,!0}return!1}let tr=100;function er(t,o){return Ps(t,o,s,i)}function ai(){return Go(G,s,i)}let li=No;function ui(t){let o=t.map(v=>({...v,color:G[v.y][v.s]}));for(let v of t)G[v.y][v.s]=0;let a=s;for(let v of t){let F=v.y;for(let tt=1;tt<=v.y;tt++){let ut=v.y-tt;if(G[ut][v.s]){F=tt-1;break}}a=Math.min(a,F)}for(let v of o)G[v.y-a][v.s]=v.color;return a>0}function di(){let t=!0;for(;t;){t=!1;let o=ai();for(let a of o)li(a)||ui(a)&&(t=!0)}}function fi(){Qn()}let ps=$o;function Us(t,o){let a=new Map,v=0,F=0,tt=0,ut={},zt=t.length+o.length;for(let dt of t){let pt=Qt[dt.color],Ot=0,Yt=0;if(dt.length>=5?(Ot=it,Yt=Ye,lt.lines5++):dt.length===4?(Ot=u,Yt=re,lt.lines4++):dt.length===3&&(Ot=Lt,Yt=he,lt.lines3++),Re()&&pt&&Ot>0){st.addCharges(pt,Ot),ut[pt]=(ut[pt]||0)+Ot;let ge=dt.cells[Math.floor(dt.cells.length/2)],me=Ns(ge.y,ge.s),Ie=dn[pt];for(let pe=0;pe<Ot;pe++)setTimeout(()=>{ke.spawnMagicOrb(pt,me.x,me.y,Ie)},pe*100)}v+=Yt*f(),tt+=Yt,F+=dt.length*Ce;for(let ge of dt.cells){let me=`${ge.y},${ge.s}`;a.has(me)||a.set(me,{y:ge.y,s:ge.s,color:dt.color,isLine:!0})}}for(let dt of o){if(lt.pairs++,v+=we*f(),tt+=we,F+=Pe,Re()){let pt=[...new Set(dt.cells.map(Ot=>G[Ot.y][Ot.s]).filter(Boolean))];if(pt.length>0){let Ot=dt.cells[Math.floor(dt.cells.length/2)],Yt=Ns(Ot.y,Ot.s);pt.forEach((ge,me)=>{let Ie=Qt[ge];if(!Ie)return;st.addCharges(Ie,j),ut[Ie]=(ut[Ie]||0)+j;let pe=dn[Ie];pe&&setTimeout(()=>{ke.spawnMagicOrb(Ie,Yt.x,Yt.y,pe)},me*100)})}}for(let pt of dt.cells){let Ot=`${pt.y},${pt.s}`;a.has(Ot)||a.set(Ot,{y:pt.y,s:pt.s,color:G[pt.y][pt.s],isLine:!1})}}let xe=ps(U,zt-1),je=ps(I,nn),Ae=Math.round(F*xe*je),Bt=0;zt>1&&(lt.combos++,lt.maxCombo=Math.max(lt.maxCombo,zt),setTimeout(()=>ee(`COMBO \xD7${zt}`,"combo"),Bt),Bt+=180,A.play("combo2")),nn>0&&(lt.cascades++,lt.maxCascade=Math.max(lt.maxCascade,nn),setTimeout(()=>ee(`CASCADE \xD7${nn}`,"cascade"),Bt),Bt+=180,A.play("cascade")),(t.length>0||o.length>0)&&A.play("combo");for(let dt of t){let pt=dt.length,Ot=pt*Ce;setTimeout(()=>ee(`Line-${pt} +${Ot}`,"line",dt.color),Bt),Bt+=100}for(let dt of o){let pt=dt.cells.length>0?G[dt.cells[0].y][dt.cells[0].s]:null;setTimeout(()=>ee(`Pair +${Pe}`,"pair",pt),Bt),Bt+=100}Ae>0&&(setTimeout(()=>ee(`+${Ae}`,"score"),Bt),Bt+=120),tt>0&&(setTimeout(()=>ee(`+${tt}s`,"time"),Bt),Bt+=120);for(let[dt,pt]of Object.entries(ut))pt>0&&(setTimeout(()=>ee(`+${pt}${Mn(dt)}`,"charge"),Bt),Bt+=120);en=Array.from(a.values()),Hn=performance.now(),qe=!0,fn=!1,Oe=v,ze=Ae,wn()}function gi(){for(let t of en)G[t.y][t.s]=0;if(en.length>0&&A.playRandom("disappear"),Oe>0){Rt+=Oe;let t=Oe/f();Ln.spawnBonusBubbles(t)}yt.addScore(ze),Pt+=ze,Fn(),en=[],qe=!1,fn=!1,Oe=0,ze=0,nn++,Qn()}function Qn(){di();let{lineMatches:t,pairMatches:o}=xi();if(t.length>0||o.length>0)Us(t,o);else{let a=qs();a.length>0?Ei(a):!S&&At==="playing"&&Ks()}}function nr(t,o){Us(t,o)}function Zn(t){return Rn(t,i)}function Jn(){return Zn(Math.round(Dt))}function Xs(t,o){return ks(S,t,o,G,s,i)}function ts(t){return Xs(t,Jn())}let es=Fo;function Ys(){Vt&&(se!==0&&Nt>=se||(bt=0,Nt+=1))}function mi(){if(!S)return;let t=S.cells,o=S.colors,a={cells:t,colors:o};if(nt>=0||(a=es(a.cells,a.colors),a=es(a.cells,a.colors)),a=es(a.cells,a.colors),S.cells=a.cells,S.colors=a.colors,!ts(Math.floor(Tt))){S.cells=t,S.colors=o;return}A.play("turn"),w&&Ys()}function pi(){return Uo(S,Tt,Jn(),G,s,i)}function hi(){if(!S)return!1;let t=Math.floor(Tt)-1,o=!ts(t);return o&&!w?(w=!0,bt=0,Nt=0):!o&&w&&(w=!1,bt=0,Nt=0),o}let vn=ds;function $n(){if(At==="playing"){cn.classList.add("hidden"),ae.classList.remove("hidden");return}if(cn.classList.remove("hidden"),ae.classList.add("hidden"),At==="intro"){K.classList.remove("hidden"),N.classList.add("hidden");let t=b.loadHighscore(Et);t.score>0?(ot.textContent=t.score.toLocaleString(),vt.textContent=vn(t.time)):(ot.textContent="0",vt.textContent="0:00"),Bs(),Me.textContent=`v${bn}`,E.classList.remove("idlePulse"),E.offsetWidth,E.classList.add("idlePulse")}else{K.classList.add("hidden"),N.classList.remove("hidden"),q.textContent=Pt.toLocaleString(),Y.textContent=vn(Fe);let t=b.loadHighscore(Et);Pt>0&&Pt>=t.score?ct.classList.remove("hidden"):ct.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${lt.rings}</span>
          <span class="count ring-max">${lt.maxRing>0?"max \xD7"+lt.maxRing:""}</span>
        </div>
      `;H.innerHTML=o;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${lt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${lt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${lt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${lt.pairs}</span>
        </div>
      `;B.innerHTML=a;let v=Re()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${lt.magicUsed}</span>
        </div>
      `:"",F=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${lt.combos}</span>
          <span class="count max-combo">${lt.maxCombo>0?"max \xD7"+lt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${lt.cascades}</span>
          <span class="count max-cascade">${lt.maxCascade>0?"max \xD7"+lt.maxCascade:""}</span>
        </div>
        ${v}
      `;X.innerHTML=F}}function Fn(){Mt.textContent=`Score: ${Pt}`}function hs(){_t.textContent=`Time: ${vn(Fe)}`}function Vs(){let t=Math.max(0,(s-Jt)/f()),o=Math.floor(t/60),a=Math.floor(t%60);Ht.textContent=`Left: ${o}:${a.toString().padStart(2,"0")}`,t<30?Ht.classList.add("warning"):Ht.classList.remove("warning")}function yi(){g(Et),L(),Jt=0,Rt=0,Dt=$e=0,Gt=0,yt.start(),lt=yt.stats,Pt=0,on=performance.now(),Fe=0,pn=0,rn=0,At="playing",Ge=null,Re()?st.reset():(st.deactivate(),Object.keys(st.charges).forEach(t=>{st.charges[t]=0}),wn()),ie.reset(),qn(),en=[],Bn=[],qe=!1,fn=!1,_n=!1,Oe=0,ze=0,nn=0,tn.reset(),wn(),Fn(),hs(),Vs(),ms(),Ks(),Ln.drawNextPreview(Se,Ge),$n(),A.getSettings().musicEnabled&&A.startGameMusic()}function ys(){yt.gameOver(),At="gameover",S=null,w=!1,bt=0,Nt=0;let t=b.saveHighscore(Pt,Fe,Et);A.stopMusic(),A.play("gameover"),hs(),$n(),t&&Pt>0&&setTimeout(()=>{ee("\u{1F3C6} NEW RECORD!","score")},500)}function Si(t){for(let a=0;a<50;a++){let v=t.map(()=>1+(Math.random()*4|0));if(!vi(t,v))return v}return t.map((a,v)=>1+v%4)}let vi=Vo;function Ws(t){let o=t.cells.map(v=>({x:v.x,y:v.y})),a=Si(o);return{name:t.name,cells:o,colors:a}}function Ks(){if(!Ge){let F=M[Math.random()*M.length|0];Ge=Ws(F)}S=Ge;let t=M[Math.random()*M.length|0];Ge=Ws(t),Ln.drawNextPreview(Se,Ge);let o=1/0,a=-1/0;for(let F of S.cells)F.x<o&&(o=F.x),F.x>a&&(a=F.x);let v=(o+a)/2;for(let F of S.cells)F.x=F.x-Math.round(v);Tt=s+3,C=0,w=!1,bt=0,Nt=0,ts(Math.floor(Tt))?A.playRandom("appear"):ys()}function qs(){return Yo(G,s,i)}function Ei(t){if(t.length===0)return;let o=[];for(let zt of t)for(let xe=0;xe<i;xe++)o.push({y:zt,s:xe,color:G[zt][xe],isLine:!1});Bn=t,en=o,Hn=performance.now(),qe=!0,_n=!0,fn=!1;let a=t.length;lt.rings+=a,lt.maxRing=Math.max(lt.maxRing,a);let v=ps(J,a-1),F=Math.round(Ve*a*v),tt=An*a;ze=F,Oe=tt*f(),A.play("ring");let ut=`RING \xD7${a}`;ee(ut,"ring"),setTimeout(()=>ee(`+${F}`,"score"),150),setTimeout(()=>ee(`+${tt}s`,"time"),300)}function bi(){let t=[...Bn].sort((o,a)=>a-o);for(let o of t){for(let a=o;a<s-1;a++)G[a].set(G[a+1]);G[s-1].fill(0)}if(Oe>0){Rt+=Oe;let o=Oe/f();Ln.spawnBonusBubbles(o)}yt.addScore(ze),Pt+=ze,Fn(),Et==="30_24"&&Bn.length>0&&(te=b.addHighTowerRings(Bn.length)),en=[],Bn=[],qe=!1,_n=!1,Oe=0,ze=0,Qn()}function sr(){return qs().length}function Mi(){if(!S)return;let t=Jn();Dt=t,$e=t,Gt=0;let o=!1;for(let a=0;a<S.cells.length;a++){let v=S.cells[a],F=S.colors[a],tt=Math.floor(Tt)+v.y,ut=Zn(t+v.x);tt>=s&&(o=!0),tt>=0&&tt<s&&(G[tt][ut]=F)}if(o){ys();return}yt.addScore(Ct),Pt+=Ct,Fn(),ee(`+${Ct}`,"score"),A.playRandom("drop"),S=null,nn=0,fi()}function xi(){return Xo(G,s,i)}function Ci(){if(!S)return!1;let t=Math.floor(Tt)-1;return ts(t)?(Tt=t,w=!1,bt=0,Nt=0,!0):(w=!0,!1)}n.addEventListener("pointerdown",t=>{if(It.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),a=t.clientX-o.left,v=t.clientY-o.top;ye.handlePointerDown(t,{onMagicTap:Re()?()=>tn.handleTap(a,v)?!0:It.applyCommand("magic_shoot",{x:a,y:v}):null,onDoubleTap:()=>It.applyCommand("rotate_piece")},$e)||(Gt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(It.state!=="playing"||!ye.dragging)return;t.preventDefault?.();let o=ye.handlePointerMove(t,{canRotateTo:(a,v)=>It.canRotateTo(a,v),onDrop:()=>It.applyCommand("move_down"),onGroundedMove:()=>It.onGroundedMove(),onRotateStep:()=>gt.trigger("tower_rotate")},It.pieceY,It.isGrounded);o&&It.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{It.state==="playing"&&ye.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{ye.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ye.dragging&&ye.handlePointerUp(t)},{passive:!1}),$.addEventListener("click",()=>{It.state==="playing"&&It.applyCommand("rotate_piece")});let ns=e.dropBtn,ss=null;function Ti(){It.state==="playing"&&(It.applyCommand("move_down"),ss=setInterval(()=>{if(It.state!=="playing"){os();return}It.applyCommand("move_down")},Ft))}function os(){ss&&(clearInterval(ss),ss=null)}ns.addEventListener("pointerdown",t=>{t.preventDefault(),Ti()}),ns.addEventListener("pointerup",os),ns.addEventListener("pointerleave",os),ns.addEventListener("pointercancel",os);for(let[t,o]of Object.entries(dn))o.addEventListener("click",()=>{It.state==="playing"&&Re()&&It.applyCommand("select_magic",{element:t})});kt&&kt.addEventListener("click",()=>{if(It.state!=="playing"||!Kn()||!Re())return;let t=st.active??xn;if(!t)return;let o=fs[t];!o||!Xn(o)||(ie.selectSpell(o),st.active&&(xn=st.active,Yn=!0,st.deactivate()),tn.handleSpellButtonClick())});let Ss=e.soundsToggle,vs=e.musicToggle;function gn(){let t=A.getSettings();t.soundsEnabled?Ss.classList.add("active"):Ss.classList.remove("active"),t.musicEnabled?vs.classList.add("active"):vs.classList.remove("active");for(let o=0;o<=4;o++){let a=e.soundVolBtns[o],v=e.musicVolBtns[o];a&&a.classList.toggle("active",t.soundVolume===o),v&&v.classList.toggle("active",t.musicVolume===o)}}let zs=e.tabBtns,_i=e.tabContents;zs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;zs.forEach(a=>a.classList.remove("active")),_i.forEach(a=>a.classList.remove("active")),t.classList.add("active"),_o(o).classList.add("active"),o==="sounds"&&gn()})});let js=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Qs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Bi=e.iosHint,Li=e.standaloneBadge;function Zs(){let t=document.fullscreenElement||document.webkitFullscreenElement;x.textContent=t?"Disable":"Enable"}js&&(Qs?(Li.style.display="block",x.style.display="none"):(Bi.style.display="block",x.textContent="Not supported",x.style.opacity="0.5",x.style.cursor="default")),x.addEventListener("click",()=>{if(js&&!Qs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Zs),document.addEventListener("webkitfullscreenchange",Zs);let is=e.invertSwipeToggle,sn=e.hapticsToggle;T.invertSwipe&&is.classList.add("active"),sn&&(gt.supports()?T.hapticsEnabled&&sn.classList.add("active"):(sn.classList.add("disabled"),sn.classList.remove("active"),T.hapticsEnabled=!1,gt.setEnabled(!1),b.saveGameSettings(T))),is.addEventListener("click",()=>{is.classList.toggle("active");let t=is.classList.contains("active");ye.rotDir=t?-1:1,T.invertSwipe=t,b.saveGameSettings(T)}),sn&&sn.addEventListener("click",()=>{if(sn.classList.contains("disabled"))return;sn.classList.toggle("active");let t=sn.classList.contains("active");T.hapticsEnabled=t,b.saveGameSettings(T),gt.setEnabled(t)}),Ss.addEventListener("click",()=>{let o=!A.getSettings().soundsEnabled;A.updateSettings({soundsEnabled:o}),gn(),Gn()}),vs.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),gn(),Gn(),At!=="paused"&&(o?At==="playing"?A.startGameMusic():A.startMenuMusic():A.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({soundVolume:t}),gn(),A.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({musicVolume:t}),gn()})}gn();function Js(){At==="playing"&&(yt.pause(),rn=performance.now(),At="paused",A.musicAudio&&A.musicAudio.pause())}function rs(){At==="paused"&&(yt.resume(),pn+=performance.now()-rn,rn=0,At="playing",Ms=performance.now(),A.getSettings().musicEnabled&&A.startGameMusic())}function Gn(){let t=A.getSettings();Te.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Te.classList.toggle("off",!t.soundsEnabled),Ee.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Ee.classList.toggle("off",!t.musicEnabled)}function Ri(){le.classList.remove("hidden"),ae.classList.add("hidden");let t=b.loadHighscore(Et);if(Qe.textContent=t.score?t.score.toLocaleString():"0",hn.textContent=t.time?ds(t.time):"0:00",Ze.textContent=Et==="30_24"?"High Tower":"Quick Tower",Xt.textContent=Pt.toLocaleString(),ln.textContent=ds(Fe),_e.textContent=Et==="30_24"?"High Tower":"Quick Tower",Gn(),oo){let o=Et==="30_24";oo.style.display=o?"":"none",o&&Bs()}}function Nn(){le.classList.add("hidden"),ae.classList.remove("hidden")}ae.addEventListener("click",()=>{Js(),Ri()}),We.addEventListener("click",()=>{Nn(),rs()});let Es=null;function to(t,o){un.textContent=t,Es=o,be.classList.remove("hidden")}function eo(){be.classList.add("hidden"),Es=null}ne.addEventListener("click",()=>{eo()}),yn.addEventListener("click",()=>{let t=Es;eo(),t&&t()}),de.addEventListener("click",()=>{to("Restart game?",()=>{Nn(),It.applyCommand("start_game")})}),oe.addEventListener("click",()=>{to("Exit to menu?",()=>{Nn(),ae.classList.add("hidden"),At="intro",yt.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),$n()})}),Ne.addEventListener("click",()=>{qt.classList.remove("hidden")}),Te.addEventListener("click",()=>{let t=A.getSettings();A.updateSettings({soundsEnabled:!t.soundsEnabled}),Gn(),gn()}),Ee.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),Gn(),gn()}),le.addEventListener("click",t=>{t.target===le&&(Nn(),rs())}),document.addEventListener("keydown",t=>{At==="paused"&&!le.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Nn(),rs())}),Be.addEventListener("click",()=>{qt.classList.add("hidden")}),qt.addEventListener("click",t=>{t.target===qt&&qt.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?At==="playing"&&(Js(),bs=!0):bs&&At==="paused"&&(rs(),bs=!1)});let It=Wo({getN:()=>i,getH:()=>s,FALL_INTERVAL:xt,LOCK_DELAY_SEC:$t,getKillRate:f,MATCH_HIGHLIGHT_SEC:En,MAGIC_SHRINK_SEC:Z,RING_HIGHLIGHT_SEC:ce,getState:()=>({gameState:At,score:Pt,elapsedMs:Fe,startTime:on,totalPausedMs:pn,stats:lt,activePiece:S,pieceY:Tt,targetRot:$e,rotFloat:Dt,rotVel:Gt,isGrounded:w,isHighlighting:qe,isMagicAnimation:fn,isRingAnimation:_n,highlightStartTime:Hn,killLevel:Jt,grid:G,fallTimer:C,lockTimer:bt}),setState:t=>{"elapsedMs"in t&&(Fe=t.elapsedMs),"killLevel"in t&&(Jt=t.killLevel),"fallTimer"in t&&(C=t.fallTimer),"lockTimer"in t&&(bt=t.lockTimer),"targetRot"in t&&($e=t.targetRot),"rotFloat"in t&&(Dt=t.rotFloat),"rotVel"in t&&(Gt=t.rotVel)},funcs:{startGame:yi,endGame:ys,rotatePieceByDir:mi,tryMoveDown:Ci,canPlaceAtRot:Xs,maybeResetLockDelay:Ys,shootMagic:ci,selectMagic:qo,updateGroundedState:hi,lockPiece:Mi,finishHighlight:gi,finishRingHighlight:bi},ui:{updateTimeHud:hs,updateRemainingHud:Vs}}),Ln=Ko({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:D,MAX_RADIUS_X:k,RADIUS_X_FACTOR:W,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:En,MATCH_SHRINK_PHASE:ht,MAGIC_SHRINK_SEC:Z,RING_HIGHLIGHT_SEC:ce,LOCK_DELAY_SEC:$t,getKillRate:f,ELEMENT_COLORS:ue,ELEMENT_TO_COLOR:P,BLOCK_COLOR_FRONT:et,BLOCK_COLOR_BACK:at,ACTIVE_COLOR_FRONT:jt,GHOST_COLOR_FILL:z,GHOST_COLOR_STROKE:V,GHOST_STROKE_WIDTH:mt,MAGIC_DIM_DOT_ALPHA:Wt,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:mn,getState:()=>({gameState:At,grid:G,activePiece:S,pieceY:Tt,rotFloat:Dt,killLevel:Jt,isHighlighting:qe,highlightedCells:en,highlightStartTime:Hn,isMagicAnimation:fn,isRingAnimation:_n,isGrounded:w,lockTimer:bt,spellState:tn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Ut,waterColor:wt}),funcs:{snappedRot:Jn,computeGhostY:pi,normSector:Zn,getMagicTargetColor:()=>Re()&&st.canUse()?P[st.active]:null,getTransmuteAnimState:t=>tn.getTransmuteAnimState(t),getLightningAnimState:t=>tn.getLightningAnimState(t),getFireAnimState:t=>tn.getFireAnimState(t)}}),Ms=performance.now();function no(t){let o=Math.min(.05,Math.max(.001,(t-Ms)/1e3));if(Ms=t,It.update(o,t),tn.update(t),Rt>0){let a=Math.min(Rt,He*o);Jt=Math.max(0,Jt-a),Rt-=a}Dt=$e,Dt>1e6&&(Dt%=i),Dt<-1e6&&(Dt%=i),Ln.render(o,t),requestAnimationFrame(no)}E.addEventListener("click",()=>{It.applyCommand("start_game")}),ft.addEventListener("click",()=>{It.applyCommand("start_game")}),St.addEventListener("click",()=>{At="intro",yt.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),$n()}),Ue.forEach(t=>{t.addEventListener("click",o=>{Ue.forEach(v=>v.classList.remove("active")),t.classList.add("active"),Et=t.dataset.mode,qn(),Wn();let a=b.loadHighscore(Et);a.score>0?(ot.textContent=a.score.toLocaleString(),vt.textContent=vn(a.time)):(ot.textContent="0",vt.textContent="0:00"),E.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>E.classList.add("idlePulse"),2e3)})});let xs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),Ai=document.getElementById("spellProgressFill"),so=document.getElementById("spellProgressMarkers"),oo=document.getElementById("pauseSpellProgress"),Ii=document.getElementById("pauseSpellProgressFill"),io=document.getElementById("pauseSpellProgressMarkers"),ro=document.getElementById("pauseSpellProgressLabel");function Ts(){return jo.map(t=>Pn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function wi(t){let o=Ts(),a=_s(o);return a<=0?"":`${Math.min(t,a)}/${a}`}function co(t){if(!t)return;t.innerHTML="";let o=Ts(),a=_s(o);o.forEach(v=>{let F=document.createElement("span");F.className="marker",F.dataset.threshold=v;let tt=a>0?v/a*100:0;F.style.left=`${tt}%`,t.appendChild(F)})}function ao(t,o){if(!t)return;let a=Pi(o);t.style.width=`${a}%`}function lo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(v=>{let F=parseInt(v.dataset.threshold,10)||0;v.classList.toggle("reached",o>=F)})}function Pi(t){let o=Ts(),a=_s(o);return t<=0||a<=0?0:t>=a?100:t/a*100}function uo(t){if(!Cs)return;let o=Pn(t),a=ie.getDescription(t);o===0||te>=o?Cs.innerHTML=a:Cs.innerHTML=`${a} <span class="spell-progress-text">${te}/${o}</span>`}function Bs(){te=b.loadHighTowerRings(),xs.forEach(o=>{let a=o.dataset.spell,v=Pn(a),F=te>=v;o.classList.toggle("locked",!F);let tt=o.querySelector(".spell-lock");tt&&(tt.style.display=F?"none":"")}),ao(Ai,te),ao(Ii,te),lo(so,te),lo(io,te),ro&&(ro.textContent=wi(te));let t=document.querySelector(".spell-select-btn.active");t&&uo(t.dataset.spell)}co(so),co(io),Bs(),xs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){Ue.forEach(zt=>zt.classList.remove("active")),a.classList.add("active"),Et="30_24",qn(),Wn();let ut=b.loadHighscore(Et);ut.score>0?(ot.textContent=ut.score.toLocaleString(),vt.textContent=vn(ut.time)):(ot.textContent="0",vt.textContent="0:00")}let v=t.dataset.spell,F=Pn(v),tt=te>=F;uo(v),tt&&(xs.forEach(ut=>ut.classList.remove("active")),t.classList.add("active"),ie.selectSpell(v),kn(st.active))})}),Sn.addEventListener("click",()=>{let t=b.loadHighscore("30_24"),o=b.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${vn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${vn(o.time)}
`:`  No record yet
`,alert(a)}),fe.addEventListener("click",()=>{qt.classList.remove("hidden")}),wn(),Wn(),qn(),$n(),A.startMenuMusic();let ki=()=>{if(A.unlock(),!A.getSettings().musicEnabled)return;let t=A.musicAudio;!t||t.paused||t.ended?It.state==="playing"?A.startGameMusic():A.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},fo=0,Oi=10,Di=()=>{fo>=Oi||(fo++,ki())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Di,{passive:!0})}),requestAnimationFrame(no)})();})();
