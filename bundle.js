(()=>{var Yi=[0,.25,.5,.75,1],Wi=[0,.05,.15,.25,.5],Vi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Eo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},bo="soundSettings";function Ki(){try{let e=localStorage.getItem(bo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function qi(e){try{localStorage.setItem(bo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Mo(){return{audioContext:null,buffers:{},settings:Ki(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Yi[this.settings.soundVolume]},getMusicVolume(){return Wi[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(d){console.debug(`Failed to load sound: ${n} from ${r}`,d)}},preload(){this.initContext();for(let[n,r]of Object.entries(Vi))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;r!==null&&(d=`${n}${r}`);let i=this.buffers[d];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},qi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var xo="eb_highscore",Co="eb_highscore_quick",To="eb_settings",_o="eb_high_tower_rings",zi={invertSwipe:!1,hapticsEnabled:!0};function Lo(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Co:xo,r=localStorage.getItem(n);if(r)return JSON.parse(r)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,r="30_24"){try{let d=this.loadHighscore(r);if(e>d.score||e===d.score&&n>d.time){let i=r==="25_20"?Co:xo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(To);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...zi}},saveGameSettings(e){try{localStorage.setItem(To,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(_o);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(_o,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let r=this.loadHighTowerRings()+e;return this.saveHighTowerRings(r),r}}}function Bo(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Ro(e){return document.getElementById("tab-"+e)}var ji={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ao(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(d,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=d,s&&n[s]&&(c.style.color=n[s]);let f=window.innerWidth/2,m=window.innerHeight/2-40,g=(Math.random()-.5)*200,a=(Math.random()-.5)*100+r*36;c.style.left=`${f+g}px`,c.style.top=`${m+a}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(d){return ji[d]||"\u2726"}}}var Is={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function wo(){return{spawnMagicOrb(e,n,r,d){if(!d)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Is[e]||"\u2726";let s=d.getBoundingClientRect(),c=s.left+s.width/2-n,f=s.top+s.height/2-r,m=Math.hypot(c,f),g=Math.atan2(f,c),a=m*.35*(Math.random()>.5?1:-1),p=g+Math.PI/2,E=c*.5+Math.cos(p)*a,A=f*.5+Math.sin(p)*a;i.style.setProperty("--mid-x",`${E}px`),i.style.setProperty("--mid-y",`${A}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${f}px`),i.style.left=`${n}px`,i.style.top=`${r}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,r,d,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,f=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Is[e]||"\u2726";let g=r-c,a=d-f;m.style.setProperty("--end-x",`${g}px`),m.style.setProperty("--end-y",`${a}px`),m.style.left=`${c}px`,m.style.top=`${f}px`,document.body.appendChild(m);let p=setInterval(()=>{let E=m.getBoundingClientRect();this.spawnTrailParticle(e,E.left+E.width/2,E.top+E.height/2)},40);setTimeout(()=>{clearInterval(p),m.remove(),this.spawnExplosion(e,r,d),i&&i()},300)},spawnTrailParticle(e,n,r){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${n}px`,d.style.top=`${r}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,n,r){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,f=40+Math.random()*40,m=Math.cos(c)*f,g=Math.sin(c)*f;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${r}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",r=18){if(!e)return;let d=n;typeof n=="number"&&(r=n,d="water"),Is[d]||(d="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,f=Math.max(8,Math.round(r));for(let m=0;m<f;m++){let g=document.createElement("div");g.className=`spell-bubble ${d}`,g.textContent="\u25CF";let a=m/f*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,E=Math.cos(a)*p,A=Math.sin(a)*p-20;g.style.setProperty("--px",`${E}px`),g.style.setProperty("--py",`${A}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,r){if(!r)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let i=r.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,f=Math.hypot(s,c),m=Math.atan2(c,s),g=f*.35*(Math.random()>.5?1:-1),a=m+Math.PI/2,p=s*.5+Math.cos(a)*g,E=c*.5+Math.sin(a)*g;d.style.setProperty("--mid-x",`${p}px`),d.style.setProperty("--mid-y",`${E}px`),d.style.setProperty("--end-x",`${s}px`),d.style.setProperty("--end-y",`${c}px`),d.style.left=`${e}px`,d.style.top=`${n}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}var Qi=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Io=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Zi=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function Ji(e){let n=e.querySelector(".ring"),r=e.querySelector(".falling-figure"),d=e.querySelector(".clock");if(!n||!r||!d)return()=>{};let i=!1,s=[],c=[],f=(W,V)=>{let ut=setTimeout(()=>{i||W()},V);return s.push(ut),ut},m=(W,V)=>{let ut=setInterval(()=>{if(i){clearInterval(ut);return}W()},V);return c.push(ut),ut},g=48,a=.9,p=9,E=9,A=3,j=2,q=18,ct=-12,wt=.5,ve=12,rt=10,$=["--fire","--water","--light","--earth"],bt=["--light","--fire","--water"],ne=3,Ot=Math.floor(p/2)-1,qt=8e3,Rt=[];function It(W,V){let ut=(V-1)/2,zt=Math.abs(W-ut)/ut;return 1-(1-wt)*zt}function _(W,V,ut,zt){let Ae=(V-1)/2,Q=Math.abs(W-Ae)/Ae;return zt?Q*ut:-Q*ut}function Pt(){n.innerHTML="";let W=[],V=[];for(let ot=0;ot<E;ot++)V.push(g*a*It(ot,E));let ut=V.reduce((ot,Lt)=>ot+Lt,0)+(E-1)*j,zt=[];for(let ot=0;ot<p;ot++)zt.push(g*It(ot,p));let Ae=zt.reduce((ot,Lt)=>ot+Lt,0)+(p-1)*A,Q=-ut/2;for(let ot=0;ot<E;ot++){let Lt=V[ot],Ht=g*a,se=p+ot,Bt=_(ot,E,rt,!0),Zt=document.createElement("div");Zt.className="block back",Zt.style.cssText=`left:${Q.toFixed(1)}px;top:${(ct-Ht/2+Bt).toFixed(1)}px;width:${Lt.toFixed(1)}px;height:${Ht.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let F=document.createElement("div");F.className="dot";let oe=a*It(ot,E);F.style.cssText=`--c:var(${$[se%4]});transform:scale(${oe.toFixed(2)});`,Zt.appendChild(F),Zt.dataset.index=se,n.appendChild(Zt),W[se]=Zt,Q+=Lt+j}let tt=-Ae/2;for(let ot=0;ot<p;ot++){let Lt=zt[ot],Ht=g,se=ot,Bt=_(ot,p,ve,!1),Zt=se>=Ot&&se<Ot+ne,F=document.createElement("div");F.className="block",Zt&&F.classList.add("gap"),F.style.cssText=`left:${tt.toFixed(1)}px;top:${(q-Ht/2+Bt).toFixed(1)}px;width:${Lt.toFixed(1)}px;height:${Ht.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let oe=document.createElement("div");oe.className="dot";let Le=It(ot,p);oe.style.cssText=`--c:var(${$[se%4]});transform:scale(${Le.toFixed(2)});`,F.appendChild(oe),F.dataset.index=se,n.appendChild(F),W[se]=F,tt+=Lt+A}Rt=W}function _t(){let W=[];for(let V=Ot-1;V>=0;V--)W.push(V);for(let V=0;V<E;V++)W.push(p+V);for(let V=p-1;V>=Ot;V--)W.push(V);return W}function Ct(){Rt.forEach((W,V)=>{W&&(W.classList.remove("hi","vanish","gap"),W.style.opacity="",W.style.transform="",V>=Ot&&V<Ot+ne&&W.classList.add("gap"))})}function l(){for(let W=0;W<ne;W++){let V=Rt[Ot+W];if(V){V.classList.remove("gap");let ut=V.querySelector(".dot");if(ut){let zt=It(Ot+W,p);ut.style.cssText=`--c:var(${bt[W]});transform:scale(${zt.toFixed(2)});`}}}}function lt(W){let V=_t(),ut=0,zt=V.length,Ae=m(()=>{if(ut>0&&ut<=zt){let Q=Rt[V[ut-1]];Q&&Q.classList.remove("hi")}if(ut<zt){let Q=Rt[V[ut]];Q&&Q.classList.add("hi"),ut++}else clearInterval(Ae),Rt.forEach(Q=>{Q&&Q.classList.add("hi")}),f(W,300)},30)}function J(W){let V=_t(),ut=V.length;V.forEach((zt,Ae)=>{let Q=Rt[zt];Q&&f(()=>{Q.classList.add("vanish")},Ae*40)}),f(W,ut*40+500)}function le(){i||(Ct(),r.classList.add("active"),f(()=>{l(),r.classList.remove("active"),r.style.opacity="0",f(()=>{lt(()=>{i||(d.classList.add("show"),f(()=>{J(()=>{i||(d.classList.remove("show"),r.style.opacity="",f(le,500))})},400))})},200)},qt*.38))}return Pt(),le(),()=>{i=!0,s.forEach(clearTimeout),c.forEach(clearInterval)}}var tc=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:Qi},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Io},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:Zi,onEnter:e=>Ji(e)}];function Po(e={}){let{helpBtn:n,mount:r=document.body,combosTemplate:d}=e;if(!n||!r)return{open(){},close(){},setCombosTemplate(){}};let i=tc.map(_=>({..._}));typeof d=="string"&&d.trim()&&(i[1].illustrationHtml=d);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,r.appendChild(s);let c=s.querySelector(".help-next-btn"),f=s.querySelector(".help-slide-title"),m=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),a=s.querySelector(".help-dots"),p=i.map(()=>{let _=document.createElement("span");return _.className="help-dot",a.appendChild(_),_}),E=0,A=!1,j=null,q=null,ct=180,wt=560,ve=460,rt=480,$=_=>{q&&(q(),q=null);let Pt=i[_];Pt&&(E=_,f.textContent=Pt.title,m.textContent=Pt.text,g.innerHTML=Pt.illustrationHtml||"",p.forEach((_t,Ct)=>{_t.classList.toggle("active",Ct===_)}),c.textContent=_===i.length-1?"Done":"Next",bt(),Pt.onEnter&&(q=Pt.onEnter(g)))},bt=()=>{if(!A||s.classList.contains("hidden"))return;let _=g.getBoundingClientRect();if(!_.width||!_.height)return;let Pt=g.querySelector(".help-combos");if(Pt){let l=Math.min(1,Math.min(_.width,_.height)/wt);Pt.style.setProperty("--help-combos-scale",l.toFixed(3))}let _t=g.querySelector(".help-controls");if(_t){let l=Math.min(1,Math.min(_.width,_.height)/ve);_t.style.setProperty("--help-controls-scale",l.toFixed(3))}let Ct=g.querySelector(".help-rings");if(Ct){let l=Math.min(1,Math.min(_.width,_.height)/rt);Ct.style.setProperty("--help-rings-scale",l.toFixed(3))}},ne=()=>{A&&bt()},Ot=_=>{A&&_.stopPropagation()},qt=_=>{if(A){if(_.key==="Escape"){_.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation?.(),It();return}_.preventDefault(),_.stopPropagation(),_.stopImmediatePropagation?.()}},Rt=()=>{A||(A=!0,j&&(clearTimeout(j),j=null),$(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),bt()}),document.addEventListener("keydown",qt,!0),window.addEventListener("resize",ne))},It=()=>{A&&(A=!1,q&&(q(),q=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",qt,!0),window.removeEventListener("resize",ne),j=window.setTimeout(()=>{s.classList.add("hidden")},ct))};return s.addEventListener("click",_=>{A&&(_.target===s&&It(),_.stopPropagation())}),s.addEventListener("pointerdown",Ot),s.addEventListener("pointerup",Ot),s.addEventListener("touchstart",Ot,{passive:!0}),s.addEventListener("touchmove",_=>{A&&(_.preventDefault(),_.stopPropagation())},{passive:!1}),s.addEventListener("wheel",_=>{A&&(_.preventDefault(),_.stopPropagation())},{passive:!1}),c.addEventListener("click",_=>{_.stopPropagation(),E<i.length-1?$(E+1):It()}),n.addEventListener("click",_=>{_.preventDefault(),Rt()}),{open:Rt,close:It,setCombosTemplate(_){typeof _=="string"&&(i[1].illustrationHtml=_.trim()||Io,A&&E===1&&$(1))}}}var ec={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function nc(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Ps=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let r=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return r?(navigator.vibrate(r),!0):!1}},ks=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function ko({enabled:e=!0,patterns:n=ec}={}){let r=nc(),d=r?new ks(r):new Ps,i=d.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let f=n[c];return f?d.trigger({name:c,...f}):!1}}}function Oo(e={}){let{buttons:n={},onActivate:r=null,onChange:d=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[m,g]of Object.entries(n)){if(!g)continue;let a=i[m],p=g.querySelector(".charges");p&&(p.textContent=a),g.classList.toggle("empty",a<=0),g.classList.toggle("active",s===m&&a>0)}d&&d({...i},s)}function f(m){let g=n[m];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(m){s=m},select(m){if(i[m]<=0)return!1;let g=s===m;return s=g?null:m,c(),!g&&s===m&&r&&r(),!g},useCharge(){if(!s||i[s]<=0)return!1;let m=s;return i[m]--,s=null,c(),f(m),!0},addCharges(m,g){i[m]!==void 0&&(i[m]+=g,c(),f(m))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(m){for(let[g,a]of Object.entries(n))a&&a.addEventListener("click",()=>{m&&m(g)})}}}var Je={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function Do(e={}){let{button:n=null,onActivate:r=null,onProgress:d=null,onReady:i=null}=e,s="ice",c=0;function f(){return Je[s]||Je.ice}function m({silent:a=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=f(),E=Number.isFinite(p.maxProgress)?p.maxProgress:0,A=E>0?Math.min(c/E,1)*100:0,j=E>0&&c>=E;n.style.setProperty("--progress",`${A}%`);let q=n.querySelector(".spell-icon");q&&(q.textContent=p.icon);let ct=n.querySelector(".spell-counter");ct&&(ct.textContent=E>0?`${Math.min(c,E)}/${E}`:""),n.classList.toggle("ready",j),n.classList.toggle("charging",!j&&c>0),d&&!a&&E>0&&d(c,E)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return f().maxProgress??0},get isReady(){let a=f().maxProgress;return Number.isFinite(a)&&a>0&&c>=a},get effect(){return f().effect},getUnlockRings(a){return(Je[a]||Je.ice).unlockRings??0},getCost(a){return(Je[a]||Je.ice).cost??0},getDescription(a){return(Je[a]||Je.ice).description||""},getEffect(a){return(Je[a]||Je.ice).effect},get button(){return n},selectSpell(a){Je[a]&&(s=a,c=0,m())},addProgress(a=1){let p=f();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||c>=p.maxProgress)return!1;let E=c<p.maxProgress;return c=Math.min(c+a,p.maxProgress),m(),g(),E&&c>=p.maxProgress&&i&&i(),!0},setProgress(a,{silent:p=!1}={}){c=Math.max(0,a),m({silent:p})},canUse(){let a=f().maxProgress;return Number.isFinite(a)&&a>0&&c>=a},use(){if(!this.canUse())return null;let a=f().effect;return c=0,m(),g(),r&&r(s),a},reset(){c=0,m()},pulse(){g()},updateButton:m,initButton(a){n&&n.addEventListener("click",()=>{a&&a()})}}}function Os({centerY:e,centerS:n,size:r,H:d,normSector:i}){let s=[],c=Math.floor(r/2);for(let f=-c;f<=c;f++)for(let m=-c;m<=c;m++){let g=e+f,a=i(n+m);if(g<0||g>=d)continue;let p=f*f+m*m;s.push({y:g,s:a,distSq:p})}return s}function fs(e,n,r){return n.filter(d=>e[d.y][d.s]===r)}function gs(e,n){return[...e].sort((d,i)=>d.distSq!==i.distSq?d.distSq-i.distSq:d.y!==i.y?d.y-i.y:d.s-i.s).slice(0,n).map(d=>({y:d.y,s:d.s}))}function Ho({centerY:e,centerS:n,beamLength:r,N:d,H:i,normSector:s}){if(e<0||e>=i||r<0||d<=0)return[];let c=[],f=new Set,m=(a,p)=>`${a},${p}`,g=s(n);c.push({y:e,s:g,dist:0}),f.add(m(e,g));for(let a=1;a<=r;a++){let p=s(n+a),E=m(e,p);f.has(E)||(c.push({y:e,s:p,dist:a}),f.add(E));let A=s(n-a),j=m(e,A);f.has(j)||(c.push({y:e,s:A,dist:a}),f.add(j))}for(let a=1;a<=r;a++){let p=s(n),E=e+a;if(E<i){let j=m(E,p);f.has(j)||(c.push({y:E,s:p,dist:a}),f.add(j))}let A=e-a;if(A>=0){let j=m(A,p);f.has(j)||(c.push({y:A,s:p,dist:a}),f.add(j))}}return c}function $o(e){let{canvas:n,dom:r,getGrid:d,getN:i,getH:s,getRotFloat:c,constants:f,helpers:m,Spell:g,Magic:a,SoundModule:p,State:E,isGamePlaying:A,addPendingKzDrop:j,getKillRate:q,triggerSpellWave:ct,spawnSpellBubbles:wt,spawnBonusBubbles:ve,getTransmuteEffect:rt,getLightningEffect:$,getFireEffect:bt,continueMatchProcessing:ne,updateScoreHud:Ot,showBonus:qt,getSpellCost:Rt,getSpellElement:It,onUltimateApplied:_,isSpellBlocked:Pt,setScore:_t,setCascadeLevel:Ct}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:lt,SIDE_MARGIN_PX:J,MAX_RADIUS_X:le,SCORE_MAGIC_DESTROY:W}=f,{normSector:V,levelYToScreenY:ut,sectorCenterXY:zt}=m,Ae=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],Q="idle",tt=null,ot=null,Lt=[],Ht=[],se=0,Bt=null,Zt=0,F="idle",oe=null,Le=[],de=[],U=0,P=0,L="idle",w=null,k=[],v=[],at=0;function dt(h){if(typeof Rt!="function"||typeof It!="function")return!1;let B=It(h),S=Rt(h);return!B||!S?!1:(a.charges[B]??0)>=S}function et(h){if(typeof Rt!="function"||typeof It!="function")return!1;let B=It(h),S=Rt(h);return!B||!S||(a.charges[B]??0)<S?!1:(a.charges[B]-=S,a.updateButtons(),g.pulse(),!0)}let it=0,T=350;function M(){return typeof Pt=="function"?Pt():!1}function R(){let h=performance.now();h-it<T||(it=h,p.play("cancel"))}function ie(){Q="selecting_source",tt=null,ot=null,Lt=[],Ht=[],F!=="idle"&&gt(),L!=="idle"&&Wt(),a.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function b(){Q!=="idle"&&p.play("cancel"),Q="idle",tt=null,ot=null,Lt=[],Ht=[],kt();let h=r.spellBtn;h&&h.classList.remove("selecting")}function nt(h,B){if(Q!=="selecting_source")return!1;if(M())return R(),!0;let S=z(h,B);if(!S)return b(),!0;let K=d();tt={y:S.y,s:S.s,color:K[S.y][S.s]},Lt=Os({centerY:S.y,centerS:S.s,size:rt().areaSize,H:s(),normSector:V});let Et=tt.color,pt=fs(K,Lt,Et);return Ht=gs(pt,rt().maxBlocks),ue(tt.color,S.y),Q="selecting_target",!0}function z(h,B){let S=n.clientWidth,K=n.clientHeight,Et=S*.5,pt=(S-2*J)/2,Kt=K-l-lt,we=6,Vt=s(),tn=i(),Ve=c(),en=tn*Kt/(we*Vt),ge=K-lt,te,nn,be;en<=Math.min(pt,le)?(te=en,nn=Kt,be=l):(te=Math.min(pt,le),nn=te*we*Vt/tn,be=ge-nn);let Me=te*.28,un=null,Mn=1/0,fn=d();for(let Qt=0;Qt<Vt;Qt++){let sn=ut(be,nn,Qt+.5);for(let Be=0;Be<tn;Be++){if(!fn[Qt][Be])continue;let Ge=zt(Et,sn,te,Me,Be,Ve);if(Math.sin(Ge.ang)<-.1)continue;let re=h-Ge.x,xn=B-Ge.y,Ie=Math.hypot(re,xn),Ue=nn/Vt*.9,x=Ue*1.2;Math.abs(re)<x/2&&Math.abs(xn)<Ue/2&&Ie<Mn&&(Mn=Ie,un={y:Qt,s:Be})}}return un}function ue(h,B){kt();let S=document.createElement("div");S.className="transmute-popup";let K=n.clientWidth,Et=n.clientHeight,pt=(K-2*J)/2,Kt=Et-l-lt,we=6,Vt=s(),tn=i(),Ve=tn*Kt/(we*Vt),en=Et-lt,ge,te;Ve<=Math.min(pt,le)?(ge=Kt,te=l):(ge=Math.min(pt,le)*we*Vt/tn,te=en-ge);let nn=ut(te,ge,B+.5),be=Math.floor(rt().areaSize/2),Me=ut(te,ge,Math.min(Vt,B+be)+.5),un=ut(te,ge,Math.max(0,B-be)+.5),Mn=te+ge/2,fn=document.getElementById("gameContainer"),Qt=fn?fn.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},sn=160,Be=60,Ge=20,hn=Qt.left+Qt.width/2-sn/2,re;nn<Mn?re=Qt.top+un+Ge:re=Qt.top+Me-Be-Ge,re=Math.max(10,Math.min(window.innerHeight-Be-10,re)),S.style.left=`${hn}px`,S.style.top=`${re}px`,Ae.filter(Ie=>Ie.color!==h).forEach(Ie=>{let Ue=document.createElement("button");Ue.className=`transmute-btn ${Ie.name}`,Ue.innerHTML=Ie.icon,Ue.setAttribute("data-color",Ie.color),Ue.addEventListener("click",x=>{x.stopPropagation(),He(Ie.color)}),S.appendChild(Ue)}),document.body.appendChild(S),Bt=S,Zt=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",yt)},50)}function yt(h){performance.now()-Zt<200||Bt&&!Bt.contains(h.target)&&b()}function kt(){document.removeEventListener("pointerdown",yt),Bt&&(Bt.remove(),Bt=null)}function He(h){if(M()){R();return}if(!dt(g.currentSpell)){R();return}if(kt(),ot=h,Ht.length===0){b();return}ye()}function ye(){if(!tt){b();return}if(Ht.length===0){b();return}if(!et(g.currentSpell)){R(),b();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),Q="animating",se=performance.now(),p.play("esseffect")}function Se(){if(Q!=="selecting_target"&&Q!=="animating"||!tt||!Lt||Lt.length===0)return;let h=d(),B=h[tt.y]?.[tt.s]??0;if(!B||B!==tt.color){b();return}let S=fs(h,Lt,B),K=rt().maxBlocks??S.length;Ht=gs(S,K),Ht.length===0&&b()}function Xt(h){if(Q!=="animating")return!1;let B=(h-se)/1e3;return Math.min(B/rt().animSec,1)>=1?(We(),!1):!0}function $e(h){if(Q!=="animating")return null;let B=(h-se)/1e3,S=Math.min(B/rt().animSec,1),K="flash",Et=0,pt=0;return S<.15?(K="flash",pt=1-S/.15):S<.55?(K="shrink",Et=(S-.15)/.4):(K="grow",Et=(S-.55)/.45),{phase:K,progress:Et,areaFlash:pt}}function We(){let h=d();for(let B of Ht)h[B.y][B.s]=ot;Q="idle",tt=null,ot=null,Lt=[],Ht=[],Ct(1),ne(),typeof _=="function"&&_("earth")}function jt(){p.play("ulta"),F="selecting_source",oe=null,Le=[],de=[],P=0,Q!=="idle"&&(Q="idle",tt=null,ot=null,Lt=[],Ht=[],kt()),L!=="idle"&&(L="idle",w=null,k=[],v=[],at=0),a.deactivate();let h=r.spellBtn;h&&h.classList.add("selecting")}function gt(){F!=="idle"&&p.play("cancel"),F="idle",oe=null,Le=[],de=[],P=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function fe(){L="selecting_source",w=null,k=[],v=[],at=0,Q!=="idle"&&(Q="idle",tt=null,ot=null,Lt=[],Ht=[],kt()),F!=="idle"&&(F="idle",oe=null,Le=[],de=[],P=0),a.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function Wt(){L!=="idle"&&p.play("cancel"),L="idle",w=null,k=[],v=[],at=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function Fe(h,B){if(F!=="selecting_source")return!1;if(M())return R(),!0;let S=z(h,B);if(!S)return gt(),!0;let K=d();oe={y:S.y,s:S.s,color:K[S.y][S.s]},Le=Os({centerY:S.y,centerS:S.s,size:$().areaSize,H:s(),normSector:V});let Et=oe.color,pt=fs(K,Le,Et);return de=gs(pt,$().maxBlocks),de.length===0?(gt(),!0):dt(g.currentSpell)?(Sn(),!0):(R(),!0)}function je(h,B){if(L!=="selecting_source")return!1;if(M())return R(),!0;let S=z(h,B);if(!S)return Wt(),!0;let K=d();return w={y:S.y,s:S.s,color:K[S.y][S.s]},k=Ho({centerY:S.y,centerS:S.s,beamLength:bt().beamLength,N:i(),H:s(),normSector:V}),v=k.filter(Et=>K[Et.y][Et.s]).sort((Et,pt)=>Et.dist-pt.dist),v.length===0?(Wt(),!0):dt(g.currentSpell)?($t(),!0):(R(),!0)}function Sn(){if(!oe||de.length===0){gt();return}if(!et(g.currentSpell)){R(),gt();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),F="animating",U=performance.now(),P=0,p.play("asseffect")}function kn(h){if(F!=="animating")return!1;let B=h-U,S=$().flashMs+de.length*$().jumpMs;return B>=S?(Ee(),!1):!0}function H(h){if(F!=="animating")return null;let B=h-U;if(B<$().flashMs)return{phase:"flash",flashProgress:1-B/$().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let S=B-$().flashMs,K=Math.floor(S/$().jumpMs),Et=S%$().jumpMs/$().jumpMs,pt=[];for(let Kt=0;Kt<Math.min(K,de.length);Kt++)pt.push(Kt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(K,de.length-1),jumpProgress:Et,struckTargets:pt}}function Ee(){let h=d(),B=de.length,S=B*W;E.addScore(S),_t(E.score),Ot(),qt(`+${S}`,"score");for(let Kt of de)h[Kt.y][Kt.s]=0;let K=$(),Et=Math.abs(K.kzDropSecPerBlock??0),pt=B*Et;pt>0&&typeof j=="function"&&typeof q=="function"&&(j(pt*q()),qt(`\u26A1 -${pt}s`,"time")),F="idle",oe=null,Le=[],de=[],P=0,Ct(1),ne(),typeof _=="function"&&_("air")}function $t(){if(!w||v.length===0){Wt();return}if(!et(g.currentSpell)){R(),Wt();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),L="animating",at=performance.now(),p.play("fsseffect")}function ce(h){return L!=="animating"?!1:(h-at)/1e3>=bt().animSec?(Ne(),!1):!0}function En(h){if(L!=="animating")return null;let B=bt(),S=Math.max(.001,B.animSec),K=(h-at)/1e3,Et=Math.min(K/S,1),pt=.25,Kt=Et<pt?1-Et/pt:0,we=.6,Vt=Et<we?Et/we*B.beamLength:B.beamLength;return{progress:Et,flashProgress:Kt,beamLength:B.beamLength,beamReach:Vt}}function Ne(){let h=d(),B=v.length;if(B>0){let S=B*W;E.addScore(S),_t(E.score),Ot(),qt(`+${S}`,"score")}for(let S of v)h[S.y][S.s]=0;L="idle",w=null,k=[],v=[],at=0,Ct(1),ne(),typeof _=="function"&&_("fire")}function dn(){let h=typeof A=="function"?A():E.isPlaying(),B=g.currentSpell;if(!h)return!1;if(B==="ice"){if(M()||!dt(B)||!et(g.currentSpell))return R(),!1;let S=g.effect;return typeof j=="function"&&typeof q=="function"&&j(S.duration*q()),p.play("wsseffect"),qt(`\u{1F4A7} -${S.duration}s`,"time"),typeof ct=="function"&&ct(),typeof ve=="function"&&ve(S.duration),typeof _=="function"&&_(B),!0}return B==="earth"?Q==="selecting_source"||Q==="selecting_target"?(b(),!0):Q!=="idle"||M()||!dt(B)?(R(),!1):(Q==="idle"&&ie(),!0):B==="air"?F==="selecting_source"?(gt(),!0):F!=="idle"||M()||!dt(B)?(R(),!1):(F==="idle"&&jt(),!0):B==="fire"?L==="selecting_source"?(Wt(),!0):L!=="idle"||M()||!dt(B)?(R(),!1):(L==="idle"&&fe(),!0):!1}function bn(h){Se(),Xt(h),kn(h),ce(h)}function Qe(h,B){return M()&&(Q==="selecting_source"||F==="selecting_source"||L==="selecting_source")?(R(),!0):Q==="selecting_source"?nt(h,B):F==="selecting_source"?Fe(h,B):L==="selecting_source"?je(h,B):!1}function St(){Q="idle",tt=null,ot=null,Lt=[],Ht=[],kt(),F="idle",oe=null,Le=[],de=[],P=0,L="idle",w=null,k=[],v=[],at=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function Jt(){return{transmuteState:Q,transmuteSourceBlock:tt,transmuteTargetColor:ot,transmuteAreaCells:Lt,transmuteBlocksToChange:Ht,lightningState:F,lightningSourceBlock:oe,lightningAreaCells:Le,lightningBlocksToHit:de,fireState:L,fireSourceBlock:w,fireLineCells:k,fireTargets:v}}return{startTransmuteSourceSelection:ie,cancelTransmutation:b,startLightningSourceSelection:jt,cancelLightning:gt,startFireSourceSelection:fe,cancelFire:Wt,handleTap:Qe,update:bn,reset:St,getRenderState:Jt,getTransmuteAnimState:$e,getLightningAnimState:H,getFireAnimState:En,handleSpellButtonClick:dn,isTransmuteSelecting:()=>Q==="selecting_source",isLightningSelecting:()=>F==="selecting_source"}}var sc={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Fo(e={}){let{canvas:n}=e,r=e.rotDir||1,d=!1,i=0,s=0,c=0,f=0,m=0,g=1,a=null,p=0,E=0,A=0,j=0,q=0,ct=0,wt=0,ve=0,rt=sc;return{get rotDir(){return r},set rotDir($){r=$},get dragging(){return d},get dragMode(){return a},handlePointerDown($,bt,ne){if(bt.onMagicTap&&bt.onMagicTap($.clientX,$.clientY))return!0;let Ot=performance.now(),qt=Ot-ct,Rt=$.clientX-wt,It=$.clientY-ve,_=Math.hypot(Rt,It);return qt<=rt.DOUBLE_TAP_MS&&_<=rt.DOUBLE_TAP_MAX_DIST?(bt.onDoubleTap&&bt.onDoubleTap(),ct=0):(ct=Ot,wt=$.clientX,ve=$.clientY),d=!0,g=-1,i=$.clientX,s=$.clientY,c=ne,f=0,m=0,a=null,p=Ot,E=$.clientX,A=$.clientY,j=p,q=0,n&&n.setPointerCapture($.pointerId),!1},handlePointerMove($,bt,ne,Ot){if(!d)return null;let qt=$.clientX-i,Rt=$.clientY-s,It=performance.now();if(Math.abs(qt)<rt.DEADZONE_PX&&Math.abs(Rt)<rt.DEADZONE_PX)return null;if(a){if(a==="rotate"){let Pt=Math.abs(qt),_t=Math.abs(Rt);if(_t>=Pt*rt.AXIS_DOMINANCE&&_t>=rt.DROP_SWIPE_MIN_DISTANCE){let Ct=Math.max(1,It-p);_t/Ct*1e3>=rt.DROP_SWIPE_MIN_SPEED&&(a="drop",m=0)}}}else{let Pt=Math.abs(qt),_t=Math.abs(Rt);if(Rt<0)Pt>=rt.DEADZONE_PX&&(a="rotate");else if(_t>=Pt*rt.AXIS_DOMINANCE){if(_t>=rt.DROP_SWIPE_MIN_DISTANCE){let Ct=Math.max(1,It-p);_t/Ct*1e3>=rt.DROP_SWIPE_MIN_SPEED?a="drop":a="rotate"}}else Pt>=_t*rt.AXIS_DOMINANCE&&(a="rotate");if(!a)return null}let _=null;if(a==="rotate"&&Math.abs(qt)>=rt.DEADZONE_PX){let Pt=Math.max(1,It-j),_t=$.clientX-E,Ct=Math.max(1,Math.abs(_t)/Pt*1e3),l=Math.max(rt.MIN_ROT_PX,Math.min(rt.MAX_ROT_PX,rt.PX_PER_STEP*(rt.SWIPE_SPEED_REF/Ct)));q+=-_t/l*r*g;let lt=Math.trunc(q);lt!==0&&(q-=lt);let J=f+lt;if(J!==f&&bt.canRotateTo){let le=Math.sign(J-f),W=c+f;for(;f!==J;){let V=f+le,ut=c+V;if(!bt.canRotateTo(Math.floor(ne),ut))break;f=V,W=ut,bt.onRotateStep&&bt.onRotateStep(),Ot&&bt.onGroundedMove&&bt.onGroundedMove()}_={targetRot:W,rotFloat:W}}}if(a==="drop"&&Rt>=rt.DROP_SWIPE_MIN_DISTANCE&&bt.onDrop){let Pt=Math.max(1,It-j),_t=$.clientY-A,Ct=Math.max(1,_t/Pt*1e3),l=Math.max(rt.MIN_DROP_PX,Math.min(rt.MAX_DROP_PX,rt.PX_PER_DROP*(rt.SWIPE_SPEED_REF/Ct))),lt=Math.trunc(Rt/l);if(lt>m){let J=lt-m;for(let le=0;le<J;le++)bt.onDrop();m=lt}}return E=$.clientX,A=$.clientY,j=It,_},handlePointerUp($){if(d&&(d=!1,a=null,n&&$&&$.pointerId!==void 0))try{n.releasePointerCapture($.pointerId)}catch{}},reset(){d=!1,a=null,f=0,m=0,q=0}}}var Ds={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function No(){let e="intro",n=0,r=0,d=0,i=0,s=0,c={...Ds};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return r},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),d=0,i=0,s=0,c={...Ds}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(f){n+=f},setScore(f){n=f},updateTime(){e==="playing"&&r>0&&(d=performance.now()-r-s)},getFormattedTime(){let f=Math.floor(d/1e3),m=Math.floor(f/60),g=f%60;return`${m}:${g.toString().padStart(2,"0")}`},incrementStat(f,m=1){f in c&&(c[f]+=m)},updateMaxStat(f,m){f in c&&m>c[f]&&(c[f]=m)},reset(){e="intro",n=0,r=0,d=0,i=0,s=0,c={...Ds}}}}function Pn(e,n){return e%=n,e<0&&(e+=n),e}function Go(e,n){return e[Math.min(n,e.length-1)]}function ms(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),d=n%60;return`${r}:${d.toString().padStart(2,"0")}`}function Uo(e,n){let r=e.map(({x:f,y:m},g)=>({x:m,y:-f,color:n[g]})),d=1/0,i=-1/0,s=1/0;for(let f of r)d=Math.min(d,f.x),i=Math.max(i,f.x),s=Math.min(s,f.y);let c=Math.round((d+i)/2);for(let f of r)f.x-=c,f.y-=s;return r.sort((f,m)=>f.y-m.y||f.x-m.x),{cells:r.map(f=>({x:f.x,y:f.y})),colors:r.map(f=>f.color)}}function Hs(e,n,r,d){let i=[];return e+1<r&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Pn(n-1,d)}),i.push({y:e,s:Pn(n+1,d)}),i}function Xo(e,n,r){let d=Array.from({length:n},()=>new Uint8Array(r)),i=[];for(let s=0;s<n;s++)for(let c=0;c<r;c++){if(!e[s][c]||d[s][c])continue;let f=[],m=[{y:s,s:c}];for(d[s][c]=1;m.length>0;){let g=m.shift();f.push(g);for(let a of Hs(g.y,g.s,n,r))e[a.y][a.s]&&!d[a.y][a.s]&&(d[a.y][a.s]=1,m.push(a))}i.push(f)}return i}function Yo(e){return e.some(n=>n.y===0)}function $s(e,n,r,d,i,s){if(!e)return!1;let c=Pn(r,s);for(let f of e.cells){let m=n+f.y,g=Pn(c+f.x,s);if(m<0)return!1;if(!(m>=i)&&d[m][g])return!1}return!0}function Wo(e,n,r,d,i,s){if(!e)return null;let c=Math.floor(n);for(;$s(e,c-1,r,d,i,s);)c-=1;return c}function Vo(e,n,r){let d=[],i=[];for(let s=0;s<n;s++){let c=[],f=0,m=e[s][0],g=m?1:0;for(let a=1;a<=r;a++){let p=a<r?e[s][a]:0;p&&p===m?g++:(g>=1&&m&&c.push({start:f,length:g,color:m}),f=a,m=p,g=p?1:0)}if(c.length>=2){let a=c[0],p=c[c.length-1];if(a.start===0&&p.start+p.length===r&&a.color===p.color){let E=a.length+p.length;c[0]={start:p.start,length:E,color:a.color},c.pop()}}for(let a of c)if(a.length>=3){let p=[];for(let E=0;E<a.length;E++)p.push({y:s,s:(a.start+E)%r});d.push({color:a.color,length:a.length,cells:p})}}for(let s=0;s<r;s++){let c=0,f=e[0][s],m=f?1:0;for(let g=1;g<=n;g++){let a=g<n?e[g][s]:0;if(a&&a===f)m++;else{if(m>=3&&f){let p=[];for(let E=0;E<m;E++)p.push({y:c+E,s});d.push({color:f,length:m,cells:p})}c=g,f=a,m=a?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<r;c++){let f=e[s][c],m=e[s][(c+1)%r],g=e[s][(c+2)%r],a=e[s][(c+3)%r];f&&f===m&&g&&g===a&&f!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%r},{y:s,s:(c+2)%r},{y:s,s:(c+3)%r}]})}for(let s=0;s<r;s++)for(let c=0;c<n-3;c++){let f=e[c][s],m=e[c+1][s],g=e[c+2][s],a=e[c+3][s];f&&f===m&&g&&g===a&&f!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:d,pairMatches:i}}function Ko(e,n,r){let d=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<r;c++)if(!e[i][c]){s=!1;break}s&&d.push(i)}return d}function qo(e,n){let r=new Map;e.forEach((d,i)=>r.set(`${d.x},${d.y}`,n[i]));for(let d=0;d<e.length;d++){let i=e[d],s=n[d],c=1;for(let ct=1;ct<=2&&r.get(`${i.x+ct},${i.y}`)===s;ct++)c++;if(c>=3)return!0;let f=1;for(let ct=1;ct<=2&&r.get(`${i.x},${i.y+ct}`)===s;ct++)f++;if(f>=3)return!0;let m=s,g=r.get(`${i.x+1},${i.y}`),a=r.get(`${i.x+2},${i.y}`),p=r.get(`${i.x+3},${i.y}`);if(m&&g&&a&&p&&m===g&&a===p&&m!==a)return!0;let E=s,A=r.get(`${i.x},${i.y+1}`),j=r.get(`${i.x},${i.y+2}`),q=r.get(`${i.x},${i.y+3}`);if(E&&A&&j&&q&&E===A&&j===q&&E!==j)return!0}return!1}function zo(e){let{getN:n,getH:r,FALL_INTERVAL:d,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:f,RING_HIGHLIGHT_SEC:m,getState:g,setState:a,funcs:p,ui:E}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(A,j={}){let q=g();if(A==="start_game")return q.gameState!=="playing"?(p.startGame(),!0):!1;if(q.gameState!=="playing")return!1;switch(A){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:ct}=j;return typeof ct=="number"&&p.canPlaceAtRot(Math.floor(q.pieceY),ct)?(a({targetRot:ct,rotFloat:ct,rotVel:0}),q.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ct,y:wt}=j;return p.shootMagic(ct,wt)}case"select_magic":{let{element:ct}=j;return p.selectMagic(ct),!0}default:return console.warn("GameEngine: unknown command",A),!1}},update(A,j){let q=g();if(q.gameState!=="playing")return;let ct=j-q.startTime-q.totalPausedMs;a({elapsedMs:ct}),E.updateTimeHud();let wt=q.killLevel+s()*A;if(a({killLevel:wt}),E.updateRemainingHud(),wt>=r()){p.endGame();return}if(q.isHighlighting){let $=(j-q.highlightStartTime)/1e3,bt;q.isRingAnimation?bt=m:q.isMagicAnimation?bt=f:bt=c,$>=bt&&(q.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ve=q.fallTimer+A;if(ve>=d&&(ve-=d,p.tryMoveDown()),a({fallTimer:ve}),p.updateGroundedState()){let $=q.lockTimer+A;a({lockTimer:$}),$>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(A,j){return p.canPlaceAtRot(A,j)},getRotation(){let A=g();return{targetRot:A.targetRot,rotFloat:A.rotFloat,rotVel:A.rotVel}},setRotation(A){a({targetRot:A,rotFloat:A,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var ze=Math.PI*2;function jo(e){let{canvas:n,canvasCtx:r,getN:d,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:f,MAX_RADIUS_X:m,RADIUS_X_FACTOR:g,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:E,MAGIC_SHRINK_SEC:A,RING_HIGHLIGHT_SEC:j,LOCK_DELAY_SEC:q,getKillRate:ct,ELEMENT_COLORS:wt,ELEMENT_TO_COLOR:ve,BLOCK_COLOR_FRONT:rt,BLOCK_COLOR_BACK:$,ACTIVE_COLOR_FRONT:bt,GHOST_COLOR_FILL:ne,GHOST_COLOR_STROKE:Ot,GHOST_STROKE_WIDTH:qt,MAGIC_DIM_DOT_ALPHA:Rt,MAGIC_DIM_DOT_SCALE:It,MAGIC_TARGET_DOT_SCALE:_,getState:Pt,getVisualSettings:_t,funcs:Ct}=e,l=r,lt=d(),J=i(),le={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},W=[],V=40;function ut(U,P,L,w,k){let v=Math.max(3,Math.round(U)),at=180;for(let dt=0;dt<v;dt++)setTimeout(()=>{let et=Math.random()>.5?"left":"right",it=15,T=et==="left"?it+Math.random()*Math.max(10,P-it*2):L+it+Math.random()*Math.max(10,k-L-it*2),M=w-10;W.push({x:T,baseX:T,y:M,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:it,maxX:k-it})},dt*at)}function zt(U,P,L){W=W.filter(w=>w.y>U+w.size&&w.y>-20);for(let w of W){w.y-=V*L,w.wobble+=w.wobbleSpeed*L;let k=w.baseX+Math.sin(w.wobble)*w.wobbleAmp;w.x=Math.max(w.minX,Math.min(w.maxX,k))}}function Ae(U){if(W.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let P of W)P.y<U+P.size||(l.beginPath(),l.arc(P.x,P.y,P.size,0,Math.PI*2),l.fill(),l.stroke())}}let Q={left:0,right:0,h:0,w:0};function tt(U,P,L){let w=1-L/J;return U+w*P}function ot(U){return U=U%lt,U<0?U+lt:U}function Lt(U,P,L,w,k,v){let at=ot(v),dt=(k-at)/lt*ze+a;return{x:U+Math.cos(dt)*L,y:P+Math.sin(dt)*w,ang:dt}}let Ht=.52,se=1.02;function Bt(U,P,L,w,k,v){let at=ot(v),dt=(k-at)/lt*ze+a;return{x:U+Math.cos(dt)*L,y:P+Math.sin(dt)*w,ang:dt}}function Zt(U,P,L,w,k,v,at,dt=1){let et=Bt(U,P,L,w,k-Ht,v),it=Bt(U,P,L,w,k+Ht,v),T={x:et.x,y:et.y-at*.5},M={x:et.x,y:et.y+at*.5},R={x:it.x,y:it.y-at*.5},ie={x:it.x,y:it.y+at*.5},b=(T.x+R.x+ie.x+M.x)*.25,nt=(T.y+R.y+ie.y+M.y)*.25,z=se*dt,ue=dt,yt=[T,R,ie,M].map(ye=>({x:b+(ye.x-b)*z,y:nt+(ye.y-nt)*ue})),kt=Math.abs((it.x-et.x)*z),He=Math.abs(at*ue);return{corners:yt,cx:b,cy:nt,wApprox:kt,hApprox:He,ang:Bt(U,P,L,w,k,v).ang}}function F(U,P,L,w,k,v,at,dt,et=1,it=null,T=1,M=null,R=0,ie=1,b=1){let nt=Zt(U,P,L,w,k,v,at,b),[z,ue,yt,kt]=nt.corners;if(l.save(),l.globalAlpha=et,l.fillStyle=dt,l.beginPath(),l.moveTo(z.x,z.y),l.lineTo(ue.x,ue.y),l.lineTo(yt.x,yt.y),l.lineTo(kt.x,kt.y),l.closePath(),l.fill(),M&&R>0&&(l.strokeStyle=M,l.lineWidth=R,l.stroke()),it){let He=Math.min(nt.wApprox,nt.hApprox)*.28*ie;l.globalAlpha=et*T,l.fillStyle=it,l.beginPath(),l.arc(nt.cx,nt.cy,He,0,ze),l.fill()}l.restore(),l.globalAlpha=1}function oe(U,P,L,w,k,v){let at=Lt(U,P,L,w,k,v),dt=Lt(U,P,L,w,k+1,v),et=Lt(U,P,L,w,k-1,v),it=Math.abs(dt.x-at.x),T=Math.abs(at.x-et.x),M=(it+T)*.5*1.06;return Math.max(1,M)}function Le(U,P,L,w,k,v){let at=(k-v)/lt*ze+a;return{x:U+Math.cos(at)*L,y:P+Math.sin(at)*w,ang:at}}function de(U,P,L,w,k,v,at,dt=1,et=null,it=1,T=null,M=0,R=1){l.save(),l.translate(U,P);let ie=Math.atan2(w,L);if(l.rotate(ie),l.globalAlpha=dt,l.fillStyle=at,l.fillRect(-k/2,-v/2,k,v),T&&M>0&&(l.strokeStyle=T,l.lineWidth=M,l.strokeRect(-k/2,-v/2,k,v)),et){let b=Math.min(k,v)*.28*R;l.globalAlpha=dt*it,l.fillStyle=et,l.beginPath(),l.arc(0,0,b,0,ze),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let U=Math.max(1,Math.min(2,window.devicePixelRatio||1)),P=Math.floor(n.clientWidth*U),L=Math.floor(n.clientHeight*U);(n.width!==P||n.height!==L)&&(n.width=P,n.height=L,l.setTransform(U,0,0,U,0,0))},render(U=.016,P=performance.now()){this.resize();let L=Pt();lt=d(),J=i();let w=n.clientWidth,k=n.clientHeight;l.clearRect(0,0,w,k),l.fillStyle="#0b0f14",l.fillRect(0,0,w,k);let v=w*.5,at=(w-2*f)/2,dt=k-s-c,et=6,it=lt*dt/(et*J),T,M,R,ie;ie=k-c,it<=Math.min(at,m)?(T=it,M=dt,R=s):(T=Math.min(at,m),M=T*et*J/lt,R=ie-M);let b=T*.28,{killLevel:nt,rotFloat:z,grid:ue,gameState:yt}=L,kt=_t?_t():{},He=kt.waterColor||"blue",ye=kt.waterBubbles||!1,Se=le[He]||le.blue,Xt=tt(R,M,nt),$e=.7,We=nt/J,jt={...Se.top},gt={...Se.bottom};if(We>$e){let x=(We-$e)/(1-$e);jt.r=Math.round(jt.r+(255-jt.r)*x*.5),jt.g=Math.round(jt.g+(150-jt.g)*x*.5),jt.b=Math.round(jt.b+(150-jt.b)*x*.5),gt.r=Math.round(gt.r+(180-gt.r)*x),gt.g=Math.round(gt.g*(1-x*.6)),gt.b=Math.round(gt.b*(1-x*.6))}let fe=v-T-8,Wt=v+T+8,Fe=R,je=ie+5,Sn=l.createLinearGradient(0,Xt,0,k);Sn.addColorStop(0,`rgba(${jt.r},${jt.g},${jt.b},0.5)`),Sn.addColorStop(1,`rgba(${gt.r},${gt.g},${gt.b},0.7)`),l.fillStyle=Sn;let kn=Math.round((jt.r+gt.r)/2),H=Math.round((jt.g+gt.g)/2),Ee=Math.round((jt.b+gt.b)/2),$t=T+8,ce=b+4;l.fillRect(0,Xt,fe,k-Xt),l.fillRect(Wt,Xt,w-Wt,k-Xt),l.beginPath();let En=Math.max(Xt,je);l.moveTo(fe,En),Xt<=je+ce?l.ellipse(v,je,$t,ce,0,Math.PI,0,!1):l.lineTo(Wt,En),l.lineTo(Wt,k),l.lineTo(fe,k),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(fe,Fe),l.lineTo(fe,je),l.stroke(),l.beginPath(),l.moveTo(Wt,Fe),l.lineTo(Wt,je),l.stroke(),l.beginPath(),l.ellipse(v,je,T+8,b+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(v,je,T+8,b+4,0,0,ze),l.fill(),nt>.5&&(l.strokeStyle=`rgba(${Math.min(255,kn+60)},${Math.min(255,H+40)},${Math.min(255,Ee+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Xt),l.lineTo(fe,Xt),l.moveTo(Wt,Xt),l.lineTo(w,Xt),l.stroke()),Q={left:fe,right:Wt,h:k,w},(W.length>0||ye)&&(zt(Xt,k,U),Ae(Xt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Ne=ze*T,dn=10,bn=Ne/dn*.7,Qe=Ne/dn*.3;l.setLineDash([bn,Qe]);let St=Ne/lt;l.lineDashOffset=ot(z)*St;for(let x=0;x<=J;x++){let O=tt(R,M,x);l.beginPath(),l.ellipse(v,O,T,b,0,0,ze),l.stroke()}l.setLineDash([]);let Jt=[],h=[];for(let x=0;x<J;x++){let O=tt(R,M,x+.5);for(let Z=0;Z<lt;Z++){let X=ue[x][Z];if(!X)continue;let N=Lt(v,O,T,b,Z,z),Y=Math.sin(N.ang),I={y:x,s:Z,yScr:O,p:N,depth:Y,color:X};Y<-.1?Jt.push(I):h.push(I)}}let B=Ct.getMagicTargetColor(),{isHighlighting:S,highlightedCells:K,highlightStartTime:Et,isMagicAnimation:pt}=L,Kt=null,we=1,Vt=1,tn=!1;if(S&&K.length>0){Kt=new Set(K.map(O=>`${O.y},${O.s}`));let x=(performance.now()-Et)/1e3;if(pt){let O=Math.min(1,x/A);we=1-O*.85,Vt=1-O*.9,tn=!0}else{let O=Math.min(1,x/p),Z=1-E;if(O>Z){let X=(O-Z)/E;we=1-X*.85,Vt=1-X*.9,tn=!0}}}Jt.sort((x,O)=>x.depth-O.depth);for(let x of Jt){let O=M/J*.9,Z=wt[x.color]||null,X=.35,N=1,Y=`${x.y},${x.s}`;Kt&&Kt.has(Y)&&(X*=Vt,N=we),F(v,x.yScr,T,b,x.s,z,O,$,X,Z,.5,null,0,1,N)}let{isRingAnimation:Ve}=L;if(S&&K.length>0&&!pt){let x=(performance.now()-Et)/1e3,Z=Math.min(1,x/(Ve?j:p)),X=1-E,N=Z>X,Y=N?(Z-X)/E:0,I=Ve?Math.floor(Z*X*lt*2)%lt:-1,C=4+Z/X*10,G=Math.sin(x*C*ze),mt=N?1:.3+G*.3,Mt=N?1-Y*.8:1,At=N?1-Y:1;for(let xt of K){let Ft=tt(R,M,xt.y+.5),Pe=Bt(v,Ft,T,b,xt.s,z);if(Math.sin(Pe.ang)>=-.1)continue;let Cn=M/J*.9,Re,ae,ee;if(Ve){let cn=(xt.s-I+lt)%lt,Ze=cn<3?1-cn/3:0;Re=(N?At:.2+Ze*.5)*.5,ae=`rgba(255, 159, 67, ${Re})`,ee=N?Mt:1+Ze*.15}else Re=mt*At,ae=xt.isLine?`rgba(255, 255, 255, ${Re*.5})`:`rgba(255, 220, 100, ${Re*.4})`,ee=N?Mt:1.1;F(v,Ft,T,b,xt.s,z,Cn,ae,1,null,1,null,0,1,ee)}}h.sort((x,O)=>x.depth-O.depth);for(let x of h){let O=M/J*.9,Z=wt[x.color]||null,X=1,N=1,Y=1,I=1,C=`${x.y},${x.s}`,G=Kt&&Kt.has(C);G&&(X=Vt,N=we),B!==null&&!G&&(x.color!==B?(Y=Rt,I=It):I=_),F(v,x.yScr,T,b,x.s,z,O,rt,X,Z,Y,null,0,I,N)}if(S&&K.length>0&&!pt){let x=(performance.now()-Et)/1e3,Z=Math.min(1,x/(Ve?j:p)),X=1-E,N=Z>X,Y=N?(Z-X)/E:0,I=Ve?Math.floor(Z*X*lt*2)%lt:-1,C=4+Z/X*10,G=Math.sin(x*C*ze),mt=N?1:.5+G*.5,Mt=N?1-Y*.8:1,At=N?1-Y:1;for(let xt of K){let Ft=tt(R,M,xt.y+.5),Pe=Bt(v,Ft,T,b,xt.s,z);if(Math.sin(Pe.ang)<-.1)continue;let Cn=M/J*.9,Re,ae,ee;if(Ve){let cn=(xt.s-I+lt)%lt,Ze=cn<4?1-cn/4:0;Re=N?At:.3+Ze*.7,ae=`rgba(255, 159, 67, ${Re})`,ee=N?Mt:1+Ze*.2}else Re=mt*At,ae=xt.isLine?`rgba(255, 255, 255, ${Re*.7})`:`rgba(255, 220, 100, ${Re*.6})`,ee=N?Mt:1.15;F(v,Ft,T,b,xt.s,z,Cn,ae,1,null,1,null,0,1,ee)}}let en=L.spellState||L,{transmuteState:ge,transmuteSourceBlock:te,transmuteTargetColor:nn,transmuteAreaCells:be,transmuteBlocksToChange:Me}=en;if(ge==="selecting_source"){let x=M/J*.9,O=.35+Math.sin(P/150)*.15;for(let Z of h){let X=tt(R,M,Z.y+.5);F(v,X,T,b,Z.s,z,x,`rgba(0, 40, 20, ${O})`,1,null,1,null,0,1,1)}}if(ge==="selecting_target"&&Me&&Me.length>0){let x=M/J*.9,O=.4+Math.sin(P/120)*.25,Z=.6+Math.sin(P/120)*.4;for(let X of Me){if(X.y<0||X.y>=J)continue;let N=tt(R,M,X.y+.5),Y=Bt(v,N,T,b,X.s,z);Math.sin(Y.ang)<-.1||(F(v,N,T,b,X.s,z,x,`rgba(0, 50, 30, ${O})`,1,null,1,null,0,1,1),F(v,N,T,b,X.s,z,x,"transparent",1,null,1,`rgba(100, 255, 150, ${Z})`,3,1,1.02))}}if(ge==="animating"&&Ct.getTransmuteAnimState){let x=Ct.getTransmuteAnimState(P);if(x){let O=M/J*.9,{phase:Z,progress:X,areaFlash:N}=x;if(N>0&&be)for(let Y of be){if(Y.y<0||Y.y>=J)continue;let I=tt(R,M,Y.y+.5),C=Bt(v,I,T,b,Y.s,z);Math.sin(C.ang)<-.1||F(v,I,T,b,Y.s,z,O,`rgba(150, 255, 200, ${N*.4})`,1,null,1,null,0,1,1)}if(Me&&Me.length>0){let Y=te?te.color:1,I=nn||1;for(let C of Me){if(C.y<0||C.y>=J)continue;let G=tt(R,M,C.y+.5),mt=Bt(v,G,T,b,C.s,z);if(Math.sin(mt.ang)<-.1)continue;let At=1,xt=wt[Y],Ft=0;if(Z==="shrink"?(At=1-X*.95,xt=wt[Y],Ft=.5+X*.3):Z==="grow"&&(At=X,xt=wt[I],Ft=.8-X*.5),Ft>0&&F(v,G,T,b,C.s,z,O,`rgba(200, 255, 220, ${Ft})`,1,null,1,null,0,1,1),At>.05){let Pe=Zt(v,G,T,b,C.s,z,O,1),on=Math.min(Pe.wApprox,Pe.hApprox)*.28*At;l.save(),l.globalAlpha=1,l.fillStyle=xt,l.beginPath(),l.arc(Pe.cx,Pe.cy,on,0,ze),l.fill(),l.restore()}}}}}let{lightningState:un,lightningSourceBlock:Mn,lightningAreaCells:fn,lightningBlocksToHit:Qt}=en;if(un==="selecting_source"){let x=M/J*.9,O=.35+Math.sin(P/150)*.15;for(let Z of h){let X=tt(R,M,Z.y+.5);F(v,X,T,b,Z.s,z,x,`rgba(20, 20, 60, ${O})`,1,null,1,null,0,1,1)}}if(un==="animating"&&Ct.getLightningAnimState){let x=Ct.getLightningAnimState(P);if(x&&Qt&&Qt.length>0){let O=M/J*.9,{phase:Z,flashProgress:X,currentTarget:N,jumpProgress:Y,struckTargets:I}=x;if(Z==="flash"&&X>0&&fn)for(let C of fn){if(C.y<0||C.y>=J)continue;let G=tt(R,M,C.y+.5),mt=Bt(v,G,T,b,C.s,z);Math.sin(mt.ang)<-.1||F(v,G,T,b,C.s,z,O,`rgba(100, 150, 255, ${X*.5})`,1,null,1,null,0,1,1)}if(I&&I.length>0)for(let C of I){let G=Qt[C];if(!G||G.y<0||G.y>=J)continue;let mt=tt(R,M,G.y+.5),Mt=Bt(v,mt,T,b,G.s,z);if(Math.sin(Mt.ang)<-.1)continue;let xt=(I.length-1-I.indexOf(C))*.1,Ft=Math.max(0,.8-xt);F(v,mt,T,b,G.s,z,O,`rgba(255, 255, 255, ${Ft})`,1,null,1,`rgba(150, 200, 255, ${Ft})`,2,1,1.05)}if(Z==="chain"&&N>=0&&N<Qt.length){let C=Qt[N];if(C&&C.y>=0&&C.y<J){let G=tt(R,M,C.y+.5),mt=Bt(v,G,T,b,C.s,z);if(Math.sin(mt.ang)>=-.1){let At=1-Y;F(v,G,T,b,C.s,z,O,`rgba(200, 220, 255, ${At*.9})`,1,null,1,`rgba(100, 180, 255, ${At})`,3,1,1.1-Y*.05)}}if(N>0){let G=Qt[N-1],mt=Qt[N];if(G&&mt){let Mt=tt(R,M,G.y+.5),At=tt(R,M,mt.y+.5),xt=Zt(v,Mt,T,b,G.s,z,O,1),Ft=Zt(v,At,T,b,mt.s,z,O,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-Y*.5})`,l.lineWidth=2+(1-Y)*2,l.lineCap="round",l.beginPath();let Pe=xt.cx,on=xt.cy,Cn=Ft.cx,Re=Ft.cy;l.moveTo(Pe,on);let ae=4;for(let ee=1;ee<=ae;ee++){let cn=ee/ae,Ze=Pe+(Cn-Pe)*cn,ps=on+(Re-on)*cn,Vn=ee<ae?(Math.random()-.5)*8:0;l.lineTo(Ze+Vn,ps+Vn)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-Y)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:sn,fireSourceBlock:Be,fireLineCells:Ge,fireTargets:hn}=en;if(sn==="selecting_source"){let x=M/J*.9,O=.3+Math.sin(P/140)*.2;for(let Z of h){let X=tt(R,M,Z.y+.5);F(v,X,T,b,Z.s,z,x,`rgba(70, 25, 10, ${O})`,1,null,1,null,0,1,1)}}if(sn==="animating"&&Ct.getFireAnimState){let x=Ct.getFireAnimState(P);if(x&&Ge&&Ge.length>0){let O=M/J*.9,{progress:Z,flashProgress:X}=x,N=Math.sin(Z*Math.PI);if(X>0)for(let Y of Ge){if(Y.y<0||Y.y>=J)continue;let I=tt(R,M,Y.y+.5),C=Bt(v,I,T,b,Y.s,z);Math.sin(C.ang)<-.1||F(v,I,T,b,Y.s,z,O,`rgba(255, 120, 50, ${X*.45})`,1,null,1,`rgba(255, 200, 140, ${X*.5})`,2,1,1.03)}if(Be){let Y=new Map;for(let C of Ge){if(C.y<0||C.y>=J)continue;let G=tt(R,M,C.y+.5),mt=Bt(v,G,T,b,C.s,z);if(Math.sin(mt.ang)<-.1)continue;let At=Zt(v,G,T,b,C.s,z,O,1),xt=C.s-Be.s;xt>lt/2&&(xt-=lt),xt<-lt/2&&(xt+=lt);let Ft=C.y;Y.has(Ft)||Y.set(Ft,[]),Y.get(Ft).push({x:At.cx,y:At.cy,offset:xt})}let I=Array.from(Y.keys()).sort((C,G)=>G-C);if(I.length>0){let C=.35+.3*Math.sin(P/60)+N*.2;l.save(),l.lineCap="round";for(let G of I){let mt=Y.get(G)||[];if(mt.sort((Mt,At)=>Mt.offset-At.offset),mt.length!==0){l.beginPath(),l.moveTo(mt[0].x,mt[0].y);for(let Mt=1;Mt<mt.length;Mt++)l.lineTo(mt[Mt].x,mt[Mt].y);l.strokeStyle=`rgba(255, 140, 60, ${C})`,l.lineWidth=Math.max(2,O*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${C*.35})`,l.lineWidth=Math.max(6,O*.35),l.stroke()}}l.restore()}}if(hn&&hn.length>0){let Y=.2+N*.6;for(let I of hn){if(I.y<0||I.y>=J)continue;let C=tt(R,M,I.y+.5),G=Bt(v,C,T,b,I.s,z);Math.sin(G.ang)<-.1||F(v,C,T,b,I.s,z,O,`rgba(255, 160, 70, ${Y})`,1,null,1,`rgba(255, 230, 180, ${N*.6})`,2,1,1.05)}}}}let{activePiece:re,pieceY:xn,isGrounded:Ie,lockTimer:Ue}=L;if(re){let x=Ct.snappedRot(),O=x,Z=Ct.computeGhostY(),X=M/J*.9;if(Z!==null){let I=[];for(let C=0;C<re.cells.length;C++){let G=re.cells[C],mt=re.colors[C],Mt=Z+G.y,At=Ct.normSector(x+G.x);if(Mt<0||Mt>=J)continue;let xt=tt(R,M,Mt+.5),Ft=Bt(v,xt,T,b,At,O);I.push({cy:Mt,cs:At,yScr:xt,depth:Math.sin(Ft.ang),color:mt})}I.sort((C,G)=>C.depth-G.depth);for(let C of I){let G=wt[C.color]||null;F(v,C.yScr,T,b,C.cs,O,X,ne,1,G,.5,Ot,qt,1,1)}}let N=bt;if(Ie&&Ue>0){let I=Math.min(1,Ue/q),C=255,G=Math.round(170+85*I),mt=Math.round(180+75*I),Mt=.75+(1-.75)*I;N=`rgba(${C},${G},${mt},${Mt})`}let Y=[];for(let I=0;I<re.cells.length;I++){let C=re.cells[I],G=re.colors[I],mt=Ct.normSector(x+C.x),Mt=xn+C.y;if(Mt<0||Mt>=J)continue;let At=tt(R,M,Mt+.5),xt=Bt(v,At,T,b,mt,O);Y.push({cs:mt,yScr:At,depth:Math.sin(xt.ang),color:G})}Y.sort((I,C)=>I.depth-C.depth);for(let I of Y){let C=wt[I.color]||null;F(v,I.yScr,T,b,I.cs,O,X,N,1,C,1,null,0,1,1)}}},drawNextPreview(U,P){if(!U)return;let L=U.getContext("2d"),w=U.width,k=U.height;if(L.clearRect(0,0,w,k),!P)return;let v=1/0,at=-1/0,dt=1/0,et=-1/0;for(let b of P.cells)v=Math.min(v,b.x),at=Math.max(at,b.x),dt=Math.min(dt,b.y),et=Math.max(et,b.y);let it=at-v+1,T=et-dt+1,M=Math.min(w/(it+.5),k/(T+.5)),R=(w-it*M)/2,ie=(k-T*M)/2;L.fillStyle=rt;for(let b=0;b<P.cells.length;b++){let nt=P.cells[b],z=R+(nt.x-v)*M,ue=ie+(T-1-(nt.y-dt))*M;L.fillRect(z+1,ue+1,M-2,M-2);let yt=P.colors[b],kt=wt[yt];if(kt){let He=(M-2)*.32;L.fillStyle=kt,L.beginPath(),L.arc(z+M/2,ue+M/2,He,0,ze),L.fill(),L.fillStyle=rt}}},spawnBonusBubbles(U){let{left:P,right:L,h:w,w:k}=Q;k>0&&ut(U,P,L,w,k)}}}(()=>{let e=Bo(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,i=30,s=24,c=120,f={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let o=f[t]||f["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let a=Math.PI/2,p=70,E=120,A=30;function j(){let t=document.createElement("div");t.style.cssText="position:fixed;bottom:0;left:0;width:0;height:env(safe-area-inset-bottom,0px);visibility:hidden;pointer-events:none",document.body.appendChild(t);let o=t.offsetHeight;return document.body.removeChild(t),o}let q=j(),ct=E+q;document.documentElement.style.setProperty("--sab",q+"px");let wt=320,ve=.42,rt="rgb(235,240,250)",$="rgb(55,62,75)",bt="rgba(255,170,180,0.75)",ne="rgba(110,255,150,0.15)",Ot="rgba(110,255,150,0.85)",qt=2,Rt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},It={1:"fire",2:"water",3:"lightning",4:"earth"},_={fire:1,water:2,lightning:3,earth:4},Pt=1,_t=.58,Ct=!0,l=12,lt=25,J=1,le=2,W=3,V=1,ut={fire:1,water:1,lightning:1,earth:1},zt=5,Ae=7,Q=10,tt=3,ot=50,Lt=2,Ht=.3,se=.5,Bt=1,Zt=.3,F=.5,oe=1.3,Le=10,de=1e3,U=[1,1.25,1.5,1.75,2],P=10,L=20,w=5,k=[1,1.3,1.6,2,2.4,2.8],v=[1,1.1,1.2,1.3,1.4,1.5],at=[1,1.5,2,2.5,3,3.5],dt=[1,1.3,1.6,2,2.4,2.8],et=Lo(),it=et.loadGameSettings();it.hapticsEnabled===void 0&&(it.hapticsEnabled=!0);let T=it.invertSwipe?-1:1,R=!1,ie=-1,b=ko({enabled:it.hapticsEnabled}),nt=Array.from({length:s},()=>new Uint8Array(i));function z(){nt=Array.from({length:s},()=>new Uint8Array(i))}let ue=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],yt=null,kt=s+3,He=0,ye=0,Se=!1,Xt=0,$e=0,We=0,jt=3,gt=0,fe=0,Wt=0,Fe=Fo({canvas:n,rotDir:T}),je="0.17.3",Sn=!0,kn="blue",H=Mo();H.preload();let Ee=No(),$t="intro",ce=0,En=0,Ne=0,dn=0,bn=0,Qe=null,St=Ee.stats,Jt=0,h=e.overlay,B=e.gameContainer,S=Ao({elementColors:Rt}),K=S.showBonus.bind(S),Et=S.getElementIcon.bind(S),pt=wo(),Kt=e.overlayTitle,we=e.overlayStats,Vt=e.startBtn,tn=e.hud,Ve=e.scoreHud,en=e.timeHud,ge=e.remainingHud,te=e.nextCanvas,nn=te.getContext("2d"),be=e.pauseBtn,Me=e.pauseOverlay,un=e.resumeBtn,Mn=e.restartBtn,fn=e.exitToMenuBtn,Qt=e.pauseSettingsBtn,sn=e.pauseSoundBtn,Be=e.pauseMusicBtn,Ge=e.pauseBestScore,hn=e.pauseBestTime,re=e.pauseBestMode,xn=e.pauseCurrentScore,Ie=e.pauseCurrentTime,Ue=e.pauseCurrentMode,x=e.confirmDialog,O=e.confirmText,Z=e.confirmCancel,X=e.confirmOk,N=e.settingsOverlay,Y=e.settingsClose,I=e.fullscreenBtn,C=e.rotateBtn,G=e.startPanel,mt=e.gameoverPanel,Mt=e.goScore,At=e.goTime,xt=e.goRing,Ft=e.goMatches,Pe=e.goBonuses,on=e.goNewRecord,Cn=e.goRestartBtn,Re=e.goExitBtn,ae=e.bestScore,ee=e.bestTimeVal,cn=e.startVersion,Ze=e.modeBtns,ps=e.recordsBtn,Vn=e.startSettingsBtn,Qo=e.helpBtn;Po({helpBtn:Qo});let xe="25_20";function Zo(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function Jo(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,y=f[u];if(!y)return;let D=o.querySelector(".mode-tag.time-tag");if(!D)return;let st=Zo(y.survivalTime);st&&(D.textContent=st)})}Jo();let ft=Oo({buttons:e.magicBtns,onActivate:()=>H.play("spells"),onChange:(t,o)=>{ys()}}),_n=e.magicBtns,ic=ft.charges,ti=t=>ke()?ft.select(t):!1,On=()=>ft.updateButtons(),Fs=e.magicRow,Yt=e.magicActiveIndicator,Ns=e.magicActiveIcon,Gs=e.magicActiveCost,ei={ice:"water",air:"lightning",earth:"earth",fire:"fire"},hs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},ni=["ice","earth","air","fire"];Jt=et.loadHighTowerRings();function Dn(t){return typeof me?.getUnlockRings=="function"?me.getUnlockRings(t):0}function Kn(t){let o=Dn(t);return o===0||Jt>=o}let Us=["fire","water","lightning","earth"],Ln=null,qn=!1,si=500,oi=30,ii=220,Bn=null,vs=null,Xs={fire:!1,water:!1,lightning:!1,earth:!1};function Ys(){if(!Yt)return;let t=Yt.getBoundingClientRect();t.width>0&&t.height>0&&(vs=t)}function ci(){if(!Yt)return null;let t=Yt.getBoundingClientRect();return t.width>0&&t.height>0?Yt:vs?{getBoundingClientRect:()=>vs}:null}function Hn(t=ft.active){if(!Yt||!Ns)return;t?(Ln=t,qn=!1):qn||(Ln=null);let o=Ln;if(!o||!ke()||(ft.charges[o]??0)<=0){Ys(),Yt.classList.add("hidden"),Yt.classList.remove("active","ult-ready",...Us),Yt.style.setProperty("--progress","0%"),Bn&&clearTimeout(Bn),Bn=setTimeout(()=>{Yt.classList.add("gone")},ii);return}Bn&&(clearTimeout(Bn),Bn=null),Yt.classList.remove("gone"),Yt.classList.contains("hidden")?requestAnimationFrame(()=>Yt.classList.remove("hidden")):Yt.classList.remove("hidden"),Ns.textContent=Et(o);let y=hs[o];y&&me.selectSpell(y);let D=y?Fn(y):0,st=ft.charges[o]??0,vt=!!y&&Qn()&&Kn(y),Nt=!!y&&Qn()&&!vt,pe=vt&&D>0?Math.min(st/D,1):0,Oe=vt&&D>0,Xe=Oe&&st>=D;Gs&&(Gs.textContent=Oe?`-${D}`:Nt?"\u{1F512}":""),Yt.classList.toggle("no-cost",!Oe&&!Nt),Yt.classList.toggle("locked",Nt),Yt.classList.toggle("ult-ready",Xe),Yt.style.setProperty("--progress",`${Math.round(pe*100)}%`),Yt.classList.remove("hidden",...Us),Yt.classList.add("active",o),Ys()}function ri(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),si))}function zn(){for(let[t,o]of Object.entries(_n)){if(!o)continue;let u=hs[t],y=Fn(u),D=Qn()&&ke()&&u,st=typeof Kn=="function"?Kn(u):!0,vt=D&&st&&y>0&&(ft.charges[t]??0)>=y;o.classList.toggle("ult-ready",vt),vt&&!Xs[t]&&(ri(o),$t==="playing"&&H.play("readysuper")),Xs[t]=vt}}function ke(t=xe){return t==="30_24"?!0:R}function ys(){Hn(ft.active),zn()}function cc(t){R=t,xe==="25_20"&&(R?ft.reset():(ft.deactivate(),Object.keys(ft.charges).forEach(o=>{ft.charges[o]=0})),On()),jn(),ys()}function jn(){Fs&&(Fs.style.display=ke()?"":"none",Hn(ft.active),zn())}function rc(t){let o=Rn(t),u=Fn(t);return!o||u<=0?!1:ft.charges[o]>=u}function ac(t){let o=Rn(t),u=Fn(t);return!o||u<=0||ft.charges[o]<u?!1:(ft.charges[o]-=u,ft.updateButtons(),me.pulse(),!0)}let $n=e.spellWave;function ai(){$n&&($n.classList.remove("active"),$n.offsetWidth,$n.classList.add("active"),setTimeout(()=>$n.classList.remove("active"),1200))}let gn=null,me=Do({button:Yt,onReady:()=>{H.play("readysuper")}}),li=()=>me.getEffect("earth"),di=()=>me.getEffect("air"),ui=()=>me.getEffect("fire"),Fn=t=>typeof me?.getCost=="function"?me.getCost(t):0,Rn=t=>ei[t]??null;gn=$o({canvas:n,dom:e,getGrid:()=>nt,getN:()=>i,getH:()=>s,getRotFloat:()=>gt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:ct,SIDE_MARGIN_PX:A,MAX_RADIUS_X:wt,SCORE_MAGIC_DESTROY:w},helpers:{normSector:ns,levelYToScreenY:Jn,sectorCenterXY:ts},Spell:me,Magic:ft,SoundModule:H,State:Ee,isGamePlaying:()=>$t==="playing",addPendingKzDrop:t=>{We+=t},getKillRate:g,triggerSpellWave:ai,spawnSpellBubbles:t=>{let o=Rn(me.currentSpell)??"water";pt.spawnSpellBubbles(me.button,o,t)},spawnBonusBubbles:t=>{In.spawnBonusBubbles(t)},getTransmuteEffect:li,getLightningEffect:di,getFireEffect:ui,continueMatchProcessing:es,updateScoreHud:Xn,showBonus:K,getSpellCost:Fn,getSpellElement:Rn,onUltimateApplied:t=>{let o=Rn(t)??Rn(me.currentSpell)??"water";if(typeof pt?.spawnSpellBubbles=="function"){let u=ci();u&&pt.spawnSpellBubbles(u,o,oi)}qn=!1,Ln=null,Hn(null),zn()},isSpellBlocked:fi,setScore:t=>{ce=t},setCascadeLevel:t=>{ln=t}});function Qn(){return xe==="30_24"}function Zn(){Hn(ft.active),zn()}let mn=[],Nn=0,rn=!1,vn=!1,An=!1,Ke=0,an=0,ln=0,wn=[];function fi(){return rn||vn||An}function Jn(t,o,u){let y=1-u/s;return t+y*o}function ts(t,o,u,y,D,st){let vt=(D-st)/i*d+a;return{x:t+Math.cos(vt)*u,y:o+Math.sin(vt)*y,ang:vt}}function Ss(t,o){let u=n.clientWidth,y=n.clientHeight,D=u*.5,st=(u-2*A)/2,vt=y-p-ct,Nt=6,pe=i*vt/(Nt*s),Oe=y-ct,Xe,Ce,he;pe<=Math.min(st,wt)?(Xe=pe,Ce=vt,he=p):(Xe=Math.min(st,wt),Ce=Xe*Nt*s/i,he=Oe-Ce);let Gt=Xe*.28,Tt=Jn(he,Ce,t+.5),ht=ts(D,Tt,Xe,Gt,o,gt),Ut=n.getBoundingClientRect();return{x:Ut.left+ht.x,y:Ut.top+ht.y}}function gi(t,o){if(!ke()||!ft.canUse()||rn)return!1;let u=_[ft.active],y=n.clientWidth,D=n.clientHeight,st=y*.5,vt=(y-2*A)/2,Nt=D-p-ct,pe=6,Oe=i*Nt/(pe*s),Xe=D-ct,Ce,he,Gt;Oe<=Math.min(vt,wt)?(Ce=Oe,he=Nt,Gt=p):(Ce=Math.min(vt,wt),he=Ce*pe*s/i,Gt=Xe-he);let Tt=Ce*.28,ht=null,Ut=1/0;for(let Te=0;Te<s;Te++){let De=Jn(Gt,he,Te+.5);for(let _e=0;_e<i;_e++){let Ye=nt[Te][_e];if(!Ye||Ye!==u)continue;let qe=ts(st,De,Ce,Tt,_e,gt);if(Math.sin(qe.ang)<-.1)continue;let us=t-qe.x,vo=o-qe.y,yo=Math.hypot(us,vo),So=he/s*.9,Xi=So*1.2;Math.abs(us)<Xi/2&&Math.abs(vo)<So/2&&yo<Ut&&(Ut=yo,ht={y:Te,s:_e})}}if(ht){let Te=Jn(Gt,he,ht.y+.5),De=ts(st,Te,Ce,Tt,ht.s,gt),_e=n.getBoundingClientRect(),Ye=_e.left+De.x,qe=_e.top+De.y,ho=_n[ft.active];return pt.spawnMagicShot(ft.active,ho,Ye,qe,()=>{let us=nt[ht.y][ht.s];mn=[{y:ht.y,s:ht.s,color:us,isLine:!1,isMagic:!0}],Nn=performance.now(),rn=!0,vn=!0,Ke=0,an=w,K(`+${w}`,"score")}),ln=0,ft.useCharge(),St.magicUsed++,!0}return!1}let lc=100;function dc(t,o){return Hs(t,o,s,i)}function mi(){return Xo(nt,s,i)}let pi=Yo;function hi(t){let o=t.map(y=>({...y,color:nt[y.y][y.s]}));for(let y of t)nt[y.y][y.s]=0;let u=s;for(let y of t){let D=y.y;for(let st=1;st<=y.y;st++){let vt=y.y-st;if(nt[vt][y.s]){D=st-1;break}}u=Math.min(u,D)}for(let y of o)nt[y.y-u][y.s]=y.color;return u>0}function vi(){let t=!0;for(;t;){t=!1;let o=mi();for(let u of o)pi(u)||hi(u)&&(t=!0)}}function yi(){es()}let Gn=Go;function Ws(t,o){let u=new Map,y=0,D=0,st=0,vt={},Nt=t.length+o.length;for(let Tt of t){let ht=It[Tt.color],Ut=0,Te=0;if(Tt.length>=5?(Ut=W,Te=Q,St.lines5++):Tt.length===4?(Ut=le,Te=Ae,St.lines4++):Tt.length===3&&(Ut=J,Te=zt,St.lines3++),ke()&&ht&&Ut>0){ft.addCharges(ht,Ut),vt[ht]=(vt[ht]||0)+Ut;let De=Tt.cells[Math.floor(Tt.cells.length/2)],_e=Ss(De.y,De.s),Ye=_n[ht];for(let qe=0;qe<Ut;qe++)setTimeout(()=>{pt.spawnMagicOrb(ht,_e.x,_e.y,Ye)},qe*100)}y+=Te*g(),st+=Te,D+=Tt.length*P;for(let De of Tt.cells){let _e=`${De.y},${De.s}`;u.has(_e)||u.set(_e,{y:De.y,s:De.s,color:Tt.color,isLine:!0})}}for(let Tt of o){if(St.pairs++,y+=tt*g(),st+=tt,D+=L,ke()){let ht=[...new Set(Tt.cells.map(Ut=>nt[Ut.y][Ut.s]).filter(Boolean))];if(ht.length>0){let Ut=Tt.cells[Math.floor(Tt.cells.length/2)],Te=Ss(Ut.y,Ut.s);ht.forEach((De,_e)=>{let Ye=It[De];if(!Ye)return;ft.addCharges(Ye,V),vt[Ye]=(vt[Ye]||0)+V;let qe=_n[Ye];qe&&setTimeout(()=>{pt.spawnMagicOrb(Ye,Te.x,Te.y,qe)},_e*100)})}}for(let ht of Tt.cells){let Ut=`${ht.y},${ht.s}`;u.has(Ut)||u.set(Ut,{y:ht.y,s:ht.s,color:nt[ht.y][ht.s],isLine:!1})}}let pe=Gn(k,Nt-1),Oe=Gn(v,Nt-1),Xe=Gn(at,ln),Ce=Gn(dt,ln),he=Math.round(D*pe*Xe);st=Math.round(st*Oe*Ce),y=Math.round(y*Oe*Ce);let Gt=0;Nt>1&&(St.combos++,St.maxCombo=Math.max(St.maxCombo,Nt),setTimeout(()=>K(`COMBO \xD7${Nt}`,"combo"),Gt),Gt+=180,H.play("combo2")),ln>0&&(St.cascades++,St.maxCascade=Math.max(St.maxCascade,ln),setTimeout(()=>K(`CASCADE \xD7${ln}`,"cascade"),Gt),Gt+=180,H.play("cascade")),(t.length>0||o.length>0)&&H.play("combo");for(let Tt of t){let ht=Tt.length,Ut=ht*P;setTimeout(()=>K(`Line-${ht} +${Ut}`,"line",Tt.color),Gt),Gt+=100}for(let Tt of o){let ht=Tt.cells.length>0?nt[Tt.cells[0].y][Tt.cells[0].s]:null;setTimeout(()=>K(`Pair +${L}`,"pair",ht),Gt),Gt+=100}he>0&&(setTimeout(()=>K(`+${he}`,"score"),Gt),Gt+=120),st>0&&(setTimeout(()=>K(`+${st}s`,"time"),Gt),Gt+=120);for(let[Tt,ht]of Object.entries(vt))ht>0&&(setTimeout(()=>K(`+${ht}${Et(Tt)}`,"charge"),Gt),Gt+=120);mn=Array.from(u.values()),Nn=performance.now(),rn=!0,vn=!1,Ke=y,an=he,On()}function Si(){for(let t of mn)nt[t.y][t.s]=0;if(mn.length>0&&H.playRandom("disappear"),Ke>0){We+=Ke;let t=Ke/g();In.spawnBonusBubbles(t)}Ee.addScore(an),ce+=an,Xn(),mn=[],rn=!1,vn=!1,Ke=0,an=0,ln++,es()}function es(){vi();let{lineMatches:t,pairMatches:o}=Ri();if(t.length>0||o.length>0)Ws(t,o);else{let u=Qs();u.length>0?_i(u):!yt&&$t==="playing"&&js()}}function uc(t,o){Ws(t,o)}function ns(t){return Pn(t,i)}function ss(){return ns(Math.round(gt))}function Vs(t,o){return $s(yt,t,o,nt,s,i)}function os(t){return Vs(t,ss())}let is=Uo;function Ks(){Ct&&(l!==0&&Xt>=l||(ye=0,Xt+=1))}function Ei(){if(!yt)return;let t=yt.cells,o=yt.colors,u={cells:t,colors:o};if(ie>=0||(u=is(u.cells,u.colors),u=is(u.cells,u.colors)),u=is(u.cells,u.colors),yt.cells=u.cells,yt.colors=u.colors,!os(Math.floor(kt))){yt.cells=t,yt.colors=o;return}H.play("turn"),Se&&Ks()}function bi(){return Wo(yt,kt,ss(),nt,s,i)}function Mi(){if(!yt)return!1;let t=Math.floor(kt)-1,o=!os(t);return o&&!Se?(Se=!0,ye=0,Xt=0):!o&&Se&&(Se=!1,ye=0,Xt=0),o}let Tn=ms;function Un(){if($t==="playing"){h.classList.add("hidden"),be.classList.remove("hidden");return}if(h.classList.remove("hidden"),be.classList.add("hidden"),$t==="intro"){G.classList.remove("hidden"),mt.classList.add("hidden");let t=et.loadHighscore(xe);t.score>0?(ae.textContent=t.score.toLocaleString(),ee.textContent=Tn(t.time)):(ae.textContent="0",ee.textContent="0:00"),ws(),cn.textContent=`v${je}`,Vt.classList.remove("idlePulse"),Vt.offsetWidth,Vt.classList.add("idlePulse")}else{G.classList.add("hidden"),mt.classList.remove("hidden"),Mt.textContent=ce.toLocaleString(),At.textContent=Tn(Ne);let t=et.loadHighscore(xe);ce>0&&ce>=t.score?on.classList.remove("hidden"):on.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${St.rings}</span>
          <span class="count ring-max">${St.maxRing>0?"max \xD7"+St.maxRing:""}</span>
        </div>
      `;xt.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${St.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${St.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${St.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${St.pairs}</span>
        </div>
      `;Ft.innerHTML=u;let y=ke()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${St.magicUsed}</span>
        </div>
      `:"",D=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${St.combos}</span>
          <span class="count max-combo">${St.maxCombo>0?"max \xD7"+St.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${St.cascades}</span>
          <span class="count max-cascade">${St.maxCascade>0?"max \xD7"+St.maxCascade:""}</span>
        </div>
        ${y}
      `;Pe.innerHTML=D}}function Xn(){Ve.textContent=`Score: ${ce}`}function Es(){en.textContent=`Time: ${Tn(Ne)}`}function qs(){let t=Math.max(0,(s-$e)/g()),o=Math.floor(t/60),u=Math.floor(t%60);ge.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?ge.classList.add("warning"):ge.classList.remove("warning")}function xi(){m(xe),z(),$e=0,We=0,gt=fe=0,Wt=0,Ee.start(),St=Ee.stats,ce=0,En=performance.now(),Ne=0,bn=0,dn=0,$t="playing",Qe=null,ke()?ft.reset():(ft.deactivate(),Object.keys(ft.charges).forEach(t=>{ft.charges[t]=0}),On()),me.reset(),Zn(),mn=[],wn=[],rn=!1,vn=!1,An=!1,Ke=0,an=0,ln=0,gn.reset(),On(),Xn(),Es(),qs(),ys(),js(),In.drawNextPreview(te,Qe),Un(),H.getSettings().musicEnabled&&H.startGameMusic()}function bs(){Ee.gameOver(),$t="gameover",yt=null,Se=!1,ye=0,Xt=0;let t=et.saveHighscore(ce,Ne,xe);H.stopMusic(),H.play("gameover"),Es(),Un(),t&&ce>0&&setTimeout(()=>{K("\u{1F3C6} NEW RECORD!","score")},500)}function Ci(t){for(let u=0;u<50;u++){let y=t.map(()=>1+(Math.random()*4|0));if(!Ti(t,y))return y}return t.map((u,y)=>1+y%4)}let Ti=qo;function zs(t){let o=t.cells.map(y=>({x:y.x,y:y.y})),u=Ci(o);return{name:t.name,cells:o,colors:u}}function js(){if(!Qe){let D=ue[Math.random()*ue.length|0];Qe=zs(D)}yt=Qe;let t=ue[Math.random()*ue.length|0];Qe=zs(t),In.drawNextPreview(te,Qe);let o=1/0,u=-1/0;for(let D of yt.cells)D.x<o&&(o=D.x),D.x>u&&(u=D.x);let y=(o+u)/2;for(let D of yt.cells)D.x=D.x-Math.round(y);kt=s+3,He=0,Se=!1,ye=0,Xt=0,os(Math.floor(kt))?H.playRandom("appear"):bs()}function Qs(){return Ko(nt,s,i)}function _i(t){if(t.length===0)return;let o=[];for(let Nt of t)for(let pe=0;pe<i;pe++)o.push({y:Nt,s:pe,color:nt[Nt][pe],isLine:!1});wn=t,mn=o,Nn=performance.now(),rn=!0,An=!0,vn=!1;let u=t.length;St.rings+=u,St.maxRing=Math.max(St.maxRing,u);let y=Gn(U,u-1),D=Math.round(de*u*y),st=ot*u;if(an=D,Ke=st*g(),ke()){for(let[Nt,pe]of Object.entries(ut))if(pe>0){let Oe=pe*u;ft.addCharges(Nt,Oe);let Xe=Math.floor(i/2),Ce=t[0],he=Ss(Ce,Xe),Gt=_n[Nt];if(Gt)for(let Tt=0;Tt<Oe;Tt++)setTimeout(()=>{pt.spawnMagicOrb(Nt,he.x,he.y,Gt)},Tt*100)}}H.play("ring");let vt=`RING \xD7${u}`;K(vt,"ring"),setTimeout(()=>K(`+${D}`,"score"),150),setTimeout(()=>K(`+${st}s`,"time"),300)}function Li(){let t=[...wn].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<s-1;u++)nt[u].set(nt[u+1]);nt[s-1].fill(0)}if(Ke>0){We+=Ke;let o=Ke/g();In.spawnBonusBubbles(o)}Ee.addScore(an),ce+=an,Xn(),xe==="30_24"&&wn.length>0&&(Jt=et.addHighTowerRings(wn.length)),mn=[],wn=[],rn=!1,An=!1,Ke=0,an=0,es()}function fc(){return Qs().length}function Bi(){if(!yt)return;let t=ss();gt=t,fe=t,Wt=0;let o=!1;for(let u=0;u<yt.cells.length;u++){let y=yt.cells[u],D=yt.colors[u],st=Math.floor(kt)+y.y,vt=ns(t+y.x);st>=s&&(o=!0),st>=0&&st<s&&(nt[st][vt]=D)}if(o){bs();return}Ee.addScore(Le),ce+=Le,Xn(),K(`+${Le}`,"score"),H.playRandom("drop"),yt=null,ln=0,yi()}function Ri(){return Vo(nt,s,i)}function Ai(){if(!yt)return!1;let t=Math.floor(kt)-1;return os(t)?(kt=t,Se=!1,ye=0,Xt=0,!0):(Se=!0,!1)}n.addEventListener("pointerdown",t=>{if(Dt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),u=t.clientX-o.left,y=t.clientY-o.top;Fe.handlePointerDown(t,{onMagicTap:ke()?()=>gn.handleTap(u,y)?!0:Dt.applyCommand("magic_shoot",{x:u,y}):null,onDoubleTap:()=>Dt.applyCommand("rotate_piece")},fe)||(Wt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Dt.state!=="playing"||!Fe.dragging)return;t.preventDefault?.();let o=Fe.handlePointerMove(t,{canRotateTo:(u,y)=>Dt.canRotateTo(u,y),onDrop:()=>Dt.applyCommand("move_down"),onGroundedMove:()=>Dt.onGroundedMove(),onRotateStep:()=>b.trigger("tower_rotate")},Dt.pieceY,Dt.isGrounded);o&&Dt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Dt.state==="playing"&&Fe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Fe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Fe.dragging&&Fe.handlePointerUp(t)},{passive:!1}),C.addEventListener("click",()=>{Dt.state==="playing"&&Dt.applyCommand("rotate_piece")});let cs=e.dropBtn,rs=null;function wi(){Dt.state==="playing"&&(Dt.applyCommand("move_down"),rs=setInterval(()=>{if(Dt.state!=="playing"){as();return}Dt.applyCommand("move_down")},lt))}function as(){rs&&(clearInterval(rs),rs=null)}cs.addEventListener("pointerdown",t=>{t.preventDefault(),wi()}),cs.addEventListener("pointerup",as),cs.addEventListener("pointerleave",as),cs.addEventListener("pointercancel",as);for(let[t,o]of Object.entries(_n))o.addEventListener("click",()=>{Dt.state==="playing"&&ke()&&Dt.applyCommand("select_magic",{element:t})});Yt&&Yt.addEventListener("click",()=>{if(Dt.state!=="playing"||!Qn()||!ke())return;let t=ft.active??Ln;if(!t)return;let o=hs[t];!o||!Kn(o)||(me.selectSpell(o),ft.active&&(Ln=ft.active,qn=!0,ft.deactivate()),gn.handleSpellButtonClick())});let Ms=e.soundsToggle,xs=e.musicToggle;function yn(){let t=H.getSettings();t.soundsEnabled?Ms.classList.add("active"):Ms.classList.remove("active"),t.musicEnabled?xs.classList.add("active"):xs.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],y=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),y&&y.classList.toggle("active",t.musicVolume===o)}}let Zs=e.tabBtns,Ii=e.tabContents;Zs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;Zs.forEach(u=>u.classList.remove("active")),Ii.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Ro(o).classList.add("active"),o==="sounds"&&yn()})});let Js=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,to=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Pi=e.iosHint,ki=e.standaloneBadge;function eo(){let t=document.fullscreenElement||document.webkitFullscreenElement;I.textContent=t?"Disable":"Enable"}Js&&(to?(ki.style.display="block",I.style.display="none"):(Pi.style.display="block",I.textContent="Not supported",I.style.opacity="0.5",I.style.cursor="default")),I.addEventListener("click",()=>{if(Js&&!to)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",eo),document.addEventListener("webkitfullscreenchange",eo);let ls=e.invertSwipeToggle,pn=e.hapticsToggle;it.invertSwipe&&ls.classList.add("active"),pn&&(b.supports()?it.hapticsEnabled&&pn.classList.add("active"):(pn.classList.add("disabled"),pn.classList.remove("active"),it.hapticsEnabled=!1,b.setEnabled(!1),et.saveGameSettings(it))),ls.addEventListener("click",()=>{ls.classList.toggle("active");let t=ls.classList.contains("active");Fe.rotDir=t?-1:1,it.invertSwipe=t,et.saveGameSettings(it)}),pn&&pn.addEventListener("click",()=>{if(pn.classList.contains("disabled"))return;pn.classList.toggle("active");let t=pn.classList.contains("active");it.hapticsEnabled=t,et.saveGameSettings(it),b.setEnabled(t)}),Ms.addEventListener("click",()=>{let o=!H.getSettings().soundsEnabled;H.updateSettings({soundsEnabled:o}),yn(),Yn()}),xs.addEventListener("click",()=>{let o=!H.getSettings().musicEnabled;H.updateSettings({musicEnabled:o}),yn(),Yn(),$t!=="paused"&&(o?$t==="playing"?H.startGameMusic():H.startMenuMusic():H.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{H.updateSettings({soundVolume:t}),yn(),H.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{H.updateSettings({musicVolume:t}),yn()})}yn();function no(){$t==="playing"&&(Ee.pause(),dn=performance.now(),$t="paused",H.musicAudio&&H.musicAudio.pause())}function ds(){$t==="paused"&&(Ee.resume(),bn+=performance.now()-dn,dn=0,$t="playing",_s=performance.now(),H.getSettings().musicEnabled&&H.startGameMusic())}function Yn(){let t=H.getSettings();sn.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",sn.classList.toggle("off",!t.soundsEnabled),Be.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Be.classList.toggle("off",!t.musicEnabled)}function Oi(){Me.classList.remove("hidden"),be.classList.add("hidden");let t=et.loadHighscore(xe);if(Ge.textContent=t.score?t.score.toLocaleString():"0",hn.textContent=t.time?ms(t.time):"0:00",re.textContent=xe==="30_24"?"High Tower":"Quick Tower",xn.textContent=ce.toLocaleString(),Ie.textContent=ms(Ne),Ue.textContent=xe==="30_24"?"High Tower":"Quick Tower",Yn(),ro){let o=xe==="30_24";ro.style.display=o?"":"none",o&&ws()}}function Wn(){Me.classList.add("hidden"),be.classList.remove("hidden")}be.addEventListener("click",()=>{no(),Oi()}),un.addEventListener("click",()=>{Wn(),ds()});let Cs=null;function so(t,o){O.textContent=t,Cs=o,x.classList.remove("hidden")}function oo(){x.classList.add("hidden"),Cs=null}Z.addEventListener("click",()=>{oo()}),X.addEventListener("click",()=>{let t=Cs;oo(),t&&t()}),Mn.addEventListener("click",()=>{so("Restart game?",()=>{Wn(),Dt.applyCommand("start_game")})}),fn.addEventListener("click",()=>{so("Exit to menu?",()=>{Wn(),be.classList.add("hidden"),$t="intro",Ee.reset(),H.stopMusic(),H.getSettings().musicEnabled&&H.startMenuMusic(),Un()})}),Qt.addEventListener("click",()=>{N.classList.remove("hidden")}),sn.addEventListener("click",()=>{let t=H.getSettings();H.updateSettings({soundsEnabled:!t.soundsEnabled}),Yn(),yn()}),Be.addEventListener("click",()=>{let o=!H.getSettings().musicEnabled;H.updateSettings({musicEnabled:o}),Yn(),yn()}),Me.addEventListener("click",t=>{t.target===Me&&(Wn(),ds())}),document.addEventListener("keydown",t=>{$t==="paused"&&!Me.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Wn(),ds())}),Y.addEventListener("click",()=>{N.classList.add("hidden")}),N.addEventListener("click",t=>{t.target===N&&N.classList.add("hidden")});let Ts=!1;document.addEventListener("visibilitychange",()=>{document.hidden?$t==="playing"&&(no(),Ts=!0):Ts&&$t==="paused"&&(ds(),Ts=!1)});let Dt=zo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Pt,LOCK_DELAY_SEC:_t,getKillRate:g,MATCH_HIGHLIGHT_SEC:Lt,MAGIC_SHRINK_SEC:se,RING_HIGHLIGHT_SEC:Bt,getState:()=>({gameState:$t,score:ce,elapsedMs:Ne,startTime:En,totalPausedMs:bn,stats:St,activePiece:yt,pieceY:kt,targetRot:fe,rotFloat:gt,rotVel:Wt,isGrounded:Se,isHighlighting:rn,isMagicAnimation:vn,isRingAnimation:An,highlightStartTime:Nn,killLevel:$e,grid:nt,fallTimer:He,lockTimer:ye}),setState:t=>{"elapsedMs"in t&&(Ne=t.elapsedMs),"killLevel"in t&&($e=t.killLevel),"fallTimer"in t&&(He=t.fallTimer),"lockTimer"in t&&(ye=t.lockTimer),"targetRot"in t&&(fe=t.targetRot),"rotFloat"in t&&(gt=t.rotFloat),"rotVel"in t&&(Wt=t.rotVel)},funcs:{startGame:xi,endGame:bs,rotatePieceByDir:Ei,tryMoveDown:Ai,canPlaceAtRot:Vs,maybeResetLockDelay:Ks,shootMagic:gi,selectMagic:ti,updateGroundedState:Mi,lockPiece:Bi,finishHighlight:Si,finishRingHighlight:Li},ui:{updateTimeHud:Es,updateRemainingHud:qs}}),In=jo({canvas:n,canvasCtx:r,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:ct,SIDE_MARGIN_PX:A,MAX_RADIUS_X:wt,RADIUS_X_FACTOR:ve,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:Lt,MATCH_SHRINK_PHASE:Ht,MAGIC_SHRINK_SEC:se,RING_HIGHLIGHT_SEC:Bt,LOCK_DELAY_SEC:_t,getKillRate:g,ELEMENT_COLORS:Rt,ELEMENT_TO_COLOR:_,BLOCK_COLOR_FRONT:rt,BLOCK_COLOR_BACK:$,ACTIVE_COLOR_FRONT:bt,GHOST_COLOR_FILL:ne,GHOST_COLOR_STROKE:Ot,GHOST_STROKE_WIDTH:qt,MAGIC_DIM_DOT_ALPHA:Zt,MAGIC_DIM_DOT_SCALE:F,MAGIC_TARGET_DOT_SCALE:oe,getState:()=>({gameState:$t,grid:nt,activePiece:yt,pieceY:kt,rotFloat:gt,killLevel:$e,isHighlighting:rn,highlightedCells:mn,highlightStartTime:Nn,isMagicAnimation:vn,isRingAnimation:An,isGrounded:Se,lockTimer:ye,spellState:gn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Sn,waterColor:kn}),funcs:{snappedRot:ss,computeGhostY:bi,normSector:ns,getMagicTargetColor:()=>ke()&&ft.canUse()?_[ft.active]:null,getTransmuteAnimState:t=>gn.getTransmuteAnimState(t),getLightningAnimState:t=>gn.getLightningAnimState(t),getFireAnimState:t=>gn.getFireAnimState(t)}}),_s=performance.now();function io(t){let o=Math.min(.05,Math.max(.001,(t-_s)/1e3));if(_s=t,Dt.update(o,t),gn.update(t),We>0){let u=Math.min(We,jt*o);$e=Math.max(0,$e-u),We-=u}gt=fe,gt>1e6&&(gt%=i),gt<-1e6&&(gt%=i),In.render(o,t),requestAnimationFrame(io)}Vt.addEventListener("click",()=>{Dt.applyCommand("start_game")}),Cn.addEventListener("click",()=>{Dt.applyCommand("start_game")}),Re.addEventListener("click",()=>{$t="intro",Ee.reset(),H.stopMusic(),H.getSettings().musicEnabled&&H.startMenuMusic(),Un()}),Ze.forEach(t=>{t.addEventListener("click",o=>{Ze.forEach(y=>y.classList.remove("active")),t.classList.add("active"),xe=t.dataset.mode,Zn(),jn();let u=et.loadHighscore(xe);u.score>0?(ae.textContent=u.score.toLocaleString(),ee.textContent=Tn(u.time)):(ae.textContent="0",ee.textContent="0:00"),Vt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>Vt.classList.add("idlePulse"),2e3)})});let Ls=document.querySelectorAll(".spell-select-btn"),Bs=document.getElementById("spellDesc"),Di=document.getElementById("spellProgressFill"),co=document.getElementById("spellProgressMarkers"),ro=document.getElementById("pauseSpellProgress"),Hi=document.getElementById("pauseSpellProgressFill"),ao=document.getElementById("pauseSpellProgressMarkers"),lo=document.getElementById("pauseSpellProgressLabel");function Rs(){return ni.map(t=>Dn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function As(t){return t.length?Math.max(...t):0}function $i(t){let o=Rs(),u=As(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function uo(t){if(!t)return;t.innerHTML="";let o=Rs(),u=As(o);o.forEach(y=>{let D=document.createElement("span");D.className="marker",D.dataset.threshold=y;let st=u>0?y/u*100:0;D.style.left=`${st}%`,t.appendChild(D)})}function fo(t,o){if(!t)return;let u=Fi(o);t.style.width=`${u}%`}function go(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(y=>{let D=parseInt(y.dataset.threshold,10)||0;y.classList.toggle("reached",o>=D)})}function Fi(t){let o=Rs(),u=As(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function mo(t){if(!Bs)return;let o=Dn(t),u=me.getDescription(t);o===0||Jt>=o?Bs.innerHTML=u:Bs.innerHTML=`${u} <span class="spell-progress-text">${Jt}/${o}</span>`}function ws(){Jt=et.loadHighTowerRings(),Ls.forEach(o=>{let u=o.dataset.spell,y=Dn(u),D=Jt>=y;o.classList.toggle("locked",!D);let st=o.querySelector(".spell-lock");st&&(st.style.display=D?"none":"")}),fo(Di,Jt),fo(Hi,Jt),go(co,Jt),go(ao,Jt),lo&&(lo.textContent=$i(Jt));let t=document.querySelector(".spell-select-btn.active");t&&mo(t.dataset.spell)}uo(co),uo(ao),ws(),Ls.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){Ze.forEach(Nt=>Nt.classList.remove("active")),u.classList.add("active"),xe="30_24",Zn(),jn();let vt=et.loadHighscore(xe);vt.score>0?(ae.textContent=vt.score.toLocaleString(),ee.textContent=Tn(vt.time)):(ae.textContent="0",ee.textContent="0:00")}let y=t.dataset.spell,D=Dn(y),st=Jt>=D;mo(y),st&&(Ls.forEach(vt=>vt.classList.remove("active")),t.classList.add("active"),me.selectSpell(y),Hn(ft.active))})}),ps.addEventListener("click",()=>{let t=et.loadHighscore("30_24"),o=et.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Tn(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Tn(o.time)}
`:`  No record yet
`,alert(u)}),Vn.addEventListener("click",()=>{N.classList.remove("hidden")}),On(),jn(),Zn(),Un(),H.startMenuMusic();let Ni=()=>{if(H.unlock(),!H.getSettings().musicEnabled)return;let t=H.musicAudio;!t||t.paused||t.ended?Dt.state==="playing"?H.startGameMusic():H.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},po=0,Gi=10,Ui=()=>{po>=Gi||(po++,Ni())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Ui,{passive:!0})}),requestAnimationFrame(io)})();})();
