(()=>{var qi=[0,.25,.5,.75,1],zi=[0,.05,.15,.25,.5],ji={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},xo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Co="soundSettings";function Qi(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Zi(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function To(){return{audioContext:null,buffers:{},settings:Qi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),a=this.audioContext.createBufferSource();a.buffer=n,a.connect(this.audioContext.destination),a.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return qi[this.settings.soundVolume]},getMusicVolume(){return zi[this.settings.musicVolume]},async loadSound(n,a){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(a)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(d){console.debug(`Failed to load sound: ${n} from ${a}`,d)}},preload(){this.initContext();for(let[n,a]of Object.entries(ji))this.loadSound(n,a)},play(n,a=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;a!==null&&(d=`${n}${a}`);let i=this.buffers[d];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let a=1+Math.floor(Math.random()*3);this.play(n,a)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(a=>{console.debug("Menu music autoplay blocked:",a)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(a=>{console.debug("Game music play failed:",a)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Zi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(a=>{console.debug("Music resume failed:",a)}):this.stopMusic()}catch(a){console.debug("Update music settings failed:",a)}},getSettings(){return{...this.settings}}}}var _o="eb_highscore",Lo="eb_highscore_quick",Bo="eb_settings",Ro="eb_high_tower_rings",Ji={invertSwipe:!1,hapticsEnabled:!0,showControls:!0,tapRotate:!1};function wo(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Lo:_o,a=localStorage.getItem(n);if(a)return JSON.parse(a)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,a="30_24"){try{let d=this.loadHighscore(a);if(e>d.score||e===d.score&&n>d.time){let i=a==="25_20"?Lo:_o;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Bo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Ji}},saveGameSettings(e){try{localStorage.setItem(Bo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Ro);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Ro,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let a=this.loadHighTowerRings()+e;return this.saveHighTowerRings(a),a}}}function Ao(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),controlsRight:document.querySelector(".controls-right"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),showControlsToggle:document.getElementById("showControlsToggle"),tapRotateToggle:document.getElementById("tapRotateToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Io(e){return document.getElementById("tab-"+e)}var tc={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Po(e={}){let{elementColors:n={}}=e,a=0;return{showBonus(d,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=d,s&&n[s]&&(c.style.color=n[s]);let f=window.innerWidth/2,p=window.innerHeight/2-40,g=(Math.random()-.5)*200,r=(Math.random()-.5)*100+a*36;c.style.left=`${f+g}px`,c.style.top=`${p+r}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),a++,setTimeout(()=>{a=Math.max(0,a-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(d){return tc[d]||"\u2726"}}}var ks={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function ko(){return{spawnMagicOrb(e,n,a,d){if(!d)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=ks[e]||"\u2726";let s=d.getBoundingClientRect(),c=s.left+s.width/2-n,f=s.top+s.height/2-a,p=Math.hypot(c,f),g=Math.atan2(f,c),r=p*.35*(Math.random()>.5?1:-1),m=g+Math.PI/2,S=c*.5+Math.cos(m)*r,w=f*.5+Math.sin(m)*r;i.style.setProperty("--mid-x",`${S}px`),i.style.setProperty("--mid-y",`${w}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${f}px`),i.style.left=`${n}px`,i.style.top=`${a}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,a,d,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,f=s.top+s.height/2,p=document.createElement("div");p.className=`magic-shot ${e}`,p.textContent=ks[e]||"\u2726";let g=a-c,r=d-f;p.style.setProperty("--end-x",`${g}px`),p.style.setProperty("--end-y",`${r}px`),p.style.left=`${c}px`,p.style.top=`${f}px`,document.body.appendChild(p);let m=setInterval(()=>{let S=p.getBoundingClientRect();this.spawnTrailParticle(e,S.left+S.width/2,S.top+S.height/2)},40);setTimeout(()=>{clearInterval(m),p.remove(),this.spawnExplosion(e,a,d),i&&i()},300)},spawnTrailParticle(e,n,a){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${n}px`,d.style.top=`${a}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,n,a){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,f=40+Math.random()*40,p=Math.cos(c)*f,g=Math.sin(c)*f;s.style.setProperty("--px",`${p}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${a}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",a=18){if(!e)return;let d=n;typeof n=="number"&&(a=n,d="water"),ks[d]||(d="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,f=Math.max(8,Math.round(a));for(let p=0;p<f;p++){let g=document.createElement("div");g.className=`spell-bubble ${d}`,g.textContent="\u25CF";let r=p/f*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,S=Math.cos(r)*m,w=Math.sin(r)*m-20;g.style.setProperty("--px",`${S}px`),g.style.setProperty("--py",`${w}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,a){if(!a)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let i=a.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,f=Math.hypot(s,c),p=Math.atan2(c,s),g=f*.35*(Math.random()>.5?1:-1),r=p+Math.PI/2,m=s*.5+Math.cos(r)*g,S=c*.5+Math.sin(r)*g;d.style.setProperty("--mid-x",`${m}px`),d.style.setProperty("--mid-y",`${S}px`),d.style.setProperty("--end-x",`${s}px`),d.style.setProperty("--end-y",`${c}px`),d.style.left=`${e}px`,d.style.top=`${n}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}var ec=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Oo=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,nc=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function sc(e){let n=e.querySelector(".ring"),a=e.querySelector(".falling-figure"),d=e.querySelector(".clock");if(!n||!a||!d)return()=>{};let i=!1,s=[],c=[],f=(N,W)=>{let at=setTimeout(()=>{i||N()},W);return s.push(at),at},p=(N,W)=>{let at=setInterval(()=>{if(i){clearInterval(at);return}N()},W);return c.push(at),at},g=48,r=.9,m=9,S=9,w=3,Z=2,U=18,pt=-12,Xt=.5,ye=12,zt=10,xt=["--fire","--water","--light","--earth"],Wt=["--light","--fire","--water"],rt=3,j=Math.floor(m/2)-1,Ct=8e3,wt=[];function It(N,W){let at=(W-1)/2,Ht=Math.abs(N-at)/at;return 1-(1-Xt)*Ht}function M(N,W,at,Ht){let oe=(W-1)/2,q=Math.abs(N-oe)/oe;return Ht?q*at:-q*at}function Pt(){n.innerHTML="";let N=[],W=[];for(let ct=0;ct<S;ct++)W.push(g*r*It(ct,S));let at=W.reduce((ct,Tt)=>ct+Tt,0)+(S-1)*Z,Ht=[];for(let ct=0;ct<m;ct++)Ht.push(g*It(ct,m));let oe=Ht.reduce((ct,Tt)=>ct+Tt,0)+(m-1)*w,q=-at/2;for(let ct=0;ct<S;ct++){let Tt=W[ct],Ot=g*r,ue=m+ct,Lt=M(ct,S,zt,!0),te=document.createElement("div");te.className="block back",te.style.cssText=`left:${q.toFixed(1)}px;top:${(pt-Ot/2+Lt).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Ot.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let H=document.createElement("div");H.className="dot";let ie=r*It(ct,S);H.style.cssText=`--c:var(${xt[ue%4]});transform:scale(${ie.toFixed(2)});`,te.appendChild(H),te.dataset.index=ue,n.appendChild(te),N[ue]=te,q+=Tt+Z}let st=-oe/2;for(let ct=0;ct<m;ct++){let Tt=Ht[ct],Ot=g,ue=ct,Lt=M(ct,m,ye,!1),te=ue>=j&&ue<j+rt,H=document.createElement("div");H.className="block",te&&H.classList.add("gap"),H.style.cssText=`left:${st.toFixed(1)}px;top:${(U-Ot/2+Lt).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Ot.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let ie=document.createElement("div");ie.className="dot";let He=It(ct,m);ie.style.cssText=`--c:var(${xt[ue%4]});transform:scale(${He.toFixed(2)});`,H.appendChild(ie),H.dataset.index=ue,n.appendChild(H),N[ue]=H,st+=Tt+w}wt=N}function Dt(){let N=[];for(let W=j-1;W>=0;W--)N.push(W);for(let W=0;W<S;W++)N.push(m+W);for(let W=m-1;W>=j;W--)N.push(W);return N}function _t(){wt.forEach((N,W)=>{N&&(N.classList.remove("hi","vanish","gap"),N.style.opacity="",N.style.transform="",W>=j&&W<j+rt&&N.classList.add("gap"))})}function l(){for(let N=0;N<rt;N++){let W=wt[j+N];if(W){W.classList.remove("gap");let at=W.querySelector(".dot");if(at){let Ht=It(j+N,m);at.style.cssText=`--c:var(${Wt[N]});transform:scale(${Ht.toFixed(2)});`}}}}function et(N){let W=Dt(),at=0,Ht=W.length,oe=p(()=>{if(at>0&&at<=Ht){let q=wt[W[at-1]];q&&q.classList.remove("hi")}if(at<Ht){let q=wt[W[at]];q&&q.classList.add("hi"),at++}else clearInterval(oe),wt.forEach(q=>{q&&q.classList.add("hi")}),f(N,300)},30)}function nt(N){let W=Dt(),at=W.length;W.forEach((Ht,oe)=>{let q=wt[Ht];q&&f(()=>{q.classList.add("vanish")},oe*40)}),f(N,at*40+500)}function Jt(){i||(_t(),a.classList.add("active"),f(()=>{l(),a.classList.remove("active"),a.style.opacity="0",f(()=>{et(()=>{i||(d.classList.add("show"),f(()=>{nt(()=>{i||(d.classList.remove("show"),a.style.opacity="",f(Jt,500))})},400))})},200)},Ct*.38))}return Pt(),Jt(),()=>{i=!0,s.forEach(clearTimeout),c.forEach(clearInterval)}}var oc=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:ec},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Oo},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:nc,onEnter:e=>sc(e)}];function Do(e={}){let{helpBtn:n,mount:a=document.body,combosTemplate:d}=e;if(!n||!a)return{open(){},close(){},setCombosTemplate(){}};let i=oc.map(M=>({...M}));typeof d=="string"&&d.trim()&&(i[1].illustrationHtml=d);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,a.appendChild(s);let c=s.querySelector(".help-next-btn"),f=s.querySelector(".help-slide-title"),p=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),r=s.querySelector(".help-dots"),m=i.map(()=>{let M=document.createElement("span");return M.className="help-dot",r.appendChild(M),M}),S=0,w=!1,Z=null,U=null,pt=180,Xt=560,ye=460,zt=480,xt=M=>{U&&(U(),U=null);let Pt=i[M];Pt&&(S=M,f.textContent=Pt.title,p.textContent=Pt.text,g.innerHTML=Pt.illustrationHtml||"",m.forEach((Dt,_t)=>{Dt.classList.toggle("active",_t===M)}),c.textContent=M===i.length-1?"Done":"Next",Wt(),Pt.onEnter&&(U=Pt.onEnter(g)))},Wt=()=>{if(!w||s.classList.contains("hidden"))return;let M=g.getBoundingClientRect();if(!M.width||!M.height)return;let Pt=g.querySelector(".help-combos");if(Pt){let l=Math.min(1,Math.min(M.width,M.height)/Xt);Pt.style.setProperty("--help-combos-scale",l.toFixed(3))}let Dt=g.querySelector(".help-controls");if(Dt){let l=Math.min(1,Math.min(M.width,M.height)/ye);Dt.style.setProperty("--help-controls-scale",l.toFixed(3))}let _t=g.querySelector(".help-rings");if(_t){let l=Math.min(1,Math.min(M.width,M.height)/zt);_t.style.setProperty("--help-rings-scale",l.toFixed(3))}},rt=()=>{w&&Wt()},j=M=>{w&&M.stopPropagation()},Ct=M=>{if(w){if(M.key==="Escape"){M.preventDefault(),M.stopPropagation(),M.stopImmediatePropagation?.(),It();return}M.preventDefault(),M.stopPropagation(),M.stopImmediatePropagation?.()}},wt=()=>{w||(w=!0,Z&&(clearTimeout(Z),Z=null),xt(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),Wt()}),document.addEventListener("keydown",Ct,!0),window.addEventListener("resize",rt))},It=()=>{w&&(w=!1,U&&(U(),U=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",Ct,!0),window.removeEventListener("resize",rt),Z=window.setTimeout(()=>{s.classList.add("hidden")},pt))};return s.addEventListener("click",M=>{w&&(M.target===s&&It(),M.stopPropagation())}),s.addEventListener("pointerdown",j),s.addEventListener("pointerup",j),s.addEventListener("touchstart",j,{passive:!0}),s.addEventListener("touchmove",M=>{w&&(M.preventDefault(),M.stopPropagation())},{passive:!1}),s.addEventListener("wheel",M=>{w&&(M.preventDefault(),M.stopPropagation())},{passive:!1}),c.addEventListener("click",M=>{M.stopPropagation(),S<i.length-1?xt(S+1):It()}),n.addEventListener("click",M=>{M.preventDefault(),wt()}),{open:wt,close:It,setCombosTemplate(M){typeof M=="string"&&(i[1].illustrationHtml=M.trim()||Oo,w&&S===1&&xt(1))}}}var ic={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function cc(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Os=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let a=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return a?(navigator.vibrate(a),!0):!1}},Ds=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Ho({enabled:e=!0,patterns:n=ic}={}){let a=cc(),d=a?new Ds(a):new Os,i=d.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let f=n[c];return f?d.trigger({name:c,...f}):!1}}}function Fo(e={}){let{buttons:n={},onActivate:a=null,onChange:d=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[p,g]of Object.entries(n)){if(!g)continue;let r=i[p],m=g.querySelector(".charges");m&&(m.textContent=r),g.classList.toggle("empty",r<=0),g.classList.toggle("active",s===p&&r>0)}d&&d({...i},s)}function f(p){let g=n[p];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(p){s=p},select(p){if(i[p]<=0)return!1;let g=s===p;return s=g?null:p,c(),!g&&s===p&&a&&a(),!g},useCharge(){if(!s||i[s]<=0)return!1;let p=s;return i[p]--,s=null,c(),f(p),!0},addCharges(p,g){i[p]!==void 0&&(i[p]+=g,c(),f(p))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(p){for(let[g,r]of Object.entries(n))r&&r.addEventListener("click",()=>{p&&p(g)})}}}var Je={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function $o(e={}){let{button:n=null,onActivate:a=null,onProgress:d=null,onReady:i=null}=e,s="ice",c=0;function f(){return Je[s]||Je.ice}function p({silent:r=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let m=f(),S=Number.isFinite(m.maxProgress)?m.maxProgress:0,w=S>0?Math.min(c/S,1)*100:0,Z=S>0&&c>=S;n.style.setProperty("--progress",`${w}%`);let U=n.querySelector(".spell-icon");U&&(U.textContent=m.icon);let pt=n.querySelector(".spell-counter");pt&&(pt.textContent=S>0?`${Math.min(c,S)}/${S}`:""),n.classList.toggle("ready",Z),n.classList.toggle("charging",!Z&&c>0),d&&!r&&S>0&&d(c,S)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return f().maxProgress??0},get isReady(){let r=f().maxProgress;return Number.isFinite(r)&&r>0&&c>=r},get effect(){return f().effect},getUnlockRings(r){return(Je[r]||Je.ice).unlockRings??0},getCost(r){return(Je[r]||Je.ice).cost??0},getDescription(r){return(Je[r]||Je.ice).description||""},getEffect(r){return(Je[r]||Je.ice).effect},get button(){return n},selectSpell(r){Je[r]&&(s=r,c=0,p())},addProgress(r=1){let m=f();if(!Number.isFinite(m.maxProgress)||m.maxProgress<=0||c>=m.maxProgress)return!1;let S=c<m.maxProgress;return c=Math.min(c+r,m.maxProgress),p(),g(),S&&c>=m.maxProgress&&i&&i(),!0},setProgress(r,{silent:m=!1}={}){c=Math.max(0,r),p({silent:m})},canUse(){let r=f().maxProgress;return Number.isFinite(r)&&r>0&&c>=r},use(){if(!this.canUse())return null;let r=f().effect;return c=0,p(),g(),a&&a(s),r},reset(){c=0,p()},pulse(){g()},updateButton:p,initButton(r){n&&n.addEventListener("click",()=>{r&&r()})}}}function Hs({centerY:e,centerS:n,size:a,H:d,normSector:i}){let s=[],c=Math.floor(a/2);for(let f=-c;f<=c;f++)for(let p=-c;p<=c;p++){let g=e+f,r=i(n+p);if(g<0||g>=d)continue;let m=f*f+p*p;s.push({y:g,s:r,distSq:m})}return s}function ps(e,n,a){return n.filter(d=>e[d.y][d.s]===a)}function ms(e,n){return[...e].sort((d,i)=>d.distSq!==i.distSq?d.distSq-i.distSq:d.y!==i.y?d.y-i.y:d.s-i.s).slice(0,n).map(d=>({y:d.y,s:d.s}))}function No({centerY:e,centerS:n,beamLength:a,N:d,H:i,normSector:s}){if(e<0||e>=i||a<0||d<=0)return[];let c=[],f=new Set,p=(r,m)=>`${r},${m}`,g=s(n);c.push({y:e,s:g,dist:0}),f.add(p(e,g));for(let r=1;r<=a;r++){let m=s(n+r),S=p(e,m);f.has(S)||(c.push({y:e,s:m,dist:r}),f.add(S));let w=s(n-r),Z=p(e,w);f.has(Z)||(c.push({y:e,s:w,dist:r}),f.add(Z))}for(let r=1;r<=a;r++){let m=s(n),S=e+r;if(S<i){let Z=p(S,m);f.has(Z)||(c.push({y:S,s:m,dist:r}),f.add(Z))}let w=e-r;if(w>=0){let Z=p(w,m);f.has(Z)||(c.push({y:w,s:m,dist:r}),f.add(Z))}}return c}function Go(e){let{canvas:n,dom:a,getGrid:d,getN:i,getH:s,getRotFloat:c,constants:f,helpers:p,Spell:g,Magic:r,SoundModule:m,State:S,isGamePlaying:w,addPendingKzDrop:Z,getKillRate:U,triggerSpellWave:pt,spawnSpellBubbles:Xt,spawnBonusBubbles:ye,getTransmuteEffect:zt,getLightningEffect:xt,getFireEffect:Wt,continueMatchProcessing:rt,updateScoreHud:j,showBonus:Ct,getSpellCost:wt,getSpellElement:It,onUltimateApplied:M,isSpellBlocked:Pt,setScore:Dt,setCascadeLevel:_t}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:et,SIDE_MARGIN_PX:nt,MAX_RADIUS_X:Jt,SCORE_MAGIC_DESTROY:N}=f,{normSector:W,levelYToScreenY:at,sectorCenterXY:Ht}=p,oe=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],q="idle",st=null,ct=null,Tt=[],Ot=[],ue=0,Lt=null,te=0,H="idle",ie=null,He=[],ce=[],X=0,A=0,L="idle",I=null,k=[],v=[],O=0;function D(h){if(typeof wt!="function"||typeof It!="function")return!1;let B=It(h),E=wt(h);return!B||!E?!1:(r.charges[B]??0)>=E}function Bt(h){if(typeof wt!="function"||typeof It!="function")return!1;let B=It(h),E=wt(h);return!B||!E||(r.charges[B]??0)<E?!1:(r.charges[B]-=E,r.updateButtons(),g.pulse(),!0)}let bt=0,x=350;function C(){return typeof Pt=="function"?Pt():!1}function R(){let h=performance.now();h-bt<x||(bt=h,m.play("cancel"))}function ae(){q="selecting_source",st=null,ct=null,Tt=[],Ot=[],H!=="idle"&&dt(),L!=="idle"&&Kt(),r.deactivate(),m.play("ulta");let h=a.spellBtn;h&&h.classList.add("selecting")}function b(){q!=="idle"&&m.play("cancel"),q="idle",st=null,ct=null,Tt=[],Ot=[],At();let h=a.spellBtn;h&&h.classList.remove("selecting")}function ot(h,B){if(q!=="selecting_source")return!1;if(C())return R(),!0;let E=J(h,B);if(!E)return b(),!0;let Q=d();st={y:E.y,s:E.s,color:Q[E.y][E.s]},Tt=Hs({centerY:E.y,centerS:E.s,size:zt().areaSize,H:s(),normSector:W});let yt=st.color,ft=ps(Q,Tt,yt);return Ot=ms(ft,zt().maxBlocks),fe(st.color,E.y),q="selecting_target",!0}function J(h,B){let E=n.clientWidth,Q=n.clientHeight,yt=E*.5,ft=(E-2*nt)/2,jt=Q-l-et,Ae=6,qt=s(),tn=i(),We=c(),en=tn*jt/(Ae*qt),pe=Q-et,ne,nn,Me;en<=Math.min(ft,Jt)?(ne=en,nn=jt,Me=l):(ne=Math.min(ft,Jt),nn=ne*Ae*qt/tn,Me=pe-nn);let xe=ne*.28,un=null,Mn=1/0,fn=d();for(let Zt=0;Zt<qt;Zt++){let sn=at(Me,nn,Zt+.5);for(let Re=0;Re<tn;Re++){if(!fn[Zt][Re])continue;let Ge=Ht(yt,sn,ne,xe,Re,We);if(Math.sin(Ge.ang)<-.1)continue;let le=h-Ge.x,xn=B-Ge.y,Ie=Math.hypot(le,xn),Ue=nn/qt*.9,T=Ue*1.2;Math.abs(le)<T/2&&Math.abs(xn)<Ue/2&&Ie<Mn&&(Mn=Ie,un={y:Zt,s:Re})}}return un}function fe(h,B){At();let E=document.createElement("div");E.className="transmute-popup";let Q=n.clientWidth,yt=n.clientHeight,ft=(Q-2*nt)/2,jt=yt-l-et,Ae=6,qt=s(),tn=i(),We=tn*jt/(Ae*qt),en=yt-et,pe,ne;We<=Math.min(ft,Jt)?(pe=jt,ne=l):(pe=Math.min(ft,Jt)*Ae*qt/tn,ne=en-pe);let nn=at(ne,pe,B+.5),Me=Math.floor(zt().areaSize/2),xe=at(ne,pe,Math.min(qt,B+Me)+.5),un=at(ne,pe,Math.max(0,B-Me)+.5),Mn=ne+pe/2,fn=document.getElementById("gameContainer"),Zt=fn?fn.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},sn=160,Re=60,Ge=20,hn=Zt.left+Zt.width/2-sn/2,le;nn<Mn?le=Zt.top+un+Ge:le=Zt.top+xe-Re-Ge,le=Math.max(10,Math.min(window.innerHeight-Re-10,le)),E.style.left=`${hn}px`,E.style.top=`${le}px`,oe.filter(Ie=>Ie.color!==h).forEach(Ie=>{let Ue=document.createElement("button");Ue.className=`transmute-btn ${Ie.name}`,Ue.innerHTML=Ie.icon,Ue.setAttribute("data-color",Ie.color),Ue.addEventListener("click",T=>{T.stopPropagation(),Fe(Ie.color)}),E.appendChild(Ue)}),document.body.appendChild(E),Lt=E,te=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",ht)},50)}function ht(h){performance.now()-te<200||Lt&&!Lt.contains(h.target)&&b()}function At(){document.removeEventListener("pointerdown",ht),Lt&&(Lt.remove(),Lt=null)}function Fe(h){if(C()){R();return}if(!D(g.currentSpell)){R();return}if(At(),ct=h,Ot.length===0){b();return}Se()}function Se(){if(!st){b();return}if(Ot.length===0){b();return}if(!Bt(g.currentSpell)){R(),b();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),q="animating",ue=performance.now(),m.play("esseffect")}function Ee(){if(q!=="selecting_target"&&q!=="animating"||!st||!Tt||Tt.length===0)return;let h=d(),B=h[st.y]?.[st.s]??0;if(!B||B!==st.color){b();return}let E=ps(h,Tt,B),Q=zt().maxBlocks??E.length;Ot=ms(E,Q),Ot.length===0&&b()}function Yt(h){if(q!=="animating")return!1;let B=(h-ue)/1e3;return Math.min(B/zt().animSec,1)>=1?(Ve(),!1):!0}function $e(h){if(q!=="animating")return null;let B=(h-ue)/1e3,E=Math.min(B/zt().animSec,1),Q="flash",yt=0,ft=0;return E<.15?(Q="flash",ft=1-E/.15):E<.55?(Q="shrink",yt=(E-.15)/.4):(Q="grow",yt=(E-.55)/.45),{phase:Q,progress:yt,areaFlash:ft}}function Ve(){let h=d();for(let B of Ot)h[B.y][B.s]=ct;q="idle",st=null,ct=null,Tt=[],Ot=[],_t(1),rt(),typeof M=="function"&&M("earth")}function Qt(){m.play("ulta"),H="selecting_source",ie=null,He=[],ce=[],A=0,q!=="idle"&&(q="idle",st=null,ct=null,Tt=[],Ot=[],At()),L!=="idle"&&(L="idle",I=null,k=[],v=[],O=0),r.deactivate();let h=a.spellBtn;h&&h.classList.add("selecting")}function dt(){H!=="idle"&&m.play("cancel"),H="idle",ie=null,He=[],ce=[],A=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function ge(){L="selecting_source",I=null,k=[],v=[],O=0,q!=="idle"&&(q="idle",st=null,ct=null,Tt=[],Ot=[],At()),H!=="idle"&&(H="idle",ie=null,He=[],ce=[],A=0),r.deactivate(),m.play("ulta");let h=a.spellBtn;h&&h.classList.add("selecting")}function Kt(){L!=="idle"&&m.play("cancel"),L="idle",I=null,k=[],v=[],O=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function Be(h,B){if(H!=="selecting_source")return!1;if(C())return R(),!0;let E=J(h,B);if(!E)return dt(),!0;let Q=d();ie={y:E.y,s:E.s,color:Q[E.y][E.s]},He=Hs({centerY:E.y,centerS:E.s,size:xt().areaSize,H:s(),normSector:W});let yt=ie.color,ft=ps(Q,He,yt);return ce=ms(ft,xt().maxBlocks),ce.length===0?(dt(),!0):D(g.currentSpell)?(Sn(),!0):(R(),!0)}function je(h,B){if(L!=="selecting_source")return!1;if(C())return R(),!0;let E=J(h,B);if(!E)return Kt(),!0;let Q=d();return I={y:E.y,s:E.s,color:Q[E.y][E.s]},k=No({centerY:E.y,centerS:E.s,beamLength:Wt().beamLength,N:i(),H:s(),normSector:W}),v=k.filter(yt=>Q[yt.y][yt.s]).sort((yt,ft)=>yt.dist-ft.dist),v.length===0?(Kt(),!0):D(g.currentSpell)?(Ft(),!0):(R(),!0)}function Sn(){if(!ie||ce.length===0){dt();return}if(!Bt(g.currentSpell)){R(),dt();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),H="animating",X=performance.now(),A=0,m.play("asseffect")}function kn(h){if(H!=="animating")return!1;let B=h-X,E=xt().flashMs+ce.length*xt().jumpMs;return B>=E?(be(),!1):!0}function G(h){if(H!=="animating")return null;let B=h-X;if(B<xt().flashMs)return{phase:"flash",flashProgress:1-B/xt().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let E=B-xt().flashMs,Q=Math.floor(E/xt().jumpMs),yt=E%xt().jumpMs/xt().jumpMs,ft=[];for(let jt=0;jt<Math.min(Q,ce.length);jt++)ft.push(jt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(Q,ce.length-1),jumpProgress:yt,struckTargets:ft}}function be(){let h=d(),B=ce.length,E=B*N;S.addScore(E),Dt(S.score),j(),Ct(`+${E}`,"score");for(let jt of ce)h[jt.y][jt.s]=0;let Q=xt(),yt=Math.abs(Q.kzDropSecPerBlock??0),ft=B*yt;ft>0&&typeof Z=="function"&&typeof U=="function"&&(Z(ft*U()),Ct(`\u26A1 -${ft}s`,"time")),H="idle",ie=null,He=[],ce=[],A=0,_t(1),rt(),typeof M=="function"&&M("air")}function Ft(){if(!I||v.length===0){Kt();return}if(!Bt(g.currentSpell)){R(),Kt();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),L="animating",O=performance.now(),m.play("fsseffect")}function re(h){return L!=="animating"?!1:(h-O)/1e3>=Wt().animSec?(Ne(),!1):!0}function En(h){if(L!=="animating")return null;let B=Wt(),E=Math.max(.001,B.animSec),Q=(h-O)/1e3,yt=Math.min(Q/E,1),ft=.25,jt=yt<ft?1-yt/ft:0,Ae=.6,qt=yt<Ae?yt/Ae*B.beamLength:B.beamLength;return{progress:yt,flashProgress:jt,beamLength:B.beamLength,beamReach:qt}}function Ne(){let h=d(),B=v.length;if(B>0){let E=B*N;S.addScore(E),Dt(S.score),j(),Ct(`+${E}`,"score")}for(let E of v)h[E.y][E.s]=0;L="idle",I=null,k=[],v=[],O=0,_t(1),rt(),typeof M=="function"&&M("fire")}function dn(){let h=typeof w=="function"?w():S.isPlaying(),B=g.currentSpell;if(!h)return!1;if(B==="ice"){if(C()||!D(B)||!Bt(g.currentSpell))return R(),!1;let E=g.effect;return typeof Z=="function"&&typeof U=="function"&&Z(E.duration*U()),m.play("wsseffect"),Ct(`\u{1F4A7} -${E.duration}s`,"time"),typeof pt=="function"&&pt(),typeof ye=="function"&&ye(E.duration),typeof M=="function"&&M(B),!0}return B==="earth"?q==="selecting_source"||q==="selecting_target"?(b(),!0):q!=="idle"||C()||!D(B)?(R(),!1):(q==="idle"&&ae(),!0):B==="air"?H==="selecting_source"?(dt(),!0):H!=="idle"||C()||!D(B)?(R(),!1):(H==="idle"&&Qt(),!0):B==="fire"?L==="selecting_source"?(Kt(),!0):L!=="idle"||C()||!D(B)?(R(),!1):(L==="idle"&&ge(),!0):!1}function bn(h){Ee(),Yt(h),kn(h),re(h)}function Qe(h,B){return C()&&(q==="selecting_source"||H==="selecting_source"||L==="selecting_source")?(R(),!0):q==="selecting_source"?ot(h,B):H==="selecting_source"?Be(h,B):L==="selecting_source"?je(h,B):!1}function vt(){q="idle",st=null,ct=null,Tt=[],Ot=[],At(),H="idle",ie=null,He=[],ce=[],A=0,L="idle",I=null,k=[],v=[],O=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function ee(){return{transmuteState:q,transmuteSourceBlock:st,transmuteTargetColor:ct,transmuteAreaCells:Tt,transmuteBlocksToChange:Ot,lightningState:H,lightningSourceBlock:ie,lightningAreaCells:He,lightningBlocksToHit:ce,fireState:L,fireSourceBlock:I,fireLineCells:k,fireTargets:v}}return{startTransmuteSourceSelection:ae,cancelTransmutation:b,startLightningSourceSelection:Qt,cancelLightning:dt,startFireSourceSelection:ge,cancelFire:Kt,handleTap:Qe,update:bn,reset:vt,getRenderState:ee,getTransmuteAnimState:$e,getLightningAnimState:G,getFireAnimState:En,handleSpellButtonClick:dn,isTransmuteSelecting:()=>q==="selecting_source",isLightningSelecting:()=>H==="selecting_source"}}var ac={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Uo(e={}){let{canvas:n}=e,a=e.rotDir||1,d=!1,i=0,s=0,c=0,f=0,p=0,g=1,r=null,m=0,S=0,w=0,Z=0,U=0,pt=0,Xt=0,ye=0,zt=!1,xt=!1,Wt=!1,rt=ac;return{get tapRotateEnabled(){return zt},set tapRotateEnabled(j){zt=j},get rotDir(){return a},set rotDir(j){a=j},get dragging(){return d},get dragMode(){return r},handlePointerDown(j,Ct,wt){if(Ct.onMagicTap&&Ct.onMagicTap(j.clientX,j.clientY))return xt=!0,!0;xt=!1,Wt=!1;let It=performance.now(),M=It-pt,Pt=j.clientX-Xt,Dt=j.clientY-ye,_t=Math.hypot(Pt,Dt);return M<=rt.DOUBLE_TAP_MS&&_t<=rt.DOUBLE_TAP_MAX_DIST?(Ct.onDoubleTap&&Ct.onDoubleTap(),Wt=!0,pt=0):(pt=It,Xt=j.clientX,ye=j.clientY),d=!0,g=-1,i=j.clientX,s=j.clientY,c=wt,f=0,p=0,r=null,m=It,S=j.clientX,w=j.clientY,Z=m,U=0,n&&n.setPointerCapture(j.pointerId),!1},handlePointerMove(j,Ct,wt,It){if(!d)return null;let M=j.clientX-i,Pt=j.clientY-s,Dt=performance.now();if(Math.abs(M)<rt.DEADZONE_PX&&Math.abs(Pt)<rt.DEADZONE_PX)return null;if(r){if(r==="rotate"){let l=Math.abs(M),et=Math.abs(Pt);if(et>=l*rt.AXIS_DOMINANCE&&et>=rt.DROP_SWIPE_MIN_DISTANCE){let nt=Math.max(1,Dt-m);et/nt*1e3>=rt.DROP_SWIPE_MIN_SPEED&&(r="drop",p=0)}}}else{let l=Math.abs(M),et=Math.abs(Pt);if(Pt<0)l>=rt.DEADZONE_PX&&(r="rotate");else if(et>=l*rt.AXIS_DOMINANCE){if(et>=rt.DROP_SWIPE_MIN_DISTANCE){let nt=Math.max(1,Dt-m);et/nt*1e3>=rt.DROP_SWIPE_MIN_SPEED?r="drop":r="rotate"}}else l>=et*rt.AXIS_DOMINANCE&&(r="rotate");if(!r)return null}let _t=null;if(r==="rotate"&&Math.abs(M)>=rt.DEADZONE_PX){let l=Math.max(1,Dt-Z),et=j.clientX-S,nt=Math.max(1,Math.abs(et)/l*1e3),Jt=Math.max(rt.MIN_ROT_PX,Math.min(rt.MAX_ROT_PX,rt.PX_PER_STEP*(rt.SWIPE_SPEED_REF/nt)));U+=-et/Jt*a*g;let N=Math.trunc(U);N!==0&&(U-=N);let W=f+N;if(W!==f&&Ct.canRotateTo){let at=Math.sign(W-f),Ht=c+f;for(;f!==W;){let oe=f+at,q=c+oe;if(!Ct.canRotateTo(Math.floor(wt),q))break;f=oe,Ht=q,Ct.onRotateStep&&Ct.onRotateStep(),It&&Ct.onGroundedMove&&Ct.onGroundedMove()}_t={targetRot:Ht,rotFloat:Ht}}}if(r==="drop"&&Pt>=rt.DROP_SWIPE_MIN_DISTANCE&&Ct.onDrop){let l=Math.max(1,Dt-Z),et=j.clientY-w,nt=Math.max(1,et/l*1e3),Jt=Math.max(rt.MIN_DROP_PX,Math.min(rt.MAX_DROP_PX,rt.PX_PER_DROP*(rt.SWIPE_SPEED_REF/nt))),N=Math.trunc(Pt/Jt);if(N>p){let W=N-p;for(let at=0;at<W;at++)Ct.onDrop();p=N}}return S=j.clientX,w=j.clientY,Z=Dt,_t},handlePointerUp(j,Ct){if(d){if(zt&&!xt&&!Wt&&!r&&Ct?.onSingleTap){let wt=Math.abs(j.clientX-i),It=Math.abs(j.clientY-s),M=performance.now()-m;wt<rt.DEADZONE_PX&&It<rt.DEADZONE_PX&&M<300&&Ct.onSingleTap()}if(d=!1,r=null,n&&j&&j.pointerId!==void 0)try{n.releasePointerCapture(j.pointerId)}catch{}}},reset(){d=!1,r=null,f=0,p=0,U=0}}}var Fs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Xo(){let e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return a},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,a=performance.now(),d=0,i=0,s=0,c={...Fs}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(f){n+=f},setScore(f){n=f},updateTime(){e==="playing"&&a>0&&(d=performance.now()-a-s)},getFormattedTime(){let f=Math.floor(d/1e3),p=Math.floor(f/60),g=f%60;return`${p}:${g.toString().padStart(2,"0")}`},incrementStat(f,p=1){f in c&&(c[f]+=p)},updateMaxStat(f,p){f in c&&p>c[f]&&(c[f]=p)},reset(){e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs}}}}function Pn(e,n){return e%=n,e<0&&(e+=n),e}function Yo(e,n){return e[Math.min(n,e.length-1)]}function hs(e){let n=Math.max(0,Math.floor(e/1e3)),a=Math.floor(n/60),d=n%60;return`${a}:${d.toString().padStart(2,"0")}`}function Vo(e,n){let a=e.map(({x:f,y:p},g)=>({x:p,y:-f,color:n[g]})),d=1/0,i=-1/0,s=1/0;for(let f of a)d=Math.min(d,f.x),i=Math.max(i,f.x),s=Math.min(s,f.y);let c=Math.round((d+i)/2);for(let f of a)f.x-=c,f.y-=s;return a.sort((f,p)=>f.y-p.y||f.x-p.x),{cells:a.map(f=>({x:f.x,y:f.y})),colors:a.map(f=>f.color)}}function $s(e,n,a,d){let i=[];return e+1<a&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Pn(n-1,d)}),i.push({y:e,s:Pn(n+1,d)}),i}function Wo(e,n,a){let d=Array.from({length:n},()=>new Uint8Array(a)),i=[];for(let s=0;s<n;s++)for(let c=0;c<a;c++){if(!e[s][c]||d[s][c])continue;let f=[],p=[{y:s,s:c}];for(d[s][c]=1;p.length>0;){let g=p.shift();f.push(g);for(let r of $s(g.y,g.s,n,a))e[r.y][r.s]&&!d[r.y][r.s]&&(d[r.y][r.s]=1,p.push(r))}i.push(f)}return i}function Ko(e){return e.some(n=>n.y===0)}function Ns(e,n,a,d,i,s){if(!e)return!1;let c=Pn(a,s);for(let f of e.cells){let p=n+f.y,g=Pn(c+f.x,s);if(p<0)return!1;if(!(p>=i)&&d[p][g])return!1}return!0}function qo(e,n,a,d,i,s){if(!e)return null;let c=Math.floor(n);for(;Ns(e,c-1,a,d,i,s);)c-=1;return c}function zo(e,n,a){let d=[],i=[];for(let s=0;s<n;s++){let c=[],f=0,p=e[s][0],g=p?1:0;for(let r=1;r<=a;r++){let m=r<a?e[s][r]:0;m&&m===p?g++:(g>=1&&p&&c.push({start:f,length:g,color:p}),f=r,p=m,g=m?1:0)}if(c.length>=2){let r=c[0],m=c[c.length-1];if(r.start===0&&m.start+m.length===a&&r.color===m.color){let S=r.length+m.length;c[0]={start:m.start,length:S,color:r.color},c.pop()}}for(let r of c)if(r.length>=3){let m=[];for(let S=0;S<r.length;S++)m.push({y:s,s:(r.start+S)%a});d.push({color:r.color,length:r.length,cells:m})}}for(let s=0;s<a;s++){let c=0,f=e[0][s],p=f?1:0;for(let g=1;g<=n;g++){let r=g<n?e[g][s]:0;if(r&&r===f)p++;else{if(p>=3&&f){let m=[];for(let S=0;S<p;S++)m.push({y:c+S,s});d.push({color:f,length:p,cells:m})}c=g,f=r,p=r?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<a;c++){let f=e[s][c],p=e[s][(c+1)%a],g=e[s][(c+2)%a],r=e[s][(c+3)%a];f&&f===p&&g&&g===r&&f!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%a},{y:s,s:(c+2)%a},{y:s,s:(c+3)%a}]})}for(let s=0;s<a;s++)for(let c=0;c<n-3;c++){let f=e[c][s],p=e[c+1][s],g=e[c+2][s],r=e[c+3][s];f&&f===p&&g&&g===r&&f!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:d,pairMatches:i}}function jo(e,n,a){let d=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<a;c++)if(!e[i][c]){s=!1;break}s&&d.push(i)}return d}function Qo(e,n){let a=new Map;e.forEach((d,i)=>a.set(`${d.x},${d.y}`,n[i]));for(let d=0;d<e.length;d++){let i=e[d],s=n[d],c=1;for(let pt=1;pt<=2&&a.get(`${i.x+pt},${i.y}`)===s;pt++)c++;if(c>=3)return!0;let f=1;for(let pt=1;pt<=2&&a.get(`${i.x},${i.y+pt}`)===s;pt++)f++;if(f>=3)return!0;let p=s,g=a.get(`${i.x+1},${i.y}`),r=a.get(`${i.x+2},${i.y}`),m=a.get(`${i.x+3},${i.y}`);if(p&&g&&r&&m&&p===g&&r===m&&p!==r)return!0;let S=s,w=a.get(`${i.x},${i.y+1}`),Z=a.get(`${i.x},${i.y+2}`),U=a.get(`${i.x},${i.y+3}`);if(S&&w&&Z&&U&&S===w&&Z===U&&S!==Z)return!0}return!1}function Zo(e){let{getN:n,getH:a,FALL_INTERVAL:d,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:f,RING_HIGHLIGHT_SEC:p,getState:g,setState:r,funcs:m,ui:S}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(w,Z={}){let U=g();if(w==="start_game")return U.gameState!=="playing"?(m.startGame(),!0):!1;if(U.gameState!=="playing")return!1;switch(w){case"rotate_piece":return m.rotatePieceByDir(),!0;case"move_down":return m.tryMoveDown();case"rotate_cylinder":{let{rot:pt}=Z;return typeof pt=="number"&&m.canPlaceAtRot(Math.floor(U.pieceY),pt)?(r({targetRot:pt,rotFloat:pt,rotVel:0}),U.isGrounded&&m.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:pt,y:Xt}=Z;return m.shootMagic(pt,Xt)}case"select_magic":{let{element:pt}=Z;return m.selectMagic(pt),!0}default:return console.warn("GameEngine: unknown command",w),!1}},update(w,Z){let U=g();if(U.gameState!=="playing")return;let pt=Z-U.startTime-U.totalPausedMs;r({elapsedMs:pt}),S.updateTimeHud();let Xt=U.killLevel+s()*w;if(r({killLevel:Xt}),S.updateRemainingHud(),Xt>=a()){m.endGame();return}if(U.isHighlighting){let xt=(Z-U.highlightStartTime)/1e3,Wt;U.isRingAnimation?Wt=p:U.isMagicAnimation?Wt=f:Wt=c,xt>=Wt&&(U.isRingAnimation?m.finishRingHighlight():m.finishHighlight())}let ye=U.fallTimer+w;if(ye>=d&&(ye-=d,m.tryMoveDown()),r({fallTimer:ye}),m.updateGroundedState()){let xt=U.lockTimer+w;r({lockTimer:xt}),xt>=i&&m.lockPiece()}},reset(){m.startGame()},canRotateTo(w,Z){return m.canPlaceAtRot(w,Z)},getRotation(){let w=g();return{targetRot:w.targetRot,rotFloat:w.rotFloat,rotVel:w.rotVel}},setRotation(w){r({targetRot:w,rotFloat:w,rotVel:0})},onGroundedMove(){m.maybeResetLockDelay()}}}var ze=Math.PI*2;function Jo(e){let{canvas:n,canvasCtx:a,getN:d,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:f,MAX_RADIUS_X:p,RADIUS_X_FACTOR:g,ANG_OFFSET:r,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:S,MAGIC_SHRINK_SEC:w,RING_HIGHLIGHT_SEC:Z,LOCK_DELAY_SEC:U,getKillRate:pt,ELEMENT_COLORS:Xt,ELEMENT_TO_COLOR:ye,BLOCK_COLOR_FRONT:zt,BLOCK_COLOR_BACK:xt,ACTIVE_COLOR_FRONT:Wt,GHOST_COLOR_FILL:rt,GHOST_COLOR_STROKE:j,GHOST_STROKE_WIDTH:Ct,MAGIC_DIM_DOT_ALPHA:wt,MAGIC_DIM_DOT_SCALE:It,MAGIC_TARGET_DOT_SCALE:M,getState:Pt,getVisualSettings:Dt,funcs:_t}=e,l=a,et=d(),nt=i(),Jt={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},N=[],W=40;function at(X,A,L,I,k){let v=Math.max(3,Math.round(X)),O=180;for(let D=0;D<v;D++)setTimeout(()=>{let Bt=Math.random()>.5?"left":"right",bt=15,x=Bt==="left"?bt+Math.random()*Math.max(10,A-bt*2):L+bt+Math.random()*Math.max(10,k-L-bt*2),C=I-10;N.push({x,baseX:x,y:C,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:bt,maxX:k-bt})},D*O)}function Ht(X,A,L){N=N.filter(I=>I.y>X+I.size&&I.y>-20);for(let I of N){I.y-=W*L,I.wobble+=I.wobbleSpeed*L;let k=I.baseX+Math.sin(I.wobble)*I.wobbleAmp;I.x=Math.max(I.minX,Math.min(I.maxX,k))}}function oe(X){if(N.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let A of N)A.y<X+A.size||(l.beginPath(),l.arc(A.x,A.y,A.size,0,Math.PI*2),l.fill(),l.stroke())}}let q={left:0,right:0,h:0,w:0};function st(X,A,L){let I=1-L/nt;return X+I*A}function ct(X){return X=X%et,X<0?X+et:X}function Tt(X,A,L,I,k,v){let O=ct(v),D=(k-O)/et*ze+r;return{x:X+Math.cos(D)*L,y:A+Math.sin(D)*I,ang:D}}let Ot=.52,ue=1.02;function Lt(X,A,L,I,k,v){let O=ct(v),D=(k-O)/et*ze+r;return{x:X+Math.cos(D)*L,y:A+Math.sin(D)*I,ang:D}}function te(X,A,L,I,k,v,O,D=1){let Bt=Lt(X,A,L,I,k-Ot,v),bt=Lt(X,A,L,I,k+Ot,v),x={x:Bt.x,y:Bt.y-O*.5},C={x:Bt.x,y:Bt.y+O*.5},R={x:bt.x,y:bt.y-O*.5},ae={x:bt.x,y:bt.y+O*.5},b=(x.x+R.x+ae.x+C.x)*.25,ot=(x.y+R.y+ae.y+C.y)*.25,J=ue*D,fe=D,ht=[x,R,ae,C].map(Se=>({x:b+(Se.x-b)*J,y:ot+(Se.y-ot)*fe})),At=Math.abs((bt.x-Bt.x)*J),Fe=Math.abs(O*fe);return{corners:ht,cx:b,cy:ot,wApprox:At,hApprox:Fe,ang:Lt(X,A,L,I,k,v).ang}}function H(X,A,L,I,k,v,O,D,Bt=1,bt=null,x=1,C=null,R=0,ae=1,b=1){let ot=te(X,A,L,I,k,v,O,b),[J,fe,ht,At]=ot.corners;if(l.save(),l.globalAlpha=Bt,l.fillStyle=D,l.beginPath(),l.moveTo(J.x,J.y),l.lineTo(fe.x,fe.y),l.lineTo(ht.x,ht.y),l.lineTo(At.x,At.y),l.closePath(),l.fill(),C&&R>0&&(l.strokeStyle=C,l.lineWidth=R,l.stroke()),bt){let Fe=Math.min(ot.wApprox,ot.hApprox)*.28*ae;l.globalAlpha=Bt*x,l.fillStyle=bt,l.beginPath(),l.arc(ot.cx,ot.cy,Fe,0,ze),l.fill()}l.restore(),l.globalAlpha=1}function ie(X,A,L,I,k,v){let O=Tt(X,A,L,I,k,v),D=Tt(X,A,L,I,k+1,v),Bt=Tt(X,A,L,I,k-1,v),bt=Math.abs(D.x-O.x),x=Math.abs(O.x-Bt.x),C=(bt+x)*.5*1.06;return Math.max(1,C)}function He(X,A,L,I,k,v){let O=(k-v)/et*ze+r;return{x:X+Math.cos(O)*L,y:A+Math.sin(O)*I,ang:O}}function ce(X,A,L,I,k,v,O,D=1,Bt=null,bt=1,x=null,C=0,R=1){l.save(),l.translate(X,A);let ae=Math.atan2(I,L);if(l.rotate(ae),l.globalAlpha=D,l.fillStyle=O,l.fillRect(-k/2,-v/2,k,v),x&&C>0&&(l.strokeStyle=x,l.lineWidth=C,l.strokeRect(-k/2,-v/2,k,v)),Bt){let b=Math.min(k,v)*.28*R;l.globalAlpha=D*bt,l.fillStyle=Bt,l.beginPath(),l.arc(0,0,b,0,ze),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let X=Math.max(1,Math.min(2,window.devicePixelRatio||1)),A=Math.floor(n.clientWidth*X),L=Math.floor(n.clientHeight*X);(n.width!==A||n.height!==L)&&(n.width=A,n.height=L,l.setTransform(X,0,0,X,0,0))},render(X=.016,A=performance.now()){this.resize();let L=Pt();et=d(),nt=i();let I=n.clientWidth,k=n.clientHeight;l.clearRect(0,0,I,k),l.fillStyle="#0b0f14",l.fillRect(0,0,I,k);let v=I*.5,O=(I-2*f)/2,D=k-s-c,Bt=6,bt=et*D/(Bt*nt),x,C,R,ae;ae=k-c,bt<=Math.min(O,p)?(x=bt,C=D,R=s):(x=Math.min(O,p),C=x*Bt*nt/et,R=ae-C);let b=x*.28,{killLevel:ot,rotFloat:J,grid:fe,gameState:ht}=L,At=Dt?Dt():{},Fe=At.waterColor||"blue",Se=At.waterBubbles||!1,Ee=Jt[Fe]||Jt.blue,Yt=st(R,C,ot),$e=.7,Ve=ot/nt,Qt={...Ee.top},dt={...Ee.bottom};if(Ve>$e){let T=(Ve-$e)/(1-$e);Qt.r=Math.round(Qt.r+(255-Qt.r)*T*.5),Qt.g=Math.round(Qt.g+(150-Qt.g)*T*.5),Qt.b=Math.round(Qt.b+(150-Qt.b)*T*.5),dt.r=Math.round(dt.r+(180-dt.r)*T),dt.g=Math.round(dt.g*(1-T*.6)),dt.b=Math.round(dt.b*(1-T*.6))}let ge=v-x-8,Kt=v+x+8,Be=R,je=ae+5,Sn=l.createLinearGradient(0,Yt,0,k);Sn.addColorStop(0,`rgba(${Qt.r},${Qt.g},${Qt.b},0.5)`),Sn.addColorStop(1,`rgba(${dt.r},${dt.g},${dt.b},0.7)`),l.fillStyle=Sn;let kn=Math.round((Qt.r+dt.r)/2),G=Math.round((Qt.g+dt.g)/2),be=Math.round((Qt.b+dt.b)/2),Ft=x+8,re=b+4;l.fillRect(0,Yt,ge,k-Yt),l.fillRect(Kt,Yt,I-Kt,k-Yt),l.beginPath();let En=Math.max(Yt,je);l.moveTo(ge,En),Yt<=je+re?l.ellipse(v,je,Ft,re,0,Math.PI,0,!1):l.lineTo(Kt,En),l.lineTo(Kt,k),l.lineTo(ge,k),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(ge,Be),l.lineTo(ge,je),l.stroke(),l.beginPath(),l.moveTo(Kt,Be),l.lineTo(Kt,je),l.stroke(),l.beginPath(),l.ellipse(v,je,x+8,b+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(v,je,x+8,b+4,0,0,ze),l.fill(),ot>.5&&(l.strokeStyle=`rgba(${Math.min(255,kn+60)},${Math.min(255,G+40)},${Math.min(255,be+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Yt),l.lineTo(ge,Yt),l.moveTo(Kt,Yt),l.lineTo(I,Yt),l.stroke()),q={left:ge,right:Kt,h:k,w:I},(N.length>0||Se)&&(Ht(Yt,k,X),oe(Yt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Ne=ze*x,dn=10,bn=Ne/dn*.7,Qe=Ne/dn*.3;l.setLineDash([bn,Qe]);let vt=Ne/et;l.lineDashOffset=ct(J)*vt;for(let T=0;T<=nt;T++){let F=st(R,C,T);l.beginPath(),l.ellipse(v,F,x,b,0,0,ze),l.stroke()}l.setLineDash([]);let ee=[],h=[];for(let T=0;T<nt;T++){let F=st(R,C,T+.5);for(let tt=0;tt<et;tt++){let K=fe[T][tt];if(!K)continue;let Y=Tt(v,F,x,b,tt,J),z=Math.sin(Y.ang),P={y:T,s:tt,yScr:F,p:Y,depth:z,color:K};z<-.1?ee.push(P):h.push(P)}}let B=_t.getMagicTargetColor(),{isHighlighting:E,highlightedCells:Q,highlightStartTime:yt,isMagicAnimation:ft}=L,jt=null,Ae=1,qt=1,tn=!1;if(E&&Q.length>0){jt=new Set(Q.map(F=>`${F.y},${F.s}`));let T=(performance.now()-yt)/1e3;if(ft){let F=Math.min(1,T/w);Ae=1-F*.85,qt=1-F*.9,tn=!0}else{let F=Math.min(1,T/m),tt=1-S;if(F>tt){let K=(F-tt)/S;Ae=1-K*.85,qt=1-K*.9,tn=!0}}}ee.sort((T,F)=>T.depth-F.depth);for(let T of ee){let F=C/nt*.9,tt=Xt[T.color]||null,K=.35,Y=1,z=`${T.y},${T.s}`;jt&&jt.has(z)&&(K*=qt,Y=Ae),H(v,T.yScr,x,b,T.s,J,F,xt,K,tt,.5,null,0,1,Y)}let{isRingAnimation:We}=L;if(E&&Q.length>0&&!ft){let T=(performance.now()-yt)/1e3,tt=Math.min(1,T/(We?Z:m)),K=1-S,Y=tt>K,z=Y?(tt-K)/S:0,P=We?Math.floor(tt*K*et*2)%et:-1,_=4+tt/K*10,V=Math.sin(T*_*ze),ut=Y?1:.3+V*.3,St=Y?1-z*.8:1,Rt=Y?1-z:1;for(let Et of Q){let $t=st(R,C,Et.y+.5),Pe=Lt(v,$t,x,b,Et.s,J);if(Math.sin(Pe.ang)>=-.1)continue;let Cn=C/nt*.9,we,de,se;if(We){let cn=(Et.s-P+et)%et,Ze=cn<3?1-cn/3:0;we=(Y?Rt:.2+Ze*.5)*.5,de=`rgba(255, 159, 67, ${we})`,se=Y?St:1+Ze*.15}else we=ut*Rt,de=Et.isLine?`rgba(255, 255, 255, ${we*.5})`:`rgba(255, 220, 100, ${we*.4})`,se=Y?St:1.1;H(v,$t,x,b,Et.s,J,Cn,de,1,null,1,null,0,1,se)}}h.sort((T,F)=>T.depth-F.depth);for(let T of h){let F=C/nt*.9,tt=Xt[T.color]||null,K=1,Y=1,z=1,P=1,_=`${T.y},${T.s}`,V=jt&&jt.has(_);V&&(K=qt,Y=Ae),B!==null&&!V&&(T.color!==B?(z=wt,P=It):P=M),H(v,T.yScr,x,b,T.s,J,F,zt,K,tt,z,null,0,P,Y)}if(E&&Q.length>0&&!ft){let T=(performance.now()-yt)/1e3,tt=Math.min(1,T/(We?Z:m)),K=1-S,Y=tt>K,z=Y?(tt-K)/S:0,P=We?Math.floor(tt*K*et*2)%et:-1,_=4+tt/K*10,V=Math.sin(T*_*ze),ut=Y?1:.5+V*.5,St=Y?1-z*.8:1,Rt=Y?1-z:1;for(let Et of Q){let $t=st(R,C,Et.y+.5),Pe=Lt(v,$t,x,b,Et.s,J);if(Math.sin(Pe.ang)<-.1)continue;let Cn=C/nt*.9,we,de,se;if(We){let cn=(Et.s-P+et)%et,Ze=cn<4?1-cn/4:0;we=Y?Rt:.3+Ze*.7,de=`rgba(255, 159, 67, ${we})`,se=Y?St:1+Ze*.2}else we=ut*Rt,de=Et.isLine?`rgba(255, 255, 255, ${we*.7})`:`rgba(255, 220, 100, ${we*.6})`,se=Y?St:1.15;H(v,$t,x,b,Et.s,J,Cn,de,1,null,1,null,0,1,se)}}let en=L.spellState||L,{transmuteState:pe,transmuteSourceBlock:ne,transmuteTargetColor:nn,transmuteAreaCells:Me,transmuteBlocksToChange:xe}=en;if(pe==="selecting_source"){let T=C/nt*.9,F=.35+Math.sin(A/150)*.15;for(let tt of h){let K=st(R,C,tt.y+.5);H(v,K,x,b,tt.s,J,T,`rgba(0, 40, 20, ${F})`,1,null,1,null,0,1,1)}}if(pe==="selecting_target"&&xe&&xe.length>0){let T=C/nt*.9,F=.4+Math.sin(A/120)*.25,tt=.6+Math.sin(A/120)*.4;for(let K of xe){if(K.y<0||K.y>=nt)continue;let Y=st(R,C,K.y+.5),z=Lt(v,Y,x,b,K.s,J);Math.sin(z.ang)<-.1||(H(v,Y,x,b,K.s,J,T,`rgba(0, 50, 30, ${F})`,1,null,1,null,0,1,1),H(v,Y,x,b,K.s,J,T,"transparent",1,null,1,`rgba(100, 255, 150, ${tt})`,3,1,1.02))}}if(pe==="animating"&&_t.getTransmuteAnimState){let T=_t.getTransmuteAnimState(A);if(T){let F=C/nt*.9,{phase:tt,progress:K,areaFlash:Y}=T;if(Y>0&&Me)for(let z of Me){if(z.y<0||z.y>=nt)continue;let P=st(R,C,z.y+.5),_=Lt(v,P,x,b,z.s,J);Math.sin(_.ang)<-.1||H(v,P,x,b,z.s,J,F,`rgba(150, 255, 200, ${Y*.4})`,1,null,1,null,0,1,1)}if(xe&&xe.length>0){let z=ne?ne.color:1,P=nn||1;for(let _ of xe){if(_.y<0||_.y>=nt)continue;let V=st(R,C,_.y+.5),ut=Lt(v,V,x,b,_.s,J);if(Math.sin(ut.ang)<-.1)continue;let Rt=1,Et=Xt[z],$t=0;if(tt==="shrink"?(Rt=1-K*.95,Et=Xt[z],$t=.5+K*.3):tt==="grow"&&(Rt=K,Et=Xt[P],$t=.8-K*.5),$t>0&&H(v,V,x,b,_.s,J,F,`rgba(200, 255, 220, ${$t})`,1,null,1,null,0,1,1),Rt>.05){let Pe=te(v,V,x,b,_.s,J,F,1),on=Math.min(Pe.wApprox,Pe.hApprox)*.28*Rt;l.save(),l.globalAlpha=1,l.fillStyle=Et,l.beginPath(),l.arc(Pe.cx,Pe.cy,on,0,ze),l.fill(),l.restore()}}}}}let{lightningState:un,lightningSourceBlock:Mn,lightningAreaCells:fn,lightningBlocksToHit:Zt}=en;if(un==="selecting_source"){let T=C/nt*.9,F=.35+Math.sin(A/150)*.15;for(let tt of h){let K=st(R,C,tt.y+.5);H(v,K,x,b,tt.s,J,T,`rgba(20, 20, 60, ${F})`,1,null,1,null,0,1,1)}}if(un==="animating"&&_t.getLightningAnimState){let T=_t.getLightningAnimState(A);if(T&&Zt&&Zt.length>0){let F=C/nt*.9,{phase:tt,flashProgress:K,currentTarget:Y,jumpProgress:z,struckTargets:P}=T;if(tt==="flash"&&K>0&&fn)for(let _ of fn){if(_.y<0||_.y>=nt)continue;let V=st(R,C,_.y+.5),ut=Lt(v,V,x,b,_.s,J);Math.sin(ut.ang)<-.1||H(v,V,x,b,_.s,J,F,`rgba(100, 150, 255, ${K*.5})`,1,null,1,null,0,1,1)}if(P&&P.length>0)for(let _ of P){let V=Zt[_];if(!V||V.y<0||V.y>=nt)continue;let ut=st(R,C,V.y+.5),St=Lt(v,ut,x,b,V.s,J);if(Math.sin(St.ang)<-.1)continue;let Et=(P.length-1-P.indexOf(_))*.1,$t=Math.max(0,.8-Et);H(v,ut,x,b,V.s,J,F,`rgba(255, 255, 255, ${$t})`,1,null,1,`rgba(150, 200, 255, ${$t})`,2,1,1.05)}if(tt==="chain"&&Y>=0&&Y<Zt.length){let _=Zt[Y];if(_&&_.y>=0&&_.y<nt){let V=st(R,C,_.y+.5),ut=Lt(v,V,x,b,_.s,J);if(Math.sin(ut.ang)>=-.1){let Rt=1-z;H(v,V,x,b,_.s,J,F,`rgba(200, 220, 255, ${Rt*.9})`,1,null,1,`rgba(100, 180, 255, ${Rt})`,3,1,1.1-z*.05)}}if(Y>0){let V=Zt[Y-1],ut=Zt[Y];if(V&&ut){let St=st(R,C,V.y+.5),Rt=st(R,C,ut.y+.5),Et=te(v,St,x,b,V.s,J,F,1),$t=te(v,Rt,x,b,ut.s,J,F,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-z*.5})`,l.lineWidth=2+(1-z)*2,l.lineCap="round",l.beginPath();let Pe=Et.cx,on=Et.cy,Cn=$t.cx,we=$t.cy;l.moveTo(Pe,on);let de=4;for(let se=1;se<=de;se++){let cn=se/de,Ze=Pe+(Cn-Pe)*cn,vs=on+(we-on)*cn,Kn=se<de?(Math.random()-.5)*8:0;l.lineTo(Ze+Kn,vs+Kn)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-z)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:sn,fireSourceBlock:Re,fireLineCells:Ge,fireTargets:hn}=en;if(sn==="selecting_source"){let T=C/nt*.9,F=.3+Math.sin(A/140)*.2;for(let tt of h){let K=st(R,C,tt.y+.5);H(v,K,x,b,tt.s,J,T,`rgba(70, 25, 10, ${F})`,1,null,1,null,0,1,1)}}if(sn==="animating"&&_t.getFireAnimState){let T=_t.getFireAnimState(A);if(T&&Ge&&Ge.length>0){let F=C/nt*.9,{progress:tt,flashProgress:K}=T,Y=Math.sin(tt*Math.PI);if(K>0)for(let z of Ge){if(z.y<0||z.y>=nt)continue;let P=st(R,C,z.y+.5),_=Lt(v,P,x,b,z.s,J);Math.sin(_.ang)<-.1||H(v,P,x,b,z.s,J,F,`rgba(255, 120, 50, ${K*.45})`,1,null,1,`rgba(255, 200, 140, ${K*.5})`,2,1,1.03)}if(Re){let z=new Map;for(let _ of Ge){if(_.y<0||_.y>=nt)continue;let V=st(R,C,_.y+.5),ut=Lt(v,V,x,b,_.s,J);if(Math.sin(ut.ang)<-.1)continue;let Rt=te(v,V,x,b,_.s,J,F,1),Et=_.s-Re.s;Et>et/2&&(Et-=et),Et<-et/2&&(Et+=et);let $t=_.y;z.has($t)||z.set($t,[]),z.get($t).push({x:Rt.cx,y:Rt.cy,offset:Et})}let P=Array.from(z.keys()).sort((_,V)=>V-_);if(P.length>0){let _=.35+.3*Math.sin(A/60)+Y*.2;l.save(),l.lineCap="round";for(let V of P){let ut=z.get(V)||[];if(ut.sort((St,Rt)=>St.offset-Rt.offset),ut.length!==0){l.beginPath(),l.moveTo(ut[0].x,ut[0].y);for(let St=1;St<ut.length;St++)l.lineTo(ut[St].x,ut[St].y);l.strokeStyle=`rgba(255, 140, 60, ${_})`,l.lineWidth=Math.max(2,F*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,l.lineWidth=Math.max(6,F*.35),l.stroke()}}l.restore()}}if(hn&&hn.length>0){let z=.2+Y*.6;for(let P of hn){if(P.y<0||P.y>=nt)continue;let _=st(R,C,P.y+.5),V=Lt(v,_,x,b,P.s,J);Math.sin(V.ang)<-.1||H(v,_,x,b,P.s,J,F,`rgba(255, 160, 70, ${z})`,1,null,1,`rgba(255, 230, 180, ${Y*.6})`,2,1,1.05)}}}}let{activePiece:le,pieceY:xn,isGrounded:Ie,lockTimer:Ue}=L;if(le){let T=_t.snappedRot(),F=T,tt=_t.computeGhostY(),K=C/nt*.9;if(tt!==null){let P=[];for(let _=0;_<le.cells.length;_++){let V=le.cells[_],ut=le.colors[_],St=tt+V.y,Rt=_t.normSector(T+V.x);if(St<0||St>=nt)continue;let Et=st(R,C,St+.5),$t=Lt(v,Et,x,b,Rt,F);P.push({cy:St,cs:Rt,yScr:Et,depth:Math.sin($t.ang),color:ut})}P.sort((_,V)=>_.depth-V.depth);for(let _ of P){let V=Xt[_.color]||null;H(v,_.yScr,x,b,_.cs,F,K,rt,1,V,.5,j,Ct,1,1)}}let Y=Wt;if(Ie&&Ue>0){let P=Math.min(1,Ue/U),_=255,V=Math.round(170+85*P),ut=Math.round(180+75*P),St=.75+(1-.75)*P;Y=`rgba(${_},${V},${ut},${St})`}let z=[];for(let P=0;P<le.cells.length;P++){let _=le.cells[P],V=le.colors[P],ut=_t.normSector(T+_.x),St=xn+_.y;if(St<0||St>=nt)continue;let Rt=st(R,C,St+.5),Et=Lt(v,Rt,x,b,ut,F);z.push({cs:ut,yScr:Rt,depth:Math.sin(Et.ang),color:V})}z.sort((P,_)=>P.depth-_.depth);for(let P of z){let _=Xt[P.color]||null;H(v,P.yScr,x,b,P.cs,F,K,Y,1,_,1,null,0,1,1)}}},drawNextPreview(X,A){if(!X)return;let L=X.getContext("2d"),I=X.width,k=X.height;if(L.clearRect(0,0,I,k),!A)return;let v=1/0,O=-1/0,D=1/0,Bt=-1/0;for(let b of A.cells)v=Math.min(v,b.x),O=Math.max(O,b.x),D=Math.min(D,b.y),Bt=Math.max(Bt,b.y);let bt=O-v+1,x=Bt-D+1,C=Math.min(I/(bt+.5),k/(x+.5)),R=(I-bt*C)/2,ae=(k-x*C)/2;L.fillStyle=zt;for(let b=0;b<A.cells.length;b++){let ot=A.cells[b],J=R+(ot.x-v)*C,fe=ae+(x-1-(ot.y-D))*C;L.fillRect(J+1,fe+1,C-2,C-2);let ht=A.colors[b],At=Xt[ht];if(At){let Fe=(C-2)*.32;L.fillStyle=At,L.beginPath(),L.arc(J+C/2,fe+C/2,Fe,0,ze),L.fill(),L.fillStyle=zt}}},spawnBonusBubbles(X){let{left:A,right:L,h:I,w:k}=q;k>0&&at(X,A,L,I,k)}}}(()=>{let e=Ao(),n=e.canvas,a=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,i=30,s=24,c=120,f={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function p(t){let o=f[t]||f["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let r=Math.PI/2,m=70,S=120,w=30;function Z(){document.documentElement.style.setProperty("--vh",window.innerHeight*.01+"px")}Z(),window.addEventListener("resize",Z);let U=320,pt=.42,Xt="rgb(235,240,250)",ye="rgb(55,62,75)",zt="rgba(255,170,180,0.75)",xt="rgba(110,255,150,0.15)",Wt="rgba(110,255,150,0.85)",rt=2,j={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Ct={1:"fire",2:"water",3:"lightning",4:"earth"},wt={fire:1,water:2,lightning:3,earth:4},It=1,M=.58,Pt=!0,Dt=12,_t=25,l=1,et=2,nt=3,Jt=1,N={fire:1,water:1,lightning:1,earth:1},W=5,at=7,Ht=10,oe=3,q=50,st=2,ct=.3,Tt=.5,Ot=1,ue=.3,Lt=.5,te=1.3,H=10,ie=1e3,He=[1,1.25,1.5,1.75,2],ce=10,X=20,A=5,L=[1,1.3,1.6,2,2.4,2.8],I=[1,1.1,1.2,1.3,1.4,1.5],k=[1,1.5,2,2.5,3,3.5],v=[1,1.3,1.6,2,2.4,2.8],O=wo(),D=O.loadGameSettings();D.hapticsEnabled===void 0&&(D.hapticsEnabled=!0);let Bt=D.invertSwipe?-1:1,bt=D.showControls!==!1,x=D.tapRotate===!0,R=!1,ae=-1,b=Ho({enabled:D.hapticsEnabled}),ot=Array.from({length:s},()=>new Uint8Array(i));function J(){ot=Array.from({length:s},()=>new Uint8Array(i))}let fe=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],ht=null,At=s+3,Fe=0,Se=0,Ee=!1,Yt=0,$e=0,Ve=0,Qt=3,dt=0,ge=0,Kt=0,Be=Uo({canvas:n,rotDir:Bt}),je="0.17.11",Sn=!0,kn="blue",G=To();G.preload();let be=Xo(),Ft="intro",re=0,En=0,Ne=0,dn=0,bn=0,Qe=null,vt=be.stats,ee=0,h=e.overlay,B=e.gameContainer,E=Po({elementColors:j}),Q=E.showBonus.bind(E),yt=E.getElementIcon.bind(E),ft=ko(),jt=e.overlayTitle,Ae=e.overlayStats,qt=e.startBtn,tn=e.hud,We=e.scoreHud,en=e.timeHud,pe=e.remainingHud,ne=e.nextCanvas,nn=ne.getContext("2d"),Me=e.pauseBtn,xe=e.pauseOverlay,un=e.resumeBtn,Mn=e.restartBtn,fn=e.exitToMenuBtn,Zt=e.pauseSettingsBtn,sn=e.pauseSoundBtn,Re=e.pauseMusicBtn,Ge=e.pauseBestScore,hn=e.pauseBestTime,le=e.pauseBestMode,xn=e.pauseCurrentScore,Ie=e.pauseCurrentTime,Ue=e.pauseCurrentMode,T=e.confirmDialog,F=e.confirmText,tt=e.confirmCancel,K=e.confirmOk,Y=e.settingsOverlay,z=e.settingsClose,P=e.fullscreenBtn,_=e.rotateBtn,V=e.startPanel,ut=e.gameoverPanel,St=e.goScore,Rt=e.goTime,Et=e.goRing,$t=e.goMatches,Pe=e.goBonuses,on=e.goNewRecord,Cn=e.goRestartBtn,we=e.goExitBtn,de=e.bestScore,se=e.bestTimeVal,cn=e.startVersion,Ze=e.modeBtns,vs=e.recordsBtn,Kn=e.startSettingsBtn,ti=e.helpBtn;Do({helpBtn:ti});let Ce="25_20";function ei(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function ni(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,y=f[u];if(!y)return;let $=o.querySelector(".mode-tag.time-tag");if(!$)return;let it=ei(y.survivalTime);it&&($.textContent=it)})}ni();let lt=Fo({buttons:e.magicBtns,onActivate:()=>G.play("spells"),onChange:(t,o)=>{Es()}}),_n=e.magicBtns,lc=lt.charges,si=t=>ke()?lt.select(t):!1,On=()=>lt.updateButtons(),Gs=e.magicRow,Vt=e.magicActiveIndicator,Us=e.magicActiveIcon,Xs=e.magicActiveCost,oi={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ys={fire:"fire",water:"ice",lightning:"air",earth:"earth"},ii=["ice","earth","air","fire"];ee=O.loadHighTowerRings();function Dn(t){return typeof me?.getUnlockRings=="function"?me.getUnlockRings(t):0}function qn(t){let o=Dn(t);return o===0||ee>=o}let Ys=["fire","water","lightning","earth"],Ln=null,zn=!1,ci=500,ai=30,ri=220,Bn=null,Ss=null,Vs={fire:!1,water:!1,lightning:!1,earth:!1};function Ws(){if(!Vt)return;let t=Vt.getBoundingClientRect();t.width>0&&t.height>0&&(Ss=t)}function li(){if(!Vt)return null;let t=Vt.getBoundingClientRect();return t.width>0&&t.height>0?Vt:Ss?{getBoundingClientRect:()=>Ss}:null}function Hn(t=lt.active){if(!Vt||!Us)return;t?(Ln=t,zn=!1):zn||(Ln=null);let o=Ln;if(!o||!ke()||(lt.charges[o]??0)<=0){Ws(),Vt.classList.add("hidden"),Vt.classList.remove("active","ult-ready",...Ys),Vt.style.setProperty("--progress","0%"),Bn&&clearTimeout(Bn),Bn=setTimeout(()=>{Vt.classList.add("gone")},ri);return}Bn&&(clearTimeout(Bn),Bn=null),Vt.classList.remove("gone"),Vt.classList.contains("hidden")?requestAnimationFrame(()=>Vt.classList.remove("hidden")):Vt.classList.remove("hidden"),Us.textContent=yt(o);let y=ys[o];y&&me.selectSpell(y);let $=y?$n(y):0,it=lt.charges[o]??0,mt=!!y&&Zn()&&qn(y),Nt=!!y&&Zn()&&!mt,he=mt&&$>0?Math.min(it/$,1):0,Oe=mt&&$>0,Xe=Oe&&it>=$;Xs&&(Xs.textContent=Oe?`-${$}`:Nt?"\u{1F512}":""),Vt.classList.toggle("no-cost",!Oe&&!Nt),Vt.classList.toggle("locked",Nt),Vt.classList.toggle("ult-ready",Xe),Vt.style.setProperty("--progress",`${Math.round(he*100)}%`),Vt.classList.remove("hidden",...Ys),Vt.classList.add("active",o),Ws()}function di(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),ci))}function jn(){for(let[t,o]of Object.entries(_n)){if(!o)continue;let u=ys[t],y=$n(u),$=Zn()&&ke()&&u,it=typeof qn=="function"?qn(u):!0,mt=$&&it&&y>0&&(lt.charges[t]??0)>=y;o.classList.toggle("ult-ready",mt),mt&&!Vs[t]&&(di(o),Ft==="playing"&&G.play("readysuper")),Vs[t]=mt}}function ke(t=Ce){return t==="30_24"?!0:R}function Es(){Hn(lt.active),jn()}function dc(t){R=t,Ce==="25_20"&&(R?lt.reset():(lt.deactivate(),Object.keys(lt.charges).forEach(o=>{lt.charges[o]=0})),On()),Qn(),Es()}function Qn(){Gs&&(Gs.style.display=ke()?"":"none",Hn(lt.active),jn())}function uc(t){let o=Rn(t),u=$n(t);return!o||u<=0?!1:lt.charges[o]>=u}function fc(t){let o=Rn(t),u=$n(t);return!o||u<=0||lt.charges[o]<u?!1:(lt.charges[o]-=u,lt.updateButtons(),me.pulse(),!0)}let Fn=e.spellWave;function ui(){Fn&&(Fn.classList.remove("active"),Fn.offsetWidth,Fn.classList.add("active"),setTimeout(()=>Fn.classList.remove("active"),1200))}let gn=null,me=$o({button:Vt,onReady:()=>{G.play("readysuper")}}),fi=()=>me.getEffect("earth"),gi=()=>me.getEffect("air"),pi=()=>me.getEffect("fire"),$n=t=>typeof me?.getCost=="function"?me.getCost(t):0,Rn=t=>oi[t]??null;gn=Go({canvas:n,dom:e,getGrid:()=>ot,getN:()=>i,getH:()=>s,getRotFloat:()=>dt,constants:{TOP_PAD_PX:m,BOTTOM_PAD_PX:S,SIDE_MARGIN_PX:w,MAX_RADIUS_X:U,SCORE_MAGIC_DESTROY:A},helpers:{normSector:ss,levelYToScreenY:ts,sectorCenterXY:es},Spell:me,Magic:lt,SoundModule:G,State:be,isGamePlaying:()=>Ft==="playing",addPendingKzDrop:t=>{Ve+=t},getKillRate:g,triggerSpellWave:ui,spawnSpellBubbles:t=>{let o=Rn(me.currentSpell)??"water";ft.spawnSpellBubbles(me.button,o,t)},spawnBonusBubbles:t=>{In.spawnBonusBubbles(t)},getTransmuteEffect:fi,getLightningEffect:gi,getFireEffect:pi,continueMatchProcessing:ns,updateScoreHud:Xn,showBonus:Q,getSpellCost:$n,getSpellElement:Rn,onUltimateApplied:t=>{let o=Rn(t)??Rn(me.currentSpell)??"water";if(typeof ft?.spawnSpellBubbles=="function"){let u=li();u&&ft.spawnSpellBubbles(u,o,ai)}zn=!1,Ln=null,Hn(null),jn()},isSpellBlocked:mi,setScore:t=>{re=t},setCascadeLevel:t=>{ln=t}});function Zn(){return Ce==="30_24"}function Jn(){Hn(lt.active),jn()}let pn=[],Nn=0,an=!1,vn=!1,wn=!1,Ke=0,rn=0,ln=0,An=[];function mi(){return an||vn||wn}function ts(t,o,u){let y=1-u/s;return t+y*o}function es(t,o,u,y,$,it){let mt=($-it)/i*d+r;return{x:t+Math.cos(mt)*u,y:o+Math.sin(mt)*y,ang:mt}}function bs(t,o){let u=n.clientWidth,y=n.clientHeight,$=u*.5,it=(u-2*w)/2,mt=y-m-S,Nt=6,he=i*mt/(Nt*s),Oe=y-S,Xe,Te,ve;he<=Math.min(it,U)?(Xe=he,Te=mt,ve=m):(Xe=Math.min(it,U),Te=Xe*Nt*s/i,ve=Oe-Te);let Gt=Xe*.28,Mt=ts(ve,Te,t+.5),gt=es($,Mt,Xe,Gt,o,dt),Ut=n.getBoundingClientRect();return{x:Ut.left+gt.x,y:Ut.top+gt.y}}function hi(t,o){if(!ke()||!lt.canUse()||an)return!1;let u=wt[lt.active],y=n.clientWidth,$=n.clientHeight,it=y*.5,mt=(y-2*w)/2,Nt=$-m-S,he=6,Oe=i*Nt/(he*s),Xe=$-S,Te,ve,Gt;Oe<=Math.min(mt,U)?(Te=Oe,ve=Nt,Gt=m):(Te=Math.min(mt,U),ve=Te*he*s/i,Gt=Xe-ve);let Mt=Te*.28,gt=null,Ut=1/0;for(let _e=0;_e<s;_e++){let De=ts(Gt,ve,_e+.5);for(let Le=0;Le<i;Le++){let Ye=ot[_e][Le];if(!Ye||Ye!==u)continue;let qe=es(it,De,Te,Mt,Le,dt);if(Math.sin(qe.ang)<-.1)continue;let gs=t-qe.x,Eo=o-qe.y,bo=Math.hypot(gs,Eo),Mo=ve/s*.9,Ki=Mo*1.2;Math.abs(gs)<Ki/2&&Math.abs(Eo)<Mo/2&&bo<Ut&&(Ut=bo,gt={y:_e,s:Le})}}if(gt){let _e=ts(Gt,ve,gt.y+.5),De=es(it,_e,Te,Mt,gt.s,dt),Le=n.getBoundingClientRect(),Ye=Le.left+De.x,qe=Le.top+De.y,So=_n[lt.active];return ft.spawnMagicShot(lt.active,So,Ye,qe,()=>{let gs=ot[gt.y][gt.s];pn=[{y:gt.y,s:gt.s,color:gs,isLine:!1,isMagic:!0}],Nn=performance.now(),an=!0,vn=!0,Ke=0,rn=A,Q(`+${A}`,"score")}),ln=0,lt.useCharge(),vt.magicUsed++,!0}return!1}let gc=100;function pc(t,o){return $s(t,o,s,i)}function vi(){return Wo(ot,s,i)}let yi=Ko;function Si(t){let o=t.map(y=>({...y,color:ot[y.y][y.s]}));for(let y of t)ot[y.y][y.s]=0;let u=s;for(let y of t){let $=y.y;for(let it=1;it<=y.y;it++){let mt=y.y-it;if(ot[mt][y.s]){$=it-1;break}}u=Math.min(u,$)}for(let y of o)ot[y.y-u][y.s]=y.color;return u>0}function Ei(){let t=!0;for(;t;){t=!1;let o=vi();for(let u of o)yi(u)||Si(u)&&(t=!0)}}function bi(){ns()}let Gn=Yo;function Ks(t,o){let u=new Map,y=0,$=0,it=0,mt={},Nt=t.length+o.length;for(let Mt of t){let gt=Ct[Mt.color],Ut=0,_e=0;if(Mt.length>=5?(Ut=nt,_e=Ht,vt.lines5++):Mt.length===4?(Ut=et,_e=at,vt.lines4++):Mt.length===3&&(Ut=l,_e=W,vt.lines3++),ke()&&gt&&Ut>0){lt.addCharges(gt,Ut),mt[gt]=(mt[gt]||0)+Ut;let De=Mt.cells[Math.floor(Mt.cells.length/2)],Le=bs(De.y,De.s),Ye=_n[gt];for(let qe=0;qe<Ut;qe++)setTimeout(()=>{ft.spawnMagicOrb(gt,Le.x,Le.y,Ye)},qe*100)}y+=_e*g(),it+=_e,$+=Mt.length*ce;for(let De of Mt.cells){let Le=`${De.y},${De.s}`;u.has(Le)||u.set(Le,{y:De.y,s:De.s,color:Mt.color,isLine:!0})}}for(let Mt of o){if(vt.pairs++,y+=oe*g(),it+=oe,$+=X,ke()){let gt=[...new Set(Mt.cells.map(Ut=>ot[Ut.y][Ut.s]).filter(Boolean))];if(gt.length>0){let Ut=Mt.cells[Math.floor(Mt.cells.length/2)],_e=bs(Ut.y,Ut.s);gt.forEach((De,Le)=>{let Ye=Ct[De];if(!Ye)return;lt.addCharges(Ye,Jt),mt[Ye]=(mt[Ye]||0)+Jt;let qe=_n[Ye];qe&&setTimeout(()=>{ft.spawnMagicOrb(Ye,_e.x,_e.y,qe)},Le*100)})}}for(let gt of Mt.cells){let Ut=`${gt.y},${gt.s}`;u.has(Ut)||u.set(Ut,{y:gt.y,s:gt.s,color:ot[gt.y][gt.s],isLine:!1})}}let he=Gn(L,Nt-1),Oe=Gn(I,Nt-1),Xe=Gn(k,ln),Te=Gn(v,ln),ve=Math.round($*he*Xe);it=Math.round(it*Oe*Te),y=Math.round(y*Oe*Te);let Gt=0;Nt>1&&(vt.combos++,vt.maxCombo=Math.max(vt.maxCombo,Nt),setTimeout(()=>Q(`COMBO \xD7${Nt}`,"combo"),Gt),Gt+=180,G.play("combo2")),ln>0&&(vt.cascades++,vt.maxCascade=Math.max(vt.maxCascade,ln),setTimeout(()=>Q(`CASCADE \xD7${ln}`,"cascade"),Gt),Gt+=180,G.play("cascade")),(t.length>0||o.length>0)&&G.play("combo");for(let Mt of t){let gt=Mt.length,Ut=gt*ce;setTimeout(()=>Q(`Line-${gt} +${Ut}`,"line",Mt.color),Gt),Gt+=100}for(let Mt of o){let gt=Mt.cells.length>0?ot[Mt.cells[0].y][Mt.cells[0].s]:null;setTimeout(()=>Q(`Pair +${X}`,"pair",gt),Gt),Gt+=100}ve>0&&(setTimeout(()=>Q(`+${ve}`,"score"),Gt),Gt+=120),it>0&&(setTimeout(()=>Q(`+${it}s`,"time"),Gt),Gt+=120);for(let[Mt,gt]of Object.entries(mt))gt>0&&(setTimeout(()=>Q(`+${gt}${yt(Mt)}`,"charge"),Gt),Gt+=120);pn=Array.from(u.values()),Nn=performance.now(),an=!0,vn=!1,Ke=y,rn=ve,On()}function Mi(){for(let t of pn)ot[t.y][t.s]=0;if(pn.length>0&&G.playRandom("disappear"),Ke>0){Ve+=Ke;let t=Ke/g();In.spawnBonusBubbles(t)}be.addScore(rn),re+=rn,Xn(),pn=[],an=!1,vn=!1,Ke=0,rn=0,ln++,ns()}function ns(){Ei();let{lineMatches:t,pairMatches:o}=Ii();if(t.length>0||o.length>0)Ks(t,o);else{let u=Js();u.length>0?Ri(u):!ht&&Ft==="playing"&&Zs()}}function mc(t,o){Ks(t,o)}function ss(t){return Pn(t,i)}function os(){return ss(Math.round(dt))}function qs(t,o){return Ns(ht,t,o,ot,s,i)}function is(t){return qs(t,os())}let cs=Vo;function zs(){Pt&&(Dt!==0&&Yt>=Dt||(Se=0,Yt+=1))}function xi(){if(!ht)return;let t=ht.cells,o=ht.colors,u={cells:t,colors:o};if(ae>=0||(u=cs(u.cells,u.colors),u=cs(u.cells,u.colors)),u=cs(u.cells,u.colors),ht.cells=u.cells,ht.colors=u.colors,!is(Math.floor(At))){ht.cells=t,ht.colors=o;return}G.play("turn"),Ee&&zs()}function Ci(){return qo(ht,At,os(),ot,s,i)}function Ti(){if(!ht)return!1;let t=Math.floor(At)-1,o=!is(t);return o&&!Ee?(Ee=!0,Se=0,Yt=0):!o&&Ee&&(Ee=!1,Se=0,Yt=0),o}let Tn=hs;function Un(){if(Ft==="playing"){h.classList.add("hidden"),Me.classList.remove("hidden");return}if(h.classList.remove("hidden"),Me.classList.add("hidden"),Ft==="intro"){V.classList.remove("hidden"),ut.classList.add("hidden");let t=O.loadHighscore(Ce);t.score>0?(de.textContent=t.score.toLocaleString(),se.textContent=Tn(t.time)):(de.textContent="0",se.textContent="0:00"),Ps(),cn.textContent=`v${je}`,qt.classList.remove("idlePulse"),qt.offsetWidth,qt.classList.add("idlePulse")}else{V.classList.add("hidden"),ut.classList.remove("hidden"),St.textContent=re.toLocaleString(),Rt.textContent=Tn(Ne);let t=O.loadHighscore(Ce);re>0&&re>=t.score?on.classList.remove("hidden"):on.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${vt.rings}</span>
          <span class="count ring-max">${vt.maxRing>0?"max \xD7"+vt.maxRing:""}</span>
        </div>
      `;Et.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${vt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${vt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${vt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${vt.pairs}</span>
        </div>
      `;$t.innerHTML=u;let y=ke()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${vt.magicUsed}</span>
        </div>
      `:"",$=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${vt.combos}</span>
          <span class="count max-combo">${vt.maxCombo>0?"max \xD7"+vt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${vt.cascades}</span>
          <span class="count max-cascade">${vt.maxCascade>0?"max \xD7"+vt.maxCascade:""}</span>
        </div>
        ${y}
      `;Pe.innerHTML=$}}function Xn(){We.textContent=`Score: ${re}`}function Ms(){en.textContent=`Time: ${Tn(Ne)}`}function js(){let t=Math.max(0,(s-$e)/g()),o=Math.floor(t/60),u=Math.floor(t%60);pe.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?pe.classList.add("warning"):pe.classList.remove("warning")}function _i(){p(Ce),J(),$e=0,Ve=0,dt=ge=0,Kt=0,be.start(),vt=be.stats,re=0,En=performance.now(),Ne=0,bn=0,dn=0,Ft="playing",Qe=null,ke()?lt.reset():(lt.deactivate(),Object.keys(lt.charges).forEach(t=>{lt.charges[t]=0}),On()),me.reset(),Jn(),pn=[],An=[],an=!1,vn=!1,wn=!1,Ke=0,rn=0,ln=0,gn.reset(),On(),Xn(),Ms(),js(),Es(),Zs(),In.drawNextPreview(ne,Qe),Un(),G.getSettings().musicEnabled&&G.startGameMusic()}function xs(){be.gameOver(),Ft="gameover",ht=null,Ee=!1,Se=0,Yt=0;let t=O.saveHighscore(re,Ne,Ce);G.stopMusic(),G.play("gameover"),Ms(),Un(),t&&re>0&&setTimeout(()=>{Q("\u{1F3C6} NEW RECORD!","score")},500)}function Li(t){for(let u=0;u<50;u++){let y=t.map(()=>1+(Math.random()*4|0));if(!Bi(t,y))return y}return t.map((u,y)=>1+y%4)}let Bi=Qo;function Qs(t){let o=t.cells.map(y=>({x:y.x,y:y.y})),u=Li(o);return{name:t.name,cells:o,colors:u}}function Zs(){if(!Qe){let $=fe[Math.random()*fe.length|0];Qe=Qs($)}ht=Qe;let t=fe[Math.random()*fe.length|0];Qe=Qs(t),In.drawNextPreview(ne,Qe);let o=1/0,u=-1/0;for(let $ of ht.cells)$.x<o&&(o=$.x),$.x>u&&(u=$.x);let y=(o+u)/2;for(let $ of ht.cells)$.x=$.x-Math.round(y);At=s+3,Fe=0,Ee=!1,Se=0,Yt=0,is(Math.floor(At))?G.playRandom("appear"):xs()}function Js(){return jo(ot,s,i)}function Ri(t){if(t.length===0)return;let o=[];for(let Nt of t)for(let he=0;he<i;he++)o.push({y:Nt,s:he,color:ot[Nt][he],isLine:!1});An=t,pn=o,Nn=performance.now(),an=!0,wn=!0,vn=!1;let u=t.length;vt.rings+=u,vt.maxRing=Math.max(vt.maxRing,u);let y=Gn(He,u-1),$=Math.round(ie*u*y),it=q*u;if(rn=$,Ke=it*g(),ke()){for(let[Nt,he]of Object.entries(N))if(he>0){let Oe=he*u;lt.addCharges(Nt,Oe);let Xe=Math.floor(i/2),Te=t[0],ve=bs(Te,Xe),Gt=_n[Nt];if(Gt)for(let Mt=0;Mt<Oe;Mt++)setTimeout(()=>{ft.spawnMagicOrb(Nt,ve.x,ve.y,Gt)},Mt*100)}}G.play("ring");let mt=`RING \xD7${u}`;Q(mt,"ring"),setTimeout(()=>Q(`+${$}`,"score"),150),setTimeout(()=>Q(`+${it}s`,"time"),300)}function wi(){let t=[...An].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<s-1;u++)ot[u].set(ot[u+1]);ot[s-1].fill(0)}if(Ke>0){Ve+=Ke;let o=Ke/g();In.spawnBonusBubbles(o)}be.addScore(rn),re+=rn,Xn(),Ce==="30_24"&&An.length>0&&(ee=O.addHighTowerRings(An.length)),pn=[],An=[],an=!1,wn=!1,Ke=0,rn=0,ns()}function hc(){return Js().length}function Ai(){if(!ht)return;let t=os();dt=t,ge=t,Kt=0;let o=!1;for(let u=0;u<ht.cells.length;u++){let y=ht.cells[u],$=ht.colors[u],it=Math.floor(At)+y.y,mt=ss(t+y.x);it>=s&&(o=!0),it>=0&&it<s&&(ot[it][mt]=$)}if(o){xs();return}be.addScore(H),re+=H,Xn(),Q(`+${H}`,"score"),G.playRandom("drop"),ht=null,ln=0,bi()}function Ii(){return zo(ot,s,i)}function Pi(){if(!ht)return!1;let t=Math.floor(At)-1;return is(t)?(At=t,Ee=!1,Se=0,Yt=0,!0):(Ee=!0,!1)}n.addEventListener("pointerdown",t=>{if(kt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),u=t.clientX-o.left,y=t.clientY-o.top;Be.handlePointerDown(t,{onMagicTap:ke()?()=>gn.handleTap(u,y)?!0:kt.applyCommand("magic_shoot",{x:u,y}):null,onDoubleTap:()=>kt.applyCommand("rotate_piece")},ge)||(Kt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(kt.state!=="playing"||!Be.dragging)return;t.preventDefault?.();let o=Be.handlePointerMove(t,{canRotateTo:(u,y)=>kt.canRotateTo(u,y),onDrop:()=>kt.applyCommand("move_down"),onGroundedMove:()=>kt.onGroundedMove(),onRotateStep:()=>b.trigger("tower_rotate")},kt.pieceY,kt.isGrounded);o&&kt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{kt.state==="playing"&&Be.handlePointerUp(t,{onSingleTap:()=>kt.applyCommand("rotate_piece")})},{passive:!1}),n.addEventListener("pointercancel",t=>{Be.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Be.dragging&&Be.handlePointerUp(t)},{passive:!1}),_.addEventListener("click",()=>{kt.state==="playing"&&kt.applyCommand("rotate_piece")});let as=e.dropBtn,rs=null;function ki(){kt.state==="playing"&&(kt.applyCommand("move_down"),rs=setInterval(()=>{if(kt.state!=="playing"){ls();return}kt.applyCommand("move_down")},_t))}function ls(){rs&&(clearInterval(rs),rs=null)}as.addEventListener("pointerdown",t=>{t.preventDefault(),ki()}),as.addEventListener("pointerup",ls),as.addEventListener("pointerleave",ls),as.addEventListener("pointercancel",ls);for(let[t,o]of Object.entries(_n))o.addEventListener("click",()=>{kt.state==="playing"&&ke()&&kt.applyCommand("select_magic",{element:t})});Vt&&Vt.addEventListener("click",()=>{if(kt.state!=="playing"||!Zn()||!ke())return;let t=lt.active??Ln;if(!t)return;let o=ys[t];!o||!qn(o)||(me.selectSpell(o),lt.active&&(Ln=lt.active,zn=!0,lt.deactivate()),gn.handleSpellButtonClick())});let Cs=e.soundsToggle,Ts=e.musicToggle;function yn(){let t=G.getSettings();t.soundsEnabled?Cs.classList.add("active"):Cs.classList.remove("active"),t.musicEnabled?Ts.classList.add("active"):Ts.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],y=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),y&&y.classList.toggle("active",t.musicVolume===o)}}let to=e.tabBtns,Oi=e.tabContents;to.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;to.forEach(u=>u.classList.remove("active")),Oi.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Io(o).classList.add("active"),o==="sounds"&&yn()})});let eo=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,no=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Di=e.iosHint,Hi=e.standaloneBadge;function so(){let t=document.fullscreenElement||document.webkitFullscreenElement;P.textContent=t?"Disable":"Enable"}eo&&(no?(Hi.style.display="block",P.style.display="none"):(Di.style.display="block",P.textContent="Not supported",P.style.opacity="0.5",P.style.cursor="default")),P.addEventListener("click",()=>{if(eo&&!no)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",so),document.addEventListener("webkitfullscreenchange",so);let ds=e.invertSwipeToggle,mn=e.hapticsToggle;D.invertSwipe&&ds.classList.add("active"),mn&&(b.supports()?D.hapticsEnabled&&mn.classList.add("active"):(mn.classList.add("disabled"),mn.classList.remove("active"),D.hapticsEnabled=!1,b.setEnabled(!1),O.saveGameSettings(D))),ds.addEventListener("click",()=>{ds.classList.toggle("active");let t=ds.classList.contains("active");Be.rotDir=t?-1:1,D.invertSwipe=t,O.saveGameSettings(D)}),mn&&mn.addEventListener("click",()=>{if(mn.classList.contains("disabled"))return;mn.classList.toggle("active");let t=mn.classList.contains("active");D.hapticsEnabled=t,O.saveGameSettings(D),b.setEnabled(t)});let Yn=e.showControlsToggle,Fi=e.controlsRight;function oo(t){Fi.style.display=t?"":"none",bt=t}bt?Yn.classList.add("active"):Yn.classList.remove("active"),oo(bt),Yn.addEventListener("click",()=>{Yn.classList.toggle("active");let t=Yn.classList.contains("active");oo(t),D.showControls=t,O.saveGameSettings(D)});let us=e.tapRotateToggle;x&&us.classList.add("active"),Be.tapRotateEnabled=x,us.addEventListener("click",()=>{us.classList.toggle("active");let t=us.classList.contains("active");x=t,Be.tapRotateEnabled=t,D.tapRotate=t,O.saveGameSettings(D)}),Cs.addEventListener("click",()=>{let o=!G.getSettings().soundsEnabled;G.updateSettings({soundsEnabled:o}),yn(),Vn()}),Ts.addEventListener("click",()=>{let o=!G.getSettings().musicEnabled;G.updateSettings({musicEnabled:o}),yn(),Vn(),Ft!=="paused"&&(o?Ft==="playing"?G.startGameMusic():G.startMenuMusic():G.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{G.updateSettings({soundVolume:t}),yn(),G.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{G.updateSettings({musicVolume:t}),yn()})}yn();function io(){Ft==="playing"&&(be.pause(),dn=performance.now(),Ft="paused",G.musicAudio&&G.musicAudio.pause())}function fs(){Ft==="paused"&&(be.resume(),bn+=performance.now()-dn,dn=0,Ft="playing",Bs=performance.now(),G.getSettings().musicEnabled&&G.startGameMusic())}function Vn(){let t=G.getSettings();sn.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",sn.classList.toggle("off",!t.soundsEnabled),Re.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Re.classList.toggle("off",!t.musicEnabled)}function $i(){xe.classList.remove("hidden"),Me.classList.add("hidden");let t=O.loadHighscore(Ce);if(Ge.textContent=t.score?t.score.toLocaleString():"0",hn.textContent=t.time?hs(t.time):"0:00",le.textContent=Ce==="30_24"?"High Tower":"Quick Tower",xn.textContent=re.toLocaleString(),Ie.textContent=hs(Ne),Ue.textContent=Ce==="30_24"?"High Tower":"Quick Tower",Vn(),uo){let o=Ce==="30_24";uo.style.display=o?"":"none",o&&Ps()}}function Wn(){xe.classList.add("hidden"),Me.classList.remove("hidden")}Me.addEventListener("click",()=>{io(),$i()}),un.addEventListener("click",()=>{Wn(),fs()});let _s=null;function co(t,o){F.textContent=t,_s=o,T.classList.remove("hidden")}function ao(){T.classList.add("hidden"),_s=null}tt.addEventListener("click",()=>{ao()}),K.addEventListener("click",()=>{let t=_s;ao(),t&&t()}),Mn.addEventListener("click",()=>{co("Restart game?",()=>{Wn(),kt.applyCommand("start_game")})}),fn.addEventListener("click",()=>{co("Exit to menu?",()=>{Wn(),Me.classList.add("hidden"),Ft="intro",be.reset(),G.stopMusic(),G.getSettings().musicEnabled&&G.startMenuMusic(),Un()})}),Zt.addEventListener("click",()=>{Y.classList.remove("hidden")}),sn.addEventListener("click",()=>{let t=G.getSettings();G.updateSettings({soundsEnabled:!t.soundsEnabled}),Vn(),yn()}),Re.addEventListener("click",()=>{let o=!G.getSettings().musicEnabled;G.updateSettings({musicEnabled:o}),Vn(),yn()}),xe.addEventListener("click",t=>{t.target===xe&&(Wn(),fs())}),document.addEventListener("keydown",t=>{Ft==="paused"&&!xe.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Wn(),fs())}),z.addEventListener("click",()=>{Y.classList.add("hidden")}),Y.addEventListener("click",t=>{t.target===Y&&Y.classList.add("hidden")});let Ls=!1;document.addEventListener("visibilitychange",()=>{document.hidden?Ft==="playing"&&(io(),Ls=!0):Ls&&Ft==="paused"&&(fs(),Ls=!1)});let kt=Zo({getN:()=>i,getH:()=>s,FALL_INTERVAL:It,LOCK_DELAY_SEC:M,getKillRate:g,MATCH_HIGHLIGHT_SEC:st,MAGIC_SHRINK_SEC:Tt,RING_HIGHLIGHT_SEC:Ot,getState:()=>({gameState:Ft,score:re,elapsedMs:Ne,startTime:En,totalPausedMs:bn,stats:vt,activePiece:ht,pieceY:At,targetRot:ge,rotFloat:dt,rotVel:Kt,isGrounded:Ee,isHighlighting:an,isMagicAnimation:vn,isRingAnimation:wn,highlightStartTime:Nn,killLevel:$e,grid:ot,fallTimer:Fe,lockTimer:Se}),setState:t=>{"elapsedMs"in t&&(Ne=t.elapsedMs),"killLevel"in t&&($e=t.killLevel),"fallTimer"in t&&(Fe=t.fallTimer),"lockTimer"in t&&(Se=t.lockTimer),"targetRot"in t&&(ge=t.targetRot),"rotFloat"in t&&(dt=t.rotFloat),"rotVel"in t&&(Kt=t.rotVel)},funcs:{startGame:_i,endGame:xs,rotatePieceByDir:xi,tryMoveDown:Pi,canPlaceAtRot:qs,maybeResetLockDelay:zs,shootMagic:hi,selectMagic:si,updateGroundedState:Ti,lockPiece:Ai,finishHighlight:Mi,finishRingHighlight:wi},ui:{updateTimeHud:Ms,updateRemainingHud:js}}),In=Jo({canvas:n,canvasCtx:a,getN:()=>i,getH:()=>s,TOP_PAD_PX:m,BOTTOM_PAD_PX:S,SIDE_MARGIN_PX:w,MAX_RADIUS_X:U,RADIUS_X_FACTOR:pt,ANG_OFFSET:r,MATCH_HIGHLIGHT_SEC:st,MATCH_SHRINK_PHASE:ct,MAGIC_SHRINK_SEC:Tt,RING_HIGHLIGHT_SEC:Ot,LOCK_DELAY_SEC:M,getKillRate:g,ELEMENT_COLORS:j,ELEMENT_TO_COLOR:wt,BLOCK_COLOR_FRONT:Xt,BLOCK_COLOR_BACK:ye,ACTIVE_COLOR_FRONT:zt,GHOST_COLOR_FILL:xt,GHOST_COLOR_STROKE:Wt,GHOST_STROKE_WIDTH:rt,MAGIC_DIM_DOT_ALPHA:ue,MAGIC_DIM_DOT_SCALE:Lt,MAGIC_TARGET_DOT_SCALE:te,getState:()=>({gameState:Ft,grid:ot,activePiece:ht,pieceY:At,rotFloat:dt,killLevel:$e,isHighlighting:an,highlightedCells:pn,highlightStartTime:Nn,isMagicAnimation:vn,isRingAnimation:wn,isGrounded:Ee,lockTimer:Se,spellState:gn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Sn,waterColor:kn}),funcs:{snappedRot:os,computeGhostY:Ci,normSector:ss,getMagicTargetColor:()=>ke()&&lt.canUse()?wt[lt.active]:null,getTransmuteAnimState:t=>gn.getTransmuteAnimState(t),getLightningAnimState:t=>gn.getLightningAnimState(t),getFireAnimState:t=>gn.getFireAnimState(t)}}),Bs=performance.now();function ro(t){let o=Math.min(.05,Math.max(.001,(t-Bs)/1e3));if(Bs=t,kt.update(o,t),gn.update(t),Ve>0){let u=Math.min(Ve,Qt*o);$e=Math.max(0,$e-u),Ve-=u}dt=ge,dt>1e6&&(dt%=i),dt<-1e6&&(dt%=i),In.render(o,t),requestAnimationFrame(ro)}qt.addEventListener("click",()=>{kt.applyCommand("start_game")}),Cn.addEventListener("click",()=>{kt.applyCommand("start_game")}),we.addEventListener("click",()=>{Ft="intro",be.reset(),G.stopMusic(),G.getSettings().musicEnabled&&G.startMenuMusic(),Un()}),Ze.forEach(t=>{t.addEventListener("click",o=>{Ze.forEach(y=>y.classList.remove("active")),t.classList.add("active"),Ce=t.dataset.mode,Jn(),Qn();let u=O.loadHighscore(Ce);u.score>0?(de.textContent=u.score.toLocaleString(),se.textContent=Tn(u.time)):(de.textContent="0",se.textContent="0:00"),qt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>qt.classList.add("idlePulse"),2e3)})});let Rs=document.querySelectorAll(".spell-select-btn"),ws=document.getElementById("spellDesc"),Ni=document.getElementById("spellProgressFill"),lo=document.getElementById("spellProgressMarkers"),uo=document.getElementById("pauseSpellProgress"),Gi=document.getElementById("pauseSpellProgressFill"),fo=document.getElementById("pauseSpellProgressMarkers"),go=document.getElementById("pauseSpellProgressLabel");function As(){return ii.map(t=>Dn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Is(t){return t.length?Math.max(...t):0}function Ui(t){let o=As(),u=Is(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function po(t){if(!t)return;t.innerHTML="";let o=As(),u=Is(o);o.forEach(y=>{let $=document.createElement("span");$.className="marker",$.dataset.threshold=y;let it=u>0?y/u*100:0;$.style.left=`${it}%`,t.appendChild($)})}function mo(t,o){if(!t)return;let u=Xi(o);t.style.width=`${u}%`}function ho(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(y=>{let $=parseInt(y.dataset.threshold,10)||0;y.classList.toggle("reached",o>=$)})}function Xi(t){let o=As(),u=Is(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function vo(t){if(!ws)return;let o=Dn(t),u=me.getDescription(t);o===0||ee>=o?ws.innerHTML=u:ws.innerHTML=`${u} <span class="spell-progress-text">${ee}/${o}</span>`}function Ps(){ee=O.loadHighTowerRings(),Rs.forEach(o=>{let u=o.dataset.spell,y=Dn(u),$=ee>=y;o.classList.toggle("locked",!$);let it=o.querySelector(".spell-lock");it&&(it.style.display=$?"none":"")}),mo(Ni,ee),mo(Gi,ee),ho(lo,ee),ho(fo,ee),go&&(go.textContent=Ui(ee));let t=document.querySelector(".spell-select-btn.active");t&&vo(t.dataset.spell)}po(lo),po(fo),Ps(),Rs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){Ze.forEach(Nt=>Nt.classList.remove("active")),u.classList.add("active"),Ce="30_24",Jn(),Qn();let mt=O.loadHighscore(Ce);mt.score>0?(de.textContent=mt.score.toLocaleString(),se.textContent=Tn(mt.time)):(de.textContent="0",se.textContent="0:00")}let y=t.dataset.spell,$=Dn(y),it=ee>=$;vo(y),it&&(Rs.forEach(mt=>mt.classList.remove("active")),t.classList.add("active"),me.selectSpell(y),Hn(lt.active))})}),vs.addEventListener("click",()=>{let t=O.loadHighscore("30_24"),o=O.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Tn(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Tn(o.time)}
`:`  No record yet
`,alert(u)}),Kn.addEventListener("click",()=>{Y.classList.remove("hidden")}),On(),Qn(),Jn(),Un(),G.startMenuMusic();let Yi=()=>{if(G.unlock(),!G.getSettings().musicEnabled)return;let t=G.musicAudio;!t||t.paused||t.ended?kt.state==="playing"?G.startGameMusic():G.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},yo=0,Vi=10,Wi=()=>{yo>=Vi||(yo++,Yi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Wi,{passive:!0})}),requestAnimationFrame(ro)})();})();
