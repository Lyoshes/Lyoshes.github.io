(()=>{var qo=[0,.25,.5,.75,1],jo=[0,.05,.15,.25,.5],Qo={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Xs={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Us="soundSettings";function Zo(){try{let e=localStorage.getItem(Us);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Jo(e){try{localStorage.setItem(Us,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Ys(){return{audioContext:null,buffers:{},settings:Zo(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return qo[this.settings.soundVolume]},getMusicVolume(){return jo[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let o=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(o);this.buffers[n]=s}catch(a){console.debug(`Failed to load sound: ${n} from ${c}`,a)}},preload(){this.initContext();for(let[n,c]of Object.entries(Qo))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let a=n;c!==null&&(a=`${n}${c}`);let o=this.buffers[a];if(o)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let i=this.audioContext.createBufferSource();i.buffer=o,i.connect(s),i.start(0),i.onended=()=>{i.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Xs.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Xs.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Jo(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Vs="eb_highscore",Ws="eb_highscore_quick",Ks="eb_settings",zs="eb_high_tower_rings",ti={invertSwipe:!1,difficulty:"easy",magicEnabled:!1};function qs(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Ws:Vs,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let a=this.loadHighscore(c);if(e>a.score||e===a.score&&n>a.time){let o=c==="25_20"?Ws:Vs;return localStorage.setItem(o,JSON.stringify({score:e,time:n})),!0}}catch(a){console.debug("Failed to save highscore:",a)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Ks);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ti}},saveGameSettings(e){try{localStorage.setItem(Ks,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(zs);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(zs,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function js(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),magicToggle:document.getElementById("magicToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Qs(e){return document.getElementById("tab-"+e)}var ei={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Zs(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(a,o="score",s=null){let i=document.createElement("div");i.className=`bonus-popup ${o}`,i.textContent=a,s&&n[s]&&(i.style.color=n[s]);let l=window.innerWidth/2,g=window.innerHeight/2-40,p=(Math.random()-.5)*200,f=(Math.random()-.5)*100+c*36;i.style.left=`${l+p}px`,i.style.top=`${g+f}px`,i.style.transform="translate(-50%, -50%)",document.body.appendChild(i),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{i.remove()},1800)},getElementIcon(a){return ei[a]||"\u2726"}}}var Js={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function to(){return{spawnMagicOrb(e,n,c,a){if(!a)return;let o=document.createElement("div");o.className=`magic-orb ${e}`,o.textContent=Js[e]||"\u2726";let s=a.getBoundingClientRect(),i=s.left+s.width/2-n,l=s.top+s.height/2-c,g=Math.hypot(i,l),p=Math.atan2(l,i),f=g*.35*(Math.random()>.5?1:-1),h=p+Math.PI/2,A=i*.5+Math.cos(h)*f,z=l*.5+Math.sin(h)*f;o.style.setProperty("--mid-x",`${A}px`),o.style.setProperty("--mid-y",`${z}px`),o.style.setProperty("--end-x",`${i}px`),o.style.setProperty("--end-y",`${l}px`),o.style.left=`${n}px`,o.style.top=`${c}px`,document.body.appendChild(o),setTimeout(()=>{o.remove()},700)},spawnMagicShot(e,n,c,a,o){if(!n){o&&o();return}let s=n.getBoundingClientRect(),i=s.left+s.width/2,l=s.top+s.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=Js[e]||"\u2726";let p=c-i,f=a-l;g.style.setProperty("--end-x",`${p}px`),g.style.setProperty("--end-y",`${f}px`),g.style.left=`${i}px`,g.style.top=`${l}px`,document.body.appendChild(g);let h=setInterval(()=>{let A=g.getBoundingClientRect();this.spawnTrailParticle(e,A.left+A.width/2,A.top+A.height/2)},40);setTimeout(()=>{clearInterval(h),g.remove(),this.spawnExplosion(e,c,a),o&&o()},300)},spawnTrailParticle(e,n,c){let a=document.createElement("div");a.className=`magic-trail ${e}`,a.style.left=`${n}px`,a.style.top=`${c}px`,document.body.appendChild(a),setTimeout(()=>a.remove(),400)},spawnExplosion(e,n,c){for(let o=0;o<12;o++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let i=o/12*Math.PI*2+(Math.random()-.5)*.5,l=40+Math.random()*40,g=Math.cos(i)*l,p=Math.sin(i)*l;s.style.setProperty("--px",`${g}px`),s.style.setProperty("--py",`${p}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let c=e.getBoundingClientRect(),a=c.left+c.width/2,o=c.top+c.height/2,s=Math.max(8,Math.round(n));for(let i=0;i<s;i++){let l=document.createElement("div");l.className="spell-bubble",l.textContent="\u25CF";let g=i/s*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,f=Math.cos(g)*p,h=Math.sin(g)*p-20;l.style.setProperty("--px",`${f}px`),l.style.setProperty("--py",`${h}px`),l.style.left=`${a}px`,l.style.top=`${o}px`,l.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let a=document.createElement("div");a.className="spell-orb",a.textContent="\u2727";let o=c.getBoundingClientRect(),s=o.left+o.width/2-e,i=o.top+o.height/2-n,l=Math.hypot(s,i),g=Math.atan2(i,s),p=l*.35*(Math.random()>.5?1:-1),f=g+Math.PI/2,h=s*.5+Math.cos(f)*p,A=i*.5+Math.sin(f)*p;a.style.setProperty("--mid-x",`${h}px`),a.style.setProperty("--mid-y",`${A}px`),a.style.setProperty("--end-x",`${s}px`),a.style.setProperty("--end-y",`${i}px`),a.style.left=`${e}px`,a.style.top=`${n}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},700)}}}function eo(e={}){let{buttons:n={},onActivate:c=null}=e,a={fire:3,water:3,lightning:3,earth:3},o=null;function s(){for(let[l,g]of Object.entries(n)){if(!g)continue;let p=a[l],f=g.querySelector(".charges");f&&(f.textContent=p),g.classList.toggle("empty",p<=0),g.classList.toggle("active",o===l&&p>0)}}function i(l){let g=n[l];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return a},get active(){return o},set active(l){o=l},select(l){if(a[l]<=0)return!1;let g=o===l;return o=g?null:l,s(),!g&&o===l&&c&&c(),!g},useCharge(){if(!o||a[o]<=0)return!1;let l=o;return a[l]--,o=null,s(),i(l),!0},addCharges(l,g){a[l]!==void 0&&(a[l]+=g,s(),i(l))},canUse(){return o!==null&&a[o]>0},deactivate(){o=null,s()},reset(){a.fire=3,a.water=3,a.lightning=3,a.earth=3,o=null,s()},updateButtons:s,initButtons(l){for(let[g,p]of Object.entries(n))p&&p.addEventListener("click",()=>{l&&l(g)})}}}var Rn={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:6,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:10,effect:{type:"chain_lightning",areaSize:6,maxBlocks:10,jumpMs:180,flashMs:250}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:8,effect:{type:"transmutation",areaSize:6,maxBlocks:10,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:12,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function no(e={}){let{button:n=null,onActivate:c=null,onProgress:a=null,onReady:o=null}=e,s="ice",i=0;function l(){return Rn[s]||Rn.ice}function g(){if(!n)return;let f=l(),h=Math.min(i/f.maxProgress,1)*100,A=i>=f.maxProgress;n.style.setProperty("--progress",`${h}%`);let z=n.querySelector(".spell-icon");z&&(z.textContent=f.icon);let F=n.querySelector(".spell-counter");F&&(F.textContent=`${Math.min(i,f.maxProgress)}/${f.maxProgress}`),n.classList.toggle("ready",A),n.classList.toggle("charging",!A&&i>0),a&&a(i,f.maxProgress)}function p(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return i},get maxProgress(){return l().maxProgress},get isReady(){return i>=l().maxProgress},get effect(){return l().effect},getEffect(f){return(Rn[f]||Rn.ice).effect},get button(){return n},selectSpell(f){Rn[f]&&(s=f,i=0,g())},addProgress(f=1){let h=l();if(i>=h.maxProgress)return!1;let A=i<h.maxProgress;return i=Math.min(i+f,h.maxProgress),g(),p(),A&&i>=h.maxProgress&&o&&o(),!0},canUse(){return i>=l().maxProgress},use(){if(!this.canUse())return null;let f=l().effect;return i=0,g(),p(),c&&c(s),f},reset(){i=0,g()},updateButton:g,initButton(f){n&&n.addEventListener("click",()=>{f&&f()})}}}function us({centerY:e,centerS:n,size:c,H:a,normSector:o}){let s=[],i=Math.floor(c/2);for(let l=-i;l<=i;l++)for(let g=-i;g<=i;g++){let p=e+l,f=o(n+g);if(p<0||p>=a)continue;let h=l*l+g*g;s.push({y:p,s:f,distSq:h})}return s}function ds(e,n,c){return n.filter(a=>e[a.y][a.s]===c)}function gs(e,n){return[...e].sort((a,o)=>a.distSq!==o.distSq?a.distSq-o.distSq:a.y!==o.y?a.y-o.y:a.s-o.s).slice(0,n).map(a=>({y:a.y,s:a.s}))}function so({centerY:e,centerS:n,beamLength:c,beamWidth:a,N:o,H:s,normSector:i}){if(e<0||e>=s||a<=0||c<0||o<=0)return[];let l=Math.min(a,s),g=[],p=new Set,f=F=>F<0||F>=s||p.has(F)?!1:(p.add(F),g.push(F),!0);f(e);for(let F=1;g.length<l&&(e+F<s||e-F>=0)&&(f(e+F),!(g.length>=l));F++)f(e-F);g.sort((F,q)=>q-F);let h=Math.min(o,c*2+1),A=c%2===0,z=[];for(let F of g){let q=new Set,st=(ot,le)=>{let Q=i(ot);return q.has(Q)?!1:(q.add(Q),z.push({y:F,s:Q,dist:le}),!0)};st(n,0);for(let ot=1;q.size<h&&ot<o;ot++)if(A){if(st(n+ot,ot),q.size>=h)break;st(n-ot,ot)}else{if(st(n-ot,ot),q.size>=h)break;st(n+ot,ot)}}return z}function oo(e){let{canvas:n,dom:c,getGrid:a,getN:o,getH:s,getRotFloat:i,constants:l,helpers:g,Spell:p,Magic:f,SoundModule:h,State:A,isGamePlaying:z,addPendingKzDrop:F,getKillRate:q,triggerSpellWave:st,spawnSpellBubbles:ot,spawnBonusBubbles:le,getTransmuteEffect:Q,getLightningEffect:W,getFireEffect:Mt,continueMatchProcessing:be,updateScoreHud:fe,showBonus:jt,setScore:ae,setCascadeLevel:Qt}=e,{TOP_PAD_PX:me,BOTTOM_PAD_PX:Nt,SIDE_MARGIN_PX:Xt,MAX_RADIUS_X:_t,SCORE_MAGIC_DESTROY:r}=l,{normSector:Z,levelYToScreenY:K,sectorCenterXY:we}=g,Zt=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],xt="idle",Gt=null,re=null,pe=[],Wt=[],pt=0,Ce=null,Ue=0,Pt="idle",Jt=null,ht=[],wt=[],vt=0,$e=0,It="idle",Pe=null,w=[],S=[],B=0;function k(){xt="selecting_source",Gt=null,re=null,pe=[],Wt=[],Pt!=="idle"&&R(),It!=="idle"&&rt(),f.deactivate(),h.play("ulta");let m=c.spellBtn;m&&m.classList.add("selecting")}function C(){xt!=="idle"&&h.play("cancel"),xt="idle",Gt=null,re=null,pe=[],Wt=[],P();let m=c.spellBtn;m&&m.classList.remove("selecting")}function E(m,V){if(xt!=="selecting_source")return!1;let x=L(m,V);if(!x)return C(),!0;let U=a();Gt={y:x.y,s:x.s,color:U[x.y][x.s]},pe=us({centerY:x.y,centerS:x.s,size:Q().areaSize,H:s(),normSector:Z});let Tt=Gt.color,Et=ds(U,pe,Tt);return Wt=gs(Et,Q().maxBlocks),it(Gt.color,x.y),xt="selecting_target",!0}function L(m,V){let x=n.clientWidth,U=n.clientHeight,Tt=x*.5,Et=(x-2*Xt)/2,ye=U-me-Nt,en=6,Yt=s(),Ve=o(),We=i(),Se=Ve*ye/(en*Yt),Kt=U-Nt,Ot,se,Vt;Se<=Math.min(Et,_t)?(Ot=Se,se=ye,Vt=me):(Ot=Math.min(Et,_t),se=Ot*en*Yt/Ve,Vt=Kt-se);let Ee=Ot*.28,Te=null,Oe=1/0,ke=a();for(let oe=0;oe<Yt;oe++){let de=K(Vt,se,oe+.5);for(let zt=0;zt<Ve;zt++){if(!ke[oe][zt])continue;let _e=we(Tt,de,Ot,Ee,zt,We);if(Math.sin(_e.ang)<-.1)continue;let Be=m-_e.x,nn=V-_e.y,Ht=Math.hypot(Be,nn),Me=se/Yt*.9,un=Me*1.2;Math.abs(Be)<un/2&&Math.abs(nn)<Me/2&&Ht<Oe&&(Oe=Ht,Te={y:oe,s:zt})}}return Te}function it(m,V){P();let x=document.createElement("div");x.className="transmute-popup";let U=n.clientWidth,Tt=n.clientHeight,Et=(U-2*Xt)/2,ye=Tt-me-Nt,en=6,Yt=s(),Ve=o(),We=Ve*ye/(en*Yt),Se=Tt-Nt,Kt,Ot;We<=Math.min(Et,_t)?(Kt=ye,Ot=me):(Kt=Math.min(Et,_t)*en*Yt/Ve,Ot=Se-Kt);let se=K(Ot,Kt,V+.5),Vt=Math.floor(Q().areaSize/2),Ee=K(Ot,Kt,Math.min(Yt,V+Vt)+.5),Te=K(Ot,Kt,Math.max(0,V-Vt)+.5),Oe=Ot+Kt/2,ke=document.getElementById("gameContainer"),oe=ke?ke.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},de=160,zt=60,_e=20,rn=oe.left+oe.width/2-de/2,Be;se<Oe?Be=oe.top+Te+_e:Be=oe.top+Ee-zt-_e,Be=Math.max(10,Math.min(window.innerHeight-zt-10,Be)),x.style.left=`${rn}px`,x.style.top=`${Be}px`,Zt.filter(Ht=>Ht.color!==m).forEach(Ht=>{let Me=document.createElement("button");Me.className=`transmute-btn ${Ht.name}`,Me.innerHTML=Ht.icon,Me.setAttribute("data-color",Ht.color),Me.addEventListener("click",un=>{un.stopPropagation(),y(Ht.color)}),x.appendChild(Me)}),document.body.appendChild(x),Ce=x,Ue=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",at)},50)}function at(m){performance.now()-Ue<200||Ce&&!Ce.contains(m.target)&&C()}function P(){document.removeEventListener("pointerdown",at),Ce&&(Ce.remove(),Ce=null)}function y(m){P(),re=m,p.use(),v()}function v(){if(!Gt){C();return}if(Wt.length===0){C();return}let m=c.spellBtn;m&&m.classList.remove("selecting"),xt="animating",pt=performance.now(),h.play("esseffect")}function X(m){if(xt!=="animating")return!1;let V=(m-pt)/1e3;return Math.min(V/Q().animSec,1)>=1?(b(),!1):!0}function yt(m){if(xt!=="animating")return null;let V=(m-pt)/1e3,x=Math.min(V/Q().animSec,1),U="flash",Tt=0,Et=0;return x<.15?(U="flash",Et=1-x/.15):x<.55?(U="shrink",Tt=(x-.15)/.4):(U="grow",Tt=(x-.55)/.45),{phase:U,progress:Tt,areaFlash:Et}}function b(){let m=a();for(let V of Wt)m[V.y][V.s]=re;xt="idle",Gt=null,re=null,pe=[],Wt=[],Qt(0),be()}function St(){h.play("ulta"),Pt="selecting_source",Jt=null,ht=[],wt=[],$e=0,xt!=="idle"&&(xt="idle",Gt=null,re=null,pe=[],Wt=[],P()),It!=="idle"&&(It="idle",Pe=null,w=[],S=[],B=0),f.deactivate();let m=c.spellBtn;m&&m.classList.add("selecting")}function R(){Pt!=="idle"&&h.play("cancel"),Pt="idle",Jt=null,ht=[],wt=[],$e=0;let m=c.spellBtn;m&&m.classList.remove("selecting")}function te(){It="selecting_source",Pe=null,w=[],S=[],B=0,xt!=="idle"&&(xt="idle",Gt=null,re=null,pe=[],Wt=[],P()),Pt!=="idle"&&(Pt="idle",Jt=null,ht=[],wt=[],$e=0),f.deactivate(),h.play("ulta");let m=c.spellBtn;m&&m.classList.add("selecting")}function rt(){It!=="idle"&&h.play("cancel"),It="idle",Pe=null,w=[],S=[],B=0;let m=c.spellBtn;m&&m.classList.remove("selecting")}function Dt(m,V){if(Pt!=="selecting_source")return!1;let x=L(m,V);if(!x)return R(),!0;let U=a();Jt={y:x.y,s:x.s,color:U[x.y][x.s]},ht=us({centerY:x.y,centerS:x.s,size:W().areaSize,H:s(),normSector:Z});let Tt=Jt.color,Et=ds(U,ht,Tt);return wt=gs(Et,W().maxBlocks),wt.length===0?(R(),!0):(p.use(),ne(),!0)}function ee(m,V){if(It!=="selecting_source")return!1;let x=L(m,V);if(!x)return rt(),!0;let U=a();return Pe={y:x.y,s:x.s,color:U[x.y][x.s]},w=so({centerY:x.y,centerS:x.s,beamLength:Mt().beamLength,beamWidth:Mt().beamWidth,N:o(),H:s(),normSector:Z}),S=w.filter(Tt=>U[Tt.y][Tt.s]),S.length===0?(rt(),!0):(p.use(),H(),!0)}function ne(){if(!Jt||wt.length===0){R();return}let m=c.spellBtn;m&&m.classList.remove("selecting"),Pt="animating",vt=performance.now(),$e=0,h.play("asseffect")}function mn(m){if(Pt!=="animating")return!1;let V=m-vt,x=W().flashMs+wt.length*W().jumpMs;return V>=x?(an(),!1):!0}function Ut(m){if(Pt!=="animating")return null;let V=m-vt;if(V<W().flashMs)return{phase:"flash",flashProgress:1-V/W().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let x=V-W().flashMs,U=Math.floor(x/W().jumpMs),Tt=x%W().jumpMs/W().jumpMs,Et=[];for(let ye=0;ye<Math.min(U,wt.length);ye++)Et.push(ye);return{phase:"chain",flashProgress:0,currentTarget:Math.min(U,wt.length-1),jumpProgress:Tt,struckTargets:Et}}function an(){let m=a(),x=wt.length*r;A.addScore(x),ae(A.score),fe(),jt(`+${x}`,"score");for(let U of wt)m[U.y][U.s]=0;Pt="idle",Jt=null,ht=[],wt=[],$e=0,Qt(0),be()}function H(){if(!Pe||S.length===0){rt();return}let m=c.spellBtn;m&&m.classList.remove("selecting"),It="animating",B=performance.now(),h.play("fsseffect")}function ut(m){return It!=="animating"?!1:(m-B)/1e3>=Mt().animSec?(Rt(),!1):!0}function tt(m){if(It!=="animating")return null;let V=Math.max(.001,Mt().animSec),x=(m-B)/1e3,U=Math.min(x/V,1),Tt=.25,Et=U<Tt?1-U/Tt:0;return{progress:U,flashProgress:Et}}function Rt(){let m=a(),V=S.length;if(V>0){let x=V*r;A.addScore(x),ae(A.score),fe(),jt(`+${x}`,"score")}for(let x of S)m[x.y][x.s]=0;It="idle",Pe=null,w=[],S=[],B=0,Qt(0),be()}function he(){if(!(typeof z=="function"?z():A.isPlaying())||!p.canUse())return!1;let V=p.currentSpell;if(V==="ice"){let x=p.use();return x?(typeof F=="function"&&typeof q=="function"&&F(x.duration*q()),h.play("wsseffect"),jt(`\u{1F4A7} -${x.duration}s`,"time"),typeof st=="function"&&st(),typeof ot=="function"&&ot(x.duration),typeof le=="function"&&le(x.duration),!0):!1}return V==="earth"?(xt==="idle"?k():C(),!0):V==="air"?(Pt==="idle"?St():R(),!0):V==="fire"?(It==="idle"?te():rt(),!0):(p.use(),!0)}function ve(m){X(m),mn(m),ut(m)}function ue(m,V){return xt==="selecting_source"?E(m,V):Pt==="selecting_source"?Dt(m,V):It==="selecting_source"?ee(m,V):!1}function Ye(){xt="idle",Gt=null,re=null,pe=[],Wt=[],P(),Pt="idle",Jt=null,ht=[],wt=[],$e=0,It="idle",Pe=null,w=[],S=[],B=0;let m=c.spellBtn;m&&m.classList.remove("selecting")}function Ie(){return{transmuteState:xt,transmuteSourceBlock:Gt,transmuteTargetColor:re,transmuteAreaCells:pe,transmuteBlocksToChange:Wt,lightningState:Pt,lightningSourceBlock:Jt,lightningAreaCells:ht,lightningBlocksToHit:wt,fireState:It,fireSourceBlock:Pe,fireLineCells:w,fireTargets:S}}return{startTransmuteSourceSelection:k,cancelTransmutation:C,startLightningSourceSelection:St,cancelLightning:R,startFireSourceSelection:te,cancelFire:rt,handleTap:ue,update:ve,reset:Ye,getRenderState:Ie,getTransmuteAnimState:yt,getLightningAnimState:Ut,getFireAnimState:tt,handleSpellButtonClick:he,isTransmuteSelecting:()=>xt==="selecting_source",isLightningSelecting:()=>Pt==="selecting_source"}}var ni={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function io(e={}){let{canvas:n}=e,c=e.rotDir||1,a=!1,o=0,s=0,i=0,l=0,g=0,p=1,f=null,h=0,A=0,z=0,F=0,q=0,st=0,ot=0,le=0,Q=ni;return{get rotDir(){return c},set rotDir(W){c=W},get dragging(){return a},get dragMode(){return f},handlePointerDown(W,Mt,be){if(Mt.onMagicTap&&Mt.onMagicTap(W.clientX,W.clientY))return!0;let fe=performance.now(),jt=fe-st,ae=W.clientX-ot,Qt=W.clientY-le,me=Math.hypot(ae,Qt);return jt<=Q.DOUBLE_TAP_MS&&me<=Q.DOUBLE_TAP_MAX_DIST?(Mt.onDoubleTap&&Mt.onDoubleTap(),st=0):(st=fe,ot=W.clientX,le=W.clientY),a=!0,p=-1,o=W.clientX,s=W.clientY,i=be,l=0,g=0,f=null,h=fe,A=W.clientX,z=W.clientY,F=h,q=0,n&&n.setPointerCapture(W.pointerId),!1},handlePointerMove(W,Mt,be,fe){if(!a)return null;let jt=W.clientX-o,ae=W.clientY-s,Qt=performance.now();if(Math.abs(jt)<Q.DEADZONE_PX&&Math.abs(ae)<Q.DEADZONE_PX)return null;if(!f){let Nt=Math.abs(jt),Xt=Math.abs(ae);if(ae<0)Nt>=Q.DEADZONE_PX&&(f="rotate");else if(Xt>=Nt*Q.AXIS_DOMINANCE){if(Xt>=Q.DROP_SWIPE_MIN_DISTANCE){let _t=Math.max(1,Qt-h);Xt/_t*1e3>=Q.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else Nt>=Xt*Q.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let me=null;if(f==="rotate"&&Math.abs(jt)>=Q.DEADZONE_PX){let Nt=Math.max(1,Qt-F),Xt=W.clientX-A,_t=Math.max(1,Math.abs(Xt)/Nt*1e3),r=Math.max(Q.MIN_ROT_PX,Math.min(Q.MAX_ROT_PX,Q.PX_PER_STEP*(Q.SWIPE_SPEED_REF/_t)));q+=-Xt/r*c*p;let Z=Math.trunc(q);Z!==0&&(q-=Z);let K=l+Z;if(K!==l&&Mt.canRotateTo){let we=Math.sign(K-l),Zt=i+l;for(;l!==K;){let xt=l+we,Gt=i+xt;if(!Mt.canRotateTo(Math.floor(be),Gt))break;l=xt,Zt=Gt,fe&&Mt.onGroundedMove&&Mt.onGroundedMove()}me={targetRot:Zt,rotFloat:Zt}}}if(f==="drop"&&ae>Q.DEADZONE_PX&&Mt.onDrop){let Nt=Math.max(1,Qt-F),Xt=W.clientY-z,_t=Math.max(1,Xt/Nt*1e3),r=Math.max(Q.MIN_DROP_PX,Math.min(Q.MAX_DROP_PX,Q.PX_PER_DROP*(Q.SWIPE_SPEED_REF/_t))),Z=Math.trunc(ae/r);if(Z>g){let K=Z-g;for(let we=0;we<K;we++)Mt.onDrop();g=Z}}return A=W.clientX,z=W.clientY,F=Qt,me},handlePointerUp(W){if(a&&(a=!1,f=null,n&&W&&W.pointerId!==void 0))try{n.releasePointerCapture(W.pointerId)}catch{}},reset(){a=!1,f=null,l=0,g=0,q=0}}}var fs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function co(){let e="intro",n=0,c=0,a=0,o=0,s=0,i={...fs};return{get state(){return e},get score(){return n},get elapsedMs(){return a},get startTime(){return c},get stats(){return i},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),a=0,o=0,s=0,i={...fs}},pause(){return e!=="playing"?!1:(e="paused",o=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",o>0&&(s+=performance.now()-o,o=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(l){n+=l},setScore(l){n=l},updateTime(){e==="playing"&&c>0&&(a=performance.now()-c-s)},getFormattedTime(){let l=Math.floor(a/1e3),g=Math.floor(l/60),p=l%60;return`${g}:${p.toString().padStart(2,"0")}`},incrementStat(l,g=1){l in i&&(i[l]+=g)},updateMaxStat(l,g){l in i&&g>i[l]&&(i[l]=g)},reset(){e="intro",n=0,c=0,a=0,o=0,s=0,i={...fs}}}}function Mn(e,n){return e%=n,e<0&&(e+=n),e}function lo(e,n){return e[Math.min(n,e.length-1)]}function jn(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),a=n%60;return`${c}:${a.toString().padStart(2,"0")}`}function ao(e,n){let c=e.map(({x:l,y:g},p)=>({x:g,y:-l,color:n[p]})),a=1/0,o=-1/0,s=1/0;for(let l of c)a=Math.min(a,l.x),o=Math.max(o,l.x),s=Math.min(s,l.y);let i=Math.round((a+o)/2);for(let l of c)l.x-=i,l.y-=s;return c.sort((l,g)=>l.y-g.y||l.x-g.x),{cells:c.map(l=>({x:l.x,y:l.y})),colors:c.map(l=>l.color)}}function ms(e,n,c,a){let o=[];return e+1<c&&o.push({y:e+1,s:n}),e-1>=0&&o.push({y:e-1,s:n}),o.push({y:e,s:Mn(n-1,a)}),o.push({y:e,s:Mn(n+1,a)}),o}function ro(e,n,c){let a=Array.from({length:n},()=>new Uint8Array(c)),o=[];for(let s=0;s<n;s++)for(let i=0;i<c;i++){if(!e[s][i]||a[s][i])continue;let l=[],g=[{y:s,s:i}];for(a[s][i]=1;g.length>0;){let p=g.shift();l.push(p);for(let f of ms(p.y,p.s,n,c))e[f.y][f.s]&&!a[f.y][f.s]&&(a[f.y][f.s]=1,g.push(f))}o.push(l)}return o}function uo(e){return e.some(n=>n.y===0)}function ps(e,n,c,a,o,s){if(!e)return!1;let i=Mn(c,s);for(let l of e.cells){let g=n+l.y,p=Mn(i+l.x,s);if(g<0)return!1;if(!(g>=o)&&a[g][p])return!1}return!0}function go(e,n,c,a,o,s){if(!e)return null;let i=Math.floor(n);for(;ps(e,i-1,c,a,o,s);)i-=1;return i}function fo(e,n,c){let a=[],o=[];for(let s=0;s<n;s++){let i=[],l=0,g=e[s][0],p=g?1:0;for(let f=1;f<=c;f++){let h=f<c?e[s][f]:0;h&&h===g?p++:(p>=1&&g&&i.push({start:l,length:p,color:g}),l=f,g=h,p=h?1:0)}if(i.length>=2){let f=i[0],h=i[i.length-1];if(f.start===0&&h.start+h.length===c&&f.color===h.color){let A=f.length+h.length;i[0]={start:h.start,length:A,color:f.color},i.pop()}}for(let f of i)if(f.length>=3){let h=[];for(let A=0;A<f.length;A++)h.push({y:s,s:(f.start+A)%c});a.push({color:f.color,length:f.length,cells:h})}}for(let s=0;s<c;s++){let i=0,l=e[0][s],g=l?1:0;for(let p=1;p<=n;p++){let f=p<n?e[p][s]:0;if(f&&f===l)g++;else{if(g>=3&&l){let h=[];for(let A=0;A<g;A++)h.push({y:i+A,s});a.push({color:l,length:g,cells:h})}i=p,l=f,g=f?1:0}}}for(let s=0;s<n;s++)for(let i=0;i<c;i++){let l=e[s][i],g=e[s][(i+1)%c],p=e[s][(i+2)%c],f=e[s][(i+3)%c];l&&l===g&&p&&p===f&&l!==p&&o.push({cells:[{y:s,s:i},{y:s,s:(i+1)%c},{y:s,s:(i+2)%c},{y:s,s:(i+3)%c}]})}for(let s=0;s<c;s++)for(let i=0;i<n-3;i++){let l=e[i][s],g=e[i+1][s],p=e[i+2][s],f=e[i+3][s];l&&l===g&&p&&p===f&&l!==p&&o.push({cells:[{y:i,s},{y:i+1,s},{y:i+2,s},{y:i+3,s}]})}return{lineMatches:a,pairMatches:o}}function mo(e,n,c){let a=[];for(let o=0;o<n;o++){let s=!0;for(let i=0;i<c;i++)if(!e[o][i]){s=!1;break}s&&a.push(o)}return a}function po(e,n){let c=new Map;e.forEach((a,o)=>c.set(`${a.x},${a.y}`,n[o]));for(let a=0;a<e.length;a++){let o=e[a],s=n[a],i=1;for(let st=1;st<=2&&c.get(`${o.x+st},${o.y}`)===s;st++)i++;if(i>=3)return!0;let l=1;for(let st=1;st<=2&&c.get(`${o.x},${o.y+st}`)===s;st++)l++;if(l>=3)return!0;let g=s,p=c.get(`${o.x+1},${o.y}`),f=c.get(`${o.x+2},${o.y}`),h=c.get(`${o.x+3},${o.y}`);if(g&&p&&f&&h&&g===p&&f===h&&g!==f)return!0;let A=s,z=c.get(`${o.x},${o.y+1}`),F=c.get(`${o.x},${o.y+2}`),q=c.get(`${o.x},${o.y+3}`);if(A&&z&&F&&q&&A===z&&F===q&&A!==F)return!0}return!1}function ho(e){let{getN:n,getH:c,FALL_INTERVAL:a,LOCK_DELAY_SEC:o,getKillRate:s,MATCH_HIGHLIGHT_SEC:i,MAGIC_SHRINK_SEC:l,RING_HIGHLIGHT_SEC:g,getState:p,setState:f,funcs:h,ui:A}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(z,F={}){let q=p();if(z==="start_game")return q.gameState!=="playing"?(h.startGame(),!0):!1;if(q.gameState!=="playing")return!1;switch(z){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:st}=F;return typeof st=="number"&&h.canPlaceAtRot(Math.floor(q.pieceY),st)?(f({targetRot:st,rotFloat:st,rotVel:0}),q.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:st,y:ot}=F;return h.shootMagic(st,ot)}case"select_magic":{let{element:st}=F;return h.selectMagic(st),!0}default:return console.warn("GameEngine: unknown command",z),!1}},update(z,F){let q=p();if(q.gameState!=="playing")return;let st=F-q.startTime-q.totalPausedMs;f({elapsedMs:st}),A.updateTimeHud();let ot=q.killLevel+s()*z;if(f({killLevel:ot}),A.updateRemainingHud(),ot>=c()){h.endGame();return}if(q.isHighlighting){let W=(F-q.highlightStartTime)/1e3,Mt;q.isRingAnimation?Mt=g:q.isMagicAnimation?Mt=l:Mt=i,W>=Mt&&(q.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let le=q.fallTimer+z;if(le>=a&&(le-=a,h.tryMoveDown()),f({fallTimer:le}),h.updateGroundedState()){let W=q.lockTimer+z;f({lockTimer:W}),W>=o&&h.lockPiece()}},reset(){h.startGame()},canRotateTo(z,F){return h.canPlaceAtRot(z,F)},getRotation(){let z=p();return{targetRot:z.targetRot,rotFloat:z.rotFloat,rotVel:z.rotVel}},setRotation(z){f({targetRot:z,rotFloat:z,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var Ae=Math.PI*2;function yo(e){let{canvas:n,canvasCtx:c,getN:a,getH:o,TOP_PAD_PX:s,BOTTOM_PAD_PX:i,SIDE_MARGIN_PX:l,MAX_RADIUS_X:g,RADIUS_X_FACTOR:p,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:h,MATCH_SHRINK_PHASE:A,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:F,LOCK_DELAY_SEC:q,getKillRate:st,ELEMENT_COLORS:ot,ELEMENT_TO_COLOR:le,BLOCK_COLOR_FRONT:Q,BLOCK_COLOR_BACK:W,ACTIVE_COLOR_FRONT:Mt,GHOST_COLOR_FILL:be,GHOST_COLOR_STROKE:fe,GHOST_STROKE_WIDTH:jt,MAGIC_DIM_DOT_ALPHA:ae,MAGIC_DIM_DOT_SCALE:Qt,MAGIC_TARGET_DOT_SCALE:me,getState:Nt,getVisualSettings:Xt,funcs:_t}=e,r=c,Z=a(),K=o(),we={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},Zt=[],xt=40;function Gt(w,S,B,k,C){let E=Math.max(3,Math.round(w)),L=180;for(let it=0;it<E;it++)setTimeout(()=>{let at=Math.random()>.5?"left":"right",P=15,y=at==="left"?P+Math.random()*Math.max(10,S-P*2):B+P+Math.random()*Math.max(10,C-B-P*2),v=k-10;Zt.push({x:y,baseX:y,y:v,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:P,maxX:C-P})},it*L)}function re(w,S,B){Zt=Zt.filter(k=>k.y>w+k.size&&k.y>-20);for(let k of Zt){k.y-=xt*B,k.wobble+=k.wobbleSpeed*B;let C=k.baseX+Math.sin(k.wobble)*k.wobbleAmp;k.x=Math.max(k.minX,Math.min(k.maxX,C))}}function pe(w){if(Zt.length!==0){r.fillStyle="rgba(255, 255, 255, 0.3)",r.strokeStyle="rgba(255, 255, 255, 0.5)",r.lineWidth=1;for(let S of Zt)S.y<w+S.size||(r.beginPath(),r.arc(S.x,S.y,S.size,0,Math.PI*2),r.fill(),r.stroke())}}let Wt={left:0,right:0,h:0,w:0};function pt(w,S,B){let k=1-B/K;return w+k*S}function Ce(w){return w=w%Z,w<0?w+Z:w}function Ue(w,S,B,k,C,E){let L=Ce(E),it=(C-L)/Z*Ae+f;return{x:w+Math.cos(it)*B,y:S+Math.sin(it)*k,ang:it}}let Pt=.52,Jt=1.02;function ht(w,S,B,k,C,E){let L=Ce(E),it=(C-L)/Z*Ae+f;return{x:w+Math.cos(it)*B,y:S+Math.sin(it)*k,ang:it}}function wt(w,S,B,k,C,E,L,it=1){let at=ht(w,S,B,k,C-Pt,E),P=ht(w,S,B,k,C+Pt,E),y={x:at.x,y:at.y-L*.5},v={x:at.x,y:at.y+L*.5},X={x:P.x,y:P.y-L*.5},yt={x:P.x,y:P.y+L*.5},b=(y.x+X.x+yt.x+v.x)*.25,St=(y.y+X.y+yt.y+v.y)*.25,R=Jt*it,te=it,rt=[y,X,yt,v].map(ne=>({x:b+(ne.x-b)*R,y:St+(ne.y-St)*te})),Dt=Math.abs((P.x-at.x)*R),ee=Math.abs(L*te);return{corners:rt,cx:b,cy:St,wApprox:Dt,hApprox:ee,ang:ht(w,S,B,k,C,E).ang}}function vt(w,S,B,k,C,E,L,it,at=1,P=null,y=1,v=null,X=0,yt=1,b=1){let St=wt(w,S,B,k,C,E,L,b),[R,te,rt,Dt]=St.corners;if(r.save(),r.globalAlpha=at,r.fillStyle=it,r.beginPath(),r.moveTo(R.x,R.y),r.lineTo(te.x,te.y),r.lineTo(rt.x,rt.y),r.lineTo(Dt.x,Dt.y),r.closePath(),r.fill(),v&&X>0&&(r.strokeStyle=v,r.lineWidth=X,r.stroke()),P){let ee=Math.min(St.wApprox,St.hApprox)*.28*yt;r.globalAlpha=at*y,r.fillStyle=P,r.beginPath(),r.arc(St.cx,St.cy,ee,0,Ae),r.fill()}r.restore(),r.globalAlpha=1}function $e(w,S,B,k,C,E){let L=Ue(w,S,B,k,C,E),it=Ue(w,S,B,k,C+1,E),at=Ue(w,S,B,k,C-1,E),P=Math.abs(it.x-L.x),y=Math.abs(L.x-at.x),v=(P+y)*.5*1.06;return Math.max(1,v)}function It(w,S,B,k,C,E){let L=(C-E)/Z*Ae+f;return{x:w+Math.cos(L)*B,y:S+Math.sin(L)*k,ang:L}}function Pe(w,S,B,k,C,E,L,it=1,at=null,P=1,y=null,v=0,X=1){r.save(),r.translate(w,S);let yt=Math.atan2(k,B);if(r.rotate(yt),r.globalAlpha=it,r.fillStyle=L,r.fillRect(-C/2,-E/2,C,E),y&&v>0&&(r.strokeStyle=y,r.lineWidth=v,r.strokeRect(-C/2,-E/2,C,E)),at){let b=Math.min(C,E)*.28*X;r.globalAlpha=it*P,r.fillStyle=at,r.beginPath(),r.arc(0,0,b,0,Ae),r.fill()}r.restore(),r.globalAlpha=1}return{resize(){let w=Math.max(1,Math.min(2,window.devicePixelRatio||1)),S=Math.floor(n.clientWidth*w),B=Math.floor(n.clientHeight*w);(n.width!==S||n.height!==B)&&(n.width=S,n.height=B,r.setTransform(w,0,0,w,0,0))},render(w=.016,S=performance.now()){this.resize();let B=Nt();Z=a(),K=o();let k=n.clientWidth,C=n.clientHeight;r.clearRect(0,0,k,C),r.fillStyle="#0b0f14",r.fillRect(0,0,k,C);let E=k*.5,L=(k-2*l)/2,it=C-s-i,at=6,P=Z*it/(at*K),y,v,X,yt;yt=C-i,P<=Math.min(L,g)?(y=P,v=it,X=s):(y=Math.min(L,g),v=y*at*K/Z,X=yt-v);let b=y*.28,{killLevel:St,rotFloat:R,grid:te,gameState:rt}=B,Dt=Xt?Xt():{},ee=Dt.waterColor||"blue",ne=Dt.waterBubbles||!1,mn=we[ee]||we.blue,Ut=pt(X,v,St),an=.7,H=St/K,ut={...mn.top},tt={...mn.bottom};if(H>an){let T=(H-an)/(1-an);ut.r=Math.round(ut.r+(255-ut.r)*T*.5),ut.g=Math.round(ut.g+(150-ut.g)*T*.5),ut.b=Math.round(ut.b+(150-ut.b)*T*.5),tt.r=Math.round(tt.r+(180-tt.r)*T),tt.g=Math.round(tt.g*(1-T*.6)),tt.b=Math.round(tt.b*(1-T*.6))}let Rt=E-y-8,he=E+y+8,ve=X,ue=yt+5,Ye=r.createLinearGradient(0,Ut,0,C);Ye.addColorStop(0,`rgba(${ut.r},${ut.g},${ut.b},0.5)`),Ye.addColorStop(1,`rgba(${tt.r},${tt.g},${tt.b},0.7)`),r.fillStyle=Ye;let Ie=Math.round((ut.r+tt.r)/2),m=Math.round((ut.g+tt.g)/2),V=Math.round((ut.b+tt.b)/2),x=y+8,U=b+4;r.fillRect(0,Ut,Rt,C-Ut),r.fillRect(he,Ut,k-he,C-Ut),r.beginPath();let Tt=Math.max(Ut,ue);r.moveTo(Rt,Tt),Ut<=ue+U?r.ellipse(E,ue,x,U,0,Math.PI,0,!1):r.lineTo(he,Tt),r.lineTo(he,C),r.lineTo(Rt,C),r.closePath(),r.fill(),r.strokeStyle="rgba(100,180,255,0.6)",r.lineWidth=3,r.lineCap="round",r.beginPath(),r.moveTo(Rt,ve),r.lineTo(Rt,ue),r.stroke(),r.beginPath(),r.moveTo(he,ve),r.lineTo(he,ue),r.stroke(),r.beginPath(),r.ellipse(E,ue,y+8,b+4,0,0,Math.PI),r.stroke(),r.fillStyle="#0b0f14",r.beginPath(),r.ellipse(E,ue,y+8,b+4,0,0,Ae),r.fill(),St>.5&&(r.strokeStyle=`rgba(${Math.min(255,Ie+60)},${Math.min(255,m+40)},${Math.min(255,V+40)},0.6)`,r.lineWidth=2,r.beginPath(),r.moveTo(0,Ut),r.lineTo(Rt,Ut),r.moveTo(he,Ut),r.lineTo(k,Ut),r.stroke()),Wt={left:Rt,right:he,h:C,w:k},(Zt.length>0||ne)&&(re(Ut,C,w),pe(Ut)),r.strokeStyle="rgba(160,190,220,0.3)",r.lineWidth=1;let Et=Ae*y,ye=10,en=Et/ye*.7,Yt=Et/ye*.3;r.setLineDash([en,Yt]);let Ve=Et/Z;r.lineDashOffset=Ce(R)*Ve;for(let T=0;T<=K;T++){let D=pt(X,v,T);r.beginPath(),r.ellipse(E,D,y,b,0,0,Ae),r.stroke()}r.setLineDash([]);let We=[],Se=[];for(let T=0;T<K;T++){let D=pt(X,v,T+.5);for(let Y=0;Y<Z;Y++){let $=te[T][Y];if(!$)continue;let N=Ue(E,D,y,b,Y,R),G=Math.sin(N.ang),O={y:T,s:Y,yScr:D,p:N,depth:G,color:$};G<-.1?We.push(O):Se.push(O)}}let Kt=_t.getMagicTargetColor(),{isHighlighting:Ot,highlightedCells:se,highlightStartTime:Vt,isMagicAnimation:Ee}=B,Te=null,Oe=1,ke=1,oe=!1;if(Ot&&se.length>0){Te=new Set(se.map(D=>`${D.y},${D.s}`));let T=(performance.now()-Vt)/1e3;if(Ee){let D=Math.min(1,T/z);Oe=1-D*.85,ke=1-D*.9,oe=!0}else{let D=Math.min(1,T/h),Y=1-A;if(D>Y){let $=(D-Y)/A;Oe=1-$*.85,ke=1-$*.9,oe=!0}}}We.sort((T,D)=>T.depth-D.depth);for(let T of We){let D=v/K*.9,Y=ot[T.color]||null,$=.35,N=1,G=`${T.y},${T.s}`;Te&&Te.has(G)&&($*=ke,N=Oe),vt(E,T.yScr,y,b,T.s,R,D,W,$,Y,.5,null,0,1,N)}let{isRingAnimation:de}=B;if(Ot&&se.length>0&&!Ee){let T=(performance.now()-Vt)/1e3,Y=Math.min(1,T/(de?F:h)),$=1-A,N=Y>$,G=N?(Y-$)/A:0,O=de?Math.floor(Y*$*Z*2)%Z:-1,M=4+Y/$*10,I=Math.sin(T*M*Ae),J=N?1:.3+I*.3,et=N?1-G*.8:1,ft=N?1-G:1;for(let ct of se){let Bt=pt(X,v,ct.y+.5),bt=ht(E,Bt,y,b,ct.s,R);if(Math.sin(bt.ang)>=-.1)continue;let Fe=v/K*.9,ge,xe,Ft;if(de){let De=(ct.s-O+Z)%Z,je=De<3?1-De/3:0;ge=(N?ft:.2+je*.5)*.5,xe=`rgba(255, 159, 67, ${ge})`,Ft=N?et:1+je*.15}else ge=J*ft,xe=ct.isLine?`rgba(255, 255, 255, ${ge*.5})`:`rgba(255, 220, 100, ${ge*.4})`,Ft=N?et:1.1;vt(E,Bt,y,b,ct.s,R,Fe,xe,1,null,1,null,0,1,Ft)}}Se.sort((T,D)=>T.depth-D.depth);for(let T of Se){let D=v/K*.9,Y=ot[T.color]||null,$=1,N=1,G=1,O=1,M=`${T.y},${T.s}`,I=Te&&Te.has(M);I&&($=ke,N=Oe),Kt!==null&&!I&&(T.color!==Kt?(G=ae,O=Qt):O=me),vt(E,T.yScr,y,b,T.s,R,D,Q,$,Y,G,null,0,O,N)}if(Ot&&se.length>0&&!Ee){let T=(performance.now()-Vt)/1e3,Y=Math.min(1,T/(de?F:h)),$=1-A,N=Y>$,G=N?(Y-$)/A:0,O=de?Math.floor(Y*$*Z*2)%Z:-1,M=4+Y/$*10,I=Math.sin(T*M*Ae),J=N?1:.5+I*.5,et=N?1-G*.8:1,ft=N?1-G:1;for(let ct of se){let Bt=pt(X,v,ct.y+.5),bt=ht(E,Bt,y,b,ct.s,R);if(Math.sin(bt.ang)<-.1)continue;let Fe=v/K*.9,ge,xe,Ft;if(de){let De=(ct.s-O+Z)%Z,je=De<4?1-De/4:0;ge=N?ft:.3+je*.7,xe=`rgba(255, 159, 67, ${ge})`,Ft=N?et:1+je*.2}else ge=J*ft,xe=ct.isLine?`rgba(255, 255, 255, ${ge*.7})`:`rgba(255, 220, 100, ${ge*.6})`,Ft=N?et:1.15;vt(E,Bt,y,b,ct.s,R,Fe,xe,1,null,1,null,0,1,Ft)}}let zt=B.spellState||B,{transmuteState:_e,transmuteSourceBlock:rn,transmuteTargetColor:Be,transmuteAreaCells:nn,transmuteBlocksToChange:Ht}=zt;if(_e==="selecting_source"){let T=v/K*.9,D=.35+Math.sin(S/150)*.15;for(let Y of Se){let $=pt(X,v,Y.y+.5);vt(E,$,y,b,Y.s,R,T,`rgba(0, 40, 20, ${D})`,1,null,1,null,0,1,1)}}if(_e==="selecting_target"&&Ht&&Ht.length>0){let T=v/K*.9,D=.4+Math.sin(S/120)*.25,Y=.6+Math.sin(S/120)*.4;for(let $ of Ht){if($.y<0||$.y>=K)continue;let N=pt(X,v,$.y+.5),G=ht(E,N,y,b,$.s,R);Math.sin(G.ang)<-.1||(vt(E,N,y,b,$.s,R,T,`rgba(0, 50, 30, ${D})`,1,null,1,null,0,1,1),vt(E,N,y,b,$.s,R,T,"transparent",1,null,1,`rgba(100, 255, 150, ${Y})`,3,1,1.02))}}if(_e==="animating"&&_t.getTransmuteAnimState){let T=_t.getTransmuteAnimState(S);if(T){let D=v/K*.9,{phase:Y,progress:$,areaFlash:N}=T;if(N>0&&nn)for(let G of nn){if(G.y<0||G.y>=K)continue;let O=pt(X,v,G.y+.5),M=ht(E,O,y,b,G.s,R);Math.sin(M.ang)<-.1||vt(E,O,y,b,G.s,R,D,`rgba(150, 255, 200, ${N*.4})`,1,null,1,null,0,1,1)}if(Ht&&Ht.length>0){let G=rn?rn.color:1,O=Be||1;for(let M of Ht){if(M.y<0||M.y>=K)continue;let I=pt(X,v,M.y+.5),J=ht(E,I,y,b,M.s,R);if(Math.sin(J.ang)<-.1)continue;let ft=1,ct=ot[G],Bt=0;if(Y==="shrink"?(ft=1-$*.95,ct=ot[G],Bt=.5+$*.3):Y==="grow"&&(ft=$,ct=ot[O],Bt=.8-$*.5),Bt>0&&vt(E,I,y,b,M.s,R,D,`rgba(200, 255, 220, ${Bt})`,1,null,1,null,0,1,1),ft>.05){let bt=wt(E,I,y,b,M.s,R,D,1),mt=Math.min(bt.wApprox,bt.hApprox)*.28*ft;r.save(),r.globalAlpha=1,r.fillStyle=ct,r.beginPath(),r.arc(bt.cx,bt.cy,mt,0,Ae),r.fill(),r.restore()}}}}}let{lightningState:Me,lightningSourceBlock:un,lightningAreaCells:An,lightningBlocksToHit:Ke}=zt;if(Me==="selecting_source"){let T=v/K*.9,D=.35+Math.sin(S/150)*.15;for(let Y of Se){let $=pt(X,v,Y.y+.5);vt(E,$,y,b,Y.s,R,T,`rgba(20, 20, 60, ${D})`,1,null,1,null,0,1,1)}}if(Me==="animating"&&_t.getLightningAnimState){let T=_t.getLightningAnimState(S);if(T&&Ke&&Ke.length>0){let D=v/K*.9,{phase:Y,flashProgress:$,currentTarget:N,jumpProgress:G,struckTargets:O}=T;if(Y==="flash"&&$>0&&An)for(let M of An){if(M.y<0||M.y>=K)continue;let I=pt(X,v,M.y+.5),J=ht(E,I,y,b,M.s,R);Math.sin(J.ang)<-.1||vt(E,I,y,b,M.s,R,D,`rgba(100, 150, 255, ${$*.5})`,1,null,1,null,0,1,1)}if(O&&O.length>0)for(let M of O){let I=Ke[M];if(!I||I.y<0||I.y>=K)continue;let J=pt(X,v,I.y+.5),et=ht(E,J,y,b,I.s,R);if(Math.sin(et.ang)<-.1)continue;let ct=(O.length-1-O.indexOf(M))*.1,Bt=Math.max(0,.8-ct);vt(E,J,y,b,I.s,R,D,`rgba(255, 255, 255, ${Bt})`,1,null,1,`rgba(150, 200, 255, ${Bt})`,2,1,1.05)}if(Y==="chain"&&N>=0&&N<Ke.length){let M=Ke[N];if(M&&M.y>=0&&M.y<K){let I=pt(X,v,M.y+.5),J=ht(E,I,y,b,M.s,R);if(Math.sin(J.ang)>=-.1){let ft=1-G;vt(E,I,y,b,M.s,R,D,`rgba(200, 220, 255, ${ft*.9})`,1,null,1,`rgba(100, 180, 255, ${ft})`,3,1,1.1-G*.05)}}if(N>0){let I=Ke[N-1],J=Ke[N];if(I&&J){let et=pt(X,v,I.y+.5),ft=pt(X,v,J.y+.5),ct=wt(E,et,y,b,I.s,R,D,1),Bt=wt(E,ft,y,b,J.s,R,D,1);r.save(),r.strokeStyle=`rgba(150, 200, 255, ${1-G*.5})`,r.lineWidth=2+(1-G)*2,r.lineCap="round",r.beginPath();let bt=ct.cx,mt=ct.cy,Fe=Bt.cx,ge=Bt.cy;r.moveTo(bt,mt);let xe=4;for(let Ft=1;Ft<=xe;Ft++){let De=Ft/xe,je=bt+(Fe-bt)*De,kn=mt+(ge-mt)*De,sn=Ft<xe?(Math.random()-.5)*8:0;r.lineTo(je+sn,kn+sn)}r.stroke(),r.strokeStyle=`rgba(100, 150, 255, ${(1-G)*.3})`,r.lineWidth=6,r.stroke(),r.restore()}}}}}let{fireState:wn,fireSourceBlock:ze,fireLineCells:pn,fireTargets:Ge}=zt;if(wn==="selecting_source"){let T=v/K*.9,D=.3+Math.sin(S/140)*.2;for(let Y of Se){let $=pt(X,v,Y.y+.5);vt(E,$,y,b,Y.s,R,T,`rgba(70, 25, 10, ${D})`,1,null,1,null,0,1,1)}}if(wn==="animating"&&_t.getFireAnimState){let T=_t.getFireAnimState(S);if(T&&pn&&pn.length>0){let D=v/K*.9,{progress:Y,flashProgress:$}=T,N=Math.sin(Y*Math.PI);if($>0)for(let G of pn){if(G.y<0||G.y>=K)continue;let O=pt(X,v,G.y+.5),M=ht(E,O,y,b,G.s,R);Math.sin(M.ang)<-.1||vt(E,O,y,b,G.s,R,D,`rgba(255, 120, 50, ${$*.45})`,1,null,1,`rgba(255, 200, 140, ${$*.5})`,2,1,1.03)}if(ze){let G=new Map;for(let M of pn){if(M.y<0||M.y>=K)continue;let I=pt(X,v,M.y+.5),J=ht(E,I,y,b,M.s,R);if(Math.sin(J.ang)<-.1)continue;let ft=wt(E,I,y,b,M.s,R,D,1),ct=M.s-ze.s;ct>Z/2&&(ct-=Z),ct<-Z/2&&(ct+=Z);let Bt=M.y;G.has(Bt)||G.set(Bt,[]),G.get(Bt).push({x:ft.cx,y:ft.cy,offset:ct})}let O=Array.from(G.keys()).sort((M,I)=>I-M);if(O.length>0){let M=.35+.3*Math.sin(S/60)+N*.2;r.save(),r.lineCap="round";for(let I of O){let J=G.get(I)||[];if(J.sort((et,ft)=>et.offset-ft.offset),J.length!==0){r.beginPath(),r.moveTo(J[0].x,J[0].y);for(let et=1;et<J.length;et++)r.lineTo(J[et].x,J[et].y);r.strokeStyle=`rgba(255, 140, 60, ${M})`,r.lineWidth=Math.max(2,D*.15),r.stroke(),r.strokeStyle=`rgba(255, 210, 140, ${M*.35})`,r.lineWidth=Math.max(6,D*.35),r.stroke()}}r.restore()}}if(Ge&&Ge.length>0){let G=.2+N*.6;for(let O of Ge){if(O.y<0||O.y>=K)continue;let M=pt(X,v,O.y+.5),I=ht(E,M,y,b,O.s,R);Math.sin(I.ang)<-.1||vt(E,M,y,b,O.s,R,D,`rgba(255, 160, 70, ${G})`,1,null,1,`rgba(255, 230, 180, ${N*.6})`,2,1,1.05)}}}}let{activePiece:qe,pieceY:Pn,isGrounded:In,lockTimer:On}=B;if(qe){let T=_t.snappedRot(),D=T,Y=_t.computeGhostY(),$=v/K*.9;if(Y!==null){let O=[];for(let M=0;M<qe.cells.length;M++){let I=qe.cells[M],J=qe.colors[M],et=Y+I.y,ft=_t.normSector(T+I.x);if(et<0||et>=K)continue;let ct=pt(X,v,et+.5),Bt=ht(E,ct,y,b,ft,D);O.push({cy:et,cs:ft,yScr:ct,depth:Math.sin(Bt.ang),color:J})}O.sort((M,I)=>M.depth-I.depth);for(let M of O){let I=ot[M.color]||null;vt(E,M.yScr,y,b,M.cs,D,$,be,1,I,.5,fe,jt,1,1)}}let N=Mt;if(In&&On>0){let O=Math.min(1,On/q),M=255,I=Math.round(170+85*O),J=Math.round(180+75*O),et=.75+(1-.75)*O;N=`rgba(${M},${I},${J},${et})`}let G=[];for(let O=0;O<qe.cells.length;O++){let M=qe.cells[O],I=qe.colors[O],J=_t.normSector(T+M.x),et=Pn+M.y;if(et<0||et>=K)continue;let ft=pt(X,v,et+.5),ct=ht(E,ft,y,b,J,D);G.push({cs:J,yScr:ft,depth:Math.sin(ct.ang),color:I})}G.sort((O,M)=>O.depth-M.depth);for(let O of G){let M=ot[O.color]||null;vt(E,O.yScr,y,b,O.cs,D,$,N,1,M,1,null,0,1,1)}}},drawNextPreview(w,S){if(!w)return;let B=w.getContext("2d"),k=w.width,C=w.height;if(B.clearRect(0,0,k,C),!S)return;let E=1/0,L=-1/0,it=1/0,at=-1/0;for(let b of S.cells)E=Math.min(E,b.x),L=Math.max(L,b.x),it=Math.min(it,b.y),at=Math.max(at,b.y);let P=L-E+1,y=at-it+1,v=Math.min(k/(P+.5),C/(y+.5)),X=(k-P*v)/2,yt=(C-y*v)/2;B.fillStyle=Q;for(let b=0;b<S.cells.length;b++){let St=S.cells[b],R=X+(St.x-E)*v,te=yt+(y-1-(St.y-it))*v;B.fillRect(R+1,te+1,v-2,v-2);let rt=S.colors[b],Dt=ot[rt];if(Dt){let ee=(v-2)*.32;B.fillStyle=Dt,B.beginPath(),B.arc(R+v/2,te+v/2,ee,0,Ae),B.fill(),B.fillStyle=Q}}},spawnBonusBubbles(w){let{left:S,right:B,h:k,w:C}=Wt;C>0&&Gt(w,S,B,k,C)}}}(()=>{let e=js(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let a=Math.PI*2,o=30,s=24,i=120,l={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function g(t){let u=l[t]||l["30_24"];o=u.N,s=u.H,i=u.survivalTime}function p(){return s/i}let f=Math.PI/2,h=70,A=120,z=30,F=320,q=.42,st="rgb(235,240,250)",ot="rgb(55,62,75)",le="rgba(255,170,180,0.75)",Q="rgba(110,255,150,0.15)",W="rgba(110,255,150,0.85)",Mt=2,be={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},fe={1:"fire",2:"water",3:"lightning",4:"earth"},jt={fire:1,water:2,lightning:3,earth:4},ae=1,Qt=.58,me=!0,Nt=12,Xt=25,_t=1,r=2,Z=3,K=5,we=8,Zt=10,xt=15,Gt=30,re=2,pe=.3,Wt=.5,pt=1,Ce=.3,Ue=.5,Pt=1.3,Jt=10,ht=500,wt=[1,1.25,1.5,1.75,2],vt=10,$e=100,It=25,Pe=[1,1.3,1.6,2],w=[1,1.5,2,2.5],S=qs(),B=S.loadGameSettings(),k=B.invertSwipe?-1:1,C=B.magicEnabled??!1,E=-1,L=Array.from({length:s},()=>new Uint8Array(o));function it(){L=Array.from({length:s},()=>new Uint8Array(o))}let at=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],P=null,y=s+3,v=0,X=0,yt=!1,b=0,St=0,R=0,te=3,rt=0,Dt=0,ee=0,ne=io({canvas:n,rotDir:k}),mn="0.15.0",Ut=!0,an="blue",H=Ys();H.preload();let ut=co(),tt="intro",Rt=0,he=0,ve=0,ue=0,Ye=0,Ie=null,m=ut.stats,V=e.overlay,x=Zs({elementColors:be}),U=x.showBonus.bind(x),Tt=x.getElementIcon.bind(x),Et=to(),ye=e.overlayTitle,en=e.overlayStats,Yt=e.startBtn,Ve=e.hud,We=e.scoreHud,Se=e.timeHud,Kt=e.remainingHud,Ot=e.nextCanvas,se=Ot.getContext("2d"),Vt=e.pauseBtn,Ee=e.pauseOverlay,Te=e.resumeBtn,Oe=e.restartBtn,ke=e.exitToMenuBtn,oe=e.pauseSettingsBtn,de=e.pauseSoundBtn,zt=e.pauseMusicBtn,_e=e.pauseBestScore,rn=e.pauseBestTime,Be=e.pauseBestMode,nn=e.pauseCurrentScore,Ht=e.pauseCurrentTime,Me=e.pauseCurrentMode,un=e.confirmDialog,An=e.confirmText,Ke=e.confirmCancel,wn=e.confirmOk,ze=e.settingsOverlay,pn=e.settingsClose,Ge=e.fullscreenBtn,qe=e.rotateBtn,Pn=e.startPanel,In=e.gameoverPanel,On=e.goScore,T=e.goTime,D=e.goRing,Y=e.goMatches,$=e.goBonuses,N=e.goNewRecord,G=e.goRestartBtn,O=e.goExitBtn,M=e.bestScore,I=e.bestTimeVal,J=e.startVersion,et=e.modeBtns,ft=e.recordsBtn,ct=e.startSettingsBtn,Bt=e.helpBtn,bt="25_20",mt=eo({buttons:e.magicBtns,onActivate:()=>H.play("spells")}),Fe=e.magicBtns,ge=mt.charges,xe=t=>C?mt.select(t):!1,Ft=()=>mt.updateButtons(),De=e.magicRow;function je(t){C=t,B.magicEnabled=t,S.saveGameSettings(B),C?mt.reset():(mt.deactivate(),Object.keys(mt.charges).forEach(u=>{mt.charges[u]=0})),Ft(),kn(),xn()}function kn(){De&&(De.style.display=C?"":"none")}let sn=e.spellWave;function So(){sn&&(sn.classList.remove("active"),sn.offsetWidth,sn.classList.add("active"),setTimeout(()=>sn.classList.remove("active"),1200))}let Qe=null,Ne=no({button:e.spellBtn,onReady:()=>{H.play("readysuper")}});Qe=oo({canvas:n,dom:e,getGrid:()=>L,getN:()=>o,getH:()=>s,getRotFloat:()=>rt,constants:{TOP_PAD_PX:h,BOTTOM_PAD_PX:A,SIDE_MARGIN_PX:z,MAX_RADIUS_X:F,SCORE_MAGIC_DESTROY:It},helpers:{normSector:Gn,levelYToScreenY:Dn,sectorCenterXY:Hn},Spell:Ne,Magic:mt,SoundModule:H,State:ut,isGamePlaying:()=>tt==="playing",addPendingKzDrop:t=>{R+=t},getKillRate:p,triggerSpellWave:So,spawnSpellBubbles:t=>{Et.spawnSpellBubbles(Ne.button,t)},spawnBonusBubbles:t=>{Sn.spawnBonusBubbles(t)},getTransmuteEffect:()=>Ne.getEffect("earth"),getLightningEffect:()=>Ne.getEffect("air"),getFireEffect:()=>Ne.getEffect("fire"),continueMatchProcessing:$n,updateScoreHud:Tn,showBonus:U,setScore:t=>{Rt=t},setCascadeLevel:t=>{tn=t}}),Ne.initButton(()=>{Qe.handleSpellButtonClick()});function hs(){return C&&bt==="30_24"}function xn(){let t=e.spellBtn;t&&(t.style.display=hs()?"":"none")}let Ze=[],bn=0,Je=!1,dn=!1,Cn=!1,Le=0,Xe=0,tn=0,hn=[];function Dn(t,u,d){let _=1-d/s;return t+_*u}function Hn(t,u,d,_,lt,dt){let gt=(lt-dt)/o*a+f;return{x:t+Math.cos(gt)*d,y:u+Math.sin(gt)*_,ang:gt}}function Qn(t,u){let d=n.clientWidth,_=n.clientHeight,lt=d*.5,dt=(d-2*z)/2,gt=_-h-A,ie=6,Re=o*gt/(ie*s),En=_-A,He,Ct,j;Re<=Math.min(dt,F)?(He=Re,Ct=gt,j=h):(He=Math.min(dt,F),Ct=He*ie*s/o,j=En-Ct);let nt=He*.28,At=Dn(j,Ct,t+.5),kt=Hn(lt,At,He,nt,u,rt),qt=n.getBoundingClientRect();return{x:qt.left+kt.x,y:qt.top+kt.y}}function Eo(t,u){if(!C||!mt.canUse()||Je)return!1;let d=jt[mt.active],_=n.clientWidth,lt=n.clientHeight,dt=_*.5,gt=(_-2*z)/2,ie=lt-h-A,Re=6,En=o*ie/(Re*s),He=lt-A,Ct,j,nt;En<=Math.min(gt,F)?(Ct=En,j=ie,nt=h):(Ct=Math.min(gt,F),j=Ct*Re*s/o,nt=He-j);let At=Ct*.28,kt=null,qt=1/0;for(let ce=0;ce<s;ce++){let ln=Dn(nt,j,ce+.5);for(let $t=0;$t<o;$t++){let fn=L[ce][$t];if(!fn||fn!==d)continue;let Ln=Hn(dt,ln,Ct,At,$t,rt);if(Math.sin(Ln.ang)<-.1)continue;let qn=t-Ln.x,Gs=u-Ln.y,Fs=Math.hypot(qn,Gs),Ns=j/s*.9,zo=Ns*1.2;Math.abs(qn)<zo/2&&Math.abs(Gs)<Ns/2&&Fs<qt&&(qt=Fs,kt={y:ce,s:$t})}}if(kt){let ce=Dn(nt,j,kt.y+.5),ln=Hn(dt,ce,Ct,At,kt.s,rt),$t=n.getBoundingClientRect(),fn=$t.left+ln.x,Ln=$t.top+ln.y,$s=Fe[mt.active];return Et.spawnMagicShot(mt.active,$s,fn,Ln,()=>{let qn=L[kt.y][kt.s];Ze=[{y:kt.y,s:kt.s,color:qn,isLine:!1,isMagic:!0}],bn=performance.now(),Je=!0,dn=!0,Le=0,Xe=It,U(`+${It}`,"score")}),tn=0,mt.useCharge(),m.magicUsed++,!0}return!1}let li=100;function ai(t,u){return ms(t,u,s,o)}function Mo(){return ro(L,s,o)}let xo=uo;function bo(t){let u=t.map(_=>({..._,color:L[_.y][_.s]}));for(let _ of t)L[_.y][_.s]=0;let d=s;for(let _ of t){let lt=_.y;for(let dt=1;dt<=_.y;dt++){let gt=_.y-dt;if(L[gt][_.s]){lt=dt-1;break}}d=Math.min(d,lt)}for(let _ of u)L[_.y-d][_.s]=_.color;return d>0}function Co(){let t=!0;for(;t;){t=!1;let u=Mo();for(let d of u)xo(d)||bo(d)&&(t=!0)}}function vo(){$n()}let Zn=lo;function ys(t,u){let d=new Map,_=0,lt=0,dt=0,gt={},ie=t.length+u.length;for(let j of t){let nt=fe[j.color],At=0,kt=0;if(j.length>=5?(At=Z,kt=Zt,m.lines5++):j.length===4?(At=r,kt=we,m.lines4++):j.length===3&&(At=_t,kt=K,m.lines3++),C&&nt&&At>0){mt.addCharges(nt,At),gt[nt]=(gt[nt]||0)+At;let qt=j.cells[Math.floor(j.cells.length/2)],ce=Qn(qt.y,qt.s),ln=Fe[nt];for(let $t=0;$t<At;$t++)setTimeout(()=>{Et.spawnMagicOrb(nt,ce.x,ce.y,ln)},$t*100)}_+=kt*p(),dt+=kt,lt+=j.length*vt;for(let qt of j.cells){let ce=`${qt.y},${qt.s}`;d.has(ce)||d.set(ce,{y:qt.y,s:qt.s,color:j.color,isLine:!0})}}for(let j of u){if(m.pairs++,_+=xt*p(),dt+=xt,lt+=$e,C){let nt=[];j.cells.length>=4&&(nt.push(L[j.cells[0].y][j.cells[0].s]),nt.push(L[j.cells[2].y][j.cells[2].s]));let At=[...new Set(nt.filter(Boolean))];if(At.length>0){let kt=j.cells[Math.floor(j.cells.length/2)],qt=Qn(kt.y,kt.s);At.forEach((ce,ln)=>{let $t=fe[ce];if(!$t)return;mt.addCharges($t,1),gt[$t]=(gt[$t]||0)+1;let fn=Fe[$t];fn&&setTimeout(()=>{Et.spawnMagicOrb($t,qt.x,qt.y,fn)},ln*100)})}}if(hs()&&Ne.addProgress(1)){let nt=j.cells[Math.floor(j.cells.length/2)],At=Qn(nt.y,nt.s);Et.spawnSpellOrb(At.x,At.y,Ne.button)}for(let nt of j.cells){let At=`${nt.y},${nt.s}`;d.has(At)||d.set(At,{y:nt.y,s:nt.s,color:L[nt.y][nt.s],isLine:!1})}}let Re=Zn(Pe,ie-1),En=Zn(w,tn),He=Math.round(lt*Re*En),Ct=0;ie>1&&(m.combos++,m.maxCombo=Math.max(m.maxCombo,ie),setTimeout(()=>U(`COMBO \xD7${ie}`,"combo"),Ct),Ct+=180,H.play("combo2")),tn>0&&(m.cascades++,m.maxCascade=Math.max(m.maxCascade,tn),setTimeout(()=>U(`CASCADE \xD7${tn}`,"cascade"),Ct),Ct+=180,H.play("cascade")),(t.length>0||u.length>0)&&H.play("combo");for(let j of t){let nt=j.length,At=nt*vt;setTimeout(()=>U(`Line-${nt} +${At}`,"line",j.color),Ct),Ct+=100}for(let j of u){let nt=j.cells.length>0?L[j.cells[0].y][j.cells[0].s]:null;setTimeout(()=>U(`Pair +${$e}`,"pair",nt),Ct),Ct+=100}He>0&&(setTimeout(()=>U(`+${He}`,"score"),Ct),Ct+=120),dt>0&&(setTimeout(()=>U(`+${dt}s`,"time"),Ct),Ct+=120);for(let[j,nt]of Object.entries(gt))nt>0&&(setTimeout(()=>U(`+${nt}${Tt(j)}`,"charge"),Ct),Ct+=120);Ze=Array.from(d.values()),bn=performance.now(),Je=!0,dn=!1,Le=_,Xe=He,Ft()}function To(){for(let t of Ze)L[t.y][t.s]=0;if(Ze.length>0&&H.playRandom("disappear"),Le>0){R+=Le;let t=Le/p();Sn.spawnBonusBubbles(t)}ut.addScore(Xe),Rt+=Xe,Tn(),Ze=[],Je=!1,dn=!1,Le=0,Xe=0,tn++,$n()}function $n(){Co();let{lineMatches:t,pairMatches:u}=ko();if(t.length>0||u.length>0)ys(t,u);else{let d=Cs();d.length>0?Po(d):!P&&tt==="playing"&&bs()}}function ri(t,u){ys(t,u)}function Gn(t){return Mn(t,o)}function Fn(){return Gn(Math.round(rt))}function Ss(t,u){return ps(P,t,u,L,s,o)}function Nn(t){return Ss(t,Fn())}let Xn=ao;function Es(){me&&(Nt!==0&&b>=Nt||(X=0,b+=1))}function _o(){if(!P)return;let t=P.cells,u=P.colors,d={cells:t,colors:u};if(E>=0||(d=Xn(d.cells,d.colors),d=Xn(d.cells,d.colors)),d=Xn(d.cells,d.colors),P.cells=d.cells,P.colors=d.colors,!Nn(Math.floor(y))){P.cells=t,P.colors=u;return}H.play("turn"),yt&&Es()}function Bo(){return go(P,y,Fn(),L,s,o)}function Lo(){if(!P)return!1;let t=Math.floor(y)-1,u=!Nn(t);return u&&!yt?(yt=!0,X=0,b=0):!u&&yt&&(yt=!1,X=0,b=0),u}let gn=jn;function vn(){if(tt==="playing"){V.classList.add("hidden"),Vt.classList.remove("hidden");return}if(V.classList.remove("hidden"),Vt.classList.add("hidden"),tt==="intro"){Pn.classList.remove("hidden"),In.classList.add("hidden");let t=S.loadHighscore(bt);t.score>0?(M.textContent=t.score.toLocaleString(),I.textContent=gn(t.time)):(M.textContent="0",I.textContent="0:00"),Ds(),J.textContent=`v${mn}`,Yt.classList.remove("idlePulse"),Yt.offsetWidth,Yt.classList.add("idlePulse")}else{Pn.classList.add("hidden"),In.classList.remove("hidden"),On.textContent=Rt.toLocaleString(),T.textContent=gn(ve);let t=S.loadHighscore(bt);Rt>0&&Rt>=t.score?N.classList.remove("hidden"):N.classList.add("hidden");let u=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${m.rings}</span>
          <span class="count ring-max">${m.maxRing>0?"max \xD7"+m.maxRing:""}</span>
        </div>
      `;D.innerHTML=u;let d=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${m.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${m.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${m.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${m.pairs}</span>
        </div>
      `;Y.innerHTML=d;let _=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${m.combos}</span>
          <span class="count max-combo">${m.maxCombo>0?"max \xD7"+m.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${m.cascades}</span>
          <span class="count max-cascade">${m.maxCascade>0?"max \xD7"+m.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${m.magicUsed}</span>
        </div>
      `;$.innerHTML=_}}function Tn(){We.textContent=`Score: ${Rt}`}function Jn(){Se.textContent=`Time: ${gn(ve)}`}function Ms(){let t=Math.max(0,(s-St)/p()),u=Math.floor(t/60),d=Math.floor(t%60);Kt.textContent=`Left: ${u}:${d.toString().padStart(2,"0")}`,t<30?Kt.classList.add("warning"):Kt.classList.remove("warning")}function Ro(){g(bt),it(),St=0,R=0,rt=Dt=0,ee=0,ut.start(),m=ut.stats,Rt=0,he=performance.now(),ve=0,Ye=0,ue=0,tt="playing",Ie=null,C?mt.reset():(mt.deactivate(),Object.keys(mt.charges).forEach(t=>{mt.charges[t]=0}),Ft()),Ne.reset(),xn(),Ze=[],hn=[],Je=!1,dn=!1,Cn=!1,Le=0,Xe=0,tn=0,Qe.reset(),Ft(),Tn(),Jn(),Ms(),bs(),Sn.drawNextPreview(Ot,Ie),vn(),H.getSettings().musicEnabled&&H.startGameMusic()}function ts(){ut.gameOver(),tt="gameover",P=null,yt=!1,X=0,b=0;let t=S.saveHighscore(Rt,ve,bt);H.stopMusic(),H.play("gameover"),Jn(),vn(),t&&Rt>0&&setTimeout(()=>{U("\u{1F3C6} NEW RECORD!","score")},500)}function Ao(t){for(let d=0;d<50;d++){let _=t.map(()=>1+(Math.random()*4|0));if(!wo(t,_))return _}return t.map((d,_)=>1+_%4)}let wo=po;function xs(t){let u=t.cells.map(_=>({x:_.x,y:_.y})),d=Ao(u);return{name:t.name,cells:u,colors:d}}function bs(){if(!Ie){let lt=at[Math.random()*at.length|0];Ie=xs(lt)}P=Ie;let t=at[Math.random()*at.length|0];Ie=xs(t),Sn.drawNextPreview(Ot,Ie);let u=1/0,d=-1/0;for(let lt of P.cells)lt.x<u&&(u=lt.x),lt.x>d&&(d=lt.x);let _=(u+d)/2;for(let lt of P.cells)lt.x=lt.x-Math.round(_);y=s+3,v=0,yt=!1,X=0,b=0,Nn(Math.floor(y))?H.playRandom("appear"):ts()}function Cs(){return mo(L,s,o)}function Po(t){if(t.length===0)return;let u=[];for(let ie of t)for(let Re=0;Re<o;Re++)u.push({y:ie,s:Re,color:L[ie][Re],isLine:!1});hn=t,Ze=u,bn=performance.now(),Je=!0,Cn=!0,dn=!1;let d=t.length;m.rings+=d,m.maxRing=Math.max(m.maxRing,d);let _=Zn(wt,d-1),lt=Math.round(ht*d*_),dt=Gt*d;Xe=lt,Le=dt*p(),H.play("ring");let gt=`RING \xD7${d}`;U(gt,"ring"),setTimeout(()=>U(`+${lt}`,"score"),150),setTimeout(()=>U(`+${dt}s`,"time"),300)}function Io(){let t=[...hn].sort((u,d)=>d-u);for(let u of t){for(let d=u;d<s-1;d++)L[d].set(L[d+1]);L[s-1].fill(0)}if(Le>0){R+=Le;let u=Le/p();Sn.spawnBonusBubbles(u)}ut.addScore(Xe),Rt+=Xe,Tn(),bt==="30_24"&&hn.length>0&&(cn=S.addHighTowerRings(hn.length)),Ze=[],hn=[],Je=!1,Cn=!1,Le=0,Xe=0,$n()}function ui(){return Cs().length}function Oo(){if(!P)return;let t=Fn();rt=t,Dt=t,ee=0;let u=!1;for(let d=0;d<P.cells.length;d++){let _=P.cells[d],lt=P.colors[d],dt=Math.floor(y)+_.y,gt=Gn(t+_.x);dt>=s&&(u=!0),dt>=0&&dt<s&&(L[dt][gt]=lt)}if(u){ts();return}ut.addScore(Jt),Rt+=Jt,Tn(),U(`+${Jt}`,"score"),H.playRandom("drop"),P=null,tn=0,vo()}function ko(){return fo(L,s,o)}function Do(){if(!P)return!1;let t=Math.floor(y)-1;return Nn(t)?(y=t,yt=!1,X=0,b=0,!0):(yt=!0,!1)}n.addEventListener("pointerdown",t=>{if(Lt.state!=="playing")return;t.preventDefault?.();let u=n.getBoundingClientRect(),d=t.clientX-u.left,_=t.clientY-u.top;ne.handlePointerDown(t,{onMagicTap:C?()=>Qe.handleTap(d,_)?!0:Lt.applyCommand("magic_shoot",{x:d,y:_}):null,onDoubleTap:()=>Lt.applyCommand("rotate_piece")},Dt)||(ee=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Lt.state!=="playing"||!ne.dragging)return;t.preventDefault?.();let u=ne.handlePointerMove(t,{canRotateTo:(d,_)=>Lt.canRotateTo(d,_),onDrop:()=>Lt.applyCommand("move_down"),onGroundedMove:()=>Lt.onGroundedMove()},Lt.pieceY,Lt.isGrounded);u&&Lt.setRotation(u.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Lt.state==="playing"&&ne.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{ne.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ne.dragging&&ne.handlePointerUp(t)},{passive:!1}),qe.addEventListener("click",()=>{Lt.state==="playing"&&Lt.applyCommand("rotate_piece")});let Un=e.dropBtn,Yn=null;function Ho(){Lt.state==="playing"&&(Lt.applyCommand("move_down"),Yn=setInterval(()=>{if(Lt.state!=="playing"){Vn();return}Lt.applyCommand("move_down")},Xt))}function Vn(){Yn&&(clearInterval(Yn),Yn=null)}Un.addEventListener("pointerdown",t=>{t.preventDefault(),Ho()}),Un.addEventListener("pointerup",Vn),Un.addEventListener("pointerleave",Vn),Un.addEventListener("pointercancel",Vn);for(let[t,u]of Object.entries(Fe))u.addEventListener("click",()=>{Lt.state==="playing"&&C&&Lt.applyCommand("select_magic",{element:t})});let es=e.soundsToggle,ns=e.musicToggle;function on(){let t=H.getSettings();t.soundsEnabled?es.classList.add("active"):es.classList.remove("active"),t.musicEnabled?ns.classList.add("active"):ns.classList.remove("active");for(let u=0;u<=4;u++){let d=e.soundVolBtns[u],_=e.musicVolBtns[u];d&&d.classList.toggle("active",t.soundVolume===u),_&&_.classList.toggle("active",t.musicVolume===u)}}let vs=e.tabBtns,$o=e.tabContents;vs.forEach(t=>{t.addEventListener("click",()=>{let u=t.dataset.tab;vs.forEach(d=>d.classList.remove("active")),$o.forEach(d=>d.classList.remove("active")),t.classList.add("active"),Qs(u).classList.add("active"),u==="sounds"&&on()})});let Ts=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,_s=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Go=e.iosHint,Fo=e.standaloneBadge;function Bs(){let t=document.fullscreenElement||document.webkitFullscreenElement;Ge.textContent=t?"Disable":"Enable"}Ts&&(_s?(Fo.style.display="block",Ge.style.display="none"):(Go.style.display="block",Ge.textContent="Not supported",Ge.style.opacity="0.5",Ge.style.cursor="default")),Ge.addEventListener("click",()=>{if(Ts&&!_s)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let u=document.documentElement;u.requestFullscreen?u.requestFullscreen():u.webkitRequestFullscreen&&u.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Bs),document.addEventListener("webkitfullscreenchange",Bs);let Wn=e.invertSwipeToggle,yn=e.magicToggle;B.invertSwipe&&Wn.classList.add("active"),yn&&yn.classList.toggle("active",C),Wn.addEventListener("click",()=>{Wn.classList.toggle("active");let t=Wn.classList.contains("active");ne.rotDir=t?-1:1,B.invertSwipe=t,S.saveGameSettings(B)}),yn&&yn.addEventListener("click",()=>{yn.classList.toggle("active");let t=yn.classList.contains("active");je(t)});let Ls=e.diffBtns;Ls.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Ls.forEach(u=>{u.classList.remove("active");let d=u.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let u=document.createElement("span");u.className="check-icon",u.textContent="\u2713",t.appendChild(u)}})}),es.addEventListener("click",()=>{let u=!H.getSettings().soundsEnabled;H.updateSettings({soundsEnabled:u}),on(),_n()}),ns.addEventListener("click",()=>{let u=!H.getSettings().musicEnabled;H.updateSettings({musicEnabled:u}),on(),_n(),tt!=="paused"&&(u?tt==="playing"?H.startGameMusic():H.startMenuMusic():H.stopMusic())});for(let t=0;t<=4;t++){let u=e.soundVolBtns[t];u&&u.addEventListener("click",()=>{H.updateSettings({soundVolume:t}),on(),H.play("turn")})}for(let t=0;t<=4;t++){let u=e.musicVolBtns[t];u&&u.addEventListener("click",()=>{H.updateSettings({musicVolume:t}),on()})}on();function Rs(){tt==="playing"&&(ut.pause(),ue=performance.now(),tt="paused",H.musicAudio&&H.musicAudio.pause())}function Kn(){tt==="paused"&&(ut.resume(),Ye+=performance.now()-ue,ue=0,tt="playing",is=performance.now(),H.getSettings().musicEnabled&&H.startGameMusic())}function _n(){let t=H.getSettings();de.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",de.classList.toggle("off",!t.soundsEnabled),zt.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",zt.classList.toggle("off",!t.musicEnabled)}function No(){Ee.classList.remove("hidden"),Vt.classList.add("hidden");let t=S.loadHighscore(bt);_e.textContent=t.score?t.score.toLocaleString():"0",rn.textContent=t.time?jn(t.time):"0:00",Be.textContent=bt==="30_24"?"High Tower":"Quick Tower",nn.textContent=Rt.toLocaleString(),Ht.textContent=jn(ve),Me.textContent=bt==="30_24"?"High Tower":"Quick Tower",_n()}function Bn(){Ee.classList.add("hidden"),Vt.classList.remove("hidden")}Vt.addEventListener("click",()=>{Rs(),No()}),Te.addEventListener("click",()=>{Bn(),Kn()});let ss=null;function As(t,u){An.textContent=t,ss=u,un.classList.remove("hidden")}function ws(){un.classList.add("hidden"),ss=null}Ke.addEventListener("click",()=>{ws()}),wn.addEventListener("click",()=>{let t=ss;ws(),t&&t()}),Oe.addEventListener("click",()=>{As("Restart game?",()=>{Bn(),Lt.applyCommand("start_game")})}),ke.addEventListener("click",()=>{As("Exit to menu?",()=>{Bn(),Vt.classList.add("hidden"),tt="intro",ut.reset(),H.stopMusic(),H.getSettings().musicEnabled&&H.startMenuMusic(),vn()})}),oe.addEventListener("click",()=>{ze.classList.remove("hidden")}),de.addEventListener("click",()=>{let t=H.getSettings();H.updateSettings({soundsEnabled:!t.soundsEnabled}),_n(),on()}),zt.addEventListener("click",()=>{let u=!H.getSettings().musicEnabled;H.updateSettings({musicEnabled:u}),_n(),on()}),Ee.addEventListener("click",t=>{t.target===Ee&&(Bn(),Kn())}),document.addEventListener("keydown",t=>{tt==="paused"&&!Ee.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Bn(),Kn())}),pn.addEventListener("click",()=>{ze.classList.add("hidden")}),ze.addEventListener("click",t=>{t.target===ze&&ze.classList.add("hidden")});let os=!1;document.addEventListener("visibilitychange",()=>{document.hidden?tt==="playing"&&(Rs(),os=!0):os&&tt==="paused"&&(Kn(),os=!1)});let Lt=ho({getN:()=>o,getH:()=>s,FALL_INTERVAL:ae,LOCK_DELAY_SEC:Qt,getKillRate:p,MATCH_HIGHLIGHT_SEC:re,MAGIC_SHRINK_SEC:Wt,RING_HIGHLIGHT_SEC:pt,getState:()=>({gameState:tt,score:Rt,elapsedMs:ve,startTime:he,totalPausedMs:Ye,stats:m,activePiece:P,pieceY:y,targetRot:Dt,rotFloat:rt,rotVel:ee,isGrounded:yt,isHighlighting:Je,isMagicAnimation:dn,isRingAnimation:Cn,highlightStartTime:bn,killLevel:St,grid:L,fallTimer:v,lockTimer:X}),setState:t=>{"elapsedMs"in t&&(ve=t.elapsedMs),"killLevel"in t&&(St=t.killLevel),"fallTimer"in t&&(v=t.fallTimer),"lockTimer"in t&&(X=t.lockTimer),"targetRot"in t&&(Dt=t.targetRot),"rotFloat"in t&&(rt=t.rotFloat),"rotVel"in t&&(ee=t.rotVel)},funcs:{startGame:Ro,endGame:ts,rotatePieceByDir:_o,tryMoveDown:Do,canPlaceAtRot:Ss,maybeResetLockDelay:Es,shootMagic:Eo,selectMagic:xe,updateGroundedState:Lo,lockPiece:Oo,finishHighlight:To,finishRingHighlight:Io},ui:{updateTimeHud:Jn,updateRemainingHud:Ms}}),Sn=yo({canvas:n,canvasCtx:c,getN:()=>o,getH:()=>s,TOP_PAD_PX:h,BOTTOM_PAD_PX:A,SIDE_MARGIN_PX:z,MAX_RADIUS_X:F,RADIUS_X_FACTOR:q,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:re,MATCH_SHRINK_PHASE:pe,MAGIC_SHRINK_SEC:Wt,RING_HIGHLIGHT_SEC:pt,LOCK_DELAY_SEC:Qt,getKillRate:p,ELEMENT_COLORS:be,ELEMENT_TO_COLOR:jt,BLOCK_COLOR_FRONT:st,BLOCK_COLOR_BACK:ot,ACTIVE_COLOR_FRONT:le,GHOST_COLOR_FILL:Q,GHOST_COLOR_STROKE:W,GHOST_STROKE_WIDTH:Mt,MAGIC_DIM_DOT_ALPHA:Ce,MAGIC_DIM_DOT_SCALE:Ue,MAGIC_TARGET_DOT_SCALE:Pt,getState:()=>({gameState:tt,grid:L,activePiece:P,pieceY:y,rotFloat:rt,killLevel:St,isHighlighting:Je,highlightedCells:Ze,highlightStartTime:bn,isMagicAnimation:dn,isRingAnimation:Cn,isGrounded:yt,lockTimer:X,spellState:Qe.getRenderState()}),getVisualSettings:()=>({waterBubbles:Ut,waterColor:an}),funcs:{snappedRot:Fn,computeGhostY:Bo,normSector:Gn,getMagicTargetColor:()=>C&&mt.canUse()?jt[mt.active]:null,getTransmuteAnimState:t=>Qe.getTransmuteAnimState(t),getLightningAnimState:t=>Qe.getLightningAnimState(t),getFireAnimState:t=>Qe.getFireAnimState(t)}}),is=performance.now();function Ps(t){let u=Math.min(.05,Math.max(.001,(t-is)/1e3));if(is=t,Lt.update(u,t),Qe.update(t),R>0){let d=Math.min(R,te*u);St=Math.max(0,St-d),R-=d}rt=Dt,rt>1e6&&(rt%=o),rt<-1e6&&(rt%=o),Sn.render(u,t),requestAnimationFrame(Ps)}Yt.addEventListener("click",()=>{Lt.applyCommand("start_game")}),G.addEventListener("click",()=>{Lt.applyCommand("start_game")}),O.addEventListener("click",()=>{tt="intro",ut.reset(),H.stopMusic(),H.getSettings().musicEnabled&&H.startMenuMusic(),vn()}),et.forEach(t=>{t.addEventListener("click",u=>{et.forEach(_=>_.classList.remove("active")),t.classList.add("active"),bt=t.dataset.mode,xn();let d=S.loadHighscore(bt);d.score>0?(M.textContent=d.score.toLocaleString(),I.textContent=gn(d.time)):(M.textContent="0",I.textContent="0:00"),Yt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>Yt.classList.add("idlePulse"),2e3)})});let cs=document.querySelectorAll(".spell-select-btn"),ls=document.getElementById("spellDesc"),Is=document.getElementById("spellProgressFill"),as=document.getElementById("spellProgressMarkers"),zn={ice:0,earth:10,air:25,fire:40},Os=Object.values(zn).sort((t,u)=>t-u),rs=Math.max(...Os),Xo={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"},cn=S.loadHighTowerRings();function Uo(){as&&(as.innerHTML="",Os.forEach(t=>{let u=document.createElement("span");u.className="marker",u.dataset.threshold=t;let d=t/rs*100;u.style.left=`${d}%`,as.appendChild(u)}))}function Yo(t){return t<=0?0:t>=rs?100:t/rs*100}function ks(t){if(!ls)return;let u=zn[t]||0,d=Xo[t]||"";u===0||cn>=u?ls.innerHTML=d:ls.innerHTML=`${d} <span class="spell-progress-text">${cn}/${u}</span>`}function Ds(){if(cn=S.loadHighTowerRings(),cs.forEach(d=>{let _=d.dataset.spell,lt=zn[_]||0,dt=cn>=lt;d.classList.toggle("locked",!dt);let gt=d.querySelector(".spell-lock");gt&&(gt.style.display=dt?"none":"")}),Is){let d=Yo(cn);Is.style.width=`${d}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(d=>{let _=parseInt(d.dataset.threshold,10)||0;d.classList.toggle("reached",cn>=_)});let u=document.querySelector(".spell-select-btn.active");u&&ks(u.dataset.spell)}Uo(),Ds(),cs.forEach(t=>{t.addEventListener("click",u=>{u.stopPropagation();let d=document.querySelector('.mode-btn[data-mode="30_24"]');if(d&&!d.classList.contains("active")){et.forEach(ie=>ie.classList.remove("active")),d.classList.add("active"),bt="30_24",xn();let gt=S.loadHighscore(bt);gt.score>0?(M.textContent=gt.score.toLocaleString(),I.textContent=gn(gt.time)):(M.textContent="0",I.textContent="0:00")}let _=t.dataset.spell,lt=zn[_]||0,dt=cn>=lt;ks(_),dt&&(cs.forEach(gt=>gt.classList.remove("active")),t.classList.add("active"),Ne.selectSpell(_))})}),ft.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),u=S.loadHighscore("25_20"),d=`Records

`;d+=`High Tower (30\xD724):
`,d+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${gn(t.time)}
`:`  No record yet
`,d+=`
Quick Tower (25\xD720):
`,d+=u.score>0?`  Score: ${u.score.toLocaleString()}, Time: ${gn(u.time)}
`:`  No record yet
`,alert(d)}),ct.addEventListener("click",()=>{ze.classList.remove("hidden")}),Bt.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
`+(C?`6) Use magic: tap element button, then tap matching block

`:`6) Magic is disabled in settings

`)+"Survive as long as you can!")}),Ft(),kn(),xn(),vn(),H.startMenuMusic();let Vo=()=>{if(H.unlock(),!H.getSettings().musicEnabled)return;let t=H.musicAudio;!t||t.paused||t.ended?Lt.state==="playing"?H.startGameMusic():H.startMenuMusic():t.play().catch(u=>{console.debug("Music resume on interaction failed:",u)})},Hs=0,Wo=10,Ko=()=>{Hs>=Wo||(Hs++,Vo())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Ko,{passive:!0})}),requestAnimationFrame(Ps)})();})();
