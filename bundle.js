(()=>{var Ns=[0,.25,.5,.75,1],Us=[0,.05,.15,.25,.5],Xs={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},Vn={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Yn="soundSettings";function Vs(){try{let e=localStorage.getItem(Yn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ys(e){try{localStorage.setItem(Yn,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Wn(){return{audioContext:null,buffers:{},settings:Vs(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Ns[this.settings.soundVolume]},getMusicVolume(){return Us[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(u){console.debug(`Failed to load sound: ${n} from ${r}`,u)}},preload(){this.initContext();for(let[n,r]of Object.entries(Xs))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;r!==null&&(u=`${n}${r}`);let i=this.buffers[u];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let o=this.audioContext.createBufferSource();o.buffer=i,o.connect(s),o.start(0),o.onended=()=>{o.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Vn.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Vn.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ys(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var Kn="eb_highscore",zn="eb_settings",Ws={invertSwipe:!1,difficulty:"easy"};function qn(){return{loadHighscore(){try{let e=localStorage.getItem(Kn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load highscore:",e)}return{score:0,time:0}},saveHighscore(e,n){try{let r=this.loadHighscore();if(e>r.score||e===r.score&&n>r.time)return localStorage.setItem(Kn,JSON.stringify({score:e,time:n})),!0}catch(r){console.debug("Failed to save highscore:",r)}return!1},loadGameSettings(){try{let e=localStorage.getItem(zn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Ws}},saveGameSettings(e){try{localStorage.setItem(zn,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}}}}function Zn(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),playAgainBtn:document.getElementById("playAgainBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Jn(e){return document.getElementById("tab-"+e)}var jn={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Qn(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(u,i="score",s=null){let o=document.createElement("div");o.className=`bonus-popup ${i}`,o.textContent=u,s&&n[s]&&(o.style.color=n[s]);let l=window.innerWidth/2,g=window.innerHeight/2-40,p=(Math.random()-.5)*200,f=(Math.random()-.5)*100+r*36;o.style.left=`${l+p}px`,o.style.top=`${g+f}px`,o.style.transform="translate(-50%, -50%)",document.body.appendChild(o),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{o.remove()},1800)},getElementIcon(u){return jn[u]||"\u2726"},spawnMagicOrb(u,i,s,o){if(!o)return;let l=document.createElement("div");l.className=`magic-orb ${u}`,l.textContent=jn[u]||"\u2726";let g=o.getBoundingClientRect(),p=g.left+g.width/2-i,f=g.top+g.height/2-s,S=Math.hypot(p,f),q=Math.atan2(f,p),D=S*.35*(Math.random()>.5?1:-1),Z=q+Math.PI/2,k=p*.5+Math.cos(Z)*D,w=f*.5+Math.sin(Z)*D;l.style.setProperty("--mid-x",`${k}px`),l.style.setProperty("--mid-y",`${w}px`),l.style.setProperty("--end-x",`${p}px`),l.style.setProperty("--end-y",`${f}px`),l.style.left=`${i}px`,l.style.top=`${s}px`,document.body.appendChild(l),setTimeout(()=>{l.remove(),o&&(o.classList.remove("pulse"),o.offsetWidth,o.classList.add("pulse"),setTimeout(()=>o.classList.remove("pulse"),400))},700)}}}function ts(e={}){let{buttons:n={},onActivate:r=null}=e,u={fire:3,water:3,lightning:3,earth:3},i=null;function s(){for(let[o,l]of Object.entries(n)){if(!l)continue;let g=u[o],p=l.querySelector(".charges");p&&(p.textContent=g),l.classList.toggle("empty",g<=0),l.classList.toggle("active",i===o&&g>0)}}return{get charges(){return u},get active(){return i},set active(o){i=o},select(o){if(u[o]<=0)return!1;let l=i===o;return i=l?null:o,s(),!l&&i===o&&r&&r(),!l},useCharge(){return!i||u[i]<=0?!1:(u[i]--,i=null,s(),!0)},addCharges(o,l){u[o]!==void 0&&(u[o]+=l,s())},canUse(){return i!==null&&u[i]>0},deactivate(){i=null,s()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,i=null,s()},updateButtons:s,initButtons(o){for(let[l,g]of Object.entries(n))g&&g.addEventListener("click",()=>{o&&o(l)})}}}var Ks={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function es(e={}){let{canvas:n}=e,r=e.rotDir||1,u=!1,i=0,s=0,o=0,l=0,g=0,p=1,f=null,S=0,q=0,D=0,Z=0,k=0,w=0,It=0,Tt=0,Y=Ks;return{get rotDir(){return r},set rotDir(R){r=R},get dragging(){return u},get dragMode(){return f},handlePointerDown(R,nt,le){if(nt.onMagicTap&&nt.onMagicTap(R.clientX,R.clientY))return!0;let Dt=performance.now(),Wt=Dt-w,xt=R.clientX-It,Et=R.clientY-Tt,te=Math.hypot(xt,Et);return Wt<=Y.DOUBLE_TAP_MS&&te<=Y.DOUBLE_TAP_MAX_DIST?(nt.onDoubleTap&&nt.onDoubleTap(),w=0):(w=Dt,It=R.clientX,Tt=R.clientY),u=!0,p=-1,i=R.clientX,s=R.clientY,o=le,l=0,g=0,f=null,S=Dt,q=R.clientX,D=R.clientY,Z=S,k=0,n&&n.setPointerCapture(R.pointerId),!1},handlePointerMove(R,nt,le,Dt){if(!u)return null;let Wt=R.clientX-i,xt=R.clientY-s,Et=performance.now();if(Math.abs(Wt)<Y.DEADZONE_PX&&Math.abs(xt)<Y.DEADZONE_PX)return null;if(!f){let Lt=Math.abs(Wt),dt=Math.abs(xt);if(xt<0)Lt>=Y.DEADZONE_PX&&(f="rotate");else if(dt>=Lt*Y.AXIS_DOMINANCE){if(dt>=Y.DROP_SWIPE_MIN_DISTANCE){let c=Math.max(1,Et-S);dt/c*1e3>=Y.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else Lt>=dt*Y.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let te=null;if(f==="rotate"&&Math.abs(Wt)>=Y.DEADZONE_PX){let Lt=Math.max(1,Et-Z),dt=R.clientX-q,c=Math.max(1,Math.abs(dt)/Lt*1e3),Kt=Math.max(Y.MIN_ROT_PX,Math.min(Y.MAX_ROT_PX,Y.PX_PER_STEP*(Y.SWIPE_SPEED_REF/c)));k+=-dt/Kt*r*p;let ht=Math.trunc(k);ht!==0&&(k-=ht);let kt=l+ht;if(kt!==l&&nt.canRotateTo){let ee=Math.sign(kt-l),ne=o+l;for(;l!==kt;){let pe=l+ee,vt=o+pe;if(!nt.canRotateTo(Math.floor(le),vt))break;l=pe,ne=vt,Dt&&nt.onGroundedMove&&nt.onGroundedMove()}te={targetRot:ne,rotFloat:ne}}}if(f==="drop"&&xt>Y.DEADZONE_PX&&nt.onDrop){let Lt=Math.max(1,Et-Z),dt=R.clientY-D,c=Math.max(1,dt/Lt*1e3),Kt=Math.max(Y.MIN_DROP_PX,Math.min(Y.MAX_DROP_PX,Y.PX_PER_DROP*(Y.SWIPE_SPEED_REF/c))),ht=Math.trunc(xt/Kt);if(ht>g){let kt=ht-g;for(let ee=0;ee<kt;ee++)nt.onDrop();g=ht}}return q=R.clientX,D=R.clientY,Z=Et,te},handlePointerUp(R){if(u&&(u=!1,f=null,n&&R&&R.pointerId!==void 0))try{n.releasePointerCapture(R.pointerId)}catch{}},reset(){u=!1,f=null,l=0,g=0,k=0}}}var xn={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function ns(){let e="intro",n=0,r=0,u=0,i=0,s=0,o={...xn};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return r},get stats(){return o},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),u=0,i=0,s=0,o={...xn}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(l){n+=l},setScore(l){n=l},updateTime(){e==="playing"&&r>0&&(u=performance.now()-r-s)},getFormattedTime(){let l=Math.floor(u/1e3),g=Math.floor(l/60),p=l%60;return`${g}:${p.toString().padStart(2,"0")}`},incrementStat(l,g=1){l in o&&(o[l]+=g)},updateMaxStat(l,g){l in o&&g>o[l]&&(o[l]=g)},reset(){e="intro",n=0,r=0,u=0,i=0,s=0,o={...xn}}}}function _e(e,n){return e%=n,e<0&&(e+=n),e}function ss(e,n){return e[Math.min(n,e.length-1)]}function Je(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),u=n%60;return`${r}:${u.toString().padStart(2,"0")}`}function os(e,n){let r=e.map(({x:l,y:g},p)=>({x:g,y:-l,color:n[p]})),u=1/0,i=-1/0,s=1/0;for(let l of r)u=Math.min(u,l.x),i=Math.max(i,l.x),s=Math.min(s,l.y);let o=Math.round((u+i)/2);for(let l of r)l.x-=o,l.y-=s;return r.sort((l,g)=>l.y-g.y||l.x-g.x),{cells:r.map(l=>({x:l.x,y:l.y})),colors:r.map(l=>l.color)}}function vn(e,n,r,u){let i=[];return e+1<r&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:_e(n-1,u)}),i.push({y:e,s:_e(n+1,u)}),i}function is(e,n,r){let u=Array.from({length:n},()=>new Uint8Array(r)),i=[];for(let s=0;s<n;s++)for(let o=0;o<r;o++){if(!e[s][o]||u[s][o])continue;let l=[],g=[{y:s,s:o}];for(u[s][o]=1;g.length>0;){let p=g.shift();l.push(p);for(let f of vn(p.y,p.s,n,r))e[f.y][f.s]&&!u[f.y][f.s]&&(u[f.y][f.s]=1,g.push(f))}i.push(l)}return i}function cs(e){return e.some(n=>n.y===0)}function bn(e,n,r,u,i,s){if(!e)return!1;let o=_e(r,s);for(let l of e.cells){let g=n+l.y,p=_e(o+l.x,s);if(g<0)return!1;if(!(g>=i)&&u[g][p])return!1}return!0}function as(e,n,r,u,i,s){if(!e)return null;let o=Math.floor(n);for(;bn(e,o-1,r,u,i,s);)o-=1;return o}function ls(e,n,r){let u=[],i=[];for(let s=0;s<n;s++){let o=[],l=0,g=e[s][0],p=g?1:0;for(let f=1;f<=r;f++){let S=f<r?e[s][f]:0;S&&S===g?p++:(p>=1&&g&&o.push({start:l,length:p,color:g}),l=f,g=S,p=S?1:0)}if(o.length>=2){let f=o[0],S=o[o.length-1];if(f.start===0&&S.start+S.length===r&&f.color===S.color){let q=f.length+S.length;o[0]={start:S.start,length:q,color:f.color},o.pop()}}for(let f of o)if(f.length>=3){let S=[];for(let q=0;q<f.length;q++)S.push({y:s,s:(f.start+q)%r});u.push({color:f.color,length:f.length,cells:S})}}for(let s=0;s<r;s++){let o=0,l=e[0][s],g=l?1:0;for(let p=1;p<=n;p++){let f=p<n?e[p][s]:0;if(f&&f===l)g++;else{if(g>=3&&l){let S=[];for(let q=0;q<g;q++)S.push({y:o+q,s});u.push({color:l,length:g,cells:S})}o=p,l=f,g=f?1:0}}}for(let s=0;s<n;s++)for(let o=0;o<r;o++){let l=e[s][o],g=e[s][(o+1)%r],p=e[s][(o+2)%r],f=e[s][(o+3)%r];l&&l===g&&p&&p===f&&l!==p&&i.push({cells:[{y:s,s:o},{y:s,s:(o+1)%r},{y:s,s:(o+2)%r},{y:s,s:(o+3)%r}]})}for(let s=0;s<r;s++)for(let o=0;o<n-3;o++){let l=e[o][s],g=e[o+1][s],p=e[o+2][s],f=e[o+3][s];l&&l===g&&p&&p===f&&l!==p&&i.push({cells:[{y:o,s},{y:o+1,s},{y:o+2,s},{y:o+3,s}]})}return{lineMatches:u,pairMatches:i}}function rs(e,n,r){let u=[];for(let i=0;i<n;i++){let s=!0;for(let o=0;o<r;o++)if(!e[i][o]){s=!1;break}s&&u.push(i)}return u}function us(e,n){let r=new Map;e.forEach((u,i)=>r.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],s=n[u],o=1;for(let w=1;w<=2&&r.get(`${i.x+w},${i.y}`)===s;w++)o++;if(o>=3)return!0;let l=1;for(let w=1;w<=2&&r.get(`${i.x},${i.y+w}`)===s;w++)l++;if(l>=3)return!0;let g=s,p=r.get(`${i.x+1},${i.y}`),f=r.get(`${i.x+2},${i.y}`),S=r.get(`${i.x+3},${i.y}`);if(g&&p&&f&&S&&g===p&&f===S&&g!==f)return!0;let q=s,D=r.get(`${i.x},${i.y+1}`),Z=r.get(`${i.x},${i.y+2}`),k=r.get(`${i.x},${i.y+3}`);if(q&&D&&Z&&k&&q===D&&Z===k&&q!==Z)return!0}return!1}function ds(e){let{N:n,H:r,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,KILL_RATE:s,MATCH_HIGHLIGHT_SEC:o,MAGIC_SHRINK_SEC:l,RING_HIGHLIGHT_SEC:g,getState:p,setState:f,funcs:S,ui:q}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(D,Z={}){let k=p();if(D==="start_game")return k.gameState!=="playing"?(S.startGame(),!0):!1;if(k.gameState!=="playing")return!1;switch(D){case"rotate_piece":return S.rotatePieceByDir(),!0;case"move_down":return S.tryMoveDown();case"rotate_cylinder":{let{rot:w}=Z;return typeof w=="number"&&S.canPlaceAtRot(Math.floor(k.pieceY),w)?(f({targetRot:w,rotFloat:w,rotVel:0}),k.isGrounded&&S.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:w,y:It}=Z;return S.shootMagic(w,It)}case"select_magic":{let{element:w}=Z;return S.selectMagic(w),!0}default:return console.warn("GameEngine: unknown command",D),!1}},update(D,Z){let k=p();if(k.gameState!=="playing")return;let w=Z-k.startTime-k.totalPausedMs;f({elapsedMs:w}),q.updateTimeHud();let It=k.killLevel+s*D;if(f({killLevel:It}),It>=r){S.endGame();return}if(k.isHighlighting){let R=(Z-k.highlightStartTime)/1e3,nt;k.isRingAnimation?nt=g:k.isMagicAnimation?nt=l:nt=o,R>=nt&&(k.isRingAnimation?S.finishRingHighlight():S.finishHighlight())}let Tt=k.fallTimer+D;if(Tt>=u&&(Tt-=u,S.tryMoveDown()),f({fallTimer:Tt}),S.updateGroundedState()){let R=k.lockTimer+D;f({lockTimer:R}),R>=i&&S.lockPiece()}},reset(){S.startGame()},canRotateTo(D,Z){return S.canPlaceAtRot(D,Z)},getRotation(){let D=p();return{targetRot:D.targetRot,rotFloat:D.rotFloat,rotVel:D.rotVel}},setRotation(D){f({targetRot:D,rotFloat:D,rotVel:0})},onGroundedMove(){S.maybeResetLockDelay()}}}var Ot=Math.PI*2;function ms(e){let{canvas:n,canvasCtx:r,N:u,H:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:o,MAX_RADIUS_X:l,RADIUS_X_FACTOR:g,ANG_OFFSET:p,MATCH_HIGHLIGHT_SEC:f,MATCH_SHRINK_PHASE:S,MAGIC_SHRINK_SEC:q,RING_HIGHLIGHT_SEC:D,LOCK_DELAY_SEC:Z,KILL_RATE:k,ELEMENT_COLORS:w,ELEMENT_TO_COLOR:It,BLOCK_COLOR_FRONT:Tt,BLOCK_COLOR_BACK:Y,ACTIVE_COLOR_FRONT:R,GHOST_COLOR_FILL:nt,GHOST_COLOR_STROKE:le,GHOST_STROKE_WIDTH:Dt,MAGIC_DIM_DOT_ALPHA:Wt,MAGIC_DIM_DOT_SCALE:xt,MAGIC_TARGET_DOT_SCALE:Et,getState:te,getVisualSettings:Lt,funcs:dt}=e,c=r,Kt={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},ht=[],kt=15,ee=2;function ne(_,C,M,A,b,I,y){for(ht=ht.filter(m=>m.y>_+m.size);ht.length<kt;){let m=Math.random()>.5?"left":"right",E=10,W=m==="left"?E+Math.random()*(C-E*2):M+E+Math.random()*(b-M-E*2),L=A+20+Math.random()*100;ht.push({x:W,baseX:W,y:L,size:1.5+Math.random()*3,speedFactor:.9+Math.random()*.2,wobble:Math.random()*Math.PI*2,wobbleSpeed:.4+Math.random()*.4,wobbleAmp:3+Math.random()*4,side:m,minX:m==="left"?E:M+E,maxX:m==="left"?C-E:b-E})}let T=I*ee;for(let m of ht){m.y-=T*m.speedFactor*y,m.wobble+=m.wobbleSpeed*y;let E=m.baseX+Math.sin(m.wobble)*m.wobbleAmp;m.x=Math.max(m.minX,Math.min(m.maxX,E))}}function pe(_){c.fillStyle="rgba(255, 255, 255, 0.25)",c.strokeStyle="rgba(255, 255, 255, 0.4)",c.lineWidth=1;for(let C of ht)C.y<_+C.size||(c.beginPath(),c.arc(C.x,C.y,C.size,0,Math.PI*2),c.fill(),c.stroke())}function vt(_,C,M){let A=1-M/i;return _+A*C}function he(_){return _=_%u,_<0?_+u:_}function ye(_,C,M,A,b,I){let y=he(I),T=(b-y)/u*Ot+p;return{x:_+Math.cos(T)*M,y:C+Math.sin(T)*A,ang:T}}let Pe=.52,je=1.02;function Bt(_,C,M,A,b,I){let y=he(I),T=(b-y)/u*Ot+p;return{x:_+Math.cos(T)*M,y:C+Math.sin(T)*A,ang:T}}function Qe(_,C,M,A,b,I,y,T=1){let m=Bt(_,C,M,A,b-Pe,I),E=Bt(_,C,M,A,b+Pe,I),W={x:m.x,y:m.y-y*.5},L={x:m.x,y:m.y+y*.5},J={x:E.x,y:E.y-y*.5},at={x:E.x,y:E.y+y*.5},H=(W.x+J.x+at.x+L.x)*.25,N=(W.y+J.y+at.y+L.y)*.25,mt=je*T,ft=T,$=[W,J,at,L].map(st=>({x:H+(st.x-H)*mt,y:N+(st.y-N)*ft})),St=Math.abs((E.x-m.x)*mt),Gt=Math.abs(y*ft);return{corners:$,cx:H,cy:N,wApprox:St,hApprox:Gt,ang:Bt(_,C,M,A,b,I).ang}}function se(_,C,M,A,b,I,y,T,m=1,E=null,W=1,L=null,J=0,at=1,H=1){let N=Qe(_,C,M,A,b,I,y,H),[mt,ft,$,St]=N.corners;if(c.save(),c.globalAlpha=m,c.fillStyle=T,c.beginPath(),c.moveTo(mt.x,mt.y),c.lineTo(ft.x,ft.y),c.lineTo($.x,$.y),c.lineTo(St.x,St.y),c.closePath(),c.fill(),L&&J>0&&(c.strokeStyle=L,c.lineWidth=J,c.stroke()),E){let Gt=Math.min(N.wApprox,N.hApprox)*.28*at;c.globalAlpha=m*W,c.fillStyle=E,c.beginPath(),c.arc(N.cx,N.cy,Gt,0,Ot),c.fill()}c.restore(),c.globalAlpha=1}function tn(_,C,M,A,b,I){let y=ye(_,C,M,A,b,I),T=ye(_,C,M,A,b+1,I),m=ye(_,C,M,A,b-1,I),E=Math.abs(T.x-y.x),W=Math.abs(y.x-m.x),L=(E+W)*.5*1.06;return Math.max(1,L)}function en(_,C,M,A,b,I){let y=(b-I)/u*Ot+p;return{x:_+Math.cos(y)*M,y:C+Math.sin(y)*A,ang:y}}function nn(_,C,M,A,b,I,y,T=1,m=null,E=1,W=null,L=0,J=1){c.save(),c.translate(_,C);let at=Math.atan2(A,M);if(c.rotate(at),c.globalAlpha=T,c.fillStyle=y,c.fillRect(-b/2,-I/2,b,I),W&&L>0&&(c.strokeStyle=W,c.lineWidth=L,c.strokeRect(-b/2,-I/2,b,I)),m){let H=Math.min(b,I)*.28*J;c.globalAlpha=T*E,c.fillStyle=m,c.beginPath(),c.arc(0,0,H,0,Ot),c.fill()}c.restore(),c.globalAlpha=1}return{resize(){let _=Math.max(1,Math.min(2,window.devicePixelRatio||1)),C=Math.floor(n.clientWidth*_),M=Math.floor(n.clientHeight*_);(n.width!==C||n.height!==M)&&(n.width=C,n.height=M,c.setTransform(_,0,0,_,0,0))},render(_=.016){this.resize();let C=te(),M=n.clientWidth,A=n.clientHeight;c.clearRect(0,0,M,A),c.fillStyle="#0b0f14",c.fillRect(0,0,M,A);let b=M*.5,I=s,y=A-o,T=Math.max(1,y-I),m=Math.min(M*g,l),E=m*.28,{killLevel:W,rotFloat:L,grid:J,gameState:at}=C,H=Lt?Lt():{},N=H.waterColor||"blue",mt=H.waterBubbles||!1,ft=Kt[N]||Kt.blue,$=vt(I,T,W),St=.7,Gt=W/i,st={...ft.top},h={...ft.bottom};if(Gt>St){let x=(Gt-St)/(1-St);st.r=Math.round(st.r+(255-st.r)*x*.5),st.g=Math.round(st.g+(150-st.g)*x*.5),st.b=Math.round(st.b+(150-st.b)*x*.5),h.r=Math.round(h.r+(180-h.r)*x),h.g=Math.round(h.g*(1-x*.6)),h.b=Math.round(h.b*(1-x*.6))}let gt=b-m-8,K=b+m+8,bt=I,Ht=y+5,Rt=c.createLinearGradient(0,$,0,A);Rt.addColorStop(0,`rgba(${st.r},${st.g},${st.b},0.5)`),Rt.addColorStop(1,`rgba(${h.r},${h.g},${h.b},0.7)`),c.fillStyle=Rt;let Ee=Math.round((st.r+h.r)/2),Te=Math.round((st.g+h.g)/2),zt=Math.round((st.b+h.b)/2),X=m+8,Le=E+4;c.fillRect(0,$,gt,A-$),c.fillRect(K,$,M-K,A-$),c.beginPath();let oe=Math.max($,Ht);if(c.moveTo(gt,oe),$<=Ht+Le?c.ellipse(b,Ht,X,Le,0,Math.PI,0,!1):c.lineTo(K,oe),c.lineTo(K,A),c.lineTo(gt,A),c.closePath(),c.fill(),c.strokeStyle="rgba(100,180,255,0.6)",c.lineWidth=3,c.lineCap="round",c.beginPath(),c.moveTo(gt,bt),c.lineTo(gt,Ht),c.stroke(),c.beginPath(),c.moveTo(K,bt),c.lineTo(K,Ht),c.stroke(),c.beginPath(),c.ellipse(b,Ht,m+8,E+4,0,0,Math.PI),c.stroke(),c.fillStyle="#0b0f14",c.beginPath(),c.ellipse(b,Ht,m+8,E+4,0,0,Ot),c.fill(),W>.5&&(c.strokeStyle=`rgba(${Math.min(255,Ee+60)},${Math.min(255,Te+40)},${Math.min(255,zt+40)},0.6)`,c.lineWidth=2,c.beginPath(),c.moveTo(0,$),c.lineTo(gt,$),c.moveTo(K,$),c.lineTo(M,$),c.stroke()),mt&&W>.5){let x=k*T/i;ne($,gt,K,A,M,x,_),pe($)}c.strokeStyle="rgba(160,190,220,0.3)",c.lineWidth=1;let pt=Ot*m,Oe=10,sn=pt/Oe*.7,on=pt/Oe*.3;c.setLineDash([sn,on]);let ie=pt/u;c.lineDashOffset=he(L)*ie;for(let x=0;x<=i;x++){let G=vt(I,T,x);c.beginPath(),c.ellipse(b,G,m,E,0,0,Ot),c.stroke()}c.setLineDash([]);let De=[],Ae=[];for(let x=0;x<i;x++){let G=vt(I,T,x+.5);for(let P=0;P<u;P++){let z=J[x][P];if(!z)continue;let B=ye(b,G,m,E,P,L),ot=Math.sin(B.ang),O={y:x,s:P,yScr:G,p:B,depth:ot,color:z};ot<-.1?De.push(O):Ae.push(O)}}let ke=dt.getMagicTargetColor(),{isHighlighting:re,highlightedCells:ue,highlightStartTime:$t,isMagicAnimation:qt}=C,de=null,Se=1,Me=1,xe=!1;if(re&&ue.length>0){de=new Set(ue.map(G=>`${G.y},${G.s}`));let x=(performance.now()-$t)/1e3;if(qt){let G=Math.min(1,x/q);Se=1-G*.85,Me=1-G*.9,xe=!0}else{let G=Math.min(1,x/f),P=1-S;if(G>P){let z=(G-P)/S;Se=1-z*.85,Me=1-z*.9,xe=!0}}}De.sort((x,G)=>x.depth-G.depth);for(let x of De){let G=T/i*.9,P=w[x.color]||null,z=.35,B=1,ot=`${x.y},${x.s}`;de&&de.has(ot)&&(z*=Me,B=Se),se(b,x.yScr,m,E,x.s,L,G,Y,z,P,.5,null,0,1,B)}let{isRingAnimation:Ft}=C;if(re&&ue.length>0&&!qt){let x=(performance.now()-$t)/1e3,P=Math.min(1,x/(Ft?D:f)),z=1-S,B=P>z,ot=B?(P-z)/S:0,O=Ft?Math.floor(P*z*u*2)%u:-1,U=4+P/z*10,it=Math.sin(x*U*Ot),Ct=B?1:.3+it*.3,ct=B?1-ot*.8:1,_t=B?1-ot:1;for(let lt of ue){let Nt=vt(I,T,lt.y+.5),Ie=Bt(b,Nt,m,E,lt.s,L);if(Math.sin(Ie.ang)>=-.1)continue;let Be=T/i*.9,yt,rt,Ut;if(Ft){let ve=(lt.s-O+u)%u,me=ve<3?1-ve/3:0;yt=(B?_t:.2+me*.5)*.5,rt=`rgba(255, 159, 67, ${yt})`,Ut=B?ct:1+me*.15}else yt=Ct*_t,rt=lt.isLine?`rgba(255, 255, 255, ${yt*.5})`:`rgba(255, 220, 100, ${yt*.4})`,Ut=B?ct:1.1;se(b,Nt,m,E,lt.s,L,Be,rt,1,null,1,null,0,1,Ut)}}Ae.sort((x,G)=>x.depth-G.depth);for(let x of Ae){let G=T/i*.9,P=w[x.color]||null,z=1,B=1,ot=1,O=1,U=`${x.y},${x.s}`,it=de&&de.has(U);it&&(z=Me,B=Se),ke!==null&&!it&&(x.color!==ke?(ot=Wt,O=xt):O=Et),se(b,x.yScr,m,E,x.s,L,G,Tt,z,P,ot,null,0,O,B)}if(re&&ue.length>0&&!qt){let x=(performance.now()-$t)/1e3,P=Math.min(1,x/(Ft?D:f)),z=1-S,B=P>z,ot=B?(P-z)/S:0,O=Ft?Math.floor(P*z*u*2)%u:-1,U=4+P/z*10,it=Math.sin(x*U*Ot),Ct=B?1:.5+it*.5,ct=B?1-ot*.8:1,_t=B?1-ot:1;for(let lt of ue){let Nt=vt(I,T,lt.y+.5),Ie=Bt(b,Nt,m,E,lt.s,L);if(Math.sin(Ie.ang)<-.1)continue;let Be=T/i*.9,yt,rt,Ut;if(Ft){let ve=(lt.s-O+u)%u,me=ve<4?1-ve/4:0;yt=B?_t:.3+me*.7,rt=`rgba(255, 159, 67, ${yt})`,Ut=B?ct:1+me*.2}else yt=Ct*_t,rt=lt.isLine?`rgba(255, 255, 255, ${yt*.7})`:`rgba(255, 220, 100, ${yt*.6})`,Ut=B?ct:1.15;se(b,Nt,m,E,lt.s,L,Be,rt,1,null,1,null,0,1,Ut)}}let{activePiece:Zt,pieceY:cn,isGrounded:an,lockTimer:Ge}=C;if(Zt){let x=dt.snappedRot(),G=x,P=dt.computeGhostY(),z=T/i*.9;if(P!==null){let O=[];for(let U=0;U<Zt.cells.length;U++){let it=Zt.cells[U],Ct=Zt.colors[U],ct=P+it.y,_t=dt.normSector(x+it.x);if(ct<0||ct>=i)continue;let lt=vt(I,T,ct+.5),Nt=Bt(b,lt,m,E,_t,G);O.push({cy:ct,cs:_t,yScr:lt,depth:Math.sin(Nt.ang),color:Ct})}O.sort((U,it)=>U.depth-it.depth);for(let U of O){let it=w[U.color]||null;se(b,U.yScr,m,E,U.cs,G,z,nt,1,it,.5,le,Dt,1,1)}}let B=R;if(an&&Ge>0){let O=Math.min(1,Ge/Z),U=255,it=Math.round(170+85*O),Ct=Math.round(180+75*O),ct=.75+(1-.75)*O;B=`rgba(${U},${it},${Ct},${ct})`}let ot=[];for(let O=0;O<Zt.cells.length;O++){let U=Zt.cells[O],it=Zt.colors[O],Ct=dt.normSector(x+U.x),ct=cn+U.y;if(ct<0||ct>=i)continue;let _t=vt(I,T,ct+.5),lt=Bt(b,_t,m,E,Ct,G);ot.push({cs:Ct,yScr:_t,depth:Math.sin(lt.ang),color:it})}ot.sort((O,U)=>O.depth-U.depth);for(let O of ot){let U=w[O.color]||null;se(b,O.yScr,m,E,O.cs,G,z,B,1,U,1,null,0,1,1)}}},drawNextPreview(_,C){if(!_)return;let M=_.getContext("2d"),A=_.width,b=_.height;if(M.clearRect(0,0,A,b),!C)return;let I=1/0,y=-1/0,T=1/0,m=-1/0;for(let H of C.cells)I=Math.min(I,H.x),y=Math.max(y,H.x),T=Math.min(T,H.y),m=Math.max(m,H.y);let E=y-I+1,W=m-T+1,L=Math.min(A/(E+.5),b/(W+.5)),J=(A-E*L)/2,at=(b-W*L)/2;M.fillStyle=Tt;for(let H=0;H<C.cells.length;H++){let N=C.cells[H],mt=J+(N.x-I)*L,ft=at+(W-1-(N.y-T))*L;M.fillRect(mt+1,ft+1,L-2,L-2);let $=C.colors[H],St=w[$];if(St){let Gt=(L-2)*.32;M.fillStyle=St,M.beginPath(),M.arc(mt+L/2,ft+L/2,Gt,0,Ot),M.fill(),M.fillStyle=Tt}}}}}(()=>{let e=Zn(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,s=24,o=Math.PI/2,l=18,g=90,p=260,f=.36,S="rgb(235,240,250)",q="rgb(55,62,75)",D="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",k="rgba(110,255,150,0.85)",w=2,It={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Tt={1:"fire",2:"water",3:"lightning",4:"earth"},Y={fire:1,water:2,lightning:3,earth:4},R=1,nt=.58,le=!0,Dt=12,Wt=25,xt=120,Et=s/xt,te=1,Lt=2,dt=3,c=5,Kt=8,ht=10,kt=15,ee=30,ne=2,pe=.3,vt=.5,he=1,ye=.3,Pe=.5,je=1.3,Bt=10,Qe=500,se=[1,1.25,1.5,1.75,2],tn=10,en=100,nn=25,_=[1,1.3,1.6,2],C=[1,1.5,2,2.5],M=qn(),A=M.loadGameSettings(),b=A.invertSwipe?-1:1,I=-1,y=Array.from({length:s},()=>new Uint8Array(i)),T=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],m=null,E=s+3,W=0,L=0,J=!1,at=0,H=0,N=0,mt=0,ft=0,$=es({canvas:n,rotDir:b}),St="0.12.2",Gt=!0,st="blue",h=Wn();h.preload();let gt=ns(),K="intro",bt=0,Ht=0,Rt=0,Ee=0,Te=0,zt=null,X=gt.stats,Le=e.overlay,oe=Qn({elementColors:It}),pt=oe.showBonus.bind(oe),Oe=oe.getElementIcon.bind(oe),sn=e.overlayTitle,on=e.overlayStats,ie=e.startBtn,De=e.hud,Ae=e.scoreHud,ke=e.timeHud,re=e.nextCanvas,ue=re.getContext("2d"),$t=e.pauseBtn,qt=e.pauseOverlay,de=e.resumeBtn,Se=e.exitToMenuBtn,Me=e.pauseSettingsBtn,xe=e.pauseSoundBtn,Ft=e.pauseMusicBtn,Zt=e.pauseBestScore,cn=e.pauseBestTime,an=e.pauseBestMode,Ge=e.pauseCurrentScore,x=e.pauseCurrentTime,G=e.pauseCurrentMode,P=e.settingsOverlay,z=e.settingsClose,B=e.fullscreenBtn,ot=e.rotateBtn,O=e.startPanel,U=e.gameoverPanel,it=e.playAgainBtn,Ct=e.bestScore,ct=e.bestExtra,_t=e.surviveVal,lt=e.startVersion,Nt=e.modeBtns,Ie=e.recordsBtn,ln=e.startSettingsBtn,Be=e.helpBtn,yt="30_24",rt=ts({buttons:e.magicBtns,onActivate:()=>h.play("spells")}),Ut=e.magicBtns,ve=rt.charges,me=t=>rt.select(t),rn=()=>rt.updateButtons(),Jt=[],Re=0,jt=!1,fe=!1,we=!1,Xt=0,Vt=0,ce=0,He=[];function Cn(t,a,d){let v=1-d/s;return t+v*a}function _n(t,a,d,v,V,Q){let ut=(V-Q)/i*u+o;return{x:t+Math.cos(ut)*d,y:a+Math.sin(ut)*v,ang:ut}}function fs(t,a){let d=n.clientWidth,v=n.clientHeight,V=d*.5,Q=l,ut=v-g,wt=Math.max(1,ut-Q),At=Math.min(d*f,p),be=At*.28,ge=Cn(Q,wt,t+.5),tt=_n(V,ge,At,be,a,N);return{x:tt.x,y:tt.y}}function gs(t,a){if(!rt.canUse()||jt)return!1;let d=Y[rt.active],v=n.clientWidth,V=n.clientHeight,Q=v*.5,ut=l,wt=V-g,At=Math.max(1,wt-ut),be=Math.min(v*f,p),ge=be*.28,tt=null,et=1/0;for(let F=0;F<s;F++){let Mt=Cn(ut,At,F+.5);for(let Pt=0;Pt<i;Pt++){let Yt=y[F][Pt];if(!Yt||Yt!==d)continue;let Qt=_n(Q,Mt,be,ge,Pt,N);if(Math.sin(Qt.ang)<-.1)continue;let Ce=t-Qt.x,Nn=a-Qt.y,Un=Math.hypot(Ce,Nn),Xn=At/s*.9,Fs=Xn*1.2;Math.abs(Ce)<Fs/2&&Math.abs(Nn)<Xn/2&&Un<et&&(et=Un,tt={y:F,s:Pt})}}if(tt){let F=y[tt.y][tt.s];return Jt=[{y:tt.y,s:tt.s,color:F,isLine:!1,isMagic:!0}],Re=performance.now(),jt=!0,fe=!0,Xt=0,Vt=nn,pt(`+${nn}`,"score"),ce=0,rt.useCharge(),X.magicUsed++,!0}return!1}let qs=100;function Zs(t,a){return vn(t,a,s,i)}function ps(){return is(y,s,i)}let hs=cs;function ys(t){let a=t.map(v=>({...v,color:y[v.y][v.s]}));for(let v of t)y[v.y][v.s]=0;let d=s;for(let v of t){let V=v.y;for(let Q=1;Q<=v.y;Q++){let ut=v.y-Q;if(y[ut][v.s]){V=Q-1;break}}d=Math.min(d,V)}for(let v of a)y[v.y-d][v.s]=v.color;return d>0}function Es(){let t=!0;for(;t;){t=!1;let a=ps();for(let d of a)hs(d)||ys(d)&&(t=!0)}}function Ss(){dn()}let un=ss;function Tn(t,a){let d=new Map,v=0,V=0,Q=0,ut={},wt=t.length+a.length;for(let et of t){let F=Tt[et.color],Mt=0,Pt=0;if(et.length>=5?(Mt=dt,Pt=ht,X.lines5++):et.length===4?(Mt=Lt,Pt=Kt,X.lines4++):et.length===3&&(Mt=te,Pt=c,X.lines3++),F&&Mt>0){rt.addCharges(F,Mt),ut[F]=(ut[F]||0)+Mt;let Yt=et.cells[Math.floor(et.cells.length/2)],Qt=fs(Yt.y,Yt.s),Fn=Ut[F];for(let Ce=0;Ce<Mt;Ce++)setTimeout(()=>{oe.spawnMagicOrb(F,Qt.x,Qt.y,Fn)},Ce*100)}v+=Pt*Et,Q+=Pt,V+=et.length*tn;for(let Yt of et.cells){let Qt=`${Yt.y},${Yt.s}`;d.has(Qt)||d.set(Qt,{y:Yt.y,s:Yt.s,color:et.color,isLine:!0})}}for(let et of a){X.pairs++,v+=kt*Et,Q+=kt,V+=en;for(let F of et.cells){let Mt=`${F.y},${F.s}`;d.has(Mt)||d.set(Mt,{y:F.y,s:F.s,color:y[F.y][F.s],isLine:!1})}}let At=un(_,wt-1),be=un(C,ce),ge=Math.round(V*At*be),tt=0;wt>1&&(X.combos++,X.maxCombo=Math.max(X.maxCombo,wt),setTimeout(()=>pt(`COMBO \xD7${wt}`,"combo"),tt),tt+=180,h.play("combo2")),ce>0&&(X.cascades++,X.maxCascade=Math.max(X.maxCascade,ce),setTimeout(()=>pt(`CASCADE \xD7${ce}`,"cascade"),tt),tt+=180,h.play("cascade")),(t.length>0||a.length>0)&&h.play("combo");for(let et of t){let F=et.length,Mt=F*tn;setTimeout(()=>pt(`Line-${F} +${Mt}`,"line",et.color),tt),tt+=100}for(let et of a){let F=et.cells.length>0?y[et.cells[0].y][et.cells[0].s]:null;setTimeout(()=>pt(`Pair +${en}`,"pair",F),tt),tt+=100}ge>0&&(setTimeout(()=>pt(`+${ge}`,"score"),tt),tt+=120),Q>0&&(setTimeout(()=>pt(`+${Q}s`,"time"),tt),tt+=120);for(let[et,F]of Object.entries(ut))F>0&&(setTimeout(()=>pt(`+${F}${Oe(et)}`,"charge"),tt),tt+=120);Jt=Array.from(d.values()),Re=performance.now(),jt=!0,fe=!1,Xt=v,Vt=ge,rn()}function Ms(){for(let t of Jt)y[t.y][t.s]=0;Jt.length>0&&h.playRandom("disappear"),Xt>0&&(H=Math.max(0,H-Xt)),gt.addScore(Vt),bt+=Vt,Ve(),Jt=[],jt=!1,fe=!1,Xt=0,Vt=0,ce++,dn()}function dn(){Es();let{lineMatches:t,pairMatches:a}=Bs();if(t.length>0||a.length>0)Tn(t,a);else{let d=Rn();d.length>0?Ls(d):!m&&K==="playing"&&Bn()}}function Js(t,a){Tn(t,a)}function mn(t){return _e(t,i)}function $e(){return mn(Math.round(N))}function Ln(t,a){return bn(m,t,a,y,s,i)}function Fe(t){return Ln(t,$e())}let Ne=os;function An(){le&&(Dt!==0&&at>=Dt||(L=0,at+=1))}function xs(){if(!m)return;let t=m.cells,a=m.colors,d={cells:t,colors:a};if(I>=0||(d=Ne(d.cells,d.colors),d=Ne(d.cells,d.colors)),d=Ne(d.cells,d.colors),m.cells=d.cells,m.colors=d.colors,!Fe(Math.floor(E))){m.cells=t,m.colors=a;return}h.play("turn"),J&&An()}function vs(){return as(m,E,$e(),y,s,i)}function bs(){if(!m)return!1;let t=Math.floor(E)-1,a=!Fe(t);return a&&!J?(J=!0,L=0,at=0):!a&&J&&(J=!1,L=0,at=0),a}let Ue=Je;function Xe(){if(K==="playing"){Le.classList.add("hidden"),$t.classList.remove("hidden");return}if(Le.classList.remove("hidden"),$t.classList.add("hidden"),K==="intro"){O.classList.remove("hidden"),U.classList.add("hidden");let t=Math.floor(xt/60),a=xt%60;_t.textContent=`${t}:${a.toString().padStart(2,"0")}`;let d=M.loadHighscore();d.score>0?(Ct.textContent=d.score.toLocaleString(),ct.textContent=`(${Ue(d.time)})`):(Ct.textContent="0",ct.textContent=""),lt.textContent=`v${St}`,ie.classList.remove("idlePulse"),ie.offsetWidth,ie.classList.add("idlePulse")}else{O.classList.add("hidden"),U.classList.remove("hidden"),sn.textContent="Game Over";let t=`
        <div class="go-score">${bt.toLocaleString()}</div>
        <div class="go-time">\u23F1 ${Ue(Rt)}</div>
        <div class="intro-box" style="margin-top:12px">
          <div class="intro-box-title">Matches</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Line-3</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.lines3}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">Line-4</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.lines4}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">Line-5</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.lines5}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Pair</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.pairs}</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">Ring</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.rings}</span>
            </div>
          </div>
        </div>
        <div class="intro-box" style="margin-top:8px">
          <div class="intro-box-title">Bonuses</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots" style="color:#ffd84d;font-size:14px;font-weight:700">COMBO</span>
              <span class="rule-text">\xD7${X.combos}</span>
              <span class="rule-time" style="color:#ffd84d">${X.maxCombo>0?"max \xD7"+X.maxCombo:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#ff6b9d;font-size:14px;font-weight:700">CASCADE</span>
              <span class="rule-text">\xD7${X.cascades}</span>
              <span class="rule-time" style="color:#ff6b9d">${X.maxCascade>0?"max \xD7"+X.maxCascade:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#cfe0f3;font-size:14px">\u2726</span>
              <span class="rule-text">Magic</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${X.magicUsed}</span>
            </div>
          </div>
        </div>
        <div class="go-version">v${St}</div>
      `;on.innerHTML=t}}function Ve(){Ae.textContent=`Score: ${bt}`}function fn(){ke.textContent=`Time: ${Ue(Rt)}`}function Cs(){for(let t=0;t<s;t++)y[t].fill(0);H=0,N=mt=0,ft=0,gt.start(),bt=0,Ht=performance.now(),Rt=0,Te=0,Ee=0,K="playing",zt=null,rt.reset(),Jt=[],He=[],jt=!1,fe=!1,we=!1,Xt=0,Vt=0,ce=0,rn(),Ve(),fn(),Bn(),Sn.drawNextPreview(re,zt),Xe(),h.getSettings().musicEnabled&&h.startGameMusic()}function gn(){gt.gameOver(),K="gameover",m=null,J=!1,L=0,at=0;let t=M.saveHighscore(bt,Rt);h.stopMusic(),h.play("gameover"),setTimeout(()=>{(K==="gameover"||K==="intro")&&h.startMenuMusic()},2500),fn(),Xe(),t&&bt>0&&setTimeout(()=>{pt("\u{1F3C6} NEW RECORD!","score")},500)}function _s(t){for(let d=0;d<50;d++){let v=t.map(()=>1+(Math.random()*4|0));if(!Ts(t,v))return v}return t.map((d,v)=>1+v%4)}let Ts=us;function In(t){let a=t.cells.map(v=>({x:v.x,y:v.y})),d=_s(a);return{name:t.name,cells:a,colors:d}}function Bn(){if(!zt){let V=T[Math.random()*T.length|0];zt=In(V)}m=zt;let t=T[Math.random()*T.length|0];zt=In(t),Sn.drawNextPreview(re,zt);let a=1/0,d=-1/0;for(let V of m.cells)V.x<a&&(a=V.x),V.x>d&&(d=V.x);let v=(a+d)/2;for(let V of m.cells)V.x=V.x-Math.round(v);E=s+3,W=0,J=!1,L=0,at=0,Fe(Math.floor(E))?h.playRandom("appear"):gn()}function Rn(){return rs(y,s,i)}function Ls(t){if(t.length===0)return;let a=[];for(let wt of t)for(let At=0;At<i;At++)a.push({y:wt,s:At,color:y[wt][At],isLine:!1});He=t,Jt=a,Re=performance.now(),jt=!0,we=!0,fe=!1;let d=t.length;X.rings+=d;let v=un(se,d-1),V=Math.round(Qe*d*v),Q=ee*d;Vt=V,Xt=Q*Et,h.play("ring");let ut=`RING \xD7${d}`;pt(ut,"ring"),setTimeout(()=>pt(`+${V}`,"score"),150),setTimeout(()=>pt(`+${Q}s`,"time"),300)}function As(){let t=[...He].sort((a,d)=>d-a);for(let a of t){for(let d=a;d<s-1;d++)y[d].set(y[d+1]);y[s-1].fill(0)}Xt>0&&(H=Math.max(0,H-Xt)),gt.addScore(Vt),bt+=Vt,Ve(),Jt=[],He=[],jt=!1,we=!1,Xt=0,Vt=0,dn()}function js(){return Rn().length}function Is(){if(!m)return;let t=$e();N=t,mt=t,ft=0;let a=!1;for(let d=0;d<m.cells.length;d++){let v=m.cells[d],V=m.colors[d],Q=Math.floor(E)+v.y,ut=mn(t+v.x);Q>=s&&(a=!0),Q>=0&&Q<s&&(y[Q][ut]=V)}if(a){gn();return}gt.addScore(Bt),bt+=Bt,Ve(),pt(`+${Bt}`,"score"),h.playRandom("drop"),m=null,ce=0,Ss()}function Bs(){return ls(y,s,i)}function Rs(){if(!m)return!1;let t=Math.floor(E)-1;return Fe(t)?(E=t,J=!1,L=0,at=0,!0):(J=!0,!1)}n.addEventListener("pointerdown",t=>{if(j.state!=="playing")return;t.preventDefault?.(),$.handlePointerDown(t,{onMagicTap:(d,v)=>j.applyCommand("magic_shoot",{x:d,y:v}),onDoubleTap:()=>j.applyCommand("rotate_piece")},mt)||(ft=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(j.state!=="playing"||!$.dragging)return;t.preventDefault?.();let a=$.handlePointerMove(t,{canRotateTo:(d,v)=>j.canRotateTo(d,v),onDrop:()=>j.applyCommand("move_down"),onGroundedMove:()=>j.onGroundedMove()},j.pieceY,j.isGrounded);a&&j.setRotation(a.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{j.state==="playing"&&$.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{$.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{$.dragging&&$.handlePointerUp(t)},{passive:!1}),ot.addEventListener("click",()=>{j.state==="playing"&&j.applyCommand("rotate_piece")});let Ye=e.dropBtn,We=null;function ws(){j.state==="playing"&&(j.applyCommand("move_down"),We=setInterval(()=>{if(j.state!=="playing"){Ke();return}j.applyCommand("move_down")},Wt))}function Ke(){We&&(clearInterval(We),We=null)}Ye.addEventListener("pointerdown",t=>{t.preventDefault(),ws()}),Ye.addEventListener("pointerup",Ke),Ye.addEventListener("pointerleave",Ke),Ye.addEventListener("pointercancel",Ke);for(let[t,a]of Object.entries(Ut))a.addEventListener("click",()=>{j.state==="playing"&&j.applyCommand("select_magic",{element:t})});let pn=e.soundsToggle,hn=e.musicToggle;function ae(){let t=h.getSettings();t.soundsEnabled?pn.classList.add("active"):pn.classList.remove("active"),t.musicEnabled?hn.classList.add("active"):hn.classList.remove("active");for(let a=0;a<=4;a++){let d=e.soundVolBtns[a],v=e.musicVolBtns[a];d&&d.classList.toggle("active",t.soundVolume===a),v&&v.classList.toggle("active",t.musicVolume===a)}}let wn=e.tabBtns,Ps=e.tabContents;wn.forEach(t=>{t.addEventListener("click",()=>{let a=t.dataset.tab;wn.forEach(d=>d.classList.remove("active")),Ps.forEach(d=>d.classList.remove("active")),t.classList.add("active"),Jn(a).classList.add("active"),a==="sounds"&&ae()})});let Pn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,On=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Os=e.iosHint,Ds=e.standaloneBadge;function Dn(){let t=document.fullscreenElement||document.webkitFullscreenElement;B.textContent=t?"Disable":"Enable"}Pn&&(On?(Ds.style.display="block",B.style.display="none"):(Os.style.display="block",B.textContent="Not supported",B.style.opacity="0.5",B.style.cursor="default")),B.addEventListener("click",()=>{if(Pn&&!On)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Dn),document.addEventListener("webkitfullscreenchange",Dn);let ze=e.invertSwipeToggle;A.invertSwipe&&ze.classList.add("active"),ze.addEventListener("click",()=>{ze.classList.toggle("active");let t=ze.classList.contains("active");$.rotDir=t?-1:1,A.invertSwipe=t,M.saveGameSettings(A)});let kn=e.diffBtns;kn.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(kn.forEach(a=>{a.classList.remove("active");let d=a.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let a=document.createElement("span");a.className="check-icon",a.textContent="\u2713",t.appendChild(a)}})}),pn.addEventListener("click",()=>{let a=!h.getSettings().soundsEnabled;h.updateSettings({soundsEnabled:a}),ae()}),hn.addEventListener("click",()=>{let a=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:a}),ae(),a?j.state==="playing"?h.startGameMusic():h.startMenuMusic():a||h.stopMusic()});for(let t=0;t<=4;t++){let a=e.soundVolBtns[t];a&&a.addEventListener("click",()=>{h.updateSettings({soundVolume:t}),ae(),h.play("turn")})}for(let t=0;t<=4;t++){let a=e.musicVolBtns[t];a&&a.addEventListener("click",()=>{h.updateSettings({musicVolume:t}),ae()})}ae();function Gn(){K==="playing"&&(gt.pause(),Ee=performance.now(),K="paused",h.musicAudio&&h.musicAudio.pause())}function qe(){K==="paused"&&(gt.resume(),Te+=performance.now()-Ee,Ee=0,K="playing",Mn=performance.now(),h.getSettings().musicEnabled&&h.startGameMusic())}function yn(){let t=h.getSettings();xe.textContent=t.soundEnabled?"\u{1F50A}":"\u{1F507}",xe.classList.toggle("off",!t.soundEnabled),Ft.textContent=(t.musicEnabled,"\u{1F3B5}"),Ft.classList.toggle("off",!t.musicEnabled)}function ks(){qt.classList.remove("hidden"),$t.classList.add("hidden");let t=M.loadHighscore();Zt.textContent=t.score?t.score.toLocaleString():"0",cn.textContent=t.time?Je(t.time):"0:00",an.textContent=yt==="30_24"?"High Tower":"Quick Tower",Ge.textContent=bt.toLocaleString(),x.textContent=Je(Rt),G.textContent=yt==="30_24"?"High Tower":"Quick Tower",yn()}function Ze(){qt.classList.add("hidden"),$t.classList.remove("hidden")}$t.addEventListener("click",()=>{Gn(),ks()}),de.addEventListener("click",()=>{Ze(),qe()}),Se.addEventListener("click",()=>{Ze(),$t.classList.add("hidden"),K="intro",gt.reset(),h.stopMusic(),h.getSettings().musicEnabled&&h.startMenuMusic(),Xe()}),Me.addEventListener("click",()=>{P.classList.remove("hidden")}),xe.addEventListener("click",()=>{let t=h.getSettings();h.updateSettings({soundEnabled:!t.soundEnabled}),yn(),ae()}),Ft.addEventListener("click",()=>{let a=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:a}),yn(),ae()}),qt.addEventListener("click",t=>{t.target===qt&&(Ze(),qe())}),document.addEventListener("keydown",t=>{K==="paused"&&!qt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Ze(),qe())}),z.addEventListener("click",()=>{P.classList.add("hidden")}),P.addEventListener("click",t=>{t.target===P&&P.classList.add("hidden")});let En=!1;document.addEventListener("visibilitychange",()=>{document.hidden?K==="playing"&&(Gn(),En=!0):En&&K==="paused"&&(qe(),En=!1)});let j=ds({N:i,H:s,FALL_INTERVAL:R,LOCK_DELAY_SEC:nt,KILL_RATE:Et,MATCH_HIGHLIGHT_SEC:ne,MAGIC_SHRINK_SEC:vt,RING_HIGHLIGHT_SEC:he,getState:()=>({gameState:K,score:bt,elapsedMs:Rt,startTime:Ht,totalPausedMs:Te,stats:X,activePiece:m,pieceY:E,targetRot:mt,rotFloat:N,rotVel:ft,isGrounded:J,isHighlighting:jt,isMagicAnimation:fe,isRingAnimation:we,highlightStartTime:Re,killLevel:H,grid:y,fallTimer:W,lockTimer:L}),setState:t=>{"elapsedMs"in t&&(Rt=t.elapsedMs),"killLevel"in t&&(H=t.killLevel),"fallTimer"in t&&(W=t.fallTimer),"lockTimer"in t&&(L=t.lockTimer),"targetRot"in t&&(mt=t.targetRot),"rotFloat"in t&&(N=t.rotFloat),"rotVel"in t&&(ft=t.rotVel)},funcs:{startGame:Cs,endGame:gn,rotatePieceByDir:xs,tryMoveDown:Rs,canPlaceAtRot:Ln,maybeResetLockDelay:An,shootMagic:gs,selectMagic:me,updateGroundedState:bs,lockPiece:Is,finishHighlight:Ms,finishRingHighlight:As},ui:{updateTimeHud:fn}}),Sn=ms({canvas:n,canvasCtx:r,N:i,H:s,TOP_PAD_PX:l,BOTTOM_PAD_PX:g,MAX_RADIUS_X:p,RADIUS_X_FACTOR:f,ANG_OFFSET:o,MATCH_HIGHLIGHT_SEC:ne,MATCH_SHRINK_PHASE:pe,MAGIC_SHRINK_SEC:vt,RING_HIGHLIGHT_SEC:he,LOCK_DELAY_SEC:nt,KILL_RATE:Et,ELEMENT_COLORS:It,ELEMENT_TO_COLOR:Y,BLOCK_COLOR_FRONT:S,BLOCK_COLOR_BACK:q,ACTIVE_COLOR_FRONT:D,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:k,GHOST_STROKE_WIDTH:w,MAGIC_DIM_DOT_ALPHA:ye,MAGIC_DIM_DOT_SCALE:Pe,MAGIC_TARGET_DOT_SCALE:je,getState:()=>({gameState:K,grid:y,activePiece:m,pieceY:E,rotFloat:N,killLevel:H,isHighlighting:jt,highlightedCells:Jt,highlightStartTime:Re,isMagicAnimation:fe,isRingAnimation:we,isGrounded:J,lockTimer:L}),getVisualSettings:()=>({waterBubbles:Gt,waterColor:st}),funcs:{snappedRot:$e,computeGhostY:vs,normSector:mn,getMagicTargetColor:()=>rt.canUse()?Y[rt.active]:null}}),Mn=performance.now();function Hn(t){let a=Math.min(.05,Math.max(.001,(t-Mn)/1e3));Mn=t,j.update(a,t),N=mt,N>1e6&&(N%=i),N<-1e6&&(N%=i),Sn.render(a),requestAnimationFrame(Hn)}ie.addEventListener("click",()=>{j.applyCommand("start_game")}),it.addEventListener("click",()=>{j.applyCommand("start_game")}),Nt.forEach(t=>{t.addEventListener("click",()=>{Nt.forEach(a=>a.classList.remove("active")),t.classList.add("active"),yt=t.dataset.mode,ie.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ie.classList.add("idlePulse"),2e3)})}),Ie.addEventListener("click",()=>{let t=M.loadHighscore();t.score>0?alert(`Records (demo)

Best Score: ${t.score.toLocaleString()}
Time: ${Ue(t.time)}`):alert(`Records (demo)

No records yet. Play to set your first highscore!`)}),ln.addEventListener("click",()=>{P.classList.remove("hidden")}),Be.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),rn(),Xe(),h.startMenuMusic();let Gs=()=>{if(h.unlock(),!h.getSettings().musicEnabled)return;let t=h.musicAudio;!t||t.paused||t.ended?j.state==="playing"?h.startGameMusic():h.startMenuMusic():t.play().catch(a=>{console.debug("Music resume on interaction failed:",a)})},$n=0,Hs=10,$s=()=>{$n>=Hs||($n++,Gs())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,$s,{passive:!0})}),requestAnimationFrame(Hn)})();})();
