(()=>{var ps=[0,.25,.5,.75,1],hs=[0,.05,.15,.25,.5],ys={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},_n={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Cn="soundSettings";function Ms(){try{let e=localStorage.getItem(Cn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ss(e){try{localStorage.setItem(Cn,JSON.stringify(e))}catch(o){console.debug("Failed to save sound settings:",o)}}function Tn(){return{audioContext:null,buffers:{},settings:Ms(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let o=window.AudioContext||window.webkitAudioContext;this.audioContext=new o,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(o){console.debug("Failed to create AudioContext:",o)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(o){console.debug("Failed to resume AudioContext:",o)}if(!this.unlocked&&this.audioContext.state==="running"){let o=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=o,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ps[this.settings.soundVolume]},getMusicVolume(){return hs[this.settings.musicVolume]},async loadSound(o,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),n=await this.audioContext.decodeAudioData(i);this.buffers[o]=n}catch(u){console.debug(`Failed to load sound: ${o} from ${r}`,u)}},preload(){this.initContext();for(let[o,r]of Object.entries(ys))this.loadSound(o,r)},play(o,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=o;r!==null&&(u=`${o}${r}`);let i=this.buffers[u];if(i)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let s=this.audioContext.createBufferSource();s.buffer=i,s.connect(n),s.start(0),s.onended=()=>{s.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(o){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(o,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(_n.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(o){console.debug("Menu music start failed:",o)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(_n.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(o){console.debug("Game music start failed:",o)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(o){console.debug("Stop music failed:",o)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(o){if(this.settings={...this.settings,...o},Ss(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var An="eb_highscore",Ln="eb_settings",Es={invertSwipe:!1,difficulty:"easy"};function Rn(){return{loadHighscore(){try{let e=localStorage.getItem(An);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load highscore:",e)}return{score:0,time:0}},saveHighscore(e,o){try{let r=this.loadHighscore();if(e>r.score||e===r.score&&o>r.time)return localStorage.setItem(An,JSON.stringify({score:e,time:o})),!0}catch(r){console.debug("Failed to save highscore:",r)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Ln);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Es}},saveGameSettings(e){try{localStorage.setItem(Ln,JSON.stringify(e))}catch(o){console.debug("Failed to save game settings:",o)}}}}function In(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),settingsBtn:document.getElementById("settingsBtn"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function wn(e){return document.getElementById("tab-"+e)}var On={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Pn(e={}){let{elementColors:o={}}=e,r=0;return{showBonus(u,i="score",n=null){let s=document.createElement("div");s.className=`bonus-popup ${i}`,s.textContent=u,n&&o[n]&&(s.style.color=o[n]);let l=window.innerWidth/2,m=window.innerHeight/2-40,g=(Math.random()-.5)*200,f=(Math.random()-.5)*100+r*36;s.style.left=`${l+g}px`,s.style.top=`${m+f}px`,s.style.transform="translate(-50%, -50%)",document.body.appendChild(s),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{s.remove()},1800)},getElementIcon(u){return On[u]||"\u2726"},spawnMagicOrb(u,i,n,s){if(!s)return;let l=document.createElement("div");l.className=`magic-orb ${u}`,l.textContent=On[u]||"\u2726";let m=s.getBoundingClientRect(),g=m.left+m.width/2-i,f=m.top+m.height/2-n,M=Math.hypot(g,f),z=Math.atan2(f,g),k=M*.35*(Math.random()>.5?1:-1),J=z+Math.PI/2,O=g*.5+Math.cos(J)*k,V=f*.5+Math.sin(J)*k;l.style.setProperty("--mid-x",`${O}px`),l.style.setProperty("--mid-y",`${V}px`),l.style.setProperty("--end-x",`${g}px`),l.style.setProperty("--end-y",`${f}px`),l.style.left=`${i}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove(),s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))},700)}}}function Dn(e={}){let{buttons:o={},onActivate:r=null}=e,u={fire:3,water:3,lightning:3,earth:3},i=null;function n(){for(let[s,l]of Object.entries(o)){if(!l)continue;let m=u[s],g=l.querySelector(".charges");g&&(g.textContent=m),l.classList.toggle("empty",m<=0),l.classList.toggle("active",i===s&&m>0)}}return{get charges(){return u},get active(){return i},set active(s){i=s},select(s){if(u[s]<=0)return!1;let l=i===s;return i=l?null:s,n(),!l&&i===s&&r&&r(),!l},useCharge(){return!i||u[i]<=0?!1:(u[i]--,i=null,n(),!0)},addCharges(s,l){u[s]!==void 0&&(u[s]+=l,n())},canUse(){return i!==null&&u[i]>0},deactivate(){i=null,n()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,i=null,n()},updateButtons:n,initButtons(s){for(let[l,m]of Object.entries(o))m&&m.addEventListener("click",()=>{s&&s(l)})}}}var xs={PX_PER_STEP:16,DEADZONE_PX:2,PX_PER_DROP:18,AXIS_DOMINANCE:1.1,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:400,DROP_SWIPE_MIN_DISTANCE:12,DOUBLE_TAP_MS:280,DOUBLE_TAP_MAX_DIST:18};function Bn(e={}){let{canvas:o}=e,r=e.rotDir||1,u=!1,i=0,n=0,s=0,l=0,m=0,g=1,f=null,M=0,z=0,k=0,J=0,O=0,V=0,Mt=0,Gt=0,K=xs;return{get rotDir(){return r},set rotDir($){r=$},get dragging(){return u},get dragMode(){return f},handlePointerDown($,ot,se){if(ot.onMagicTap&&ot.onMagicTap($.clientX,$.clientY))return!0;let kt=performance.now(),Vt=kt-V,bt=$.clientX-Mt,_t=$.clientY-Gt,Yt=Math.hypot(bt,_t);return Vt<=K.DOUBLE_TAP_MS&&Yt<=K.DOUBLE_TAP_MAX_DIST?(ot.onDoubleTap&&ot.onDoubleTap(),V=0):(V=kt,Mt=$.clientX,Gt=$.clientY),u=!0,g=-1,i=$.clientX,n=$.clientY,s=se,l=0,m=0,f=null,M=kt,z=$.clientX,k=$.clientY,J=M,O=0,o&&o.setPointerCapture($.pointerId),!1},handlePointerMove($,ot,se,kt){if(!u)return null;let Vt=$.clientX-i,bt=$.clientY-n,_t=performance.now();if(Math.abs(Vt)<K.DEADZONE_PX&&Math.abs(bt)<K.DEADZONE_PX)return null;if(!f){let pt=Math.abs(Vt),c=Math.abs(bt);if(bt<0)pt>=K.DEADZONE_PX&&(f="rotate");else if(c>=pt*K.AXIS_DOMINANCE){if(c>=K.DROP_SWIPE_MIN_DISTANCE){let It=Math.max(1,_t-M);c/It*1e3>=K.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else pt>=c*K.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let Yt=null;if(f==="rotate"&&Math.abs(Vt)>=K.DEADZONE_PX){let pt=Math.max(1,_t-J),c=$.clientX-z,It=Math.max(1,Math.abs(c)/pt*1e3),St=Math.max(K.MIN_ROT_PX,Math.min(K.MAX_ROT_PX,K.PX_PER_STEP*(K.SWIPE_SPEED_REF/It)));O+=-c/St*r*g;let At=Math.trunc(O);At!==0&&(O-=At);let wt=l+At;if(wt!==l&&ot.canRotateTo){let Wt=Math.sign(wt-l),Et=s+l;for(;l!==wt;){let te=l+Wt,$t=s+te;if(!ot.canRotateTo(Math.floor(se),$t))break;l=te,Et=$t,kt&&ot.onGroundedMove&&ot.onGroundedMove()}Yt={targetRot:Et,rotFloat:Et}}}if(f==="drop"&&bt>K.DEADZONE_PX&&ot.onDrop){let pt=Math.max(1,_t-J),c=$.clientY-k,It=Math.max(1,c/pt*1e3),St=Math.max(K.MIN_DROP_PX,Math.min(K.MAX_DROP_PX,K.PX_PER_DROP*(K.SWIPE_SPEED_REF/It))),At=Math.trunc(bt/St);if(At>m){let wt=At-m;for(let Wt=0;Wt<wt;Wt++)ot.onDrop();m=At}}return z=$.clientX,k=$.clientY,J=_t,Yt},handlePointerUp($){u&&(u=!1,o&&o.releasePointerCapture($.pointerId))},reset(){u=!1,f=null,l=0,m=0,O=0}}}var Qe={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Gn(){let e="intro",o=0,r=0,u=0,i=0,n=0,s={...Qe};return{get state(){return e},get score(){return o},get elapsedMs(){return u},get startTime(){return r},get stats(){return s},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",o=0,r=performance.now(),u=0,i=0,n=0,s={...Qe}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(n+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(l){o+=l},setScore(l){o=l},updateTime(){e==="playing"&&r>0&&(u=performance.now()-r-n)},getFormattedTime(){let l=Math.floor(u/1e3),m=Math.floor(l/60),g=l%60;return`${m}:${g.toString().padStart(2,"0")}`},incrementStat(l,m=1){l in s&&(s[l]+=m)},updateMaxStat(l,m){l in s&&m>s[l]&&(s[l]=m)},reset(){e="intro",o=0,r=0,u=0,i=0,n=0,s={...Qe}}}}function Se(e,o){return e%=o,e<0&&(e+=o),e}function kn(e,o){return e[Math.min(o,e.length-1)]}function $n(e){let o=Math.max(0,Math.floor(e/1e3)),r=Math.floor(o/60),u=o%60;return`${r}:${u.toString().padStart(2,"0")}`}function Hn(e,o){let r=e.map(({x:l,y:m},g)=>({x:m,y:-l,color:o[g]})),u=1/0,i=-1/0,n=1/0;for(let l of r)u=Math.min(u,l.x),i=Math.max(i,l.x),n=Math.min(n,l.y);let s=Math.round((u+i)/2);for(let l of r)l.x-=s,l.y-=n;return r.sort((l,m)=>l.y-m.y||l.x-m.x),{cells:r.map(l=>({x:l.x,y:l.y})),colors:r.map(l=>l.color)}}function tn(e,o,r,u){let i=[];return e+1<r&&i.push({y:e+1,s:o}),e-1>=0&&i.push({y:e-1,s:o}),i.push({y:e,s:Se(o-1,u)}),i.push({y:e,s:Se(o+1,u)}),i}function Fn(e,o,r){let u=Array.from({length:o},()=>new Uint8Array(r)),i=[];for(let n=0;n<o;n++)for(let s=0;s<r;s++){if(!e[n][s]||u[n][s])continue;let l=[],m=[{y:n,s}];for(u[n][s]=1;m.length>0;){let g=m.shift();l.push(g);for(let f of tn(g.y,g.s,o,r))e[f.y][f.s]&&!u[f.y][f.s]&&(u[f.y][f.s]=1,m.push(f))}i.push(l)}return i}function Nn(e){return e.some(o=>o.y===0)}function en(e,o,r,u,i,n){if(!e)return!1;let s=Se(r,n);for(let l of e.cells){let m=o+l.y,g=Se(s+l.x,n);if(m<0)return!1;if(!(m>=i)&&u[m][g])return!1}return!0}function Un(e,o,r,u,i,n){if(!e)return null;let s=Math.floor(o);for(;en(e,s-1,r,u,i,n);)s-=1;return s}function Xn(e,o,r){let u=[],i=[];for(let n=0;n<o;n++){let s=[],l=0,m=e[n][0],g=m?1:0;for(let f=1;f<=r;f++){let M=f<r?e[n][f]:0;M&&M===m?g++:(g>=1&&m&&s.push({start:l,length:g,color:m}),l=f,m=M,g=M?1:0)}if(s.length>=2){let f=s[0],M=s[s.length-1];if(f.start===0&&M.start+M.length===r&&f.color===M.color){let z=f.length+M.length;s[0]={start:M.start,length:z,color:f.color},s.pop()}}for(let f of s)if(f.length>=3){let M=[];for(let z=0;z<f.length;z++)M.push({y:n,s:(f.start+z)%r});u.push({color:f.color,length:f.length,cells:M})}}for(let n=0;n<r;n++){let s=0,l=e[0][n],m=l?1:0;for(let g=1;g<=o;g++){let f=g<o?e[g][n]:0;if(f&&f===l)m++;else{if(m>=3&&l){let M=[];for(let z=0;z<m;z++)M.push({y:s+z,s:n});u.push({color:l,length:m,cells:M})}s=g,l=f,m=f?1:0}}}for(let n=0;n<o;n++)for(let s=0;s<r;s++){let l=e[n][s],m=e[n][(s+1)%r],g=e[n][(s+2)%r],f=e[n][(s+3)%r];l&&l===m&&g&&g===f&&l!==g&&i.push({cells:[{y:n,s},{y:n,s:(s+1)%r},{y:n,s:(s+2)%r},{y:n,s:(s+3)%r}]})}for(let n=0;n<r;n++)for(let s=0;s<o-3;s++){let l=e[s][n],m=e[s+1][n],g=e[s+2][n],f=e[s+3][n];l&&l===m&&g&&g===f&&l!==g&&i.push({cells:[{y:s,s:n},{y:s+1,s:n},{y:s+2,s:n},{y:s+3,s:n}]})}return{lineMatches:u,pairMatches:i}}function Vn(e,o,r){let u=[];for(let i=0;i<o;i++){let n=!0;for(let s=0;s<r;s++)if(!e[i][s]){n=!1;break}n&&u.push(i)}return u}function Yn(e,o){let r=new Map;e.forEach((u,i)=>r.set(`${u.x},${u.y}`,o[i]));for(let u=0;u<e.length;u++){let i=e[u],n=o[u],s=1;for(let V=1;V<=2&&r.get(`${i.x+V},${i.y}`)===n;V++)s++;if(s>=3)return!0;let l=1;for(let V=1;V<=2&&r.get(`${i.x},${i.y+V}`)===n;V++)l++;if(l>=3)return!0;let m=n,g=r.get(`${i.x+1},${i.y}`),f=r.get(`${i.x+2},${i.y}`),M=r.get(`${i.x+3},${i.y}`);if(m&&g&&f&&M&&m===g&&f===M&&m!==f)return!0;let z=n,k=r.get(`${i.x},${i.y+1}`),J=r.get(`${i.x},${i.y+2}`),O=r.get(`${i.x},${i.y+3}`);if(z&&k&&J&&O&&z===k&&J===O&&z!==J)return!0}return!1}function Wn(e){let{N:o,H:r,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,KILL_RATE:n,MATCH_HIGHLIGHT_SEC:s,MAGIC_SHRINK_SEC:l,RING_HIGHLIGHT_SEC:m,getState:g,setState:f,funcs:M,ui:z}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(k,J={}){let O=g();if(k==="start_game")return O.gameState!=="playing"?(M.startGame(),!0):!1;if(O.gameState!=="playing")return!1;switch(k){case"rotate_piece":return M.rotatePieceByDir(),!0;case"move_down":return M.tryMoveDown();case"rotate_cylinder":{let{rot:V}=J;return typeof V=="number"&&M.canPlaceAtRot(Math.floor(O.pieceY),V)?(f({targetRot:V,rotFloat:V,rotVel:0}),O.isGrounded&&M.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:V,y:Mt}=J;return M.shootMagic(V,Mt)}case"select_magic":{let{element:V}=J;return M.selectMagic(V),!0}default:return console.warn("GameEngine: unknown command",k),!1}},update(k,J){let O=g();if(O.gameState!=="playing")return;let V=J-O.startTime-O.totalPausedMs;f({elapsedMs:V}),z.updateTimeHud();let Mt=O.killLevel+n*k;if(f({killLevel:Mt}),Mt>=r){M.endGame();return}if(O.isHighlighting){let $=(J-O.highlightStartTime)/1e3,ot;O.isRingAnimation?ot=m:O.isMagicAnimation?ot=l:ot=s,$>=ot&&(O.isRingAnimation?M.finishRingHighlight():M.finishHighlight())}let Gt=O.fallTimer+k;if(Gt>=u&&(Gt-=u,M.tryMoveDown()),f({fallTimer:Gt}),M.updateGroundedState()){let $=O.lockTimer+k;f({lockTimer:$}),$>=i&&M.lockPiece()}},reset(){M.startGame()},canRotateTo(k,J){return M.canPlaceAtRot(k,J)},getRotation(){let k=g();return{targetRot:k.targetRot,rotFloat:k.rotFloat,rotVel:k.rotVel}},setRotation(k){f({targetRot:k,rotFloat:k,rotVel:0})},onGroundedMove(){M.maybeResetLockDelay()}}}var Bt=Math.PI*2;function Kn(e){let{canvas:o,canvasCtx:r,N:u,H:i,TOP_PAD_PX:n,BOTTOM_PAD_PX:s,MAX_RADIUS_X:l,RADIUS_X_FACTOR:m,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:f,MATCH_SHRINK_PHASE:M,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:k,LOCK_DELAY_SEC:J,ELEMENT_COLORS:O,ELEMENT_TO_COLOR:V,BLOCK_COLOR_FRONT:Mt,BLOCK_COLOR_BACK:Gt,ACTIVE_COLOR_FRONT:K,GHOST_COLOR_FILL:$,GHOST_COLOR_STROKE:ot,GHOST_STROKE_WIDTH:se,MAGIC_DIM_DOT_ALPHA:kt,MAGIC_DIM_DOT_SCALE:Vt,MAGIC_TARGET_DOT_SCALE:bt,getState:_t,getVisualSettings:Yt,funcs:pt}=e,c=r,It={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},St=[],At=15;function wt(v,S,b,T,A){for(St=St.filter(h=>h.y>v+h.size);St.length<At;){let h=Math.random()>.5?"left":"right",E=10,C=h==="left"?E+Math.random()*(S-E*2):b+E+Math.random()*(A-b-E*2);St.push({x:C,y:T+Math.random()*50,size:1.5+Math.random()*3,speed:.05+Math.random()*.1,wobble:Math.random()*Math.PI*2,wobbleSpeed:.01+Math.random()*.015,side:h,minX:h==="left"?E:b+E,maxX:h==="left"?S-E:A-E})}for(let h of St)h.y-=h.speed,h.wobble+=h.wobbleSpeed,h.x+=Math.sin(h.wobble)*.2,h.x=Math.max(h.minX,Math.min(h.maxX,h.x))}function Wt(v){c.fillStyle="rgba(255, 255, 255, 0.25)",c.strokeStyle="rgba(255, 255, 255, 0.4)",c.lineWidth=1;for(let S of St)S.y<v+S.size||(c.beginPath(),c.arc(S.x,S.y,S.size,0,Math.PI*2),c.fill(),c.stroke())}function Et(v,S,b){let T=1-b/i;return v+T*S}function te(v){return v=v%u,v<0?v+u:v}function $t(v,S,b,T,A,h){let E=te(h),C=(A-E)/u*Bt+g;return{x:v+Math.cos(C)*b,y:S+Math.sin(C)*T,ang:C}}let Ee=.52,ke=1.02;function Kt(v,S,b,T,A,h){let E=te(h),C=(A-E)/u*Bt+g;return{x:v+Math.cos(C)*b,y:S+Math.sin(C)*T,ang:C}}function $e(v,S,b,T,A,h,E,C=1){let p=Kt(v,S,b,T,A-Ee,h),q=Kt(v,S,b,T,A+Ee,h),_={x:p.x,y:p.y-E*.5},B={x:p.x,y:p.y+E*.5},ht={x:q.x,y:q.y-E*.5},nt={x:q.x,y:q.y+E*.5},H=(_.x+ht.x+nt.x+B.x)*.25,st=(_.y+ht.y+nt.y+B.y)*.25,ct=ke*C,I=C,dt=[_,ht,nt,B].map(lt=>({x:H+(lt.x-H)*ct,y:st+(lt.y-st)*I})),mt=Math.abs((q.x-p.x)*ct),Y=Math.abs(E*I);return{corners:dt,cx:H,cy:st,wApprox:mt,hApprox:Y,ang:Kt(v,S,b,T,A,h).ang}}function Ht(v,S,b,T,A,h,E,C,p=1,q=null,_=1,B=null,ht=0,nt=1,H=1){let st=$e(v,S,b,T,A,h,E,H),[ct,I,dt,mt]=st.corners;if(c.save(),c.globalAlpha=p,c.fillStyle=C,c.beginPath(),c.moveTo(ct.x,ct.y),c.lineTo(I.x,I.y),c.lineTo(dt.x,dt.y),c.lineTo(mt.x,mt.y),c.closePath(),c.fill(),B&&ht>0&&(c.strokeStyle=B,c.lineWidth=ht,c.stroke()),q){let Y=Math.min(st.wApprox,st.hApprox)*.28*nt;c.globalAlpha=p*_,c.fillStyle=q,c.beginPath(),c.arc(st.cx,st.cy,Y,0,Bt),c.fill()}c.restore(),c.globalAlpha=1}function nn(v,S,b,T,A,h){let E=$t(v,S,b,T,A,h),C=$t(v,S,b,T,A+1,h),p=$t(v,S,b,T,A-1,h),q=Math.abs(C.x-E.x),_=Math.abs(E.x-p.x),B=(q+_)*.5*1.06;return Math.max(1,B)}function sn(v,S,b,T,A,h){let E=(A-h)/u*Bt+g;return{x:v+Math.cos(E)*b,y:S+Math.sin(E)*T,ang:E}}function He(v,S,b,T,A,h,E,C=1,p=null,q=1,_=null,B=0,ht=1){c.save(),c.translate(v,S);let nt=Math.atan2(T,b);if(c.rotate(nt),c.globalAlpha=C,c.fillStyle=E,c.fillRect(-A/2,-h/2,A,h),_&&B>0&&(c.strokeStyle=_,c.lineWidth=B,c.strokeRect(-A/2,-h/2,A,h)),p){let H=Math.min(A,h)*.28*ht;c.globalAlpha=C*q,c.fillStyle=p,c.beginPath(),c.arc(0,0,H,0,Bt),c.fill()}c.restore(),c.globalAlpha=1}return{resize(){let v=Math.max(1,Math.min(2,window.devicePixelRatio||1)),S=Math.floor(o.clientWidth*v),b=Math.floor(o.clientHeight*v);(o.width!==S||o.height!==b)&&(o.width=S,o.height=b,c.setTransform(v,0,0,v,0,0))},render(){this.resize();let v=_t(),S=o.clientWidth,b=o.clientHeight;c.clearRect(0,0,S,b),c.fillStyle="#0b0f14",c.fillRect(0,0,S,b);let T=S*.5,A=n,h=b-s,E=Math.max(1,h-A),C=Math.min(S*m,l),p=C*.28,{killLevel:q,rotFloat:_,grid:B,gameState:ht}=v,nt=Yt?Yt():{},H=nt.waterColor||"blue",st=nt.waterBubbles||!1,ct=It[H]||It.blue,I=Et(A,E,q),dt=.7,mt=q/i,Y={...ct.top},lt={...ct.bottom};if(mt>dt){let x=(mt-dt)/(1-dt);Y.r=Math.round(Y.r+(255-Y.r)*x*.5),Y.g=Math.round(Y.g+(150-Y.g)*x*.5),Y.b=Math.round(Y.b+(150-Y.b)*x*.5),lt.r=Math.round(lt.r+(180-lt.r)*x),lt.g=Math.round(lt.g*(1-x*.6)),lt.b=Math.round(lt.b*(1-x*.6))}let zt=T-C-8,Ft=T+C+8,L=A,gt=h+5,ft=c.createLinearGradient(0,I,0,b);ft.addColorStop(0,`rgba(${Y.r},${Y.g},${Y.b},0.5)`),ft.addColorStop(1,`rgba(${lt.r},${lt.g},${lt.b},0.7)`),c.fillStyle=ft;let Ot=Math.round((Y.r+lt.r)/2),_e=Math.round((Y.g+lt.g)/2),ee=Math.round((Y.b+lt.b)/2),re=C+8,ue=p+4;c.fillRect(0,I,zt,b-I),c.fillRect(Ft,I,S-Ft,b-I),c.beginPath();let Nt=Math.max(I,gt);c.moveTo(zt,Nt),I<=gt+ue?c.ellipse(T,gt,re,ue,0,Math.PI,0,!1):c.lineTo(Ft,Nt),c.lineTo(Ft,b),c.lineTo(zt,b),c.closePath(),c.fill(),c.strokeStyle="rgba(100,180,255,0.6)",c.lineWidth=3,c.lineCap="round",c.beginPath(),c.moveTo(zt,L),c.lineTo(zt,gt),c.stroke(),c.beginPath(),c.moveTo(Ft,L),c.lineTo(Ft,gt),c.stroke(),c.beginPath(),c.ellipse(T,gt,C+8,p+4,0,0,Math.PI),c.stroke(),c.fillStyle="#0b0f14",c.beginPath(),c.ellipse(T,gt,C+8,p+4,0,0,Bt),c.fill(),q>.5&&(c.strokeStyle=`rgba(${Math.min(255,Ot+60)},${Math.min(255,_e+40)},${Math.min(255,ee+40)},0.6)`,c.lineWidth=2,c.beginPath(),c.moveTo(0,I),c.lineTo(zt,I),c.moveTo(Ft,I),c.lineTo(S,I),c.stroke()),st&&q>.5&&(wt(I,zt,Ft,b,S),Wt(I)),c.strokeStyle="rgba(160,190,220,0.3)",c.lineWidth=1;let N=Bt*C,xe=10,oe=N/xe*.7,yt=N/xe*.3;c.setLineDash([oe,yt]);let Fe=N/u;c.lineDashOffset=te(_)*Fe;for(let x=0;x<=i;x++){let G=Et(A,E,x);c.beginPath(),c.ellipse(T,G,C,p,0,0,Bt),c.stroke()}c.setLineDash([]);let de=[],fe=[];for(let x=0;x<i;x++){let G=Et(A,E,x+.5);for(let P=0;P<u;P++){let F=B[x][P];if(!F)continue;let R=$t(T,G,C,p,P,_),Z=Math.sin(R.ang),D={y:x,s:P,yScr:G,p:R,depth:Z,color:F};Z<-.1?de.push(D):fe.push(D)}}let me=pt.getMagicTargetColor(),{isHighlighting:Ce,highlightedCells:ne,highlightStartTime:ve,isMagicAnimation:ie}=v,ge=null,pe=1,Ut=1,Te=!1;if(Ce&&ne.length>0){ge=new Set(ne.map(G=>`${G.y},${G.s}`));let x=(performance.now()-ve)/1e3;if(ie){let G=Math.min(1,x/z);pe=1-G*.85,Ut=1-G*.9,Te=!0}else{let G=Math.min(1,x/f),P=1-M;if(G>P){let F=(G-P)/M;pe=1-F*.85,Ut=1-F*.9,Te=!0}}}de.sort((x,G)=>x.depth-G.depth);for(let x of de){let G=E/i*.9,P=O[x.color]||null,F=.35,R=1,Z=`${x.y},${x.s}`;ge&&ge.has(Z)&&(F*=Ut,R=pe),Ht(T,x.yScr,C,p,x.s,_,G,Gt,F,P,.5,null,0,1,R)}let{isRingAnimation:Ct}=v;if(Ce&&ne.length>0&&!ie){let x=(performance.now()-ve)/1e3,P=Math.min(1,x/(Ct?k:f)),F=1-M,R=P>F,Z=R?(P-F)/M:0,D=Ct?Math.floor(P*F*u*2)%u:-1,w=4+P/F*10,X=Math.sin(x*w*Bt),at=R?1:.3+X*.3,it=R?1-Z*.8:1,xt=R?1-Z:1;for(let rt of ne){let Zt=Et(A,E,rt.y+.5),be=Kt(T,Zt,C,p,rt.s,_);if(Math.sin(be.ang)>=-.1)continue;let Le=E/i*.9,Tt,Jt,jt;if(Ct){let ce=(rt.s-D+u)%u,le=ce<3?1-ce/3:0;Tt=(R?xt:.2+le*.5)*.5,Jt=`rgba(255, 159, 67, ${Tt})`,jt=R?it:1+le*.15}else Tt=at*xt,Jt=rt.isLine?`rgba(255, 255, 255, ${Tt*.5})`:`rgba(255, 220, 100, ${Tt*.4})`,jt=R?it:1.1;Ht(T,Zt,C,p,rt.s,_,Le,Jt,1,null,1,null,0,1,jt)}}fe.sort((x,G)=>x.depth-G.depth);for(let x of fe){let G=E/i*.9,P=O[x.color]||null,F=1,R=1,Z=1,D=1,w=`${x.y},${x.s}`,X=ge&&ge.has(w);X&&(F=Ut,R=pe),me!==null&&!X&&(x.color!==me?(Z=kt,D=Vt):D=bt),Ht(T,x.yScr,C,p,x.s,_,G,Mt,F,P,Z,null,0,D,R)}if(Ce&&ne.length>0&&!ie){let x=(performance.now()-ve)/1e3,P=Math.min(1,x/(Ct?k:f)),F=1-M,R=P>F,Z=R?(P-F)/M:0,D=Ct?Math.floor(P*F*u*2)%u:-1,w=4+P/F*10,X=Math.sin(x*w*Bt),at=R?1:.5+X*.5,it=R?1-Z*.8:1,xt=R?1-Z:1;for(let rt of ne){let Zt=Et(A,E,rt.y+.5),be=Kt(T,Zt,C,p,rt.s,_);if(Math.sin(be.ang)<-.1)continue;let Le=E/i*.9,Tt,Jt,jt;if(Ct){let ce=(rt.s-D+u)%u,le=ce<4?1-ce/4:0;Tt=R?xt:.3+le*.7,Jt=`rgba(255, 159, 67, ${Tt})`,jt=R?it:1+le*.2}else Tt=at*xt,Jt=rt.isLine?`rgba(255, 255, 255, ${Tt*.7})`:`rgba(255, 220, 100, ${Tt*.6})`,jt=R?it:1.15;Ht(T,Zt,C,p,rt.s,_,Le,Jt,1,null,1,null,0,1,jt)}}let{activePiece:qt,pieceY:Lt,isGrounded:Ae,lockTimer:Ne}=v;if(qt){let x=pt.snappedRot(),G=x,P=pt.computeGhostY(),F=E/i*.9;if(P!==null){let D=[];for(let w=0;w<qt.cells.length;w++){let X=qt.cells[w],at=qt.colors[w],it=P+X.y,xt=pt.normSector(x+X.x);if(it<0||it>=i)continue;let rt=Et(A,E,it+.5),Zt=Kt(T,rt,C,p,xt,G);D.push({cy:it,cs:xt,yScr:rt,depth:Math.sin(Zt.ang),color:at})}D.sort((w,X)=>w.depth-X.depth);for(let w of D){let X=O[w.color]||null;Ht(T,w.yScr,C,p,w.cs,G,F,$,1,X,.5,ot,se,1,1)}}let R=K;if(Ae&&Ne>0){let D=Math.min(1,Ne/J),w=255,X=Math.round(170+85*D),at=Math.round(180+75*D),it=.75+(1-.75)*D;R=`rgba(${w},${X},${at},${it})`}let Z=[];for(let D=0;D<qt.cells.length;D++){let w=qt.cells[D],X=qt.colors[D],at=pt.normSector(x+w.x),it=Lt+w.y;if(it<0||it>=i)continue;let xt=Et(A,E,it+.5),rt=Kt(T,xt,C,p,at,G);Z.push({cs:at,yScr:xt,depth:Math.sin(rt.ang),color:X})}Z.sort((D,w)=>D.depth-w.depth);for(let D of Z){let w=O[D.color]||null;Ht(T,D.yScr,C,p,D.cs,G,F,R,1,w,1,null,0,1,1)}}},drawNextPreview(v,S){if(!v)return;let b=v.getContext("2d"),T=v.width,A=v.height;if(b.clearRect(0,0,T,A),!S)return;let h=1/0,E=-1/0,C=1/0,p=-1/0;for(let H of S.cells)h=Math.min(h,H.x),E=Math.max(E,H.x),C=Math.min(C,H.y),p=Math.max(p,H.y);let q=E-h+1,_=p-C+1,B=Math.min(T/(q+.5),A/(_+.5)),ht=(T-q*B)/2,nt=(A-_*B)/2;b.fillStyle=Mt;for(let H=0;H<S.cells.length;H++){let st=S.cells[H],ct=ht+(st.x-h)*B,I=nt+(_-1-(st.y-C))*B;b.fillRect(ct+1,I+1,B-2,B-2);let dt=S.colors[H],mt=O[dt];if(mt){let Y=(B-2)*.32;b.fillStyle=mt,b.beginPath(),b.arc(ct+B/2,I+B/2,Y,0,Bt),b.fill(),b.fillStyle=Mt}}}}}(()=>{let e=In(),o=e.canvas,r=o.getContext("2d");o.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,n=24,s=Math.PI/2,l=18,m=90,g=260,f=.36,M="rgb(235,240,250)",z="rgb(55,62,75)",k="rgba(255,170,180,0.75)",J="rgba(110,255,150,0.15)",O="rgba(110,255,150,0.85)",V=2,Mt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Gt={1:"fire",2:"water",3:"lightning",4:"earth"},K={fire:1,water:2,lightning:3,earth:4},$=1,ot=.58,se=!0,kt=12,Vt=25,bt=120,_t=n/bt,Yt=1,pt=2,c=3,It=5,St=8,At=10,wt=15,Wt=30,Et=2,te=.3,$t=.5,Ee=1,ke=.3,Kt=.5,$e=1.3,Ht=10,nn=500,sn=[1,1.25,1.5,1.75,2],He=10,v=100,S=25,b=[1,1.3,1.6,2],T=[1,1.5,2,2.5],A=Rn(),h=A.loadGameSettings(),E=h.invertSwipe?-1:1,C=-1,p=Array.from({length:n},()=>new Uint8Array(i)),q=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],_=null,B=n+3,ht=0,nt=0,H=!1,st=0,ct=0,I=0,dt=0,mt=0,Y=Bn({canvas:o,rotDir:E}),lt="0.12.2",zt=!0,Ft="blue",L=Tn();L.preload();let gt=Gn(),ft="intro",Ot=0,_e=0,ee=0,re=0,ue=0,Nt=null,N=gt.stats,xe=e.overlay,oe=Pn({elementColors:Mt}),yt=oe.showBonus.bind(oe),Fe=oe.getElementIcon.bind(oe),de=e.overlayTitle,fe=e.overlayStats,me=e.startBtn,Ce=e.hud,ne=e.scoreHud,ve=e.timeHud,ie=e.nextCanvas,ge=ie.getContext("2d"),pe=e.settingsBtn,Ut=e.settingsOverlay,Te=e.settingsClose,Ct=e.fullscreenBtn,qt=e.rotateBtn,Lt=Dn({buttons:e.magicBtns,onActivate:()=>L.play("spells")}),Ae=e.magicBtns,Ne=Lt.charges,x=t=>Lt.select(t),G=()=>Lt.updateButtons(),P=[],F=0,R=!1,Z=!1,D=!1,w=0,X=0,at=0,it=[];function xt(t,a,d){let y=1-d/n;return t+y*a}function rt(t,a,d,y,W,j){let ut=(W-j)/i*u+s;return{x:t+Math.cos(ut)*d,y:a+Math.sin(ut)*y,ang:ut}}function Zt(t,a){let d=o.clientWidth,y=o.clientHeight,W=d*.5,j=l,ut=y-m,Pt=Math.max(1,ut-j),Rt=Math.min(d*f,g),ye=Rt*.28,ae=xt(j,Pt,t+.5),Q=rt(W,ae,Rt,ye,a,I);return{x:Q.x,y:Q.y}}function be(t,a){if(!Lt.canUse()||R)return!1;let d=K[Lt.active],y=o.clientWidth,W=o.clientHeight,j=y*.5,ut=l,Pt=W-m,Rt=Math.max(1,Pt-ut),ye=Math.min(y*f,g),ae=ye*.28,Q=null,et=1/0;for(let U=0;U<n;U++){let vt=xt(ut,Rt,U+.5);for(let Dt=0;Dt<i;Dt++){let Xt=p[U][Dt];if(!Xt||Xt!==d)continue;let Qt=rt(j,vt,ye,ae,Dt,I);if(Math.sin(Qt.ang)<-.1)continue;let Me=t-Qt.x,xn=a-Qt.y,vn=Math.hypot(Me,xn),bn=Rt/n*.9,gs=bn*1.2;Math.abs(Me)<gs/2&&Math.abs(xn)<bn/2&&vn<et&&(et=vn,Q={y:U,s:Dt})}}if(Q){let U=p[Q.y][Q.s];return P=[{y:Q.y,s:Q.s,color:U,isLine:!1,isMagic:!0}],F=performance.now(),R=!0,Z=!0,w=0,X=S,yt(`+${S}`,"score"),at=0,Lt.useCharge(),N.magicUsed++,!0}return!1}let on=100;function Le(t,a){return tn(t,a,n,i)}function Tt(){return Fn(p,n,i)}let Jt=Nn;function jt(t){let a=t.map(y=>({...y,color:p[y.y][y.s]}));for(let y of t)p[y.y][y.s]=0;let d=n;for(let y of t){let W=y.y;for(let j=1;j<=y.y;j++){let ut=y.y-j;if(p[ut][y.s]){W=j-1;break}}d=Math.min(d,W)}for(let y of a)p[y.y-d][y.s]=y.color;return d>0}function ce(){let t=!0;for(;t;){t=!1;let a=Tt();for(let d of a)Jt(d)||jt(d)&&(t=!0)}}function le(){Xe()}let Ue=kn;function cn(t,a){let d=new Map,y=0,W=0,j=0,ut={},Pt=t.length+a.length;for(let et of t){let U=Gt[et.color],vt=0,Dt=0;if(et.length>=5?(vt=c,Dt=At,N.lines5++):et.length===4?(vt=pt,Dt=St,N.lines4++):et.length===3&&(vt=Yt,Dt=It,N.lines3++),U&&vt>0){Lt.addCharges(U,vt),ut[U]=(ut[U]||0)+vt;let Xt=et.cells[Math.floor(et.cells.length/2)],Qt=Zt(Xt.y,Xt.s),En=Ae[U];for(let Me=0;Me<vt;Me++)setTimeout(()=>{oe.spawnMagicOrb(U,Qt.x,Qt.y,En)},Me*100)}y+=Dt*_t,j+=Dt,W+=et.length*He;for(let Xt of et.cells){let Qt=`${Xt.y},${Xt.s}`;d.has(Qt)||d.set(Qt,{y:Xt.y,s:Xt.s,color:et.color,isLine:!0})}}for(let et of a){N.pairs++,y+=wt*_t,j+=wt,W+=v;for(let U of et.cells){let vt=`${U.y},${U.s}`;d.has(vt)||d.set(vt,{y:U.y,s:U.s,color:p[U.y][U.s],isLine:!1})}}let Rt=Ue(b,Pt-1),ye=Ue(T,at),ae=Math.round(W*Rt*ye),Q=0;Pt>1&&(N.combos++,N.maxCombo=Math.max(N.maxCombo,Pt),setTimeout(()=>yt(`COMBO \xD7${Pt}`,"combo"),Q),Q+=180,L.play("combo2")),at>0&&(N.cascades++,N.maxCascade=Math.max(N.maxCascade,at),setTimeout(()=>yt(`CASCADE \xD7${at}`,"cascade"),Q),Q+=180,L.play("cascade")),(t.length>0||a.length>0)&&L.play("combo");for(let et of t){let U=et.length,vt=U*He;setTimeout(()=>yt(`Line-${U} +${vt}`,"line",et.color),Q),Q+=100}for(let et of a){let U=et.cells.length>0?p[et.cells[0].y][et.cells[0].s]:null;setTimeout(()=>yt(`Pair +${v}`,"pair",U),Q),Q+=100}ae>0&&(setTimeout(()=>yt(`+${ae}`,"score"),Q),Q+=120),j>0&&(setTimeout(()=>yt(`+${j}s`,"time"),Q),Q+=120);for(let[et,U]of Object.entries(ut))U>0&&(setTimeout(()=>yt(`+${U}${Fe(et)}`,"charge"),Q),Q+=120);P=Array.from(d.values()),F=performance.now(),R=!0,Z=!1,w=y,X=ae,G()}function zn(){for(let t of P)p[t.y][t.s]=0;P.length>0&&L.playRandom("disappear"),w>0&&(ct=Math.max(0,ct-w)),gt.addScore(X),Ot+=X,Oe(),P=[],R=!1,Z=!1,w=0,X=0,at++,Xe()}function Xe(){ce();let{lineMatches:t,pairMatches:a}=os();if(t.length>0||a.length>0)cn(t,a);else{let d=dn();d.length>0?es(d):!_&&ft==="playing"&&un()}}function bs(t,a){cn(t,a)}function Ve(t){return Se(t,i)}function Re(){return Ve(Math.round(I))}function ln(t,a){return en(_,t,a,p,n,i)}function Ie(t){return ln(t,Re())}let we=Hn;function an(){se&&(kt!==0&&st>=kt||(nt=0,st+=1))}function qn(){if(!_)return;let t=_.cells,a=_.colors,d={cells:t,colors:a};if(C>=0||(d=we(d.cells,d.colors),d=we(d.cells,d.colors)),d=we(d.cells,d.colors),_.cells=d.cells,_.colors=d.colors,!Ie(Math.floor(B))){_.cells=t,_.colors=a;return}L.play("turn"),H&&an()}function Zn(){return Un(_,B,Re(),p,n,i)}function Jn(){if(!_)return!1;let t=Math.floor(B)-1,a=!Ie(t);return a&&!H?(H=!0,nt=0,st=0):!a&&H&&(H=!1,nt=0,st=0),a}let Ye=$n;function We(){if(ft==="playing"){xe.classList.add("hidden");return}if(xe.classList.remove("hidden"),ft==="intro"){de.innerHTML='<span class="title-elemental">Elemental</span> <span class="title-blocks">Blocks</span>';let t=Math.floor(bt/60),a=bt%60,d=A.loadHighscore(),y=d.score>0?`<div class="intro-highscore">\u{1F3C6} Best: ${d.score.toLocaleString()} <small>(${Ye(d.time)})</small></div>`:"";fe.innerHTML=`
        ${y}
        <div class="intro-survival">\u23F1 Survive: ${t}:${a.toString().padStart(2,"0")}</div>
        <div class="intro-box">
          <div class="intro-box-title">Combos</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+30 <small>+1\u2726</small></span>
              <span class="rule-time">+${It}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">+40 <small>+2\u2726</small></span>
              <span class="rule-time">+${St}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">+50 <small>+3\u2726</small></span>
              <span class="rule-time">+${At}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+100</span>
              <span class="rule-time">+${wt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">+500</span>
              <span class="rule-time">+${Wt}s</span>
            </div>
          </div>
        </div>
        <div class="intro-version">v${lt}</div>
      `,me.textContent="Start"}else{de.textContent="Game Over";let t=`
        <div class="go-score">${Ot.toLocaleString()}</div>
        <div class="go-time">\u23F1 ${Ye(ee)}</div>
        <div class="intro-box" style="margin-top:12px">
          <div class="intro-box-title">Matches</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Line-3</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.lines3}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">Line-4</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.lines4}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">Line-5</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.lines5}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Pair</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.pairs}</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">Ring</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.rings}</span>
            </div>
          </div>
        </div>
        <div class="intro-box" style="margin-top:8px">
          <div class="intro-box-title">Bonuses</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots" style="color:#ffd84d;font-size:14px;font-weight:700">COMBO</span>
              <span class="rule-text">\xD7${N.combos}</span>
              <span class="rule-time" style="color:#ffd84d">${N.maxCombo>0?"max \xD7"+N.maxCombo:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#ff6b9d;font-size:14px;font-weight:700">CASCADE</span>
              <span class="rule-text">\xD7${N.cascades}</span>
              <span class="rule-time" style="color:#ff6b9d">${N.maxCascade>0?"max \xD7"+N.maxCascade:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#cfe0f3;font-size:14px">\u2726</span>
              <span class="rule-text">Magic</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${N.magicUsed}</span>
            </div>
          </div>
        </div>
        <div class="go-version">v${lt}</div>
      `;fe.innerHTML=t,me.textContent="Play again"}}function Oe(){ne.textContent=`Score: ${Ot}`}function Ke(){ve.textContent=`Time: ${Ye(ee)}`}function jn(){for(let t=0;t<n;t++)p[t].fill(0);ct=0,I=dt=0,mt=0,gt.start(),Ot=0,_e=performance.now(),ee=0,ue=0,re=0,ft="playing",Nt=null,Lt.reset(),P=[],it=[],R=!1,Z=!1,D=!1,w=0,X=0,at=0,G(),Oe(),Ke(),un(),Je.drawNextPreview(ie,Nt),We(),L.getSettings().musicEnabled&&L.startGameMusic()}function ze(){gt.gameOver(),ft="gameover",_=null,H=!1,nt=0,st=0;let t=A.saveHighscore(Ot,ee);L.stopMusic(),L.play("gameover"),setTimeout(()=>{(ft==="gameover"||ft==="intro")&&L.startMenuMusic()},2500),Ke(),We(),t&&Ot>0&&setTimeout(()=>{yt("\u{1F3C6} NEW RECORD!","score")},500)}function Qn(t){for(let d=0;d<50;d++){let y=t.map(()=>1+(Math.random()*4|0));if(!ts(t,y))return y}return t.map((d,y)=>1+y%4)}let ts=Yn;function rn(t){let a=t.cells.map(y=>({x:y.x,y:y.y})),d=Qn(a);return{name:t.name,cells:a,colors:d}}function un(){if(!Nt){let W=q[Math.random()*q.length|0];Nt=rn(W)}_=Nt;let t=q[Math.random()*q.length|0];Nt=rn(t),Je.drawNextPreview(ie,Nt);let a=1/0,d=-1/0;for(let W of _.cells)W.x<a&&(a=W.x),W.x>d&&(d=W.x);let y=(a+d)/2;for(let W of _.cells)W.x=W.x-Math.round(y);B=n+3,ht=0,H=!1,nt=0,st=0,Ie(Math.floor(B))?L.playRandom("appear"):ze()}function dn(){return Vn(p,n,i)}function es(t){if(t.length===0)return;let a=[];for(let Pt of t)for(let Rt=0;Rt<i;Rt++)a.push({y:Pt,s:Rt,color:p[Pt][Rt],isLine:!1});it=t,P=a,F=performance.now(),R=!0,D=!0,Z=!1;let d=t.length;N.rings+=d;let y=Ue(sn,d-1),W=Math.round(nn*d*y),j=Wt*d;X=W,w=j*_t,L.play("ring");let ut=`RING \xD7${d}`;yt(ut,"ring"),setTimeout(()=>yt(`+${W}`,"score"),150),setTimeout(()=>yt(`+${j}s`,"time"),300)}function ns(){let t=[...it].sort((a,d)=>d-a);for(let a of t){for(let d=a;d<n-1;d++)p[d].set(p[d+1]);p[n-1].fill(0)}w>0&&(ct=Math.max(0,ct-w)),gt.addScore(X),Ot+=X,Oe(),P=[],it=[],R=!1,D=!1,w=0,X=0,Xe()}function _s(){return dn().length}function ss(){if(!_)return;let t=Re();I=t,dt=t,mt=0;let a=!1;for(let d=0;d<_.cells.length;d++){let y=_.cells[d],W=_.colors[d],j=Math.floor(B)+y.y,ut=Ve(t+y.x);j>=n&&(a=!0),j>=0&&j<n&&(p[j][ut]=W)}if(a){ze();return}gt.addScore(Ht),Ot+=Ht,Oe(),yt(`+${Ht}`,"score"),L.playRandom("drop"),_=null,at=0,le()}function os(){return Xn(p,n,i)}function is(){if(!_)return!1;let t=Math.floor(B)-1;return Ie(t)?(B=t,H=!1,nt=0,st=0,!0):(H=!0,!1)}o.addEventListener("pointerdown",t=>{if(tt.state!=="playing")return;t.preventDefault?.(),Y.handlePointerDown(t,{onMagicTap:(d,y)=>tt.applyCommand("magic_shoot",{x:d,y}),onDoubleTap:()=>tt.applyCommand("rotate_piece")},dt)||(mt=0)},{passive:!1}),o.addEventListener("pointermove",t=>{if(tt.state!=="playing"||!Y.dragging)return;t.preventDefault?.();let a=Y.handlePointerMove(t,{canRotateTo:(d,y)=>tt.canRotateTo(d,y),onDrop:()=>tt.applyCommand("move_down"),onGroundedMove:()=>tt.onGroundedMove()},tt.pieceY,tt.isGrounded);a&&tt.setRotation(a.targetRot)},{passive:!1}),o.addEventListener("pointerup",t=>{tt.state==="playing"&&Y.handlePointerUp(t)},{passive:!1}),qt.addEventListener("click",()=>{tt.state==="playing"&&tt.applyCommand("rotate_piece")});let Pe=e.dropBtn,De=null;function cs(){tt.state==="playing"&&(tt.applyCommand("move_down"),De=setInterval(()=>{if(tt.state!=="playing"){Be();return}tt.applyCommand("move_down")},Vt))}function Be(){De&&(clearInterval(De),De=null)}Pe.addEventListener("pointerdown",t=>{t.preventDefault(),cs()}),Pe.addEventListener("pointerup",Be),Pe.addEventListener("pointerleave",Be),Pe.addEventListener("pointercancel",Be);for(let[t,a]of Object.entries(Ae))a.addEventListener("click",()=>{tt.state==="playing"&&tt.applyCommand("select_magic",{element:t})});let qe=e.soundsToggle,Ze=e.musicToggle;function he(){let t=L.getSettings();t.soundsEnabled?qe.classList.add("active"):qe.classList.remove("active"),t.musicEnabled?Ze.classList.add("active"):Ze.classList.remove("active");for(let a=0;a<=4;a++){let d=e.soundVolBtns[a],y=e.musicVolBtns[a];d&&d.classList.toggle("active",t.soundVolume===a),y&&y.classList.toggle("active",t.musicVolume===a)}}let fn=e.tabBtns,ls=e.tabContents;fn.forEach(t=>{t.addEventListener("click",()=>{let a=t.dataset.tab;fn.forEach(d=>d.classList.remove("active")),ls.forEach(d=>d.classList.remove("active")),t.classList.add("active"),wn(a).classList.add("active"),a==="sounds"&&he()})});let mn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,gn=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,as=e.iosHint,rs=e.standaloneBadge;function pn(){let t=document.fullscreenElement||document.webkitFullscreenElement;Ct.textContent=t?"Disable":"Enable"}mn&&(gn?(rs.style.display="block",Ct.style.display="none"):(as.style.display="block",Ct.textContent="Not supported",Ct.style.opacity="0.5",Ct.style.cursor="default")),Ct.addEventListener("click",()=>{if(mn&&!gn)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",pn),document.addEventListener("webkitfullscreenchange",pn);let Ge=e.invertSwipeToggle;h.invertSwipe&&Ge.classList.add("active"),Ge.addEventListener("click",()=>{Ge.classList.toggle("active");let t=Ge.classList.contains("active");Y.rotDir=t?-1:1,h.invertSwipe=t,A.saveGameSettings(h)});let hn=e.diffBtns;hn.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(hn.forEach(a=>{a.classList.remove("active");let d=a.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let a=document.createElement("span");a.className="check-icon",a.textContent="\u2713",t.appendChild(a)}})}),qe.addEventListener("click",()=>{let a=!L.getSettings().soundsEnabled;L.updateSettings({soundsEnabled:a}),he()}),Ze.addEventListener("click",()=>{let a=!L.getSettings().musicEnabled;L.updateSettings({musicEnabled:a}),he(),a?tt.state==="playing"?L.startGameMusic():L.startMenuMusic():a||L.stopMusic()});for(let t=0;t<=4;t++){let a=e.soundVolBtns[t];a&&a.addEventListener("click",()=>{L.updateSettings({soundVolume:t}),he(),L.play("turn")})}for(let t=0;t<=4;t++){let a=e.musicVolBtns[t];a&&a.addEventListener("click",()=>{L.updateSettings({musicVolume:t}),he()})}he();function us(){ft==="playing"&&(gt.pause(),re=performance.now(),ft="paused",L.musicAudio&&L.musicAudio.pause())}function yn(){ft==="paused"&&(gt.resume(),ue+=performance.now()-re,re=0,ft="playing",je=performance.now(),L.getSettings().musicEnabled&&L.startGameMusic())}pe.addEventListener("click",()=>{us(),Ut.classList.remove("hidden")}),Te.addEventListener("click",()=>{Ut.classList.add("hidden"),yn()}),Ut.addEventListener("click",t=>{t.target===Ut&&(Ut.classList.add("hidden"),yn())});let tt=Wn({N:i,H:n,FALL_INTERVAL:$,LOCK_DELAY_SEC:ot,KILL_RATE:_t,MATCH_HIGHLIGHT_SEC:Et,MAGIC_SHRINK_SEC:$t,RING_HIGHLIGHT_SEC:Ee,getState:()=>({gameState:ft,score:Ot,elapsedMs:ee,startTime:_e,totalPausedMs:ue,stats:N,activePiece:_,pieceY:B,targetRot:dt,rotFloat:I,rotVel:mt,isGrounded:H,isHighlighting:R,isMagicAnimation:Z,isRingAnimation:D,highlightStartTime:F,killLevel:ct,grid:p,fallTimer:ht,lockTimer:nt}),setState:t=>{"elapsedMs"in t&&(ee=t.elapsedMs),"killLevel"in t&&(ct=t.killLevel),"fallTimer"in t&&(ht=t.fallTimer),"lockTimer"in t&&(nt=t.lockTimer),"targetRot"in t&&(dt=t.targetRot),"rotFloat"in t&&(I=t.rotFloat),"rotVel"in t&&(mt=t.rotVel)},funcs:{startGame:jn,endGame:ze,rotatePieceByDir:qn,tryMoveDown:is,canPlaceAtRot:ln,maybeResetLockDelay:an,shootMagic:be,selectMagic:x,updateGroundedState:Jn,lockPiece:ss,finishHighlight:zn,finishRingHighlight:ns},ui:{updateTimeHud:Ke}}),Je=Kn({canvas:o,canvasCtx:r,N:i,H:n,TOP_PAD_PX:l,BOTTOM_PAD_PX:m,MAX_RADIUS_X:g,RADIUS_X_FACTOR:f,ANG_OFFSET:s,MATCH_HIGHLIGHT_SEC:Et,MATCH_SHRINK_PHASE:te,MAGIC_SHRINK_SEC:$t,RING_HIGHLIGHT_SEC:Ee,LOCK_DELAY_SEC:ot,ELEMENT_COLORS:Mt,ELEMENT_TO_COLOR:K,BLOCK_COLOR_FRONT:M,BLOCK_COLOR_BACK:z,ACTIVE_COLOR_FRONT:k,GHOST_COLOR_FILL:J,GHOST_COLOR_STROKE:O,GHOST_STROKE_WIDTH:V,MAGIC_DIM_DOT_ALPHA:ke,MAGIC_DIM_DOT_SCALE:Kt,MAGIC_TARGET_DOT_SCALE:$e,getState:()=>({gameState:ft,grid:p,activePiece:_,pieceY:B,rotFloat:I,killLevel:ct,isHighlighting:R,highlightedCells:P,highlightStartTime:F,isMagicAnimation:Z,isRingAnimation:D,isGrounded:H,lockTimer:nt}),getVisualSettings:()=>({waterBubbles:zt,waterColor:Ft}),funcs:{snappedRot:Re,computeGhostY:Zn,normSector:Ve,getMagicTargetColor:()=>Lt.canUse()?K[Lt.active]:null}}),je=performance.now();function Mn(t){let a=Math.min(.05,Math.max(.001,(t-je)/1e3));je=t,tt.update(a,t),I=dt,I>1e6&&(I%=i),I<-1e6&&(I%=i),Je.render(),requestAnimationFrame(Mn)}me.addEventListener("click",()=>{tt.applyCommand("start_game")}),G(),We(),L.startMenuMusic();let ds=()=>{if(L.unlock(),!L.getSettings().musicEnabled)return;let t=L.musicAudio;!t||t.paused||t.ended?tt.state==="playing"?L.startGameMusic():L.startMenuMusic():t.play().catch(a=>{console.debug("Music resume on interaction failed:",a)})},Sn=0,fs=10,ms=()=>{Sn>=fs||(Sn++,ds())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ms,{passive:!0})}),requestAnimationFrame(Mn)})();})();
