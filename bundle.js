(()=>{var ji=[0,.25,.5,.75,1],Qi=[0,.05,.15,.25,.5],Zi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},xo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Co="soundSettings";function Ji(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function tc(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function To(){return{audioContext:null,buffers:{},settings:Ji(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),a=this.audioContext.createBufferSource();a.buffer=n,a.connect(this.audioContext.destination),a.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ji[this.settings.soundVolume]},getMusicVolume(){return Qi[this.settings.musicVolume]},async loadSound(n,a){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(a)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(d){console.debug(`Failed to load sound: ${n} from ${a}`,d)}},preload(){this.initContext();for(let[n,a]of Object.entries(Zi))this.loadSound(n,a)},play(n,a=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;a!==null&&(d=`${n}${a}`);let i=this.buffers[d];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let a=1+Math.floor(Math.random()*3);this.play(n,a)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(a=>{console.debug("Menu music autoplay blocked:",a)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(a=>{console.debug("Game music play failed:",a)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},tc(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(a=>{console.debug("Music resume failed:",a)}):this.stopMusic()}catch(a){console.debug("Update music settings failed:",a)}},getSettings(){return{...this.settings}}}}var _o="eb_highscore",Lo="eb_highscore_quick",Bo="eb_settings",Ro="eb_high_tower_rings",ec={invertSwipe:!1,hapticsEnabled:!0,showControls:!0,tapRotate:!1};function wo(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Lo:_o,a=localStorage.getItem(n);if(a)return JSON.parse(a)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,a="30_24"){try{let d=this.loadHighscore(a);if(e>d.score||e===d.score&&n>d.time){let i=a==="25_20"?Lo:_o;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Bo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ec}},saveGameSettings(e){try{localStorage.setItem(Bo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Ro);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Ro,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let a=this.loadHighTowerRings()+e;return this.saveHighTowerRings(a),a}}}function Ao(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),controlsRight:document.querySelector(".controls-right"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),showControlsToggle:document.getElementById("showControlsToggle"),tapRotateToggle:document.getElementById("tapRotateToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Io(e){return document.getElementById("tab-"+e)}var nc={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Po(e={}){let{elementColors:n={}}=e,a=0;return{showBonus(d,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=d,s&&n[s]&&(c.style.color=n[s]);let f=window.innerWidth/2,p=window.innerHeight/2-40,g=(Math.random()-.5)*200,l=(Math.random()-.5)*100+a*36;c.style.left=`${f+g}px`,c.style.top=`${p+l}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),a++,setTimeout(()=>{a=Math.max(0,a-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(d){return nc[d]||"\u2726"}}}var ks={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function ko(){return{spawnMagicOrb(e,n,a,d){if(!d)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=ks[e]||"\u2726";let s=d.getBoundingClientRect(),c=s.left+s.width/2-n,f=s.top+s.height/2-a,p=Math.hypot(c,f),g=Math.atan2(f,c),l=p*.35*(Math.random()>.5?1:-1),m=g+Math.PI/2,S=c*.5+Math.cos(m)*l,w=f*.5+Math.sin(m)*l;i.style.setProperty("--mid-x",`${S}px`),i.style.setProperty("--mid-y",`${w}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${f}px`),i.style.left=`${n}px`,i.style.top=`${a}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,a,d,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,f=s.top+s.height/2,p=document.createElement("div");p.className=`magic-shot ${e}`,p.textContent=ks[e]||"\u2726";let g=a-c,l=d-f;p.style.setProperty("--end-x",`${g}px`),p.style.setProperty("--end-y",`${l}px`),p.style.left=`${c}px`,p.style.top=`${f}px`,document.body.appendChild(p);let m=setInterval(()=>{let S=p.getBoundingClientRect();this.spawnTrailParticle(e,S.left+S.width/2,S.top+S.height/2)},40);setTimeout(()=>{clearInterval(m),p.remove(),this.spawnExplosion(e,a,d),i&&i()},300)},spawnTrailParticle(e,n,a){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${n}px`,d.style.top=`${a}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,n,a){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,f=40+Math.random()*40,p=Math.cos(c)*f,g=Math.sin(c)*f;s.style.setProperty("--px",`${p}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${a}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",a=18){if(!e)return;let d=n;typeof n=="number"&&(a=n,d="water"),ks[d]||(d="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,f=Math.max(8,Math.round(a));for(let p=0;p<f;p++){let g=document.createElement("div");g.className=`spell-bubble ${d}`,g.textContent="\u25CF";let l=p/f*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,S=Math.cos(l)*m,w=Math.sin(l)*m-20;g.style.setProperty("--px",`${S}px`),g.style.setProperty("--py",`${w}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,a){if(!a)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let i=a.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,f=Math.hypot(s,c),p=Math.atan2(c,s),g=f*.35*(Math.random()>.5?1:-1),l=p+Math.PI/2,m=s*.5+Math.cos(l)*g,S=c*.5+Math.sin(l)*g;d.style.setProperty("--mid-x",`${m}px`),d.style.setProperty("--mid-y",`${S}px`),d.style.setProperty("--end-x",`${s}px`),d.style.setProperty("--end-y",`${c}px`),d.style.left=`${e}px`,d.style.top=`${n}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}var sc=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Oo=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,oc=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function ic(e){let n=e.querySelector(".ring"),a=e.querySelector(".falling-figure"),d=e.querySelector(".clock");if(!n||!a||!d)return()=>{};let i=!1,s=[],c=[],f=(F,N)=>{let at=setTimeout(()=>{i||F()},N);return s.push(at),at},p=(F,N)=>{let at=setInterval(()=>{if(i){clearInterval(at);return}F()},N);return c.push(at),at},g=48,l=.9,m=9,S=9,w=3,z=2,K=18,ct=-12,wt=.5,he=12,zt=10,xt=["--fire","--water","--light","--earth"],Kt=["--light","--fire","--water"],lt=3,q=Math.floor(m/2)-1,Ct=8e3,It=[];function At(F,N){let at=(N-1)/2,$t=Math.abs(F-at)/at;return 1-(1-wt)*$t}function C(F,N,at,$t){let ie=(N-1)/2,W=Math.abs(F-ie)/ie;return $t?W*at:-W*at}function Pt(){n.innerHTML="";let F=[],N=[];for(let it=0;it<S;it++)N.push(g*l*At(it,S));let at=N.reduce((it,Tt)=>it+Tt,0)+(S-1)*z,$t=[];for(let it=0;it<m;it++)$t.push(g*At(it,m));let ie=$t.reduce((it,Tt)=>it+Tt,0)+(m-1)*w,W=-at/2;for(let it=0;it<S;it++){let Tt=N[it],Nt=g*l,ne=m+it,_t=C(it,S,zt,!0),Jt=document.createElement("div");Jt.className="block back",Jt.style.cssText=`left:${W.toFixed(1)}px;top:${(ct-Nt/2+_t).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Nt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let G=document.createElement("div");G.className="dot";let se=l*At(it,S);G.style.cssText=`--c:var(${xt[ne%4]});transform:scale(${se.toFixed(2)});`,Jt.appendChild(G),Jt.dataset.index=ne,n.appendChild(Jt),F[ne]=Jt,W+=Tt+z}let nt=-ie/2;for(let it=0;it<m;it++){let Tt=$t[it],Nt=g,ne=it,_t=C(it,m,he,!1),Jt=ne>=q&&ne<q+lt,G=document.createElement("div");G.className="block",Jt&&G.classList.add("gap"),G.style.cssText=`left:${nt.toFixed(1)}px;top:${(K-Nt/2+_t).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Nt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let se=document.createElement("div");se.className="dot";let Ce=At(it,m);se.style.cssText=`--c:var(${xt[ne%4]});transform:scale(${Ce.toFixed(2)});`,G.appendChild(se),G.dataset.index=ne,n.appendChild(G),F[ne]=G,nt+=Tt+w}It=F}function Ft(){let F=[];for(let N=q-1;N>=0;N--)F.push(N);for(let N=0;N<S;N++)F.push(m+N);for(let N=m-1;N>=q;N--)F.push(N);return F}function Bt(){It.forEach((F,N)=>{F&&(F.classList.remove("hi","vanish","gap"),F.style.opacity="",F.style.transform="",N>=q&&N<q+lt&&F.classList.add("gap"))})}function r(){for(let F=0;F<lt;F++){let N=It[q+F];if(N){N.classList.remove("gap");let at=N.querySelector(".dot");if(at){let $t=At(q+F,m);at.style.cssText=`--c:var(${Kt[F]});transform:scale(${$t.toFixed(2)});`}}}}function J(F){let N=Ft(),at=0,$t=N.length,ie=p(()=>{if(at>0&&at<=$t){let W=It[N[at-1]];W&&W.classList.remove("hi")}if(at<$t){let W=It[N[at]];W&&W.classList.add("hi"),at++}else clearInterval(ie),It.forEach(W=>{W&&W.classList.add("hi")}),f(F,300)},30)}function tt(F){let N=Ft(),at=N.length;N.forEach(($t,ie)=>{let W=It[$t];W&&f(()=>{W.classList.add("vanish")},ie*40)}),f(F,at*40+500)}function ee(){i||(Bt(),a.classList.add("active"),f(()=>{r(),a.classList.remove("active"),a.style.opacity="0",f(()=>{J(()=>{i||(d.classList.add("show"),f(()=>{tt(()=>{i||(d.classList.remove("show"),a.style.opacity="",f(ee,500))})},400))})},200)},Ct*.38))}return Pt(),ee(),()=>{i=!0,s.forEach(clearTimeout),c.forEach(clearInterval)}}var cc=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:sc},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Oo},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:oc,onEnter:e=>ic(e)}];function Do(e={}){let{helpBtn:n,mount:a=document.body,combosTemplate:d}=e;if(!n||!a)return{open(){},close(){},setCombosTemplate(){}};let i=cc.map(C=>({...C}));typeof d=="string"&&d.trim()&&(i[1].illustrationHtml=d);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,a.appendChild(s);let c=s.querySelector(".help-next-btn"),f=s.querySelector(".help-slide-title"),p=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),l=s.querySelector(".help-dots"),m=i.map(()=>{let C=document.createElement("span");return C.className="help-dot",l.appendChild(C),C}),S=0,w=!1,z=null,K=null,ct=180,wt=560,he=460,zt=480,xt=C=>{K&&(K(),K=null);let Pt=i[C];Pt&&(S=C,f.textContent=Pt.title,p.textContent=Pt.text,g.innerHTML=Pt.illustrationHtml||"",m.forEach((Ft,Bt)=>{Ft.classList.toggle("active",Bt===C)}),c.textContent=C===i.length-1?"Done":"Next",Kt(),Pt.onEnter&&(K=Pt.onEnter(g)))},Kt=()=>{if(!w||s.classList.contains("hidden"))return;let C=g.getBoundingClientRect();if(!C.width||!C.height)return;let Pt=g.querySelector(".help-combos");if(Pt){let r=Math.min(1,Math.min(C.width,C.height)/wt);Pt.style.setProperty("--help-combos-scale",r.toFixed(3))}let Ft=g.querySelector(".help-controls");if(Ft){let r=Math.min(1,Math.min(C.width,C.height)/he);Ft.style.setProperty("--help-controls-scale",r.toFixed(3))}let Bt=g.querySelector(".help-rings");if(Bt){let r=Math.min(1,Math.min(C.width,C.height)/zt);Bt.style.setProperty("--help-rings-scale",r.toFixed(3))}},lt=()=>{w&&Kt()},q=C=>{w&&C.stopPropagation()},Ct=C=>{if(w){if(C.key==="Escape"){C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation?.(),At();return}C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation?.()}},It=()=>{w||(w=!0,z&&(clearTimeout(z),z=null),xt(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),Kt()}),document.addEventListener("keydown",Ct,!0),window.addEventListener("resize",lt))},At=()=>{w&&(w=!1,K&&(K(),K=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",Ct,!0),window.removeEventListener("resize",lt),z=window.setTimeout(()=>{s.classList.add("hidden")},ct))};return s.addEventListener("click",C=>{w&&(C.target===s&&At(),C.stopPropagation())}),s.addEventListener("pointerdown",q),s.addEventListener("pointerup",q),s.addEventListener("touchstart",q,{passive:!0}),s.addEventListener("touchmove",C=>{w&&(C.preventDefault(),C.stopPropagation())},{passive:!1}),s.addEventListener("wheel",C=>{w&&(C.preventDefault(),C.stopPropagation())},{passive:!1}),c.addEventListener("click",C=>{C.stopPropagation(),S<i.length-1?xt(S+1):At()}),n.addEventListener("click",C=>{C.preventDefault(),It()}),{open:It,close:At,setCombosTemplate(C){typeof C=="string"&&(i[1].illustrationHtml=C.trim()||Oo,w&&S===1&&xt(1))}}}var ac={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function rc(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Os=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let a=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return a?(navigator.vibrate(a),!0):!1}},Ds=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Ho({enabled:e=!0,patterns:n=ac}={}){let a=rc(),d=a?new Ds(a):new Os,i=d.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let f=n[c];return f?d.trigger({name:c,...f}):!1}}}function Fo(e={}){let{buttons:n={},onActivate:a=null,onChange:d=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[p,g]of Object.entries(n)){if(!g)continue;let l=i[p],m=g.querySelector(".charges");m&&(m.textContent=l),g.classList.toggle("empty",l<=0),g.classList.toggle("active",s===p&&l>0)}d&&d({...i},s)}function f(p){let g=n[p];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(p){s=p},select(p){if(i[p]<=0)return!1;let g=s===p;return s=g?null:p,c(),!g&&s===p&&a&&a(),!g},useCharge(){if(!s||i[s]<=0)return!1;let p=s;return i[p]--,s=null,c(),f(p),!0},addCharges(p,g){i[p]!==void 0&&(i[p]+=g,c(),f(p))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(p){for(let[g,l]of Object.entries(n))l&&l.addEventListener("click",()=>{p&&p(g)})}}}var en={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function $o(e={}){let{button:n=null,onActivate:a=null,onProgress:d=null,onReady:i=null}=e,s="ice",c=0;function f(){return en[s]||en.ice}function p({silent:l=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let m=f(),S=Number.isFinite(m.maxProgress)?m.maxProgress:0,w=S>0?Math.min(c/S,1)*100:0,z=S>0&&c>=S;n.style.setProperty("--progress",`${w}%`);let K=n.querySelector(".spell-icon");K&&(K.textContent=m.icon);let ct=n.querySelector(".spell-counter");ct&&(ct.textContent=S>0?`${Math.min(c,S)}/${S}`:""),n.classList.toggle("ready",z),n.classList.toggle("charging",!z&&c>0),d&&!l&&S>0&&d(c,S)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return f().maxProgress??0},get isReady(){let l=f().maxProgress;return Number.isFinite(l)&&l>0&&c>=l},get effect(){return f().effect},getUnlockRings(l){return(en[l]||en.ice).unlockRings??0},getCost(l){return(en[l]||en.ice).cost??0},getDescription(l){return(en[l]||en.ice).description||""},getEffect(l){return(en[l]||en.ice).effect},get button(){return n},selectSpell(l){en[l]&&(s=l,c=0,p())},addProgress(l=1){let m=f();if(!Number.isFinite(m.maxProgress)||m.maxProgress<=0||c>=m.maxProgress)return!1;let S=c<m.maxProgress;return c=Math.min(c+l,m.maxProgress),p(),g(),S&&c>=m.maxProgress&&i&&i(),!0},setProgress(l,{silent:m=!1}={}){c=Math.max(0,l),p({silent:m})},canUse(){let l=f().maxProgress;return Number.isFinite(l)&&l>0&&c>=l},use(){if(!this.canUse())return null;let l=f().effect;return c=0,p(),g(),a&&a(s),l},reset(){c=0,p()},pulse(){g()},updateButton:p,initButton(l){n&&n.addEventListener("click",()=>{l&&l()})}}}function Hs({centerY:e,centerS:n,size:a,H:d,normSector:i}){let s=[],c=Math.floor(a/2);for(let f=-c;f<=c;f++)for(let p=-c;p<=c;p++){let g=e+f,l=i(n+p);if(g<0||g>=d)continue;let m=f*f+p*p;s.push({y:g,s:l,distSq:m})}return s}function ps(e,n,a){return n.filter(d=>e[d.y][d.s]===a)}function ms(e,n){return[...e].sort((d,i)=>d.distSq!==i.distSq?d.distSq-i.distSq:d.y!==i.y?d.y-i.y:d.s-i.s).slice(0,n).map(d=>({y:d.y,s:d.s}))}function No({centerY:e,centerS:n,beamLength:a,N:d,H:i,normSector:s}){if(e<0||e>=i||a<0||d<=0)return[];let c=[],f=new Set,p=(l,m)=>`${l},${m}`,g=s(n);c.push({y:e,s:g,dist:0}),f.add(p(e,g));for(let l=1;l<=a;l++){let m=s(n+l),S=p(e,m);f.has(S)||(c.push({y:e,s:m,dist:l}),f.add(S));let w=s(n-l),z=p(e,w);f.has(z)||(c.push({y:e,s:w,dist:l}),f.add(z))}for(let l=1;l<=a;l++){let m=s(n),S=e+l;if(S<i){let z=p(S,m);f.has(z)||(c.push({y:S,s:m,dist:l}),f.add(z))}let w=e-l;if(w>=0){let z=p(w,m);f.has(z)||(c.push({y:w,s:m,dist:l}),f.add(z))}}return c}function Go(e){let{canvas:n,dom:a,getGrid:d,getN:i,getH:s,getRotFloat:c,constants:f,helpers:p,Spell:g,Magic:l,SoundModule:m,State:S,isGamePlaying:w,addPendingKzDrop:z,getKillRate:K,triggerSpellWave:ct,spawnSpellBubbles:wt,spawnBonusBubbles:he,getTransmuteEffect:zt,getLightningEffect:xt,getFireEffect:Kt,continueMatchProcessing:lt,updateScoreHud:q,showBonus:Ct,getSpellCost:It,getSpellElement:At,onUltimateApplied:C,isSpellBlocked:Pt,setScore:Ft,setCascadeLevel:Bt}=e,{TOP_PAD_PX:r,BOTTOM_PAD_PX:J,SIDE_MARGIN_PX:tt,MAX_RADIUS_X:ee,SCORE_MAGIC_DESTROY:F}=f,{normSector:N,levelYToScreenY:at,sectorCenterXY:$t}=p,ie=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],W="idle",nt=null,it=null,Tt=[],Nt=[],ne=0,_t=null,Jt=0,G="idle",se=null,Ce=[],ce=[],U=0,P=0,B="idle",A=null,k=[],v=[],rt=0;function dt(h){if(typeof It!="function"||typeof At!="function")return!1;let E=At(h),b=It(h);return!E||!b?!1:(l.charges[E]??0)>=b}function et(h){if(typeof It!="function"||typeof At!="function")return!1;let E=At(h),b=It(h);return!E||!b||(l.charges[E]??0)<b?!1:(l.charges[E]-=b,l.updateButtons(),g.pulse(),!0)}let j=0,L=350;function M(){return typeof Pt=="function"?Pt():!1}function R(){let h=performance.now();h-j<L||(j=h,m.play("cancel"))}function ae(){W="selecting_source",nt=null,it=null,Tt=[],Nt=[],G!=="idle"&&Rt(),B!=="idle"&&bt(),l.deactivate(),m.play("ulta");let h=a.spellBtn;h&&h.classList.add("selecting")}function x(){W!=="idle"&&m.play("cancel"),W="idle",nt=null,it=null,Tt=[],Nt=[],qt();let h=a.spellBtn;h&&h.classList.remove("selecting")}function Qt(h,E){if(W!=="selecting_source")return!1;if(M())return R(),!0;let b=X(h,E);if(!b)return x(),!0;let ht=d();nt={y:b.y,s:b.s,color:ht[b.y][b.s]},Tt=Hs({centerY:b.y,centerS:b.s,size:zt().areaSize,H:s(),normSector:N});let gt=nt.color,st=ps(ht,Tt,gt);return Nt=ms(st,zt().maxBlocks),ft(nt.color,b.y),W="selecting_target",!0}function X(h,E){let b=n.clientWidth,ht=n.clientHeight,gt=b*.5,st=(b-2*tt)/2,Wt=ht-r-J,jt=6,ye=s(),nn=i(),ue=c(),rn=nn*Wt/(jt*ye),_e=ht-J,fe,Fe,$e;rn<=Math.min(st,ee)?(fe=rn,Fe=Wt,$e=r):(fe=Math.min(st,ee),Fe=fe*jt*ye/nn,$e=_e-Fe);let Je=fe*.28,Re=null,tn=1/0,ln=d();for(let Zt=0;Zt<ye;Zt++){let hn=at($e,Fe,Zt+.5);for(let Ne=0;Ne<nn;Ne++){if(!ln[Zt][Ne])continue;let Le=$t(gt,hn,fe,Je,Ne,ue);if(Math.sin(Le.ang)<-.1)continue;let oe=h-Le.x,bn=E-Le.y,we=Math.hypot(oe,bn),Ge=Fe/ye*.9,T=Ge*1.2;Math.abs(oe)<T/2&&Math.abs(bn)<Ge/2&&we<tn&&(tn=we,Re={y:Zt,s:Ne})}}return Re}function ft(h,E){qt();let b=document.createElement("div");b.className="transmute-popup";let ht=n.clientWidth,gt=n.clientHeight,st=(ht-2*tt)/2,Wt=gt-r-J,jt=6,ye=s(),nn=i(),ue=nn*Wt/(jt*ye),rn=gt-J,_e,fe;ue<=Math.min(st,ee)?(_e=Wt,fe=r):(_e=Math.min(st,ee)*jt*ye/nn,fe=rn-_e);let Fe=at(fe,_e,E+.5),$e=Math.floor(zt().areaSize/2),Je=at(fe,_e,Math.min(ye,E+$e)+.5),Re=at(fe,_e,Math.max(0,E-$e)+.5),tn=fe+_e/2,ln=document.getElementById("gameContainer"),Zt=ln?ln.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},hn=160,Ne=60,Le=20,sn=Zt.left+Zt.width/2-hn/2,oe;Fe<tn?oe=Zt.top+Re+Le:oe=Zt.top+Je-Ne-Le,oe=Math.max(10,Math.min(window.innerHeight-Ne-10,oe)),b.style.left=`${sn}px`,b.style.top=`${oe}px`,ie.filter(we=>we.color!==h).forEach(we=>{let Ge=document.createElement("button");Ge.className=`transmute-btn ${we.name}`,Ge.innerHTML=we.icon,Ge.setAttribute("data-color",we.color),Ge.addEventListener("click",T=>{T.stopPropagation(),St(we.color)}),b.appendChild(Ge)}),document.body.appendChild(b),_t=b,Jt=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",We)},50)}function We(h){performance.now()-Jt<200||_t&&!_t.contains(h.target)&&x()}function qt(){document.removeEventListener("pointerdown",We),_t&&(_t.remove(),_t=null)}function St(h){if(M()){R();return}if(!dt(g.currentSpell)){R();return}if(qt(),it=h,Nt.length===0){x();return}re()}function re(){if(!nt){x();return}if(Nt.length===0){x();return}if(!et(g.currentSpell)){R(),x();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),W="animating",ne=performance.now(),m.play("esseffect")}function pn(){if(W!=="selecting_target"&&W!=="animating"||!nt||!Tt||Tt.length===0)return;let h=d(),E=h[nt.y]?.[nt.s]??0;if(!E||E!==nt.color){x();return}let b=ps(h,Tt,E),ht=zt().maxBlocks??b.length;Nt=ms(b,ht),Nt.length===0&&x()}function Dt(h){if(W!=="animating")return!1;let E=(h-ne)/1e3;return Math.min(E/zt().animSec,1)>=1?(Ve(),!1):!0}function le(h){if(W!=="animating")return null;let E=(h-ne)/1e3,b=Math.min(E/zt().animSec,1),ht="flash",gt=0,st=0;return b<.15?(ht="flash",st=1-b/.15):b<.55?(ht="shrink",gt=(b-.15)/.4):(ht="grow",gt=(b-.55)/.45),{phase:ht,progress:gt,areaFlash:st}}function Ve(){let h=d();for(let E of Nt)h[E.y][E.s]=it;W="idle",nt=null,it=null,Tt=[],Nt=[],Bt(1),lt(),typeof C=="function"&&C("earth")}function kt(){m.play("ulta"),G="selecting_source",se=null,Ce=[],ce=[],P=0,W!=="idle"&&(W="idle",nt=null,it=null,Tt=[],Nt=[],qt()),B!=="idle"&&(B="idle",A=null,k=[],v=[],rt=0),l.deactivate();let h=a.spellBtn;h&&h.classList.add("selecting")}function Rt(){G!=="idle"&&m.play("cancel"),G="idle",se=null,Ce=[],ce=[],P=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function Ke(){B="selecting_source",A=null,k=[],v=[],rt=0,W!=="idle"&&(W="idle",nt=null,it=null,Tt=[],Nt=[],qt()),G!=="idle"&&(G="idle",se=null,Ce=[],ce=[],P=0),l.deactivate(),m.play("ulta");let h=a.spellBtn;h&&h.classList.add("selecting")}function bt(){B!=="idle"&&m.play("cancel"),B="idle",A=null,k=[],v=[],rt=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function Qe(h,E){if(G!=="selecting_source")return!1;if(M())return R(),!0;let b=X(h,E);if(!b)return Rt(),!0;let ht=d();se={y:b.y,s:b.s,color:ht[b.y][b.s]},Ce=Hs({centerY:b.y,centerS:b.s,size:xt().areaSize,H:s(),normSector:N});let gt=se.color,st=ps(ht,Ce,gt);return ce=ms(st,xt().maxBlocks),ce.length===0?(Rt(),!0):dt(g.currentSpell)?(ve(),!0):(R(),!0)}function Te(h,E){if(B!=="selecting_source")return!1;if(M())return R(),!0;let b=X(h,E);if(!b)return bt(),!0;let ht=d();return A={y:b.y,s:b.s,color:ht[b.y][b.s]},k=No({centerY:b.y,centerS:b.s,beamLength:Kt().beamLength,N:i(),H:s(),normSector:N}),v=k.filter(gt=>ht[gt.y][gt.s]).sort((gt,st)=>gt.dist-st.dist),v.length===0?(bt(),!0):dt(g.currentSpell)?($(),!0):(R(),!0)}function ve(){if(!se||ce.length===0){Rt();return}if(!et(g.currentSpell)){R(),Rt();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),G="animating",U=performance.now(),P=0,m.play("asseffect")}function Pn(h){if(G!=="animating")return!1;let E=h-U,b=xt().flashMs+ce.length*xt().jumpMs;return E>=b?(On(),!1):!0}function kn(h){if(G!=="animating")return null;let E=h-U;if(E<xt().flashMs)return{phase:"flash",flashProgress:1-E/xt().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let b=E-xt().flashMs,ht=Math.floor(b/xt().jumpMs),gt=b%xt().jumpMs/xt().jumpMs,st=[];for(let Wt=0;Wt<Math.min(ht,ce.length);Wt++)st.push(Wt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(ht,ce.length-1),jumpProgress:gt,struckTargets:st}}function On(){let h=d(),E=ce.length,b=E*F;S.addScore(b),Ft(S.score),q(),Ct(`+${b}`,"score");for(let Wt of ce)h[Wt.y][Wt.s]=0;let ht=xt(),gt=Math.abs(ht.kzDropSecPerBlock??0),st=E*gt;st>0&&typeof z=="function"&&typeof K=="function"&&(z(st*K()),Ct(`\u26A1 -${st}s`,"time")),G="idle",se=null,Ce=[],ce=[],P=0,Bt(1),lt(),typeof C=="function"&&C("air")}function $(){if(!A||v.length===0){bt();return}if(!et(g.currentSpell)){R(),bt();return}let h=a.spellBtn;h&&h.classList.remove("selecting"),B="animating",rt=performance.now(),m.play("fsseffect")}function de(h){return B!=="animating"?!1:(h-rt)/1e3>=Kt().animSec?(te(),!1):!0}function Ht(h){if(B!=="animating")return null;let E=Kt(),b=Math.max(.001,E.animSec),ht=(h-rt)/1e3,gt=Math.min(ht/b,1),st=.25,Wt=gt<st?1-gt/st:0,jt=.6,ye=gt<jt?gt/jt*E.beamLength:E.beamLength;return{progress:gt,flashProgress:Wt,beamLength:E.beamLength,beamReach:ye}}function te(){let h=d(),E=v.length;if(E>0){let b=E*F;S.addScore(b),Ft(S.score),q(),Ct(`+${b}`,"score")}for(let b of v)h[b.y][b.s]=0;B="idle",A=null,k=[],v=[],rt=0,Bt(1),lt(),typeof C=="function"&&C("fire")}function Sn(){let h=typeof w=="function"?w():S.isPlaying(),E=g.currentSpell;if(!h)return!1;if(E==="ice"){if(M()||!dt(E)||!et(g.currentSpell))return R(),!1;let b=g.effect;return typeof z=="function"&&typeof K=="function"&&z(b.duration*K()),m.play("wsseffect"),Ct(`\u{1F4A7} -${b.duration}s`,"time"),typeof ct=="function"&&ct(),typeof he=="function"&&he(b.duration),typeof C=="function"&&C(E),!0}return E==="earth"?W==="selecting_source"||W==="selecting_target"?(x(),!0):W!=="idle"||M()||!dt(E)?(R(),!1):(W==="idle"&&ae(),!0):E==="air"?G==="selecting_source"?(Rt(),!0):G!=="idle"||M()||!dt(E)?(R(),!1):(G==="idle"&&kt(),!0):E==="fire"?B==="selecting_source"?(bt(),!0):B!=="idle"||M()||!dt(E)?(R(),!1):(B==="idle"&&Ke(),!0):!1}function Ze(h){pn(),Dt(h),Pn(h),de(h)}function mn(h,E){return M()&&(W==="selecting_source"||G==="selecting_source"||B==="selecting_source")?(R(),!0):W==="selecting_source"?Qt(h,E):G==="selecting_source"?Qe(h,E):B==="selecting_source"?Te(h,E):!1}function En(){W="idle",nt=null,it=null,Tt=[],Nt=[],qt(),G="idle",se=null,Ce=[],ce=[],P=0,B="idle",A=null,k=[],v=[],rt=0;let h=a.spellBtn;h&&h.classList.remove("selecting")}function He(){return{transmuteState:W,transmuteSourceBlock:nt,transmuteTargetColor:it,transmuteAreaCells:Tt,transmuteBlocksToChange:Nt,lightningState:G,lightningSourceBlock:se,lightningAreaCells:Ce,lightningBlocksToHit:ce,fireState:B,fireSourceBlock:A,fireLineCells:k,fireTargets:v}}return{startTransmuteSourceSelection:ae,cancelTransmutation:x,startLightningSourceSelection:kt,cancelLightning:Rt,startFireSourceSelection:Ke,cancelFire:bt,handleTap:mn,update:Ze,reset:En,getRenderState:He,getTransmuteAnimState:le,getLightningAnimState:kn,getFireAnimState:Ht,handleSpellButtonClick:Sn,isTransmuteSelecting:()=>W==="selecting_source",isLightningSelecting:()=>G==="selecting_source"}}var lc={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Uo(e={}){let{canvas:n}=e,a=e.rotDir||1,d=!1,i=0,s=0,c=0,f=0,p=0,g=1,l=null,m=0,S=0,w=0,z=0,K=0,ct=0,wt=0,he=0,zt=!1,xt=!1,Kt=!1,lt=lc;return{get tapRotateEnabled(){return zt},set tapRotateEnabled(q){zt=q},get rotDir(){return a},set rotDir(q){a=q},get dragging(){return d},get dragMode(){return l},handlePointerDown(q,Ct,It){if(Ct.onMagicTap&&Ct.onMagicTap(q.clientX,q.clientY))return xt=!0,!0;xt=!1,Kt=!1;let At=performance.now(),C=At-ct,Pt=q.clientX-wt,Ft=q.clientY-he,Bt=Math.hypot(Pt,Ft);return C<=lt.DOUBLE_TAP_MS&&Bt<=lt.DOUBLE_TAP_MAX_DIST?(Ct.onDoubleTap&&Ct.onDoubleTap(),Kt=!0,ct=0):(ct=At,wt=q.clientX,he=q.clientY),d=!0,g=-1,i=q.clientX,s=q.clientY,c=It,f=0,p=0,l=null,m=At,S=q.clientX,w=q.clientY,z=m,K=0,n&&n.setPointerCapture(q.pointerId),!1},handlePointerMove(q,Ct,It,At){if(!d)return null;let C=q.clientX-i,Pt=q.clientY-s,Ft=performance.now();if(Math.abs(C)<lt.DEADZONE_PX&&Math.abs(Pt)<lt.DEADZONE_PX)return null;if(l){if(l==="rotate"){let r=Math.abs(C),J=Math.abs(Pt);if(J>=r*lt.AXIS_DOMINANCE&&J>=lt.DROP_SWIPE_MIN_DISTANCE){let tt=Math.max(1,Ft-m);J/tt*1e3>=lt.DROP_SWIPE_MIN_SPEED&&(l="drop",p=0)}}}else{let r=Math.abs(C),J=Math.abs(Pt);if(Pt<0)r>=lt.DEADZONE_PX&&(l="rotate");else if(J>=r*lt.AXIS_DOMINANCE){if(J>=lt.DROP_SWIPE_MIN_DISTANCE){let tt=Math.max(1,Ft-m);J/tt*1e3>=lt.DROP_SWIPE_MIN_SPEED?l="drop":l="rotate"}}else r>=J*lt.AXIS_DOMINANCE&&(l="rotate");if(!l)return null}let Bt=null;if(l==="rotate"&&Math.abs(C)>=lt.DEADZONE_PX){let r=Math.max(1,Ft-z),J=q.clientX-S,tt=Math.max(1,Math.abs(J)/r*1e3),ee=Math.max(lt.MIN_ROT_PX,Math.min(lt.MAX_ROT_PX,lt.PX_PER_STEP*(lt.SWIPE_SPEED_REF/tt)));K+=-J/ee*a*g;let F=Math.trunc(K);F!==0&&(K-=F);let N=f+F;if(N!==f&&Ct.canRotateTo){let at=Math.sign(N-f),$t=c+f;for(;f!==N;){let ie=f+at,W=c+ie;if(!Ct.canRotateTo(Math.floor(It),W))break;f=ie,$t=W,Ct.onRotateStep&&Ct.onRotateStep(),At&&Ct.onGroundedMove&&Ct.onGroundedMove()}Bt={targetRot:$t,rotFloat:$t}}}if(l==="drop"&&Pt>=lt.DROP_SWIPE_MIN_DISTANCE&&Ct.onDrop){let r=Math.max(1,Ft-z),J=q.clientY-w,tt=Math.max(1,J/r*1e3),ee=Math.max(lt.MIN_DROP_PX,Math.min(lt.MAX_DROP_PX,lt.PX_PER_DROP*(lt.SWIPE_SPEED_REF/tt))),F=Math.trunc(Pt/ee);if(F>p){let N=F-p;for(let at=0;at<N;at++)Ct.onDrop();p=F}}return S=q.clientX,w=q.clientY,z=Ft,Bt},handlePointerUp(q,Ct){if(d){if(zt&&!xt&&!Kt&&!l&&Ct?.onSingleTap){let It=Math.abs(q.clientX-i),At=Math.abs(q.clientY-s),C=performance.now()-m;It<lt.DEADZONE_PX&&At<lt.DEADZONE_PX&&C<300&&Ct.onSingleTap()}if(d=!1,l=null,n&&q&&q.pointerId!==void 0)try{n.releasePointerCapture(q.pointerId)}catch{}}},reset(){d=!1,l=null,f=0,p=0,K=0}}}var Fs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Xo(){let e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return a},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,a=performance.now(),d=0,i=0,s=0,c={...Fs}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(f){n+=f},setScore(f){n=f},updateTime(){e==="playing"&&a>0&&(d=performance.now()-a-s)},getFormattedTime(){let f=Math.floor(d/1e3),p=Math.floor(f/60),g=f%60;return`${p}:${g.toString().padStart(2,"0")}`},incrementStat(f,p=1){f in c&&(c[f]+=p)},updateMaxStat(f,p){f in c&&p>c[f]&&(c[f]=p)},reset(){e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs}}}}function In(e,n){return e%=n,e<0&&(e+=n),e}function Yo(e,n){return e[Math.min(n,e.length-1)]}function hs(e){let n=Math.max(0,Math.floor(e/1e3)),a=Math.floor(n/60),d=n%60;return`${a}:${d.toString().padStart(2,"0")}`}function Wo(e,n){let a=e.map(({x:f,y:p},g)=>({x:p,y:-f,color:n[g]})),d=1/0,i=-1/0,s=1/0;for(let f of a)d=Math.min(d,f.x),i=Math.max(i,f.x),s=Math.min(s,f.y);let c=Math.round((d+i)/2);for(let f of a)f.x-=c,f.y-=s;return a.sort((f,p)=>f.y-p.y||f.x-p.x),{cells:a.map(f=>({x:f.x,y:f.y})),colors:a.map(f=>f.color)}}function $s(e,n,a,d){let i=[];return e+1<a&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:In(n-1,d)}),i.push({y:e,s:In(n+1,d)}),i}function Vo(e,n,a){let d=Array.from({length:n},()=>new Uint8Array(a)),i=[];for(let s=0;s<n;s++)for(let c=0;c<a;c++){if(!e[s][c]||d[s][c])continue;let f=[],p=[{y:s,s:c}];for(d[s][c]=1;p.length>0;){let g=p.shift();f.push(g);for(let l of $s(g.y,g.s,n,a))e[l.y][l.s]&&!d[l.y][l.s]&&(d[l.y][l.s]=1,p.push(l))}i.push(f)}return i}function Ko(e){return e.some(n=>n.y===0)}function Ns(e,n,a,d,i,s){if(!e)return!1;let c=In(a,s);for(let f of e.cells){let p=n+f.y,g=In(c+f.x,s);if(p<0)return!1;if(!(p>=i)&&d[p][g])return!1}return!0}function qo(e,n,a,d,i,s){if(!e)return null;let c=Math.floor(n);for(;Ns(e,c-1,a,d,i,s);)c-=1;return c}function zo(e,n,a){let d=[],i=[];for(let s=0;s<n;s++){let c=[],f=0,p=e[s][0],g=p?1:0;for(let l=1;l<=a;l++){let m=l<a?e[s][l]:0;m&&m===p?g++:(g>=1&&p&&c.push({start:f,length:g,color:p}),f=l,p=m,g=m?1:0)}if(c.length>=2){let l=c[0],m=c[c.length-1];if(l.start===0&&m.start+m.length===a&&l.color===m.color){let S=l.length+m.length;c[0]={start:m.start,length:S,color:l.color},c.pop()}}for(let l of c)if(l.length>=3){let m=[];for(let S=0;S<l.length;S++)m.push({y:s,s:(l.start+S)%a});d.push({color:l.color,length:l.length,cells:m})}}for(let s=0;s<a;s++){let c=0,f=e[0][s],p=f?1:0;for(let g=1;g<=n;g++){let l=g<n?e[g][s]:0;if(l&&l===f)p++;else{if(p>=3&&f){let m=[];for(let S=0;S<p;S++)m.push({y:c+S,s});d.push({color:f,length:p,cells:m})}c=g,f=l,p=l?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<a;c++){let f=e[s][c],p=e[s][(c+1)%a],g=e[s][(c+2)%a],l=e[s][(c+3)%a];f&&f===p&&g&&g===l&&f!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%a},{y:s,s:(c+2)%a},{y:s,s:(c+3)%a}]})}for(let s=0;s<a;s++)for(let c=0;c<n-3;c++){let f=e[c][s],p=e[c+1][s],g=e[c+2][s],l=e[c+3][s];f&&f===p&&g&&g===l&&f!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:d,pairMatches:i}}function jo(e,n,a){let d=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<a;c++)if(!e[i][c]){s=!1;break}s&&d.push(i)}return d}function Qo(e,n){let a=new Map;e.forEach((d,i)=>a.set(`${d.x},${d.y}`,n[i]));for(let d=0;d<e.length;d++){let i=e[d],s=n[d],c=1;for(let ct=1;ct<=2&&a.get(`${i.x+ct},${i.y}`)===s;ct++)c++;if(c>=3)return!0;let f=1;for(let ct=1;ct<=2&&a.get(`${i.x},${i.y+ct}`)===s;ct++)f++;if(f>=3)return!0;let p=s,g=a.get(`${i.x+1},${i.y}`),l=a.get(`${i.x+2},${i.y}`),m=a.get(`${i.x+3},${i.y}`);if(p&&g&&l&&m&&p===g&&l===m&&p!==l)return!0;let S=s,w=a.get(`${i.x},${i.y+1}`),z=a.get(`${i.x},${i.y+2}`),K=a.get(`${i.x},${i.y+3}`);if(S&&w&&z&&K&&S===w&&z===K&&S!==z)return!0}return!1}function Zo(e){let{getN:n,getH:a,FALL_INTERVAL:d,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:f,RING_HIGHLIGHT_SEC:p,getState:g,setState:l,funcs:m,ui:S}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(w,z={}){let K=g();if(w==="start_game")return K.gameState!=="playing"?(m.startGame(),!0):!1;if(K.gameState!=="playing")return!1;switch(w){case"rotate_piece":return m.rotatePieceByDir(),!0;case"move_down":return m.tryMoveDown();case"rotate_cylinder":{let{rot:ct}=z;return typeof ct=="number"&&m.canPlaceAtRot(Math.floor(K.pieceY),ct)?(l({targetRot:ct,rotFloat:ct,rotVel:0}),K.isGrounded&&m.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ct,y:wt}=z;return m.shootMagic(ct,wt)}case"select_magic":{let{element:ct}=z;return m.selectMagic(ct),!0}default:return console.warn("GameEngine: unknown command",w),!1}},update(w,z){let K=g();if(K.gameState!=="playing")return;let ct=z-K.startTime-K.totalPausedMs;l({elapsedMs:ct}),S.updateTimeHud();let wt=K.killLevel+s()*w;if(l({killLevel:wt}),S.updateRemainingHud(),wt>=a()){m.endGame();return}if(K.isHighlighting){let xt=(z-K.highlightStartTime)/1e3,Kt;K.isRingAnimation?Kt=p:K.isMagicAnimation?Kt=f:Kt=c,xt>=Kt&&(K.isRingAnimation?m.finishRingHighlight():m.finishHighlight())}let he=K.fallTimer+w;if(he>=d&&(he-=d,m.tryMoveDown()),l({fallTimer:he}),m.updateGroundedState()){let xt=K.lockTimer+w;l({lockTimer:xt}),xt>=i&&m.lockPiece()}},reset(){m.startGame()},canRotateTo(w,z){return m.canPlaceAtRot(w,z)},getRotation(){let w=g();return{targetRot:w.targetRot,rotFloat:w.rotFloat,rotVel:w.rotVel}},setRotation(w){l({targetRot:w,rotFloat:w,rotVel:0})},onGroundedMove(){m.maybeResetLockDelay()}}}var je=Math.PI*2;function Jo(e){let{canvas:n,canvasCtx:a,getN:d,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:f,MAX_RADIUS_X:p,RADIUS_X_FACTOR:g,ANG_OFFSET:l,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:S,MAGIC_SHRINK_SEC:w,RING_HIGHLIGHT_SEC:z,LOCK_DELAY_SEC:K,getKillRate:ct,ELEMENT_COLORS:wt,ELEMENT_TO_COLOR:he,BLOCK_COLOR_FRONT:zt,BLOCK_COLOR_BACK:xt,ACTIVE_COLOR_FRONT:Kt,GHOST_COLOR_FILL:lt,GHOST_COLOR_STROKE:q,GHOST_STROKE_WIDTH:Ct,MAGIC_DIM_DOT_ALPHA:It,MAGIC_DIM_DOT_SCALE:At,MAGIC_TARGET_DOT_SCALE:C,getState:Pt,getVisualSettings:Ft,funcs:Bt}=e,r=a,J=d(),tt=i(),ee={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},F=[],N=40;function at(U,P,B,A,k){let v=Math.max(3,Math.round(U)),rt=180;for(let dt=0;dt<v;dt++)setTimeout(()=>{let et=Math.random()>.5?"left":"right",j=15,L=et==="left"?j+Math.random()*Math.max(10,P-j*2):B+j+Math.random()*Math.max(10,k-B-j*2),M=A-10;F.push({x:L,baseX:L,y:M,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:j,maxX:k-j})},dt*rt)}function $t(U,P,B){F=F.filter(A=>A.y>U+A.size&&A.y>-20);for(let A of F){A.y-=N*B,A.wobble+=A.wobbleSpeed*B;let k=A.baseX+Math.sin(A.wobble)*A.wobbleAmp;A.x=Math.max(A.minX,Math.min(A.maxX,k))}}function ie(U){if(F.length!==0){r.fillStyle="rgba(255, 255, 255, 0.3)",r.strokeStyle="rgba(255, 255, 255, 0.5)",r.lineWidth=1;for(let P of F)P.y<U+P.size||(r.beginPath(),r.arc(P.x,P.y,P.size,0,Math.PI*2),r.fill(),r.stroke())}}let W={left:0,right:0,h:0,w:0};function nt(U,P,B){let A=1-B/tt;return U+A*P}function it(U){return U=U%J,U<0?U+J:U}function Tt(U,P,B,A,k,v){let rt=it(v),dt=(k-rt)/J*je+l;return{x:U+Math.cos(dt)*B,y:P+Math.sin(dt)*A,ang:dt}}let Nt=.52,ne=1.02;function _t(U,P,B,A,k,v){let rt=it(v),dt=(k-rt)/J*je+l;return{x:U+Math.cos(dt)*B,y:P+Math.sin(dt)*A,ang:dt}}function Jt(U,P,B,A,k,v,rt,dt=1){let et=_t(U,P,B,A,k-Nt,v),j=_t(U,P,B,A,k+Nt,v),L={x:et.x,y:et.y-rt*.5},M={x:et.x,y:et.y+rt*.5},R={x:j.x,y:j.y-rt*.5},ae={x:j.x,y:j.y+rt*.5},x=(L.x+R.x+ae.x+M.x)*.25,Qt=(L.y+R.y+ae.y+M.y)*.25,X=ne*dt,ft=dt,We=[L,R,ae,M].map(re=>({x:x+(re.x-x)*X,y:Qt+(re.y-Qt)*ft})),qt=Math.abs((j.x-et.x)*X),St=Math.abs(rt*ft);return{corners:We,cx:x,cy:Qt,wApprox:qt,hApprox:St,ang:_t(U,P,B,A,k,v).ang}}function G(U,P,B,A,k,v,rt,dt,et=1,j=null,L=1,M=null,R=0,ae=1,x=1){let Qt=Jt(U,P,B,A,k,v,rt,x),[X,ft,We,qt]=Qt.corners;if(r.save(),r.globalAlpha=et,r.fillStyle=dt,r.beginPath(),r.moveTo(X.x,X.y),r.lineTo(ft.x,ft.y),r.lineTo(We.x,We.y),r.lineTo(qt.x,qt.y),r.closePath(),r.fill(),M&&R>0&&(r.strokeStyle=M,r.lineWidth=R,r.stroke()),j){let St=Math.min(Qt.wApprox,Qt.hApprox)*.28*ae;r.globalAlpha=et*L,r.fillStyle=j,r.beginPath(),r.arc(Qt.cx,Qt.cy,St,0,je),r.fill()}r.restore(),r.globalAlpha=1}function se(U,P,B,A,k,v){let rt=Tt(U,P,B,A,k,v),dt=Tt(U,P,B,A,k+1,v),et=Tt(U,P,B,A,k-1,v),j=Math.abs(dt.x-rt.x),L=Math.abs(rt.x-et.x),M=(j+L)*.5*1.06;return Math.max(1,M)}function Ce(U,P,B,A,k,v){let rt=(k-v)/J*je+l;return{x:U+Math.cos(rt)*B,y:P+Math.sin(rt)*A,ang:rt}}function ce(U,P,B,A,k,v,rt,dt=1,et=null,j=1,L=null,M=0,R=1){r.save(),r.translate(U,P);let ae=Math.atan2(A,B);if(r.rotate(ae),r.globalAlpha=dt,r.fillStyle=rt,r.fillRect(-k/2,-v/2,k,v),L&&M>0&&(r.strokeStyle=L,r.lineWidth=M,r.strokeRect(-k/2,-v/2,k,v)),et){let x=Math.min(k,v)*.28*R;r.globalAlpha=dt*j,r.fillStyle=et,r.beginPath(),r.arc(0,0,x,0,je),r.fill()}r.restore(),r.globalAlpha=1}return{resize(){let U=Math.max(1,Math.min(2,window.devicePixelRatio||1)),P=Math.floor(n.clientWidth*U),B=Math.floor(n.clientHeight*U);(n.width!==P||n.height!==B)&&(n.width=P,n.height=B,r.setTransform(U,0,0,U,0,0))},render(U=.016,P=performance.now()){this.resize();let B=Pt();J=d(),tt=i();let A=n.clientWidth,k=n.clientHeight;r.clearRect(0,0,A,k),r.fillStyle="#0b0f14",r.fillRect(0,0,A,k);let v=A*.5,rt=(A-2*f)/2,dt=k-s-c,et=6,j=J*dt/(et*tt),L,M,R,ae;ae=k-c,j<=Math.min(rt,p)?(L=j,M=dt,R=s):(L=Math.min(rt,p),M=L*et*tt/J,R=ae-M);let x=L*.28,{killLevel:Qt,rotFloat:X,grid:ft,gameState:We}=B,qt=Ft?Ft():{},St=qt.waterColor||"blue",re=qt.waterBubbles||!1,pn=ee[St]||ee.blue,Dt=nt(R,M,Qt),le=.7,Ve=Qt/tt,kt={...pn.top},Rt={...pn.bottom};if(Ve>le){let T=(Ve-le)/(1-le);kt.r=Math.round(kt.r+(255-kt.r)*T*.5),kt.g=Math.round(kt.g+(150-kt.g)*T*.5),kt.b=Math.round(kt.b+(150-kt.b)*T*.5),Rt.r=Math.round(Rt.r+(180-Rt.r)*T),Rt.g=Math.round(Rt.g*(1-T*.6)),Rt.b=Math.round(Rt.b*(1-T*.6))}let Ke=v-L-8,bt=v+L+8,Qe=R,Te=ae+5,ve=r.createLinearGradient(0,Dt,0,k);ve.addColorStop(0,`rgba(${kt.r},${kt.g},${kt.b},0.5)`),ve.addColorStop(1,`rgba(${Rt.r},${Rt.g},${Rt.b},0.7)`),r.fillStyle=ve;let Pn=Math.round((kt.r+Rt.r)/2),kn=Math.round((kt.g+Rt.g)/2),On=Math.round((kt.b+Rt.b)/2),$=L+8,de=x+4;r.fillRect(0,Dt,Ke,k-Dt),r.fillRect(bt,Dt,A-bt,k-Dt),r.beginPath();let Ht=Math.max(Dt,Te);r.moveTo(Ke,Ht),Dt<=Te+de?r.ellipse(v,Te,$,de,0,Math.PI,0,!1):r.lineTo(bt,Ht),r.lineTo(bt,k),r.lineTo(Ke,k),r.closePath(),r.fill(),r.strokeStyle="rgba(100,180,255,0.6)",r.lineWidth=3,r.lineCap="round",r.beginPath(),r.moveTo(Ke,Qe),r.lineTo(Ke,Te),r.stroke(),r.beginPath(),r.moveTo(bt,Qe),r.lineTo(bt,Te),r.stroke(),r.beginPath(),r.ellipse(v,Te,L+8,x+4,0,0,Math.PI),r.stroke(),r.fillStyle="#0b0f14",r.beginPath(),r.ellipse(v,Te,L+8,x+4,0,0,je),r.fill(),Qt>.5&&(r.strokeStyle=`rgba(${Math.min(255,Pn+60)},${Math.min(255,kn+40)},${Math.min(255,On+40)},0.6)`,r.lineWidth=2,r.beginPath(),r.moveTo(0,Dt),r.lineTo(Ke,Dt),r.moveTo(bt,Dt),r.lineTo(A,Dt),r.stroke()),W={left:Ke,right:bt,h:k,w:A},(F.length>0||re)&&($t(Dt,k,U),ie(Dt)),r.strokeStyle="rgba(160,190,220,0.3)",r.lineWidth=1;let te=je*L,Sn=10,Ze=te/Sn*.7,mn=te/Sn*.3;r.setLineDash([Ze,mn]);let En=te/J;r.lineDashOffset=it(X)*En;for(let T=0;T<=tt;T++){let D=nt(R,M,T);r.beginPath(),r.ellipse(v,D,L,x,0,0,je),r.stroke()}r.setLineDash([]);let He=[],h=[];for(let T=0;T<tt;T++){let D=nt(R,M,T+.5);for(let Q=0;Q<J;Q++){let Y=ft[T][Q];if(!Y)continue;let Z=Tt(v,D,L,x,Q,X),V=Math.sin(Z.ang),I={y:T,s:Q,yScr:D,p:Z,depth:V,color:Y};V<-.1?He.push(I):h.push(I)}}let E=Bt.getMagicTargetColor(),{isHighlighting:b,highlightedCells:ht,highlightStartTime:gt,isMagicAnimation:st}=B,Wt=null,jt=1,ye=1,nn=!1;if(b&&ht.length>0){Wt=new Set(ht.map(D=>`${D.y},${D.s}`));let T=(performance.now()-gt)/1e3;if(st){let D=Math.min(1,T/w);jt=1-D*.85,ye=1-D*.9,nn=!0}else{let D=Math.min(1,T/m),Q=1-S;if(D>Q){let Y=(D-Q)/S;jt=1-Y*.85,ye=1-Y*.9,nn=!0}}}He.sort((T,D)=>T.depth-D.depth);for(let T of He){let D=M/tt*.9,Q=wt[T.color]||null,Y=.35,Z=1,V=`${T.y},${T.s}`;Wt&&Wt.has(V)&&(Y*=ye,Z=jt),G(v,T.yScr,L,x,T.s,X,D,xt,Y,Q,.5,null,0,1,Z)}let{isRingAnimation:ue}=B;if(b&&ht.length>0&&!st){let T=(performance.now()-gt)/1e3,Q=Math.min(1,T/(ue?z:m)),Y=1-S,Z=Q>Y,V=Z?(Q-Y)/S:0,I=ue?Math.floor(Q*Y*J*2)%J:-1,_=4+Q/Y*10,O=Math.sin(T*_*je),pt=Z?1:.3+O*.3,yt=Z?1-V*.8:1,Lt=Z?1-V:1;for(let Et of ht){let Gt=nt(R,M,Et.y+.5),Ae=_t(v,Gt,L,x,Et.s,X);if(Math.sin(Ae.ang)>=-.1)continue;let Mn=M/tt*.9,Se,Ue,Ie;if(ue){let Be=(Et.s-I+J)%J,Pe=Be<3?1-Be/3:0;Se=(Z?Lt:.2+Pe*.5)*.5,Ue=`rgba(255, 159, 67, ${Se})`,Ie=Z?yt:1+Pe*.15}else Se=pt*Lt,Ue=Et.isLine?`rgba(255, 255, 255, ${Se*.5})`:`rgba(255, 220, 100, ${Se*.4})`,Ie=Z?yt:1.1;G(v,Gt,L,x,Et.s,X,Mn,Ue,1,null,1,null,0,1,Ie)}}h.sort((T,D)=>T.depth-D.depth);for(let T of h){let D=M/tt*.9,Q=wt[T.color]||null,Y=1,Z=1,V=1,I=1,_=`${T.y},${T.s}`,O=Wt&&Wt.has(_);O&&(Y=ye,Z=jt),E!==null&&!O&&(T.color!==E?(V=It,I=At):I=C),G(v,T.yScr,L,x,T.s,X,D,zt,Y,Q,V,null,0,I,Z)}if(b&&ht.length>0&&!st){let T=(performance.now()-gt)/1e3,Q=Math.min(1,T/(ue?z:m)),Y=1-S,Z=Q>Y,V=Z?(Q-Y)/S:0,I=ue?Math.floor(Q*Y*J*2)%J:-1,_=4+Q/Y*10,O=Math.sin(T*_*je),pt=Z?1:.5+O*.5,yt=Z?1-V*.8:1,Lt=Z?1-V:1;for(let Et of ht){let Gt=nt(R,M,Et.y+.5),Ae=_t(v,Gt,L,x,Et.s,X);if(Math.sin(Ae.ang)<-.1)continue;let Mn=M/tt*.9,Se,Ue,Ie;if(ue){let Be=(Et.s-I+J)%J,Pe=Be<4?1-Be/4:0;Se=Z?Lt:.3+Pe*.7,Ue=`rgba(255, 159, 67, ${Se})`,Ie=Z?yt:1+Pe*.2}else Se=pt*Lt,Ue=Et.isLine?`rgba(255, 255, 255, ${Se*.7})`:`rgba(255, 220, 100, ${Se*.6})`,Ie=Z?yt:1.15;G(v,Gt,L,x,Et.s,X,Mn,Ue,1,null,1,null,0,1,Ie)}}let rn=B.spellState||B,{transmuteState:_e,transmuteSourceBlock:fe,transmuteTargetColor:Fe,transmuteAreaCells:$e,transmuteBlocksToChange:Je}=rn;if(_e==="selecting_source"){let T=M/tt*.9,D=.35+Math.sin(P/150)*.15;for(let Q of h){let Y=nt(R,M,Q.y+.5);G(v,Y,L,x,Q.s,X,T,`rgba(0, 40, 20, ${D})`,1,null,1,null,0,1,1)}}if(_e==="selecting_target"&&Je&&Je.length>0){let T=M/tt*.9,D=.4+Math.sin(P/120)*.25,Q=.6+Math.sin(P/120)*.4;for(let Y of Je){if(Y.y<0||Y.y>=tt)continue;let Z=nt(R,M,Y.y+.5),V=_t(v,Z,L,x,Y.s,X);Math.sin(V.ang)<-.1||(G(v,Z,L,x,Y.s,X,T,`rgba(0, 50, 30, ${D})`,1,null,1,null,0,1,1),G(v,Z,L,x,Y.s,X,T,"transparent",1,null,1,`rgba(100, 255, 150, ${Q})`,3,1,1.02))}}if(_e==="animating"&&Bt.getTransmuteAnimState){let T=Bt.getTransmuteAnimState(P);if(T){let D=M/tt*.9,{phase:Q,progress:Y,areaFlash:Z}=T;if(Z>0&&$e)for(let V of $e){if(V.y<0||V.y>=tt)continue;let I=nt(R,M,V.y+.5),_=_t(v,I,L,x,V.s,X);Math.sin(_.ang)<-.1||G(v,I,L,x,V.s,X,D,`rgba(150, 255, 200, ${Z*.4})`,1,null,1,null,0,1,1)}if(Je&&Je.length>0){let V=fe?fe.color:1,I=Fe||1;for(let _ of Je){if(_.y<0||_.y>=tt)continue;let O=nt(R,M,_.y+.5),pt=_t(v,O,L,x,_.s,X);if(Math.sin(pt.ang)<-.1)continue;let Lt=1,Et=wt[V],Gt=0;if(Q==="shrink"?(Lt=1-Y*.95,Et=wt[V],Gt=.5+Y*.3):Q==="grow"&&(Lt=Y,Et=wt[I],Gt=.8-Y*.5),Gt>0&&G(v,O,L,x,_.s,X,D,`rgba(200, 255, 220, ${Gt})`,1,null,1,null,0,1,1),Lt>.05){let Ae=Jt(v,O,L,x,_.s,X,D,1),dn=Math.min(Ae.wApprox,Ae.hApprox)*.28*Lt;r.save(),r.globalAlpha=1,r.fillStyle=Et,r.beginPath(),r.arc(Ae.cx,Ae.cy,dn,0,je),r.fill(),r.restore()}}}}}let{lightningState:Re,lightningSourceBlock:tn,lightningAreaCells:ln,lightningBlocksToHit:Zt}=rn;if(Re==="selecting_source"){let T=M/tt*.9,D=.35+Math.sin(P/150)*.15;for(let Q of h){let Y=nt(R,M,Q.y+.5);G(v,Y,L,x,Q.s,X,T,`rgba(20, 20, 60, ${D})`,1,null,1,null,0,1,1)}}if(Re==="animating"&&Bt.getLightningAnimState){let T=Bt.getLightningAnimState(P);if(T&&Zt&&Zt.length>0){let D=M/tt*.9,{phase:Q,flashProgress:Y,currentTarget:Z,jumpProgress:V,struckTargets:I}=T;if(Q==="flash"&&Y>0&&ln)for(let _ of ln){if(_.y<0||_.y>=tt)continue;let O=nt(R,M,_.y+.5),pt=_t(v,O,L,x,_.s,X);Math.sin(pt.ang)<-.1||G(v,O,L,x,_.s,X,D,`rgba(100, 150, 255, ${Y*.5})`,1,null,1,null,0,1,1)}if(I&&I.length>0)for(let _ of I){let O=Zt[_];if(!O||O.y<0||O.y>=tt)continue;let pt=nt(R,M,O.y+.5),yt=_t(v,pt,L,x,O.s,X);if(Math.sin(yt.ang)<-.1)continue;let Et=(I.length-1-I.indexOf(_))*.1,Gt=Math.max(0,.8-Et);G(v,pt,L,x,O.s,X,D,`rgba(255, 255, 255, ${Gt})`,1,null,1,`rgba(150, 200, 255, ${Gt})`,2,1,1.05)}if(Q==="chain"&&Z>=0&&Z<Zt.length){let _=Zt[Z];if(_&&_.y>=0&&_.y<tt){let O=nt(R,M,_.y+.5),pt=_t(v,O,L,x,_.s,X);if(Math.sin(pt.ang)>=-.1){let Lt=1-V;G(v,O,L,x,_.s,X,D,`rgba(200, 220, 255, ${Lt*.9})`,1,null,1,`rgba(100, 180, 255, ${Lt})`,3,1,1.1-V*.05)}}if(Z>0){let O=Zt[Z-1],pt=Zt[Z];if(O&&pt){let yt=nt(R,M,O.y+.5),Lt=nt(R,M,pt.y+.5),Et=Jt(v,yt,L,x,O.s,X,D,1),Gt=Jt(v,Lt,L,x,pt.s,X,D,1);r.save(),r.strokeStyle=`rgba(150, 200, 255, ${1-V*.5})`,r.lineWidth=2+(1-V)*2,r.lineCap="round",r.beginPath();let Ae=Et.cx,dn=Et.cy,Mn=Gt.cx,Se=Gt.cy;r.moveTo(Ae,dn);let Ue=4;for(let Ie=1;Ie<=Ue;Ie++){let Be=Ie/Ue,Pe=Ae+(Mn-Ae)*Be,vs=dn+(Se-dn)*Be,Cn=Ie<Ue?(Math.random()-.5)*8:0;r.lineTo(Pe+Cn,vs+Cn)}r.stroke(),r.strokeStyle=`rgba(100, 150, 255, ${(1-V)*.3})`,r.lineWidth=6,r.stroke(),r.restore()}}}}}let{fireState:hn,fireSourceBlock:Ne,fireLineCells:Le,fireTargets:sn}=rn;if(hn==="selecting_source"){let T=M/tt*.9,D=.3+Math.sin(P/140)*.2;for(let Q of h){let Y=nt(R,M,Q.y+.5);G(v,Y,L,x,Q.s,X,T,`rgba(70, 25, 10, ${D})`,1,null,1,null,0,1,1)}}if(hn==="animating"&&Bt.getFireAnimState){let T=Bt.getFireAnimState(P);if(T&&Le&&Le.length>0){let D=M/tt*.9,{progress:Q,flashProgress:Y}=T,Z=Math.sin(Q*Math.PI);if(Y>0)for(let V of Le){if(V.y<0||V.y>=tt)continue;let I=nt(R,M,V.y+.5),_=_t(v,I,L,x,V.s,X);Math.sin(_.ang)<-.1||G(v,I,L,x,V.s,X,D,`rgba(255, 120, 50, ${Y*.45})`,1,null,1,`rgba(255, 200, 140, ${Y*.5})`,2,1,1.03)}if(Ne){let V=new Map;for(let _ of Le){if(_.y<0||_.y>=tt)continue;let O=nt(R,M,_.y+.5),pt=_t(v,O,L,x,_.s,X);if(Math.sin(pt.ang)<-.1)continue;let Lt=Jt(v,O,L,x,_.s,X,D,1),Et=_.s-Ne.s;Et>J/2&&(Et-=J),Et<-J/2&&(Et+=J);let Gt=_.y;V.has(Gt)||V.set(Gt,[]),V.get(Gt).push({x:Lt.cx,y:Lt.cy,offset:Et})}let I=Array.from(V.keys()).sort((_,O)=>O-_);if(I.length>0){let _=.35+.3*Math.sin(P/60)+Z*.2;r.save(),r.lineCap="round";for(let O of I){let pt=V.get(O)||[];if(pt.sort((yt,Lt)=>yt.offset-Lt.offset),pt.length!==0){r.beginPath(),r.moveTo(pt[0].x,pt[0].y);for(let yt=1;yt<pt.length;yt++)r.lineTo(pt[yt].x,pt[yt].y);r.strokeStyle=`rgba(255, 140, 60, ${_})`,r.lineWidth=Math.max(2,D*.15),r.stroke(),r.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,r.lineWidth=Math.max(6,D*.35),r.stroke()}}r.restore()}}if(sn&&sn.length>0){let V=.2+Z*.6;for(let I of sn){if(I.y<0||I.y>=tt)continue;let _=nt(R,M,I.y+.5),O=_t(v,_,L,x,I.s,X);Math.sin(O.ang)<-.1||G(v,_,L,x,I.s,X,D,`rgba(255, 160, 70, ${V})`,1,null,1,`rgba(255, 230, 180, ${Z*.6})`,2,1,1.05)}}}}let{activePiece:oe,pieceY:bn,isGrounded:we,lockTimer:Ge}=B;if(oe){let T=Bt.snappedRot(),D=T,Q=Bt.computeGhostY(),Y=M/tt*.9;if(Q!==null){let I=[];for(let _=0;_<oe.cells.length;_++){let O=oe.cells[_],pt=oe.colors[_],yt=Q+O.y,Lt=Bt.normSector(T+O.x);if(yt<0||yt>=tt)continue;let Et=nt(R,M,yt+.5),Gt=_t(v,Et,L,x,Lt,D);I.push({cy:yt,cs:Lt,yScr:Et,depth:Math.sin(Gt.ang),color:pt})}I.sort((_,O)=>_.depth-O.depth);for(let _ of I){let O=wt[_.color]||null;G(v,_.yScr,L,x,_.cs,D,Y,lt,1,O,.5,q,Ct,1,1)}}let Z=Kt;if(we&&Ge>0){let I=Math.min(1,Ge/K),_=255,O=Math.round(170+85*I),pt=Math.round(180+75*I),yt=.75+(1-.75)*I;Z=`rgba(${_},${O},${pt},${yt})`}let V=[];for(let I=0;I<oe.cells.length;I++){let _=oe.cells[I],O=oe.colors[I],pt=Bt.normSector(T+_.x),yt=bn+_.y;if(yt<0||yt>=tt)continue;let Lt=nt(R,M,yt+.5),Et=_t(v,Lt,L,x,pt,D);V.push({cs:pt,yScr:Lt,depth:Math.sin(Et.ang),color:O})}V.sort((I,_)=>I.depth-_.depth);for(let I of V){let _=wt[I.color]||null;G(v,I.yScr,L,x,I.cs,D,Y,Z,1,_,1,null,0,1,1)}}},drawNextPreview(U,P){if(!U)return;let B=U.getContext("2d"),A=U.width,k=U.height;if(B.clearRect(0,0,A,k),!P)return;let v=1/0,rt=-1/0,dt=1/0,et=-1/0;for(let x of P.cells)v=Math.min(v,x.x),rt=Math.max(rt,x.x),dt=Math.min(dt,x.y),et=Math.max(et,x.y);let j=rt-v+1,L=et-dt+1,M=Math.min(A/(j+.5),k/(L+.5)),R=(A-j*M)/2,ae=(k-L*M)/2;B.fillStyle=zt;for(let x=0;x<P.cells.length;x++){let Qt=P.cells[x],X=R+(Qt.x-v)*M,ft=ae+(L-1-(Qt.y-dt))*M;B.fillRect(X+1,ft+1,M-2,M-2);let We=P.colors[x],qt=wt[We];if(qt){let St=(M-2)*.32;B.fillStyle=qt,B.beginPath(),B.arc(X+M/2,ft+M/2,St,0,je),B.fill(),B.fillStyle=zt}}},spawnBonusBubbles(U){let{left:P,right:B,h:A,w:k}=W;k>0&&at(U,P,B,A,k)}}}(()=>{let e=Ao(),n=e.canvas,a=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,i=30,s=24,c=120,f={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function p(t){let o=f[t]||f["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let l=Math.PI/2,m=70,S=120,w=30;function z(){let t=document.createElement("div");t.style.cssText="position:fixed;bottom:0;left:0;width:0;height:env(safe-area-inset-bottom,0px);visibility:hidden;pointer-events:none",document.body.appendChild(t);let o=t.offsetHeight;return document.body.removeChild(t),o}let K=z(),ct=S+K;document.documentElement.style.setProperty("--sab",K+"px");let wt=320,he=.42,zt="rgb(235,240,250)",xt="rgb(55,62,75)",Kt="rgba(255,170,180,0.75)",lt="rgba(110,255,150,0.15)",q="rgba(110,255,150,0.85)",Ct=2,It={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},At={1:"fire",2:"water",3:"lightning",4:"earth"},C={fire:1,water:2,lightning:3,earth:4},Pt=1,Ft=.58,Bt=!0,r=12,J=25,tt=1,ee=2,F=3,N=1,at={fire:1,water:1,lightning:1,earth:1},$t=5,ie=7,W=10,nt=3,it=50,Tt=2,Nt=.3,ne=.5,_t=1,Jt=.3,G=.5,se=1.3,Ce=10,ce=1e3,U=[1,1.25,1.5,1.75,2],P=10,B=20,A=5,k=[1,1.3,1.6,2,2.4,2.8],v=[1,1.1,1.2,1.3,1.4,1.5],rt=[1,1.5,2,2.5,3,3.5],dt=[1,1.3,1.6,2,2.4,2.8],et=wo(),j=et.loadGameSettings();j.hapticsEnabled===void 0&&(j.hapticsEnabled=!0);let L=j.invertSwipe?-1:1,M=j.showControls!==!1,R=j.tapRotate===!0,x=!1,Qt=-1,X=Ho({enabled:j.hapticsEnabled}),ft=Array.from({length:s},()=>new Uint8Array(i));function We(){ft=Array.from({length:s},()=>new Uint8Array(i))}let qt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],St=null,re=s+3,pn=0,Dt=0,le=!1,Ve=0,kt=0,Rt=0,Ke=3,bt=0,Qe=0,Te=0,ve=Uo({canvas:n,rotDir:L}),Pn="0.17.4",kn=!0,On="blue",$=To();$.preload();let de=Xo(),Ht="intro",te=0,Sn=0,Ze=0,mn=0,En=0,He=null,h=de.stats,E=0,b=e.overlay,ht=e.gameContainer,gt=Po({elementColors:It}),st=gt.showBonus.bind(gt),Wt=gt.getElementIcon.bind(gt),jt=ko(),ye=e.overlayTitle,nn=e.overlayStats,ue=e.startBtn,rn=e.hud,_e=e.scoreHud,fe=e.timeHud,Fe=e.remainingHud,$e=e.nextCanvas,Je=$e.getContext("2d"),Re=e.pauseBtn,tn=e.pauseOverlay,ln=e.resumeBtn,Zt=e.restartBtn,hn=e.exitToMenuBtn,Ne=e.pauseSettingsBtn,Le=e.pauseSoundBtn,sn=e.pauseMusicBtn,oe=e.pauseBestScore,bn=e.pauseBestTime,we=e.pauseBestMode,Ge=e.pauseCurrentScore,T=e.pauseCurrentTime,D=e.pauseCurrentMode,Q=e.confirmDialog,Y=e.confirmText,Z=e.confirmCancel,V=e.confirmOk,I=e.settingsOverlay,_=e.settingsClose,O=e.fullscreenBtn,pt=e.rotateBtn,yt=e.startPanel,Lt=e.gameoverPanel,Et=e.goScore,Gt=e.goTime,Ae=e.goRing,dn=e.goMatches,Mn=e.goBonuses,Se=e.goNewRecord,Ue=e.goRestartBtn,Ie=e.goExitBtn,Be=e.bestScore,Pe=e.bestTimeVal,vs=e.startVersion,Cn=e.modeBtns,ti=e.recordsBtn,ei=e.startSettingsBtn,ni=e.helpBtn;Do({helpBtn:ni});let Ee="25_20";function si(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function oi(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,y=f[u];if(!y)return;let H=o.querySelector(".mode-tag.time-tag");if(!H)return;let ot=si(y.survivalTime);ot&&(H.textContent=ot)})}oi();let ut=Fo({buttons:e.magicBtns,onActivate:()=>$.play("spells"),onChange:(t,o)=>{Es()}}),Tn=e.magicBtns,uc=ut.charges,ii=t=>ke()?ut.select(t):!1,Dn=()=>ut.updateButtons(),Gs=e.magicRow,Vt=e.magicActiveIndicator,Us=e.magicActiveIcon,Xs=e.magicActiveCost,ci={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ys={fire:"fire",water:"ice",lightning:"air",earth:"earth"},ai=["ice","earth","air","fire"];E=et.loadHighTowerRings();function Hn(t){return typeof ge?.getUnlockRings=="function"?ge.getUnlockRings(t):0}function qn(t){let o=Hn(t);return o===0||E>=o}let Ys=["fire","water","lightning","earth"],_n=null,zn=!1,ri=500,li=30,di=220,Ln=null,Ss=null,Ws={fire:!1,water:!1,lightning:!1,earth:!1};function Vs(){if(!Vt)return;let t=Vt.getBoundingClientRect();t.width>0&&t.height>0&&(Ss=t)}function ui(){if(!Vt)return null;let t=Vt.getBoundingClientRect();return t.width>0&&t.height>0?Vt:Ss?{getBoundingClientRect:()=>Ss}:null}function Fn(t=ut.active){if(!Vt||!Us)return;t?(_n=t,zn=!1):zn||(_n=null);let o=_n;if(!o||!ke()||(ut.charges[o]??0)<=0){Vs(),Vt.classList.add("hidden"),Vt.classList.remove("active","ult-ready",...Ys),Vt.style.setProperty("--progress","0%"),Ln&&clearTimeout(Ln),Ln=setTimeout(()=>{Vt.classList.add("gone")},di);return}Ln&&(clearTimeout(Ln),Ln=null),Vt.classList.remove("gone"),Vt.classList.contains("hidden")?requestAnimationFrame(()=>Vt.classList.remove("hidden")):Vt.classList.remove("hidden"),Us.textContent=Wt(o);let y=ys[o];y&&ge.selectSpell(y);let H=y?Nn(y):0,ot=ut.charges[o]??0,vt=!!y&&Zn()&&qn(y),Ut=!!y&&Zn()&&!vt,pe=vt&&H>0?Math.min(ot/H,1):0,Oe=vt&&H>0,Xe=Oe&&ot>=H;Xs&&(Xs.textContent=Oe?`-${H}`:Ut?"\u{1F512}":""),Vt.classList.toggle("no-cost",!Oe&&!Ut),Vt.classList.toggle("locked",Ut),Vt.classList.toggle("ult-ready",Xe),Vt.style.setProperty("--progress",`${Math.round(pe*100)}%`),Vt.classList.remove("hidden",...Ys),Vt.classList.add("active",o),Vs()}function fi(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),ri))}function jn(){for(let[t,o]of Object.entries(Tn)){if(!o)continue;let u=ys[t],y=Nn(u),H=Zn()&&ke()&&u,ot=typeof qn=="function"?qn(u):!0,vt=H&&ot&&y>0&&(ut.charges[t]??0)>=y;o.classList.toggle("ult-ready",vt),vt&&!Ws[t]&&(fi(o),Ht==="playing"&&$.play("readysuper")),Ws[t]=vt}}function ke(t=Ee){return t==="30_24"?!0:x}function Es(){Fn(ut.active),jn()}function fc(t){x=t,Ee==="25_20"&&(x?ut.reset():(ut.deactivate(),Object.keys(ut.charges).forEach(o=>{ut.charges[o]=0})),Dn()),Qn(),Es()}function Qn(){Gs&&(Gs.style.display=ke()?"":"none",Fn(ut.active),jn())}function gc(t){let o=Bn(t),u=Nn(t);return!o||u<=0?!1:ut.charges[o]>=u}function pc(t){let o=Bn(t),u=Nn(t);return!o||u<=0||ut.charges[o]<u?!1:(ut.charges[o]-=u,ut.updateButtons(),ge.pulse(),!0)}let $n=e.spellWave;function gi(){$n&&($n.classList.remove("active"),$n.offsetWidth,$n.classList.add("active"),setTimeout(()=>$n.classList.remove("active"),1200))}let un=null,ge=$o({button:Vt,onReady:()=>{$.play("readysuper")}}),pi=()=>ge.getEffect("earth"),mi=()=>ge.getEffect("air"),hi=()=>ge.getEffect("fire"),Nn=t=>typeof ge?.getCost=="function"?ge.getCost(t):0,Bn=t=>ci[t]??null;un=Go({canvas:n,dom:e,getGrid:()=>ft,getN:()=>i,getH:()=>s,getRotFloat:()=>bt,constants:{TOP_PAD_PX:m,BOTTOM_PAD_PX:ct,SIDE_MARGIN_PX:w,MAX_RADIUS_X:wt,SCORE_MAGIC_DESTROY:A},helpers:{normSector:ss,levelYToScreenY:ts,sectorCenterXY:es},Spell:ge,Magic:ut,SoundModule:$,State:de,isGamePlaying:()=>Ht==="playing",addPendingKzDrop:t=>{Rt+=t},getKillRate:g,triggerSpellWave:gi,spawnSpellBubbles:t=>{let o=Bn(ge.currentSpell)??"water";jt.spawnSpellBubbles(ge.button,o,t)},spawnBonusBubbles:t=>{An.spawnBonusBubbles(t)},getTransmuteEffect:pi,getLightningEffect:mi,getFireEffect:hi,continueMatchProcessing:ns,updateScoreHud:Yn,showBonus:st,getSpellCost:Nn,getSpellElement:Bn,onUltimateApplied:t=>{let o=Bn(t)??Bn(ge.currentSpell)??"water";if(typeof jt?.spawnSpellBubbles=="function"){let u=ui();u&&jt.spawnSpellBubbles(u,o,li)}zn=!1,_n=null,Fn(null),jn()},isSpellBlocked:vi,setScore:t=>{te=t},setCascadeLevel:t=>{an=t}});function Zn(){return Ee==="30_24"}function Jn(){Fn(ut.active),jn()}let fn=[],Gn=0,on=!1,vn=!1,Rn=!1,qe=0,cn=0,an=0,wn=[];function vi(){return on||vn||Rn}function ts(t,o,u){let y=1-u/s;return t+y*o}function es(t,o,u,y,H,ot){let vt=(H-ot)/i*d+l;return{x:t+Math.cos(vt)*u,y:o+Math.sin(vt)*y,ang:vt}}function bs(t,o){let u=n.clientWidth,y=n.clientHeight,H=u*.5,ot=(u-2*w)/2,vt=y-m-ct,Ut=6,pe=i*vt/(Ut*s),Oe=y-ct,Xe,be,me;pe<=Math.min(ot,wt)?(Xe=pe,be=vt,me=m):(Xe=Math.min(ot,wt),be=Xe*Ut*s/i,me=Oe-be);let Xt=Xe*.28,Mt=ts(me,be,t+.5),mt=es(H,Mt,Xe,Xt,o,bt),Yt=n.getBoundingClientRect();return{x:Yt.left+mt.x,y:Yt.top+mt.y}}function yi(t,o){if(!ke()||!ut.canUse()||on)return!1;let u=C[ut.active],y=n.clientWidth,H=n.clientHeight,ot=y*.5,vt=(y-2*w)/2,Ut=H-m-ct,pe=6,Oe=i*Ut/(pe*s),Xe=H-ct,be,me,Xt;Oe<=Math.min(vt,wt)?(be=Oe,me=Ut,Xt=m):(be=Math.min(vt,wt),me=be*pe*s/i,Xt=Xe-me);let Mt=be*.28,mt=null,Yt=1/0;for(let Me=0;Me<s;Me++){let De=ts(Xt,me,Me+.5);for(let xe=0;xe<i;xe++){let Ye=ft[Me][xe];if(!Ye||Ye!==u)continue;let ze=es(ot,De,be,Mt,xe,bt);if(Math.sin(ze.ang)<-.1)continue;let gs=t-ze.x,Eo=o-ze.y,bo=Math.hypot(gs,Eo),Mo=me/s*.9,zi=Mo*1.2;Math.abs(gs)<zi/2&&Math.abs(Eo)<Mo/2&&bo<Yt&&(Yt=bo,mt={y:Me,s:xe})}}if(mt){let Me=ts(Xt,me,mt.y+.5),De=es(ot,Me,be,Mt,mt.s,bt),xe=n.getBoundingClientRect(),Ye=xe.left+De.x,ze=xe.top+De.y,So=Tn[ut.active];return jt.spawnMagicShot(ut.active,So,Ye,ze,()=>{let gs=ft[mt.y][mt.s];fn=[{y:mt.y,s:mt.s,color:gs,isLine:!1,isMagic:!0}],Gn=performance.now(),on=!0,vn=!0,qe=0,cn=A,st(`+${A}`,"score")}),an=0,ut.useCharge(),h.magicUsed++,!0}return!1}let mc=100;function hc(t,o){return $s(t,o,s,i)}function Si(){return Vo(ft,s,i)}let Ei=Ko;function bi(t){let o=t.map(y=>({...y,color:ft[y.y][y.s]}));for(let y of t)ft[y.y][y.s]=0;let u=s;for(let y of t){let H=y.y;for(let ot=1;ot<=y.y;ot++){let vt=y.y-ot;if(ft[vt][y.s]){H=ot-1;break}}u=Math.min(u,H)}for(let y of o)ft[y.y-u][y.s]=y.color;return u>0}function Mi(){let t=!0;for(;t;){t=!1;let o=Si();for(let u of o)Ei(u)||bi(u)&&(t=!0)}}function xi(){ns()}let Un=Yo;function Ks(t,o){let u=new Map,y=0,H=0,ot=0,vt={},Ut=t.length+o.length;for(let Mt of t){let mt=At[Mt.color],Yt=0,Me=0;if(Mt.length>=5?(Yt=F,Me=W,h.lines5++):Mt.length===4?(Yt=ee,Me=ie,h.lines4++):Mt.length===3&&(Yt=tt,Me=$t,h.lines3++),ke()&&mt&&Yt>0){ut.addCharges(mt,Yt),vt[mt]=(vt[mt]||0)+Yt;let De=Mt.cells[Math.floor(Mt.cells.length/2)],xe=bs(De.y,De.s),Ye=Tn[mt];for(let ze=0;ze<Yt;ze++)setTimeout(()=>{jt.spawnMagicOrb(mt,xe.x,xe.y,Ye)},ze*100)}y+=Me*g(),ot+=Me,H+=Mt.length*P;for(let De of Mt.cells){let xe=`${De.y},${De.s}`;u.has(xe)||u.set(xe,{y:De.y,s:De.s,color:Mt.color,isLine:!0})}}for(let Mt of o){if(h.pairs++,y+=nt*g(),ot+=nt,H+=B,ke()){let mt=[...new Set(Mt.cells.map(Yt=>ft[Yt.y][Yt.s]).filter(Boolean))];if(mt.length>0){let Yt=Mt.cells[Math.floor(Mt.cells.length/2)],Me=bs(Yt.y,Yt.s);mt.forEach((De,xe)=>{let Ye=At[De];if(!Ye)return;ut.addCharges(Ye,N),vt[Ye]=(vt[Ye]||0)+N;let ze=Tn[Ye];ze&&setTimeout(()=>{jt.spawnMagicOrb(Ye,Me.x,Me.y,ze)},xe*100)})}}for(let mt of Mt.cells){let Yt=`${mt.y},${mt.s}`;u.has(Yt)||u.set(Yt,{y:mt.y,s:mt.s,color:ft[mt.y][mt.s],isLine:!1})}}let pe=Un(k,Ut-1),Oe=Un(v,Ut-1),Xe=Un(rt,an),be=Un(dt,an),me=Math.round(H*pe*Xe);ot=Math.round(ot*Oe*be),y=Math.round(y*Oe*be);let Xt=0;Ut>1&&(h.combos++,h.maxCombo=Math.max(h.maxCombo,Ut),setTimeout(()=>st(`COMBO \xD7${Ut}`,"combo"),Xt),Xt+=180,$.play("combo2")),an>0&&(h.cascades++,h.maxCascade=Math.max(h.maxCascade,an),setTimeout(()=>st(`CASCADE \xD7${an}`,"cascade"),Xt),Xt+=180,$.play("cascade")),(t.length>0||o.length>0)&&$.play("combo");for(let Mt of t){let mt=Mt.length,Yt=mt*P;setTimeout(()=>st(`Line-${mt} +${Yt}`,"line",Mt.color),Xt),Xt+=100}for(let Mt of o){let mt=Mt.cells.length>0?ft[Mt.cells[0].y][Mt.cells[0].s]:null;setTimeout(()=>st(`Pair +${B}`,"pair",mt),Xt),Xt+=100}me>0&&(setTimeout(()=>st(`+${me}`,"score"),Xt),Xt+=120),ot>0&&(setTimeout(()=>st(`+${ot}s`,"time"),Xt),Xt+=120);for(let[Mt,mt]of Object.entries(vt))mt>0&&(setTimeout(()=>st(`+${mt}${Wt(Mt)}`,"charge"),Xt),Xt+=120);fn=Array.from(u.values()),Gn=performance.now(),on=!0,vn=!1,qe=y,cn=me,Dn()}function Ci(){for(let t of fn)ft[t.y][t.s]=0;if(fn.length>0&&$.playRandom("disappear"),qe>0){Rt+=qe;let t=qe/g();An.spawnBonusBubbles(t)}de.addScore(cn),te+=cn,Yn(),fn=[],on=!1,vn=!1,qe=0,cn=0,an++,ns()}function ns(){Mi();let{lineMatches:t,pairMatches:o}=ki();if(t.length>0||o.length>0)Ks(t,o);else{let u=Js();u.length>0?Ai(u):!St&&Ht==="playing"&&Zs()}}function vc(t,o){Ks(t,o)}function ss(t){return In(t,i)}function os(){return ss(Math.round(bt))}function qs(t,o){return Ns(St,t,o,ft,s,i)}function is(t){return qs(t,os())}let cs=Wo;function zs(){Bt&&(r!==0&&Ve>=r||(Dt=0,Ve+=1))}function Ti(){if(!St)return;let t=St.cells,o=St.colors,u={cells:t,colors:o};if(Qt>=0||(u=cs(u.cells,u.colors),u=cs(u.cells,u.colors)),u=cs(u.cells,u.colors),St.cells=u.cells,St.colors=u.colors,!is(Math.floor(re))){St.cells=t,St.colors=o;return}$.play("turn"),le&&zs()}function _i(){return qo(St,re,os(),ft,s,i)}function Li(){if(!St)return!1;let t=Math.floor(re)-1,o=!is(t);return o&&!le?(le=!0,Dt=0,Ve=0):!o&&le&&(le=!1,Dt=0,Ve=0),o}let xn=hs;function Xn(){if(Ht==="playing"){b.classList.add("hidden"),Re.classList.remove("hidden");return}if(b.classList.remove("hidden"),Re.classList.add("hidden"),Ht==="intro"){yt.classList.remove("hidden"),Lt.classList.add("hidden");let t=et.loadHighscore(Ee);t.score>0?(Be.textContent=t.score.toLocaleString(),Pe.textContent=xn(t.time)):(Be.textContent="0",Pe.textContent="0:00"),Ps(),vs.textContent=`v${Pn}`,ue.classList.remove("idlePulse"),ue.offsetWidth,ue.classList.add("idlePulse")}else{yt.classList.add("hidden"),Lt.classList.remove("hidden"),Et.textContent=te.toLocaleString(),Gt.textContent=xn(Ze);let t=et.loadHighscore(Ee);te>0&&te>=t.score?Se.classList.remove("hidden"):Se.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${h.rings}</span>
          <span class="count ring-max">${h.maxRing>0?"max \xD7"+h.maxRing:""}</span>
        </div>
      `;Ae.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${h.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${h.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${h.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${h.pairs}</span>
        </div>
      `;dn.innerHTML=u;let y=ke()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${h.magicUsed}</span>
        </div>
      `:"",H=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${h.combos}</span>
          <span class="count max-combo">${h.maxCombo>0?"max \xD7"+h.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${h.cascades}</span>
          <span class="count max-cascade">${h.maxCascade>0?"max \xD7"+h.maxCascade:""}</span>
        </div>
        ${y}
      `;Mn.innerHTML=H}}function Yn(){_e.textContent=`Score: ${te}`}function Ms(){fe.textContent=`Time: ${xn(Ze)}`}function js(){let t=Math.max(0,(s-kt)/g()),o=Math.floor(t/60),u=Math.floor(t%60);Fe.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?Fe.classList.add("warning"):Fe.classList.remove("warning")}function Bi(){p(Ee),We(),kt=0,Rt=0,bt=Qe=0,Te=0,de.start(),h=de.stats,te=0,Sn=performance.now(),Ze=0,En=0,mn=0,Ht="playing",He=null,ke()?ut.reset():(ut.deactivate(),Object.keys(ut.charges).forEach(t=>{ut.charges[t]=0}),Dn()),ge.reset(),Jn(),fn=[],wn=[],on=!1,vn=!1,Rn=!1,qe=0,cn=0,an=0,un.reset(),Dn(),Yn(),Ms(),js(),Es(),Zs(),An.drawNextPreview($e,He),Xn(),$.getSettings().musicEnabled&&$.startGameMusic()}function xs(){de.gameOver(),Ht="gameover",St=null,le=!1,Dt=0,Ve=0;let t=et.saveHighscore(te,Ze,Ee);$.stopMusic(),$.play("gameover"),Ms(),Xn(),t&&te>0&&setTimeout(()=>{st("\u{1F3C6} NEW RECORD!","score")},500)}function Ri(t){for(let u=0;u<50;u++){let y=t.map(()=>1+(Math.random()*4|0));if(!wi(t,y))return y}return t.map((u,y)=>1+y%4)}let wi=Qo;function Qs(t){let o=t.cells.map(y=>({x:y.x,y:y.y})),u=Ri(o);return{name:t.name,cells:o,colors:u}}function Zs(){if(!He){let H=qt[Math.random()*qt.length|0];He=Qs(H)}St=He;let t=qt[Math.random()*qt.length|0];He=Qs(t),An.drawNextPreview($e,He);let o=1/0,u=-1/0;for(let H of St.cells)H.x<o&&(o=H.x),H.x>u&&(u=H.x);let y=(o+u)/2;for(let H of St.cells)H.x=H.x-Math.round(y);re=s+3,pn=0,le=!1,Dt=0,Ve=0,is(Math.floor(re))?$.playRandom("appear"):xs()}function Js(){return jo(ft,s,i)}function Ai(t){if(t.length===0)return;let o=[];for(let Ut of t)for(let pe=0;pe<i;pe++)o.push({y:Ut,s:pe,color:ft[Ut][pe],isLine:!1});wn=t,fn=o,Gn=performance.now(),on=!0,Rn=!0,vn=!1;let u=t.length;h.rings+=u,h.maxRing=Math.max(h.maxRing,u);let y=Un(U,u-1),H=Math.round(ce*u*y),ot=it*u;if(cn=H,qe=ot*g(),ke()){for(let[Ut,pe]of Object.entries(at))if(pe>0){let Oe=pe*u;ut.addCharges(Ut,Oe);let Xe=Math.floor(i/2),be=t[0],me=bs(be,Xe),Xt=Tn[Ut];if(Xt)for(let Mt=0;Mt<Oe;Mt++)setTimeout(()=>{jt.spawnMagicOrb(Ut,me.x,me.y,Xt)},Mt*100)}}$.play("ring");let vt=`RING \xD7${u}`;st(vt,"ring"),setTimeout(()=>st(`+${H}`,"score"),150),setTimeout(()=>st(`+${ot}s`,"time"),300)}function Ii(){let t=[...wn].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<s-1;u++)ft[u].set(ft[u+1]);ft[s-1].fill(0)}if(qe>0){Rt+=qe;let o=qe/g();An.spawnBonusBubbles(o)}de.addScore(cn),te+=cn,Yn(),Ee==="30_24"&&wn.length>0&&(E=et.addHighTowerRings(wn.length)),fn=[],wn=[],on=!1,Rn=!1,qe=0,cn=0,ns()}function yc(){return Js().length}function Pi(){if(!St)return;let t=os();bt=t,Qe=t,Te=0;let o=!1;for(let u=0;u<St.cells.length;u++){let y=St.cells[u],H=St.colors[u],ot=Math.floor(re)+y.y,vt=ss(t+y.x);ot>=s&&(o=!0),ot>=0&&ot<s&&(ft[ot][vt]=H)}if(o){xs();return}de.addScore(Ce),te+=Ce,Yn(),st(`+${Ce}`,"score"),$.playRandom("drop"),St=null,an=0,xi()}function ki(){return zo(ft,s,i)}function Oi(){if(!St)return!1;let t=Math.floor(re)-1;return is(t)?(re=t,le=!1,Dt=0,Ve=0,!0):(le=!0,!1)}n.addEventListener("pointerdown",t=>{if(Ot.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),u=t.clientX-o.left,y=t.clientY-o.top;ve.handlePointerDown(t,{onMagicTap:ke()?()=>un.handleTap(u,y)?!0:Ot.applyCommand("magic_shoot",{x:u,y}):null,onDoubleTap:()=>Ot.applyCommand("rotate_piece")},Qe)||(Te=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Ot.state!=="playing"||!ve.dragging)return;t.preventDefault?.();let o=ve.handlePointerMove(t,{canRotateTo:(u,y)=>Ot.canRotateTo(u,y),onDrop:()=>Ot.applyCommand("move_down"),onGroundedMove:()=>Ot.onGroundedMove(),onRotateStep:()=>X.trigger("tower_rotate")},Ot.pieceY,Ot.isGrounded);o&&Ot.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Ot.state==="playing"&&ve.handlePointerUp(t,{onSingleTap:()=>Ot.applyCommand("rotate_piece")})},{passive:!1}),n.addEventListener("pointercancel",t=>{ve.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ve.dragging&&ve.handlePointerUp(t)},{passive:!1}),pt.addEventListener("click",()=>{Ot.state==="playing"&&Ot.applyCommand("rotate_piece")});let as=e.dropBtn,rs=null;function Di(){Ot.state==="playing"&&(Ot.applyCommand("move_down"),rs=setInterval(()=>{if(Ot.state!=="playing"){ls();return}Ot.applyCommand("move_down")},J))}function ls(){rs&&(clearInterval(rs),rs=null)}as.addEventListener("pointerdown",t=>{t.preventDefault(),Di()}),as.addEventListener("pointerup",ls),as.addEventListener("pointerleave",ls),as.addEventListener("pointercancel",ls);for(let[t,o]of Object.entries(Tn))o.addEventListener("click",()=>{Ot.state==="playing"&&ke()&&Ot.applyCommand("select_magic",{element:t})});Vt&&Vt.addEventListener("click",()=>{if(Ot.state!=="playing"||!Zn()||!ke())return;let t=ut.active??_n;if(!t)return;let o=ys[t];!o||!qn(o)||(ge.selectSpell(o),ut.active&&(_n=ut.active,zn=!0,ut.deactivate()),un.handleSpellButtonClick())});let Cs=e.soundsToggle,Ts=e.musicToggle;function yn(){let t=$.getSettings();t.soundsEnabled?Cs.classList.add("active"):Cs.classList.remove("active"),t.musicEnabled?Ts.classList.add("active"):Ts.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],y=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),y&&y.classList.toggle("active",t.musicVolume===o)}}let to=e.tabBtns,Hi=e.tabContents;to.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;to.forEach(u=>u.classList.remove("active")),Hi.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Io(o).classList.add("active"),o==="sounds"&&yn()})});let eo=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,no=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Fi=e.iosHint,$i=e.standaloneBadge;function so(){let t=document.fullscreenElement||document.webkitFullscreenElement;O.textContent=t?"Disable":"Enable"}eo&&(no?($i.style.display="block",O.style.display="none"):(Fi.style.display="block",O.textContent="Not supported",O.style.opacity="0.5",O.style.cursor="default")),O.addEventListener("click",()=>{if(eo&&!no)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",so),document.addEventListener("webkitfullscreenchange",so);let ds=e.invertSwipeToggle,gn=e.hapticsToggle;j.invertSwipe&&ds.classList.add("active"),gn&&(X.supports()?j.hapticsEnabled&&gn.classList.add("active"):(gn.classList.add("disabled"),gn.classList.remove("active"),j.hapticsEnabled=!1,X.setEnabled(!1),et.saveGameSettings(j))),ds.addEventListener("click",()=>{ds.classList.toggle("active");let t=ds.classList.contains("active");ve.rotDir=t?-1:1,j.invertSwipe=t,et.saveGameSettings(j)}),gn&&gn.addEventListener("click",()=>{if(gn.classList.contains("disabled"))return;gn.classList.toggle("active");let t=gn.classList.contains("active");j.hapticsEnabled=t,et.saveGameSettings(j),X.setEnabled(t)});let Wn=e.showControlsToggle,Ni=e.controlsRight;function oo(t){Ni.style.display=t?"":"none",M=t}M?Wn.classList.add("active"):Wn.classList.remove("active"),oo(M),Wn.addEventListener("click",()=>{Wn.classList.toggle("active");let t=Wn.classList.contains("active");oo(t),j.showControls=t,et.saveGameSettings(j)});let us=e.tapRotateToggle;R&&us.classList.add("active"),ve.tapRotateEnabled=R,us.addEventListener("click",()=>{us.classList.toggle("active");let t=us.classList.contains("active");R=t,ve.tapRotateEnabled=t,j.tapRotate=t,et.saveGameSettings(j)}),Cs.addEventListener("click",()=>{let o=!$.getSettings().soundsEnabled;$.updateSettings({soundsEnabled:o}),yn(),Vn()}),Ts.addEventListener("click",()=>{let o=!$.getSettings().musicEnabled;$.updateSettings({musicEnabled:o}),yn(),Vn(),Ht!=="paused"&&(o?Ht==="playing"?$.startGameMusic():$.startMenuMusic():$.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{$.updateSettings({soundVolume:t}),yn(),$.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{$.updateSettings({musicVolume:t}),yn()})}yn();function io(){Ht==="playing"&&(de.pause(),mn=performance.now(),Ht="paused",$.musicAudio&&$.musicAudio.pause())}function fs(){Ht==="paused"&&(de.resume(),En+=performance.now()-mn,mn=0,Ht="playing",Bs=performance.now(),$.getSettings().musicEnabled&&$.startGameMusic())}function Vn(){let t=$.getSettings();Le.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Le.classList.toggle("off",!t.soundsEnabled),sn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",sn.classList.toggle("off",!t.musicEnabled)}function Gi(){tn.classList.remove("hidden"),Re.classList.add("hidden");let t=et.loadHighscore(Ee);if(oe.textContent=t.score?t.score.toLocaleString():"0",bn.textContent=t.time?hs(t.time):"0:00",we.textContent=Ee==="30_24"?"High Tower":"Quick Tower",Ge.textContent=te.toLocaleString(),T.textContent=hs(Ze),D.textContent=Ee==="30_24"?"High Tower":"Quick Tower",Vn(),uo){let o=Ee==="30_24";uo.style.display=o?"":"none",o&&Ps()}}function Kn(){tn.classList.add("hidden"),Re.classList.remove("hidden")}Re.addEventListener("click",()=>{io(),Gi()}),ln.addEventListener("click",()=>{Kn(),fs()});let _s=null;function co(t,o){Y.textContent=t,_s=o,Q.classList.remove("hidden")}function ao(){Q.classList.add("hidden"),_s=null}Z.addEventListener("click",()=>{ao()}),V.addEventListener("click",()=>{let t=_s;ao(),t&&t()}),Zt.addEventListener("click",()=>{co("Restart game?",()=>{Kn(),Ot.applyCommand("start_game")})}),hn.addEventListener("click",()=>{co("Exit to menu?",()=>{Kn(),Re.classList.add("hidden"),Ht="intro",de.reset(),$.stopMusic(),$.getSettings().musicEnabled&&$.startMenuMusic(),Xn()})}),Ne.addEventListener("click",()=>{I.classList.remove("hidden")}),Le.addEventListener("click",()=>{let t=$.getSettings();$.updateSettings({soundsEnabled:!t.soundsEnabled}),Vn(),yn()}),sn.addEventListener("click",()=>{let o=!$.getSettings().musicEnabled;$.updateSettings({musicEnabled:o}),Vn(),yn()}),tn.addEventListener("click",t=>{t.target===tn&&(Kn(),fs())}),document.addEventListener("keydown",t=>{Ht==="paused"&&!tn.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Kn(),fs())}),_.addEventListener("click",()=>{I.classList.add("hidden")}),I.addEventListener("click",t=>{t.target===I&&I.classList.add("hidden")});let Ls=!1;document.addEventListener("visibilitychange",()=>{document.hidden?Ht==="playing"&&(io(),Ls=!0):Ls&&Ht==="paused"&&(fs(),Ls=!1)});let Ot=Zo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Pt,LOCK_DELAY_SEC:Ft,getKillRate:g,MATCH_HIGHLIGHT_SEC:Tt,MAGIC_SHRINK_SEC:ne,RING_HIGHLIGHT_SEC:_t,getState:()=>({gameState:Ht,score:te,elapsedMs:Ze,startTime:Sn,totalPausedMs:En,stats:h,activePiece:St,pieceY:re,targetRot:Qe,rotFloat:bt,rotVel:Te,isGrounded:le,isHighlighting:on,isMagicAnimation:vn,isRingAnimation:Rn,highlightStartTime:Gn,killLevel:kt,grid:ft,fallTimer:pn,lockTimer:Dt}),setState:t=>{"elapsedMs"in t&&(Ze=t.elapsedMs),"killLevel"in t&&(kt=t.killLevel),"fallTimer"in t&&(pn=t.fallTimer),"lockTimer"in t&&(Dt=t.lockTimer),"targetRot"in t&&(Qe=t.targetRot),"rotFloat"in t&&(bt=t.rotFloat),"rotVel"in t&&(Te=t.rotVel)},funcs:{startGame:Bi,endGame:xs,rotatePieceByDir:Ti,tryMoveDown:Oi,canPlaceAtRot:qs,maybeResetLockDelay:zs,shootMagic:yi,selectMagic:ii,updateGroundedState:Li,lockPiece:Pi,finishHighlight:Ci,finishRingHighlight:Ii},ui:{updateTimeHud:Ms,updateRemainingHud:js}}),An=Jo({canvas:n,canvasCtx:a,getN:()=>i,getH:()=>s,TOP_PAD_PX:m,BOTTOM_PAD_PX:ct,SIDE_MARGIN_PX:w,MAX_RADIUS_X:wt,RADIUS_X_FACTOR:he,ANG_OFFSET:l,MATCH_HIGHLIGHT_SEC:Tt,MATCH_SHRINK_PHASE:Nt,MAGIC_SHRINK_SEC:ne,RING_HIGHLIGHT_SEC:_t,LOCK_DELAY_SEC:Ft,getKillRate:g,ELEMENT_COLORS:It,ELEMENT_TO_COLOR:C,BLOCK_COLOR_FRONT:zt,BLOCK_COLOR_BACK:xt,ACTIVE_COLOR_FRONT:Kt,GHOST_COLOR_FILL:lt,GHOST_COLOR_STROKE:q,GHOST_STROKE_WIDTH:Ct,MAGIC_DIM_DOT_ALPHA:Jt,MAGIC_DIM_DOT_SCALE:G,MAGIC_TARGET_DOT_SCALE:se,getState:()=>({gameState:Ht,grid:ft,activePiece:St,pieceY:re,rotFloat:bt,killLevel:kt,isHighlighting:on,highlightedCells:fn,highlightStartTime:Gn,isMagicAnimation:vn,isRingAnimation:Rn,isGrounded:le,lockTimer:Dt,spellState:un.getRenderState()}),getVisualSettings:()=>({waterBubbles:kn,waterColor:On}),funcs:{snappedRot:os,computeGhostY:_i,normSector:ss,getMagicTargetColor:()=>ke()&&ut.canUse()?C[ut.active]:null,getTransmuteAnimState:t=>un.getTransmuteAnimState(t),getLightningAnimState:t=>un.getLightningAnimState(t),getFireAnimState:t=>un.getFireAnimState(t)}}),Bs=performance.now();function ro(t){let o=Math.min(.05,Math.max(.001,(t-Bs)/1e3));if(Bs=t,Ot.update(o,t),un.update(t),Rt>0){let u=Math.min(Rt,Ke*o);kt=Math.max(0,kt-u),Rt-=u}bt=Qe,bt>1e6&&(bt%=i),bt<-1e6&&(bt%=i),An.render(o,t),requestAnimationFrame(ro)}ue.addEventListener("click",()=>{Ot.applyCommand("start_game")}),Ue.addEventListener("click",()=>{Ot.applyCommand("start_game")}),Ie.addEventListener("click",()=>{Ht="intro",de.reset(),$.stopMusic(),$.getSettings().musicEnabled&&$.startMenuMusic(),Xn()}),Cn.forEach(t=>{t.addEventListener("click",o=>{Cn.forEach(y=>y.classList.remove("active")),t.classList.add("active"),Ee=t.dataset.mode,Jn(),Qn();let u=et.loadHighscore(Ee);u.score>0?(Be.textContent=u.score.toLocaleString(),Pe.textContent=xn(u.time)):(Be.textContent="0",Pe.textContent="0:00"),ue.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ue.classList.add("idlePulse"),2e3)})});let Rs=document.querySelectorAll(".spell-select-btn"),ws=document.getElementById("spellDesc"),Ui=document.getElementById("spellProgressFill"),lo=document.getElementById("spellProgressMarkers"),uo=document.getElementById("pauseSpellProgress"),Xi=document.getElementById("pauseSpellProgressFill"),fo=document.getElementById("pauseSpellProgressMarkers"),go=document.getElementById("pauseSpellProgressLabel");function As(){return ai.map(t=>Hn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Is(t){return t.length?Math.max(...t):0}function Yi(t){let o=As(),u=Is(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function po(t){if(!t)return;t.innerHTML="";let o=As(),u=Is(o);o.forEach(y=>{let H=document.createElement("span");H.className="marker",H.dataset.threshold=y;let ot=u>0?y/u*100:0;H.style.left=`${ot}%`,t.appendChild(H)})}function mo(t,o){if(!t)return;let u=Wi(o);t.style.width=`${u}%`}function ho(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(y=>{let H=parseInt(y.dataset.threshold,10)||0;y.classList.toggle("reached",o>=H)})}function Wi(t){let o=As(),u=Is(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function vo(t){if(!ws)return;let o=Hn(t),u=ge.getDescription(t);o===0||E>=o?ws.innerHTML=u:ws.innerHTML=`${u} <span class="spell-progress-text">${E}/${o}</span>`}function Ps(){E=et.loadHighTowerRings(),Rs.forEach(o=>{let u=o.dataset.spell,y=Hn(u),H=E>=y;o.classList.toggle("locked",!H);let ot=o.querySelector(".spell-lock");ot&&(ot.style.display=H?"none":"")}),mo(Ui,E),mo(Xi,E),ho(lo,E),ho(fo,E),go&&(go.textContent=Yi(E));let t=document.querySelector(".spell-select-btn.active");t&&vo(t.dataset.spell)}po(lo),po(fo),Ps(),Rs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){Cn.forEach(Ut=>Ut.classList.remove("active")),u.classList.add("active"),Ee="30_24",Jn(),Qn();let vt=et.loadHighscore(Ee);vt.score>0?(Be.textContent=vt.score.toLocaleString(),Pe.textContent=xn(vt.time)):(Be.textContent="0",Pe.textContent="0:00")}let y=t.dataset.spell,H=Hn(y),ot=E>=H;vo(y),ot&&(Rs.forEach(vt=>vt.classList.remove("active")),t.classList.add("active"),ge.selectSpell(y),Fn(ut.active))})}),ti.addEventListener("click",()=>{let t=et.loadHighscore("30_24"),o=et.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${xn(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${xn(o.time)}
`:`  No record yet
`,alert(u)}),ei.addEventListener("click",()=>{I.classList.remove("hidden")}),Dn(),Qn(),Jn(),Xn(),$.startMenuMusic();let Vi=()=>{if($.unlock(),!$.getSettings().musicEnabled)return;let t=$.musicAudio;!t||t.paused||t.ended?Ot.state==="playing"?$.startGameMusic():$.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},yo=0,Ki=10,qi=()=>{yo>=Ki||(yo++,Vi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,qi,{passive:!0})}),requestAnimationFrame(ro)})();})();
