(()=>{var Lo=[0,.25,.5,.75,1],Ro=[0,.05,.15,.25,.5],Io={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",wsseffect:"sounds/spell/wsseffect.wav"},xs={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Ms="soundSettings";function Ao(){try{let e=localStorage.getItem(Ms);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Po(e){try{localStorage.setItem(Ms,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function vs(){return{audioContext:null,buffers:{},settings:Ao(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Lo[this.settings.soundVolume]},getMusicVolume(){return Ro[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let o=await(await fetch(r)).arrayBuffer(),s=await this.audioContext.decodeAudioData(o);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${r}`,l)}},preload(){this.initContext();for(let[n,r]of Object.entries(Io))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;r!==null&&(l=`${n}${r}`);let o=this.buffers[l];if(o)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let i=this.audioContext.createBufferSource();i.buffer=o,i.connect(s),i.start(0),i.onended=()=>{i.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xs.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xs.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Po(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var bs="eb_highscore",Cs="eb_highscore_quick",_s="eb_settings",wo={invertSwipe:!1,difficulty:"easy"};function Ts(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Cs:bs,r=localStorage.getItem(n);if(r)return JSON.parse(r)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,r="30_24"){try{let l=this.loadHighscore(r);if(e>l.score||e===l.score&&n>l.time){let o=r==="25_20"?Cs:bs;return localStorage.setItem(o,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(_s);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...wo}},saveGameSettings(e){try{localStorage.setItem(_s,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}}}}function Bs(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Ls(e){return document.getElementById("tab-"+e)}var Oo={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Rs(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(l,o="score",s=null){let i=document.createElement("div");i.className=`bonus-popup ${o}`,i.textContent=l,s&&n[s]&&(i.style.color=n[s]);let c=window.innerWidth/2,m=window.innerHeight/2-40,f=(Math.random()-.5)*200,g=(Math.random()-.5)*100+r*36;i.style.left=`${c+f}px`,i.style.top=`${m+g}px`,i.style.transform="translate(-50%, -50%)",document.body.appendChild(i),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{i.remove()},1800)},getElementIcon(l){return Oo[l]||"\u2726"}}}var Is={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function As(){return{spawnMagicOrb(e,n,r,l){if(!l)return;let o=document.createElement("div");o.className=`magic-orb ${e}`,o.textContent=Is[e]||"\u2726";let s=l.getBoundingClientRect(),i=s.left+s.width/2-n,c=s.top+s.height/2-r,m=Math.hypot(i,c),f=Math.atan2(c,i),g=m*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,_=i*.5+Math.cos(p)*g,I=c*.5+Math.sin(p)*g;o.style.setProperty("--mid-x",`${_}px`),o.style.setProperty("--mid-y",`${I}px`),o.style.setProperty("--end-x",`${i}px`),o.style.setProperty("--end-y",`${c}px`),o.style.left=`${n}px`,o.style.top=`${r}px`,document.body.appendChild(o),setTimeout(()=>{o.remove()},700)},spawnMagicShot(e,n,r,l,o){if(!n){o&&o();return}let s=n.getBoundingClientRect(),i=s.left+s.width/2,c=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Is[e]||"\u2726";let f=r-i,g=l-c;m.style.setProperty("--end-x",`${f}px`),m.style.setProperty("--end-y",`${g}px`),m.style.left=`${i}px`,m.style.top=`${c}px`,document.body.appendChild(m);let p=setInterval(()=>{let _=m.getBoundingClientRect();this.spawnTrailParticle(e,_.left+_.width/2,_.top+_.height/2)},40);setTimeout(()=>{clearInterval(p),m.remove(),this.spawnExplosion(e,r,l),o&&o()},300)},spawnTrailParticle(e,n,r){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${r}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,r){for(let o=0;o<12;o++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let i=o/12*Math.PI*2+(Math.random()-.5)*.5,c=40+Math.random()*40,m=Math.cos(i)*c,f=Math.sin(i)*c;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${r}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let r=e.getBoundingClientRect(),l=r.left+r.width/2,o=r.top+r.height/2,s=Math.max(8,Math.round(n));for(let i=0;i<s;i++){let c=document.createElement("div");c.className="spell-bubble",c.textContent="\u25CF";let m=i/s*Math.PI*2+(Math.random()-.5)*.6,f=50+Math.random()*60,g=Math.cos(m)*f,p=Math.sin(m)*f-20;c.style.setProperty("--px",`${g}px`),c.style.setProperty("--py",`${p}px`),c.style.left=`${l}px`,c.style.top=`${o}px`,c.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(c),setTimeout(()=>c.remove(),800)}},spawnSpellOrb(e,n,r){if(!r)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let o=r.getBoundingClientRect(),s=o.left+o.width/2-e,i=o.top+o.height/2-n,c=Math.hypot(s,i),m=Math.atan2(i,s),f=c*.35*(Math.random()>.5?1:-1),g=m+Math.PI/2,p=s*.5+Math.cos(g)*f,_=i*.5+Math.sin(g)*f;l.style.setProperty("--mid-x",`${p}px`),l.style.setProperty("--mid-y",`${_}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${i}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}function Ps(e={}){let{buttons:n={},onActivate:r=null}=e,l={fire:3,water:3,lightning:3,earth:3},o=null;function s(){for(let[c,m]of Object.entries(n)){if(!m)continue;let f=l[c],g=m.querySelector(".charges");g&&(g.textContent=f),m.classList.toggle("empty",f<=0),m.classList.toggle("active",o===c&&f>0)}}function i(c){let m=n[c];m&&(m.classList.remove("pulse"),m.offsetWidth,m.classList.add("pulse"),setTimeout(()=>m.classList.remove("pulse"),400))}return{get charges(){return l},get active(){return o},set active(c){o=c},select(c){if(l[c]<=0)return!1;let m=o===c;return o=m?null:c,s(),!m&&o===c&&r&&r(),!m},useCharge(){if(!o||l[o]<=0)return!1;let c=o;return l[c]--,o=null,s(),i(c),!0},addCharges(c,m){l[c]!==void 0&&(l[c]+=m,s(),i(c))},canUse(){return o!==null&&l[o]>0},deactivate(){o=null,s()},reset(){l.fire=3,l.water=3,l.lightning=3,l.earth=3,o=null,s()},updateButtons:s,initButtons(c){for(let[m,f]of Object.entries(n))f&&f.addEventListener("click",()=>{c&&c(m)})}}}var Fn={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:15,effect:{type:"lower_kz",duration:18}},air:{name:"Air",icon:"\u{1F4A8}",description:"Chain lightning - clears element in area",maxProgress:15,effect:{type:"chain_lightning"}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:15,effect:{type:"transmutation"}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:15,effect:{type:"horizontal_beam"}}};function ws(e={}){let{button:n=null,onActivate:r=null,onProgress:l=null,onReady:o=null}=e,s="ice",i=0;function c(){return Fn[s]||Fn.ice}function m(){if(!n)return;let g=c(),p=Math.min(i/g.maxProgress,1)*100,_=i>=g.maxProgress;n.style.setProperty("--progress",`${p}%`);let I=n.querySelector(".spell-icon");I&&(I.textContent=g.icon);let X=n.querySelector(".spell-counter");X&&(X.textContent=`${Math.min(i,g.maxProgress)}/${g.maxProgress}`),n.classList.toggle("ready",_),n.classList.toggle("charging",!_&&i>0),l&&l(i,g.maxProgress)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return i},get maxProgress(){return c().maxProgress},get isReady(){return i>=c().maxProgress},get effect(){return c().effect},get button(){return n},selectSpell(g){Fn[g]&&(s=g,i=0,m())},addProgress(g=1){let p=c();if(i>=p.maxProgress)return!1;let _=i<p.maxProgress;return i=Math.min(i+g,p.maxProgress),m(),f(),_&&i>=p.maxProgress&&o&&o(),!0},canUse(){return i>=c().maxProgress},use(){if(!this.canUse())return null;let g=c().effect;return i=0,m(),f(),r&&r(s),g},reset(){i=0,m()},updateButton:m,initButton(g){n&&n.addEventListener("click",()=>{g&&g()})}}}var Do={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Os(e={}){let{canvas:n}=e,r=e.rotDir||1,l=!1,o=0,s=0,i=0,c=0,m=0,f=1,g=null,p=0,_=0,I=0,X=0,V=0,nt=0,St=0,Jt=0,J=Do;return{get rotDir(){return r},set rotDir(P){r=P},get dragging(){return l},get dragMode(){return g},handlePointerDown(P,ct,ue){if(ct.onMagicTap&&ct.onMagicTap(P.clientX,P.clientY))return!0;let jt=performance.now(),$t=jt-nt,Gt=P.clientX-St,Ht=P.clientY-Jt,de=Math.hypot(Gt,Ht);return $t<=J.DOUBLE_TAP_MS&&de<=J.DOUBLE_TAP_MAX_DIST?(ct.onDoubleTap&&ct.onDoubleTap(),nt=0):(nt=jt,St=P.clientX,Jt=P.clientY),l=!0,f=-1,o=P.clientX,s=P.clientY,i=ue,c=0,m=0,g=null,p=jt,_=P.clientX,I=P.clientY,X=p,V=0,n&&n.setPointerCapture(P.pointerId),!1},handlePointerMove(P,ct,ue,jt){if(!l)return null;let $t=P.clientX-o,Gt=P.clientY-s,Ht=performance.now();if(Math.abs($t)<J.DEADZONE_PX&&Math.abs(Gt)<J.DEADZONE_PX)return null;if(!g){let It=Math.abs($t),vt=Math.abs(Gt);if(Gt<0)It>=J.DEADZONE_PX&&(g="rotate");else if(vt>=It*J.AXIS_DOMINANCE){if(vt>=J.DROP_SWIPE_MIN_DISTANCE){let Ct=Math.max(1,Ht-p);vt/Ct*1e3>=J.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else It>=vt*J.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let de=null;if(g==="rotate"&&Math.abs($t)>=J.DEADZONE_PX){let It=Math.max(1,Ht-X),vt=P.clientX-_,Ct=Math.max(1,Math.abs(vt)/It*1e3),d=Math.max(J.MIN_ROT_PX,Math.min(J.MAX_ROT_PX,J.PX_PER_STEP*(J.SWIPE_SPEED_REF/Ct)));V+=-vt/d*r*f;let z=Math.trunc(V);z!==0&&(V-=z);let it=c+z;if(it!==c&&ct.canRotateTo){let te=Math.sign(it-c),_t=i+c;for(;c!==it;){let he=c+te,Ce=i+he;if(!ct.canRotateTo(Math.floor(ue),Ce))break;c=he,_t=Ce,jt&&ct.onGroundedMove&&ct.onGroundedMove()}de={targetRot:_t,rotFloat:_t}}}if(g==="drop"&&Gt>J.DEADZONE_PX&&ct.onDrop){let It=Math.max(1,Ht-X),vt=P.clientY-I,Ct=Math.max(1,vt/It*1e3),d=Math.max(J.MIN_DROP_PX,Math.min(J.MAX_DROP_PX,J.PX_PER_DROP*(J.SWIPE_SPEED_REF/Ct))),z=Math.trunc(Gt/d);if(z>m){let it=z-m;for(let te=0;te<it;te++)ct.onDrop();m=z}}return _=P.clientX,I=P.clientY,X=Ht,de},handlePointerUp(P){if(l&&(l=!1,g=null,n&&P&&P.pointerId!==void 0))try{n.releasePointerCapture(P.pointerId)}catch{}},reset(){l=!1,g=null,c=0,m=0,V=0}}}var Un={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ds(){let e="intro",n=0,r=0,l=0,o=0,s=0,i={...Un};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return r},get stats(){return i},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),l=0,o=0,s=0,i={...Un}},pause(){return e!=="playing"?!1:(e="paused",o=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",o>0&&(s+=performance.now()-o,o=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(c){n+=c},setScore(c){n=c},updateTime(){e==="playing"&&r>0&&(l=performance.now()-r-s)},getFormattedTime(){let c=Math.floor(l/1e3),m=Math.floor(c/60),f=c%60;return`${m}:${f.toString().padStart(2,"0")}`},incrementStat(c,m=1){c in i&&(i[c]+=m)},updateMaxStat(c,m){c in i&&m>i[c]&&(i[c]=m)},reset(){e="intro",n=0,r=0,l=0,o=0,s=0,i={...Un}}}}function Oe(e,n){return e%=n,e<0&&(e+=n),e}function ks(e,n){return e[Math.min(n,e.length-1)]}function hn(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),l=n%60;return`${r}:${l.toString().padStart(2,"0")}`}function $s(e,n){let r=e.map(({x:c,y:m},f)=>({x:m,y:-c,color:n[f]})),l=1/0,o=-1/0,s=1/0;for(let c of r)l=Math.min(l,c.x),o=Math.max(o,c.x),s=Math.min(s,c.y);let i=Math.round((l+o)/2);for(let c of r)c.x-=i,c.y-=s;return r.sort((c,m)=>c.y-m.y||c.x-m.x),{cells:r.map(c=>({x:c.x,y:c.y})),colors:r.map(c=>c.color)}}function Xn(e,n,r,l){let o=[];return e+1<r&&o.push({y:e+1,s:n}),e-1>=0&&o.push({y:e-1,s:n}),o.push({y:e,s:Oe(n-1,l)}),o.push({y:e,s:Oe(n+1,l)}),o}function Gs(e,n,r){let l=Array.from({length:n},()=>new Uint8Array(r)),o=[];for(let s=0;s<n;s++)for(let i=0;i<r;i++){if(!e[s][i]||l[s][i])continue;let c=[],m=[{y:s,s:i}];for(l[s][i]=1;m.length>0;){let f=m.shift();c.push(f);for(let g of Xn(f.y,f.s,n,r))e[g.y][g.s]&&!l[g.y][g.s]&&(l[g.y][g.s]=1,m.push(g))}o.push(c)}return o}function Hs(e){return e.some(n=>n.y===0)}function Vn(e,n,r,l,o,s){if(!e)return!1;let i=Oe(r,s);for(let c of e.cells){let m=n+c.y,f=Oe(i+c.x,s);if(m<0)return!1;if(!(m>=o)&&l[m][f])return!1}return!0}function Ns(e,n,r,l,o,s){if(!e)return null;let i=Math.floor(n);for(;Vn(e,i-1,r,l,o,s);)i-=1;return i}function Fs(e,n,r){let l=[],o=[];for(let s=0;s<n;s++){let i=[],c=0,m=e[s][0],f=m?1:0;for(let g=1;g<=r;g++){let p=g<r?e[s][g]:0;p&&p===m?f++:(f>=1&&m&&i.push({start:c,length:f,color:m}),c=g,m=p,f=p?1:0)}if(i.length>=2){let g=i[0],p=i[i.length-1];if(g.start===0&&p.start+p.length===r&&g.color===p.color){let _=g.length+p.length;i[0]={start:p.start,length:_,color:g.color},i.pop()}}for(let g of i)if(g.length>=3){let p=[];for(let _=0;_<g.length;_++)p.push({y:s,s:(g.start+_)%r});l.push({color:g.color,length:g.length,cells:p})}}for(let s=0;s<r;s++){let i=0,c=e[0][s],m=c?1:0;for(let f=1;f<=n;f++){let g=f<n?e[f][s]:0;if(g&&g===c)m++;else{if(m>=3&&c){let p=[];for(let _=0;_<m;_++)p.push({y:i+_,s});l.push({color:c,length:m,cells:p})}i=f,c=g,m=g?1:0}}}for(let s=0;s<n;s++)for(let i=0;i<r;i++){let c=e[s][i],m=e[s][(i+1)%r],f=e[s][(i+2)%r],g=e[s][(i+3)%r];c&&c===m&&f&&f===g&&c!==f&&o.push({cells:[{y:s,s:i},{y:s,s:(i+1)%r},{y:s,s:(i+2)%r},{y:s,s:(i+3)%r}]})}for(let s=0;s<r;s++)for(let i=0;i<n-3;i++){let c=e[i][s],m=e[i+1][s],f=e[i+2][s],g=e[i+3][s];c&&c===m&&f&&f===g&&c!==f&&o.push({cells:[{y:i,s},{y:i+1,s},{y:i+2,s},{y:i+3,s}]})}return{lineMatches:l,pairMatches:o}}function Us(e,n,r){let l=[];for(let o=0;o<n;o++){let s=!0;for(let i=0;i<r;i++)if(!e[o][i]){s=!1;break}s&&l.push(o)}return l}function Xs(e,n){let r=new Map;e.forEach((l,o)=>r.set(`${l.x},${l.y}`,n[o]));for(let l=0;l<e.length;l++){let o=e[l],s=n[l],i=1;for(let nt=1;nt<=2&&r.get(`${o.x+nt},${o.y}`)===s;nt++)i++;if(i>=3)return!0;let c=1;for(let nt=1;nt<=2&&r.get(`${o.x},${o.y+nt}`)===s;nt++)c++;if(c>=3)return!0;let m=s,f=r.get(`${o.x+1},${o.y}`),g=r.get(`${o.x+2},${o.y}`),p=r.get(`${o.x+3},${o.y}`);if(m&&f&&g&&p&&m===f&&g===p&&m!==g)return!0;let _=s,I=r.get(`${o.x},${o.y+1}`),X=r.get(`${o.x},${o.y+2}`),V=r.get(`${o.x},${o.y+3}`);if(_&&I&&X&&V&&_===I&&X===V&&_!==X)return!0}return!1}function Vs(e){let{getN:n,getH:r,FALL_INTERVAL:l,LOCK_DELAY_SEC:o,getKillRate:s,MATCH_HIGHLIGHT_SEC:i,MAGIC_SHRINK_SEC:c,RING_HIGHLIGHT_SEC:m,getState:f,setState:g,funcs:p,ui:_}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(I,X={}){let V=f();if(I==="start_game")return V.gameState!=="playing"?(p.startGame(),!0):!1;if(V.gameState!=="playing")return!1;switch(I){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:nt}=X;return typeof nt=="number"&&p.canPlaceAtRot(Math.floor(V.pieceY),nt)?(g({targetRot:nt,rotFloat:nt,rotVel:0}),V.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:nt,y:St}=X;return p.shootMagic(nt,St)}case"select_magic":{let{element:nt}=X;return p.selectMagic(nt),!0}default:return console.warn("GameEngine: unknown command",I),!1}},update(I,X){let V=f();if(V.gameState!=="playing")return;let nt=X-V.startTime-V.totalPausedMs;g({elapsedMs:nt}),_.updateTimeHud();let St=V.killLevel+s()*I;if(g({killLevel:St}),_.updateRemainingHud(),St>=r()){p.endGame();return}if(V.isHighlighting){let P=(X-V.highlightStartTime)/1e3,ct;V.isRingAnimation?ct=m:V.isMagicAnimation?ct=c:ct=i,P>=ct&&(V.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let Jt=V.fallTimer+I;if(Jt>=l&&(Jt-=l,p.tryMoveDown()),g({fallTimer:Jt}),p.updateGroundedState()){let P=V.lockTimer+I;g({lockTimer:P}),P>=o&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(I,X){return p.canPlaceAtRot(I,X)},getRotation(){let I=f();return{targetRot:I.targetRot,rotFloat:I.rotFloat,rotVel:I.rotVel}},setRotation(I){g({targetRot:I,rotFloat:I,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var Vt=Math.PI*2;function Ys(e){let{canvas:n,canvasCtx:r,getN:l,getH:o,TOP_PAD_PX:s,BOTTOM_PAD_PX:i,SIDE_MARGIN_PX:c,MAX_RADIUS_X:m,RADIUS_X_FACTOR:f,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:_,MAGIC_SHRINK_SEC:I,RING_HIGHLIGHT_SEC:X,LOCK_DELAY_SEC:V,getKillRate:nt,ELEMENT_COLORS:St,ELEMENT_TO_COLOR:Jt,BLOCK_COLOR_FRONT:J,BLOCK_COLOR_BACK:P,ACTIVE_COLOR_FRONT:ct,GHOST_COLOR_FILL:ue,GHOST_COLOR_STROKE:jt,GHOST_STROKE_WIDTH:$t,MAGIC_DIM_DOT_ALPHA:Gt,MAGIC_DIM_DOT_SCALE:Ht,MAGIC_TARGET_DOT_SCALE:de,getState:It,getVisualSettings:vt,funcs:Ct}=e,d=r,z=l(),it=o(),te={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},_t=[],he=40;function Ce(T,S,v,E,M){let x=Math.max(3,Math.round(T)),$=180;for(let A=0;A<x;A++)setTimeout(()=>{let B=Math.random()>.5?"left":"right",y=15,R=B==="left"?y+Math.random()*Math.max(10,S-y*2):v+y+Math.random()*Math.max(10,M-v-y*2),L=E-10;_t.push({x:R,baseX:R,y:L,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:y,maxX:M-y})},A*$)}function Qe(T,S,v){_t=_t.filter(E=>E.y>T+E.size&&E.y>-20);for(let E of _t){E.y-=he*v,E.wobble+=E.wobbleSpeed*v;let M=E.baseX+Math.sin(E.wobble)*E.wobbleAmp;E.x=Math.max(E.minX,Math.min(E.maxX,M))}}function yn(T){if(_t.length!==0){d.fillStyle="rgba(255, 255, 255, 0.3)",d.strokeStyle="rgba(255, 255, 255, 0.5)",d.lineWidth=1;for(let S of _t)S.y<T+S.size||(d.beginPath(),d.arc(S.x,S.y,S.size,0,Math.PI*2),d.fill(),d.stroke())}}let De={left:0,right:0,h:0,w:0};function Yt(T,S,v){let E=1-v/it;return T+E*S}function ke(T){return T=T%z,T<0?T+z:T}function _e(T,S,v,E,M,x){let $=ke(x),A=(M-$)/z*Vt+g;return{x:T+Math.cos(A)*v,y:S+Math.sin(A)*E,ang:A}}let Ze=.52,$e=1.02;function ee(T,S,v,E,M,x){let $=ke(x),A=(M-$)/z*Vt+g;return{x:T+Math.cos(A)*v,y:S+Math.sin(A)*E,ang:A}}function En(T,S,v,E,M,x,$,A=1){let B=ee(T,S,v,E,M-Ze,x),y=ee(T,S,v,E,M+Ze,x),R={x:B.x,y:B.y-$*.5},L={x:B.x,y:B.y+$*.5},j={x:y.x,y:y.y-$*.5},w={x:y.x,y:y.y+$*.5},Y=(R.x+j.x+w.x+L.x)*.25,W=(R.y+j.y+w.y+L.y)*.25,At=$e*A,st=A,yt=[R,j,w,L].map(ye=>({x:Y+(ye.x-Y)*At,y:W+(ye.y-W)*st})),xt=Math.abs((y.x-B.x)*At),Et=Math.abs($*st);return{corners:yt,cx:Y,cy:W,wApprox:xt,hApprox:Et,ang:ee(T,S,v,E,M,x).ang}}function ne(T,S,v,E,M,x,$,A,B=1,y=null,R=1,L=null,j=0,w=1,Y=1){let W=En(T,S,v,E,M,x,$,Y),[At,st,yt,xt]=W.corners;if(d.save(),d.globalAlpha=B,d.fillStyle=A,d.beginPath(),d.moveTo(At.x,At.y),d.lineTo(st.x,st.y),d.lineTo(yt.x,yt.y),d.lineTo(xt.x,xt.y),d.closePath(),d.fill(),L&&j>0&&(d.strokeStyle=L,d.lineWidth=j,d.stroke()),y){let Et=Math.min(W.wApprox,W.hApprox)*.28*w;d.globalAlpha=B*R,d.fillStyle=y,d.beginPath(),d.arc(W.cx,W.cy,Et,0,Vt),d.fill()}d.restore(),d.globalAlpha=1}function Sn(T,S,v,E,M,x){let $=_e(T,S,v,E,M,x),A=_e(T,S,v,E,M+1,x),B=_e(T,S,v,E,M-1,x),y=Math.abs(A.x-$.x),R=Math.abs($.x-B.x),L=(y+R)*.5*1.06;return Math.max(1,L)}function xn(T,S,v,E,M,x){let $=(M-x)/z*Vt+g;return{x:T+Math.cos($)*v,y:S+Math.sin($)*E,ang:$}}function Yn(T,S,v,E,M,x,$,A=1,B=null,y=1,R=null,L=0,j=1){d.save(),d.translate(T,S);let w=Math.atan2(E,v);if(d.rotate(w),d.globalAlpha=A,d.fillStyle=$,d.fillRect(-M/2,-x/2,M,x),R&&L>0&&(d.strokeStyle=R,d.lineWidth=L,d.strokeRect(-M/2,-x/2,M,x)),B){let Y=Math.min(M,x)*.28*j;d.globalAlpha=A*y,d.fillStyle=B,d.beginPath(),d.arc(0,0,Y,0,Vt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let T=Math.max(1,Math.min(2,window.devicePixelRatio||1)),S=Math.floor(n.clientWidth*T),v=Math.floor(n.clientHeight*T);(n.width!==S||n.height!==v)&&(n.width=S,n.height=v,d.setTransform(T,0,0,T,0,0))},render(T=.016){this.resize();let S=It();z=l(),it=o();let v=n.clientWidth,E=n.clientHeight;d.clearRect(0,0,v,E),d.fillStyle="#0b0f14",d.fillRect(0,0,v,E);let M=v*.5,x=(v-2*c)/2,$=E-s-i,A=6,B=z*$/(A*it),y,R,L,j;j=E-i,B<=Math.min(x,m)?(y=B,R=$,L=s):(y=Math.min(x,m),R=y*A*it/z,L=j-R);let w=y*.28,{killLevel:Y,rotFloat:W,grid:At,gameState:st}=S,yt=vt?vt():{},xt=yt.waterColor||"blue",Et=yt.waterBubbles||!1,ye=te[xt]||te.blue,Mt=Yt(L,R,Y),Ge=.7,b=Y/it,tt={...ye.top},O={...ye.bottom};if(b>Ge){let C=(b-Ge)/(1-Ge);tt.r=Math.round(tt.r+(255-tt.r)*C*.5),tt.g=Math.round(tt.g+(150-tt.g)*C*.5),tt.b=Math.round(tt.b+(150-tt.b)*C*.5),O.r=Math.round(O.r+(180-O.r)*C),O.g=Math.round(O.g*(1-C*.6)),O.b=Math.round(O.b*(1-C*.6))}let rt=M-y-8,Nt=M+y+8,Wt=L,Pt=j+5,Ee=d.createLinearGradient(0,Mt,0,E);Ee.addColorStop(0,`rgba(${tt.r},${tt.g},${tt.b},0.5)`),Ee.addColorStop(1,`rgba(${O.r},${O.g},${O.b},0.7)`),d.fillStyle=Ee;let se=Math.round((tt.r+O.r)/2),G=Math.round((tt.g+O.g)/2),Je=Math.round((tt.b+O.b)/2),Te=y+8,ft=w+4;d.fillRect(0,Mt,rt,E-Mt),d.fillRect(Nt,Mt,v-Nt,E-Mt),d.beginPath();let je=Math.max(Mt,Pt);d.moveTo(rt,je),Mt<=Pt+ft?d.ellipse(M,Pt,Te,ft,0,Math.PI,0,!1):d.lineTo(Nt,je),d.lineTo(Nt,E),d.lineTo(rt,E),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(rt,Wt),d.lineTo(rt,Pt),d.stroke(),d.beginPath(),d.moveTo(Nt,Wt),d.lineTo(Nt,Pt),d.stroke(),d.beginPath(),d.ellipse(M,Pt,y+8,w+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(M,Pt,y+8,w+4,0,0,Vt),d.fill(),Y>.5&&(d.strokeStyle=`rgba(${Math.min(255,se+60)},${Math.min(255,G+40)},${Math.min(255,Je+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,Mt),d.lineTo(rt,Mt),d.moveTo(Nt,Mt),d.lineTo(v,Mt),d.stroke()),De={left:rt,right:Nt,h:E,w:v},(_t.length>0||Et)&&(Qe(Mt,E,T),yn(Mt)),d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let me=Vt*y,Mn=10,Wn=me/Mn*.7,ge=me/Mn*.3;d.setLineDash([Wn,ge]);let Kn=me/z;d.lineDashOffset=ke(W)*Kn;for(let C=0;C<=it;C++){let U=Yt(L,R,C);d.beginPath(),d.ellipse(M,U,y,w,0,0,Vt),d.stroke()}d.setLineDash([]);let He=[],Ne=[];for(let C=0;C<it;C++){let U=Yt(L,R,C+.5);for(let q=0;q<z;q++){let Q=At[C][q];if(!Q)continue;let K=_e(M,U,y,w,q,W),ut=Math.sin(K.ang),H={y:C,s:q,yScr:U,p:K,depth:ut,color:Q};ut<-.1?He.push(H):Ne.push(H)}}let Be=Ct.getMagicTargetColor(),{isHighlighting:Se,highlightedCells:xe,highlightStartTime:Kt,isMagicAnimation:oe}=S,Me=null,Le=1,Re=1,tn=!1;if(Se&&xe.length>0){Me=new Set(xe.map(U=>`${U.y},${U.s}`));let C=(performance.now()-Kt)/1e3;if(oe){let U=Math.min(1,C/I);Le=1-U*.85,Re=1-U*.9,tn=!0}else{let U=Math.min(1,C/p),q=1-_;if(U>q){let Q=(U-q)/_;Le=1-Q*.85,Re=1-Q*.9,tn=!0}}}He.sort((C,U)=>C.depth-U.depth);for(let C of He){let U=R/it*.9,q=St[C.color]||null,Q=.35,K=1,ut=`${C.y},${C.s}`;Me&&Me.has(ut)&&(Q*=Re,K=Le),ne(M,C.yScr,y,w,C.s,W,U,P,Q,q,.5,null,0,1,K)}let{isRingAnimation:zt}=S;if(Se&&xe.length>0&&!oe){let C=(performance.now()-Kt)/1e3,q=Math.min(1,C/(zt?X:p)),Q=1-_,K=q>Q,ut=K?(q-Q)/_:0,H=zt?Math.floor(q*Q*z*2)%z:-1,k=4+q/Q*10,dt=Math.sin(C*k*Vt),pt=K?1:.3+dt*.3,gt=K?1-ut*.8:1,bt=K?1-ut:1;for(let mt of xe){let ie=Yt(L,R,mt.y+.5),Fe=ee(M,ie,y,w,mt.s,W);if(Math.sin(Fe.ang)>=-.1)continue;let Ue=R/it*.9,Tt,qt,ce;if(zt){let ve=(mt.s-H+z)%z,Qt=ve<3?1-ve/3:0;Tt=(K?bt:.2+Qt*.5)*.5,qt=`rgba(255, 159, 67, ${Tt})`,ce=K?gt:1+Qt*.15}else Tt=pt*bt,qt=mt.isLine?`rgba(255, 255, 255, ${Tt*.5})`:`rgba(255, 220, 100, ${Tt*.4})`,ce=K?gt:1.1;ne(M,ie,y,w,mt.s,W,Ue,qt,1,null,1,null,0,1,ce)}}Ne.sort((C,U)=>C.depth-U.depth);for(let C of Ne){let U=R/it*.9,q=St[C.color]||null,Q=1,K=1,ut=1,H=1,k=`${C.y},${C.s}`,dt=Me&&Me.has(k);dt&&(Q=Re,K=Le),Be!==null&&!dt&&(C.color!==Be?(ut=Gt,H=Ht):H=de),ne(M,C.yScr,y,w,C.s,W,U,J,Q,q,ut,null,0,H,K)}if(Se&&xe.length>0&&!oe){let C=(performance.now()-Kt)/1e3,q=Math.min(1,C/(zt?X:p)),Q=1-_,K=q>Q,ut=K?(q-Q)/_:0,H=zt?Math.floor(q*Q*z*2)%z:-1,k=4+q/Q*10,dt=Math.sin(C*k*Vt),pt=K?1:.5+dt*.5,gt=K?1-ut*.8:1,bt=K?1-ut:1;for(let mt of xe){let ie=Yt(L,R,mt.y+.5),Fe=ee(M,ie,y,w,mt.s,W);if(Math.sin(Fe.ang)<-.1)continue;let Ue=R/it*.9,Tt,qt,ce;if(zt){let ve=(mt.s-H+z)%z,Qt=ve<4?1-ve/4:0;Tt=K?bt:.3+Qt*.7,qt=`rgba(255, 159, 67, ${Tt})`,ce=K?gt:1+Qt*.2}else Tt=pt*bt,qt=mt.isLine?`rgba(255, 255, 255, ${Tt*.7})`:`rgba(255, 220, 100, ${Tt*.6})`,ce=K?gt:1.15;ne(M,ie,y,w,mt.s,W,Ue,qt,1,null,1,null,0,1,ce)}}let{activePiece:Ft,pieceY:vn,isGrounded:bn,lockTimer:en}=S;if(Ft){let C=Ct.snappedRot(),U=C,q=Ct.computeGhostY(),Q=R/it*.9;if(q!==null){let H=[];for(let k=0;k<Ft.cells.length;k++){let dt=Ft.cells[k],pt=Ft.colors[k],gt=q+dt.y,bt=Ct.normSector(C+dt.x);if(gt<0||gt>=it)continue;let mt=Yt(L,R,gt+.5),ie=ee(M,mt,y,w,bt,U);H.push({cy:gt,cs:bt,yScr:mt,depth:Math.sin(ie.ang),color:pt})}H.sort((k,dt)=>k.depth-dt.depth);for(let k of H){let dt=St[k.color]||null;ne(M,k.yScr,y,w,k.cs,U,Q,ue,1,dt,.5,jt,$t,1,1)}}let K=ct;if(bn&&en>0){let H=Math.min(1,en/V),k=255,dt=Math.round(170+85*H),pt=Math.round(180+75*H),gt=.75+(1-.75)*H;K=`rgba(${k},${dt},${pt},${gt})`}let ut=[];for(let H=0;H<Ft.cells.length;H++){let k=Ft.cells[H],dt=Ft.colors[H],pt=Ct.normSector(C+k.x),gt=vn+k.y;if(gt<0||gt>=it)continue;let bt=Yt(L,R,gt+.5),mt=ee(M,bt,y,w,pt,U);ut.push({cs:pt,yScr:bt,depth:Math.sin(mt.ang),color:dt})}ut.sort((H,k)=>H.depth-k.depth);for(let H of ut){let k=St[H.color]||null;ne(M,H.yScr,y,w,H.cs,U,Q,K,1,k,1,null,0,1,1)}}},drawNextPreview(T,S){if(!T)return;let v=T.getContext("2d"),E=T.width,M=T.height;if(v.clearRect(0,0,E,M),!S)return;let x=1/0,$=-1/0,A=1/0,B=-1/0;for(let Y of S.cells)x=Math.min(x,Y.x),$=Math.max($,Y.x),A=Math.min(A,Y.y),B=Math.max(B,Y.y);let y=$-x+1,R=B-A+1,L=Math.min(E/(y+.5),M/(R+.5)),j=(E-y*L)/2,w=(M-R*L)/2;v.fillStyle=J;for(let Y=0;Y<S.cells.length;Y++){let W=S.cells[Y],At=j+(W.x-x)*L,st=w+(R-1-(W.y-A))*L;v.fillRect(At+1,st+1,L-2,L-2);let yt=S.colors[Y],xt=St[yt];if(xt){let Et=(L-2)*.32;v.fillStyle=xt,v.beginPath(),v.arc(At+L/2,st+L/2,Et,0,Vt),v.fill(),v.fillStyle=J}}},spawnBonusBubbles(T){let{left:S,right:v,h:E,w:M}=De;M>0&&Ce(T,S,v,E,M)}}}(()=>{let e=Bs(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,o=30,s=24,i=120,c={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let a=c[t]||c["30_24"];o=a.N,s=a.H,i=a.survivalTime}function f(){return s/i}let g=Math.PI/2,p=70,_=120,I=30,X=320,V=.42,nt="rgb(235,240,250)",St="rgb(55,62,75)",Jt="rgba(255,170,180,0.75)",J="rgba(110,255,150,0.15)",P="rgba(110,255,150,0.85)",ct=2,ue={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},jt={1:"fire",2:"water",3:"lightning",4:"earth"},$t={fire:1,water:2,lightning:3,earth:4},Gt=1,Ht=.58,de=!0,It=12,vt=25,Ct=1,d=2,z=3,it=5,te=8,_t=10,he=15,Ce=30,Qe=2,yn=.3,De=.5,Yt=1,ke=.3,_e=.5,Ze=1.3,$e=10,ee=500,En=[1,1.25,1.5,1.75,2],ne=10,Sn=100,xn=25,Yn=[1,1.3,1.6,2],T=[1,1.5,2,2.5],S=Ts(),v=S.loadGameSettings(),E=v.invertSwipe?-1:1,M=-1,x=Array.from({length:s},()=>new Uint8Array(o));function $(){x=Array.from({length:s},()=>new Uint8Array(o))}let A=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],B=null,y=s+3,R=0,L=0,j=!1,w=0,Y=0,W=0,At=3,st=0,yt=0,xt=0,Et=Os({canvas:n,rotDir:E}),ye="0.14.1",Mt=!0,Ge="blue",b=vs();b.preload();let tt=Ds(),O="intro",rt=0,Nt=0,Wt=0,Pt=0,Ee=0,se=null,G=tt.stats,Je=e.overlay,Te=Rs({elementColors:ue}),ft=Te.showBonus.bind(Te),je=Te.getElementIcon.bind(Te),me=As(),Mn=e.overlayTitle,Wn=e.overlayStats,ge=e.startBtn,Kn=e.hud,He=e.scoreHud,Ne=e.timeHud,Be=e.remainingHud,Se=e.nextCanvas,xe=Se.getContext("2d"),Kt=e.pauseBtn,oe=e.pauseOverlay,Me=e.resumeBtn,Le=e.restartBtn,Re=e.exitToMenuBtn,tn=e.pauseSettingsBtn,zt=e.pauseSoundBtn,Ft=e.pauseMusicBtn,vn=e.pauseBestScore,bn=e.pauseBestTime,en=e.pauseBestMode,C=e.pauseCurrentScore,U=e.pauseCurrentTime,q=e.pauseCurrentMode,Q=e.confirmDialog,K=e.confirmText,ut=e.confirmCancel,H=e.confirmOk,k=e.settingsOverlay,dt=e.settingsClose,pt=e.fullscreenBtn,gt=e.rotateBtn,bt=e.startPanel,mt=e.gameoverPanel,ie=e.goScore,Fe=e.goTime,Cn=e.goRing,Ue=e.goMatches,Tt=e.goBonuses,qt=e.goNewRecord,ce=e.goRestartBtn,ve=e.goExitBtn,Qt=e.bestScore,nn=e.bestExtra,zn=e.surviveVal,Ws=e.startVersion,qn=e.modeBtns,Ks=e.recordsBtn,zs=e.startSettingsBtn,qs=e.helpBtn,Ut="25_20",wt=Ps({buttons:e.magicBtns,onActivate:()=>b.play("spells")}),_n=e.magicBtns,$o=wt.charges,Qs=t=>wt.select(t),Tn=()=>wt.updateButtons(),Xe=e.spellWave;function Zs(){Xe&&(Xe.classList.remove("active"),Xe.offsetWidth,Xe.classList.add("active"),setTimeout(()=>Xe.classList.remove("active"),1200))}let ae=ws({button:e.spellBtn,onActivate:t=>{if(t==="ice"){let a=ae.effect;W+=a.duration*f(),b.play("wsseffect"),ft(`\u{1F4A7} -${a.duration}s`,"time"),Zs(),me.spawnSpellBubbles(ae.button,a.duration),Ae.spawnBonusBubbles(a.duration)}},onReady:()=>{b.play("readysuper")}});ae.initButton(()=>{O==="playing"&&ae.canUse()&&ae.use()});function Bn(){return Ut==="30_24"}function Ln(){let t=e.spellBtn,a=document.querySelector(".spell-divider");t&&(t.style.display=Bn()?"":"none"),a&&(a.style.display=Bn()?"":"none")}let re=[],Ve=0,le=!1,be=!1,Ye=!1,Ot=0,Zt=0,fe=0,sn=[];function Rn(t,a,u){let h=1-u/s;return t+h*a}function In(t,a,u,h,N,Z){let at=(N-Z)/o*l+g;return{x:t+Math.cos(at)*u,y:a+Math.sin(at)*h,ang:at}}function Qn(t,a){let u=n.clientWidth,h=n.clientHeight,N=u*.5,Z=(u-2*I)/2,at=h-p-_,Bt=6,Dt=o*at/(Bt*s),Pe=h-_,Xt,et,D;Dt<=Math.min(Z,X)?(Xt=Dt,et=at,D=p):(Xt=Math.min(Z,X),et=Xt*Bt*s/o,D=Pe-et);let F=Xt*.28,lt=Rn(D,et,t+.5),ht=In(N,lt,Xt,F,a,st),Lt=n.getBoundingClientRect();return{x:Lt.left+ht.x,y:Lt.top+ht.y}}function Js(t,a){if(!wt.canUse()||le)return!1;let u=$t[wt.active],h=n.clientWidth,N=n.clientHeight,Z=h*.5,at=(h-2*I)/2,Bt=N-p-_,Dt=6,Pe=o*Bt/(Dt*s),Xt=N-_,et,D,F;Pe<=Math.min(at,X)?(et=Pe,D=Bt,F=p):(et=Math.min(at,X),D=et*Dt*s/o,F=Xt-D);let lt=et*.28,ht=null,Lt=1/0;for(let Rt=0;Rt<s;Rt++){let we=Rn(F,D,Rt+.5);for(let kt=0;kt<o;kt++){let fn=x[Rt][kt];if(!fn||fn!==u)continue;let qe=In(Z,we,et,lt,kt,st);if(Math.sin(qe.ang)<-.1)continue;let pn=t-qe.x,ys=a-qe.y,Es=Math.hypot(pn,ys),Ss=D/s*.9,Bo=Ss*1.2;Math.abs(pn)<Bo/2&&Math.abs(ys)<Ss/2&&Es<Lt&&(Lt=Es,ht={y:Rt,s:kt})}}if(ht){let Rt=Rn(F,D,ht.y+.5),we=In(Z,Rt,et,lt,ht.s,st),kt=n.getBoundingClientRect(),fn=kt.left+we.x,qe=kt.top+we.y,hs=_n[wt.active];return me.spawnMagicShot(wt.active,hs,fn,qe,()=>{let pn=x[ht.y][ht.s];re=[{y:ht.y,s:ht.s,color:pn,isLine:!1,isMagic:!0}],Ve=performance.now(),le=!0,be=!0,Ot=0,Zt=xn,ft(`+${xn}`,"score")}),fe=0,wt.useCharge(),G.magicUsed++,!0}return!1}let Go=100;function Ho(t,a){return Xn(t,a,s,o)}function js(){return Gs(x,s,o)}let to=Hs;function eo(t){let a=t.map(h=>({...h,color:x[h.y][h.s]}));for(let h of t)x[h.y][h.s]=0;let u=s;for(let h of t){let N=h.y;for(let Z=1;Z<=h.y;Z++){let at=h.y-Z;if(x[at][h.s]){N=Z-1;break}}u=Math.min(u,N)}for(let h of a)x[h.y-u][h.s]=h.color;return u>0}function no(){let t=!0;for(;t;){t=!1;let a=js();for(let u of a)to(u)||eo(u)&&(t=!0)}}function so(){Pn()}let An=ks;function Zn(t,a){let u=new Map,h=0,N=0,Z=0,at={},Bt=t.length+a.length;for(let D of t){let F=jt[D.color],lt=0,ht=0;if(D.length>=5?(lt=z,ht=_t,G.lines5++):D.length===4?(lt=d,ht=te,G.lines4++):D.length===3&&(lt=Ct,ht=it,G.lines3++),F&&lt>0){wt.addCharges(F,lt),at[F]=(at[F]||0)+lt;let Lt=D.cells[Math.floor(D.cells.length/2)],Rt=Qn(Lt.y,Lt.s),we=_n[F];for(let kt=0;kt<lt;kt++)setTimeout(()=>{me.spawnMagicOrb(F,Rt.x,Rt.y,we)},kt*100)}h+=ht*f(),Z+=ht,N+=D.length*ne;for(let Lt of D.cells){let Rt=`${Lt.y},${Lt.s}`;u.has(Rt)||u.set(Rt,{y:Lt.y,s:Lt.s,color:D.color,isLine:!0})}}for(let D of a){if(G.pairs++,h+=he*f(),Z+=he,N+=Sn,Bn()&&ae.addProgress(1)){let F=D.cells[Math.floor(D.cells.length/2)],lt=Qn(F.y,F.s);me.spawnSpellOrb(lt.x,lt.y,ae.button)}for(let F of D.cells){let lt=`${F.y},${F.s}`;u.has(lt)||u.set(lt,{y:F.y,s:F.s,color:x[F.y][F.s],isLine:!1})}}let Dt=An(Yn,Bt-1),Pe=An(T,fe),Xt=Math.round(N*Dt*Pe),et=0;Bt>1&&(G.combos++,G.maxCombo=Math.max(G.maxCombo,Bt),setTimeout(()=>ft(`COMBO \xD7${Bt}`,"combo"),et),et+=180,b.play("combo2")),fe>0&&(G.cascades++,G.maxCascade=Math.max(G.maxCascade,fe),setTimeout(()=>ft(`CASCADE \xD7${fe}`,"cascade"),et),et+=180,b.play("cascade")),(t.length>0||a.length>0)&&b.play("combo");for(let D of t){let F=D.length,lt=F*ne;setTimeout(()=>ft(`Line-${F} +${lt}`,"line",D.color),et),et+=100}for(let D of a){let F=D.cells.length>0?x[D.cells[0].y][D.cells[0].s]:null;setTimeout(()=>ft(`Pair +${Sn}`,"pair",F),et),et+=100}Xt>0&&(setTimeout(()=>ft(`+${Xt}`,"score"),et),et+=120),Z>0&&(setTimeout(()=>ft(`+${Z}s`,"time"),et),et+=120);for(let[D,F]of Object.entries(at))F>0&&(setTimeout(()=>ft(`+${F}${je(D)}`,"charge"),et),et+=120);re=Array.from(u.values()),Ve=performance.now(),le=!0,be=!1,Ot=h,Zt=Xt,Tn()}function oo(){for(let t of re)x[t.y][t.s]=0;if(re.length>0&&b.playRandom("disappear"),Ot>0){W+=Ot;let t=Ot/f();Ae.spawnBonusBubbles(t)}tt.addScore(Zt),rt+=Zt,rn(),re=[],le=!1,be=!1,Ot=0,Zt=0,fe++,Pn()}function Pn(){no();let{lineMatches:t,pairMatches:a}=po();if(t.length>0||a.length>0)Zn(t,a);else{let u=ss();u.length>0?mo(u):!B&&O==="playing"&&ns()}}function No(t,a){Zn(t,a)}function wn(t){return Oe(t,o)}function on(){return wn(Math.round(st))}function Jn(t,a){return Vn(B,t,a,x,s,o)}function cn(t){return Jn(t,on())}let an=$s;function jn(){de&&(It!==0&&w>=It||(L=0,w+=1))}function io(){if(!B)return;let t=B.cells,a=B.colors,u={cells:t,colors:a};if(M>=0||(u=an(u.cells,u.colors),u=an(u.cells,u.colors)),u=an(u.cells,u.colors),B.cells=u.cells,B.colors=u.colors,!cn(Math.floor(y))){B.cells=t,B.colors=a;return}b.play("turn"),j&&jn()}function co(){return Ns(B,y,on(),x,s,o)}function ao(){if(!B)return!1;let t=Math.floor(y)-1,a=!cn(t);return a&&!j?(j=!0,L=0,w=0):!a&&j&&(j=!1,L=0,w=0),a}let Ie=hn;function We(){if(O==="playing"){Je.classList.add("hidden"),Kt.classList.remove("hidden");return}if(Je.classList.remove("hidden"),Kt.classList.add("hidden"),O==="intro"){bt.classList.remove("hidden"),mt.classList.add("hidden");let t=Math.floor(i/60),a=i%60;zn.textContent=`${t}:${a.toString().padStart(2,"0")}`;let u=S.loadHighscore(Ut);u.score>0?(Qt.textContent=u.score.toLocaleString(),nn.textContent=`(${Ie(u.time)})`):(Qt.textContent="0",nn.textContent=""),Ws.textContent=`v${ye}`,ge.classList.remove("idlePulse"),ge.offsetWidth,ge.classList.add("idlePulse")}else{bt.classList.add("hidden"),mt.classList.remove("hidden"),ie.textContent=rt.toLocaleString(),Fe.textContent=Ie(Wt);let t=S.loadHighscore(Ut);rt>0&&rt>=t.score?qt.classList.remove("hidden"):qt.classList.add("hidden");let a=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${G.rings}</span>
          <span class="count ring-max">${G.maxRing>0?"max \xD7"+G.maxRing:""}</span>
        </div>
      `;Cn.innerHTML=a;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${G.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${G.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${G.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${G.pairs}</span>
        </div>
      `;Ue.innerHTML=u;let h=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${G.combos}</span>
          <span class="count max-combo">${G.maxCombo>0?"max \xD7"+G.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${G.cascades}</span>
          <span class="count max-cascade">${G.maxCascade>0?"max \xD7"+G.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${G.magicUsed}</span>
        </div>
      `;Tt.innerHTML=h}}function rn(){He.textContent=`Score: ${rt}`}function On(){Ne.textContent=`Time: ${Ie(Wt)}`}function ts(){let t=Math.max(0,(s-Y)/f()),a=Math.floor(t/60),u=Math.floor(t%60);Be.textContent=`Left: ${a}:${u.toString().padStart(2,"0")}`,t<30?Be.classList.add("warning"):Be.classList.remove("warning")}function ro(){m(Ut),$(),Y=0,W=0,st=yt=0,xt=0,tt.start(),rt=0,Nt=performance.now(),Wt=0,Ee=0,Pt=0,O="playing",se=null,wt.reset(),ae.reset(),Ln(),re=[],sn=[],le=!1,be=!1,Ye=!1,Ot=0,Zt=0,fe=0,Tn(),rn(),On(),ts(),ns(),Ae.drawNextPreview(Se,se),We(),b.getSettings().musicEnabled&&b.startGameMusic()}function Dn(){tt.gameOver(),O="gameover",B=null,j=!1,L=0,w=0;let t=S.saveHighscore(rt,Wt,Ut);b.stopMusic(),b.play("gameover"),On(),We(),t&&rt>0&&setTimeout(()=>{ft("\u{1F3C6} NEW RECORD!","score")},500)}function lo(t){for(let u=0;u<50;u++){let h=t.map(()=>1+(Math.random()*4|0));if(!uo(t,h))return h}return t.map((u,h)=>1+h%4)}let uo=Xs;function es(t){let a=t.cells.map(h=>({x:h.x,y:h.y})),u=lo(a);return{name:t.name,cells:a,colors:u}}function ns(){if(!se){let N=A[Math.random()*A.length|0];se=es(N)}B=se;let t=A[Math.random()*A.length|0];se=es(t),Ae.drawNextPreview(Se,se);let a=1/0,u=-1/0;for(let N of B.cells)N.x<a&&(a=N.x),N.x>u&&(u=N.x);let h=(a+u)/2;for(let N of B.cells)N.x=N.x-Math.round(h);y=s+3,R=0,j=!1,L=0,w=0,cn(Math.floor(y))?b.playRandom("appear"):Dn()}function ss(){return Us(x,s,o)}function mo(t){if(t.length===0)return;let a=[];for(let Bt of t)for(let Dt=0;Dt<o;Dt++)a.push({y:Bt,s:Dt,color:x[Bt][Dt],isLine:!1});sn=t,re=a,Ve=performance.now(),le=!0,Ye=!0,be=!1;let u=t.length;G.rings+=u,G.maxRing=Math.max(G.maxRing,u);let h=An(En,u-1),N=Math.round(ee*u*h),Z=Ce*u;Zt=N,Ot=Z*f(),b.play("ring");let at=`RING \xD7${u}`;ft(at,"ring"),setTimeout(()=>ft(`+${N}`,"score"),150),setTimeout(()=>ft(`+${Z}s`,"time"),300)}function go(){let t=[...sn].sort((a,u)=>u-a);for(let a of t){for(let u=a;u<s-1;u++)x[u].set(x[u+1]);x[s-1].fill(0)}if(Ot>0){W+=Ot;let a=Ot/f();Ae.spawnBonusBubbles(a)}tt.addScore(Zt),rt+=Zt,rn(),re=[],sn=[],le=!1,Ye=!1,Ot=0,Zt=0,Pn()}function Fo(){return ss().length}function fo(){if(!B)return;let t=on();st=t,yt=t,xt=0;let a=!1;for(let u=0;u<B.cells.length;u++){let h=B.cells[u],N=B.colors[u],Z=Math.floor(y)+h.y,at=wn(t+h.x);Z>=s&&(a=!0),Z>=0&&Z<s&&(x[Z][at]=N)}if(a){Dn();return}tt.addScore($e),rt+=$e,rn(),ft(`+${$e}`,"score"),b.playRandom("drop"),B=null,fe=0,so()}function po(){return Fs(x,s,o)}function ho(){if(!B)return!1;let t=Math.floor(y)-1;return cn(t)?(y=t,j=!1,L=0,w=0,!0):(j=!0,!1)}n.addEventListener("pointerdown",t=>{if(ot.state!=="playing")return;t.preventDefault?.();let a=n.getBoundingClientRect(),u=t.clientX-a.left,h=t.clientY-a.top;Et.handlePointerDown(t,{onMagicTap:()=>ot.applyCommand("magic_shoot",{x:u,y:h}),onDoubleTap:()=>ot.applyCommand("rotate_piece")},yt)||(xt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(ot.state!=="playing"||!Et.dragging)return;t.preventDefault?.();let a=Et.handlePointerMove(t,{canRotateTo:(u,h)=>ot.canRotateTo(u,h),onDrop:()=>ot.applyCommand("move_down"),onGroundedMove:()=>ot.onGroundedMove()},ot.pieceY,ot.isGrounded);a&&ot.setRotation(a.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{ot.state==="playing"&&Et.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Et.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Et.dragging&&Et.handlePointerUp(t)},{passive:!1}),gt.addEventListener("click",()=>{ot.state==="playing"&&ot.applyCommand("rotate_piece")});let ln=e.dropBtn,un=null;function yo(){ot.state==="playing"&&(ot.applyCommand("move_down"),un=setInterval(()=>{if(ot.state!=="playing"){dn();return}ot.applyCommand("move_down")},vt))}function dn(){un&&(clearInterval(un),un=null)}ln.addEventListener("pointerdown",t=>{t.preventDefault(),yo()}),ln.addEventListener("pointerup",dn),ln.addEventListener("pointerleave",dn),ln.addEventListener("pointercancel",dn);for(let[t,a]of Object.entries(_n))a.addEventListener("click",()=>{ot.state==="playing"&&ot.applyCommand("select_magic",{element:t})});let kn=e.soundsToggle,$n=e.musicToggle;function pe(){let t=b.getSettings();t.soundsEnabled?kn.classList.add("active"):kn.classList.remove("active"),t.musicEnabled?$n.classList.add("active"):$n.classList.remove("active");for(let a=0;a<=4;a++){let u=e.soundVolBtns[a],h=e.musicVolBtns[a];u&&u.classList.toggle("active",t.soundVolume===a),h&&h.classList.toggle("active",t.musicVolume===a)}}let os=e.tabBtns,Eo=e.tabContents;os.forEach(t=>{t.addEventListener("click",()=>{let a=t.dataset.tab;os.forEach(u=>u.classList.remove("active")),Eo.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Ls(a).classList.add("active"),a==="sounds"&&pe()})});let is=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,cs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,So=e.iosHint,xo=e.standaloneBadge;function as(){let t=document.fullscreenElement||document.webkitFullscreenElement;pt.textContent=t?"Disable":"Enable"}is&&(cs?(xo.style.display="block",pt.style.display="none"):(So.style.display="block",pt.textContent="Not supported",pt.style.opacity="0.5",pt.style.cursor="default")),pt.addEventListener("click",()=>{if(is&&!cs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",as),document.addEventListener("webkitfullscreenchange",as);let mn=e.invertSwipeToggle;v.invertSwipe&&mn.classList.add("active"),mn.addEventListener("click",()=>{mn.classList.toggle("active");let t=mn.classList.contains("active");Et.rotDir=t?-1:1,v.invertSwipe=t,S.saveGameSettings(v)});let rs=e.diffBtns;rs.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(rs.forEach(a=>{a.classList.remove("active");let u=a.querySelector(".check-icon");u&&u.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let a=document.createElement("span");a.className="check-icon",a.textContent="\u2713",t.appendChild(a)}})}),kn.addEventListener("click",()=>{let a=!b.getSettings().soundsEnabled;b.updateSettings({soundsEnabled:a}),pe(),Ke()}),$n.addEventListener("click",()=>{let a=!b.getSettings().musicEnabled;b.updateSettings({musicEnabled:a}),pe(),Ke(),O!=="paused"&&(a?O==="playing"?b.startGameMusic():b.startMenuMusic():b.stopMusic())});for(let t=0;t<=4;t++){let a=e.soundVolBtns[t];a&&a.addEventListener("click",()=>{b.updateSettings({soundVolume:t}),pe(),b.play("turn")})}for(let t=0;t<=4;t++){let a=e.musicVolBtns[t];a&&a.addEventListener("click",()=>{b.updateSettings({musicVolume:t}),pe()})}pe();function ls(){O==="playing"&&(tt.pause(),Pt=performance.now(),O="paused",b.musicAudio&&b.musicAudio.pause())}function gn(){O==="paused"&&(tt.resume(),Ee+=performance.now()-Pt,Pt=0,O="playing",Nn=performance.now(),b.getSettings().musicEnabled&&b.startGameMusic())}function Ke(){let t=b.getSettings();zt.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",zt.classList.toggle("off",!t.soundsEnabled),Ft.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Ft.classList.toggle("off",!t.musicEnabled)}function Mo(){oe.classList.remove("hidden"),Kt.classList.add("hidden");let t=S.loadHighscore(Ut);vn.textContent=t.score?t.score.toLocaleString():"0",bn.textContent=t.time?hn(t.time):"0:00",en.textContent=Ut==="30_24"?"High Tower":"Quick Tower",C.textContent=rt.toLocaleString(),U.textContent=hn(Wt),q.textContent=Ut==="30_24"?"High Tower":"Quick Tower",Ke()}function ze(){oe.classList.add("hidden"),Kt.classList.remove("hidden")}Kt.addEventListener("click",()=>{ls(),Mo()}),Me.addEventListener("click",()=>{ze(),gn()});let Gn=null;function us(t,a){K.textContent=t,Gn=a,Q.classList.remove("hidden")}function ds(){Q.classList.add("hidden"),Gn=null}ut.addEventListener("click",()=>{ds()}),H.addEventListener("click",()=>{let t=Gn;ds(),t&&t()}),Le.addEventListener("click",()=>{us("Restart game?",()=>{ze(),ot.applyCommand("start_game")})}),Re.addEventListener("click",()=>{us("Exit to menu?",()=>{ze(),Kt.classList.add("hidden"),O="intro",tt.reset(),b.stopMusic(),b.getSettings().musicEnabled&&b.startMenuMusic(),We()})}),tn.addEventListener("click",()=>{k.classList.remove("hidden")}),zt.addEventListener("click",()=>{let t=b.getSettings();b.updateSettings({soundsEnabled:!t.soundsEnabled}),Ke(),pe()}),Ft.addEventListener("click",()=>{let a=!b.getSettings().musicEnabled;b.updateSettings({musicEnabled:a}),Ke(),pe()}),oe.addEventListener("click",t=>{t.target===oe&&(ze(),gn())}),document.addEventListener("keydown",t=>{O==="paused"&&!oe.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(ze(),gn())}),dt.addEventListener("click",()=>{k.classList.add("hidden")}),k.addEventListener("click",t=>{t.target===k&&k.classList.add("hidden")});let Hn=!1;document.addEventListener("visibilitychange",()=>{document.hidden?O==="playing"&&(ls(),Hn=!0):Hn&&O==="paused"&&(gn(),Hn=!1)});let ot=Vs({getN:()=>o,getH:()=>s,FALL_INTERVAL:Gt,LOCK_DELAY_SEC:Ht,getKillRate:f,MATCH_HIGHLIGHT_SEC:Qe,MAGIC_SHRINK_SEC:De,RING_HIGHLIGHT_SEC:Yt,getState:()=>({gameState:O,score:rt,elapsedMs:Wt,startTime:Nt,totalPausedMs:Ee,stats:G,activePiece:B,pieceY:y,targetRot:yt,rotFloat:st,rotVel:xt,isGrounded:j,isHighlighting:le,isMagicAnimation:be,isRingAnimation:Ye,highlightStartTime:Ve,killLevel:Y,grid:x,fallTimer:R,lockTimer:L}),setState:t=>{"elapsedMs"in t&&(Wt=t.elapsedMs),"killLevel"in t&&(Y=t.killLevel),"fallTimer"in t&&(R=t.fallTimer),"lockTimer"in t&&(L=t.lockTimer),"targetRot"in t&&(yt=t.targetRot),"rotFloat"in t&&(st=t.rotFloat),"rotVel"in t&&(xt=t.rotVel)},funcs:{startGame:ro,endGame:Dn,rotatePieceByDir:io,tryMoveDown:ho,canPlaceAtRot:Jn,maybeResetLockDelay:jn,shootMagic:Js,selectMagic:Qs,updateGroundedState:ao,lockPiece:fo,finishHighlight:oo,finishRingHighlight:go},ui:{updateTimeHud:On,updateRemainingHud:ts}}),Ae=Ys({canvas:n,canvasCtx:r,getN:()=>o,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:I,MAX_RADIUS_X:X,RADIUS_X_FACTOR:V,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:Qe,MATCH_SHRINK_PHASE:yn,MAGIC_SHRINK_SEC:De,RING_HIGHLIGHT_SEC:Yt,LOCK_DELAY_SEC:Ht,getKillRate:f,ELEMENT_COLORS:ue,ELEMENT_TO_COLOR:$t,BLOCK_COLOR_FRONT:nt,BLOCK_COLOR_BACK:St,ACTIVE_COLOR_FRONT:Jt,GHOST_COLOR_FILL:J,GHOST_COLOR_STROKE:P,GHOST_STROKE_WIDTH:ct,MAGIC_DIM_DOT_ALPHA:ke,MAGIC_DIM_DOT_SCALE:_e,MAGIC_TARGET_DOT_SCALE:Ze,getState:()=>({gameState:O,grid:x,activePiece:B,pieceY:y,rotFloat:st,killLevel:Y,isHighlighting:le,highlightedCells:re,highlightStartTime:Ve,isMagicAnimation:be,isRingAnimation:Ye,isGrounded:j,lockTimer:L}),getVisualSettings:()=>({waterBubbles:Mt,waterColor:Ge}),funcs:{snappedRot:on,computeGhostY:co,normSector:wn,getMagicTargetColor:()=>wt.canUse()?$t[wt.active]:null}}),Nn=performance.now();function ms(t){let a=Math.min(.05,Math.max(.001,(t-Nn)/1e3));if(Nn=t,ot.update(a,t),W>0){let u=Math.min(W,At*a);Y=Math.max(0,Y-u),W-=u}st=yt,st>1e6&&(st%=o),st<-1e6&&(st%=o),Ae.render(a),requestAnimationFrame(ms)}ge.addEventListener("click",()=>{ot.applyCommand("start_game")}),ce.addEventListener("click",()=>{ot.applyCommand("start_game")}),ve.addEventListener("click",()=>{O="intro",tt.reset(),b.stopMusic(),b.getSettings().musicEnabled&&b.startMenuMusic(),We()}),qn.forEach(t=>{t.addEventListener("click",a=>{if(a.target.closest(".spell-select-btn"))return;qn.forEach(at=>at.classList.remove("active")),t.classList.add("active"),Ut=t.dataset.mode,Ln();let u=S.loadHighscore(Ut);u.score>0?(Qt.textContent=u.score.toLocaleString(),nn.textContent=`(${Ie(u.time)})`):(Qt.textContent="0",nn.textContent="");let h=c[Ut]||c["30_24"],N=Math.floor(h.survivalTime/60),Z=h.survivalTime%60;zn.textContent=`${N}:${Z.toString().padStart(2,"0")}`,ge.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ge.classList.add("idlePulse"),2e3)})});let gs=document.querySelectorAll(".spell-select-btn"),fs=document.getElementById("spellDesc"),vo={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"};function bo(t){fs&&(fs.textContent=vo[t]||"")}gs.forEach(t=>{t.addEventListener("click",a=>{if(a.stopPropagation(),t.classList.contains("locked"))return;gs.forEach(h=>h.classList.remove("active")),t.classList.add("active");let u=t.dataset.spell;ae.selectSpell(u),bo(u)})}),Ks.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),a=S.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ie(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=a.score>0?`  Score: ${a.score.toLocaleString()}, Time: ${Ie(a.time)}
`:`  No record yet
`,alert(u)}),zs.addEventListener("click",()=>{k.classList.remove("hidden")}),qs.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),Tn(),Ln(),We(),b.startMenuMusic();let Co=()=>{if(b.unlock(),!b.getSettings().musicEnabled)return;let t=b.musicAudio;!t||t.paused||t.ended?ot.state==="playing"?b.startGameMusic():b.startMenuMusic():t.play().catch(a=>{console.debug("Music resume on interaction failed:",a)})},ps=0,_o=10,To=()=>{ps>=_o||(ps++,Co())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,To,{passive:!0})}),requestAnimationFrame(ms)})();})();
