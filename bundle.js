(()=>{var as=[0,.25,.5,.75,1],rs=[0,.05,.15,.25,.5],ls={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},oo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},so="soundSettings";function us(){try{let e=localStorage.getItem(so);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function ds(e){try{localStorage.setItem(so,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function io(){return{audioContext:null,buffers:{},settings:us(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),u=this.audioContext.createBufferSource();u.buffer=n,u.connect(this.audioContext.destination),u.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return as[this.settings.soundVolume]},getMusicVolume(){return rs[this.settings.musicVolume]},async loadSound(n,u){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(u)).arrayBuffer(),o=await this.audioContext.decodeAudioData(c);this.buffers[n]=o}catch(d){console.debug(`Failed to load sound: ${n} from ${u}`,d)}},preload(){this.initContext();for(let[n,u]of Object.entries(ls))this.loadSound(n,u)},play(n,u=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;u!==null&&(d=`${n}${u}`);let c=this.buffers[d];if(c)try{let o=this.audioContext.createGain();o.gain.value=this.getSoundVolume(),o.connect(this.audioContext.destination);let s=this.audioContext.createBufferSource();s.buffer=c,s.connect(o),s.start(0),s.onended=()=>{s.disconnect(),o.disconnect()}}catch(o){console.debug("Sound play failed:",o)}},playRandom(n){if(!this.settings.soundsEnabled)return;let u=1+Math.floor(Math.random()*3);this.play(n,u)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(oo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(u=>{console.debug("Menu music autoplay blocked:",u)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(oo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(u=>{console.debug("Game music play failed:",u)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},ds(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(u=>{console.debug("Music resume failed:",u)}):this.stopMusic()}catch(u){console.debug("Update music settings failed:",u)}},getSettings(){return{...this.settings}}}}var co="eb_highscore",ao="eb_highscore_quick",ro="eb_settings",ms={invertSwipe:!1,difficulty:"easy"};function lo(){return{loadHighscore(e="30_24"){try{let n=e==="16_20"?ao:co,u=localStorage.getItem(n);if(u)return JSON.parse(u)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,u="30_24"){try{let d=this.loadHighscore(u);if(e>d.score||e===d.score&&n>d.time){let c=u==="16_20"?ao:co;return localStorage.setItem(c,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(ro);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ms}},saveGameSettings(e){try{localStorage.setItem(ro,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}}}}function uo(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function mo(e){return document.getElementById("tab-"+e)}var go={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function fo(e={}){let{elementColors:n={}}=e,u=0;return{showBonus(d,c="score",o=null){let s=document.createElement("div");s.className=`bonus-popup ${c}`,s.textContent=d,o&&n[o]&&(s.style.color=n[o]);let a=window.innerWidth/2,h=window.innerHeight/2-40,g=(Math.random()-.5)*200,m=(Math.random()-.5)*100+u*36;s.style.left=`${a+g}px`,s.style.top=`${h+m}px`,s.style.transform="translate(-50%, -50%)",document.body.appendChild(s),u++,setTimeout(()=>{u=Math.max(0,u-1)},200),setTimeout(()=>{s.remove()},1800)},getElementIcon(d){return go[d]||"\u2726"},spawnMagicOrb(d,c,o,s){if(!s)return;let a=document.createElement("div");a.className=`magic-orb ${d}`,a.textContent=go[d]||"\u2726";let h=s.getBoundingClientRect(),g=h.left+h.width/2-c,m=h.top+h.height/2-o,E=Math.hypot(g,m),N=Math.atan2(m,g),A=E*.35*(Math.random()>.5?1:-1),Y=N+Math.PI/2,O=g*.5+Math.cos(Y)*A,P=m*.5+Math.sin(Y)*A;a.style.setProperty("--mid-x",`${O}px`),a.style.setProperty("--mid-y",`${P}px`),a.style.setProperty("--end-x",`${g}px`),a.style.setProperty("--end-y",`${m}px`),a.style.left=`${c}px`,a.style.top=`${o}px`,document.body.appendChild(a),setTimeout(()=>{a.remove(),s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))},700)}}}function ho(e={}){let{buttons:n={},onActivate:u=null}=e,d={fire:3,water:3,lightning:3,earth:3},c=null;function o(){for(let[s,a]of Object.entries(n)){if(!a)continue;let h=d[s],g=a.querySelector(".charges");g&&(g.textContent=h),a.classList.toggle("empty",h<=0),a.classList.toggle("active",c===s&&h>0)}}return{get charges(){return d},get active(){return c},set active(s){c=s},select(s){if(d[s]<=0)return!1;let a=c===s;return c=a?null:s,o(),!a&&c===s&&u&&u(),!a},useCharge(){return!c||d[c]<=0?!1:(d[c]--,c=null,o(),!0)},addCharges(s,a){d[s]!==void 0&&(d[s]+=a,o())},canUse(){return c!==null&&d[c]>0},deactivate(){c=null,o()},reset(){d.fire=3,d.water=3,d.lightning=3,d.earth=3,c=null,o()},updateButtons:o,initButtons(s){for(let[a,h]of Object.entries(n))h&&h.addEventListener("click",()=>{s&&s(a)})}}}var gs={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function po(e={}){let{canvas:n}=e,u=e.rotDir||1,d=!1,c=0,o=0,s=0,a=0,h=0,g=1,m=null,E=0,N=0,A=0,Y=0,O=0,P=0,Dt=0,bt=0,z=gs;return{get rotDir(){return u},set rotDir(R){u=R},get dragging(){return d},get dragMode(){return m},handlePointerDown(R,st,de){if(st.onMagicTap&&st.onMagicTap(R.clientX,R.clientY))return!0;let At=performance.now(),Qt=At-P,Tt=R.clientX-Dt,kt=R.clientY-bt,Zt=Math.hypot(Tt,kt);return Qt<=z.DOUBLE_TAP_MS&&Zt<=z.DOUBLE_TAP_MAX_DIST?(st.onDoubleTap&&st.onDoubleTap(),P=0):(P=At,Dt=R.clientX,bt=R.clientY),d=!0,g=-1,c=R.clientX,o=R.clientY,s=de,a=0,h=0,m=null,E=At,N=R.clientX,A=R.clientY,Y=E,O=0,n&&n.setPointerCapture(R.pointerId),!1},handlePointerMove(R,st,de,At){if(!d)return null;let Qt=R.clientX-c,Tt=R.clientY-o,kt=performance.now();if(Math.abs(Qt)<z.DEADZONE_PX&&Math.abs(Tt)<z.DEADZONE_PX)return null;if(!m){let Lt=Math.abs(Qt),Et=Math.abs(Tt);if(Tt<0)Lt>=z.DEADZONE_PX&&(m="rotate");else if(Et>=Lt*z.AXIS_DOMINANCE){if(Et>=z.DROP_SWIPE_MIN_DISTANCE){let r=Math.max(1,kt-E);Et/r*1e3>=z.DROP_SWIPE_MIN_SPEED?m="drop":m="rotate"}}else Lt>=Et*z.AXIS_DOMINANCE&&(m="rotate");if(!m)return null}let Zt=null;if(m==="rotate"&&Math.abs(Qt)>=z.DEADZONE_PX){let Lt=Math.max(1,kt-Y),Et=R.clientX-N,r=Math.max(1,Math.abs(Et)/Lt*1e3),tt=Math.max(z.MIN_ROT_PX,Math.min(z.MAX_ROT_PX,z.PX_PER_STEP*(z.SWIPE_SPEED_REF/r)));O+=-Et/tt*u*g;let et=Math.trunc(O);et!==0&&(O-=et);let Gt=a+et;if(Gt!==a&&st.canRotateTo){let Ct=Math.sign(Gt-a),ce=s+a;for(;a!==Gt;){let Ee=a+Ct,me=s+Ee;if(!st.canRotateTo(Math.floor(de),me))break;a=Ee,ce=me,At&&st.onGroundedMove&&st.onGroundedMove()}Zt={targetRot:ce,rotFloat:ce}}}if(m==="drop"&&Tt>z.DEADZONE_PX&&st.onDrop){let Lt=Math.max(1,kt-Y),Et=R.clientY-A,r=Math.max(1,Et/Lt*1e3),tt=Math.max(z.MIN_DROP_PX,Math.min(z.MAX_DROP_PX,z.PX_PER_DROP*(z.SWIPE_SPEED_REF/r))),et=Math.trunc(Tt/tt);if(et>h){let Gt=et-h;for(let Ct=0;Ct<Gt;Ct++)st.onDrop();h=et}}return N=R.clientX,A=R.clientY,Y=kt,Zt},handlePointerUp(R){if(d&&(d=!1,m=null,n&&R&&R.pointerId!==void 0))try{n.releasePointerCapture(R.pointerId)}catch{}},reset(){d=!1,m=null,a=0,h=0,O=0}}}var Tn={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function yo(){let e="intro",n=0,u=0,d=0,c=0,o=0,s={...Tn};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return u},get stats(){return s},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,u=performance.now(),d=0,c=0,o=0,s={...Tn}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(o+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(a){n+=a},setScore(a){n=a},updateTime(){e==="playing"&&u>0&&(d=performance.now()-u-o)},getFormattedTime(){let a=Math.floor(d/1e3),h=Math.floor(a/60),g=a%60;return`${h}:${g.toString().padStart(2,"0")}`},incrementStat(a,h=1){a in s&&(s[a]+=h)},updateMaxStat(a,h){a in s&&h>s[a]&&(s[a]=h)},reset(){e="intro",n=0,u=0,d=0,c=0,o=0,s={...Tn}}}}function Be(e,n){return e%=n,e<0&&(e+=n),e}function Eo(e,n){return e[Math.min(n,e.length-1)]}function sn(e){let n=Math.max(0,Math.floor(e/1e3)),u=Math.floor(n/60),d=n%60;return`${u}:${d.toString().padStart(2,"0")}`}function So(e,n){let u=e.map(({x:a,y:h},g)=>({x:h,y:-a,color:n[g]})),d=1/0,c=-1/0,o=1/0;for(let a of u)d=Math.min(d,a.x),c=Math.max(c,a.x),o=Math.min(o,a.y);let s=Math.round((d+c)/2);for(let a of u)a.x-=s,a.y-=o;return u.sort((a,h)=>a.y-h.y||a.x-h.x),{cells:u.map(a=>({x:a.x,y:a.y})),colors:u.map(a=>a.color)}}function Ln(e,n,u,d){let c=[];return e+1<u&&c.push({y:e+1,s:n}),e-1>=0&&c.push({y:e-1,s:n}),c.push({y:e,s:Be(n-1,d)}),c.push({y:e,s:Be(n+1,d)}),c}function Mo(e,n,u){let d=Array.from({length:n},()=>new Uint8Array(u)),c=[];for(let o=0;o<n;o++)for(let s=0;s<u;s++){if(!e[o][s]||d[o][s])continue;let a=[],h=[{y:o,s}];for(d[o][s]=1;h.length>0;){let g=h.shift();a.push(g);for(let m of Ln(g.y,g.s,n,u))e[m.y][m.s]&&!d[m.y][m.s]&&(d[m.y][m.s]=1,h.push(m))}c.push(a)}return c}function xo(e){return e.some(n=>n.y===0)}function Bn(e,n,u,d,c,o){if(!e)return!1;let s=Be(u,o);for(let a of e.cells){let h=n+a.y,g=Be(s+a.x,o);if(h<0)return!1;if(!(h>=c)&&d[h][g])return!1}return!0}function vo(e,n,u,d,c,o){if(!e)return null;let s=Math.floor(n);for(;Bn(e,s-1,u,d,c,o);)s-=1;return s}function Co(e,n,u){let d=[],c=[];for(let o=0;o<n;o++){let s=[],a=0,h=e[o][0],g=h?1:0;for(let m=1;m<=u;m++){let E=m<u?e[o][m]:0;E&&E===h?g++:(g>=1&&h&&s.push({start:a,length:g,color:h}),a=m,h=E,g=E?1:0)}if(s.length>=2){let m=s[0],E=s[s.length-1];if(m.start===0&&E.start+E.length===u&&m.color===E.color){let N=m.length+E.length;s[0]={start:E.start,length:N,color:m.color},s.pop()}}for(let m of s)if(m.length>=3){let E=[];for(let N=0;N<m.length;N++)E.push({y:o,s:(m.start+N)%u});d.push({color:m.color,length:m.length,cells:E})}}for(let o=0;o<u;o++){let s=0,a=e[0][o],h=a?1:0;for(let g=1;g<=n;g++){let m=g<n?e[g][o]:0;if(m&&m===a)h++;else{if(h>=3&&a){let E=[];for(let N=0;N<h;N++)E.push({y:s+N,s:o});d.push({color:a,length:h,cells:E})}s=g,a=m,h=m?1:0}}}for(let o=0;o<n;o++)for(let s=0;s<u;s++){let a=e[o][s],h=e[o][(s+1)%u],g=e[o][(s+2)%u],m=e[o][(s+3)%u];a&&a===h&&g&&g===m&&a!==g&&c.push({cells:[{y:o,s},{y:o,s:(s+1)%u},{y:o,s:(s+2)%u},{y:o,s:(s+3)%u}]})}for(let o=0;o<u;o++)for(let s=0;s<n-3;s++){let a=e[s][o],h=e[s+1][o],g=e[s+2][o],m=e[s+3][o];a&&a===h&&g&&g===m&&a!==g&&c.push({cells:[{y:s,s:o},{y:s+1,s:o},{y:s+2,s:o},{y:s+3,s:o}]})}return{lineMatches:d,pairMatches:c}}function _o(e,n,u){let d=[];for(let c=0;c<n;c++){let o=!0;for(let s=0;s<u;s++)if(!e[c][s]){o=!1;break}o&&d.push(c)}return d}function bo(e,n){let u=new Map;e.forEach((d,c)=>u.set(`${d.x},${d.y}`,n[c]));for(let d=0;d<e.length;d++){let c=e[d],o=n[d],s=1;for(let P=1;P<=2&&u.get(`${c.x+P},${c.y}`)===o;P++)s++;if(s>=3)return!0;let a=1;for(let P=1;P<=2&&u.get(`${c.x},${c.y+P}`)===o;P++)a++;if(a>=3)return!0;let h=o,g=u.get(`${c.x+1},${c.y}`),m=u.get(`${c.x+2},${c.y}`),E=u.get(`${c.x+3},${c.y}`);if(h&&g&&m&&E&&h===g&&m===E&&h!==m)return!0;let N=o,A=u.get(`${c.x},${c.y+1}`),Y=u.get(`${c.x},${c.y+2}`),O=u.get(`${c.x},${c.y+3}`);if(N&&A&&Y&&O&&N===A&&Y===O&&N!==Y)return!0}return!1}function To(e){let{getN:n,getH:u,FALL_INTERVAL:d,LOCK_DELAY_SEC:c,getKillRate:o,MATCH_HIGHLIGHT_SEC:s,MAGIC_SHRINK_SEC:a,RING_HIGHLIGHT_SEC:h,getState:g,setState:m,funcs:E,ui:N}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(A,Y={}){let O=g();if(A==="start_game")return O.gameState!=="playing"?(E.startGame(),!0):!1;if(O.gameState!=="playing")return!1;switch(A){case"rotate_piece":return E.rotatePieceByDir(),!0;case"move_down":return E.tryMoveDown();case"rotate_cylinder":{let{rot:P}=Y;return typeof P=="number"&&E.canPlaceAtRot(Math.floor(O.pieceY),P)?(m({targetRot:P,rotFloat:P,rotVel:0}),O.isGrounded&&E.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:P,y:Dt}=Y;return E.shootMagic(P,Dt)}case"select_magic":{let{element:P}=Y;return E.selectMagic(P),!0}default:return console.warn("GameEngine: unknown command",A),!1}},update(A,Y){let O=g();if(O.gameState!=="playing")return;let P=Y-O.startTime-O.totalPausedMs;m({elapsedMs:P}),N.updateTimeHud();let Dt=O.killLevel+o()*A;if(m({killLevel:Dt}),N.updateRemainingHud(),Dt>=u()){E.endGame();return}if(O.isHighlighting){let R=(Y-O.highlightStartTime)/1e3,st;O.isRingAnimation?st=h:O.isMagicAnimation?st=a:st=s,R>=st&&(O.isRingAnimation?E.finishRingHighlight():E.finishHighlight())}let bt=O.fallTimer+A;if(bt>=d&&(bt-=d,E.tryMoveDown()),m({fallTimer:bt}),E.updateGroundedState()){let R=O.lockTimer+A;m({lockTimer:R}),R>=c&&E.lockPiece()}},reset(){E.startGame()},canRotateTo(A,Y){return E.canPlaceAtRot(A,Y)},getRotation(){let A=g();return{targetRot:A.targetRot,rotFloat:A.rotFloat,rotVel:A.rotVel}},setRotation(A){m({targetRot:A,rotFloat:A,rotVel:0})},onGroundedMove(){E.maybeResetLockDelay()}}}var Ot=Math.PI*2;function Lo(e){let{canvas:n,canvasCtx:u,getN:d,getH:c,TOP_PAD_PX:o,BOTTOM_PAD_PX:s,MAX_RADIUS_X:a,RADIUS_X_FACTOR:h,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:E,MAGIC_SHRINK_SEC:N,RING_HIGHLIGHT_SEC:A,LOCK_DELAY_SEC:Y,getKillRate:O,ELEMENT_COLORS:P,ELEMENT_TO_COLOR:Dt,BLOCK_COLOR_FRONT:bt,BLOCK_COLOR_BACK:z,ACTIVE_COLOR_FRONT:R,GHOST_COLOR_FILL:st,GHOST_COLOR_STROKE:de,GHOST_STROKE_WIDTH:At,MAGIC_DIM_DOT_ALPHA:Qt,MAGIC_DIM_DOT_SCALE:Tt,MAGIC_TARGET_DOT_SCALE:kt,getState:Zt,getVisualSettings:Lt,funcs:Et}=e,r=u,tt=d(),et=c(),Gt={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},Ct=[],ce=15,Ee=2;function me(b,_,S,T,C,L,M){for(Ct=Ct.filter(p=>p.y>b+p.size);Ct.length<ce;){let p=Math.random()>.5?"left":"right",f=10,w=p==="left"?f+Math.random()*(_-f*2):S+f+Math.random()*(C-S-f*2),I=T+20+Math.random()*100;Ct.push({x:w,baseX:w,y:I,size:1.5+Math.random()*3,speedFactor:.9+Math.random()*.2,wobble:Math.random()*Math.PI*2,wobbleSpeed:.4+Math.random()*.4,wobbleAmp:3+Math.random()*4,side:p,minX:p==="left"?f:S+f,maxX:p==="left"?_-f:C-f})}let B=L*Ee;for(let p of Ct){p.y-=B*p.speedFactor*M,p.wobble+=p.wobbleSpeed*M;let f=p.baseX+Math.sin(p.wobble)*p.wobbleAmp;p.x=Math.max(p.minX,Math.min(p.maxX,f))}}function cn(b){r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="rgba(255, 255, 255, 0.4)",r.lineWidth=1;for(let _ of Ct)_.y<b+_.size||(r.beginPath(),r.arc(_.x,_.y,_.size,0,Math.PI*2),r.fill(),r.stroke())}function Ht(b,_,S){let T=1-S/et;return b+T*_}function Se(b){return b=b%tt,b<0?b+tt:b}function Me(b,_,S,T,C,L){let M=Se(L),B=(C-M)/tt*Ot+g;return{x:b+Math.cos(B)*S,y:_+Math.sin(B)*T,ang:B}}let Ne=.52,an=1.02;function Rt(b,_,S,T,C,L){let M=Se(L),B=(C-M)/tt*Ot+g;return{x:b+Math.cos(B)*S,y:_+Math.sin(B)*T,ang:B}}function rn(b,_,S,T,C,L,M,B=1){let p=Rt(b,_,S,T,C-Ne,L),f=Rt(b,_,S,T,C+Ne,L),w={x:p.x,y:p.y-M*.5},I={x:p.x,y:p.y+M*.5},it={x:f.x,y:f.y-M*.5},ct={x:f.x,y:f.y+M*.5},F=(w.x+it.x+ct.x+I.x)*.25,Q=(w.y+it.y+ct.y+I.y)*.25,Z=an*B,gt=B,W=[w,it,ct,I].map(rt=>({x:F+(rt.x-F)*Z,y:Q+(rt.y-Q)*gt})),at=Math.abs((f.x-p.x)*Z),$t=Math.abs(M*gt);return{corners:W,cx:F,cy:Q,wApprox:at,hApprox:$t,ang:Rt(b,_,S,T,C,L).ang}}function ae(b,_,S,T,C,L,M,B,p=1,f=null,w=1,I=null,it=0,ct=1,F=1){let Q=rn(b,_,S,T,C,L,M,F),[Z,gt,W,at]=Q.corners;if(r.save(),r.globalAlpha=p,r.fillStyle=B,r.beginPath(),r.moveTo(Z.x,Z.y),r.lineTo(gt.x,gt.y),r.lineTo(W.x,W.y),r.lineTo(at.x,at.y),r.closePath(),r.fill(),I&&it>0&&(r.strokeStyle=I,r.lineWidth=it,r.stroke()),f){let $t=Math.min(Q.wApprox,Q.hApprox)*.28*ct;r.globalAlpha=p*w,r.fillStyle=f,r.beginPath(),r.arc(Q.cx,Q.cy,$t,0,Ot),r.fill()}r.restore(),r.globalAlpha=1}function ln(b,_,S,T,C,L){let M=Me(b,_,S,T,C,L),B=Me(b,_,S,T,C+1,L),p=Me(b,_,S,T,C-1,L),f=Math.abs(B.x-M.x),w=Math.abs(M.x-p.x),I=(f+w)*.5*1.06;return Math.max(1,I)}function un(b,_,S,T,C,L){let M=(C-L)/tt*Ot+g;return{x:b+Math.cos(M)*S,y:_+Math.sin(M)*T,ang:M}}function dn(b,_,S,T,C,L,M,B=1,p=null,f=1,w=null,I=0,it=1){r.save(),r.translate(b,_);let ct=Math.atan2(T,S);if(r.rotate(ct),r.globalAlpha=B,r.fillStyle=M,r.fillRect(-C/2,-L/2,C,L),w&&I>0&&(r.strokeStyle=w,r.lineWidth=I,r.strokeRect(-C/2,-L/2,C,L)),p){let F=Math.min(C,L)*.28*it;r.globalAlpha=B*f,r.fillStyle=p,r.beginPath(),r.arc(0,0,F,0,Ot),r.fill()}r.restore(),r.globalAlpha=1}return{resize(){let b=Math.max(1,Math.min(2,window.devicePixelRatio||1)),_=Math.floor(n.clientWidth*b),S=Math.floor(n.clientHeight*b);(n.width!==_||n.height!==S)&&(n.width=_,n.height=S,r.setTransform(b,0,0,b,0,0))},render(b=.016){this.resize();let _=Zt();tt=d(),et=c();let S=n.clientWidth,T=n.clientHeight;r.clearRect(0,0,S,T),r.fillStyle="#0b0f14",r.fillRect(0,0,S,T);let C=S*.5,L=o,M=T-s,B=Math.max(1,M-L),p=Math.min(S*h,a),f=p*.28,{killLevel:w,rotFloat:I,grid:it,gameState:ct}=_,F=Lt?Lt():{},Q=F.waterColor||"blue",Z=F.waterBubbles||!1,gt=Gt[Q]||Gt.blue,W=Ht(L,B,w),at=.7,$t=w/et,rt={...gt.top},xt={...gt.bottom};if($t>at){let v=($t-at)/(1-at);rt.r=Math.round(rt.r+(255-rt.r)*v*.5),rt.g=Math.round(rt.g+(150-rt.g)*v*.5),rt.b=Math.round(rt.b+(150-rt.b)*v*.5),xt.r=Math.round(xt.r+(180-xt.r)*v),xt.g=Math.round(xt.g*(1-v*.6)),xt.b=Math.round(xt.b*(1-v*.6))}let y=C-p-8,dt=C+p+8,nt=L,lt=M+5,xe=r.createLinearGradient(0,W,0,T);xe.addColorStop(0,`rgba(${rt.r},${rt.g},${rt.b},0.5)`),xe.addColorStop(1,`rgba(${xt.r},${xt.g},${xt.b},0.7)`),r.fillStyle=xe;let Jt=Math.round((rt.r+xt.r)/2),ve=Math.round((rt.g+xt.g)/2),Ie=Math.round((rt.b+xt.b)/2),jt=p+8,U=f+4;r.fillRect(0,W,y,T-W),r.fillRect(dt,W,S-dt,T-W),r.beginPath();let Ae=Math.max(W,lt);if(r.moveTo(y,Ae),W<=lt+U?r.ellipse(C,lt,jt,U,0,Math.PI,0,!1):r.lineTo(dt,Ae),r.lineTo(dt,T),r.lineTo(y,T),r.closePath(),r.fill(),r.strokeStyle="rgba(100,180,255,0.6)",r.lineWidth=3,r.lineCap="round",r.beginPath(),r.moveTo(y,nt),r.lineTo(y,lt),r.stroke(),r.beginPath(),r.moveTo(dt,nt),r.lineTo(dt,lt),r.stroke(),r.beginPath(),r.ellipse(C,lt,p+8,f+4,0,0,Math.PI),r.stroke(),r.fillStyle="#0b0f14",r.beginPath(),r.ellipse(C,lt,p+8,f+4,0,0,Ot),r.fill(),w>.5&&(r.strokeStyle=`rgba(${Math.min(255,Jt+60)},${Math.min(255,ve+40)},${Math.min(255,Ie+40)},0.6)`,r.lineWidth=2,r.beginPath(),r.moveTo(0,W),r.lineTo(y,W),r.moveTo(dt,W),r.lineTo(S,W),r.stroke()),Z&&w>.5){let v=O()*B/et;me(W,y,dt,T,S,v,b),cn(W)}r.strokeStyle="rgba(160,190,220,0.3)",r.lineWidth=1;let te=Ot*p,Mt=10,mn=te/Mt*.7,In=te/Mt*.3;r.setLineDash([mn,In]);let An=te/tt;r.lineDashOffset=Se(I)*An;for(let v=0;v<=et;v++){let k=Ht(L,B,v);r.beginPath(),r.ellipse(C,k,p,f,0,0,Ot),r.stroke()}r.setLineDash([]);let Nt=[],Fe=[];for(let v=0;v<et;v++){let k=Ht(L,B,v+.5);for(let X=0;X<tt;X++){let K=it[v][X];if(!K)continue;let G=Me(C,k,p,f,X,I),ut=Math.sin(G.ang),D={y:v,s:X,yScr:k,p:G,depth:ut,color:K};ut<-.1?Nt.push(D):Fe.push(D)}}let Ue=Et.getMagicTargetColor(),{isHighlighting:Re,highlightedCells:Ft,highlightStartTime:ge,isMagicAnimation:Xe}=_,Bt=null,Ut=1,Ce=1,Ve=!1;if(Re&&Ft.length>0){Bt=new Set(Ft.map(k=>`${k.y},${k.s}`));let v=(performance.now()-ge)/1e3;if(Xe){let k=Math.min(1,v/N);Ut=1-k*.85,Ce=1-k*.9,Ve=!0}else{let k=Math.min(1,v/m),X=1-E;if(k>X){let K=(k-X)/E;Ut=1-K*.85,Ce=1-K*.9,Ve=!0}}}Nt.sort((v,k)=>v.depth-k.depth);for(let v of Nt){let k=B/et*.9,X=P[v.color]||null,K=.35,G=1,ut=`${v.y},${v.s}`;Bt&&Bt.has(ut)&&(K*=Ce,G=Ut),ae(C,v.yScr,p,f,v.s,I,k,z,K,X,.5,null,0,1,G)}let{isRingAnimation:re}=_;if(Re&&Ft.length>0&&!Xe){let v=(performance.now()-ge)/1e3,X=Math.min(1,v/(re?A:m)),K=1-E,G=X>K,ut=G?(X-K)/E:0,D=re?Math.floor(X*K*tt*2)%tt:-1,V=4+X/K*10,mt=Math.sin(v*V*Ot),St=G?1:.3+mt*.3,ft=G?1-ut*.8:1,ht=G?1-ut:1;for(let pt of Ft){let Xt=Ht(L,B,pt.y+.5),_e=Rt(C,Xt,p,f,pt.s,I);if(Math.sin(_e.ang)>=-.1)continue;let Oe=B/et*.9,_t,ne,Vt;if(re){let fe=(pt.s-D+tt)%tt,he=fe<3?1-fe/3:0;_t=(G?ht:.2+he*.5)*.5,ne=`rgba(255, 159, 67, ${_t})`,Vt=G?ft:1+he*.15}else _t=St*ht,ne=pt.isLine?`rgba(255, 255, 255, ${_t*.5})`:`rgba(255, 220, 100, ${_t*.4})`,Vt=G?ft:1.1;ae(C,Xt,p,f,pt.s,I,Oe,ne,1,null,1,null,0,1,Vt)}}Fe.sort((v,k)=>v.depth-k.depth);for(let v of Fe){let k=B/et*.9,X=P[v.color]||null,K=1,G=1,ut=1,D=1,V=`${v.y},${v.s}`,mt=Bt&&Bt.has(V);mt&&(K=Ce,G=Ut),Ue!==null&&!mt&&(v.color!==Ue?(ut=Qt,D=Tt):D=kt),ae(C,v.yScr,p,f,v.s,I,k,bt,K,X,ut,null,0,D,G)}if(Re&&Ft.length>0&&!Xe){let v=(performance.now()-ge)/1e3,X=Math.min(1,v/(re?A:m)),K=1-E,G=X>K,ut=G?(X-K)/E:0,D=re?Math.floor(X*K*tt*2)%tt:-1,V=4+X/K*10,mt=Math.sin(v*V*Ot),St=G?1:.5+mt*.5,ft=G?1-ut*.8:1,ht=G?1-ut:1;for(let pt of Ft){let Xt=Ht(L,B,pt.y+.5),_e=Rt(C,Xt,p,f,pt.s,I);if(Math.sin(_e.ang)<-.1)continue;let Oe=B/et*.9,_t,ne,Vt;if(re){let fe=(pt.s-D+tt)%tt,he=fe<4?1-fe/4:0;_t=G?ht:.3+he*.7,ne=`rgba(255, 159, 67, ${_t})`,Vt=G?ft:1+he*.2}else _t=St*ht,ne=pt.isLine?`rgba(255, 255, 255, ${_t*.7})`:`rgba(255, 220, 100, ${_t*.6})`,Vt=G?ft:1.15;ae(C,Xt,p,f,pt.s,I,Oe,ne,1,null,1,null,0,1,Vt)}}let{activePiece:ee,pieceY:we,isGrounded:Pe,lockTimer:Ye}=_;if(ee){let v=Et.snappedRot(),k=v,X=Et.computeGhostY(),K=B/et*.9;if(X!==null){let D=[];for(let V=0;V<ee.cells.length;V++){let mt=ee.cells[V],St=ee.colors[V],ft=X+mt.y,ht=Et.normSector(v+mt.x);if(ft<0||ft>=et)continue;let pt=Ht(L,B,ft+.5),Xt=Rt(C,pt,p,f,ht,k);D.push({cy:ft,cs:ht,yScr:pt,depth:Math.sin(Xt.ang),color:St})}D.sort((V,mt)=>V.depth-mt.depth);for(let V of D){let mt=P[V.color]||null;ae(C,V.yScr,p,f,V.cs,k,K,st,1,mt,.5,de,At,1,1)}}let G=R;if(Pe&&Ye>0){let D=Math.min(1,Ye/Y),V=255,mt=Math.round(170+85*D),St=Math.round(180+75*D),ft=.75+(1-.75)*D;G=`rgba(${V},${mt},${St},${ft})`}let ut=[];for(let D=0;D<ee.cells.length;D++){let V=ee.cells[D],mt=ee.colors[D],St=Et.normSector(v+V.x),ft=we+V.y;if(ft<0||ft>=et)continue;let ht=Ht(L,B,ft+.5),pt=Rt(C,ht,p,f,St,k);ut.push({cs:St,yScr:ht,depth:Math.sin(pt.ang),color:mt})}ut.sort((D,V)=>D.depth-V.depth);for(let D of ut){let V=P[D.color]||null;ae(C,D.yScr,p,f,D.cs,k,K,G,1,V,1,null,0,1,1)}}},drawNextPreview(b,_){if(!b)return;let S=b.getContext("2d"),T=b.width,C=b.height;if(S.clearRect(0,0,T,C),!_)return;let L=1/0,M=-1/0,B=1/0,p=-1/0;for(let F of _.cells)L=Math.min(L,F.x),M=Math.max(M,F.x),B=Math.min(B,F.y),p=Math.max(p,F.y);let f=M-L+1,w=p-B+1,I=Math.min(T/(f+.5),C/(w+.5)),it=(T-f*I)/2,ct=(C-w*I)/2;S.fillStyle=bt;for(let F=0;F<_.cells.length;F++){let Q=_.cells[F],Z=it+(Q.x-L)*I,gt=ct+(w-1-(Q.y-B))*I;S.fillRect(Z+1,gt+1,I-2,I-2);let W=_.colors[F],at=P[W];if(at){let $t=(I-2)*.32;S.fillStyle=at,S.beginPath(),S.arc(Z+I/2,gt+I/2,$t,0,Ot),S.fill(),S.fillStyle=bt}}}}}(()=>{let e=uo(),n=e.canvas,u=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,c=30,o=24,s=120,a={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"16_20":{N:16,H:20,survivalTime:120,name:"Quick Tower"}};function h(t){let i=a[t]||a["30_24"];c=i.N,o=i.H,s=i.survivalTime}function g(){return o/s}let m=Math.PI/2,E=18,N=90,A=260,Y=.36,O="rgb(235,240,250)",P="rgb(55,62,75)",Dt="rgba(255,170,180,0.75)",bt="rgba(110,255,150,0.15)",z="rgba(110,255,150,0.85)",R=2,st={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},de={1:"fire",2:"water",3:"lightning",4:"earth"},At={fire:1,water:2,lightning:3,earth:4},Qt=1,Tt=.58,kt=!0,Zt=12,Lt=25,Et=1,r=2,tt=3,et=5,Gt=8,Ct=10,ce=15,Ee=30,me=2,cn=.3,Ht=.5,Se=1,Me=.3,Ne=.5,an=1.3,Rt=10,rn=500,ae=[1,1.25,1.5,1.75,2],ln=10,un=100,dn=25,b=[1,1.3,1.6,2],_=[1,1.5,2,2.5],S=lo(),T=S.loadGameSettings(),C=T.invertSwipe?-1:1,L=-1,M=Array.from({length:o},()=>new Uint8Array(c));function B(){M=Array.from({length:o},()=>new Uint8Array(c))}let p=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],f=null,w=o+3,I=0,it=0,ct=!1,F=0,Q=0,Z=0,gt=0,W=0,at=po({canvas:n,rotDir:C}),$t="0.13.0",rt=!0,xt="blue",y=io();y.preload();let dt=yo(),nt="intro",lt=0,xe=0,Jt=0,ve=0,Ie=0,jt=null,U=dt.stats,Ae=e.overlay,te=fo({elementColors:st}),Mt=te.showBonus.bind(te),mn=te.getElementIcon.bind(te),In=e.overlayTitle,An=e.overlayStats,Nt=e.startBtn,Fe=e.hud,Ue=e.scoreHud,Re=e.timeHud,Ft=e.remainingHud,ge=e.nextCanvas,Xe=ge.getContext("2d"),Bt=e.pauseBtn,Ut=e.pauseOverlay,Ce=e.resumeBtn,Ve=e.restartBtn,re=e.exitToMenuBtn,ee=e.pauseSettingsBtn,we=e.pauseSoundBtn,Pe=e.pauseMusicBtn,Ye=e.pauseBestScore,v=e.pauseBestTime,k=e.pauseBestMode,X=e.pauseCurrentScore,K=e.pauseCurrentTime,G=e.pauseCurrentMode,ut=e.confirmDialog,D=e.confirmText,V=e.confirmCancel,mt=e.confirmOk,St=e.settingsOverlay,ft=e.settingsClose,ht=e.fullscreenBtn,pt=e.rotateBtn,Xt=e.startPanel,_e=e.gameoverPanel,gn=e.goScore,Oe=e.goTime,_t=e.goMatches,ne=e.goBonuses,Vt=e.goNewRecord,fe=e.goRestartBtn,he=e.goExitBtn,We=e.bestScore,Ke=e.bestExtra,Rn=e.surviveVal,Bo=e.startVersion,wn=e.modeBtns,Io=e.recordsBtn,Ao=e.startSettingsBtn,Ro=e.helpBtn,Yt="16_20",Wt=ho({buttons:e.magicBtns,onActivate:()=>y.play("spells")}),Pn=e.magicBtns,hs=Wt.charges,wo=t=>Wt.select(t),fn=()=>Wt.updateButtons(),oe=[],De=0,se=!1,pe=!1,ke=!1,Kt=0,qt=0,le=0,qe=[];function On(t,i,l){let x=1-l/o;return t+x*i}function Dn(t,i,l,x,H,q){let yt=(H-q)/c*d+m;return{x:t+Math.cos(yt)*l,y:i+Math.sin(yt)*x,ang:yt}}function Po(t,i){let l=n.clientWidth,x=n.clientHeight,H=l*.5,q=E,yt=x-N,wt=Math.max(1,yt-q),It=Math.min(l*Y,A),Te=It*.28,ye=On(q,wt,t+.5),j=Dn(H,ye,It,Te,i,Z);return{x:j.x,y:j.y}}function Oo(t,i){if(!Wt.canUse()||se)return!1;let l=At[Wt.active],x=n.clientWidth,H=n.clientHeight,q=x*.5,yt=E,wt=H-N,It=Math.max(1,wt-yt),Te=Math.min(x*Y,A),ye=Te*.28,j=null,ot=1/0;for(let $=0;$<o;$++){let vt=On(yt,It,$+.5);for(let Pt=0;Pt<c;Pt++){let zt=M[$][Pt];if(!zt||zt!==l)continue;let ie=Dn(q,vt,Te,ye,Pt,Z);if(Math.sin(ie.ang)<-.1)continue;let Le=t-ie.x,to=i-ie.y,eo=Math.hypot(Le,to),no=It/o*.9,cs=no*1.2;Math.abs(Le)<cs/2&&Math.abs(to)<no/2&&eo<ot&&(ot=eo,j={y:$,s:Pt})}}if(j){let $=M[j.y][j.s];return oe=[{y:j.y,s:j.s,color:$,isLine:!1,isMagic:!0}],De=performance.now(),se=!0,pe=!0,Kt=0,qt=dn,Mt(`+${dn}`,"score"),le=0,Wt.useCharge(),U.magicUsed++,!0}return!1}let ps=100;function ys(t,i){return Ln(t,i,o,c)}function Do(){return Mo(M,o,c)}let ko=xo;function Go(t){let i=t.map(x=>({...x,color:M[x.y][x.s]}));for(let x of t)M[x.y][x.s]=0;let l=o;for(let x of t){let H=x.y;for(let q=1;q<=x.y;q++){let yt=x.y-q;if(M[yt][x.s]){H=q-1;break}}l=Math.min(l,H)}for(let x of i)M[x.y-l][x.s]=x.color;return l>0}function Ho(){let t=!0;for(;t;){t=!1;let i=Do();for(let l of i)ko(l)||Go(l)&&(t=!0)}}function $o(){pn()}let hn=Eo;function kn(t,i){let l=new Map,x=0,H=0,q=0,yt={},wt=t.length+i.length;for(let ot of t){let $=de[ot.color],vt=0,Pt=0;if(ot.length>=5?(vt=tt,Pt=Ct,U.lines5++):ot.length===4?(vt=r,Pt=Gt,U.lines4++):ot.length===3&&(vt=Et,Pt=et,U.lines3++),$&&vt>0){Wt.addCharges($,vt),yt[$]=(yt[$]||0)+vt;let zt=ot.cells[Math.floor(ot.cells.length/2)],ie=Po(zt.y,zt.s),jn=Pn[$];for(let Le=0;Le<vt;Le++)setTimeout(()=>{te.spawnMagicOrb($,ie.x,ie.y,jn)},Le*100)}x+=Pt*g(),q+=Pt,H+=ot.length*ln;for(let zt of ot.cells){let ie=`${zt.y},${zt.s}`;l.has(ie)||l.set(ie,{y:zt.y,s:zt.s,color:ot.color,isLine:!0})}}for(let ot of i){U.pairs++,x+=ce*g(),q+=ce,H+=un;for(let $ of ot.cells){let vt=`${$.y},${$.s}`;l.has(vt)||l.set(vt,{y:$.y,s:$.s,color:M[$.y][$.s],isLine:!1})}}let It=hn(b,wt-1),Te=hn(_,le),ye=Math.round(H*It*Te),j=0;wt>1&&(U.combos++,U.maxCombo=Math.max(U.maxCombo,wt),setTimeout(()=>Mt(`COMBO \xD7${wt}`,"combo"),j),j+=180,y.play("combo2")),le>0&&(U.cascades++,U.maxCascade=Math.max(U.maxCascade,le),setTimeout(()=>Mt(`CASCADE \xD7${le}`,"cascade"),j),j+=180,y.play("cascade")),(t.length>0||i.length>0)&&y.play("combo");for(let ot of t){let $=ot.length,vt=$*ln;setTimeout(()=>Mt(`Line-${$} +${vt}`,"line",ot.color),j),j+=100}for(let ot of i){let $=ot.cells.length>0?M[ot.cells[0].y][ot.cells[0].s]:null;setTimeout(()=>Mt(`Pair +${un}`,"pair",$),j),j+=100}ye>0&&(setTimeout(()=>Mt(`+${ye}`,"score"),j),j+=120),q>0&&(setTimeout(()=>Mt(`+${q}s`,"time"),j),j+=120);for(let[ot,$]of Object.entries(yt))$>0&&(setTimeout(()=>Mt(`+${$}${mn(ot)}`,"charge"),j),j+=120);oe=Array.from(l.values()),De=performance.now(),se=!0,pe=!1,Kt=x,qt=ye,fn()}function No(){for(let t of oe)M[t.y][t.s]=0;oe.length>0&&y.playRandom("disappear"),Kt>0&&(Q=Math.max(0,Q-Kt)),dt.addScore(qt),lt+=qt,Je(),oe=[],se=!1,pe=!1,Kt=0,qt=0,le++,pn()}function pn(){Ho();let{lineMatches:t,pairMatches:i}=Qo();if(t.length>0||i.length>0)kn(t,i);else{let l=Un();l.length>0?Ko(l):!f&&nt==="playing"&&Fn()}}function Es(t,i){kn(t,i)}function yn(t){return Be(t,c)}function ze(){return yn(Math.round(Z))}function Gn(t,i){return Bn(f,t,i,M,o,c)}function Qe(t){return Gn(t,ze())}let Ze=So;function Hn(){kt&&(Zt!==0&&F>=Zt||(it=0,F+=1))}function Fo(){if(!f)return;let t=f.cells,i=f.colors,l={cells:t,colors:i};if(L>=0||(l=Ze(l.cells,l.colors),l=Ze(l.cells,l.colors)),l=Ze(l.cells,l.colors),f.cells=l.cells,f.colors=l.colors,!Qe(Math.floor(w))){f.cells=t,f.colors=i;return}y.play("turn"),ct&&Hn()}function Uo(){return vo(f,w,ze(),M,o,c)}function Xo(){if(!f)return!1;let t=Math.floor(w)-1,i=!Qe(t);return i&&!ct?(ct=!0,it=0,F=0):!i&&ct&&(ct=!1,it=0,F=0),i}let be=sn;function Ge(){if(nt==="playing"){Ae.classList.add("hidden"),Bt.classList.remove("hidden");return}if(Ae.classList.remove("hidden"),Bt.classList.add("hidden"),nt==="intro"){Xt.classList.remove("hidden"),_e.classList.add("hidden");let t=Math.floor(s/60),i=s%60;Rn.textContent=`${t}:${i.toString().padStart(2,"0")}`;let l=S.loadHighscore(Yt);l.score>0?(We.textContent=l.score.toLocaleString(),Ke.textContent=`(${be(l.time)})`):(We.textContent="0",Ke.textContent=""),Bo.textContent=`v${$t}`,Nt.classList.remove("idlePulse"),Nt.offsetWidth,Nt.classList.add("idlePulse")}else{Xt.classList.add("hidden"),_e.classList.remove("hidden"),gn.textContent=lt.toLocaleString(),Oe.textContent=be(Jt);let t=S.loadHighscore(Yt);lt>0&&lt>=t.score?Vt.classList.remove("hidden"):Vt.classList.add("hidden");let i=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${U.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${U.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${U.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${U.pairs}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2B55</span>
          <span class="name">Ring</span>
          <span class="count">\xD7${U.rings}</span>
        </div>
      `;_t.innerHTML=i;let l=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${U.combos}</span>
          <span class="count">${U.maxCombo>0?"max \xD7"+U.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${U.cascades}</span>
          <span class="count">${U.maxCascade>0?"max \xD7"+U.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${U.magicUsed}</span>
        </div>
      `;ne.innerHTML=l}}function Je(){Ue.textContent=`Score: ${lt}`}function En(){Re.textContent=`Time: ${be(Jt)}`}function $n(){let t=Math.max(0,(o-Q)/g()),i=Math.floor(t/60),l=Math.floor(t%60);Ft.textContent=`Left: ${i}:${l.toString().padStart(2,"0")}`,t<30?Ft.classList.add("warning"):Ft.classList.remove("warning")}function Vo(){h(Yt),B(),Q=0,Z=gt=0,W=0,dt.start(),lt=0,xe=performance.now(),Jt=0,Ie=0,ve=0,nt="playing",jt=null,Wt.reset(),oe=[],qe=[],se=!1,pe=!1,ke=!1,Kt=0,qt=0,le=0,fn(),Je(),En(),$n(),Fn(),_n.drawNextPreview(ge,jt),Ge(),y.getSettings().musicEnabled&&y.startGameMusic()}function Sn(){dt.gameOver(),nt="gameover",f=null,ct=!1,it=0,F=0;let t=S.saveHighscore(lt,Jt,Yt);y.stopMusic(),y.play("gameover"),setTimeout(()=>{(nt==="gameover"||nt==="intro")&&y.startMenuMusic()},2500),En(),Ge(),t&&lt>0&&setTimeout(()=>{Mt("\u{1F3C6} NEW RECORD!","score")},500)}function Yo(t){for(let l=0;l<50;l++){let x=t.map(()=>1+(Math.random()*4|0));if(!Wo(t,x))return x}return t.map((l,x)=>1+x%4)}let Wo=bo;function Nn(t){let i=t.cells.map(x=>({x:x.x,y:x.y})),l=Yo(i);return{name:t.name,cells:i,colors:l}}function Fn(){if(!jt){let H=p[Math.random()*p.length|0];jt=Nn(H)}f=jt;let t=p[Math.random()*p.length|0];jt=Nn(t),_n.drawNextPreview(ge,jt);let i=1/0,l=-1/0;for(let H of f.cells)H.x<i&&(i=H.x),H.x>l&&(l=H.x);let x=(i+l)/2;for(let H of f.cells)H.x=H.x-Math.round(x);w=o+3,I=0,ct=!1,it=0,F=0,Qe(Math.floor(w))?y.playRandom("appear"):Sn()}function Un(){return _o(M,o,c)}function Ko(t){if(t.length===0)return;let i=[];for(let wt of t)for(let It=0;It<c;It++)i.push({y:wt,s:It,color:M[wt][It],isLine:!1});qe=t,oe=i,De=performance.now(),se=!0,ke=!0,pe=!1;let l=t.length;U.rings+=l;let x=hn(ae,l-1),H=Math.round(rn*l*x),q=Ee*l;qt=H,Kt=q*g(),y.play("ring");let yt=`RING \xD7${l}`;Mt(yt,"ring"),setTimeout(()=>Mt(`+${H}`,"score"),150),setTimeout(()=>Mt(`+${q}s`,"time"),300)}function qo(){let t=[...qe].sort((i,l)=>l-i);for(let i of t){for(let l=i;l<o-1;l++)M[l].set(M[l+1]);M[o-1].fill(0)}Kt>0&&(Q=Math.max(0,Q-Kt)),dt.addScore(qt),lt+=qt,Je(),oe=[],qe=[],se=!1,ke=!1,Kt=0,qt=0,pn()}function Ss(){return Un().length}function zo(){if(!f)return;let t=ze();Z=t,gt=t,W=0;let i=!1;for(let l=0;l<f.cells.length;l++){let x=f.cells[l],H=f.colors[l],q=Math.floor(w)+x.y,yt=yn(t+x.x);q>=o&&(i=!0),q>=0&&q<o&&(M[q][yt]=H)}if(i){Sn();return}dt.addScore(Rt),lt+=Rt,Je(),Mt(`+${Rt}`,"score"),y.playRandom("drop"),f=null,le=0,$o()}function Qo(){return Co(M,o,c)}function Zo(){if(!f)return!1;let t=Math.floor(w)-1;return Qe(t)?(w=t,ct=!1,it=0,F=0,!0):(ct=!0,!1)}n.addEventListener("pointerdown",t=>{if(J.state!=="playing")return;t.preventDefault?.(),at.handlePointerDown(t,{onMagicTap:(l,x)=>J.applyCommand("magic_shoot",{x:l,y:x}),onDoubleTap:()=>J.applyCommand("rotate_piece")},gt)||(W=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(J.state!=="playing"||!at.dragging)return;t.preventDefault?.();let i=at.handlePointerMove(t,{canRotateTo:(l,x)=>J.canRotateTo(l,x),onDrop:()=>J.applyCommand("move_down"),onGroundedMove:()=>J.onGroundedMove()},J.pieceY,J.isGrounded);i&&J.setRotation(i.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{J.state==="playing"&&at.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{at.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{at.dragging&&at.handlePointerUp(t)},{passive:!1}),pt.addEventListener("click",()=>{J.state==="playing"&&J.applyCommand("rotate_piece")});let je=e.dropBtn,tn=null;function Jo(){J.state==="playing"&&(J.applyCommand("move_down"),tn=setInterval(()=>{if(J.state!=="playing"){en();return}J.applyCommand("move_down")},Lt))}function en(){tn&&(clearInterval(tn),tn=null)}je.addEventListener("pointerdown",t=>{t.preventDefault(),Jo()}),je.addEventListener("pointerup",en),je.addEventListener("pointerleave",en),je.addEventListener("pointercancel",en);for(let[t,i]of Object.entries(Pn))i.addEventListener("click",()=>{J.state==="playing"&&J.applyCommand("select_magic",{element:t})});let Mn=e.soundsToggle,xn=e.musicToggle;function ue(){let t=y.getSettings();t.soundsEnabled?Mn.classList.add("active"):Mn.classList.remove("active"),t.musicEnabled?xn.classList.add("active"):xn.classList.remove("active");for(let i=0;i<=4;i++){let l=e.soundVolBtns[i],x=e.musicVolBtns[i];l&&l.classList.toggle("active",t.soundVolume===i),x&&x.classList.toggle("active",t.musicVolume===i)}}let Xn=e.tabBtns,jo=e.tabContents;Xn.forEach(t=>{t.addEventListener("click",()=>{let i=t.dataset.tab;Xn.forEach(l=>l.classList.remove("active")),jo.forEach(l=>l.classList.remove("active")),t.classList.add("active"),mo(i).classList.add("active"),i==="sounds"&&ue()})});let Vn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Yn=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,ts=e.iosHint,es=e.standaloneBadge;function Wn(){let t=document.fullscreenElement||document.webkitFullscreenElement;ht.textContent=t?"Disable":"Enable"}Vn&&(Yn?(es.style.display="block",ht.style.display="none"):(ts.style.display="block",ht.textContent="Not supported",ht.style.opacity="0.5",ht.style.cursor="default")),ht.addEventListener("click",()=>{if(Vn&&!Yn)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let i=document.documentElement;i.requestFullscreen?i.requestFullscreen():i.webkitRequestFullscreen&&i.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Wn),document.addEventListener("webkitfullscreenchange",Wn);let nn=e.invertSwipeToggle;T.invertSwipe&&nn.classList.add("active"),nn.addEventListener("click",()=>{nn.classList.toggle("active");let t=nn.classList.contains("active");at.rotDir=t?-1:1,T.invertSwipe=t,S.saveGameSettings(T)});let Kn=e.diffBtns;Kn.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Kn.forEach(i=>{i.classList.remove("active");let l=i.querySelector(".check-icon");l&&l.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let i=document.createElement("span");i.className="check-icon",i.textContent="\u2713",t.appendChild(i)}})}),Mn.addEventListener("click",()=>{let i=!y.getSettings().soundsEnabled;y.updateSettings({soundsEnabled:i}),ue(),He()}),xn.addEventListener("click",()=>{let i=!y.getSettings().musicEnabled;y.updateSettings({musicEnabled:i}),ue(),He(),nt!=="paused"&&(i?nt==="playing"?y.startGameMusic():y.startMenuMusic():y.stopMusic())});for(let t=0;t<=4;t++){let i=e.soundVolBtns[t];i&&i.addEventListener("click",()=>{y.updateSettings({soundVolume:t}),ue(),y.play("turn")})}for(let t=0;t<=4;t++){let i=e.musicVolBtns[t];i&&i.addEventListener("click",()=>{y.updateSettings({musicVolume:t}),ue()})}ue();function qn(){nt==="playing"&&(dt.pause(),ve=performance.now(),nt="paused",y.musicAudio&&y.musicAudio.pause())}function on(){nt==="paused"&&(dt.resume(),Ie+=performance.now()-ve,ve=0,nt="playing",bn=performance.now(),y.getSettings().musicEnabled&&y.startGameMusic())}function He(){let t=y.getSettings();we.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",we.classList.toggle("off",!t.soundsEnabled),Pe.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Pe.classList.toggle("off",!t.musicEnabled)}function ns(){Ut.classList.remove("hidden"),Bt.classList.add("hidden");let t=S.loadHighscore(Yt);Ye.textContent=t.score?t.score.toLocaleString():"0",v.textContent=t.time?sn(t.time):"0:00",k.textContent=Yt==="30_24"?"High Tower":"Quick Tower",X.textContent=lt.toLocaleString(),K.textContent=sn(Jt),G.textContent=Yt==="30_24"?"High Tower":"Quick Tower",He()}function $e(){Ut.classList.add("hidden"),Bt.classList.remove("hidden")}Bt.addEventListener("click",()=>{qn(),ns()}),Ce.addEventListener("click",()=>{$e(),on()});let vn=null;function zn(t,i){D.textContent=t,vn=i,ut.classList.remove("hidden")}function Qn(){ut.classList.add("hidden"),vn=null}V.addEventListener("click",()=>{Qn()}),mt.addEventListener("click",()=>{let t=vn;Qn(),t&&t()}),Ve.addEventListener("click",()=>{zn("Restart game?",()=>{$e(),J.applyCommand("start_game")})}),re.addEventListener("click",()=>{zn("Exit to menu?",()=>{$e(),Bt.classList.add("hidden"),nt="intro",dt.reset(),y.stopMusic(),y.getSettings().musicEnabled&&y.startMenuMusic(),Ge()})}),ee.addEventListener("click",()=>{St.classList.remove("hidden")}),we.addEventListener("click",()=>{let t=y.getSettings();y.updateSettings({soundsEnabled:!t.soundsEnabled}),He(),ue()}),Pe.addEventListener("click",()=>{let i=!y.getSettings().musicEnabled;y.updateSettings({musicEnabled:i}),He(),ue()}),Ut.addEventListener("click",t=>{t.target===Ut&&($e(),on())}),document.addEventListener("keydown",t=>{nt==="paused"&&!Ut.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&($e(),on())}),ft.addEventListener("click",()=>{St.classList.add("hidden")}),St.addEventListener("click",t=>{t.target===St&&St.classList.add("hidden")});let Cn=!1;document.addEventListener("visibilitychange",()=>{document.hidden?nt==="playing"&&(qn(),Cn=!0):Cn&&nt==="paused"&&(on(),Cn=!1)});let J=To({getN:()=>c,getH:()=>o,FALL_INTERVAL:Qt,LOCK_DELAY_SEC:Tt,getKillRate:g,MATCH_HIGHLIGHT_SEC:me,MAGIC_SHRINK_SEC:Ht,RING_HIGHLIGHT_SEC:Se,getState:()=>({gameState:nt,score:lt,elapsedMs:Jt,startTime:xe,totalPausedMs:Ie,stats:U,activePiece:f,pieceY:w,targetRot:gt,rotFloat:Z,rotVel:W,isGrounded:ct,isHighlighting:se,isMagicAnimation:pe,isRingAnimation:ke,highlightStartTime:De,killLevel:Q,grid:M,fallTimer:I,lockTimer:it}),setState:t=>{"elapsedMs"in t&&(Jt=t.elapsedMs),"killLevel"in t&&(Q=t.killLevel),"fallTimer"in t&&(I=t.fallTimer),"lockTimer"in t&&(it=t.lockTimer),"targetRot"in t&&(gt=t.targetRot),"rotFloat"in t&&(Z=t.rotFloat),"rotVel"in t&&(W=t.rotVel)},funcs:{startGame:Vo,endGame:Sn,rotatePieceByDir:Fo,tryMoveDown:Zo,canPlaceAtRot:Gn,maybeResetLockDelay:Hn,shootMagic:Oo,selectMagic:wo,updateGroundedState:Xo,lockPiece:zo,finishHighlight:No,finishRingHighlight:qo},ui:{updateTimeHud:En,updateRemainingHud:$n}}),_n=Lo({canvas:n,canvasCtx:u,getN:()=>c,getH:()=>o,TOP_PAD_PX:E,BOTTOM_PAD_PX:N,MAX_RADIUS_X:A,RADIUS_X_FACTOR:Y,ANG_OFFSET:m,MATCH_HIGHLIGHT_SEC:me,MATCH_SHRINK_PHASE:cn,MAGIC_SHRINK_SEC:Ht,RING_HIGHLIGHT_SEC:Se,LOCK_DELAY_SEC:Tt,getKillRate:g,ELEMENT_COLORS:st,ELEMENT_TO_COLOR:At,BLOCK_COLOR_FRONT:O,BLOCK_COLOR_BACK:P,ACTIVE_COLOR_FRONT:Dt,GHOST_COLOR_FILL:bt,GHOST_COLOR_STROKE:z,GHOST_STROKE_WIDTH:R,MAGIC_DIM_DOT_ALPHA:Me,MAGIC_DIM_DOT_SCALE:Ne,MAGIC_TARGET_DOT_SCALE:an,getState:()=>({gameState:nt,grid:M,activePiece:f,pieceY:w,rotFloat:Z,killLevel:Q,isHighlighting:se,highlightedCells:oe,highlightStartTime:De,isMagicAnimation:pe,isRingAnimation:ke,isGrounded:ct,lockTimer:it}),getVisualSettings:()=>({waterBubbles:rt,waterColor:xt}),funcs:{snappedRot:ze,computeGhostY:Uo,normSector:yn,getMagicTargetColor:()=>Wt.canUse()?At[Wt.active]:null}}),bn=performance.now();function Zn(t){let i=Math.min(.05,Math.max(.001,(t-bn)/1e3));bn=t,J.update(i,t),Z=gt,Z>1e6&&(Z%=c),Z<-1e6&&(Z%=c),_n.render(i),requestAnimationFrame(Zn)}Nt.addEventListener("click",()=>{J.applyCommand("start_game")}),fe.addEventListener("click",()=>{J.applyCommand("start_game")}),he.addEventListener("click",()=>{nt="intro",dt.reset(),y.stopMusic(),y.getSettings().musicEnabled&&y.startMenuMusic(),Ge()}),wn.forEach(t=>{t.addEventListener("click",()=>{wn.forEach(q=>q.classList.remove("active")),t.classList.add("active"),Yt=t.dataset.mode;let i=S.loadHighscore(Yt);i.score>0?(We.textContent=i.score.toLocaleString(),Ke.textContent=`(${be(i.time)})`):(We.textContent="0",Ke.textContent="");let l=a[Yt]||a["30_24"],x=Math.floor(l.survivalTime/60),H=l.survivalTime%60;Rn.textContent=`${x}:${H.toString().padStart(2,"0")}`,Nt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>Nt.classList.add("idlePulse"),2e3)})}),Io.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),i=S.loadHighscore("16_20"),l=`Records

`;l+=`High Tower (30\xD724):
`,l+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${be(t.time)}
`:`  No record yet
`,l+=`
Quick Tower (16\xD720):
`,l+=i.score>0?`  Score: ${i.score.toLocaleString()}, Time: ${be(i.time)}
`:`  No record yet
`,alert(l)}),Ao.addEventListener("click",()=>{St.classList.remove("hidden")}),Ro.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),fn(),Ge(),y.startMenuMusic();let os=()=>{if(y.unlock(),!y.getSettings().musicEnabled)return;let t=y.musicAudio;!t||t.paused||t.ended?J.state==="playing"?y.startGameMusic():y.startMenuMusic():t.play().catch(i=>{console.debug("Music resume on interaction failed:",i)})},Jn=0,ss=10,is=()=>{Jn>=ss||(Jn++,os())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,is,{passive:!0})}),requestAnimationFrame(Zn)})();})();
