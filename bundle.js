(()=>{var ls=[0,.25,.5,.75,1],rs=[0,.05,.15,.25,.5],us={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},un={menu:"music/mm.mp3",game:"sounds/amb1.wav"},dn="soundSettings";function ds(){try{let e=localStorage.getItem(dn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function fs(e){try{localStorage.setItem(dn,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function fn(){return{audioContext:null,buffers:{},settings:ds(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ls[this.settings.soundVolume]},getMusicVolume(){return rs[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(r){console.debug(`Failed to load sound: ${n} from ${c}`,r)}},preload(){this.initContext();for(let[n,c]of Object.entries(us))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let r=n;c!==null&&(r=`${n}${c}`);let i=this.buffers[r];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let o=this.audioContext.createBufferSource();o.buffer=i,o.connect(s),o.start(0),o.onended=()=>{o.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(un.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(un.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},fs(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var mn="eb_highscore",gn="eb_settings",ms={invertSwipe:!1,difficulty:"easy"};function pn(){return{loadHighscore(){try{let e=localStorage.getItem(mn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load highscore:",e)}return{score:0,time:0}},saveHighscore(e,n){try{let c=this.loadHighscore();if(e>c.score||e===c.score&&n>c.time)return localStorage.setItem(mn,JSON.stringify({score:e,time:n})),!0}catch(c){console.debug("Failed to save highscore:",c)}return!1},loadGameSettings(){try{let e=localStorage.getItem(gn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ms}},saveGameSettings(e){try{localStorage.setItem(gn,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}}}}function hn(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),settingsBtn:document.getElementById("settingsBtn"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function yn(e){return document.getElementById("tab-"+e)}var gs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Sn(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(r,i="score",s=null){let o=document.createElement("div");o.className=`bonus-popup ${i}`,o.textContent=r,s&&n[s]&&(o.style.color=n[s]);let l=window.innerWidth/2,g=window.innerHeight/2-40,p=(Math.random()-.5)*200,f=(Math.random()-.5)*100+c*36;o.style.left=`${l+p}px`,o.style.top=`${g+f}px`,o.style.transform="translate(-50%, -50%)",document.body.appendChild(o),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{o.remove()},1800)},getElementIcon(r){return gs[r]||"\u2726"}}}function En(e={}){let{buttons:n={},onActivate:c=null}=e,r={fire:3,water:3,lightning:3,earth:3},i=null;function s(){for(let[o,l]of Object.entries(n)){if(!l)continue;let g=r[o],p=l.querySelector(".charges");p&&(p.textContent=g),l.classList.toggle("empty",g<=0),l.classList.toggle("active",i===o&&g>0)}}return{get charges(){return r},get active(){return i},set active(o){i=o},select(o){if(r[o]<=0)return!1;let l=i===o;return i=l?null:o,s(),!l&&i===o&&c&&c(),!l},useCharge(){return!i||r[i]<=0?!1:(r[i]--,i=null,s(),!0)},addCharges(o,l){r[o]!==void 0&&(r[o]+=l,s())},canUse(){return i!==null&&r[i]>0},deactivate(){i=null,s()},reset(){r.fire=3,r.water=3,r.lightning=3,r.earth=3,i=null,s()},updateButtons:s,initButtons(o){for(let[l,g]of Object.entries(n))g&&g.addEventListener("click",()=>{o&&o(l)})}}}var ps={PX_PER_STEP:16,DEADZONE_PX:2,PX_PER_DROP:18,AXIS_DOMINANCE:1.1,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:400,DROP_SWIPE_MIN_DISTANCE:12,DOUBLE_TAP_MS:280,DOUBLE_TAP_MAX_DIST:18};function Mn(e={}){let{canvas:n}=e,c=e.rotDir||1,r=!1,i=0,s=0,o=0,l=0,g=0,p=1,f=null,y=0,W=0,D=0,j=0,C=0,V=0,yt=0,$t=0,$=ps;return{get rotDir(){return c},set rotDir(b){c=b},get dragging(){return r},get dragMode(){return f},handlePointerDown(b,Z,oe){if(Z.onMagicTap&&Z.onMagicTap(b.clientX,b.clientY))return!0;let Nt=performance.now(),Wt=Nt-V,_t=b.clientX-yt,Ct=b.clientY-$t,wt=Math.hypot(_t,Ct);return Wt<=$.DOUBLE_TAP_MS&&wt<=$.DOUBLE_TAP_MAX_DIST?(Z.onDoubleTap&&Z.onDoubleTap(),V=0):(V=Nt,yt=b.clientX,$t=b.clientY),r=!0,p=-1,i=b.clientX,s=b.clientY,o=oe,l=0,g=0,f=null,y=Nt,W=b.clientX,D=b.clientY,j=y,C=0,n&&n.setPointerCapture(b.pointerId),!1},handlePointerMove(b,Z,oe,Nt){if(!r)return null;let Wt=b.clientX-i,_t=b.clientY-s,Ct=performance.now();if(Math.abs(Wt)<$.DEADZONE_PX&&Math.abs(_t)<$.DEADZONE_PX)return null;if(!f){let d=Math.abs(Wt),ot=Math.abs(_t);if(_t<0)d>=$.DEADZONE_PX&&(f="rotate");else if(ot>=d*$.AXIS_DOMINANCE){if(ot>=$.DROP_SWIPE_MIN_DISTANCE){let N=Math.max(1,Ct-y);ot/N*1e3>=$.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else d>=ot*$.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let wt=null;if(f==="rotate"&&Math.abs(Wt)>=$.DEADZONE_PX){let d=Math.max(1,Ct-j),ot=b.clientX-W,N=Math.max(1,Math.abs(ot)/d*1e3),Tt=Math.max($.MIN_ROT_PX,Math.min($.MAX_ROT_PX,$.PX_PER_STEP*($.SWIPE_SPEED_REF/N)));C+=-ot/Tt*c*p;let L=Math.trunc(C);L!==0&&(C-=L);let R=l+L;if(R!==l&&Z.canRotateTo){let T=Math.sign(R-l),E=o+l;for(;l!==R;){let B=l+T,Q=o+B;if(!Z.canRotateTo(Math.floor(oe),Q))break;l=B,E=Q,Nt&&Z.onGroundedMove&&Z.onGroundedMove()}wt={targetRot:E,rotFloat:E}}}if(f==="drop"&&_t>$.DEADZONE_PX&&Z.onDrop){let d=Math.max(1,Ct-j),ot=b.clientY-D,N=Math.max(1,ot/d*1e3),Tt=Math.max($.MIN_DROP_PX,Math.min($.MAX_DROP_PX,$.PX_PER_DROP*($.SWIPE_SPEED_REF/N))),L=Math.trunc(_t/Tt);if(L>g){let R=L-g;for(let T=0;T<R;T++)Z.onDrop();g=L}}return W=b.clientX,D=b.clientY,j=Ct,wt},handlePointerUp(b){r&&(r=!1,n&&n.releasePointerCapture(b.pointerId))},reset(){r=!1,f=null,l=0,g=0,C=0}}}var Ue={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function xn(){let e="intro",n=0,c=0,r=0,i=0,s=0,o={...Ue};return{get state(){return e},get score(){return n},get elapsedMs(){return r},get startTime(){return c},get stats(){return o},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),r=0,i=0,s=0,o={...Ue}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(l){n+=l},setScore(l){n=l},updateTime(){e==="playing"&&c>0&&(r=performance.now()-c-s)},getFormattedTime(){let l=Math.floor(r/1e3),g=Math.floor(l/60),p=l%60;return`${g}:${p.toString().padStart(2,"0")}`},incrementStat(l,g=1){l in o&&(o[l]+=g)},updateMaxStat(l,g){l in o&&g>o[l]&&(o[l]=g)},reset(){e="intro",n=0,c=0,r=0,i=0,s=0,o={...Ue}}}}function ye(e,n){return e%=n,e<0&&(e+=n),e}function vn(e,n){return e[Math.min(n,e.length-1)]}function _n(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),r=n%60;return`${c}:${r.toString().padStart(2,"0")}`}function Cn(e,n){let c=e.map(({x:l,y:g},p)=>({x:g,y:-l,color:n[p]})),r=1/0,i=-1/0,s=1/0;for(let l of c)r=Math.min(r,l.x),i=Math.max(i,l.x),s=Math.min(s,l.y);let o=Math.round((r+i)/2);for(let l of c)l.x-=o,l.y-=s;return c.sort((l,g)=>l.y-g.y||l.x-g.x),{cells:c.map(l=>({x:l.x,y:l.y})),colors:c.map(l=>l.color)}}function Xe(e,n,c,r){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:ye(n-1,r)}),i.push({y:e,s:ye(n+1,r)}),i}function Tn(e,n,c){let r=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let o=0;o<c;o++){if(!e[s][o]||r[s][o])continue;let l=[],g=[{y:s,s:o}];for(r[s][o]=1;g.length>0;){let p=g.shift();l.push(p);for(let f of Xe(p.y,p.s,n,c))e[f.y][f.s]&&!r[f.y][f.s]&&(r[f.y][f.s]=1,g.push(f))}i.push(l)}return i}function An(e){return e.some(n=>n.y===0)}function Ve(e,n,c,r,i,s){if(!e)return!1;let o=ye(c,s);for(let l of e.cells){let g=n+l.y,p=ye(o+l.x,s);if(g<0)return!1;if(!(g>=i)&&r[g][p])return!1}return!0}function bn(e,n,c,r,i,s){if(!e)return null;let o=Math.floor(n);for(;Ve(e,o-1,c,r,i,s);)o-=1;return o}function Ln(e,n,c){let r=[],i=[];for(let s=0;s<n;s++){let o=[],l=0,g=e[s][0],p=g?1:0;for(let f=1;f<=c;f++){let y=f<c?e[s][f]:0;y&&y===g?p++:(p>=1&&g&&o.push({start:l,length:p,color:g}),l=f,g=y,p=y?1:0)}if(o.length>=2){let f=o[0],y=o[o.length-1];if(f.start===0&&y.start+y.length===c&&f.color===y.color){let W=f.length+y.length;o[0]={start:y.start,length:W,color:f.color},o.pop()}}for(let f of o)if(f.length>=3){let y=[];for(let W=0;W<f.length;W++)y.push({y:s,s:(f.start+W)%c});r.push({color:f.color,length:f.length,cells:y})}}for(let s=0;s<c;s++){let o=0,l=e[0][s],g=l?1:0;for(let p=1;p<=n;p++){let f=p<n?e[p][s]:0;if(f&&f===l)g++;else{if(g>=3&&l){let y=[];for(let W=0;W<g;W++)y.push({y:o+W,s});r.push({color:l,length:g,cells:y})}o=p,l=f,g=f?1:0}}}for(let s=0;s<n;s++)for(let o=0;o<c;o++){let l=e[s][o],g=e[s][(o+1)%c],p=e[s][(o+2)%c],f=e[s][(o+3)%c];l&&l===g&&p&&p===f&&l!==p&&i.push({cells:[{y:s,s:o},{y:s,s:(o+1)%c},{y:s,s:(o+2)%c},{y:s,s:(o+3)%c}]})}for(let s=0;s<c;s++)for(let o=0;o<n-3;o++){let l=e[o][s],g=e[o+1][s],p=e[o+2][s],f=e[o+3][s];l&&l===g&&p&&p===f&&l!==p&&i.push({cells:[{y:o,s},{y:o+1,s},{y:o+2,s},{y:o+3,s}]})}return{lineMatches:r,pairMatches:i}}function Rn(e,n,c){let r=[];for(let i=0;i<n;i++){let s=!0;for(let o=0;o<c;o++)if(!e[i][o]){s=!1;break}s&&r.push(i)}return r}function In(e,n){let c=new Map;e.forEach((r,i)=>c.set(`${r.x},${r.y}`,n[i]));for(let r=0;r<e.length;r++){let i=e[r],s=n[r],o=1;for(let V=1;V<=2&&c.get(`${i.x+V},${i.y}`)===s;V++)o++;if(o>=3)return!0;let l=1;for(let V=1;V<=2&&c.get(`${i.x},${i.y+V}`)===s;V++)l++;if(l>=3)return!0;let g=s,p=c.get(`${i.x+1},${i.y}`),f=c.get(`${i.x+2},${i.y}`),y=c.get(`${i.x+3},${i.y}`);if(g&&p&&f&&y&&g===p&&f===y&&g!==f)return!0;let W=s,D=c.get(`${i.x},${i.y+1}`),j=c.get(`${i.x},${i.y+2}`),C=c.get(`${i.x},${i.y+3}`);if(W&&D&&j&&C&&W===D&&j===C&&W!==j)return!0}return!1}function On(e){let{N:n,H:c,FALL_INTERVAL:r,LOCK_DELAY_SEC:i,KILL_RATE:s,MATCH_HIGHLIGHT_SEC:o,MAGIC_SHRINK_SEC:l,RING_HIGHLIGHT_SEC:g,getState:p,setState:f,funcs:y,ui:W}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(D,j={}){let C=p();if(D==="start_game")return C.gameState!=="playing"?(y.startGame(),!0):!1;if(C.gameState!=="playing")return!1;switch(D){case"rotate_piece":return y.rotatePieceByDir(),!0;case"move_down":return y.tryMoveDown();case"rotate_cylinder":{let{rot:V}=j;return typeof V=="number"&&y.canPlaceAtRot(Math.floor(C.pieceY),V)?(f({targetRot:V,rotFloat:V,rotVel:0}),C.isGrounded&&y.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:V,y:yt}=j;return y.shootMagic(V,yt)}case"select_magic":{let{element:V}=j;return y.selectMagic(V),!0}default:return console.warn("GameEngine: unknown command",D),!1}},update(D,j){let C=p();if(C.gameState!=="playing")return;let V=j-C.startTime-C.totalPausedMs;f({elapsedMs:V}),W.updateTimeHud();let yt=C.killLevel+s*D;if(f({killLevel:yt}),yt>=c){y.endGame();return}if(C.isHighlighting){let b=(j-C.highlightStartTime)/1e3,Z;C.isRingAnimation?Z=g:C.isMagicAnimation?Z=l:Z=o,b>=Z&&(C.isRingAnimation?y.finishRingHighlight():y.finishHighlight())}let $t=C.fallTimer+D;if($t>=r&&($t-=r,y.tryMoveDown()),f({fallTimer:$t}),y.updateGroundedState()){let b=C.lockTimer+D;f({lockTimer:b}),b>=i&&y.lockPiece()}},reset(){y.startGame()},canRotateTo(D,j){return y.canPlaceAtRot(D,j)},getRotation(){let D=p();return{targetRot:D.targetRot,rotFloat:D.rotFloat,rotVel:D.rotVel}},setRotation(D){f({targetRot:D,rotFloat:D,rotVel:0})},onGroundedMove(){y.maybeResetLockDelay()}}}var Qt=Math.PI*2;function wn(e){let{canvas:n,canvasCtx:c,N:r,H:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:o,MAX_RADIUS_X:l,RADIUS_X_FACTOR:g,ANG_OFFSET:p,MATCH_HIGHLIGHT_SEC:f,MATCH_SHRINK_PHASE:y,MAGIC_SHRINK_SEC:W,RING_HIGHLIGHT_SEC:D,LOCK_DELAY_SEC:j,ELEMENT_COLORS:C,ELEMENT_TO_COLOR:V,BLOCK_COLOR_FRONT:yt,BLOCK_COLOR_BACK:$t,ACTIVE_COLOR_FRONT:$,GHOST_COLOR_FILL:b,GHOST_COLOR_STROKE:Z,GHOST_STROKE_WIDTH:oe,MAGIC_DIM_DOT_ALPHA:Nt,MAGIC_DIM_DOT_SCALE:Wt,MAGIC_TARGET_DOT_SCALE:_t,getState:Ct,funcs:wt}=e,d=c;function ot(L,R,T){let E=1-T/i;return L+E*R}function N(L,R,T,E,B,Q){let U=(B-Q)/r*Qt+p;return{x:L+Math.cos(U)*T,y:R+Math.sin(U)*E,ang:U}}function Tt(L,R,T,E,B,Q,U,v=1,I=null,Ut=1,q=null,ut=0,de=1){d.save(),d.translate(L,R);let lt=Math.atan2(E,T);if(d.rotate(lt),d.globalAlpha=v,d.fillStyle=U,d.fillRect(-B/2,-Q/2,B,Q),q&&ut>0&&(d.strokeStyle=q,d.lineWidth=ut,d.strokeRect(-B/2,-Q/2,B,Q)),I){let at=Math.min(B,Q)*.28*de;d.globalAlpha=v*Ut,d.fillStyle=I,d.beginPath(),d.arc(0,0,at,0,Qt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let L=Math.max(1,Math.min(2,window.devicePixelRatio||1)),R=Math.floor(n.clientWidth*L),T=Math.floor(n.clientHeight*L);(n.width!==R||n.height!==T)&&(n.width=R,n.height=T,d.setTransform(L,0,0,L,0,0))},render(){this.resize();let L=Ct(),R=n.clientWidth,T=n.clientHeight;d.clearRect(0,0,R,T),d.fillStyle="#0b0f14",d.fillRect(0,0,R,T);let E=R*.5,B=s,Q=T-o,U=Math.max(1,Q-B),v=Math.min(R*g,l),I=v*.28,{killLevel:Ut,rotFloat:q,grid:ut,gameState:de}=L,lt=ot(B,U,Ut),at=.7,te=Ut/i,ee=28,ne=72,Xt=120;if(te>at){let m=(te-at)/(1-at);ee=Math.round(28+152*m),ne=Math.round(72+-32*m),Xt=Math.round(120+-70*m)}let St=E-v-8,Pt=E+v+8,Ee=B,O=Q+5,fe=`rgba(${ee},${ne},${Xt},0.45)`;d.fillStyle=fe;let Y=v+8,At=I+4;d.fillRect(0,lt,St,T-lt),d.fillRect(Pt,lt,R-Pt,T-lt),d.beginPath();let me=Math.max(lt,O);d.moveTo(St,me),lt<=O+At?d.ellipse(E,O,Y,At,0,Math.PI,0,!1):d.lineTo(Pt,me),d.lineTo(Pt,T),d.lineTo(St,T),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(St,Ee),d.lineTo(St,O),d.stroke(),d.beginPath(),d.moveTo(Pt,Ee),d.lineTo(Pt,O),d.stroke(),d.beginPath(),d.ellipse(E,O,v+8,I+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(E,O,v+8,I+4,0,0,Qt),d.fill(),Ut>.5&&(d.strokeStyle=`rgba(${Math.min(255,ee+60)},${Math.min(255,ne+40)},${Math.min(255,Xt+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,lt),d.lineTo(St,lt),d.moveTo(Pt,lt),d.lineTo(R,lt),d.stroke()),d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let bt=Qt*v,Et=10,qt=bt/Et*.7,Vt=bt/Et*.3;d.setLineDash([qt,Vt]);let Mt=bt/r;d.lineDashOffset=q*Mt;for(let m=0;m<=i;m++){let M=ot(B,U,m);d.beginPath(),d.ellipse(E,M,v,I,0,0,Qt),d.stroke()}d.setLineDash([]);let Yt=[],zt=[];for(let m=0;m<i;m++){let M=ot(B,U,m+.5);for(let _=0;_<r;_++){let G=ut[m][_];if(!G)continue;let w=N(E,M,v,I,_,q),dt=Math.sin(w.ang),Gt={y:m,s:_,yScr:M,p:w,depth:dt,color:G};dt<-.1?Yt.push(Gt):zt.push(Gt)}}let se=wt.getMagicTargetColor(),{isHighlighting:ge,highlightedCells:S,highlightStartTime:Dt,isMagicAnimation:rt}=L,pt=null,ie=1,Bt=1,ce=!1;if(ge&&S.length>0){pt=new Set(S.map(M=>`${M.y},${M.s}`));let m=(performance.now()-Dt)/1e3;if(rt){let M=Math.min(1,m/W);ie=1-M*.85,Bt=1-M*.9,ce=!0}else{let M=Math.min(1,m/f),_=1-y;if(M>_){let G=(M-_)/y;ie=1-G*.85,Bt=1-G*.9,ce=!0}}}Yt.sort((m,M)=>m.depth-M.depth);for(let m of Yt){let M=m.p,_=N(E,m.yScr,v,I,m.s+1,q),G=N(E,m.yScr,v,I,m.s-1,q),w=_.x-G.x,dt=_.y-G.y,xt=Math.hypot(_.x-M.x,_.y-M.y)*1.06,ft=U/i*.9,kt=C[m.color]||null,X=.35,x=1,A=`${m.y},${m.s}`;pt&&pt.has(A)&&(X*=Bt,x=ie),Tt(M.x,M.y,w,dt,xt*x,ft*x,$t,X,kt,.5)}let{isRingAnimation:Kt}=L;if(ge&&S.length>0&&!rt){let m=(performance.now()-Dt)/1e3,_=Math.min(1,m/(Kt?D:f)),G=1-y,w=_>G,dt=w?(_-G)/y:0,Gt=Kt?Math.floor(_*G*r*2)%r:-1,xt=4+_/G*10,ft=Math.sin(m*xt*Qt),kt=w?1:.3+ft*.3,X=w?1-dt*.8:1,x=w?1-dt:1;for(let A of S){let k=ot(B,U,A.y+.5),H=N(E,k,v,I,A.s,q);if(Math.sin(H.ang)>=-.1)continue;let tt=N(E,k,v,I,A.s+1,q),Lt=N(E,k,v,I,A.s-1,q),le=tt.x-Lt.x,re=tt.y-Lt.y,Zt=Math.hypot(tt.x-H.x,tt.y-H.y)*1.06,Rt=U/i*.9,ct,It,it;if(Kt){let mt=(A.s-Gt+r)%r,vt=mt<3?1-mt/3:0;ct=(w?x:.2+vt*.5)*.5,It=`rgba(255, 159, 67, ${ct})`,it=w?X:1+vt*.15}else ct=kt*x,It=A.isLine?`rgba(255, 255, 255, ${ct*.5})`:`rgba(255, 220, 100, ${ct*.4})`,it=w?X:1.1;Tt(H.x,H.y,le,re,Zt*it,Rt*it,It,1,null)}}zt.sort((m,M)=>m.depth-M.depth);for(let m of zt){let M=m.p,_=N(E,m.yScr,v,I,m.s+1,q),G=N(E,m.yScr,v,I,m.s-1,q),w=_.x-G.x,dt=_.y-G.y,xt=Math.hypot(_.x-M.x,_.y-M.y)*1.06,ft=U/i*.9,kt=C[m.color]||null,X=1,x=1,A=1,k=1,H=`${m.y},${m.s}`,J=pt&&pt.has(H);J&&(X=Bt,x=ie),se!==null&&!J&&(m.color!==se?(A=Nt,k=Wt):k=_t),Tt(M.x,M.y,w,dt,xt*x,ft*x,yt,X,kt,A,null,0,k)}if(ge&&S.length>0&&!rt){let m=(performance.now()-Dt)/1e3,_=Math.min(1,m/(Kt?D:f)),G=1-y,w=_>G,dt=w?(_-G)/y:0,Gt=Kt?Math.floor(_*G*r*2)%r:-1,xt=4+_/G*10,ft=Math.sin(m*xt*Qt),kt=w?1:.5+ft*.5,X=w?1-dt*.8:1,x=w?1-dt:1;for(let A of S){let k=ot(B,U,A.y+.5),H=N(E,k,v,I,A.s,q);if(Math.sin(H.ang)<-.1)continue;let tt=N(E,k,v,I,A.s+1,q),Lt=N(E,k,v,I,A.s-1,q),le=tt.x-Lt.x,re=tt.y-Lt.y,Zt=Math.hypot(tt.x-H.x,tt.y-H.y)*1.06,Rt=U/i*.9,ct,It,it;if(Kt){let mt=(A.s-Gt+r)%r,vt=mt<4?1-mt/4:0;ct=w?x:.3+vt*.7,It=`rgba(255, 159, 67, ${ct})`,it=w?X:1+vt*.2}else ct=kt*x,It=A.isLine?`rgba(255, 255, 255, ${ct*.7})`:`rgba(255, 220, 100, ${ct*.6})`,it=w?X:1.15;Tt(H.x,H.y,le,re,Zt*it,Rt*it,It,1,null)}}let{activePiece:ht,pieceY:P,isGrounded:Me,lockTimer:ae}=L;if(ht){let m=wt.snappedRot(),M=m,_=wt.computeGhostY(),G=ot(B,U,P+.5),w=N(E,G,v,I,m,M),dt=N(E,G,v,I,m+1,M),xt=Math.hypot(dt.x-w.x,dt.y-w.y)*1.06,ft=U/i*.9;if(_!==null){let X=[];for(let x=0;x<ht.cells.length;x++){let A=ht.cells[x],k=ht.colors[x],H=_+A.y,J=wt.normSector(m+A.x);if(H<0||H>=i)continue;let tt=ot(B,U,H+.5),Lt=N(E,tt,v,I,J,M);X.push({cy:H,cs:J,yScr:tt,p0:Lt,color:k})}X.sort((x,A)=>x.p0.y-A.p0.y);for(let x of X){let A=x.p0,k=N(E,x.yScr,v,I,x.cs+1,M),H=N(E,x.yScr,v,I,x.cs-1,M),J=k.x-H.x,tt=k.y-H.y,Lt=C[x.color]||null;Tt(A.x,A.y,J,tt,xt,ft,b,1,Lt,.5,Z,oe)}}let kt=$;if(Me&&ae>0){let X=Math.min(1,ae/j),x=255,A=Math.round(170+85*X),k=Math.round(180+75*X),H=.75+(1-.75)*X;kt=`rgba(${x},${A},${k},${H})`}for(let X=0;X<ht.cells.length;X++){let x=ht.cells[X],A=ht.colors[X],k=wt.normSector(m+x.x),H=P+x.y,J=ot(B,U,H+.5),tt=N(E,J,v,I,k,M);d.fillStyle=kt,d.fillRect(tt.x-xt/2,tt.y-ft/2,xt,ft);let Lt=C[A];if(Lt){let le=Math.min(xt,ft)*.28;d.fillStyle=Lt,d.beginPath(),d.arc(tt.x,tt.y,le,0,Qt),d.fill()}}}},drawNextPreview(L,R){if(!L)return;let T=L.getContext("2d"),E=L.width,B=L.height;if(T.clearRect(0,0,E,B),!R)return;let Q=1/0,U=-1/0,v=1/0,I=-1/0;for(let at of R.cells)Q=Math.min(Q,at.x),U=Math.max(U,at.x),v=Math.min(v,at.y),I=Math.max(I,at.y);let Ut=U-Q+1,q=I-v+1,ut=Math.min(E/(Ut+.5),B/(q+.5)),de=(E-Ut*ut)/2,lt=(B-q*ut)/2;T.fillStyle=yt;for(let at=0;at<R.cells.length;at++){let te=R.cells[at],ee=de+(te.x-Q)*ut,ne=lt+(q-1-(te.y-v))*ut;T.fillRect(ee+1,ne+1,ut-2,ut-2);let Xt=R.colors[at],St=C[Xt];if(St){let Pt=(ut-2)*.32;T.fillStyle=St,T.beginPath(),T.arc(ee+ut/2,ne+ut/2,Pt,0,Qt),T.fill(),T.fillStyle=yt}}}}}(()=>{let e=hn(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let r=Math.PI*2,i=30,s=24,o=Math.PI/2,l=18,g=90,p=260,f=.36,y="rgb(235,240,250)",W="rgb(55,62,75)",D="rgba(255,170,180,0.75)",j="rgba(110,255,150,0.15)",C="rgba(110,255,150,0.85)",V=2,yt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},$t={1:"fire",2:"water",3:"lightning",4:"earth"},$={fire:1,water:2,lightning:3,earth:4},b=1,Z=.58,oe=!0,Nt=12,Wt=25,_t=120,Ct=s/_t,wt=1,d=2,ot=3,N=5,Tt=8,L=10,R=15,T=30,E=2,B=.3,Q=.5,U=1,v=.3,I=.5,Ut=1.3,q=10,ut=500,de=[1,1.25,1.5,1.75,2],lt=10,at=100,te=25,ee=[1,1.3,1.6,2],ne=[1,1.5,2,2.5],Xt=pn(),St=Xt.loadGameSettings(),Pt=St.invertSwipe?-1:1,Ee=-1,O=Array.from({length:s},()=>new Uint8Array(i)),fe=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],Y=null,At=s+3,me=0,bt=0,Et=!1,qt=0,Vt=0,Mt=0,Yt=0,zt=0,se=Mn({canvas:n,rotDir:Pt}),ge="0.12.0",S=fn();S.preload();let Dt=xn(),rt="intro",pt=0,ie=0,Bt=0,ce=0,Kt=0,ht=null,P=Dt.stats,Me=e.overlay,ae=Sn({elementColors:yt}),m=ae.showBonus.bind(ae),M=ae.getElementIcon.bind(ae),_=e.overlayTitle,G=e.overlayStats,w=e.startBtn,dt=e.hud,Gt=e.scoreHud,xt=e.timeHud,ft=e.nextCanvas,kt=ft.getContext("2d"),X=e.settingsBtn,x=e.settingsOverlay,A=e.settingsClose,k=e.fullscreenBtn,H=e.rotateBtn,J=En({buttons:e.magicBtns,onActivate:()=>S.play("spells")}),tt=e.magicBtns,Lt=J.charges,le=t=>J.select(t),re=()=>J.updateButtons(),Ht=[],Zt=0,Rt=!1,ct=!1,It=!1,it=0,mt=0,vt=0,xe=[];function Dn(t,a,u){let h=1-u/s;return t+h*a}function Pn(t,a,u,h,K,et){let gt=(K-et)/i*r+o;return{x:t+Math.cos(gt)*u,y:a+Math.sin(gt)*h,ang:gt}}function Bn(t,a){if(!J.canUse()||Rt)return!1;let u=$[J.active],h=n.clientWidth,K=n.clientHeight,et=h*.5,gt=l,Jt=K-g,jt=Math.max(1,Jt-gt),Ie=Math.min(h*f,p),Se=Ie*.28,nt=null,st=1/0;for(let F=0;F<s;F++){let Ot=Dn(gt,jt,F+.5);for(let Ft=0;Ft<i;Ft++){let ue=O[F][Ft];if(!ue||ue!==u)continue;let he=Pn(et,Ot,Ie,Se,Ft,Mt);if(Math.sin(he.ang)<-.1)continue;let cn=t-he.x,an=a-he.y,ln=Math.hypot(cn,an),rn=jt/s*.9,as=rn*1.2;Math.abs(cn)<as/2&&Math.abs(an)<rn/2&&ln<st&&(st=ln,nt={y:F,s:Ft})}}if(nt){let F=O[nt.y][nt.s];return Ht=[{y:nt.y,s:nt.s,color:F,isLine:!1,isMagic:!0}],Zt=performance.now(),Rt=!0,ct=!0,it=0,mt=te,m(`+${te}`,"score"),vt=0,J.useCharge(),P.magicUsed++,!0}return!1}let ys=100;function Ss(t,a){return Xe(t,a,s,i)}function Gn(){return Tn(O,s,i)}let kn=An;function Hn(t){let a=t.map(h=>({...h,color:O[h.y][h.s]}));for(let h of t)O[h.y][h.s]=0;let u=s;for(let h of t){let K=h.y;for(let et=1;et<=h.y;et++){let gt=h.y-et;if(O[gt][h.s]){K=et-1;break}}u=Math.min(u,K)}for(let h of a)O[h.y-u][h.s]=h.color;return u>0}function Fn(){let t=!0;for(;t;){t=!1;let a=Gn();for(let u of a)kn(u)||Hn(u)&&(t=!0)}}function $n(){we()}let Oe=vn;function Ye(t,a){let u=new Map,h=0,K=0,et=0,gt={},Jt=t.length+a.length;for(let st of t){let F=$t[st.color],Ot=0,Ft=0;st.length>=5?(Ot=ot,Ft=L,P.lines5++):st.length===4?(Ot=d,Ft=Tt,P.lines4++):st.length===3&&(Ot=wt,Ft=N,P.lines3++),F&&Ot>0&&(J.addCharges(F,Ot),gt[F]=(gt[F]||0)+Ot),h+=Ft*Ct,et+=Ft,K+=st.length*lt;for(let ue of st.cells){let he=`${ue.y},${ue.s}`;u.has(he)||u.set(he,{y:ue.y,s:ue.s,color:st.color,isLine:!0})}}for(let st of a){P.pairs++,h+=R*Ct,et+=R,K+=at;for(let F of st.cells){let Ot=`${F.y},${F.s}`;u.has(Ot)||u.set(Ot,{y:F.y,s:F.s,color:O[F.y][F.s],isLine:!1})}}let jt=Oe(ee,Jt-1),Ie=Oe(ne,vt),Se=Math.round(K*jt*Ie),nt=0;Jt>1&&(P.combos++,P.maxCombo=Math.max(P.maxCombo,Jt),setTimeout(()=>m(`COMBO \xD7${Jt}`,"combo"),nt),nt+=180),vt>0&&(P.cascades++,P.maxCascade=Math.max(P.maxCascade,vt),setTimeout(()=>m(`CASCADE \xD7${vt}`,"cascade"),nt),nt+=180,S.play("cascade")),(t.length>0||a.length>0)&&S.play("combo");for(let st of t){let F=st.length,Ot=F*lt;setTimeout(()=>m(`Line-${F} +${Ot}`,"line",st.color),nt),nt+=100}for(let st of a){let F=st.cells.length>0?O[st.cells[0].y][st.cells[0].s]:null;setTimeout(()=>m(`Pair +${at}`,"pair",F),nt),nt+=100}Se>0&&(setTimeout(()=>m(`+${Se}`,"score"),nt),nt+=120),et>0&&(setTimeout(()=>m(`+${et}s`,"time"),nt),nt+=120);for(let[st,F]of Object.entries(gt))F>0&&(setTimeout(()=>m(`+${F}${M(st)}`,"charge"),nt),nt+=120);Ht=Array.from(u.values()),Zt=performance.now(),Rt=!0,ct=!1,it=h,mt=Se,re()}function Nn(){for(let t of Ht)O[t.y][t.s]=0;Ht.length>0&&S.playRandom("disappear"),it>0&&(Vt=Math.max(0,Vt-it)),Dt.addScore(mt),pt+=mt,Te(),Ht=[],Rt=!1,ct=!1,it=0,mt=0,vt++,we()}function we(){Fn();let{lineMatches:t,pairMatches:a}=Jn();if(t.length>0||a.length>0)Ye(t,a);else{let u=Ze();u.length>0?qn(u):!Y&&rt==="playing"&&ze()}}function Es(t,a){Ye(t,a)}function De(t){return ye(t,i)}function ve(){return De(Math.round(Mt))}function Ke(t,a){return Ve(Y,t,a,O,s,i)}function _e(t){return Ke(t,ve())}let Ce=Cn;function We(){oe&&(Nt!==0&&qt>=Nt||(bt=0,qt+=1))}function Un(){if(!Y)return;let t=Y.cells,a=Y.colors,u={cells:t,colors:a};if(Ee>=0||(u=Ce(u.cells,u.colors),u=Ce(u.cells,u.colors)),u=Ce(u.cells,u.colors),Y.cells=u.cells,Y.colors=u.colors,!_e(Math.floor(At))){Y.cells=t,Y.colors=a;return}S.play("turn"),Et&&We()}function Xn(){return bn(Y,At,ve(),O,s,i)}function Vn(){if(!Y)return!1;let t=Math.floor(At)-1,a=!_e(t);return a&&!Et?(Et=!0,bt=0,qt=0):!a&&Et&&(Et=!1,bt=0,qt=0),a}let Pe=_n;function Be(){if(rt==="playing"){Me.classList.add("hidden");return}if(Me.classList.remove("hidden"),rt==="intro"){_.innerHTML='<span class="title-elemental">Elemental</span> <span class="title-blocks">Blocks</span>';let t=Math.floor(_t/60),a=_t%60,u=Xt.loadHighscore(),h=u.score>0?`<div class="intro-highscore">\u{1F3C6} Best: ${u.score.toLocaleString()} <small>(${Pe(u.time)})</small></div>`:"";G.innerHTML=`
        ${h}
        <div class="intro-survival">\u23F1 Survive: ${t}:${a.toString().padStart(2,"0")}</div>
        <div class="intro-box">
          <div class="intro-box-title">Combos</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+30 <small>+1\u2726</small></span>
              <span class="rule-time">+${N}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">+40 <small>+2\u2726</small></span>
              <span class="rule-time">+${Tt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">+50 <small>+3\u2726</small></span>
              <span class="rule-time">+${L}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+100</span>
              <span class="rule-time">+${R}s</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">+500</span>
              <span class="rule-time">+${T}s</span>
            </div>
          </div>
        </div>
        <div class="intro-version">v${ge}</div>
      `,w.textContent="Start"}else{_.textContent="Game Over";let t=`
        <div class="go-score">${pt.toLocaleString()}</div>
        <div class="go-time">\u23F1 ${Pe(Bt)}</div>
        <div class="intro-box" style="margin-top:12px">
          <div class="intro-box-title">Matches</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Line-3</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.lines3}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">Line-4</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.lines4}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">Line-5</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.lines5}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Pair</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.pairs}</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">Ring</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.rings}</span>
            </div>
          </div>
        </div>
        <div class="intro-box" style="margin-top:8px">
          <div class="intro-box-title">Bonuses</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots" style="color:#ffd84d;font-size:14px;font-weight:700">COMBO</span>
              <span class="rule-text">\xD7${P.combos}</span>
              <span class="rule-time" style="color:#ffd84d">${P.maxCombo>0?"max \xD7"+P.maxCombo:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#ff6b9d;font-size:14px;font-weight:700">CASCADE</span>
              <span class="rule-text">\xD7${P.cascades}</span>
              <span class="rule-time" style="color:#ff6b9d">${P.maxCascade>0?"max \xD7"+P.maxCascade:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#cfe0f3;font-size:14px">\u2726</span>
              <span class="rule-text">Magic</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${P.magicUsed}</span>
            </div>
          </div>
        </div>
        <div class="go-version">v${ge}</div>
      `;G.innerHTML=t,w.textContent="Play again"}}function Te(){Gt.textContent=`Score: ${pt}`}function Ge(){xt.textContent=`Time: ${Pe(Bt)}`}function Yn(){for(let t=0;t<s;t++)O[t].fill(0);Vt=0,Mt=Yt=0,zt=0,Dt.start(),pt=0,ie=performance.now(),Bt=0,Kt=0,ce=0,rt="playing",ht=null,J.reset(),Ht=[],xe=[],Rt=!1,ct=!1,It=!1,it=0,mt=0,vt=0,re(),Te(),Ge(),ze(),$e.drawNextPreview(ft,ht),Be(),S.getSettings().musicEnabled&&S.startGameMusic()}function ke(){Dt.gameOver(),rt="gameover",Y=null,Et=!1,bt=0,qt=0;let t=Xt.saveHighscore(pt,Bt);S.stopMusic(),S.play("gameover"),setTimeout(()=>{(rt==="gameover"||rt==="intro")&&S.startMenuMusic()},2500),Ge(),Be(),t&&pt>0&&setTimeout(()=>{m("\u{1F3C6} NEW RECORD!","score")},500)}function Kn(t){for(let u=0;u<50;u++){let h=t.map(()=>1+(Math.random()*4|0));if(!Wn(t,h))return h}return t.map((u,h)=>1+h%4)}let Wn=In;function qe(t){let a=t.cells.map(h=>({x:h.x,y:h.y})),u=Kn(a);return{name:t.name,cells:a,colors:u}}function ze(){if(!ht){let K=fe[Math.random()*fe.length|0];ht=qe(K)}Y=ht;let t=fe[Math.random()*fe.length|0];ht=qe(t),$e.drawNextPreview(ft,ht);let a=1/0,u=-1/0;for(let K of Y.cells)K.x<a&&(a=K.x),K.x>u&&(u=K.x);let h=(a+u)/2;for(let K of Y.cells)K.x=K.x-Math.round(h);At=s+3,me=0,Et=!1,bt=0,qt=0,_e(Math.floor(At))?S.playRandom("appear"):ke()}function Ze(){return Rn(O,s,i)}function qn(t){if(t.length===0)return;let a=[];for(let Jt of t)for(let jt=0;jt<i;jt++)a.push({y:Jt,s:jt,color:O[Jt][jt],isLine:!1});xe=t,Ht=a,Zt=performance.now(),Rt=!0,It=!0,ct=!1;let u=t.length;P.rings+=u;let h=Oe(de,u-1),K=Math.round(ut*u*h),et=T*u;mt=K,it=et*Ct,S.play("ring");let gt=`RING \xD7${u}`;m(gt,"ring"),setTimeout(()=>m(`+${K}`,"score"),150),setTimeout(()=>m(`+${et}s`,"time"),300)}function zn(){let t=[...xe].sort((a,u)=>u-a);for(let a of t){for(let u=a;u<s-1;u++)O[u].set(O[u+1]);O[s-1].fill(0)}it>0&&(Vt=Math.max(0,Vt-it)),Dt.addScore(mt),pt+=mt,Te(),Ht=[],xe=[],Rt=!1,It=!1,it=0,mt=0,we()}function Ms(){return Ze().length}function Zn(){if(!Y)return;let t=ve();Mt=t,Yt=t,zt=0;let a=!1;for(let u=0;u<Y.cells.length;u++){let h=Y.cells[u],K=Y.colors[u],et=Math.floor(At)+h.y,gt=De(t+h.x);et>=s&&(a=!0),et>=0&&et<s&&(O[et][gt]=K)}if(a){ke();return}Dt.addScore(q),pt+=q,Te(),m(`+${q}`,"score"),S.playRandom("drop"),Y=null,vt=0,$n()}function Jn(){return Ln(O,s,i)}function jn(){if(!Y)return!1;let t=Math.floor(At)-1;return _e(t)?(At=t,Et=!1,bt=0,qt=0,!0):(Et=!0,!1)}n.addEventListener("pointerdown",t=>{if(z.state!=="playing")return;t.preventDefault?.(),se.handlePointerDown(t,{onMagicTap:(u,h)=>z.applyCommand("magic_shoot",{x:u,y:h}),onDoubleTap:()=>z.applyCommand("rotate_piece")},Yt)||(zt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(z.state!=="playing"||!se.dragging)return;t.preventDefault?.();let a=se.handlePointerMove(t,{canRotateTo:(u,h)=>z.canRotateTo(u,h),onDrop:()=>z.applyCommand("move_down"),onGroundedMove:()=>z.onGroundedMove()},z.pieceY,z.isGrounded);a&&z.setRotation(a.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{z.state==="playing"&&se.handlePointerUp(t)},{passive:!1}),H.addEventListener("click",()=>{z.state==="playing"&&z.applyCommand("rotate_piece")});let Ae=e.dropBtn,be=null;function Qn(){z.state==="playing"&&(z.applyCommand("move_down"),be=setInterval(()=>{if(z.state!=="playing"){Le();return}z.applyCommand("move_down")},Wt))}function Le(){be&&(clearInterval(be),be=null)}Ae.addEventListener("pointerdown",t=>{t.preventDefault(),Qn()}),Ae.addEventListener("pointerup",Le),Ae.addEventListener("pointerleave",Le),Ae.addEventListener("pointercancel",Le);for(let[t,a]of Object.entries(tt))a.addEventListener("click",()=>{z.state==="playing"&&z.applyCommand("select_magic",{element:t})});let He=e.soundsToggle,Fe=e.musicToggle;function pe(){let t=S.getSettings();t.soundsEnabled?He.classList.add("active"):He.classList.remove("active"),t.musicEnabled?Fe.classList.add("active"):Fe.classList.remove("active");for(let a=0;a<=4;a++){let u=e.soundVolBtns[a],h=e.musicVolBtns[a];u&&u.classList.toggle("active",t.soundVolume===a),h&&h.classList.toggle("active",t.musicVolume===a)}}let Je=e.tabBtns,ts=e.tabContents;Je.forEach(t=>{t.addEventListener("click",()=>{let a=t.dataset.tab;Je.forEach(u=>u.classList.remove("active")),ts.forEach(u=>u.classList.remove("active")),t.classList.add("active"),yn(a).classList.add("active"),a==="sounds"&&pe()})});let je=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Qe=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,es=e.iosHint,ns=e.standaloneBadge;function tn(){let t=document.fullscreenElement||document.webkitFullscreenElement;k.textContent=t?"Disable":"Enable"}je&&(Qe?(ns.style.display="block",k.style.display="none"):(es.style.display="block",k.textContent="Not supported",k.style.opacity="0.5",k.style.cursor="default")),k.addEventListener("click",()=>{if(je&&!Qe)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let a=document.documentElement;a.requestFullscreen?a.requestFullscreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",tn),document.addEventListener("webkitfullscreenchange",tn);let Re=e.invertSwipeToggle;St.invertSwipe&&Re.classList.add("active"),Re.addEventListener("click",()=>{Re.classList.toggle("active");let t=Re.classList.contains("active");se.rotDir=t?-1:1,St.invertSwipe=t,Xt.saveGameSettings(St)});let en=e.diffBtns;en.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(en.forEach(a=>{a.classList.remove("active");let u=a.querySelector(".check-icon");u&&u.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let a=document.createElement("span");a.className="check-icon",a.textContent="\u2713",t.appendChild(a)}})}),He.addEventListener("click",()=>{let a=!S.getSettings().soundsEnabled;S.updateSettings({soundsEnabled:a}),pe()}),Fe.addEventListener("click",()=>{let a=!S.getSettings().musicEnabled;S.updateSettings({musicEnabled:a}),pe(),a?z.state==="playing"?S.startGameMusic():S.startMenuMusic():a||S.stopMusic()});for(let t=0;t<=4;t++){let a=e.soundVolBtns[t];a&&a.addEventListener("click",()=>{S.updateSettings({soundVolume:t}),pe(),S.play("turn")})}for(let t=0;t<=4;t++){let a=e.musicVolBtns[t];a&&a.addEventListener("click",()=>{S.updateSettings({musicVolume:t}),pe()})}pe();function ss(){rt==="playing"&&(Dt.pause(),ce=performance.now(),rt="paused",S.musicAudio&&S.musicAudio.pause())}function nn(){rt==="paused"&&(Dt.resume(),Kt+=performance.now()-ce,ce=0,rt="playing",Ne=performance.now(),S.getSettings().musicEnabled&&S.startGameMusic())}X.addEventListener("click",()=>{ss(),x.classList.remove("hidden")}),A.addEventListener("click",()=>{x.classList.add("hidden"),nn()}),x.addEventListener("click",t=>{t.target===x&&(x.classList.add("hidden"),nn())});let z=On({N:i,H:s,FALL_INTERVAL:b,LOCK_DELAY_SEC:Z,KILL_RATE:Ct,MATCH_HIGHLIGHT_SEC:E,MAGIC_SHRINK_SEC:Q,RING_HIGHLIGHT_SEC:U,getState:()=>({gameState:rt,score:pt,elapsedMs:Bt,startTime:ie,totalPausedMs:Kt,stats:P,activePiece:Y,pieceY:At,targetRot:Yt,rotFloat:Mt,rotVel:zt,isGrounded:Et,isHighlighting:Rt,isMagicAnimation:ct,isRingAnimation:It,highlightStartTime:Zt,killLevel:Vt,grid:O,fallTimer:me,lockTimer:bt}),setState:t=>{"elapsedMs"in t&&(Bt=t.elapsedMs),"killLevel"in t&&(Vt=t.killLevel),"fallTimer"in t&&(me=t.fallTimer),"lockTimer"in t&&(bt=t.lockTimer),"targetRot"in t&&(Yt=t.targetRot),"rotFloat"in t&&(Mt=t.rotFloat),"rotVel"in t&&(zt=t.rotVel)},funcs:{startGame:Yn,endGame:ke,rotatePieceByDir:Un,tryMoveDown:jn,canPlaceAtRot:Ke,maybeResetLockDelay:We,shootMagic:Bn,selectMagic:le,updateGroundedState:Vn,lockPiece:Zn,finishHighlight:Nn,finishRingHighlight:zn},ui:{updateTimeHud:Ge}}),$e=wn({canvas:n,canvasCtx:c,N:i,H:s,TOP_PAD_PX:l,BOTTOM_PAD_PX:g,MAX_RADIUS_X:p,RADIUS_X_FACTOR:f,ANG_OFFSET:o,MATCH_HIGHLIGHT_SEC:E,MATCH_SHRINK_PHASE:B,MAGIC_SHRINK_SEC:Q,RING_HIGHLIGHT_SEC:U,LOCK_DELAY_SEC:Z,ELEMENT_COLORS:yt,ELEMENT_TO_COLOR:$,BLOCK_COLOR_FRONT:y,BLOCK_COLOR_BACK:W,ACTIVE_COLOR_FRONT:D,GHOST_COLOR_FILL:j,GHOST_COLOR_STROKE:C,GHOST_STROKE_WIDTH:V,MAGIC_DIM_DOT_ALPHA:v,MAGIC_DIM_DOT_SCALE:I,MAGIC_TARGET_DOT_SCALE:Ut,LOCK_DELAY_SEC:Z,getState:()=>({gameState:rt,grid:O,activePiece:Y,pieceY:At,rotFloat:Mt,killLevel:Vt,isHighlighting:Rt,highlightedCells:Ht,highlightStartTime:Zt,isMagicAnimation:ct,isRingAnimation:It,isGrounded:Et,lockTimer:bt}),funcs:{snappedRot:ve,computeGhostY:Xn,normSector:De,getMagicTargetColor:()=>J.canUse()?$[J.active]:null}}),Ne=performance.now();function sn(t){let a=Math.min(.05,Math.max(.001,(t-Ne)/1e3));Ne=t,z.update(a,t),Mt=Yt,Mt>1e6&&(Mt%=i),Mt<-1e6&&(Mt%=i),$e.render(),requestAnimationFrame(sn)}w.addEventListener("click",()=>{z.applyCommand("start_game")}),re(),Be(),S.startMenuMusic();let os=()=>{if(S.unlock(),!S.getSettings().musicEnabled)return;let t=S.musicAudio;!t||t.paused||t.ended?z.state==="playing"?S.startGameMusic():S.startMenuMusic():t.play().catch(a=>{console.debug("Music resume on interaction failed:",a)})},on=0,is=10,cs=()=>{on>=is||(on++,os())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,cs,{passive:!0})}),requestAnimationFrame(sn)})();})();
