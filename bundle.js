(()=>{var ai=[0,.25,.5,.75,1],ri=[0,.05,.15,.25,.5],li={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",wsseffect:"sounds/spell/wsseffect.wav"},Fs={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Us="soundSettings";function ui(){try{let e=localStorage.getItem(Us);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function di(e){try{localStorage.setItem(Us,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Xs(){return{audioContext:null,buffers:{},settings:ui(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=n,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ai[this.settings.soundVolume]},getMusicVolume(){return ri[this.settings.musicVolume]},async loadSound(n,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(l)).arrayBuffer(),o=await this.audioContext.decodeAudioData(c);this.buffers[n]=o}catch(u){console.debug(`Failed to load sound: ${n} from ${l}`,u)}},preload(){this.initContext();for(let[n,l]of Object.entries(li))this.loadSound(n,l)},play(n,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;l!==null&&(u=`${n}${l}`);let c=this.buffers[u];if(c)try{let o=this.audioContext.createGain();o.gain.value=this.getSoundVolume(),o.connect(this.audioContext.destination);let a=this.audioContext.createBufferSource();a.buffer=c,a.connect(o),a.start(0),a.onended=()=>{a.disconnect(),o.disconnect()}}catch(o){console.debug("Sound play failed:",o)}},playRandom(n){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(n,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Fs.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Fs.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},di(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var Ys="eb_highscore",Vs="eb_highscore_quick",Ws="eb_settings",Ks="eb_high_tower_rings",mi={invertSwipe:!1,difficulty:"easy"};function qs(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Vs:Ys,l=localStorage.getItem(n);if(l)return JSON.parse(l)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,l="30_24"){try{let u=this.loadHighscore(l);if(e>u.score||e===u.score&&n>u.time){let c=l==="25_20"?Vs:Ys;return localStorage.setItem(c,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Ws);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...mi}},saveGameSettings(e){try{localStorage.setItem(Ws,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Ks);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Ks,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let l=this.loadHighTowerRings()+e;return this.saveHighTowerRings(l),l}}}function zs(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Qs(e){return document.getElementById("tab-"+e)}var gi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Zs(e={}){let{elementColors:n={}}=e,l=0;return{showBonus(u,c="score",o=null){let a=document.createElement("div");a.className=`bonus-popup ${c}`,a.textContent=u,o&&n[o]&&(a.style.color=n[o]);let r=window.innerWidth/2,m=window.innerHeight/2-40,p=(Math.random()-.5)*200,g=(Math.random()-.5)*100+l*36;a.style.left=`${r+p}px`,a.style.top=`${m+g}px`,a.style.transform="translate(-50%, -50%)",document.body.appendChild(a),l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{a.remove()},1800)},getElementIcon(u){return gi[u]||"\u2726"}}}var js={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Js(){return{spawnMagicOrb(e,n,l,u){if(!u)return;let c=document.createElement("div");c.className=`magic-orb ${e}`,c.textContent=js[e]||"\u2726";let o=u.getBoundingClientRect(),a=o.left+o.width/2-n,r=o.top+o.height/2-l,m=Math.hypot(a,r),p=Math.atan2(r,a),g=m*.35*(Math.random()>.5?1:-1),h=p+Math.PI/2,T=a*.5+Math.cos(h)*g,$=r*.5+Math.sin(h)*g;c.style.setProperty("--mid-x",`${T}px`),c.style.setProperty("--mid-y",`${$}px`),c.style.setProperty("--end-x",`${a}px`),c.style.setProperty("--end-y",`${r}px`),c.style.left=`${n}px`,c.style.top=`${l}px`,document.body.appendChild(c),setTimeout(()=>{c.remove()},700)},spawnMagicShot(e,n,l,u,c){if(!n){c&&c();return}let o=n.getBoundingClientRect(),a=o.left+o.width/2,r=o.top+o.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=js[e]||"\u2726";let p=l-a,g=u-r;m.style.setProperty("--end-x",`${p}px`),m.style.setProperty("--end-y",`${g}px`),m.style.left=`${a}px`,m.style.top=`${r}px`,document.body.appendChild(m);let h=setInterval(()=>{let T=m.getBoundingClientRect();this.spawnTrailParticle(e,T.left+T.width/2,T.top+T.height/2)},40);setTimeout(()=>{clearInterval(h),m.remove(),this.spawnExplosion(e,l,u),c&&c()},300)},spawnTrailParticle(e,n,l){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${l}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,l){for(let c=0;c<12;c++){let o=document.createElement("div");o.className=`magic-explosion ${e}`;let a=c/12*Math.PI*2+(Math.random()-.5)*.5,r=40+Math.random()*40,m=Math.cos(a)*r,p=Math.sin(a)*r;o.style.setProperty("--px",`${m}px`),o.style.setProperty("--py",`${p}px`),o.style.left=`${n}px`,o.style.top=`${l}px`,document.body.appendChild(o),setTimeout(()=>o.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let l=e.getBoundingClientRect(),u=l.left+l.width/2,c=l.top+l.height/2,o=Math.max(8,Math.round(n));for(let a=0;a<o;a++){let r=document.createElement("div");r.className="spell-bubble",r.textContent="\u25CF";let m=a/o*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,g=Math.cos(m)*p,h=Math.sin(m)*p-20;r.style.setProperty("--px",`${g}px`),r.style.setProperty("--py",`${h}px`),r.style.left=`${u}px`,r.style.top=`${c}px`,r.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(r),setTimeout(()=>r.remove(),800)}},spawnSpellOrb(e,n,l){if(!l)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let c=l.getBoundingClientRect(),o=c.left+c.width/2-e,a=c.top+c.height/2-n,r=Math.hypot(o,a),m=Math.atan2(a,o),p=r*.35*(Math.random()>.5?1:-1),g=m+Math.PI/2,h=o*.5+Math.cos(g)*p,T=a*.5+Math.sin(g)*p;u.style.setProperty("--mid-x",`${h}px`),u.style.setProperty("--mid-y",`${T}px`),u.style.setProperty("--end-x",`${o}px`),u.style.setProperty("--end-y",`${a}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}function to(e={}){let{buttons:n={},onActivate:l=null}=e,u={fire:3,water:3,lightning:3,earth:3},c=null;function o(){for(let[r,m]of Object.entries(n)){if(!m)continue;let p=u[r],g=m.querySelector(".charges");g&&(g.textContent=p),m.classList.toggle("empty",p<=0),m.classList.toggle("active",c===r&&p>0)}}function a(r){let m=n[r];m&&(m.classList.remove("pulse"),m.offsetWidth,m.classList.add("pulse"),setTimeout(()=>m.classList.remove("pulse"),400))}return{get charges(){return u},get active(){return c},set active(r){c=r},select(r){if(u[r]<=0)return!1;let m=c===r;return c=m?null:r,o(),!m&&c===r&&l&&l(),!m},useCharge(){if(!c||u[c]<=0)return!1;let r=c;return u[r]--,c=null,o(),a(r),!0},addCharges(r,m){u[r]!==void 0&&(u[r]+=m,o(),a(r))},canUse(){return c!==null&&u[c]>0},deactivate(){c=null,o()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,c=null,o()},updateButtons:o,initButtons(r){for(let[m,p]of Object.entries(n))p&&p.addEventListener("click",()=>{r&&r(m)})}}}var ls={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:10,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:15,effect:{type:"chain_lightning"}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:1,effect:{type:"transmutation"}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:15,effect:{type:"horizontal_beam"}}};function eo(e={}){let{button:n=null,onActivate:l=null,onProgress:u=null,onReady:c=null}=e,o="ice",a=0;function r(){return ls[o]||ls.ice}function m(){if(!n)return;let g=r(),h=Math.min(a/g.maxProgress,1)*100,T=a>=g.maxProgress;n.style.setProperty("--progress",`${h}%`);let $=n.querySelector(".spell-icon");$&&($.textContent=g.icon);let V=n.querySelector(".spell-counter");V&&(V.textContent=`${Math.min(a,g.maxProgress)}/${g.maxProgress}`),n.classList.toggle("ready",T),n.classList.toggle("charging",!T&&a>0),u&&u(a,g.maxProgress)}function p(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return o},get progress(){return a},get maxProgress(){return r().maxProgress},get isReady(){return a>=r().maxProgress},get effect(){return r().effect},get button(){return n},selectSpell(g){ls[g]&&(o=g,a=0,m())},addProgress(g=1){let h=r();if(a>=h.maxProgress)return!1;let T=a<h.maxProgress;return a=Math.min(a+g,h.maxProgress),m(),p(),T&&a>=h.maxProgress&&c&&c(),!0},canUse(){return a>=r().maxProgress},use(){if(!this.canUse())return null;let g=r().effect;return a=0,m(),p(),l&&l(o),g},reset(){a=0,m()},updateButton:m,initButton(g){n&&n.addEventListener("click",()=>{g&&g()})}}}var fi={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function no(e={}){let{canvas:n}=e,l=e.rotDir||1,u=!1,c=0,o=0,a=0,r=0,m=0,p=1,g=null,h=0,T=0,$=0,V=0,Q=0,it=0,Et=0,le=0,nt=fi;return{get rotDir(){return l},set rotDir(N){l=N},get dragging(){return u},get dragMode(){return g},handlePointerDown(N,mt,Ee){if(mt.onMagicTap&&mt.onMagicTap(N.clientX,N.clientY))return!0;let ee=performance.now(),Kt=ee-it,qt=N.clientX-Et,zt=N.clientY-le,Se=Math.hypot(qt,zt);return Kt<=nt.DOUBLE_TAP_MS&&Se<=nt.DOUBLE_TAP_MAX_DIST?(mt.onDoubleTap&&mt.onDoubleTap(),it=0):(it=ee,Et=N.clientX,le=N.clientY),u=!0,p=-1,c=N.clientX,o=N.clientY,a=Ee,r=0,m=0,g=null,h=ee,T=N.clientX,$=N.clientY,V=h,Q=0,n&&n.setPointerCapture(N.pointerId),!1},handlePointerMove(N,mt,Ee,ee){if(!u)return null;let Kt=N.clientX-c,qt=N.clientY-o,zt=performance.now();if(Math.abs(Kt)<nt.DEADZONE_PX&&Math.abs(qt)<nt.DEADZONE_PX)return null;if(!g){let Dt=Math.abs(Kt),It=Math.abs(qt);if(qt<0)Dt>=nt.DEADZONE_PX&&(g="rotate");else if(It>=Dt*nt.AXIS_DOMINANCE){if(It>=nt.DROP_SWIPE_MIN_DISTANCE){let _t=Math.max(1,zt-h);It/_t*1e3>=nt.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else Dt>=It*nt.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let Se=null;if(g==="rotate"&&Math.abs(Kt)>=nt.DEADZONE_PX){let Dt=Math.max(1,zt-V),It=N.clientX-T,_t=Math.max(1,Math.abs(It)/Dt*1e3),d=Math.max(nt.MIN_ROT_PX,Math.min(nt.MAX_ROT_PX,nt.PX_PER_STEP*(nt.SWIPE_SPEED_REF/_t)));Q+=-It/d*l*p;let Z=Math.trunc(Q);Z!==0&&(Q-=Z);let st=r+Z;if(st!==r&&mt.canRotateTo){let ue=Math.sign(st-r),Pt=a+r;for(;r!==st;){let _e=r+ue,Oe=a+_e;if(!mt.canRotateTo(Math.floor(Ee),Oe))break;r=_e,Pt=Oe,ee&&mt.onGroundedMove&&mt.onGroundedMove()}Se={targetRot:Pt,rotFloat:Pt}}}if(g==="drop"&&qt>nt.DEADZONE_PX&&mt.onDrop){let Dt=Math.max(1,zt-V),It=N.clientY-$,_t=Math.max(1,It/Dt*1e3),d=Math.max(nt.MIN_DROP_PX,Math.min(nt.MAX_DROP_PX,nt.PX_PER_DROP*(nt.SWIPE_SPEED_REF/_t))),Z=Math.trunc(qt/d);if(Z>m){let st=Z-m;for(let ue=0;ue<st;ue++)mt.onDrop();m=Z}}return T=N.clientX,$=N.clientY,V=zt,Se},handlePointerUp(N){if(u&&(u=!1,g=null,n&&N&&N.pointerId!==void 0))try{n.releasePointerCapture(N.pointerId)}catch{}},reset(){u=!1,g=null,r=0,m=0,Q=0}}}var us={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function so(){let e="intro",n=0,l=0,u=0,c=0,o=0,a={...us};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return l},get stats(){return a},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,l=performance.now(),u=0,c=0,o=0,a={...us}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(o+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){n+=r},setScore(r){n=r},updateTime(){e==="playing"&&l>0&&(u=performance.now()-l-o)},getFormattedTime(){let r=Math.floor(u/1e3),m=Math.floor(r/60),p=r%60;return`${m}:${p.toString().padStart(2,"0")}`},incrementStat(r,m=1){r in a&&(a[r]+=m)},updateMaxStat(r,m){r in a&&m>a[r]&&(a[r]=m)},reset(){e="intro",n=0,l=0,u=0,c=0,o=0,a={...us}}}}function We(e,n){return e%=n,e<0&&(e+=n),e}function oo(e,n){return e[Math.min(n,e.length-1)]}function Nn(e){let n=Math.max(0,Math.floor(e/1e3)),l=Math.floor(n/60),u=n%60;return`${l}:${u.toString().padStart(2,"0")}`}function io(e,n){let l=e.map(({x:r,y:m},p)=>({x:m,y:-r,color:n[p]})),u=1/0,c=-1/0,o=1/0;for(let r of l)u=Math.min(u,r.x),c=Math.max(c,r.x),o=Math.min(o,r.y);let a=Math.round((u+c)/2);for(let r of l)r.x-=a,r.y-=o;return l.sort((r,m)=>r.y-m.y||r.x-m.x),{cells:l.map(r=>({x:r.x,y:r.y})),colors:l.map(r=>r.color)}}function ds(e,n,l,u){let c=[];return e+1<l&&c.push({y:e+1,s:n}),e-1>=0&&c.push({y:e-1,s:n}),c.push({y:e,s:We(n-1,u)}),c.push({y:e,s:We(n+1,u)}),c}function co(e,n,l){let u=Array.from({length:n},()=>new Uint8Array(l)),c=[];for(let o=0;o<n;o++)for(let a=0;a<l;a++){if(!e[o][a]||u[o][a])continue;let r=[],m=[{y:o,s:a}];for(u[o][a]=1;m.length>0;){let p=m.shift();r.push(p);for(let g of ds(p.y,p.s,n,l))e[g.y][g.s]&&!u[g.y][g.s]&&(u[g.y][g.s]=1,m.push(g))}c.push(r)}return c}function ao(e){return e.some(n=>n.y===0)}function ms(e,n,l,u,c,o){if(!e)return!1;let a=We(l,o);for(let r of e.cells){let m=n+r.y,p=We(a+r.x,o);if(m<0)return!1;if(!(m>=c)&&u[m][p])return!1}return!0}function ro(e,n,l,u,c,o){if(!e)return null;let a=Math.floor(n);for(;ms(e,a-1,l,u,c,o);)a-=1;return a}function lo(e,n,l){let u=[],c=[];for(let o=0;o<n;o++){let a=[],r=0,m=e[o][0],p=m?1:0;for(let g=1;g<=l;g++){let h=g<l?e[o][g]:0;h&&h===m?p++:(p>=1&&m&&a.push({start:r,length:p,color:m}),r=g,m=h,p=h?1:0)}if(a.length>=2){let g=a[0],h=a[a.length-1];if(g.start===0&&h.start+h.length===l&&g.color===h.color){let T=g.length+h.length;a[0]={start:h.start,length:T,color:g.color},a.pop()}}for(let g of a)if(g.length>=3){let h=[];for(let T=0;T<g.length;T++)h.push({y:o,s:(g.start+T)%l});u.push({color:g.color,length:g.length,cells:h})}}for(let o=0;o<l;o++){let a=0,r=e[0][o],m=r?1:0;for(let p=1;p<=n;p++){let g=p<n?e[p][o]:0;if(g&&g===r)m++;else{if(m>=3&&r){let h=[];for(let T=0;T<m;T++)h.push({y:a+T,s:o});u.push({color:r,length:m,cells:h})}a=p,r=g,m=g?1:0}}}for(let o=0;o<n;o++)for(let a=0;a<l;a++){let r=e[o][a],m=e[o][(a+1)%l],p=e[o][(a+2)%l],g=e[o][(a+3)%l];r&&r===m&&p&&p===g&&r!==p&&c.push({cells:[{y:o,s:a},{y:o,s:(a+1)%l},{y:o,s:(a+2)%l},{y:o,s:(a+3)%l}]})}for(let o=0;o<l;o++)for(let a=0;a<n-3;a++){let r=e[a][o],m=e[a+1][o],p=e[a+2][o],g=e[a+3][o];r&&r===m&&p&&p===g&&r!==p&&c.push({cells:[{y:a,s:o},{y:a+1,s:o},{y:a+2,s:o},{y:a+3,s:o}]})}return{lineMatches:u,pairMatches:c}}function uo(e,n,l){let u=[];for(let c=0;c<n;c++){let o=!0;for(let a=0;a<l;a++)if(!e[c][a]){o=!1;break}o&&u.push(c)}return u}function mo(e,n){let l=new Map;e.forEach((u,c)=>l.set(`${u.x},${u.y}`,n[c]));for(let u=0;u<e.length;u++){let c=e[u],o=n[u],a=1;for(let it=1;it<=2&&l.get(`${c.x+it},${c.y}`)===o;it++)a++;if(a>=3)return!0;let r=1;for(let it=1;it<=2&&l.get(`${c.x},${c.y+it}`)===o;it++)r++;if(r>=3)return!0;let m=o,p=l.get(`${c.x+1},${c.y}`),g=l.get(`${c.x+2},${c.y}`),h=l.get(`${c.x+3},${c.y}`);if(m&&p&&g&&h&&m===p&&g===h&&m!==g)return!0;let T=o,$=l.get(`${c.x},${c.y+1}`),V=l.get(`${c.x},${c.y+2}`),Q=l.get(`${c.x},${c.y+3}`);if(T&&$&&V&&Q&&T===$&&V===Q&&T!==V)return!0}return!1}function go(e){let{getN:n,getH:l,FALL_INTERVAL:u,LOCK_DELAY_SEC:c,getKillRate:o,MATCH_HIGHLIGHT_SEC:a,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:m,getState:p,setState:g,funcs:h,ui:T}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand($,V={}){let Q=p();if($==="start_game")return Q.gameState!=="playing"?(h.startGame(),!0):!1;if(Q.gameState!=="playing")return!1;switch($){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:it}=V;return typeof it=="number"&&h.canPlaceAtRot(Math.floor(Q.pieceY),it)?(g({targetRot:it,rotFloat:it,rotVel:0}),Q.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:it,y:Et}=V;return h.shootMagic(it,Et)}case"select_magic":{let{element:it}=V;return h.selectMagic(it),!0}default:return console.warn("GameEngine: unknown command",$),!1}},update($,V){let Q=p();if(Q.gameState!=="playing")return;let it=V-Q.startTime-Q.totalPausedMs;g({elapsedMs:it}),T.updateTimeHud();let Et=Q.killLevel+o()*$;if(g({killLevel:Et}),T.updateRemainingHud(),Et>=l()){h.endGame();return}if(Q.isHighlighting){let N=(V-Q.highlightStartTime)/1e3,mt;Q.isRingAnimation?mt=m:Q.isMagicAnimation?mt=r:mt=a,N>=mt&&(Q.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let le=Q.fallTimer+$;if(le>=u&&(le-=u,h.tryMoveDown()),g({fallTimer:le}),h.updateGroundedState()){let N=Q.lockTimer+$;g({lockTimer:N}),N>=c&&h.lockPiece()}},reset(){h.startGame()},canRotateTo($,V){return h.canPlaceAtRot($,V)},getRotation(){let $=p();return{targetRot:$.targetRot,rotFloat:$.rotFloat,rotVel:$.rotVel}},setRotation($){g({targetRot:$,rotFloat:$,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var Wt=Math.PI*2;function fo(e){let{canvas:n,canvasCtx:l,getN:u,getH:c,TOP_PAD_PX:o,BOTTOM_PAD_PX:a,SIDE_MARGIN_PX:r,MAX_RADIUS_X:m,RADIUS_X_FACTOR:p,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:h,MATCH_SHRINK_PHASE:T,MAGIC_SHRINK_SEC:$,RING_HIGHLIGHT_SEC:V,LOCK_DELAY_SEC:Q,getKillRate:it,ELEMENT_COLORS:Et,ELEMENT_TO_COLOR:le,BLOCK_COLOR_FRONT:nt,BLOCK_COLOR_BACK:N,ACTIVE_COLOR_FRONT:mt,GHOST_COLOR_FILL:Ee,GHOST_COLOR_STROKE:ee,GHOST_STROKE_WIDTH:Kt,MAGIC_DIM_DOT_ALPHA:qt,MAGIC_DIM_DOT_SCALE:zt,MAGIC_TARGET_DOT_SCALE:Se,getState:Dt,getVisualSettings:It,funcs:_t}=e,d=l,Z=u(),st=c(),ue={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},Pt=[],_e=40;function Oe(B,w,R,v,S){let M=Math.max(3,Math.round(B)),W=180;for(let K=0;K<M;K++)setTimeout(()=>{let _=Math.random()>.5?"left":"right",et=15,C=_==="left"?et+Math.random()*Math.max(10,w-et*2):R+et+Math.random()*Math.max(10,S-R-et*2),y=v-10;Pt.push({x:C,baseX:C,y,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:et,maxX:S-et})},K*W)}function pn(B,w,R){Pt=Pt.filter(v=>v.y>B+v.size&&v.y>-20);for(let v of Pt){v.y-=_e*R,v.wobble+=v.wobbleSpeed*R;let S=v.baseX+Math.sin(v.wobble)*v.wobbleAmp;v.x=Math.max(v.minX,Math.min(v.maxX,S))}}function Fn(B){if(Pt.length!==0){d.fillStyle="rgba(255, 255, 255, 0.3)",d.strokeStyle="rgba(255, 255, 255, 0.5)",d.lineWidth=1;for(let w of Pt)w.y<B+w.size||(d.beginPath(),d.arc(w.x,w.y,w.size,0,Math.PI*2),d.fill(),d.stroke())}}let Ke={left:0,right:0,h:0,w:0};function Ot(B,w,R){let v=1-R/st;return B+v*w}function qe(B){return B=B%Z,B<0?B+Z:B}function ke(B,w,R,v,S,M){let W=qe(M),K=(S-W)/Z*Wt+g;return{x:B+Math.cos(K)*R,y:w+Math.sin(K)*v,ang:K}}let hn=.52,ze=1.02;function Qt(B,w,R,v,S,M){let W=qe(M),K=(S-W)/Z*Wt+g;return{x:B+Math.cos(K)*R,y:w+Math.sin(K)*v,ang:K}}function yn(B,w,R,v,S,M,W,K=1){let _=Qt(B,w,R,v,S-hn,M),et=Qt(B,w,R,v,S+hn,M),C={x:_.x,y:_.y-W*.5},y={x:_.x,y:_.y+W*.5},G={x:et.x,y:et.y-W*.5},bt={x:et.x,y:et.y+W*.5},L=(C.x+G.x+bt.x+y.x)*.25,j=(C.y+G.y+bt.y+y.y)*.25,q=ze*K,St=K,Lt=[C,G,bt,y].map(Zt=>({x:L+(Zt.x-L)*q,y:j+(Zt.y-j)*St})),$t=Math.abs((et.x-_.x)*q),rt=Math.abs(W*St);return{corners:Lt,cx:L,cy:j,wApprox:$t,hApprox:rt,ang:Qt(B,w,R,v,S,M).ang}}function Ht(B,w,R,v,S,M,W,K,_=1,et=null,C=1,y=null,G=0,bt=1,L=1){let j=yn(B,w,R,v,S,M,W,L),[q,St,Lt,$t]=j.corners;if(d.save(),d.globalAlpha=_,d.fillStyle=K,d.beginPath(),d.moveTo(q.x,q.y),d.lineTo(St.x,St.y),d.lineTo(Lt.x,Lt.y),d.lineTo($t.x,$t.y),d.closePath(),d.fill(),y&&G>0&&(d.strokeStyle=y,d.lineWidth=G,d.stroke()),et){let rt=Math.min(j.wApprox,j.hApprox)*.28*bt;d.globalAlpha=_*C,d.fillStyle=et,d.beginPath(),d.arc(j.cx,j.cy,rt,0,Wt),d.fill()}d.restore(),d.globalAlpha=1}function Un(B,w,R,v,S,M){let W=ke(B,w,R,v,S,M),K=ke(B,w,R,v,S+1,M),_=ke(B,w,R,v,S-1,M),et=Math.abs(K.x-W.x),C=Math.abs(W.x-_.x),y=(et+C)*.5*1.06;return Math.max(1,y)}function Xn(B,w,R,v,S,M){let W=(S-M)/Z*Wt+g;return{x:B+Math.cos(W)*R,y:w+Math.sin(W)*v,ang:W}}function gs(B,w,R,v,S,M,W,K=1,_=null,et=1,C=null,y=0,G=1){d.save(),d.translate(B,w);let bt=Math.atan2(v,R);if(d.rotate(bt),d.globalAlpha=K,d.fillStyle=W,d.fillRect(-S/2,-M/2,S,M),C&&y>0&&(d.strokeStyle=C,d.lineWidth=y,d.strokeRect(-S/2,-M/2,S,M)),_){let L=Math.min(S,M)*.28*G;d.globalAlpha=K*et,d.fillStyle=_,d.beginPath(),d.arc(0,0,L,0,Wt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let B=Math.max(1,Math.min(2,window.devicePixelRatio||1)),w=Math.floor(n.clientWidth*B),R=Math.floor(n.clientHeight*B);(n.width!==w||n.height!==R)&&(n.width=w,n.height=R,d.setTransform(B,0,0,B,0,0))},render(B=.016,w=performance.now()){this.resize();let R=Dt();Z=u(),st=c();let v=n.clientWidth,S=n.clientHeight;d.clearRect(0,0,v,S),d.fillStyle="#0b0f14",d.fillRect(0,0,v,S);let M=v*.5,W=(v-2*r)/2,K=S-o-a,_=6,et=Z*K/(_*st),C,y,G,bt;bt=S-a,et<=Math.min(W,m)?(C=et,y=K,G=o):(C=Math.min(W,m),y=C*_*st/Z,G=bt-y);let L=C*.28,{killLevel:j,rotFloat:q,grid:St,gameState:Lt}=R,$t=It?It():{},rt=$t.waterColor||"blue",Zt=$t.waterBubbles||!1,Me=ue[rt]||ue.blue,ut=Ot(G,y,j),Qe=.7,En=j/st,vt={...Me.top},E={...Me.bottom};if(En>Qe){let b=(En-Qe)/(1-Qe);vt.r=Math.round(vt.r+(255-vt.r)*b*.5),vt.g=Math.round(vt.g+(150-vt.g)*b*.5),vt.b=Math.round(vt.b+(150-vt.b)*b*.5),E.r=Math.round(E.r+(180-E.r)*b),E.g=Math.round(E.g*(1-b*.6)),E.b=Math.round(E.b*(1-b*.6))}let Mt=M-C-8,J=M+C+8,Bt=G,ne=bt+5,jt=d.createLinearGradient(0,ut,0,S);jt.addColorStop(0,`rgba(${vt.r},${vt.g},${vt.b},0.5)`),jt.addColorStop(1,`rgba(${E.r},${E.g},${E.b},0.7)`),d.fillStyle=jt;let De=Math.round((vt.r+E.r)/2),Ze=Math.round((vt.g+E.g)/2),de=Math.round((vt.b+E.b)/2),z=C+8,je=L+4;d.fillRect(0,ut,Mt,S-ut),d.fillRect(J,ut,v-J,S-ut),d.beginPath();let Le=Math.max(ut,ne);d.moveTo(Mt,Le),ut<=ne+je?d.ellipse(M,ne,z,je,0,Math.PI,0,!1):d.lineTo(J,Le),d.lineTo(J,S),d.lineTo(Mt,S),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(Mt,Bt),d.lineTo(Mt,ne),d.stroke(),d.beginPath(),d.moveTo(J,Bt),d.lineTo(J,ne),d.stroke(),d.beginPath(),d.ellipse(M,ne,C+8,L+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(M,ne,C+8,L+4,0,0,Wt),d.fill(),j>.5&&(d.strokeStyle=`rgba(${Math.min(255,De+60)},${Math.min(255,Ze+40)},${Math.min(255,de+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,ut),d.lineTo(Mt,ut),d.moveTo(J,ut),d.lineTo(v,ut),d.stroke()),Ke={left:Mt,right:J,h:S,w:v},(Pt.length>0||Zt)&&(pn(ut,S,B),Fn(ut)),d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let gt=Wt*C,Je=10,He=gt/Je*.7,fs=gt/Je*.3;d.setLineDash([He,fs]);let ps=gt/Z;d.lineDashOffset=qe(q)*ps;for(let b=0;b<=st;b++){let D=Ot(G,y,b);d.beginPath(),d.ellipse(M,D,C,L,0,0,Wt),d.stroke()}d.setLineDash([]);let se=[],tn=[];for(let b=0;b<st;b++){let D=Ot(G,y,b+.5);for(let F=0;F<Z;F++){let U=St[b][F];if(!U)continue;let O=ke(M,D,C,L,F,q),tt=Math.sin(O.ang),P={y:b,s:F,yScr:D,p:O,depth:tt,color:U};tt<-.1?se.push(P):tn.push(P)}}let Sn=_t.getMagicTargetColor(),{isHighlighting:en,highlightedCells:oe,highlightStartTime:Be,isMagicAnimation:Mn}=R,Gt=null,ie=1,$e=1,xn=!1;if(en&&oe.length>0){Gt=new Set(oe.map(D=>`${D.y},${D.s}`));let b=(performance.now()-Be)/1e3;if(Mn){let D=Math.min(1,b/$);ie=1-D*.85,$e=1-D*.9,xn=!0}else{let D=Math.min(1,b/h),F=1-T;if(D>F){let U=(D-F)/T;ie=1-U*.85,$e=1-U*.9,xn=!0}}}se.sort((b,D)=>b.depth-D.depth);for(let b of se){let D=y/st*.9,F=Et[b.color]||null,U=.35,O=1,tt=`${b.y},${b.s}`;Gt&&Gt.has(tt)&&(U*=$e,O=ie),Ht(M,b.yScr,C,L,b.s,q,D,N,U,F,.5,null,0,1,O)}let{isRingAnimation:xe}=R;if(en&&oe.length>0&&!Mn){let b=(performance.now()-Be)/1e3,F=Math.min(1,b/(xe?V:h)),U=1-T,O=F>U,tt=O?(F-U)/T:0,P=xe?Math.floor(F*U*Z*2)%Z:-1,H=4+F/U*10,ct=Math.sin(b*H*Wt),Rt=O?1:.3+ct*.3,pt=O?1-tt*.8:1,xt=O?1-tt:1;for(let dt of oe){let wt=Ot(G,y,dt.y+.5),ce=Qt(M,wt,C,L,dt.s,q);if(Math.sin(ce.ang)>=-.1)continue;let on=y/st*.9,kt,Nt,Ft;if(xe){let Re=(dt.s-P+Z)%Z,be=Re<3?1-Re/3:0;kt=(O?xt:.2+be*.5)*.5,Nt=`rgba(255, 159, 67, ${kt})`,Ft=O?pt:1+be*.15}else kt=Rt*xt,Nt=dt.isLine?`rgba(255, 255, 255, ${kt*.5})`:`rgba(255, 220, 100, ${kt*.4})`,Ft=O?pt:1.1;Ht(M,wt,C,L,dt.s,q,on,Nt,1,null,1,null,0,1,Ft)}}tn.sort((b,D)=>b.depth-D.depth);for(let b of tn){let D=y/st*.9,F=Et[b.color]||null,U=1,O=1,tt=1,P=1,H=`${b.y},${b.s}`,ct=Gt&&Gt.has(H);ct&&(U=$e,O=ie),Sn!==null&&!ct&&(b.color!==Sn?(tt=qt,P=zt):P=Se),Ht(M,b.yScr,C,L,b.s,q,D,nt,U,F,tt,null,0,P,O)}if(en&&oe.length>0&&!Mn){let b=(performance.now()-Be)/1e3,F=Math.min(1,b/(xe?V:h)),U=1-T,O=F>U,tt=O?(F-U)/T:0,P=xe?Math.floor(F*U*Z*2)%Z:-1,H=4+F/U*10,ct=Math.sin(b*H*Wt),Rt=O?1:.5+ct*.5,pt=O?1-tt*.8:1,xt=O?1-tt:1;for(let dt of oe){let wt=Ot(G,y,dt.y+.5),ce=Qt(M,wt,C,L,dt.s,q);if(Math.sin(ce.ang)<-.1)continue;let on=y/st*.9,kt,Nt,Ft;if(xe){let Re=(dt.s-P+Z)%Z,be=Re<4?1-Re/4:0;kt=O?xt:.3+be*.7,Nt=`rgba(255, 159, 67, ${kt})`,Ft=O?pt:1+be*.2}else kt=Rt*xt,Nt=dt.isLine?`rgba(255, 255, 255, ${kt*.7})`:`rgba(255, 220, 100, ${kt*.6})`,Ft=O?pt:1.15;Ht(M,wt,C,L,dt.s,q,on,Nt,1,null,1,null,0,1,Ft)}}let{transmuteState:bn,transmuteSourceBlock:Ge,transmuteTargetColor:nn,transmuteAreaCells:vn,transmuteBlocksToChange:sn}=R;if(bn==="selecting_source"){let b=y/st*.9,D=.3+Math.sin(w/200)*.15;for(let F of tn){let U=Ot(G,y,F.y+.5);Ht(M,U,C,L,F.s,q,b,`rgba(100, 255, 150, ${D})`,1,null,1,null,0,1,1.05)}}if(bn==="animating"&&_t.getTransmuteAnimState){let b=_t.getTransmuteAnimState(w);if(b){let D=y/st*.9,{phase:F,progress:U,areaFlash:O}=b;if(O>0&&vn)for(let tt of vn){if(tt.y<0||tt.y>=st)continue;let P=Ot(G,y,tt.y+.5),H=Qt(M,P,C,L,tt.s,q);Math.sin(H.ang)<-.1||Ht(M,P,C,L,tt.s,q,D,`rgba(150, 255, 200, ${O*.4})`,1,null,1,null,0,1,1)}if(sn&&sn.length>0){let tt=Ge?Ge.color:1,P=nn||1;for(let H of sn){if(H.y<0||H.y>=st)continue;let ct=Ot(G,y,H.y+.5),Rt=Qt(M,ct,C,L,H.s,q);if(Math.sin(Rt.ang)<-.1)continue;let xt=1,dt=Et[tt],wt=0;if(F==="shrink"?(xt=1-U*.95,dt=Et[tt],wt=.5+U*.3):F==="grow"&&(xt=U,dt=Et[P],wt=.8-U*.5),wt>0&&Ht(M,ct,C,L,H.s,q,D,`rgba(200, 255, 220, ${wt})`,1,null,1,null,0,1,1),xt>.05){let ce=yn(M,ct,C,L,H.s,q,D,1),Ne=Math.min(ce.wApprox,ce.hApprox)*.28*xt;d.save(),d.globalAlpha=1,d.fillStyle=dt,d.beginPath(),d.arc(ce.cx,ce.cy,Ne,0,Wt),d.fill(),d.restore()}}}}}let{activePiece:me,pieceY:Yn,isGrounded:Vn,lockTimer:Cn}=R;if(me){let b=_t.snappedRot(),D=b,F=_t.computeGhostY(),U=y/st*.9;if(F!==null){let P=[];for(let H=0;H<me.cells.length;H++){let ct=me.cells[H],Rt=me.colors[H],pt=F+ct.y,xt=_t.normSector(b+ct.x);if(pt<0||pt>=st)continue;let dt=Ot(G,y,pt+.5),wt=Qt(M,dt,C,L,xt,D);P.push({cy:pt,cs:xt,yScr:dt,depth:Math.sin(wt.ang),color:Rt})}P.sort((H,ct)=>H.depth-ct.depth);for(let H of P){let ct=Et[H.color]||null;Ht(M,H.yScr,C,L,H.cs,D,U,Ee,1,ct,.5,ee,Kt,1,1)}}let O=mt;if(Vn&&Cn>0){let P=Math.min(1,Cn/Q),H=255,ct=Math.round(170+85*P),Rt=Math.round(180+75*P),pt=.75+(1-.75)*P;O=`rgba(${H},${ct},${Rt},${pt})`}let tt=[];for(let P=0;P<me.cells.length;P++){let H=me.cells[P],ct=me.colors[P],Rt=_t.normSector(b+H.x),pt=Yn+H.y;if(pt<0||pt>=st)continue;let xt=Ot(G,y,pt+.5),dt=Qt(M,xt,C,L,Rt,D);tt.push({cs:Rt,yScr:xt,depth:Math.sin(dt.ang),color:ct})}tt.sort((P,H)=>P.depth-H.depth);for(let P of tt){let H=Et[P.color]||null;Ht(M,P.yScr,C,L,P.cs,D,U,O,1,H,1,null,0,1,1)}}},drawNextPreview(B,w){if(!B)return;let R=B.getContext("2d"),v=B.width,S=B.height;if(R.clearRect(0,0,v,S),!w)return;let M=1/0,W=-1/0,K=1/0,_=-1/0;for(let L of w.cells)M=Math.min(M,L.x),W=Math.max(W,L.x),K=Math.min(K,L.y),_=Math.max(_,L.y);let et=W-M+1,C=_-K+1,y=Math.min(v/(et+.5),S/(C+.5)),G=(v-et*y)/2,bt=(S-C*y)/2;R.fillStyle=nt;for(let L=0;L<w.cells.length;L++){let j=w.cells[L],q=G+(j.x-M)*y,St=bt+(C-1-(j.y-K))*y;R.fillRect(q+1,St+1,y-2,y-2);let Lt=w.colors[L],$t=Et[Lt];if($t){let rt=(y-2)*.32;R.fillStyle=$t,R.beginPath(),R.arc(q+y/2,St+y/2,rt,0,Wt),R.fill(),R.fillStyle=nt}}},spawnBonusBubbles(B){let{left:w,right:R,h:v,w:S}=Ke;S>0&&Oe(B,w,R,v,S)}}}(()=>{let e=zs(),n=e.canvas,l=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,c=30,o=24,a=120,r={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let s=r[t]||r["30_24"];c=s.N,o=s.H,a=s.survivalTime}function p(){return o/a}let g=Math.PI/2,h=70,T=120,$=30,V=320,Q=.42,it="rgb(235,240,250)",Et="rgb(55,62,75)",le="rgba(255,170,180,0.75)",nt="rgba(110,255,150,0.15)",N="rgba(110,255,150,0.85)",mt=2,Ee={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},ee={1:"fire",2:"water",3:"lightning",4:"earth"},Kt={fire:1,water:2,lightning:3,earth:4},qt=1,zt=.58,Se=!0,Dt=12,It=25,_t=1,d=2,Z=3,st=5,ue=8,Pt=10,_e=15,Oe=30,pn=2,Fn=.3,Ke=.5,Ot=1,qe=.3,ke=.5,hn=1.3,ze=10,Qt=500,yn=[1,1.25,1.5,1.75,2],Ht=10,Un=100,Xn=25,gs=5,B=8,w=.35,R=[1,1.3,1.6,2],v=[1,1.5,2,2.5],S=qs(),M=S.loadGameSettings(),W=M.invertSwipe?-1:1,K=-1,_=Array.from({length:o},()=>new Uint8Array(c));function et(){_=Array.from({length:o},()=>new Uint8Array(c))}let C=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,G=o+3,bt=0,L=0,j=!1,q=0,St=0,Lt=0,$t=3,rt=0,Zt=0,Me=0,ut=no({canvas:n,rotDir:W}),Qe="0.14.1",En=!0,vt="blue",E=Xs();E.preload();let Mt=so(),J="intro",Bt=0,ne=0,jt=0,De=0,Ze=0,de=null,z=Mt.stats,je=e.overlay,Le=Zs({elementColors:Ee}),gt=Le.showBonus.bind(Le),Je=Le.getElementIcon.bind(Le),He=Js(),fs=e.overlayTitle,ps=e.overlayStats,se=e.startBtn,tn=e.hud,Sn=e.scoreHud,en=e.timeHud,oe=e.remainingHud,Be=e.nextCanvas,Mn=Be.getContext("2d"),Gt=e.pauseBtn,ie=e.pauseOverlay,$e=e.resumeBtn,xn=e.restartBtn,xe=e.exitToMenuBtn,bn=e.pauseSettingsBtn,Ge=e.pauseSoundBtn,nn=e.pauseMusicBtn,vn=e.pauseBestScore,sn=e.pauseBestTime,me=e.pauseBestMode,Yn=e.pauseCurrentScore,Vn=e.pauseCurrentTime,Cn=e.pauseCurrentMode,b=e.confirmDialog,D=e.confirmText,F=e.confirmCancel,U=e.confirmOk,O=e.settingsOverlay,tt=e.settingsClose,P=e.fullscreenBtn,H=e.rotateBtn,ct=e.startPanel,Rt=e.gameoverPanel,pt=e.goScore,xt=e.goTime,dt=e.goRing,wt=e.goMatches,ce=e.goBonuses,Ne=e.goNewRecord,on=e.goRestartBtn,kt=e.goExitBtn,Nt=e.bestScore,Ft=e.bestTimeVal,Re=e.startVersion,be=e.modeBtns,po=e.recordsBtn,ho=e.startSettingsBtn,yo=e.helpBtn,Jt="25_20",Ut=to({buttons:e.magicBtns,onActivate:()=>E.play("spells")}),Wn=e.magicBtns,hi=Ut.charges,Eo=t=>Ut.select(t),Kn=()=>Ut.updateButtons(),cn=e.spellWave;function So(){cn&&(cn.classList.remove("active"),cn.offsetWidth,cn.classList.add("active"),setTimeout(()=>cn.classList.remove("active"),1200))}let te=eo({button:e.spellBtn,onActivate:t=>{if(t==="ice"){let s=te.effect;Lt+=s.duration*p(),E.play("wsseffect"),gt(`\u{1F4A7} -${s.duration}s`,"time"),So(),He.spawnSpellBubbles(te.button,s.duration),Ve.spawnBonusBubbles(s.duration)}},onReady:()=>{E.play("readysuper")}});te.initButton(()=>{if(J==="playing"&&te.canUse()){if(te.currentSpell==="earth"){Yt==="idle"?xo():Xe();return}te.use()}});function hs(){return Jt==="30_24"}function qn(){let t=e.spellBtn;t&&(t.style.display=hs()?"":"none")}let ge=[],an=0,fe=!1,Ae=!1,rn=!1,Xt=0,ae=0,pe=0,Fe=[],Yt="idle",he=null,ve=null,Ie=[],ye=[],zn=0,Ue=null;function Tn(t,s,i){let f=1-i/o;return t+f*s}function _n(t,s,i,f,A,x){let I=(A-x)/c*u+g;return{x:t+Math.cos(I)*i,y:s+Math.sin(I)*f,ang:I}}function ys(t,s){let i=n.clientWidth,f=n.clientHeight,A=i*.5,x=(i-2*$)/2,I=f-h-T,ot=6,ht=c*I/(ot*o),re=f-T,Ct,Y,k;ht<=Math.min(x,V)?(Ct=ht,Y=I,k=h):(Ct=Math.min(x,V),Y=Ct*ot*o/c,k=re-Y);let X=Ct*.28,lt=Tn(k,Y,t+.5),ft=_n(A,lt,Ct,X,s,rt),yt=n.getBoundingClientRect();return{x:yt.left+ft.x,y:yt.top+ft.y}}function Mo(t,s){if(!Ut.canUse()||fe)return!1;let i=Kt[Ut.active],f=n.clientWidth,A=n.clientHeight,x=f*.5,I=(f-2*$)/2,ot=A-h-T,ht=6,re=c*ot/(ht*o),Ct=A-T,Y,k,X;re<=Math.min(I,V)?(Y=re,k=ot,X=h):(Y=Math.min(I,V),k=Y*ht*o/c,X=Ct-k);let lt=Y*.28,ft=null,yt=1/0;for(let At=0;At<o;At++){let Vt=Tn(X,k,At+.5);for(let Tt=0;Tt<c;Tt++){let mn=_[At][Tt];if(!mn||mn!==i)continue;let Te=_n(x,Vt,Y,lt,Tt,rt);if(Math.sin(Te.ang)<-.1)continue;let Pe=t-Te.x,fn=s-Te.y,Gn=Math.hypot(Pe,fn),Ns=k/o*.9,ci=Ns*1.2;Math.abs(Pe)<ci/2&&Math.abs(fn)<Ns/2&&Gn<yt&&(yt=Gn,ft={y:At,s:Tt})}}if(ft){let At=Tn(X,k,ft.y+.5),Vt=_n(x,At,Y,lt,ft.s,rt),Tt=n.getBoundingClientRect(),mn=Tt.left+Vt.x,Te=Tt.top+Vt.y,gn=Wn[Ut.active];return He.spawnMagicShot(Ut.active,gn,mn,Te,()=>{let Pe=_[ft.y][ft.s];ge=[{y:ft.y,s:ft.s,color:Pe,isLine:!1,isMagic:!0}],an=performance.now(),fe=!0,Ae=!0,Xt=0,ae=Xn,gt(`+${Xn}`,"score")}),pe=0,Ut.useCharge(),z.magicUsed++,!0}return!1}function xo(){Yt="selecting_source",he=null,ve=null,Ie=[],ye=[],gt("\u{1F33F} Select block","info"),E.play("spells")}function Xe(){Yt="idle",he=null,ve=null,Ie=[],ye=[],Ln()}function bo(t,s){if(Yt!=="selecting_source")return!1;let i=vo(t,s);return i?(he={y:i.y,s:i.s,color:_[i.y][i.s]},Co(t,s,he.color),Yt="selecting_target",!0):(Xe(),!0)}function vo(t,s){let i=n.clientWidth,f=n.clientHeight,A=i*.5,x=(i-2*$)/2,I=f-h-T,ot=6,ht=c*I/(ot*o),re=f-T,Ct,Y,k;ht<=Math.min(x,V)?(Ct=ht,Y=I,k=h):(Ct=Math.min(x,V),Y=Ct*ot*o/c,k=re-Y);let X=Ct*.28,lt=null,ft=1/0;for(let yt=0;yt<o;yt++){let At=Tn(k,Y,yt+.5);for(let Vt=0;Vt<c;Vt++){if(!_[yt][Vt])continue;let Tt=_n(A,At,Ct,X,Vt,rt);if(Math.sin(Tt.ang)<-.1)continue;let Te=t-Tt.x,gn=s-Tt.y,Pe=Math.hypot(Te,gn),fn=Y/o*.9,Gn=fn*1.2;Math.abs(Te)<Gn/2&&Math.abs(gn)<fn/2&&Pe<ft&&(ft=Pe,lt={y:yt,s:Vt})}}return lt}function Co(t,s,i){Ln();let f=document.createElement("div");f.className="transmute-popup",f.style.left=`${Math.min(t,window.innerWidth-160)}px`,f.style.top=`${Math.max(s-60,10)}px`,[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}].filter(I=>I.color!==i).forEach(I=>{let ot=document.createElement("button");ot.className=`transmute-btn ${I.name}`,ot.innerHTML=I.icon,ot.setAttribute("data-color",I.color),ot.addEventListener("click",ht=>{ht.stopPropagation(),To(I.color)}),f.appendChild(ot)});let x=document.createElement("button");x.className="transmute-btn close",x.innerHTML="\u2715",x.addEventListener("click",I=>{I.stopPropagation(),Xe()}),f.appendChild(x),document.body.appendChild(f),Ue=f,setTimeout(()=>{document.addEventListener("click",Es)},50)}function Es(t){Ue&&!Ue.contains(t.target)&&Xe()}function Ln(){document.removeEventListener("click",Es),Ue&&(Ue.remove(),Ue=null)}function To(t){Ln(),ve=t,te.use(),_o()}function _o(){if(!he){Xe();return}let{y:t,s,color:i}=he;Ie=Lo(t,s,gs);let f=Ie.filter(x=>_[x.y][x.s]===i);if(ye=Bo(f,t,s,B),ye.length===0){gt("No blocks!","info"),Xe();return}Yt="animating",zn=performance.now(),E.play("spells");let A=ee[ve]||"?";gt(`\u{1F33F} \u2192 ${ye.length}\xD7 ${Je(A)}`,"spell")}function Lo(t,s,i){let f=[],A=Math.floor(i/2);for(let x=-A;x<=A;x++)for(let I=-A;I<=A;I++){let ot=t+x,ht=Rn(s+I);if(ot<0||ot>=o)continue;let re=x*x+I*I;f.push({y:ot,s:ht,distSq:re})}return f}function Bo(t,s,i,f){return[...t].sort((x,I)=>x.distSq!==I.distSq?x.distSq-I.distSq:x.y!==I.y?x.y-I.y:x.s-I.s).slice(0,f).map(x=>({y:x.y,s:x.s}))}function Ro(t){if(Yt!=="animating")return!1;let s=(t-zn)/1e3;return Math.min(s/w,1)>=1?(Io(),!1):!0}function Ao(t){if(Yt!=="animating")return null;let s=(t-zn)/1e3,i=Math.min(s/w,1),f="flash",A=0,x=0;return i<.15?(f="flash",x=1-i/.15):i<.55?(f="shrink",A=(i-.15)/.4):(f="grow",A=(i-.55)/.45),{phase:f,progress:A,areaFlash:x}}function Io(){for(let t of ye)_[t.y][t.s]=ve;Yt="idle",he=null,ve=null,Ie=[],ye=[],pe=0,Bn()}let yi=100;function Ei(t,s){return ds(t,s,o,c)}function wo(){return co(_,o,c)}let Po=ao;function Oo(t){let s=t.map(f=>({...f,color:_[f.y][f.s]}));for(let f of t)_[f.y][f.s]=0;let i=o;for(let f of t){let A=f.y;for(let x=1;x<=f.y;x++){let I=f.y-x;if(_[I][f.s]){A=x-1;break}}i=Math.min(i,A)}for(let f of s)_[f.y-i][f.s]=f.color;return i>0}function ko(){let t=!0;for(;t;){t=!1;let s=wo();for(let i of s)Po(i)||Oo(i)&&(t=!0)}}function Do(){Bn()}let Qn=oo;function Ss(t,s){let i=new Map,f=0,A=0,x=0,I={},ot=t.length+s.length;for(let k of t){let X=ee[k.color],lt=0,ft=0;if(k.length>=5?(lt=Z,ft=Pt,z.lines5++):k.length===4?(lt=d,ft=ue,z.lines4++):k.length===3&&(lt=_t,ft=st,z.lines3++),X&&lt>0){Ut.addCharges(X,lt),I[X]=(I[X]||0)+lt;let yt=k.cells[Math.floor(k.cells.length/2)],At=ys(yt.y,yt.s),Vt=Wn[X];for(let Tt=0;Tt<lt;Tt++)setTimeout(()=>{He.spawnMagicOrb(X,At.x,At.y,Vt)},Tt*100)}f+=ft*p(),x+=ft,A+=k.length*Ht;for(let yt of k.cells){let At=`${yt.y},${yt.s}`;i.has(At)||i.set(At,{y:yt.y,s:yt.s,color:k.color,isLine:!0})}}for(let k of s){if(z.pairs++,f+=_e*p(),x+=_e,A+=Un,hs()&&te.addProgress(1)){let X=k.cells[Math.floor(k.cells.length/2)],lt=ys(X.y,X.s);He.spawnSpellOrb(lt.x,lt.y,te.button)}for(let X of k.cells){let lt=`${X.y},${X.s}`;i.has(lt)||i.set(lt,{y:X.y,s:X.s,color:_[X.y][X.s],isLine:!1})}}let ht=Qn(R,ot-1),re=Qn(v,pe),Ct=Math.round(A*ht*re),Y=0;ot>1&&(z.combos++,z.maxCombo=Math.max(z.maxCombo,ot),setTimeout(()=>gt(`COMBO \xD7${ot}`,"combo"),Y),Y+=180,E.play("combo2")),pe>0&&(z.cascades++,z.maxCascade=Math.max(z.maxCascade,pe),setTimeout(()=>gt(`CASCADE \xD7${pe}`,"cascade"),Y),Y+=180,E.play("cascade")),(t.length>0||s.length>0)&&E.play("combo");for(let k of t){let X=k.length,lt=X*Ht;setTimeout(()=>gt(`Line-${X} +${lt}`,"line",k.color),Y),Y+=100}for(let k of s){let X=k.cells.length>0?_[k.cells[0].y][k.cells[0].s]:null;setTimeout(()=>gt(`Pair +${Un}`,"pair",X),Y),Y+=100}Ct>0&&(setTimeout(()=>gt(`+${Ct}`,"score"),Y),Y+=120),x>0&&(setTimeout(()=>gt(`+${x}s`,"time"),Y),Y+=120);for(let[k,X]of Object.entries(I))X>0&&(setTimeout(()=>gt(`+${X}${Je(k)}`,"charge"),Y),Y+=120);ge=Array.from(i.values()),an=performance.now(),fe=!0,Ae=!1,Xt=f,ae=Ct,Kn()}function Ho(){for(let t of ge)_[t.y][t.s]=0;if(ge.length>0&&E.playRandom("disappear"),Xt>0){Lt+=Xt;let t=Xt/p();Ve.spawnBonusBubbles(t)}Mt.addScore(ae),Bt+=ae,Pn(),ge=[],fe=!1,Ae=!1,Xt=0,ae=0,pe++,Bn()}function Bn(){ko();let{lineMatches:t,pairMatches:s}=Ko();if(t.length>0||s.length>0)Ss(t,s);else{let i=Ts();i.length>0?Yo(i):!y&&J==="playing"&&Cs()}}function Si(t,s){Ss(t,s)}function Rn(t){return We(t,c)}function An(){return Rn(Math.round(rt))}function Ms(t,s){return ms(y,t,s,_,o,c)}function In(t){return Ms(t,An())}let wn=io;function xs(){Se&&(Dt!==0&&q>=Dt||(L=0,q+=1))}function $o(){if(!y)return;let t=y.cells,s=y.colors,i={cells:t,colors:s};if(K>=0||(i=wn(i.cells,i.colors),i=wn(i.cells,i.colors)),i=wn(i.cells,i.colors),y.cells=i.cells,y.colors=i.colors,!In(Math.floor(G))){y.cells=t,y.colors=s;return}E.play("turn"),j&&xs()}function Go(){return ro(y,G,An(),_,o,c)}function No(){if(!y)return!1;let t=Math.floor(G)-1,s=!In(t);return s&&!j?(j=!0,L=0,q=0):!s&&j&&(j=!1,L=0,q=0),s}let Ye=Nn;function ln(){if(J==="playing"){je.classList.add("hidden"),Gt.classList.remove("hidden");return}if(je.classList.remove("hidden"),Gt.classList.add("hidden"),J==="intro"){ct.classList.remove("hidden"),Rt.classList.add("hidden");let t=S.loadHighscore(Jt);t.score>0?(Nt.textContent=t.score.toLocaleString(),Ft.textContent=Ye(t.time)):(Nt.textContent="0",Ft.textContent="0:00"),$s(),Re.textContent=`v${Qe}`,se.classList.remove("idlePulse"),se.offsetWidth,se.classList.add("idlePulse")}else{ct.classList.add("hidden"),Rt.classList.remove("hidden"),pt.textContent=Bt.toLocaleString(),xt.textContent=Ye(jt);let t=S.loadHighscore(Jt);Bt>0&&Bt>=t.score?Ne.classList.remove("hidden"):Ne.classList.add("hidden");let s=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${z.rings}</span>
          <span class="count ring-max">${z.maxRing>0?"max \xD7"+z.maxRing:""}</span>
        </div>
      `;dt.innerHTML=s;let i=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${z.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${z.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${z.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${z.pairs}</span>
        </div>
      `;wt.innerHTML=i;let f=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${z.combos}</span>
          <span class="count max-combo">${z.maxCombo>0?"max \xD7"+z.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${z.cascades}</span>
          <span class="count max-cascade">${z.maxCascade>0?"max \xD7"+z.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${z.magicUsed}</span>
        </div>
      `;ce.innerHTML=f}}function Pn(){Sn.textContent=`Score: ${Bt}`}function Zn(){en.textContent=`Time: ${Ye(jt)}`}function bs(){let t=Math.max(0,(o-St)/p()),s=Math.floor(t/60),i=Math.floor(t%60);oe.textContent=`Left: ${s}:${i.toString().padStart(2,"0")}`,t<30?oe.classList.add("warning"):oe.classList.remove("warning")}function Fo(){m(Jt),et(),St=0,Lt=0,rt=Zt=0,Me=0,Mt.start(),Bt=0,ne=performance.now(),jt=0,Ze=0,De=0,J="playing",de=null,Ut.reset(),te.reset(),qn(),ge=[],Fe=[],fe=!1,Ae=!1,rn=!1,Xt=0,ae=0,pe=0,Yt="idle",he=null,ve=null,Ie=[],ye=[],Ln(),Kn(),Pn(),Zn(),bs(),Cs(),Ve.drawNextPreview(Be,de),ln(),E.getSettings().musicEnabled&&E.startGameMusic()}function jn(){Mt.gameOver(),J="gameover",y=null,j=!1,L=0,q=0;let t=S.saveHighscore(Bt,jt,Jt);E.stopMusic(),E.play("gameover"),Zn(),ln(),t&&Bt>0&&setTimeout(()=>{gt("\u{1F3C6} NEW RECORD!","score")},500)}function Uo(t){for(let i=0;i<50;i++){let f=t.map(()=>1+(Math.random()*4|0));if(!Xo(t,f))return f}return t.map((i,f)=>1+f%4)}let Xo=mo;function vs(t){let s=t.cells.map(f=>({x:f.x,y:f.y})),i=Uo(s);return{name:t.name,cells:s,colors:i}}function Cs(){if(!de){let A=C[Math.random()*C.length|0];de=vs(A)}y=de;let t=C[Math.random()*C.length|0];de=vs(t),Ve.drawNextPreview(Be,de);let s=1/0,i=-1/0;for(let A of y.cells)A.x<s&&(s=A.x),A.x>i&&(i=A.x);let f=(s+i)/2;for(let A of y.cells)A.x=A.x-Math.round(f);G=o+3,bt=0,j=!1,L=0,q=0,In(Math.floor(G))?E.playRandom("appear"):jn()}function Ts(){return uo(_,o,c)}function Yo(t){if(t.length===0)return;let s=[];for(let ot of t)for(let ht=0;ht<c;ht++)s.push({y:ot,s:ht,color:_[ot][ht],isLine:!1});Fe=t,ge=s,an=performance.now(),fe=!0,rn=!0,Ae=!1;let i=t.length;z.rings+=i,z.maxRing=Math.max(z.maxRing,i);let f=Qn(yn,i-1),A=Math.round(Qt*i*f),x=Oe*i;ae=A,Xt=x*p(),E.play("ring");let I=`RING \xD7${i}`;gt(I,"ring"),setTimeout(()=>gt(`+${A}`,"score"),150),setTimeout(()=>gt(`+${x}s`,"time"),300)}function Vo(){let t=[...Fe].sort((s,i)=>i-s);for(let s of t){for(let i=s;i<o-1;i++)_[i].set(_[i+1]);_[o-1].fill(0)}if(Xt>0){Lt+=Xt;let s=Xt/p();Ve.spawnBonusBubbles(s)}Mt.addScore(ae),Bt+=ae,Pn(),Jt==="30_24"&&Fe.length>0&&(we=S.addHighTowerRings(Fe.length)),ge=[],Fe=[],fe=!1,rn=!1,Xt=0,ae=0,Bn()}function Mi(){return Ts().length}function Wo(){if(!y)return;let t=An();rt=t,Zt=t,Me=0;let s=!1;for(let i=0;i<y.cells.length;i++){let f=y.cells[i],A=y.colors[i],x=Math.floor(G)+f.y,I=Rn(t+f.x);x>=o&&(s=!0),x>=0&&x<o&&(_[x][I]=A)}if(s){jn();return}Mt.addScore(ze),Bt+=ze,Pn(),gt(`+${ze}`,"score"),E.playRandom("drop"),y=null,pe=0,Do()}function Ko(){return lo(_,o,c)}function qo(){if(!y)return!1;let t=Math.floor(G)-1;return In(t)?(G=t,j=!1,L=0,q=0,!0):(j=!0,!1)}n.addEventListener("pointerdown",t=>{if(at.state!=="playing")return;t.preventDefault?.();let s=n.getBoundingClientRect(),i=t.clientX-s.left,f=t.clientY-s.top;ut.handlePointerDown(t,{onMagicTap:()=>Yt==="selecting_source"?bo(i,f):at.applyCommand("magic_shoot",{x:i,y:f}),onDoubleTap:()=>at.applyCommand("rotate_piece")},Zt)||(Me=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(at.state!=="playing"||!ut.dragging)return;t.preventDefault?.();let s=ut.handlePointerMove(t,{canRotateTo:(i,f)=>at.canRotateTo(i,f),onDrop:()=>at.applyCommand("move_down"),onGroundedMove:()=>at.onGroundedMove()},at.pieceY,at.isGrounded);s&&at.setRotation(s.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{at.state==="playing"&&ut.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{ut.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ut.dragging&&ut.handlePointerUp(t)},{passive:!1}),H.addEventListener("click",()=>{at.state==="playing"&&at.applyCommand("rotate_piece")});let On=e.dropBtn,kn=null;function zo(){at.state==="playing"&&(at.applyCommand("move_down"),kn=setInterval(()=>{if(at.state!=="playing"){Dn();return}at.applyCommand("move_down")},It))}function Dn(){kn&&(clearInterval(kn),kn=null)}On.addEventListener("pointerdown",t=>{t.preventDefault(),zo()}),On.addEventListener("pointerup",Dn),On.addEventListener("pointerleave",Dn),On.addEventListener("pointercancel",Dn);for(let[t,s]of Object.entries(Wn))s.addEventListener("click",()=>{at.state==="playing"&&at.applyCommand("select_magic",{element:t})});let Jn=e.soundsToggle,ts=e.musicToggle;function Ce(){let t=E.getSettings();t.soundsEnabled?Jn.classList.add("active"):Jn.classList.remove("active"),t.musicEnabled?ts.classList.add("active"):ts.classList.remove("active");for(let s=0;s<=4;s++){let i=e.soundVolBtns[s],f=e.musicVolBtns[s];i&&i.classList.toggle("active",t.soundVolume===s),f&&f.classList.toggle("active",t.musicVolume===s)}}let _s=e.tabBtns,Qo=e.tabContents;_s.forEach(t=>{t.addEventListener("click",()=>{let s=t.dataset.tab;_s.forEach(i=>i.classList.remove("active")),Qo.forEach(i=>i.classList.remove("active")),t.classList.add("active"),Qs(s).classList.add("active"),s==="sounds"&&Ce()})});let Ls=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Bs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Zo=e.iosHint,jo=e.standaloneBadge;function Rs(){let t=document.fullscreenElement||document.webkitFullscreenElement;P.textContent=t?"Disable":"Enable"}Ls&&(Bs?(jo.style.display="block",P.style.display="none"):(Zo.style.display="block",P.textContent="Not supported",P.style.opacity="0.5",P.style.cursor="default")),P.addEventListener("click",()=>{if(Ls&&!Bs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let s=document.documentElement;s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Rs),document.addEventListener("webkitfullscreenchange",Rs);let Hn=e.invertSwipeToggle;M.invertSwipe&&Hn.classList.add("active"),Hn.addEventListener("click",()=>{Hn.classList.toggle("active");let t=Hn.classList.contains("active");ut.rotDir=t?-1:1,M.invertSwipe=t,S.saveGameSettings(M)});let As=e.diffBtns;As.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(As.forEach(s=>{s.classList.remove("active");let i=s.querySelector(".check-icon");i&&i.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let s=document.createElement("span");s.className="check-icon",s.textContent="\u2713",t.appendChild(s)}})}),Jn.addEventListener("click",()=>{let s=!E.getSettings().soundsEnabled;E.updateSettings({soundsEnabled:s}),Ce(),un()}),ts.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),Ce(),un(),J!=="paused"&&(s?J==="playing"?E.startGameMusic():E.startMenuMusic():E.stopMusic())});for(let t=0;t<=4;t++){let s=e.soundVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({soundVolume:t}),Ce(),E.play("turn")})}for(let t=0;t<=4;t++){let s=e.musicVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({musicVolume:t}),Ce()})}Ce();function Is(){J==="playing"&&(Mt.pause(),De=performance.now(),J="paused",E.musicAudio&&E.musicAudio.pause())}function $n(){J==="paused"&&(Mt.resume(),Ze+=performance.now()-De,De=0,J="playing",ss=performance.now(),E.getSettings().musicEnabled&&E.startGameMusic())}function un(){let t=E.getSettings();Ge.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Ge.classList.toggle("off",!t.soundsEnabled),nn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",nn.classList.toggle("off",!t.musicEnabled)}function Jo(){ie.classList.remove("hidden"),Gt.classList.add("hidden");let t=S.loadHighscore(Jt);vn.textContent=t.score?t.score.toLocaleString():"0",sn.textContent=t.time?Nn(t.time):"0:00",me.textContent=Jt==="30_24"?"High Tower":"Quick Tower",Yn.textContent=Bt.toLocaleString(),Vn.textContent=Nn(jt),Cn.textContent=Jt==="30_24"?"High Tower":"Quick Tower",un()}function dn(){ie.classList.add("hidden"),Gt.classList.remove("hidden")}Gt.addEventListener("click",()=>{Is(),Jo()}),$e.addEventListener("click",()=>{dn(),$n()});let es=null;function ws(t,s){D.textContent=t,es=s,b.classList.remove("hidden")}function Ps(){b.classList.add("hidden"),es=null}F.addEventListener("click",()=>{Ps()}),U.addEventListener("click",()=>{let t=es;Ps(),t&&t()}),xn.addEventListener("click",()=>{ws("Restart game?",()=>{dn(),at.applyCommand("start_game")})}),xe.addEventListener("click",()=>{ws("Exit to menu?",()=>{dn(),Gt.classList.add("hidden"),J="intro",Mt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),ln()})}),bn.addEventListener("click",()=>{O.classList.remove("hidden")}),Ge.addEventListener("click",()=>{let t=E.getSettings();E.updateSettings({soundsEnabled:!t.soundsEnabled}),un(),Ce()}),nn.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),un(),Ce()}),ie.addEventListener("click",t=>{t.target===ie&&(dn(),$n())}),document.addEventListener("keydown",t=>{J==="paused"&&!ie.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(dn(),$n())}),tt.addEventListener("click",()=>{O.classList.add("hidden")}),O.addEventListener("click",t=>{t.target===O&&O.classList.add("hidden")});let ns=!1;document.addEventListener("visibilitychange",()=>{document.hidden?J==="playing"&&(Is(),ns=!0):ns&&J==="paused"&&($n(),ns=!1)});let at=go({getN:()=>c,getH:()=>o,FALL_INTERVAL:qt,LOCK_DELAY_SEC:zt,getKillRate:p,MATCH_HIGHLIGHT_SEC:pn,MAGIC_SHRINK_SEC:Ke,RING_HIGHLIGHT_SEC:Ot,getState:()=>({gameState:J,score:Bt,elapsedMs:jt,startTime:ne,totalPausedMs:Ze,stats:z,activePiece:y,pieceY:G,targetRot:Zt,rotFloat:rt,rotVel:Me,isGrounded:j,isHighlighting:fe,isMagicAnimation:Ae,isRingAnimation:rn,highlightStartTime:an,killLevel:St,grid:_,fallTimer:bt,lockTimer:L}),setState:t=>{"elapsedMs"in t&&(jt=t.elapsedMs),"killLevel"in t&&(St=t.killLevel),"fallTimer"in t&&(bt=t.fallTimer),"lockTimer"in t&&(L=t.lockTimer),"targetRot"in t&&(Zt=t.targetRot),"rotFloat"in t&&(rt=t.rotFloat),"rotVel"in t&&(Me=t.rotVel)},funcs:{startGame:Fo,endGame:jn,rotatePieceByDir:$o,tryMoveDown:qo,canPlaceAtRot:Ms,maybeResetLockDelay:xs,shootMagic:Mo,selectMagic:Eo,updateGroundedState:No,lockPiece:Wo,finishHighlight:Ho,finishRingHighlight:Vo},ui:{updateTimeHud:Zn,updateRemainingHud:bs}}),Ve=fo({canvas:n,canvasCtx:l,getN:()=>c,getH:()=>o,TOP_PAD_PX:h,BOTTOM_PAD_PX:T,SIDE_MARGIN_PX:$,MAX_RADIUS_X:V,RADIUS_X_FACTOR:Q,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:pn,MATCH_SHRINK_PHASE:Fn,MAGIC_SHRINK_SEC:Ke,RING_HIGHLIGHT_SEC:Ot,LOCK_DELAY_SEC:zt,getKillRate:p,ELEMENT_COLORS:Ee,ELEMENT_TO_COLOR:Kt,BLOCK_COLOR_FRONT:it,BLOCK_COLOR_BACK:Et,ACTIVE_COLOR_FRONT:le,GHOST_COLOR_FILL:nt,GHOST_COLOR_STROKE:N,GHOST_STROKE_WIDTH:mt,MAGIC_DIM_DOT_ALPHA:qe,MAGIC_DIM_DOT_SCALE:ke,MAGIC_TARGET_DOT_SCALE:hn,getState:()=>({gameState:J,grid:_,activePiece:y,pieceY:G,rotFloat:rt,killLevel:St,isHighlighting:fe,highlightedCells:ge,highlightStartTime:an,isMagicAnimation:Ae,isRingAnimation:rn,isGrounded:j,lockTimer:L,transmuteState:Yt,transmuteSourceBlock:he,transmuteTargetColor:ve,transmuteAreaCells:Ie,transmuteBlocksToChange:ye}),getVisualSettings:()=>({waterBubbles:En,waterColor:vt}),funcs:{snappedRot:An,computeGhostY:Go,normSector:Rn,getMagicTargetColor:()=>Ut.canUse()?Kt[Ut.active]:null,getTransmuteAnimState:Ao}}),ss=performance.now();function Os(t){let s=Math.min(.05,Math.max(.001,(t-ss)/1e3));if(ss=t,at.update(s,t),Ro(t),Lt>0){let i=Math.min(Lt,$t*s);St=Math.max(0,St-i),Lt-=i}rt=Zt,rt>1e6&&(rt%=c),rt<-1e6&&(rt%=c),Ve.render(s,t),requestAnimationFrame(Os)}se.addEventListener("click",()=>{at.applyCommand("start_game")}),on.addEventListener("click",()=>{at.applyCommand("start_game")}),kt.addEventListener("click",()=>{J="intro",Mt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),ln()}),be.forEach(t=>{t.addEventListener("click",s=>{if(s.target.closest(".spell-select-btn"))return;be.forEach(f=>f.classList.remove("active")),t.classList.add("active"),Jt=t.dataset.mode,qn();let i=S.loadHighscore(Jt);i.score>0?(Nt.textContent=i.score.toLocaleString(),Ft.textContent=Ye(i.time)):(Nt.textContent="0",Ft.textContent="0:00"),se.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>se.classList.add("idlePulse"),2e3)})});let os=document.querySelectorAll(".spell-select-btn"),is=document.getElementById("spellDesc"),ks=document.getElementById("spellProgressFill"),cs=document.getElementById("spellProgressMarkers"),as={ice:0,earth:10,air:25,fire:40},Ds=Object.values(as).sort((t,s)=>t-s),rs=Math.max(...Ds),ti={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"};S.saveHighTowerRings(15);let we=S.loadHighTowerRings();function ei(){cs&&(cs.innerHTML="",Ds.forEach(t=>{let s=document.createElement("span");s.className="marker",s.dataset.threshold=t;let i=t/rs*100;s.style.left=`${i}%`,cs.appendChild(s)}))}function ni(t){return t<=0?0:t>=rs?100:t/rs*100}function Hs(t){if(!is)return;let s=as[t]||0,i=ti[t]||"";s===0||we>=s?is.innerHTML=i:is.innerHTML=`${i} <span class="spell-progress-text">${we}/${s}</span>`}function $s(){if(we=S.loadHighTowerRings(),os.forEach(i=>{let f=i.dataset.spell,A=as[f]||0,x=we>=A;i.classList.toggle("locked",!x);let I=i.querySelector(".spell-lock");I&&(I.style.display=x?"none":"")}),ks){let i=ni(we);ks.style.width=`${i}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(i=>{let f=parseInt(i.dataset.threshold,10)||0;i.classList.toggle("reached",we>=f)});let s=document.querySelector(".spell-select-btn.active");s&&Hs(s.dataset.spell)}ei(),$s(),os.forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation(),os.forEach(f=>f.classList.remove("active")),t.classList.add("active");let i=t.dataset.spell;te.selectSpell(i),Hs(i)})}),po.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),s=S.loadHighscore("25_20"),i=`Records

`;i+=`High Tower (30\xD724):
`,i+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ye(t.time)}
`:`  No record yet
`,i+=`
Quick Tower (25\xD720):
`,i+=s.score>0?`  Score: ${s.score.toLocaleString()}, Time: ${Ye(s.time)}
`:`  No record yet
`,alert(i)}),ho.addEventListener("click",()=>{O.classList.remove("hidden")}),yo.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),Kn(),qn(),ln(),E.startMenuMusic();let si=()=>{if(E.unlock(),!E.getSettings().musicEnabled)return;let t=E.musicAudio;!t||t.paused||t.ended?at.state==="playing"?E.startGameMusic():E.startMenuMusic():t.play().catch(s=>{console.debug("Music resume on interaction failed:",s)})},Gs=0,oi=10,ii=()=>{Gs>=oi||(Gs++,si())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ii,{passive:!0})}),requestAnimationFrame(Os)})();})();
