(()=>{var ds=[0,.25,.5,.75,1],fs=[0,.05,.15,.25,.5],ms={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},mn={menu:"music/mm.mp3",game:"sounds/amb1.wav"},gn="soundSettings";function gs(){try{let e=localStorage.getItem(gn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function ps(e){try{localStorage.setItem(gn,JSON.stringify(e))}catch(o){console.debug("Failed to save sound settings:",o)}}function pn(){return{audioContext:null,buffers:{},settings:gs(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let o=window.AudioContext||window.webkitAudioContext;this.audioContext=new o,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(o){console.debug("Failed to create AudioContext:",o)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(o){console.debug("Failed to resume AudioContext:",o)}if(!this.unlocked&&this.audioContext.state==="running"){let o=this.audioContext.createBuffer(1,1,22050),a=this.audioContext.createBufferSource();a.buffer=o,a.connect(this.audioContext.destination),a.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ds[this.settings.soundVolume]},getMusicVolume(){return fs[this.settings.musicVolume]},async loadSound(o,a){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(a)).arrayBuffer(),n=await this.audioContext.decodeAudioData(i);this.buffers[o]=n}catch(u){console.debug(`Failed to load sound: ${o} from ${a}`,u)}},preload(){this.initContext();for(let[o,a]of Object.entries(ms))this.loadSound(o,a)},play(o,a=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=o;a!==null&&(u=`${o}${a}`);let i=this.buffers[u];if(i)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let s=this.audioContext.createBufferSource();s.buffer=i,s.connect(n),s.start(0),s.onended=()=>{s.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(o){if(!this.settings.soundsEnabled)return;let a=1+Math.floor(Math.random()*3);this.play(o,a)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(mn.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Menu music started")}).catch(a=>{console.debug("Menu music autoplay blocked:",a)})}catch(o){console.debug("Menu music start failed:",o)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(mn.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Game music started")}).catch(a=>{console.debug("Game music play failed:",a)})}catch(o){console.debug("Game music start failed:",o)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(o){console.debug("Stop music failed:",o)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(o){if(this.settings={...this.settings,...o},ps(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(a=>{console.debug("Music resume failed:",a)}):this.stopMusic()}catch(a){console.debug("Update music settings failed:",a)}},getSettings(){return{...this.settings}}}}var hn="eb_highscore",yn="eb_settings",hs={invertSwipe:!1,difficulty:"easy"};function En(){return{loadHighscore(){try{let e=localStorage.getItem(hn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load highscore:",e)}return{score:0,time:0}},saveHighscore(e,o){try{let a=this.loadHighscore();if(e>a.score||e===a.score&&o>a.time)return localStorage.setItem(hn,JSON.stringify({score:e,time:o})),!0}catch(a){console.debug("Failed to save highscore:",a)}return!1},loadGameSettings(){try{let e=localStorage.getItem(yn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...hs}},saveGameSettings(e){try{localStorage.setItem(yn,JSON.stringify(e))}catch(o){console.debug("Failed to save game settings:",o)}}}}function Sn(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),settingsBtn:document.getElementById("settingsBtn"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function xn(e){return document.getElementById("tab-"+e)}var Mn={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function vn(e={}){let{elementColors:o={}}=e,a=0;return{showBonus(u,i="score",n=null){let s=document.createElement("div");s.className=`bonus-popup ${i}`,s.textContent=u,n&&o[n]&&(s.style.color=o[n]);let c=window.innerWidth/2,m=window.innerHeight/2-40,g=(Math.random()-.5)*200,f=(Math.random()-.5)*100+a*36;s.style.left=`${c+g}px`,s.style.top=`${m+f}px`,s.style.transform="translate(-50%, -50%)",document.body.appendChild(s),a++,setTimeout(()=>{a=Math.max(0,a-1)},200),setTimeout(()=>{s.remove()},1800)},getElementIcon(u){return Mn[u]||"\u2726"},spawnMagicOrb(u,i,n,s){if(!s)return;let c=document.createElement("div");c.className=`magic-orb ${u}`,c.textContent=Mn[u]||"\u2726";let m=s.getBoundingClientRect(),g=m.left+m.width/2-i,f=m.top+m.height/2-n,h=Math.hypot(g,f),K=Math.atan2(f,g),P=h*.35*(Math.random()>.5?1:-1),z=K+Math.PI/2,R=g*.5+Math.cos(z)*P,U=f*.5+Math.sin(z)*P;c.style.setProperty("--mid-x",`${R}px`),c.style.setProperty("--mid-y",`${U}px`),c.style.setProperty("--end-x",`${g}px`),c.style.setProperty("--end-y",`${f}px`),c.style.left=`${i}px`,c.style.top=`${n}px`,document.body.appendChild(c),setTimeout(()=>{c.remove(),s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))},700)}}}function _n(e={}){let{buttons:o={},onActivate:a=null}=e,u={fire:3,water:3,lightning:3,earth:3},i=null;function n(){for(let[s,c]of Object.entries(o)){if(!c)continue;let m=u[s],g=c.querySelector(".charges");g&&(g.textContent=m),c.classList.toggle("empty",m<=0),c.classList.toggle("active",i===s&&m>0)}}return{get charges(){return u},get active(){return i},set active(s){i=s},select(s){if(u[s]<=0)return!1;let c=i===s;return i=c?null:s,n(),!c&&i===s&&a&&a(),!c},useCharge(){return!i||u[i]<=0?!1:(u[i]--,i=null,n(),!0)},addCharges(s,c){u[s]!==void 0&&(u[s]+=c,n())},canUse(){return i!==null&&u[i]>0},deactivate(){i=null,n()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,i=null,n()},updateButtons:n,initButtons(s){for(let[c,m]of Object.entries(o))m&&m.addEventListener("click",()=>{s&&s(c)})}}}var ys={PX_PER_STEP:16,DEADZONE_PX:2,PX_PER_DROP:18,AXIS_DOMINANCE:1.1,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:400,DROP_SWIPE_MIN_DISTANCE:12,DOUBLE_TAP_MS:280,DOUBLE_TAP_MAX_DIST:18};function Cn(e={}){let{canvas:o}=e,a=e.rotDir||1,u=!1,i=0,n=0,s=0,c=0,m=0,g=1,f=null,h=0,K=0,P=0,z=0,R=0,U=0,xt=0,Yt=0,V=ys;return{get rotDir(){return a},set rotDir(w){a=w},get dragging(){return u},get dragMode(){return f},handlePointerDown(w,st,ce){if(st.onMagicTap&&st.onMagicTap(w.clientX,w.clientY))return!0;let Vt=performance.now(),Zt=Vt-U,Ct=w.clientX-xt,Tt=w.clientY-Yt,Ot=Math.hypot(Ct,Tt);return Zt<=V.DOUBLE_TAP_MS&&Ot<=V.DOUBLE_TAP_MAX_DIST?(st.onDoubleTap&&st.onDoubleTap(),U=0):(U=Vt,xt=w.clientX,Yt=w.clientY),u=!0,g=-1,i=w.clientX,n=w.clientY,s=ce,c=0,m=0,f=null,h=Vt,K=w.clientX,P=w.clientY,z=h,R=0,o&&o.setPointerCapture(w.pointerId),!1},handlePointerMove(w,st,ce,Vt){if(!u)return null;let Zt=w.clientX-i,Ct=w.clientY-n,Tt=performance.now();if(Math.abs(Zt)<V.DEADZONE_PX&&Math.abs(Ct)<V.DEADZONE_PX)return null;if(!f){let r=Math.abs(Zt),rt=Math.abs(Ct);if(Ct<0)r>=V.DEADZONE_PX&&(f="rotate");else if(rt>=r*V.AXIS_DOMINANCE){if(rt>=V.DROP_SWIPE_MIN_DISTANCE){let Pt=Math.max(1,Tt-h);rt/Pt*1e3>=V.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else r>=rt*V.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let Ot=null;if(f==="rotate"&&Math.abs(Zt)>=V.DEADZONE_PX){let r=Math.max(1,Tt-z),rt=w.clientX-K,Pt=Math.max(1,Math.abs(rt)/r*1e3),wt=Math.max(V.MIN_ROT_PX,Math.min(V.MAX_ROT_PX,V.PX_PER_STEP*(V.SWIPE_SPEED_REF/Pt)));R+=-rt/wt*a*g;let bt=Math.trunc(R);bt!==0&&(R-=bt);let Bt=c+bt;if(Bt!==c&&st.canRotateTo){let ht=Math.sign(Bt-c),ee=s+c;for(;c!==Bt;){let Gt=c+ht,ue=s+Gt;if(!st.canRotateTo(Math.floor(ce),ue))break;c=Gt,ee=ue,Vt&&st.onGroundedMove&&st.onGroundedMove()}Ot={targetRot:ee,rotFloat:ee}}}if(f==="drop"&&Ct>V.DEADZONE_PX&&st.onDrop){let r=Math.max(1,Tt-z),rt=w.clientY-P,Pt=Math.max(1,rt/r*1e3),wt=Math.max(V.MIN_DROP_PX,Math.min(V.MAX_DROP_PX,V.PX_PER_DROP*(V.SWIPE_SPEED_REF/Pt))),bt=Math.trunc(Ct/wt);if(bt>m){let Bt=bt-m;for(let ht=0;ht<Bt;ht++)st.onDrop();m=bt}}return K=w.clientX,P=w.clientY,z=Tt,Ot},handlePointerUp(w){u&&(u=!1,o&&o.releasePointerCapture(w.pointerId))},reset(){u=!1,f=null,c=0,m=0,R=0}}}var Ue={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Tn(){let e="intro",o=0,a=0,u=0,i=0,n=0,s={...Ue};return{get state(){return e},get score(){return o},get elapsedMs(){return u},get startTime(){return a},get stats(){return s},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",o=0,a=performance.now(),u=0,i=0,n=0,s={...Ue}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(n+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(c){o+=c},setScore(c){o=c},updateTime(){e==="playing"&&a>0&&(u=performance.now()-a-n)},getFormattedTime(){let c=Math.floor(u/1e3),m=Math.floor(c/60),g=c%60;return`${m}:${g.toString().padStart(2,"0")}`},incrementStat(c,m=1){c in s&&(s[c]+=m)},updateMaxStat(c,m){c in s&&m>s[c]&&(s[c]=m)},reset(){e="intro",o=0,a=0,u=0,i=0,n=0,s={...Ue}}}}function Ee(e,o){return e%=o,e<0&&(e+=o),e}function bn(e,o){return e[Math.min(o,e.length-1)]}function An(e){let o=Math.max(0,Math.floor(e/1e3)),a=Math.floor(o/60),u=o%60;return`${a}:${u.toString().padStart(2,"0")}`}function Ln(e,o){let a=e.map(({x:c,y:m},g)=>({x:m,y:-c,color:o[g]})),u=1/0,i=-1/0,n=1/0;for(let c of a)u=Math.min(u,c.x),i=Math.max(i,c.x),n=Math.min(n,c.y);let s=Math.round((u+i)/2);for(let c of a)c.x-=s,c.y-=n;return a.sort((c,m)=>c.y-m.y||c.x-m.x),{cells:a.map(c=>({x:c.x,y:c.y})),colors:a.map(c=>c.color)}}function Xe(e,o,a,u){let i=[];return e+1<a&&i.push({y:e+1,s:o}),e-1>=0&&i.push({y:e-1,s:o}),i.push({y:e,s:Ee(o-1,u)}),i.push({y:e,s:Ee(o+1,u)}),i}function Rn(e,o,a){let u=Array.from({length:o},()=>new Uint8Array(a)),i=[];for(let n=0;n<o;n++)for(let s=0;s<a;s++){if(!e[n][s]||u[n][s])continue;let c=[],m=[{y:n,s}];for(u[n][s]=1;m.length>0;){let g=m.shift();c.push(g);for(let f of Xe(g.y,g.s,o,a))e[f.y][f.s]&&!u[f.y][f.s]&&(u[f.y][f.s]=1,m.push(f))}i.push(c)}return i}function In(e){return e.some(o=>o.y===0)}function Ye(e,o,a,u,i,n){if(!e)return!1;let s=Ee(a,n);for(let c of e.cells){let m=o+c.y,g=Ee(s+c.x,n);if(m<0)return!1;if(!(m>=i)&&u[m][g])return!1}return!0}function On(e,o,a,u,i,n){if(!e)return null;let s=Math.floor(o);for(;Ye(e,s-1,a,u,i,n);)s-=1;return s}function Pn(e,o,a){let u=[],i=[];for(let n=0;n<o;n++){let s=[],c=0,m=e[n][0],g=m?1:0;for(let f=1;f<=a;f++){let h=f<a?e[n][f]:0;h&&h===m?g++:(g>=1&&m&&s.push({start:c,length:g,color:m}),c=f,m=h,g=h?1:0)}if(s.length>=2){let f=s[0],h=s[s.length-1];if(f.start===0&&h.start+h.length===a&&f.color===h.color){let K=f.length+h.length;s[0]={start:h.start,length:K,color:f.color},s.pop()}}for(let f of s)if(f.length>=3){let h=[];for(let K=0;K<f.length;K++)h.push({y:n,s:(f.start+K)%a});u.push({color:f.color,length:f.length,cells:h})}}for(let n=0;n<a;n++){let s=0,c=e[0][n],m=c?1:0;for(let g=1;g<=o;g++){let f=g<o?e[g][n]:0;if(f&&f===c)m++;else{if(m>=3&&c){let h=[];for(let K=0;K<m;K++)h.push({y:s+K,s:n});u.push({color:c,length:m,cells:h})}s=g,c=f,m=f?1:0}}}for(let n=0;n<o;n++)for(let s=0;s<a;s++){let c=e[n][s],m=e[n][(s+1)%a],g=e[n][(s+2)%a],f=e[n][(s+3)%a];c&&c===m&&g&&g===f&&c!==g&&i.push({cells:[{y:n,s},{y:n,s:(s+1)%a},{y:n,s:(s+2)%a},{y:n,s:(s+3)%a}]})}for(let n=0;n<a;n++)for(let s=0;s<o-3;s++){let c=e[s][n],m=e[s+1][n],g=e[s+2][n],f=e[s+3][n];c&&c===m&&g&&g===f&&c!==g&&i.push({cells:[{y:s,s:n},{y:s+1,s:n},{y:s+2,s:n},{y:s+3,s:n}]})}return{lineMatches:u,pairMatches:i}}function wn(e,o,a){let u=[];for(let i=0;i<o;i++){let n=!0;for(let s=0;s<a;s++)if(!e[i][s]){n=!1;break}n&&u.push(i)}return u}function Dn(e,o){let a=new Map;e.forEach((u,i)=>a.set(`${u.x},${u.y}`,o[i]));for(let u=0;u<e.length;u++){let i=e[u],n=o[u],s=1;for(let U=1;U<=2&&a.get(`${i.x+U},${i.y}`)===n;U++)s++;if(s>=3)return!0;let c=1;for(let U=1;U<=2&&a.get(`${i.x},${i.y+U}`)===n;U++)c++;if(c>=3)return!0;let m=n,g=a.get(`${i.x+1},${i.y}`),f=a.get(`${i.x+2},${i.y}`),h=a.get(`${i.x+3},${i.y}`);if(m&&g&&f&&h&&m===g&&f===h&&m!==f)return!0;let K=n,P=a.get(`${i.x},${i.y+1}`),z=a.get(`${i.x},${i.y+2}`),R=a.get(`${i.x},${i.y+3}`);if(K&&P&&z&&R&&K===P&&z===R&&K!==z)return!0}return!1}function Bn(e){let{N:o,H:a,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,KILL_RATE:n,MATCH_HIGHLIGHT_SEC:s,MAGIC_SHRINK_SEC:c,RING_HIGHLIGHT_SEC:m,getState:g,setState:f,funcs:h,ui:K}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(P,z={}){let R=g();if(P==="start_game")return R.gameState!=="playing"?(h.startGame(),!0):!1;if(R.gameState!=="playing")return!1;switch(P){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:U}=z;return typeof U=="number"&&h.canPlaceAtRot(Math.floor(R.pieceY),U)?(f({targetRot:U,rotFloat:U,rotVel:0}),R.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:U,y:xt}=z;return h.shootMagic(U,xt)}case"select_magic":{let{element:U}=z;return h.selectMagic(U),!0}default:return console.warn("GameEngine: unknown command",P),!1}},update(P,z){let R=g();if(R.gameState!=="playing")return;let U=z-R.startTime-R.totalPausedMs;f({elapsedMs:U}),K.updateTimeHud();let xt=R.killLevel+n*P;if(f({killLevel:xt}),xt>=a){h.endGame();return}if(R.isHighlighting){let w=(z-R.highlightStartTime)/1e3,st;R.isRingAnimation?st=m:R.isMagicAnimation?st=c:st=s,w>=st&&(R.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let Yt=R.fallTimer+P;if(Yt>=u&&(Yt-=u,h.tryMoveDown()),f({fallTimer:Yt}),h.updateGroundedState()){let w=R.lockTimer+P;f({lockTimer:w}),w>=i&&h.lockPiece()}},reset(){h.startGame()},canRotateTo(P,z){return h.canPlaceAtRot(P,z)},getRotation(){let P=g();return{targetRot:P.targetRot,rotFloat:P.rotFloat,rotVel:P.rotVel}},setRotation(P){f({targetRot:P,rotFloat:P,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var Xt=Math.PI*2;function Gn(e){let{canvas:o,canvasCtx:a,N:u,H:i,TOP_PAD_PX:n,BOTTOM_PAD_PX:s,MAX_RADIUS_X:c,RADIUS_X_FACTOR:m,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:f,MATCH_SHRINK_PHASE:h,MAGIC_SHRINK_SEC:K,RING_HIGHLIGHT_SEC:P,LOCK_DELAY_SEC:z,ELEMENT_COLORS:R,ELEMENT_TO_COLOR:U,BLOCK_COLOR_FRONT:xt,BLOCK_COLOR_BACK:Yt,ACTIVE_COLOR_FRONT:V,GHOST_COLOR_FILL:w,GHOST_COLOR_STROKE:st,GHOST_STROKE_WIDTH:ce,MAGIC_DIM_DOT_ALPHA:Vt,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:Ct,getState:Tt,funcs:Ot}=e,r=a;function rt(v,T,x){let M=1-x/i;return v+M*T}function Pt(v){return v=v%u,v<0?v+u:v}function wt(v,T,x,M,b,O){let _=Pt(O),E=(b-_)/u*Xt+g;return{x:v+Math.cos(E)*x,y:T+Math.sin(E)*M,ang:E}}let bt=.52,Bt=1.02;function ht(v,T,x,M,b,O){let _=Pt(O),E=(b-_)/u*Xt+g;return{x:v+Math.cos(E)*x,y:T+Math.sin(E)*M,ang:E}}function ee(v,T,x,M,b,O,_,E=1){let I=ht(v,T,x,M,b-bt,O),ct=ht(v,T,x,M,b+bt,O),F={x:I.x,y:I.y-_*.5},N={x:I.x,y:I.y+_*.5},At={x:ct.x,y:ct.y-_*.5},ot={x:ct.x,y:ct.y+_*.5},S=(F.x+At.x+ot.x+N.x)*.25,lt=(F.y+At.y+ot.y+N.y)*.25,A=Bt*E,tt=E,Mt=[F,At,ot,N].map(Lt=>({x:S+(Lt.x-S)*A,y:lt+(Lt.y-lt)*tt})),Z=Math.abs((ct.x-I.x)*A),q=Math.abs(_*tt);return{corners:Mt,cx:S,cy:lt,wApprox:Z,hApprox:q,ang:ht(v,T,x,M,b,O).ang}}function Gt(v,T,x,M,b,O,_,E,I=1,ct=null,F=1,N=null,At=0,ot=1,S=1){let lt=ee(v,T,x,M,b,O,_,S),[A,tt,Mt,Z]=lt.corners;if(r.save(),r.globalAlpha=I,r.fillStyle=E,r.beginPath(),r.moveTo(A.x,A.y),r.lineTo(tt.x,tt.y),r.lineTo(Mt.x,Mt.y),r.lineTo(Z.x,Z.y),r.closePath(),r.fill(),N&&At>0&&(r.strokeStyle=N,r.lineWidth=At,r.stroke()),ct){let q=Math.min(lt.wApprox,lt.hApprox)*.28*ot;r.globalAlpha=I*F,r.fillStyle=ct,r.beginPath(),r.arc(lt.cx,lt.cy,q,0,Xt),r.fill()}r.restore(),r.globalAlpha=1}function ue(v,T,x,M,b,O){let _=wt(v,T,x,M,b,O),E=wt(v,T,x,M,b+1,O),I=wt(v,T,x,M,b-1,O),ct=Math.abs(E.x-_.x),F=Math.abs(_.x-I.x),N=(ct+F)*.5*1.06;return Math.max(1,N)}function Re(v,T,x,M,b,O){let _=(b-O)/u*Xt+g;return{x:v+Math.cos(_)*x,y:T+Math.sin(_)*M,ang:_}}function Ve(v,T,x,M,b,O,_,E=1,I=null,ct=1,F=null,N=0,At=1){r.save(),r.translate(v,T);let ot=Math.atan2(M,x);if(r.rotate(ot),r.globalAlpha=E,r.fillStyle=_,r.fillRect(-b/2,-O/2,b,O),F&&N>0&&(r.strokeStyle=F,r.lineWidth=N,r.strokeRect(-b/2,-O/2,b,O)),I){let S=Math.min(b,O)*.28*At;r.globalAlpha=E*ct,r.fillStyle=I,r.beginPath(),r.arc(0,0,S,0,Xt),r.fill()}r.restore(),r.globalAlpha=1}return{resize(){let v=Math.max(1,Math.min(2,window.devicePixelRatio||1)),T=Math.floor(o.clientWidth*v),x=Math.floor(o.clientHeight*v);(o.width!==T||o.height!==x)&&(o.width=T,o.height=x,r.setTransform(v,0,0,v,0,0))},render(){this.resize();let v=Tt(),T=o.clientWidth,x=o.clientHeight;r.clearRect(0,0,T,x),r.fillStyle="#0b0f14",r.fillRect(0,0,T,x);let M=T*.5,b=n,O=x-s,_=Math.max(1,O-b),E=Math.min(T*m,c),I=E*.28,{killLevel:ct,rotFloat:F,grid:N,gameState:At}=v,ot=rt(b,_,ct),S=.7,lt=ct/i,A=28,tt=72,Mt=120;if(lt>S){let y=(lt-S)/(1-S);A=Math.round(28+152*y),tt=Math.round(72+-32*y),Mt=Math.round(120+-70*y)}let Z=M-E-8,q=M+E+8,Lt=b,gt=O+5,yt=`rgba(${A},${tt},${Mt},0.45)`;r.fillStyle=yt;let ne=E+8,se=I+4;r.fillRect(0,ot,Z,x-ot),r.fillRect(q,ot,T-q,x-ot),r.beginPath();let oe=Math.max(ot,gt);r.moveTo(Z,oe),ot<=gt+se?r.ellipse(M,gt,ne,se,0,Math.PI,0,!1):r.lineTo(q,oe),r.lineTo(q,x),r.lineTo(Z,x),r.closePath(),r.fill(),r.strokeStyle="rgba(100,180,255,0.6)",r.lineWidth=3,r.lineCap="round",r.beginPath(),r.moveTo(Z,Lt),r.lineTo(Z,gt),r.stroke(),r.beginPath(),r.moveTo(q,Lt),r.lineTo(q,gt),r.stroke(),r.beginPath(),r.ellipse(M,gt,E+8,I+4,0,0,Math.PI),r.stroke(),r.fillStyle="#0b0f14",r.beginPath(),r.ellipse(M,gt,E+8,I+4,0,0,Xt),r.fill(),ct>.5&&(r.strokeStyle=`rgba(${Math.min(255,A+60)},${Math.min(255,tt+40)},${Math.min(255,Mt+40)},0.6)`,r.lineWidth=2,r.beginPath(),r.moveTo(0,ot),r.lineTo(Z,ot),r.moveTo(q,ot),r.lineTo(T,ot),r.stroke()),r.strokeStyle="rgba(160,190,220,0.3)",r.lineWidth=1;let de=Xt*E,C=10,Wt=de/C*.7,Et=de/C*.3;r.setLineDash([Wt,Et]);let kt=de/u;r.lineDashOffset=Pt(F)*kt;for(let y=0;y<=i;y++){let k=rt(b,_,y);r.beginPath(),r.ellipse(M,k,E,I,0,0,Xt),r.stroke()}r.setLineDash([]);let fe=[],Kt=[];for(let y=0;y<i;y++){let k=rt(b,_,y+.5);for(let X=0;X<u;X++){let B=N[y][X];if(!B)continue;let $=wt(M,k,E,I,X,F),J=Math.sin($.ang),D={y,s:X,yScr:k,p:$,depth:J,color:B};J<-.1?fe.push(D):Kt.push(D)}}let le=Ot.getMagicTargetColor(),{isHighlighting:ae,highlightedCells:vt,highlightStartTime:G,isMagicAnimation:me}=v,$t=null,ut=1,ge=1,Se=!1;if(ae&&vt.length>0){$t=new Set(vt.map(k=>`${k.y},${k.s}`));let y=(performance.now()-G)/1e3;if(me){let k=Math.min(1,y/K);ut=1-k*.85,ge=1-k*.9,Se=!0}else{let k=Math.min(1,y/f),X=1-h;if(k>X){let B=(k-X)/h;ut=1-B*.85,ge=1-B*.9,Se=!0}}}fe.sort((y,k)=>y.depth-k.depth);for(let y of fe){let k=_/i*.9,X=R[y.color]||null,B=.35,$=1,J=`${y.y},${y.s}`;$t&&$t.has(J)&&(B*=ge,$=ut),Gt(M,y.yScr,E,I,y.s,F,k,Yt,B,X,.5,null,0,1,$)}let{isRingAnimation:Jt}=v;if(ae&&vt.length>0&&!me){let y=(performance.now()-G)/1e3,X=Math.min(1,y/(Jt?P:f)),B=1-h,$=X>B,J=$?(X-B)/h:0,D=Jt?Math.floor(X*B*u*2)%u:-1,L=4+X/B*10,at=Math.sin(y*L*Xt),Ft=$?1:.3+at*.3,dt=$?1-J*.8:1,St=$?1-J:1;for(let W of vt){let Rt=rt(b,_,W.y+.5),It=ht(M,Rt,E,I,W.s,F);if(Math.sin(It.ang)>=-.1)continue;let Qt=_/i*.9,it,ft,pt;if(Jt){let qt=(W.s-D+u)%u,ie=qt<3?1-qt/3:0;it=($?St:.2+ie*.5)*.5,ft=`rgba(255, 159, 67, ${it})`,pt=$?dt:1+ie*.15}else it=Ft*St,ft=W.isLine?`rgba(255, 255, 255, ${it*.5})`:`rgba(255, 220, 100, ${it*.4})`,pt=$?dt:1.1;Gt(M,Rt,E,I,W.s,F,Qt,ft,1,null,1,null,0,1,pt)}}Kt.sort((y,k)=>y.depth-k.depth);for(let y of Kt){let k=_/i*.9,X=R[y.color]||null,B=1,$=1,J=1,D=1,L=`${y.y},${y.s}`,at=$t&&$t.has(L);at&&(B=ge,$=ut),le!==null&&!at&&(y.color!==le?(J=Vt,D=Zt):D=Ct),Gt(M,y.yScr,E,I,y.s,F,k,xt,B,X,J,null,0,D,$)}if(ae&&vt.length>0&&!me){let y=(performance.now()-G)/1e3,X=Math.min(1,y/(Jt?P:f)),B=1-h,$=X>B,J=$?(X-B)/h:0,D=Jt?Math.floor(X*B*u*2)%u:-1,L=4+X/B*10,at=Math.sin(y*L*Xt),Ft=$?1:.5+at*.5,dt=$?1-J*.8:1,St=$?1-J:1;for(let W of vt){let Rt=rt(b,_,W.y+.5),It=ht(M,Rt,E,I,W.s,F);if(Math.sin(It.ang)<-.1)continue;let Qt=_/i*.9,it,ft,pt;if(Jt){let qt=(W.s-D+u)%u,ie=qt<4?1-qt/4:0;it=$?St:.3+ie*.7,ft=`rgba(255, 159, 67, ${it})`,pt=$?dt:1+ie*.2}else it=Ft*St,ft=W.isLine?`rgba(255, 255, 255, ${it*.7})`:`rgba(255, 220, 100, ${it*.6})`,pt=$?dt:1.15;Gt(M,Rt,E,I,W.s,F,Qt,ft,1,null,1,null,0,1,pt)}}let{activePiece:Ht,pieceY:We,isGrounded:Ie,lockTimer:xe}=v;if(Ht){let y=Ot.snappedRot(),k=y,X=Ot.computeGhostY(),B=_/i*.9;if(X!==null){let D=[];for(let L=0;L<Ht.cells.length;L++){let at=Ht.cells[L],Ft=Ht.colors[L],dt=X+at.y,St=Ot.normSector(y+at.x);if(dt<0||dt>=i)continue;let W=rt(b,_,dt+.5),Rt=ht(M,W,E,I,St,k);D.push({cy:dt,cs:St,yScr:W,depth:Math.sin(Rt.ang),color:Ft})}D.sort((L,at)=>L.depth-at.depth);for(let L of D){let at=R[L.color]||null;Gt(M,L.yScr,E,I,L.cs,k,B,w,1,at,.5,st,ce,1,1)}}let $=V;if(Ie&&xe>0){let D=Math.min(1,xe/z),L=255,at=Math.round(170+85*D),Ft=Math.round(180+75*D),dt=.75+(1-.75)*D;$=`rgba(${L},${at},${Ft},${dt})`}let J=[];for(let D=0;D<Ht.cells.length;D++){let L=Ht.cells[D],at=Ht.colors[D],Ft=Ot.normSector(y+L.x),dt=We+L.y;if(dt<0||dt>=i)continue;let St=rt(b,_,dt+.5),W=ht(M,St,E,I,Ft,k);J.push({cs:Ft,yScr:St,depth:Math.sin(W.ang),color:at})}J.sort((D,L)=>D.depth-L.depth);for(let D of J){let L=R[D.color]||null;Gt(M,D.yScr,E,I,D.cs,k,B,$,1,L,1,null,0,1,1)}}},drawNextPreview(v,T){if(!v)return;let x=v.getContext("2d"),M=v.width,b=v.height;if(x.clearRect(0,0,M,b),!T)return;let O=1/0,_=-1/0,E=1/0,I=-1/0;for(let S of T.cells)O=Math.min(O,S.x),_=Math.max(_,S.x),E=Math.min(E,S.y),I=Math.max(I,S.y);let ct=_-O+1,F=I-E+1,N=Math.min(M/(ct+.5),b/(F+.5)),At=(M-ct*N)/2,ot=(b-F*N)/2;x.fillStyle=xt;for(let S=0;S<T.cells.length;S++){let lt=T.cells[S],A=At+(lt.x-O)*N,tt=ot+(F-1-(lt.y-E))*N;x.fillRect(A+1,tt+1,N-2,N-2);let Mt=T.colors[S],Z=R[Mt];if(Z){let q=(N-2)*.32;x.fillStyle=Z,x.beginPath(),x.arc(A+N/2,tt+N/2,q,0,Xt),x.fill(),x.fillStyle=xt}}}}}(()=>{let e=Sn(),o=e.canvas,a=o.getContext("2d");o.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,n=24,s=Math.PI/2,c=18,m=90,g=260,f=.36,h="rgb(235,240,250)",K="rgb(55,62,75)",P="rgba(255,170,180,0.75)",z="rgba(110,255,150,0.15)",R="rgba(110,255,150,0.85)",U=2,xt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Yt={1:"fire",2:"water",3:"lightning",4:"earth"},V={fire:1,water:2,lightning:3,earth:4},w=1,st=.58,ce=!0,Vt=12,Zt=25,Ct=120,Tt=n/Ct,Ot=1,r=2,rt=3,Pt=5,wt=8,bt=10,Bt=15,ht=30,ee=2,Gt=.3,ue=.5,Re=1,Ve=.3,v=.5,T=1.3,x=10,M=500,b=[1,1.25,1.5,1.75,2],O=10,_=100,E=25,I=[1,1.3,1.6,2],ct=[1,1.5,2,2.5],F=En(),N=F.loadGameSettings(),At=N.invertSwipe?-1:1,ot=-1,S=Array.from({length:n},()=>new Uint8Array(i)),lt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],A=null,tt=n+3,Mt=0,Z=0,q=!1,Lt=0,gt=0,yt=0,ne=0,se=0,oe=Cn({canvas:o,rotDir:At}),de="0.12.1",C=pn();C.preload();let Wt=Tn(),Et="intro",kt=0,fe=0,Kt=0,le=0,ae=0,vt=null,G=Wt.stats,me=e.overlay,$t=vn({elementColors:xt}),ut=$t.showBonus.bind($t),ge=$t.getElementIcon.bind($t),Se=e.overlayTitle,Jt=e.overlayStats,Ht=e.startBtn,We=e.hud,Ie=e.scoreHud,xe=e.timeHud,y=e.nextCanvas,k=y.getContext("2d"),X=e.settingsBtn,B=e.settingsOverlay,$=e.settingsClose,J=e.fullscreenBtn,D=e.rotateBtn,L=_n({buttons:e.magicBtns,onActivate:()=>C.play("spells")}),at=e.magicBtns,Ft=L.charges,dt=t=>L.select(t),St=()=>L.updateButtons(),W=[],Rt=0,It=!1,jt=!1,Qt=!1,it=0,ft=0,pt=0,qt=[];function ie(t,l,d){let p=1-d/n;return t+p*l}function Ke(t,l,d,p,Y,j){let mt=(Y-j)/i*u+s;return{x:t+Math.cos(mt)*d,y:l+Math.sin(mt)*p,ang:mt}}function kn(t,l){let d=o.clientWidth,p=o.clientHeight,Y=d*.5,j=c,mt=p-m,Nt=Math.max(1,mt-j),Dt=Math.min(d*f,g),he=Dt*.28,re=ie(j,Nt,t+.5),Q=Ke(Y,re,Dt,he,l,yt);return{x:Q.x,y:Q.y}}function $n(t,l){if(!L.canUse()||It)return!1;let d=V[L.active],p=o.clientWidth,Y=o.clientHeight,j=p*.5,mt=c,Nt=Y-m,Dt=Math.max(1,Nt-mt),he=Math.min(p*f,g),re=he*.28,Q=null,nt=1/0;for(let H=0;H<n;H++){let _t=ie(mt,Dt,H+.5);for(let Ut=0;Ut<i;Ut++){let zt=S[H][Ut];if(!zt||zt!==d)continue;let te=Ke(j,_t,he,re,Ut,yt);if(Math.sin(te.ang)<-.1)continue;let ye=t-te.x,un=l-te.y,dn=Math.hypot(ye,un),fn=Dt/n*.9,us=fn*1.2;Math.abs(ye)<us/2&&Math.abs(un)<fn/2&&dn<nt&&(nt=dn,Q={y:H,s:Ut})}}if(Q){let H=S[Q.y][Q.s];return W=[{y:Q.y,s:Q.s,color:H,isLine:!1,isMagic:!0}],Rt=performance.now(),It=!0,jt=!0,it=0,ft=E,ut(`+${E}`,"score"),pt=0,L.useCharge(),G.magicUsed++,!0}return!1}let Ss=100;function xs(t,l){return Xe(t,l,n,i)}function Hn(){return Rn(S,n,i)}let Fn=In;function Nn(t){let l=t.map(p=>({...p,color:S[p.y][p.s]}));for(let p of t)S[p.y][p.s]=0;let d=n;for(let p of t){let Y=p.y;for(let j=1;j<=p.y;j++){let mt=p.y-j;if(S[mt][p.s]){Y=j-1;break}}d=Math.min(d,Y)}for(let p of l)S[p.y-d][p.s]=p.color;return d>0}function Un(){let t=!0;for(;t;){t=!1;let l=Hn();for(let d of l)Fn(d)||Nn(d)&&(t=!0)}}function Xn(){Pe()}let Oe=bn;function qe(t,l){let d=new Map,p=0,Y=0,j=0,mt={},Nt=t.length+l.length;for(let nt of t){let H=Yt[nt.color],_t=0,Ut=0;if(nt.length>=5?(_t=rt,Ut=bt,G.lines5++):nt.length===4?(_t=r,Ut=wt,G.lines4++):nt.length===3&&(_t=Ot,Ut=Pt,G.lines3++),H&&_t>0){L.addCharges(H,_t),mt[H]=(mt[H]||0)+_t;let zt=nt.cells[Math.floor(nt.cells.length/2)],te=kn(zt.y,zt.s),rn=at[H];for(let ye=0;ye<_t;ye++)setTimeout(()=>{$t.spawnMagicOrb(H,te.x,te.y,rn)},ye*100)}p+=Ut*Tt,j+=Ut,Y+=nt.length*O;for(let zt of nt.cells){let te=`${zt.y},${zt.s}`;d.has(te)||d.set(te,{y:zt.y,s:zt.s,color:nt.color,isLine:!0})}}for(let nt of l){G.pairs++,p+=Bt*Tt,j+=Bt,Y+=_;for(let H of nt.cells){let _t=`${H.y},${H.s}`;d.has(_t)||d.set(_t,{y:H.y,s:H.s,color:S[H.y][H.s],isLine:!1})}}let Dt=Oe(I,Nt-1),he=Oe(ct,pt),re=Math.round(Y*Dt*he),Q=0;Nt>1&&(G.combos++,G.maxCombo=Math.max(G.maxCombo,Nt),setTimeout(()=>ut(`COMBO \xD7${Nt}`,"combo"),Q),Q+=180,C.play("combo2")),pt>0&&(G.cascades++,G.maxCascade=Math.max(G.maxCascade,pt),setTimeout(()=>ut(`CASCADE \xD7${pt}`,"cascade"),Q),Q+=180,C.play("cascade")),(t.length>0||l.length>0)&&C.play("combo");for(let nt of t){let H=nt.length,_t=H*O;setTimeout(()=>ut(`Line-${H} +${_t}`,"line",nt.color),Q),Q+=100}for(let nt of l){let H=nt.cells.length>0?S[nt.cells[0].y][nt.cells[0].s]:null;setTimeout(()=>ut(`Pair +${_}`,"pair",H),Q),Q+=100}re>0&&(setTimeout(()=>ut(`+${re}`,"score"),Q),Q+=120),j>0&&(setTimeout(()=>ut(`+${j}s`,"time"),Q),Q+=120);for(let[nt,H]of Object.entries(mt))H>0&&(setTimeout(()=>ut(`+${H}${ge(nt)}`,"charge"),Q),Q+=120);W=Array.from(d.values()),Rt=performance.now(),It=!0,jt=!1,it=p,ft=re,St()}function Yn(){for(let t of W)S[t.y][t.s]=0;W.length>0&&C.playRandom("disappear"),it>0&&(gt=Math.max(0,gt-it)),Wt.addScore(ft),kt+=ft,Ce(),W=[],It=!1,jt=!1,it=0,ft=0,pt++,Pe()}function Pe(){Un();let{lineMatches:t,pairMatches:l}=ts();if(t.length>0||l.length>0)qe(t,l);else{let d=Qe();d.length>0?Jn(d):!A&&Et==="playing"&&je()}}function Ms(t,l){qe(t,l)}function we(t){return Ee(t,i)}function Me(){return we(Math.round(yt))}function ze(t,l){return Ye(A,t,l,S,n,i)}function ve(t){return ze(t,Me())}let _e=Ln;function Ze(){ce&&(Vt!==0&&Lt>=Vt||(Z=0,Lt+=1))}function Vn(){if(!A)return;let t=A.cells,l=A.colors,d={cells:t,colors:l};if(ot>=0||(d=_e(d.cells,d.colors),d=_e(d.cells,d.colors)),d=_e(d.cells,d.colors),A.cells=d.cells,A.colors=d.colors,!ve(Math.floor(tt))){A.cells=t,A.colors=l;return}C.play("turn"),q&&Ze()}function Wn(){return On(A,tt,Me(),S,n,i)}function Kn(){if(!A)return!1;let t=Math.floor(tt)-1,l=!ve(t);return l&&!q?(q=!0,Z=0,Lt=0):!l&&q&&(q=!1,Z=0,Lt=0),l}let De=An;function Be(){if(Et==="playing"){me.classList.add("hidden");return}if(me.classList.remove("hidden"),Et==="intro"){Se.innerHTML='<span class="title-elemental">Elemental</span> <span class="title-blocks">Blocks</span>';let t=Math.floor(Ct/60),l=Ct%60,d=F.loadHighscore(),p=d.score>0?`<div class="intro-highscore">\u{1F3C6} Best: ${d.score.toLocaleString()} <small>(${De(d.time)})</small></div>`:"";Jt.innerHTML=`
        ${p}
        <div class="intro-survival">\u23F1 Survive: ${t}:${l.toString().padStart(2,"0")}</div>
        <div class="intro-box">
          <div class="intro-box-title">Combos</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+30 <small>+1\u2726</small></span>
              <span class="rule-time">+${Pt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">+40 <small>+2\u2726</small></span>
              <span class="rule-time">+${wt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">+50 <small>+3\u2726</small></span>
              <span class="rule-time">+${bt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">+100</span>
              <span class="rule-time">+${Bt}s</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">+500</span>
              <span class="rule-time">+${ht}s</span>
            </div>
          </div>
        </div>
        <div class="intro-version">v${de}</div>
      `,Ht.textContent="Start"}else{Se.textContent="Game Over";let t=`
        <div class="go-score">${kt.toLocaleString()}</div>
        <div class="go-time">\u23F1 ${De(Kt)}</div>
        <div class="intro-box" style="margin-top:12px">
          <div class="intro-box-title">Matches</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots"><i class="dot r"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Line-3</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.lines3}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i><i class="dot b"></i></span>
              <span class="rule-text">Line-4</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.lines4}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i><i class="dot y"></i></span>
              <span class="rule-text">Line-5</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.lines5}</span>
            </div>
            <div class="rule-row">
              <span class="dots"><i class="dot g"></i><i class="dot g"></i><i class="dot r"></i><i class="dot r"></i></span>
              <span class="rule-text">Pair</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.pairs}</span>
            </div>
            <div class="rule-row">
              <span class="dots ring">\u25EF</span>
              <span class="rule-text">Ring</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.rings}</span>
            </div>
          </div>
        </div>
        <div class="intro-box" style="margin-top:8px">
          <div class="intro-box-title">Bonuses</div>
          <div class="intro-rules">
            <div class="rule-row">
              <span class="dots" style="color:#ffd84d;font-size:14px;font-weight:700">COMBO</span>
              <span class="rule-text">\xD7${G.combos}</span>
              <span class="rule-time" style="color:#ffd84d">${G.maxCombo>0?"max \xD7"+G.maxCombo:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#ff6b9d;font-size:14px;font-weight:700">CASCADE</span>
              <span class="rule-text">\xD7${G.cascades}</span>
              <span class="rule-time" style="color:#ff6b9d">${G.maxCascade>0?"max \xD7"+G.maxCascade:""}</span>
            </div>
            <div class="rule-row">
              <span class="dots" style="color:#cfe0f3;font-size:14px">\u2726</span>
              <span class="rule-text">Magic</span>
              <span class="rule-time" style="color:#cfe0f3">\xD7${G.magicUsed}</span>
            </div>
          </div>
        </div>
        <div class="go-version">v${de}</div>
      `;Jt.innerHTML=t,Ht.textContent="Play again"}}function Ce(){Ie.textContent=`Score: ${kt}`}function Ge(){xe.textContent=`Time: ${De(Kt)}`}function qn(){for(let t=0;t<n;t++)S[t].fill(0);gt=0,yt=ne=0,se=0,Wt.start(),kt=0,fe=performance.now(),Kt=0,ae=0,le=0,Et="playing",vt=null,L.reset(),W=[],qt=[],It=!1,jt=!1,Qt=!1,it=0,ft=0,pt=0,St(),Ce(),Ge(),je(),Fe.drawNextPreview(y,vt),Be(),C.getSettings().musicEnabled&&C.startGameMusic()}function ke(){Wt.gameOver(),Et="gameover",A=null,q=!1,Z=0,Lt=0;let t=F.saveHighscore(kt,Kt);C.stopMusic(),C.play("gameover"),setTimeout(()=>{(Et==="gameover"||Et==="intro")&&C.startMenuMusic()},2500),Ge(),Be(),t&&kt>0&&setTimeout(()=>{ut("\u{1F3C6} NEW RECORD!","score")},500)}function zn(t){for(let d=0;d<50;d++){let p=t.map(()=>1+(Math.random()*4|0));if(!Zn(t,p))return p}return t.map((d,p)=>1+p%4)}let Zn=Dn;function Je(t){let l=t.cells.map(p=>({x:p.x,y:p.y})),d=zn(l);return{name:t.name,cells:l,colors:d}}function je(){if(!vt){let Y=lt[Math.random()*lt.length|0];vt=Je(Y)}A=vt;let t=lt[Math.random()*lt.length|0];vt=Je(t),Fe.drawNextPreview(y,vt);let l=1/0,d=-1/0;for(let Y of A.cells)Y.x<l&&(l=Y.x),Y.x>d&&(d=Y.x);let p=(l+d)/2;for(let Y of A.cells)Y.x=Y.x-Math.round(p);tt=n+3,Mt=0,q=!1,Z=0,Lt=0,ve(Math.floor(tt))?C.playRandom("appear"):ke()}function Qe(){return wn(S,n,i)}function Jn(t){if(t.length===0)return;let l=[];for(let Nt of t)for(let Dt=0;Dt<i;Dt++)l.push({y:Nt,s:Dt,color:S[Nt][Dt],isLine:!1});qt=t,W=l,Rt=performance.now(),It=!0,Qt=!0,jt=!1;let d=t.length;G.rings+=d;let p=Oe(b,d-1),Y=Math.round(M*d*p),j=ht*d;ft=Y,it=j*Tt,C.play("ring");let mt=`RING \xD7${d}`;ut(mt,"ring"),setTimeout(()=>ut(`+${Y}`,"score"),150),setTimeout(()=>ut(`+${j}s`,"time"),300)}function jn(){let t=[...qt].sort((l,d)=>d-l);for(let l of t){for(let d=l;d<n-1;d++)S[d].set(S[d+1]);S[n-1].fill(0)}it>0&&(gt=Math.max(0,gt-it)),Wt.addScore(ft),kt+=ft,Ce(),W=[],qt=[],It=!1,Qt=!1,it=0,ft=0,Pe()}function vs(){return Qe().length}function Qn(){if(!A)return;let t=Me();yt=t,ne=t,se=0;let l=!1;for(let d=0;d<A.cells.length;d++){let p=A.cells[d],Y=A.colors[d],j=Math.floor(tt)+p.y,mt=we(t+p.x);j>=n&&(l=!0),j>=0&&j<n&&(S[j][mt]=Y)}if(l){ke();return}Wt.addScore(x),kt+=x,Ce(),ut(`+${x}`,"score"),C.playRandom("drop"),A=null,pt=0,Xn()}function ts(){return Pn(S,n,i)}function es(){if(!A)return!1;let t=Math.floor(tt)-1;return ve(t)?(tt=t,q=!1,Z=0,Lt=0,!0):(q=!0,!1)}o.addEventListener("pointerdown",t=>{if(et.state!=="playing")return;t.preventDefault?.(),oe.handlePointerDown(t,{onMagicTap:(d,p)=>et.applyCommand("magic_shoot",{x:d,y:p}),onDoubleTap:()=>et.applyCommand("rotate_piece")},ne)||(se=0)},{passive:!1}),o.addEventListener("pointermove",t=>{if(et.state!=="playing"||!oe.dragging)return;t.preventDefault?.();let l=oe.handlePointerMove(t,{canRotateTo:(d,p)=>et.canRotateTo(d,p),onDrop:()=>et.applyCommand("move_down"),onGroundedMove:()=>et.onGroundedMove()},et.pieceY,et.isGrounded);l&&et.setRotation(l.targetRot)},{passive:!1}),o.addEventListener("pointerup",t=>{et.state==="playing"&&oe.handlePointerUp(t)},{passive:!1}),D.addEventListener("click",()=>{et.state==="playing"&&et.applyCommand("rotate_piece")});let Te=e.dropBtn,be=null;function ns(){et.state==="playing"&&(et.applyCommand("move_down"),be=setInterval(()=>{if(et.state!=="playing"){Ae();return}et.applyCommand("move_down")},Zt))}function Ae(){be&&(clearInterval(be),be=null)}Te.addEventListener("pointerdown",t=>{t.preventDefault(),ns()}),Te.addEventListener("pointerup",Ae),Te.addEventListener("pointerleave",Ae),Te.addEventListener("pointercancel",Ae);for(let[t,l]of Object.entries(at))l.addEventListener("click",()=>{et.state==="playing"&&et.applyCommand("select_magic",{element:t})});let $e=e.soundsToggle,He=e.musicToggle;function pe(){let t=C.getSettings();t.soundsEnabled?$e.classList.add("active"):$e.classList.remove("active"),t.musicEnabled?He.classList.add("active"):He.classList.remove("active");for(let l=0;l<=4;l++){let d=e.soundVolBtns[l],p=e.musicVolBtns[l];d&&d.classList.toggle("active",t.soundVolume===l),p&&p.classList.toggle("active",t.musicVolume===l)}}let tn=e.tabBtns,ss=e.tabContents;tn.forEach(t=>{t.addEventListener("click",()=>{let l=t.dataset.tab;tn.forEach(d=>d.classList.remove("active")),ss.forEach(d=>d.classList.remove("active")),t.classList.add("active"),xn(l).classList.add("active"),l==="sounds"&&pe()})});let en=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,nn=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,os=e.iosHint,is=e.standaloneBadge;function sn(){let t=document.fullscreenElement||document.webkitFullscreenElement;J.textContent=t?"Disable":"Enable"}en&&(nn?(is.style.display="block",J.style.display="none"):(os.style.display="block",J.textContent="Not supported",J.style.opacity="0.5",J.style.cursor="default")),J.addEventListener("click",()=>{if(en&&!nn)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let l=document.documentElement;l.requestFullscreen?l.requestFullscreen():l.webkitRequestFullscreen&&l.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",sn),document.addEventListener("webkitfullscreenchange",sn);let Le=e.invertSwipeToggle;N.invertSwipe&&Le.classList.add("active"),Le.addEventListener("click",()=>{Le.classList.toggle("active");let t=Le.classList.contains("active");oe.rotDir=t?-1:1,N.invertSwipe=t,F.saveGameSettings(N)});let on=e.diffBtns;on.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(on.forEach(l=>{l.classList.remove("active");let d=l.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let l=document.createElement("span");l.className="check-icon",l.textContent="\u2713",t.appendChild(l)}})}),$e.addEventListener("click",()=>{let l=!C.getSettings().soundsEnabled;C.updateSettings({soundsEnabled:l}),pe()}),He.addEventListener("click",()=>{let l=!C.getSettings().musicEnabled;C.updateSettings({musicEnabled:l}),pe(),l?et.state==="playing"?C.startGameMusic():C.startMenuMusic():l||C.stopMusic()});for(let t=0;t<=4;t++){let l=e.soundVolBtns[t];l&&l.addEventListener("click",()=>{C.updateSettings({soundVolume:t}),pe(),C.play("turn")})}for(let t=0;t<=4;t++){let l=e.musicVolBtns[t];l&&l.addEventListener("click",()=>{C.updateSettings({musicVolume:t}),pe()})}pe();function cs(){Et==="playing"&&(Wt.pause(),le=performance.now(),Et="paused",C.musicAudio&&C.musicAudio.pause())}function cn(){Et==="paused"&&(Wt.resume(),ae+=performance.now()-le,le=0,Et="playing",Ne=performance.now(),C.getSettings().musicEnabled&&C.startGameMusic())}X.addEventListener("click",()=>{cs(),B.classList.remove("hidden")}),$.addEventListener("click",()=>{B.classList.add("hidden"),cn()}),B.addEventListener("click",t=>{t.target===B&&(B.classList.add("hidden"),cn())});let et=Bn({N:i,H:n,FALL_INTERVAL:w,LOCK_DELAY_SEC:st,KILL_RATE:Tt,MATCH_HIGHLIGHT_SEC:ee,MAGIC_SHRINK_SEC:ue,RING_HIGHLIGHT_SEC:Re,getState:()=>({gameState:Et,score:kt,elapsedMs:Kt,startTime:fe,totalPausedMs:ae,stats:G,activePiece:A,pieceY:tt,targetRot:ne,rotFloat:yt,rotVel:se,isGrounded:q,isHighlighting:It,isMagicAnimation:jt,isRingAnimation:Qt,highlightStartTime:Rt,killLevel:gt,grid:S,fallTimer:Mt,lockTimer:Z}),setState:t=>{"elapsedMs"in t&&(Kt=t.elapsedMs),"killLevel"in t&&(gt=t.killLevel),"fallTimer"in t&&(Mt=t.fallTimer),"lockTimer"in t&&(Z=t.lockTimer),"targetRot"in t&&(ne=t.targetRot),"rotFloat"in t&&(yt=t.rotFloat),"rotVel"in t&&(se=t.rotVel)},funcs:{startGame:qn,endGame:ke,rotatePieceByDir:Vn,tryMoveDown:es,canPlaceAtRot:ze,maybeResetLockDelay:Ze,shootMagic:$n,selectMagic:dt,updateGroundedState:Kn,lockPiece:Qn,finishHighlight:Yn,finishRingHighlight:jn},ui:{updateTimeHud:Ge}}),Fe=Gn({canvas:o,canvasCtx:a,N:i,H:n,TOP_PAD_PX:c,BOTTOM_PAD_PX:m,MAX_RADIUS_X:g,RADIUS_X_FACTOR:f,ANG_OFFSET:s,MATCH_HIGHLIGHT_SEC:ee,MATCH_SHRINK_PHASE:Gt,MAGIC_SHRINK_SEC:ue,RING_HIGHLIGHT_SEC:Re,LOCK_DELAY_SEC:st,ELEMENT_COLORS:xt,ELEMENT_TO_COLOR:V,BLOCK_COLOR_FRONT:h,BLOCK_COLOR_BACK:K,ACTIVE_COLOR_FRONT:P,GHOST_COLOR_FILL:z,GHOST_COLOR_STROKE:R,GHOST_STROKE_WIDTH:U,MAGIC_DIM_DOT_ALPHA:Ve,MAGIC_DIM_DOT_SCALE:v,MAGIC_TARGET_DOT_SCALE:T,LOCK_DELAY_SEC:st,getState:()=>({gameState:Et,grid:S,activePiece:A,pieceY:tt,rotFloat:yt,killLevel:gt,isHighlighting:It,highlightedCells:W,highlightStartTime:Rt,isMagicAnimation:jt,isRingAnimation:Qt,isGrounded:q,lockTimer:Z}),funcs:{snappedRot:Me,computeGhostY:Wn,normSector:we,getMagicTargetColor:()=>L.canUse()?V[L.active]:null}}),Ne=performance.now();function ln(t){let l=Math.min(.05,Math.max(.001,(t-Ne)/1e3));Ne=t,et.update(l,t),yt=ne,yt>1e6&&(yt%=i),yt<-1e6&&(yt%=i),Fe.render(),requestAnimationFrame(ln)}Ht.addEventListener("click",()=>{et.applyCommand("start_game")}),St(),Be(),C.startMenuMusic();let ls=()=>{if(C.unlock(),!C.getSettings().musicEnabled)return;let t=C.musicAudio;!t||t.paused||t.ended?et.state==="playing"?C.startGameMusic():C.startMenuMusic():t.play().catch(l=>{console.debug("Music resume on interaction failed:",l)})},an=0,as=10,rs=()=>{an>=as||(an++,ls())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,rs,{passive:!0})}),requestAnimationFrame(ln)})();})();
