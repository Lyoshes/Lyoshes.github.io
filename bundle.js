(()=>{var zi=[0,.25,.5,.75,1],ji=[0,.05,.15,.25,.5],Qi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Bo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Io="soundSettings";function Zi(){try{let e=localStorage.getItem(Io);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ji(e){try{localStorage.setItem(Io,JSON.stringify(e))}catch(s){console.debug("Failed to save sound settings:",s)}}function Ao(){return{audioContext:null,buffers:{},settings:Zi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let s=window.AudioContext||window.webkitAudioContext;this.audioContext=new s,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(s){console.debug("Failed to create AudioContext:",s)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(s){console.debug("Failed to resume AudioContext:",s)}if(!this.unlocked&&this.audioContext.state==="running"){let s=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=s,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return zi[this.settings.soundVolume]},getMusicVolume(){return ji[this.settings.musicVolume]},async loadSound(s,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let a=await(await fetch(r)).arrayBuffer(),n=await this.audioContext.decodeAudioData(a);this.buffers[s]=n}catch(f){console.debug(`Failed to load sound: ${s} from ${r}`,f)}},preload(){this.initContext();for(let[s,r]of Object.entries(Qi))this.loadSound(s,r)},play(s,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let f=s;r!==null&&(f=`${s}${r}`);let a=this.buffers[f];if(a)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=a,c.connect(n),c.start(0),c.onended=()=>{c.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(s){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(s,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Bo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let s=this.musicAudio.play();s!==void 0&&s.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(s){console.debug("Menu music start failed:",s)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Bo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let s=this.musicAudio.play();s!==void 0&&s.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(s){console.debug("Game music start failed:",s)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(s){console.debug("Stop music failed:",s)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(s){if(this.settings={...this.settings,...s},Ji(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var wo="eb_highscore",Po="eb_highscore_quick",ko="eb_settings",Oo="eb_high_tower_rings",ta={invertSwipe:!1,hapticsEnabled:!0,showControls:!0,tapRotate:!1};function Do(){return{loadHighscore(e="30_24"){try{let s=e==="25_20"?Po:wo,r=localStorage.getItem(s);if(r)return JSON.parse(r)}catch(s){console.debug("Failed to load highscore:",s)}return{score:0,time:0}},saveHighscore(e,s,r="30_24"){try{let f=this.loadHighscore(r);if(e>f.score||e===f.score&&s>f.time){let a=r==="25_20"?Po:wo;return localStorage.setItem(a,JSON.stringify({score:e,time:s})),!0}}catch(f){console.debug("Failed to save highscore:",f)}return!1},loadGameSettings(){try{let e=localStorage.getItem(ko);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ta}},saveGameSettings(e){try{localStorage.setItem(ko,JSON.stringify(e))}catch(s){console.debug("Failed to save game settings:",s)}},loadHighTowerRings(){try{let e=localStorage.getItem(Oo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Oo,String(e))}catch(s){console.debug("Failed to save High Tower rings:",s)}},addHighTowerRings(e){let r=this.loadHighTowerRings()+e;return this.saveHighTowerRings(r),r}}}function No(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),controlsRight:document.querySelector(".controls-right"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),showControlsToggle:document.getElementById("showControlsToggle"),tapRotateToggle:document.getElementById("tapRotateToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Ho(e){return document.getElementById("tab-"+e)}var ea={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Fo(e={}){let{elementColors:s={}}=e,r=0,f=new Set(["combo","cascade"]);function a(n,c,g){return Math.max(c,Math.min(g,n))}return{showBonus(n,c="score",g=null){let p=document.createElement("div");p.className=`bonus-popup ${c}`,p.textContent=n,g&&s[g]&&(p.style.color=s[g]),document.body.appendChild(p);let u=p.getBoundingClientRect(),l=12,m=window.innerWidth/2,T=window.innerHeight/2-40,O,$;if(f.has(c)){let wt=c==="cascade"?34:0;O=m-u.width/2,$=T-u.height/2+wt}else{let wt=60+r%4*22,ne=Math.random()*Math.PI*2,Kt=(Math.random()-.5)*28,_t=(Math.random()-.5)*24,Xt=m+Math.cos(ne)*wt+Kt,at=T+Math.sin(ne)*wt*.75+_t;O=Xt-u.width/2,$=at-u.height/2}let Q=Math.max(l,window.innerWidth-u.width-l),vt=Math.max(l,window.innerHeight-u.height-l);p.style.left=`${a(O,l,Q)}px`,p.style.top=`${a($,l,vt)}px`,p.style.transform="none",r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{p.remove()},1800)},getElementIcon(n){return ea[n]||"\u2726"}}}var Xs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function $o(){return{spawnMagicOrb(e,s,r,f){if(!f)return;let a=document.createElement("div");a.className=`magic-orb ${e}`,a.textContent=Xs[e]||"\u2726";let n=f.getBoundingClientRect(),c=n.left+n.width/2-s,g=n.top+n.height/2-r,p=Math.hypot(c,g),u=Math.atan2(g,c),l=p*.35*(Math.random()>.5?1:-1),m=u+Math.PI/2,T=c*.5+Math.cos(m)*l,O=g*.5+Math.sin(m)*l;a.style.setProperty("--mid-x",`${T}px`),a.style.setProperty("--mid-y",`${O}px`),a.style.setProperty("--end-x",`${c}px`),a.style.setProperty("--end-y",`${g}px`),a.style.left=`${s}px`,a.style.top=`${r}px`,document.body.appendChild(a),setTimeout(()=>{a.remove()},700)},spawnMagicShot(e,s,r,f,a){if(!s){a&&a();return}let n=s.getBoundingClientRect(),c=n.left+n.width/2,g=n.top+n.height/2,p=document.createElement("div");p.className=`magic-shot ${e}`,p.textContent=Xs[e]||"\u2726";let u=r-c,l=f-g;p.style.setProperty("--end-x",`${u}px`),p.style.setProperty("--end-y",`${l}px`),p.style.left=`${c}px`,p.style.top=`${g}px`,document.body.appendChild(p);let m=setInterval(()=>{let T=p.getBoundingClientRect();this.spawnTrailParticle(e,T.left+T.width/2,T.top+T.height/2)},40);setTimeout(()=>{clearInterval(m),p.remove(),this.spawnExplosion(e,r,f),a&&a()},300)},spawnTrailParticle(e,s,r){let f=document.createElement("div");f.className=`magic-trail ${e}`,f.style.left=`${s}px`,f.style.top=`${r}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),400)},spawnExplosion(e,s,r){for(let a=0;a<12;a++){let n=document.createElement("div");n.className=`magic-explosion ${e}`;let c=a/12*Math.PI*2+(Math.random()-.5)*.5,g=40+Math.random()*40,p=Math.cos(c)*g,u=Math.sin(c)*g;n.style.setProperty("--px",`${p}px`),n.style.setProperty("--py",`${u}px`),n.style.left=`${s}px`,n.style.top=`${r}px`,document.body.appendChild(n),setTimeout(()=>n.remove(),500)}},spawnSpellBubbles(e,s="water",r=18){if(!e)return;let f=s;typeof s=="number"&&(r=s,f="water"),Xs[f]||(f="water");let a=e.getBoundingClientRect(),n=a.left+a.width/2,c=a.top+a.height/2,g=Math.max(8,Math.round(r));for(let p=0;p<g;p++){let u=document.createElement("div");u.className=`spell-bubble ${f}`,u.textContent="\u25CF";let l=p/g*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,T=Math.cos(l)*m,O=Math.sin(l)*m-20;u.style.setProperty("--px",`${T}px`),u.style.setProperty("--py",`${O}px`),u.style.left=`${n}px`,u.style.top=`${c}px`,u.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),800)}},spawnSpellOrb(e,s,r){if(!r)return;let f=document.createElement("div");f.className="spell-orb",f.textContent="\u2727";let a=r.getBoundingClientRect(),n=a.left+a.width/2-e,c=a.top+a.height/2-s,g=Math.hypot(n,c),p=Math.atan2(c,n),u=g*.35*(Math.random()>.5?1:-1),l=p+Math.PI/2,m=n*.5+Math.cos(l)*u,T=c*.5+Math.sin(l)*u;f.style.setProperty("--mid-x",`${m}px`),f.style.setProperty("--mid-y",`${T}px`),f.style.setProperty("--end-x",`${n}px`),f.style.setProperty("--end-y",`${c}px`),f.style.left=`${e}px`,f.style.top=`${s}px`,document.body.appendChild(f),setTimeout(()=>{f.remove()},700)}}}var na=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Go=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,sa=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function oa(e){let s=e.querySelector(".ring"),r=e.querySelector(".falling-figure"),f=e.querySelector(".clock");if(!s||!r||!f)return()=>{};let a=!1,n=[],c=[],g=(V,K)=>{let U=setTimeout(()=>{a||V()},K);return n.push(U),U},p=(V,K)=>{let U=setInterval(()=>{if(a){clearInterval(U);return}V()},K);return c.push(U),U},u=48,l=.9,m=9,T=9,O=3,$=2,Q=18,vt=-12,wt=.5,ne=12,Kt=10,_t=["--fire","--water","--light","--earth"],Xt=["--light","--fire","--water"],at=3,Z=Math.floor(m/2)-1,Bt=8e3,Gt=[];function kt(V,K){let U=(K-1)/2,Y=Math.abs(V-U)/U;return 1-(1-wt)*Y}function I(V,K,U,Y){let Yt=(K-1)/2,D=Math.abs(V-Yt)/Yt;return Y?D*U:-D*U}function Ot(){s.innerHTML="";let V=[],K=[];for(let lt=0;lt<T;lt++)K.push(u*l*kt(lt,T));let U=K.reduce((lt,Ht)=>lt+Ht,0)+(T-1)*$,Y=[];for(let lt=0;lt<m;lt++)Y.push(u*kt(lt,m));let Yt=Y.reduce((lt,Ht)=>lt+Ht,0)+(m-1)*O,D=-U/2;for(let lt=0;lt<T;lt++){let Ht=K[lt],Qt=u*l,ae=m+lt,bt=I(lt,T,Kt,!0),se=document.createElement("div");se.className="block back",se.style.cssText=`left:${D.toFixed(1)}px;top:${(vt-Qt/2+bt).toFixed(1)}px;width:${Ht.toFixed(1)}px;height:${Qt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let pt=document.createElement("div");pt.className="dot";let ee=l*kt(lt,T);pt.style.cssText=`--c:var(${_t[ae%4]});transform:scale(${ee.toFixed(2)});`,se.appendChild(pt),se.dataset.index=ae,s.appendChild(se),V[ae]=se,D+=Ht+$}let jt=-Yt/2;for(let lt=0;lt<m;lt++){let Ht=Y[lt],Qt=u,ae=lt,bt=I(lt,m,ne,!1),se=ae>=Z&&ae<Z+at,pt=document.createElement("div");pt.className="block",se&&pt.classList.add("gap"),pt.style.cssText=`left:${jt.toFixed(1)}px;top:${(Q-Qt/2+bt).toFixed(1)}px;width:${Ht.toFixed(1)}px;height:${Qt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let ee=document.createElement("div");ee.className="dot";let Ce=kt(lt,m);ee.style.cssText=`--c:var(${_t[ae%4]});transform:scale(${Ce.toFixed(2)});`,pt.appendChild(ee),pt.dataset.index=ae,s.appendChild(pt),V[ae]=pt,jt+=Ht+O}Gt=V}function zt(){let V=[];for(let K=Z-1;K>=0;K--)V.push(K);for(let K=0;K<T;K++)V.push(m+K);for(let K=m-1;K>=Z;K--)V.push(K);return V}function Pt(){Gt.forEach((V,K)=>{V&&(V.classList.remove("hi","vanish","gap"),V.style.opacity="",V.style.transform="",K>=Z&&K<Z+at&&V.classList.add("gap"))})}function i(){for(let V=0;V<at;V++){let K=Gt[Z+V];if(K){K.classList.remove("gap");let U=K.querySelector(".dot");if(U){let Y=kt(Z+V,m);U.style.cssText=`--c:var(${Xt[V]});transform:scale(${Y.toFixed(2)});`}}}}function it(V){let K=zt(),U=0,Y=K.length,Yt=p(()=>{if(U>0&&U<=Y){let D=Gt[K[U-1]];D&&D.classList.remove("hi")}if(U<Y){let D=Gt[K[U]];D&&D.classList.add("hi"),U++}else clearInterval(Yt),Gt.forEach(D=>{D&&D.classList.add("hi")}),g(V,300)},30)}function st(V){let K=zt(),U=K.length;K.forEach((Y,Yt)=>{let D=Gt[Y];D&&g(()=>{D.classList.add("vanish")},Yt*40)}),g(V,U*40+500)}function ie(){a||(Pt(),r.classList.add("active"),g(()=>{i(),r.classList.remove("active"),r.style.opacity="0",g(()=>{it(()=>{a||(f.classList.add("show"),g(()=>{st(()=>{a||(f.classList.remove("show"),r.style.opacity="",g(ie,500))})},400))})},200)},Bt*.38))}return Ot(),ie(),()=>{a=!0,n.forEach(clearTimeout),c.forEach(clearInterval)}}var ia=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:na},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Go},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:sa,onEnter:e=>oa(e)}];function Uo(e={}){let{helpBtn:s,mount:r=document.body,combosTemplate:f}=e;if(!s||!r)return{open(){},close(){},setCombosTemplate(){}};let a=ia.map(I=>({...I}));typeof f=="string"&&f.trim()&&(a[1].illustrationHtml=f);let n=document.createElement("div");n.className="overlay hidden help-modal",n.id="helpOverlay",n.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,r.appendChild(n);let c=n.querySelector(".help-next-btn"),g=n.querySelector(".help-slide-title"),p=n.querySelector(".help-slide-text"),u=n.querySelector(".help-illustration"),l=n.querySelector(".help-dots"),m=a.map(()=>{let I=document.createElement("span");return I.className="help-dot",l.appendChild(I),I}),T=0,O=!1,$=null,Q=null,vt=180,wt=560,ne=460,Kt=480,_t=I=>{Q&&(Q(),Q=null);let Ot=a[I];Ot&&(T=I,g.textContent=Ot.title,p.textContent=Ot.text,u.innerHTML=Ot.illustrationHtml||"",m.forEach((zt,Pt)=>{zt.classList.toggle("active",Pt===I)}),c.textContent=I===a.length-1?"Done":"Next",Xt(),Ot.onEnter&&(Q=Ot.onEnter(u)))},Xt=()=>{if(!O||n.classList.contains("hidden"))return;let I=u.getBoundingClientRect();if(!I.width||!I.height)return;let Ot=u.querySelector(".help-combos");if(Ot){let i=Math.min(1,Math.min(I.width,I.height)/wt);Ot.style.setProperty("--help-combos-scale",i.toFixed(3))}let zt=u.querySelector(".help-controls");if(zt){let i=Math.min(1,Math.min(I.width,I.height)/ne);zt.style.setProperty("--help-controls-scale",i.toFixed(3))}let Pt=u.querySelector(".help-rings");if(Pt){let i=Math.min(1,Math.min(I.width,I.height)/Kt);Pt.style.setProperty("--help-rings-scale",i.toFixed(3))}},at=()=>{O&&Xt()},Z=I=>{O&&I.stopPropagation()},Bt=I=>{if(O){if(I.key==="Escape"){I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation?.(),kt();return}I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation?.()}},Gt=()=>{O||(O=!0,$&&(clearTimeout($),$=null),_t(0),n.classList.remove("hidden"),requestAnimationFrame(()=>{n.classList.add("is-visible"),Xt()}),document.addEventListener("keydown",Bt,!0),window.addEventListener("resize",at))},kt=()=>{O&&(O=!1,Q&&(Q(),Q=null),n.classList.remove("is-visible"),document.removeEventListener("keydown",Bt,!0),window.removeEventListener("resize",at),$=window.setTimeout(()=>{n.classList.add("hidden")},vt))};return n.addEventListener("click",I=>{O&&(I.target===n&&kt(),I.stopPropagation())}),n.addEventListener("pointerdown",Z),n.addEventListener("pointerup",Z),n.addEventListener("touchstart",Z,{passive:!0}),n.addEventListener("touchmove",I=>{O&&(I.preventDefault(),I.stopPropagation())},{passive:!1}),n.addEventListener("wheel",I=>{O&&(I.preventDefault(),I.stopPropagation())},{passive:!1}),c.addEventListener("click",I=>{I.stopPropagation(),T<a.length-1?_t(T+1):kt()}),s.addEventListener("click",I=>{I.preventDefault(),Gt()}),{open:Gt,close:kt,setCombosTemplate(I){typeof I=="string"&&(a[1].illustrationHtml=I.trim()||Go,O&&T===1&&_t(1))}}}var aa={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function ca(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Ys=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(s){if(!this.supports())return!1;let r=Array.isArray(s.pattern)?s.pattern:Number.isFinite(s.durationMs)?[s.durationMs]:null;return r?(navigator.vibrate(r),!0):!1}},Ws=class{constructor(s){this.bridge=s}supports(){return!0}trigger(s){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:s.name,strength:s.strength,durationMs:s.durationMs,pattern:s.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(s.name,s.strength,s.durationMs,s.pattern),!0}catch{}return!1}};function Xo({enabled:e=!0,patterns:s=aa}={}){let r=ca(),f=r?new Ws(r):new Ys,a=f.supports(),n=!!e&&a;return{supports:()=>a,isEnabled:()=>n,setEnabled(c){n=!!c&&a},trigger(c){if(!n)return!1;let g=s[c];return g?f.trigger({name:c,...g}):!1}}}function Yo(e={}){let{buttons:s={},onActivate:r=null,onChange:f=null}=e,a={fire:3,water:3,lightning:3,earth:3},n=null;function c(){for(let[p,u]of Object.entries(s)){if(!u)continue;let l=a[p],m=u.querySelector(".charges");m&&(m.textContent=l),u.classList.toggle("empty",l<=0),u.classList.toggle("active",n===p&&l>0)}f&&f({...a},n)}function g(p){let u=s[p];u&&(u.classList.remove("pulse"),u.offsetWidth,u.classList.add("pulse"),setTimeout(()=>u.classList.remove("pulse"),400))}return{get charges(){return a},get active(){return n},set active(p){n=p},select(p){if(a[p]<=0)return!1;let u=n===p;return n=u?null:p,c(),!u&&n===p&&r&&r(),!u},useCharge(){if(!n||a[n]<=0)return!1;let p=n;return a[p]--,n=null,c(),g(p),!0},addCharges(p,u){a[p]!==void 0&&(a[p]+=u,c(),g(p))},canUse(){return n!==null&&a[n]>0},deactivate(){n=null,c()},reset(){a.fire=3,a.water=3,a.lightning=3,a.earth=3,n=null,c()},updateButtons:c,initButtons(p){for(let[u,l]of Object.entries(s))l&&l.addEventListener("click",()=>{p&&p(u)})}}}var Je={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function Wo(e={}){let{button:s=null,onActivate:r=null,onProgress:f=null,onReady:a=null}=e,n="ice",c=0;function g(){return Je[n]||Je.ice}function p({silent:l=!1}={}){if(!s||!s.classList.contains("spell-btn"))return;let m=g(),T=Number.isFinite(m.maxProgress)?m.maxProgress:0,O=T>0?Math.min(c/T,1)*100:0,$=T>0&&c>=T;s.style.setProperty("--progress",`${O}%`);let Q=s.querySelector(".spell-icon");Q&&(Q.textContent=m.icon);let vt=s.querySelector(".spell-counter");vt&&(vt.textContent=T>0?`${Math.min(c,T)}/${T}`:""),s.classList.toggle("ready",$),s.classList.toggle("charging",!$&&c>0),f&&!l&&T>0&&f(c,T)}function u(){s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))}return{get currentSpell(){return n},get progress(){return c},get maxProgress(){return g().maxProgress??0},get isReady(){let l=g().maxProgress;return Number.isFinite(l)&&l>0&&c>=l},get effect(){return g().effect},getUnlockRings(l){return(Je[l]||Je.ice).unlockRings??0},getCost(l){return(Je[l]||Je.ice).cost??0},getDescription(l){return(Je[l]||Je.ice).description||""},getEffect(l){return(Je[l]||Je.ice).effect},get button(){return s},selectSpell(l){Je[l]&&(n=l,c=0,p())},addProgress(l=1){let m=g();if(!Number.isFinite(m.maxProgress)||m.maxProgress<=0||c>=m.maxProgress)return!1;let T=c<m.maxProgress;return c=Math.min(c+l,m.maxProgress),p(),u(),T&&c>=m.maxProgress&&a&&a(),!0},setProgress(l,{silent:m=!1}={}){c=Math.max(0,l),p({silent:m})},canUse(){let l=g().maxProgress;return Number.isFinite(l)&&l>0&&c>=l},use(){if(!this.canUse())return null;let l=g().effect;return c=0,p(),u(),r&&r(n),l},reset(){c=0,p()},pulse(){u()},updateButton:p,initButton(l){s&&s.addEventListener("click",()=>{l&&l()})}}}function Vs({centerY:e,centerS:s,size:r,H:f,normSector:a}){let n=[],c=Math.floor(r/2);for(let g=-c;g<=c;g++)for(let p=-c;p<=c;p++){let u=e+g,l=a(s+p);if(u<0||u>=f)continue;let m=g*g+p*p;n.push({y:u,s:l,distSq:m})}return n}function Ts(e,s,r){return s.filter(f=>e[f.y][f.s]===r)}function xs(e,s){return[...e].sort((f,a)=>f.distSq!==a.distSq?f.distSq-a.distSq:f.y!==a.y?f.y-a.y:f.s-a.s).slice(0,s).map(f=>({y:f.y,s:f.s}))}function Vo({centerY:e,centerS:s,beamLength:r,N:f,H:a,normSector:n}){if(e<0||e>=a||r<0||f<=0)return[];let c=[],g=new Set,p=(l,m)=>`${l},${m}`,u=n(s);c.push({y:e,s:u,dist:0}),g.add(p(e,u));for(let l=1;l<=r;l++){let m=n(s+l),T=p(e,m);g.has(T)||(c.push({y:e,s:m,dist:l}),g.add(T));let O=n(s-l),$=p(e,O);g.has($)||(c.push({y:e,s:O,dist:l}),g.add($))}for(let l=1;l<=r;l++){let m=n(s),T=e+l;if(T<a){let $=p(T,m);g.has($)||(c.push({y:T,s:m,dist:l}),g.add($))}let O=e-l;if(O>=0){let $=p(O,m);g.has($)||(c.push({y:O,s:m,dist:l}),g.add($))}}return c}function qo(e){let{canvas:s,dom:r,getGrid:f,getN:a,getH:n,getRotFloat:c,constants:g,helpers:p,Spell:u,Magic:l,SoundModule:m,State:T,isGamePlaying:O,addPendingKzDrop:$,getKillRate:Q,triggerSpellWave:vt,spawnSpellBubbles:wt,spawnBonusBubbles:ne,getTransmuteEffect:Kt,getLightningEffect:_t,getFireEffect:Xt,continueMatchProcessing:at,updateScoreHud:Z,showBonus:Bt,getSpellCost:Gt,getSpellElement:kt,onUltimateApplied:I,isSpellBlocked:Ot,setScore:zt,setCascadeLevel:Pt}=e,{TOP_PAD_PX:i,BOTTOM_PAD_PX:it,SIDE_MARGIN_PX:st,MAX_RADIUS_X:ie,SCORE_MAGIC_DESTROY:V}=g,{normSector:K,levelYToScreenY:U,sectorCenterXY:Y}=p,Yt=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],D="idle",jt=null,lt=null,Ht=[],Qt=[],ae=0,bt=null,se=0,pt="idle",ee=null,Ce=[],Tt=[],Re=0,Ft=0,Jt="idle",qe=null,Ke=[],mt=[],xt=0;function ze(S){if(typeof Gt!="function"||typeof kt!="function")return!1;let L=kt(S),M=Gt(S);return!L||!M?!1:(l.charges[L]??0)>=M}function tn(S){if(typeof Gt!="function"||typeof kt!="function")return!1;let L=kt(S),M=Gt(S);return!L||!M||(l.charges[L]??0)<M?!1:(l.charges[L]-=M,l.updateButtons(),u.pulse(),!0)}let en=0,Zn=350;function _e(){return typeof Ot=="function"?Ot():!1}function Dt(){let S=performance.now();S-en<Zn||(en=S,m.play("cancel"))}function ln(){D="selecting_source",jt=null,lt=null,Ht=[],Qt=[],pt!=="idle"&&j(),Jt!=="idle"&&b(),l.deactivate(),m.play("ulta");let S=r.spellBtn;S&&S.classList.add("selecting")}function yt(){D!=="idle"&&m.play("cancel"),D="idle",jt=null,lt=null,Ht=[],Qt=[],x();let S=r.spellBtn;S&&S.classList.remove("selecting")}function Hn(S,L){if(D!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return yt(),!0;let gt=f();jt={y:M.y,s:M.s,color:gt[M.y][M.s]},Ht=Vs({centerY:M.y,centerS:M.s,size:Kt().areaSize,H:n(),normSector:K});let ht=jt.color,Rt=Ts(gt,Ht,ht);return Qt=xs(Rt,Kt().maxBlocks),h(jt.color,M.y),D="selecting_target",!0}function E(S,L){let M=s.clientWidth,gt=s.clientHeight,ht=M*.5,Rt=(M-2*st)/2,oe=gt-i-it,le=6,De=n(),nn=a(),xn=c(),Qe=nn*oe/(le*De),Se=gt-it,de,ue,Le;Qe<=Math.min(Rt,ie)?(de=Qe,ue=oe,Le=i):(de=Math.min(Rt,ie),ue=de*le*De/nn,Le=Se-ue);let Cn=de*.28,Sn=null,sn=1/0,Ne=f();for(let fe=0;fe<De;fe++){let Ze=U(Le,ue,fe+.5);for(let ge=0;ge<nn;ge++){if(!Ne[fe][ge])continue;let Ge=Y(ht,Ze,de,Cn,ge,xn);if(Math.sin(Ge.ang)<-.1)continue;let Ee=S-Ge.x,on=L-Ge.y,pe=Math.hypot(Ee,on),Be=ue/De*.9,Ue=Be*1.2;Math.abs(Ee)<Ue/2&&Math.abs(on)<Be/2&&pe<sn&&(sn=pe,Sn={y:fe,s:ge})}}return Sn}function h(S,L){x();let M=document.createElement("div");M.className="transmute-popup";let gt=s.clientWidth,ht=s.clientHeight,Rt=(gt-2*st)/2,oe=ht-i-it,le=6,De=n(),nn=a(),xn=nn*oe/(le*De),Qe=ht-it,Se,de;xn<=Math.min(Rt,ie)?(Se=oe,de=i):(Se=Math.min(Rt,ie)*le*De/nn,de=Qe-Se);let ue=U(de,Se,L+.5),Le=Math.floor(Kt().areaSize/2),Cn=U(de,Se,Math.min(De,L+Le)+.5),Sn=U(de,Se,Math.max(0,L-Le)+.5),sn=de+Se/2,Ne=document.getElementById("gameContainer"),fe=Ne?Ne.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},Ze=160,ge=60,Ge=20,En=fe.left+fe.width/2-Ze/2,Ee;ue<sn?Ee=fe.top+Sn+Ge:Ee=fe.top+Cn-ge-Ge,Ee=Math.max(10,Math.min(window.innerHeight-ge-10,Ee)),M.style.left=`${En}px`,M.style.top=`${Ee}px`,Yt.filter(pe=>pe.color!==S).forEach(pe=>{let Be=document.createElement("button");Be.className=`transmute-btn ${pe.name}`,Be.innerHTML=pe.icon,Be.setAttribute("data-color",pe.color),Be.addEventListener("click",Ue=>{Ue.stopPropagation(),B(pe.color)}),M.appendChild(Be)}),document.body.appendChild(M),bt=M,se=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",y)},50)}function y(S){performance.now()-se<200||bt&&!bt.contains(S.target)&&yt()}function x(){document.removeEventListener("pointerdown",y),bt&&(bt.remove(),bt=null)}function B(S){if(_e()){Dt();return}if(!ze(u.currentSpell)){Dt();return}if(x(),lt=S,Qt.length===0){yt();return}w()}function w(){if(!jt){yt();return}if(Qt.length===0){yt();return}if(!tn(u.currentSpell)){Dt(),yt();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),D="animating",ae=performance.now(),m.play("esseffect")}function G(){if(D!=="selecting_target"&&D!=="animating"||!jt||!Ht||Ht.length===0)return;let S=f(),L=S[jt.y]?.[jt.s]??0;if(!L||L!==jt.color){yt();return}let M=Ts(S,Ht,L),gt=Kt().maxBlocks??M.length;Qt=xs(M,gt),Qt.length===0&&yt()}function X(S){if(D!=="animating")return!1;let L=(S-ae)/1e3;return Math.min(L/Kt().animSec,1)>=1?(St(),!1):!0}function R(S){if(D!=="animating")return null;let L=(S-ae)/1e3,M=Math.min(L/Kt().animSec,1),gt="flash",ht=0,Rt=0;return M<.15?(gt="flash",Rt=1-M/.15):M<.55?(gt="shrink",ht=(M-.15)/.4):(gt="grow",ht=(M-.55)/.45),{phase:gt,progress:ht,areaFlash:Rt}}function St(){let S=f();for(let L of Qt)S[L.y][L.s]=lt;D="idle",jt=null,lt=null,Ht=[],Qt=[],Pt(1),at(),typeof I=="function"&&I("earth")}function z(){m.play("ulta"),pt="selecting_source",ee=null,Ce=[],Tt=[],Ft=0,D!=="idle"&&(D="idle",jt=null,lt=null,Ht=[],Qt=[],x()),Jt!=="idle"&&(Jt="idle",qe=null,Ke=[],mt=[],xt=0),l.deactivate();let S=r.spellBtn;S&&S.classList.add("selecting")}function j(){pt!=="idle"&&m.play("cancel"),pt="idle",ee=null,Ce=[],Tt=[],Ft=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function ft(){Jt="selecting_source",qe=null,Ke=[],mt=[],xt=0,D!=="idle"&&(D="idle",jt=null,lt=null,Ht=[],Qt=[],x()),pt!=="idle"&&(pt="idle",ee=null,Ce=[],Tt=[],Ft=0),l.deactivate(),m.play("ulta");let S=r.spellBtn;S&&S.classList.add("selecting")}function b(){Jt!=="idle"&&m.play("cancel"),Jt="idle",qe=null,Ke=[],mt=[],xt=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function N(S,L){if(pt!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return j(),!0;let gt=f();ee={y:M.y,s:M.s,color:gt[M.y][M.s]},Ce=Vs({centerY:M.y,centerS:M.s,size:_t().areaSize,H:n(),normSector:K});let ht=ee.color,Rt=Ts(gt,Ce,ht);return Tt=xs(Rt,_t().maxBlocks),Tt.length===0?(j(),!0):ze(u.currentSpell)?(ce(),!0):(Dt(),!0)}function ot(S,L){if(Jt!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return b(),!0;let gt=f();return qe={y:M.y,s:M.s,color:gt[M.y][M.s]},Ke=Vo({centerY:M.y,centerS:M.s,beamLength:Xt().beamLength,N:a(),H:n(),normSector:K}),mt=Ke.filter(ht=>gt[ht.y][ht.s]).sort((ht,Rt)=>ht.dist-Rt.dist),mt.length===0?(b(),!0):ze(u.currentSpell)?($t(),!0):(Dt(),!0)}function ce(){if(!ee||Tt.length===0){j();return}if(!tn(u.currentSpell)){Dt(),j();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),pt="animating",Re=performance.now(),Ft=0,m.play("asseffect")}function v(S){if(pt!=="animating")return!1;let L=S-Re,M=_t().flashMs+Tt.length*_t().jumpMs;return L>=M?(P(),!1):!0}function At(S){if(pt!=="animating")return null;let L=S-Re;if(L<_t().flashMs)return{phase:"flash",flashProgress:1-L/_t().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let M=L-_t().flashMs,gt=Math.floor(M/_t().jumpMs),ht=M%_t().jumpMs/_t().jumpMs,Rt=[];for(let oe=0;oe<Math.min(gt,Tt.length);oe++)Rt.push(oe);return{phase:"chain",flashProgress:0,currentTarget:Math.min(gt,Tt.length-1),jumpProgress:ht,struckTargets:Rt}}function P(){let S=f(),L=Tt.length,M=L*V;T.addScore(M),zt(T.score),Z(),Bt(`+${M}`,"score");for(let oe of Tt)S[oe.y][oe.s]=0;let gt=_t(),ht=Math.abs(gt.kzDropSecPerBlock??0),Rt=L*ht;Rt>0&&typeof $=="function"&&typeof Q=="function"&&($(Rt*Q()),Bt(`\u26A1 -${Rt}s`,"time")),pt="idle",ee=null,Ce=[],Tt=[],Ft=0,Pt(1),at(),typeof I=="function"&&I("air")}function $t(){if(!qe||mt.length===0){b();return}if(!tn(u.currentSpell)){Dt(),b();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),Jt="animating",xt=performance.now(),m.play("fsseffect")}function $e(S){return Jt!=="animating"?!1:(S-xt)/1e3>=Xt().animSec?(je(),!1):!0}function ye(S){if(Jt!=="animating")return null;let L=Xt(),M=Math.max(.001,L.animSec),gt=(S-xt)/1e3,ht=Math.min(gt/M,1),Rt=.25,oe=ht<Rt?1-ht/Rt:0,le=.6,De=ht<le?ht/le*L.beamLength:L.beamLength;return{progress:ht,flashProgress:oe,beamLength:L.beamLength,beamReach:De}}function je(){let S=f(),L=mt.length;if(L>0){let M=L*V;T.addScore(M),zt(T.score),Z(),Bt(`+${M}`,"score")}for(let M of mt)S[M.y][M.s]=0;Jt="idle",qe=null,Ke=[],mt=[],xt=0,Pt(1),at(),typeof I=="function"&&I("fire")}function dn(){let S=typeof O=="function"?O():T.isPlaying(),L=u.currentSpell;if(!S)return!1;if(L==="ice"){if(_e()||!ze(L)||!tn(u.currentSpell))return Dt(),!1;let M=u.effect;return typeof $=="function"&&typeof Q=="function"&&$(M.duration*Q()),m.play("wsseffect"),Bt(`\u{1F4A7} -${M.duration}s`,"time"),typeof vt=="function"&&vt(),typeof ne=="function"&&ne(M.duration),typeof I=="function"&&I(L),!0}return L==="earth"?D==="selecting_source"||D==="selecting_target"?(yt(),!0):D!=="idle"||_e()||!ze(L)?(Dt(),!1):(D==="idle"&&ln(),!0):L==="air"?pt==="selecting_source"?(j(),!0):pt!=="idle"||_e()||!ze(L)?(Dt(),!1):(pt==="idle"&&z(),!0):L==="fire"?Jt==="selecting_source"?(b(),!0):Jt!=="idle"||_e()||!ze(L)?(Dt(),!1):(Jt==="idle"&&ft(),!0):!1}function re(S){G(),X(S),v(S),$e(S)}function J(S,L){return _e()&&(D==="selecting_source"||pt==="selecting_source"||Jt==="selecting_source")?(Dt(),!0):D==="selecting_source"?Hn(S,L):pt==="selecting_source"?N(S,L):Jt==="selecting_source"?ot(S,L):!1}function te(){D="idle",jt=null,lt=null,Ht=[],Qt=[],x(),pt="idle",ee=null,Ce=[],Tt=[],Ft=0,Jt="idle",qe=null,Ke=[],mt=[],xt=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function Tn(){return{transmuteState:D,transmuteSourceBlock:jt,transmuteTargetColor:lt,transmuteAreaCells:Ht,transmuteBlocksToChange:Qt,lightningState:pt,lightningSourceBlock:ee,lightningAreaCells:Ce,lightningBlocksToHit:Tt,fireState:Jt,fireSourceBlock:qe,fireLineCells:Ke,fireTargets:mt}}return{startTransmuteSourceSelection:ln,cancelTransmutation:yt,startLightningSourceSelection:z,cancelLightning:j,startFireSourceSelection:ft,cancelFire:b,handleTap:J,update:re,reset:te,getRenderState:Tn,getTransmuteAnimState:R,getLightningAnimState:At,getFireAnimState:ye,handleSpellButtonClick:dn,isTransmuteSelecting:()=>D==="selecting_source",isLightningSelecting:()=>pt==="selecting_source"}}var ra={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Ko(e={}){let{canvas:s}=e,r=e.rotDir||1,f=!1,a=0,n=0,c=0,g=0,p=0,u=1,l=null,m=0,T=0,O=0,$=0,Q=0,vt=0,wt=0,ne=0,Kt=!1,_t=!1,Xt=!1,at=ra;return{get tapRotateEnabled(){return Kt},set tapRotateEnabled(Z){Kt=Z},get rotDir(){return r},set rotDir(Z){r=Z},get dragging(){return f},get dragMode(){return l},handlePointerDown(Z,Bt,Gt){if(Bt.onMagicTap&&Bt.onMagicTap(Z.clientX,Z.clientY))return _t=!0,!0;_t=!1,Xt=!1;let kt=performance.now(),I=kt-vt,Ot=Z.clientX-wt,zt=Z.clientY-ne,Pt=Math.hypot(Ot,zt);return I<=at.DOUBLE_TAP_MS&&Pt<=at.DOUBLE_TAP_MAX_DIST?(Bt.onDoubleTap&&Bt.onDoubleTap(),Xt=!0,vt=0):(vt=kt,wt=Z.clientX,ne=Z.clientY),f=!0,u=-1,a=Z.clientX,n=Z.clientY,c=Gt,g=0,p=0,l=null,m=kt,T=Z.clientX,O=Z.clientY,$=m,Q=0,s&&s.setPointerCapture(Z.pointerId),!1},handlePointerMove(Z,Bt,Gt,kt){if(!f)return null;let I=Z.clientX-a,Ot=Z.clientY-n,zt=performance.now();if(Math.abs(I)<at.DEADZONE_PX&&Math.abs(Ot)<at.DEADZONE_PX)return null;if(l){if(l==="rotate"){let i=Math.abs(I),it=Math.abs(Ot);if(it>=i*at.AXIS_DOMINANCE&&it>=at.DROP_SWIPE_MIN_DISTANCE){let st=Math.max(1,zt-m);it/st*1e3>=at.DROP_SWIPE_MIN_SPEED&&(l="drop",p=0)}}}else{let i=Math.abs(I),it=Math.abs(Ot);if(Ot<0)i>=at.DEADZONE_PX&&(l="rotate");else if(it>=i*at.AXIS_DOMINANCE){if(it>=at.DROP_SWIPE_MIN_DISTANCE){let st=Math.max(1,zt-m);it/st*1e3>=at.DROP_SWIPE_MIN_SPEED?l="drop":l="rotate"}}else i>=it*at.AXIS_DOMINANCE&&(l="rotate");if(!l)return null}let Pt=null;if(l==="rotate"&&Math.abs(I)>=at.DEADZONE_PX){let i=Math.max(1,zt-$),it=Z.clientX-T,st=Math.max(1,Math.abs(it)/i*1e3),ie=Math.max(at.MIN_ROT_PX,Math.min(at.MAX_ROT_PX,at.PX_PER_STEP*(at.SWIPE_SPEED_REF/st)));Q+=-it/ie*r*u;let V=Math.trunc(Q);V!==0&&(Q-=V);let K=g+V;if(K!==g&&Bt.canRotateTo){let U=Math.sign(K-g),Y=c+g;for(;g!==K;){let Yt=g+U,D=c+Yt;if(!Bt.canRotateTo(Math.floor(Gt),D))break;g=Yt,Y=D,Bt.onRotateStep&&Bt.onRotateStep(),kt&&Bt.onGroundedMove&&Bt.onGroundedMove()}Pt={targetRot:Y,rotFloat:Y}}}if(l==="drop"&&Ot>=at.DROP_SWIPE_MIN_DISTANCE&&Bt.onDrop){let i=Math.max(1,zt-$),it=Z.clientY-O,st=Math.max(1,it/i*1e3),ie=Math.max(at.MIN_DROP_PX,Math.min(at.MAX_DROP_PX,at.PX_PER_DROP*(at.SWIPE_SPEED_REF/st))),V=Math.trunc(Ot/ie);if(V>p){let K=V-p;for(let U=0;U<K;U++)Bt.onDrop();p=V}}return T=Z.clientX,O=Z.clientY,$=zt,Pt},handlePointerUp(Z,Bt){if(f){if(Kt&&!_t&&!Xt&&!l&&Bt?.onSingleTap){let Gt=Math.abs(Z.clientX-a),kt=Math.abs(Z.clientY-n),I=performance.now()-m;Gt<at.DEADZONE_PX&&kt<at.DEADZONE_PX&&I<300&&Bt.onSingleTap()}if(f=!1,l=null,s&&Z&&Z.pointerId!==void 0)try{s.releasePointerCapture(Z.pointerId)}catch{}}},reset(){f=!1,l=null,g=0,p=0,Q=0}}}var qs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function zo(){let e="intro",s=0,r=0,f=0,a=0,n=0,c={...qs};return{get state(){return e},get score(){return s},get elapsedMs(){return f},get startTime(){return r},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",s=0,r=performance.now(),f=0,a=0,n=0,c={...qs}},pause(){return e!=="playing"?!1:(e="paused",a=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",a>0&&(n+=performance.now()-a,a=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(g){s+=g},setScore(g){s=g},updateTime(){e==="playing"&&r>0&&(f=performance.now()-r-n)},getFormattedTime(){let g=Math.floor(f/1e3),p=Math.floor(g/60),u=g%60;return`${p}:${u.toString().padStart(2,"0")}`},incrementStat(g,p=1){g in c&&(c[g]+=p)},updateMaxStat(g,p){g in c&&p>c[g]&&(c[g]=p)},reset(){e="intro",s=0,r=0,f=0,a=0,n=0,c={...qs}}}}function Nn(e,s){return e%=s,e<0&&(e+=s),e}function jo(e,s){return e[Math.min(s,e.length-1)]}function Cs(e){let s=Math.max(0,Math.floor(e/1e3)),r=Math.floor(s/60),f=s%60;return`${r}:${f.toString().padStart(2,"0")}`}function Qo(e,s){let r=e.map(({x:g,y:p},u)=>({x:p,y:-g,color:s[u]})),f=1/0,a=-1/0,n=1/0;for(let g of r)f=Math.min(f,g.x),a=Math.max(a,g.x),n=Math.min(n,g.y);let c=Math.round((f+a)/2);for(let g of r)g.x-=c,g.y-=n;return r.sort((g,p)=>g.y-p.y||g.x-p.x),{cells:r.map(g=>({x:g.x,y:g.y})),colors:r.map(g=>g.color)}}function Ks(e,s,r,f){let a=[];return e+1<r&&a.push({y:e+1,s}),e-1>=0&&a.push({y:e-1,s}),a.push({y:e,s:Nn(s-1,f)}),a.push({y:e,s:Nn(s+1,f)}),a}function Zo(e,s,r){let f=Array.from({length:s},()=>new Uint8Array(r)),a=[];for(let n=0;n<s;n++)for(let c=0;c<r;c++){if(!e[n][c]||f[n][c])continue;let g=[],p=[{y:n,s:c}];for(f[n][c]=1;p.length>0;){let u=p.shift();g.push(u);for(let l of Ks(u.y,u.s,s,r))e[l.y][l.s]&&!f[l.y][l.s]&&(f[l.y][l.s]=1,p.push(l))}a.push(g)}return a}function Jo(e){return e.some(s=>s.y===0)}function zs(e,s,r,f,a,n){if(!e)return!1;let c=Nn(r,n);for(let g of e.cells){let p=s+g.y,u=Nn(c+g.x,n);if(p<0)return!1;if(!(p>=a)&&f[p][u])return!1}return!0}function ti(e,s,r,f,a,n){if(!e)return null;let c=Math.floor(s);for(;zs(e,c-1,r,f,a,n);)c-=1;return c}function ei(e,s,r){let f=[],a=[];for(let n=0;n<s;n++){let c=[],g=0,p=e[n][0],u=p?1:0;for(let l=1;l<=r;l++){let m=l<r?e[n][l]:0;m&&m===p?u++:(u>=1&&p&&c.push({start:g,length:u,color:p}),g=l,p=m,u=m?1:0)}if(c.length>=2){let l=c[0],m=c[c.length-1];if(l.start===0&&m.start+m.length===r&&l.color===m.color){let T=l.length+m.length;c[0]={start:m.start,length:T,color:l.color},c.pop()}}for(let l of c)if(l.length>=3){let m=[];for(let T=0;T<l.length;T++)m.push({y:n,s:(l.start+T)%r});f.push({color:l.color,length:l.length,cells:m})}}for(let n=0;n<r;n++){let c=0,g=e[0][n],p=g?1:0;for(let u=1;u<=s;u++){let l=u<s?e[u][n]:0;if(l&&l===g)p++;else{if(p>=3&&g){let m=[];for(let T=0;T<p;T++)m.push({y:c+T,s:n});f.push({color:g,length:p,cells:m})}c=u,g=l,p=l?1:0}}}for(let n=0;n<s;n++)for(let c=0;c<r;c++){let g=e[n][c],p=e[n][(c+1)%r],u=e[n][(c+2)%r],l=e[n][(c+3)%r];g&&g===p&&u&&u===l&&g!==u&&a.push({cells:[{y:n,s:c},{y:n,s:(c+1)%r},{y:n,s:(c+2)%r},{y:n,s:(c+3)%r}]})}for(let n=0;n<r;n++)for(let c=0;c<s-3;c++){let g=e[c][n],p=e[c+1][n],u=e[c+2][n],l=e[c+3][n];g&&g===p&&u&&u===l&&g!==u&&a.push({cells:[{y:c,s:n},{y:c+1,s:n},{y:c+2,s:n},{y:c+3,s:n}]})}return{lineMatches:f,pairMatches:a}}function ni(e,s,r){let f=[];for(let a=0;a<s;a++){let n=!0;for(let c=0;c<r;c++)if(!e[a][c]){n=!1;break}n&&f.push(a)}return f}function si(e,s){let r=new Map;e.forEach((f,a)=>r.set(`${f.x},${f.y}`,s[a]));for(let f=0;f<e.length;f++){let a=e[f],n=s[f],c=1;for(let vt=1;vt<=2&&r.get(`${a.x+vt},${a.y}`)===n;vt++)c++;if(c>=3)return!0;let g=1;for(let vt=1;vt<=2&&r.get(`${a.x},${a.y+vt}`)===n;vt++)g++;if(g>=3)return!0;let p=n,u=r.get(`${a.x+1},${a.y}`),l=r.get(`${a.x+2},${a.y}`),m=r.get(`${a.x+3},${a.y}`);if(p&&u&&l&&m&&p===u&&l===m&&p!==l)return!0;let T=n,O=r.get(`${a.x},${a.y+1}`),$=r.get(`${a.x},${a.y+2}`),Q=r.get(`${a.x},${a.y+3}`);if(T&&O&&$&&Q&&T===O&&$===Q&&T!==$)return!0}return!1}function oi(e){let{getN:s,getH:r,FALL_INTERVAL:f,LOCK_DELAY_SEC:a,getKillRate:n,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:g,RING_HIGHLIGHT_SEC:p,getState:u,setState:l,funcs:m,ui:T}=e;return{get state(){return u().gameState},get score(){return u().score},get elapsedMs(){return u().elapsedMs},get stats(){return u().stats},get activePiece(){return u().activePiece},get pieceY(){return u().pieceY},get targetRot(){return u().targetRot},get isGrounded(){return u().isGrounded},get isHighlighting(){return u().isHighlighting},get killLevel(){return u().killLevel},get grid(){return u().grid},applyCommand(O,$={}){let Q=u();if(O==="start_game")return Q.gameState!=="playing"?(m.startGame(),!0):!1;if(Q.gameState!=="playing")return!1;switch(O){case"rotate_piece":return m.rotatePieceByDir(),!0;case"move_down":return m.tryMoveDown();case"rotate_cylinder":{let{rot:vt}=$;return typeof vt=="number"&&m.canPlaceAtRot(Math.floor(Q.pieceY),vt)?(l({targetRot:vt,rotFloat:vt,rotVel:0}),Q.isGrounded&&m.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:vt,y:wt}=$;return m.shootMagic(vt,wt)}case"select_magic":{let{element:vt}=$;return m.selectMagic(vt),!0}default:return console.warn("GameEngine: unknown command",O),!1}},update(O,$){let Q=u();if(Q.gameState!=="playing")return;let vt=$-Q.startTime-Q.totalPausedMs;l({elapsedMs:vt}),T.updateTimeHud();let wt=Q.killLevel+n()*O;if(l({killLevel:wt}),T.updateRemainingHud(),wt>=r()){m.endGame();return}if(Q.isHighlighting){let _t=($-Q.highlightStartTime)/1e3,Xt;Q.isRingAnimation?Xt=p:Q.isMagicAnimation?Xt=g:Xt=c,_t>=Xt&&(Q.isRingAnimation?m.finishRingHighlight():m.finishHighlight())}let ne=Q.fallTimer+O;if(ne>=f&&(ne-=f,m.tryMoveDown()),l({fallTimer:ne}),m.updateGroundedState()){let _t=Q.lockTimer+O;l({lockTimer:_t}),_t>=a&&m.lockPiece()}},reset(){m.startGame()},canRotateTo(O,$){return m.canPlaceAtRot(O,$)},getRotation(){let O=u();return{targetRot:O.targetRot,rotFloat:O.rotFloat,rotVel:O.rotVel}},setRotation(O){l({targetRot:O,rotFloat:O,rotVel:0})},onGroundedMove(){m.maybeResetLockDelay()}}}var Ve=Math.PI*2;function ii(e){let{canvas:s,canvasCtx:r,getN:f,getH:a,TOP_PAD_PX:n,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:g,MAX_RADIUS_X:p,RADIUS_X_FACTOR:u,ANG_OFFSET:l,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:T,MAGIC_SHRINK_SEC:O,RING_HIGHLIGHT_SEC:$,LOCK_DELAY_SEC:Q,getKillRate:vt,ELEMENT_COLORS:wt,ELEMENT_TO_COLOR:ne,BLOCK_COLOR_FRONT:Kt,BLOCK_COLOR_BACK:_t,ACTIVE_COLOR_FRONT:Xt,GHOST_COLOR_FILL:at,GHOST_COLOR_STROKE:Z,GHOST_STROKE_WIDTH:Bt,MAGIC_DIM_DOT_ALPHA:Gt,MAGIC_DIM_DOT_SCALE:kt,MAGIC_TARGET_DOT_SCALE:I,getState:Ot,getVisualSettings:zt,funcs:Pt}=e,i=r,it=f(),st=a(),ie={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},V=[],K=40,U={ENABLED:!0,SPEED_THRESHOLD:45,SPEED_NORMALIZER:24,BRUSH_SPEED_NORMALIZER:26,MIN_DISTANCE_CELLS:3.2,MIN_CONFIRMED_FRAMES:3,DISTANCE_DECAY_PER_SEC:12,STRENGTH_DECAY_PER_SEC:3.8,STRENGTH_IDLE_DECAY_PER_SEC:6,STRENGTH_BLEND:.55,STRENGTH_GAIN:.9,MIN_RENDER_STRENGTH:.12},Y={prevPieceRef:null,prevPieceY:0,prevPieceSampleTs:0,brushStrength:0,speedCellsPerSec:0,distanceCells:0,confirmedFrames:0},Yt={ENABLED:!0,TRIGGER_TRAIL_STRENGTH:.24,MAX_OFFSET_PX:10,DOWN_DURATION_SEC:.055,RETURN_DURATION_SEC:.17,RESPECT_REDUCED_MOTION:!0},D={active:!1,startTs:0,amplitudePx:0,prevPieceRef:null,prevGrounded:!1},jt=typeof window<"u"&&typeof window.matchMedia=="function"?window.matchMedia("(prefers-reduced-motion: reduce)"):null;function lt(E,h,y,x,B){let w=Math.max(3,Math.round(E)),G=180;for(let X=0;X<w;X++)setTimeout(()=>{let R=Math.random()>.5?"left":"right",St=15,z=R==="left"?St+Math.random()*Math.max(10,h-St*2):y+St+Math.random()*Math.max(10,B-y-St*2),j=x-10;V.push({x:z,baseX:z,y:j,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:St,maxX:B-St})},X*G)}function Ht(E,h,y){V=V.filter(x=>x.y>E+x.size&&x.y>-20);for(let x of V){x.y-=K*y,x.wobble+=x.wobbleSpeed*y;let B=x.baseX+Math.sin(x.wobble)*x.wobbleAmp;x.x=Math.max(x.minX,Math.min(x.maxX,B))}}function Qt(E){if(V.length!==0){i.fillStyle="rgba(255, 255, 255, 0.3)",i.strokeStyle="rgba(255, 255, 255, 0.5)",i.lineWidth=1;for(let h of V)h.y<E+h.size||(i.beginPath(),i.arc(h.x,h.y,h.size,0,Math.PI*2),i.fill(),i.stroke())}}let ae={left:0,right:0,h:0,w:0};function bt(E,h,y){let x=1-y/st;return E+x*h}function se(E){return E=E%it,E<0?E+it:E}function pt(E,h,y,x,B,w){let G=se(w),X=(B-G)/it*Ve+l;return{x:E+Math.cos(X)*y,y:h+Math.sin(X)*x,ang:X}}let ee=.52,Ce=1.02;function Tt(E,h,y,x,B,w){let G=se(w),X=(B-G)/it*Ve+l;return{x:E+Math.cos(X)*y,y:h+Math.sin(X)*x,ang:X}}function Re(E,h,y,x,B,w,G,X=1){let R=Tt(E,h,y,x,B-ee,w),St=Tt(E,h,y,x,B+ee,w),z={x:R.x,y:R.y-G*.5},j={x:R.x,y:R.y+G*.5},ft={x:St.x,y:St.y-G*.5},b={x:St.x,y:St.y+G*.5},N=(z.x+ft.x+b.x+j.x)*.25,ot=(z.y+ft.y+b.y+j.y)*.25,ce=Ce*X,v=X,At=[z,ft,b,j].map($e=>({x:N+($e.x-N)*ce,y:ot+($e.y-ot)*v})),P=Math.abs((St.x-R.x)*ce),$t=Math.abs(G*v);return{corners:At,cx:N,cy:ot,wApprox:P,hApprox:$t,ang:Tt(E,h,y,x,B,w).ang}}function Ft(E,h,y,x,B,w,G,X,R=1,St=null,z=1,j=null,ft=0,b=1,N=1){let ot=Re(E,h,y,x,B,w,G,N),[ce,v,At,P]=ot.corners;if(i.save(),i.globalAlpha=R,i.fillStyle=X,i.beginPath(),i.moveTo(ce.x,ce.y),i.lineTo(v.x,v.y),i.lineTo(At.x,At.y),i.lineTo(P.x,P.y),i.closePath(),i.fill(),j&&ft>0&&(i.strokeStyle=j,i.lineWidth=ft,i.stroke()),St){let $t=Math.min(ot.wApprox,ot.hApprox)*.28*b;i.globalAlpha=R*z,i.fillStyle=St,i.beginPath(),i.arc(ot.cx,ot.cy,$t,0,Ve),i.fill()}i.restore(),i.globalAlpha=1}function Jt(E,h,y,x,B,w){let G=pt(E,h,y,x,B,w),X=pt(E,h,y,x,B+1,w),R=pt(E,h,y,x,B-1,w),St=Math.abs(X.x-G.x),z=Math.abs(G.x-R.x),j=(St+z)*.5*1.06;return Math.max(1,j)}function qe(E,h,y,x,B,w){let G=(B-w)/it*Ve+l;return{x:E+Math.cos(G)*y,y:h+Math.sin(G)*x,ang:G}}function Ke(E,h,y,x,B,w,G,X=1,R=null,St=1,z=null,j=0,ft=1){i.save(),i.translate(E,h);let b=Math.atan2(x,y);if(i.rotate(b),i.globalAlpha=X,i.fillStyle=G,i.fillRect(-B/2,-w/2,B,w),z&&j>0&&(i.strokeStyle=z,i.lineWidth=j,i.strokeRect(-B/2,-w/2,B,w)),R){let N=Math.min(B,w)*.28*ft;i.globalAlpha=X*St,i.fillStyle=R,i.beginPath(),i.arc(0,0,N,0,Ve),i.fill()}i.restore(),i.globalAlpha=1}function mt(E){return Math.max(0,Math.min(1,E))}function xt(E,h){if(typeof E!="string"||E.length===0)return`rgba(255, 200, 180, ${h})`;if(E.startsWith("#")){let y=E.slice(1);if(y.length===3&&(y=y.split("").map(x=>x+x).join("")),y.length===6){let x=parseInt(y.slice(0,2),16),B=parseInt(y.slice(2,4),16),w=parseInt(y.slice(4,6),16);return`rgba(${x}, ${B}, ${w}, ${h})`}}if(E.startsWith("rgb")){let y=E.match(/[\d.]+/g);if(y&&y.length>=3){let x=Number(y[0]),B=Number(y[1]),w=Number(y[2]);return`rgba(${x}, ${B}, ${w}, ${h})`}}return`rgba(255, 200, 180, ${h})`}function ze(E,h,y,x,B,w,G,X=0){if(B<=0)return;let R=mt((w-U.SPEED_THRESHOLD)/U.BRUSH_SPEED_NORMALIZER),St=y*(4.6+R*4.4)*(.78+B*.22),z=Math.max(X,y*(.58+B*.14)),j=Math.max(y*.06,z*(.09+(1-R)*.03)),ft=Math.sin(G*.01+E*.02)*y*.04*B,b=h-St;i.save(),i.globalCompositeOperation="screen",i.beginPath(),i.moveTo(E-z,h),i.lineTo(E+z,h),i.lineTo(E+ft+j,b),i.lineTo(E+ft-j,b),i.closePath(),i.clip();let N=i.createLinearGradient(E,h,E+ft,b);N.addColorStop(0,xt(x,.62*B+.16)),N.addColorStop(.38,xt(x,.36*B+.09)),N.addColorStop(.7,xt(x,.14*B+.03)),N.addColorStop(1,xt(x,0)),i.fillStyle=N,i.fillRect(E-z-y,b-y,(z+y)*2,St+y*2);let ot=Math.max(4,y*.22),ce=Math.max(1.15,ot*.22),v=Math.ceil((h-b)/ot)+1;for(let At=0;At<v;At++){let P=h-At*ot;if(P<b)break;let $t=mt((P-b)/(h-b)),$e=E+ft*(1-$t),ye=j+(z-j)*$t,je=ot,dn=$e-ye+At%2*je*.5;for(let re=dn;re<=$e+ye;re+=je){let J=1-Math.abs(re-$e)/Math.max(1,ye);if(J<=0)continue;let te=(.08+.62*Math.pow($t,1.55))*Math.pow(J,.65)*B;i.fillStyle=xt(x,te),i.beginPath(),i.arc(re,P,ce,0,Math.PI*2),i.fill()}}i.strokeStyle=xt(x,.2*B),i.lineWidth=Math.max(1,y*.05),i.beginPath(),i.moveTo(E+ft-j*.6,b+y*.05),i.lineTo(E-z*.72,h),i.moveTo(E+ft+j*.2,b+y*.08),i.lineTo(E+z*.35,h),i.stroke(),i.restore()}function tn(){Y.prevPieceRef=null,Y.prevPieceY=0,Y.prevPieceSampleTs=0,Y.speedCellsPerSec=0,Y.distanceCells=0,Y.confirmedFrames=0}function en(E,h=!1){let y=h?U.STRENGTH_IDLE_DECAY_PER_SEC:U.STRENGTH_DECAY_PER_SEC;Y.brushStrength=Math.max(0,Y.brushStrength-E*y)}function Zn(E,h,y,x){if(!U.ENABLED)return en(x,!1),{dropSpeed:0};let B=0,w=0;if(Y.prevPieceRef===E&&Y.prevPieceSampleTs>0){let St=Math.max(.001,(y-Y.prevPieceSampleTs)/1e3);w=Y.prevPieceY-h,w>0&&(B=w/St)}let G=mt((B-U.SPEED_THRESHOLD)/U.SPEED_NORMALIZER);G>0&&w>0?(Y.confirmedFrames+=1,Y.confirmedFrames>=U.MIN_CONFIRMED_FRAMES&&(Y.distanceCells+=w)):(Y.confirmedFrames=0,Y.distanceCells=Math.max(0,Y.distanceCells-x*U.DISTANCE_DECAY_PER_SEC));let X=mt((Y.distanceCells-U.MIN_DISTANCE_CELLS)/U.MIN_DISTANCE_CELLS),R=G*X;return R>0?(Y.brushStrength=Math.min(1,Y.brushStrength*U.STRENGTH_BLEND+R*U.STRENGTH_GAIN),Y.speedCellsPerSec=B):en(x,!1),Y.prevPieceRef=E,Y.prevPieceY=h,Y.prevPieceSampleTs=y,{dropSpeed:B}}function _e(E,h,y,x){if(!U.ENABLED||Y.brushStrength<=U.MIN_RENDER_STRENGTH||E.length===0)return;let B=Math.max(...E.map(ft=>ft.cy)),w=E.filter(ft=>ft.cy===B),G=Math.min(...w.map(ft=>ft.topLeftX)),X=Math.max(...w.map(ft=>ft.topRightX)),R=(G+X)*.5,St=Math.max(...w.map(ft=>ft.topY))+h*.03,z=Math.max(h*.45,(X-G)*.5+h*.04),j=wt[w[0].color]||"#ffd8a8";ze(R,St,h,j,Y.brushStrength,Math.max(Y.speedCellsPerSec,y),x,z)}function Dt(){return!!(Yt.RESPECT_REDUCED_MOTION&&jt&&jt.matches)}function ln(E,h=1){!Yt.ENABLED||Dt()||(D.active=!0,D.startTs=E,D.amplitudePx=Yt.MAX_OFFSET_PX*mt(h))}function yt(E,h,y){if(!Yt.ENABLED){D.prevPieceRef=E,D.prevGrounded=!!h;return}if(D.prevPieceRef!==E&&(D.prevGrounded=!1),!!E&&!!h&&!D.prevGrounded&&U.ENABLED){let B=Yt.TRIGGER_TRAIL_STRENGTH;if(Y.brushStrength>=B){let G=.72+mt((Y.brushStrength-B)/Math.max(.001,1-B))*.28;ln(y,G)}}D.prevPieceRef=E,D.prevGrounded=!!h}function Hn(E){if(!Yt.ENABLED||!D.active||Dt())return 0;let h=Math.max(0,(E-D.startTs)/1e3),y=Yt.DOWN_DURATION_SEC,x=Yt.RETURN_DURATION_SEC;if(h<=y){let w=mt(h/y);return D.amplitudePx*(1-Math.pow(1-w,3))}let B=h-y;if(B<=x){let w=mt(B/x),G=Math.exp(-5.2*w);return D.amplitudePx*G*Math.cos(w*Math.PI*1.35)}return D.active=!1,0}return{resize(){let E=Math.max(1,Math.min(2,window.devicePixelRatio||1)),h=Math.floor(s.clientWidth*E),y=Math.floor(s.clientHeight*E);(s.width!==h||s.height!==y)&&(s.width=h,s.height=y,i.setTransform(E,0,0,E,0,0))},render(E=.016,h=performance.now()){this.resize();let y=Ot(),{activePiece:x,isGrounded:B}=y;yt(x,B,h);let w=Hn(h);it=f(),st=a();let G=s.clientWidth,X=s.clientHeight;i.clearRect(0,0,G,X),i.save(),w!==0&&i.translate(0,w),i.fillStyle="#0b0f14",i.fillRect(0,0,G,X);let R=G*.5,St=(G-2*g)/2,z=X-n-c,j=6,ft=it*z/(j*st),b,N,ot,ce;ce=X-c,ft<=Math.min(St,p)?(b=ft,N=z,ot=n):(b=Math.min(St,p),N=b*j*st/it,ot=ce-N);let v=b*.28,{killLevel:At,rotFloat:P,grid:$t,gameState:$e}=y,ye=zt?zt():{},je=ye.waterColor||"blue",dn=ye.waterBubbles||!1,re=ie[je]||ie.blue,J=bt(ot,N,At),te=.7,Tn=At/st,S={...re.top},L={...re.bottom};if(Tn>te){let A=(Tn-te)/(1-te);S.r=Math.round(S.r+(255-S.r)*A*.5),S.g=Math.round(S.g+(150-S.g)*A*.5),S.b=Math.round(S.b+(150-S.b)*A*.5),L.r=Math.round(L.r+(180-L.r)*A),L.g=Math.round(L.g*(1-A*.6)),L.b=Math.round(L.b*(1-A*.6))}let M=R-b-8,gt=R+b+8,ht=ot,Rt=ce+5,oe=i.createLinearGradient(0,J,0,X);oe.addColorStop(0,`rgba(${S.r},${S.g},${S.b},0.5)`),oe.addColorStop(1,`rgba(${L.r},${L.g},${L.b},0.7)`),i.fillStyle=oe;let le=Math.round((S.r+L.r)/2),De=Math.round((S.g+L.g)/2),nn=Math.round((S.b+L.b)/2),xn=b+8,Qe=v+4;i.fillRect(0,J,M,X-J),i.fillRect(gt,J,G-gt,X-J),i.beginPath();let Se=Math.max(J,Rt);i.moveTo(M,Se),J<=Rt+Qe?i.ellipse(R,Rt,xn,Qe,0,Math.PI,0,!1):i.lineTo(gt,Se),i.lineTo(gt,X),i.lineTo(M,X),i.closePath(),i.fill(),i.strokeStyle="rgba(100,180,255,0.6)",i.lineWidth=3,i.lineCap="round",i.beginPath(),i.moveTo(M,ht),i.lineTo(M,Rt),i.stroke(),i.beginPath(),i.moveTo(gt,ht),i.lineTo(gt,Rt),i.stroke(),i.beginPath(),i.ellipse(R,Rt,b+8,v+4,0,0,Math.PI),i.stroke(),i.fillStyle="#0b0f14",i.beginPath(),i.ellipse(R,Rt,b+8,v+4,0,0,Ve),i.fill(),At>.5&&(i.strokeStyle=`rgba(${Math.min(255,le+60)},${Math.min(255,De+40)},${Math.min(255,nn+40)},0.6)`,i.lineWidth=2,i.beginPath(),i.moveTo(0,J),i.lineTo(M,J),i.moveTo(gt,J),i.lineTo(G,J),i.stroke()),ae={left:M,right:gt,h:X,w:G},(V.length>0||dn)&&(Ht(J,X,E),Qt(J)),i.strokeStyle="rgba(160,190,220,0.3)",i.lineWidth=1;let de=Ve*b,ue=10,Le=de/ue*.7,Cn=de/ue*.3;i.setLineDash([Le,Cn]);let Sn=de/it;i.lineDashOffset=se(P)*Sn;for(let A=0;A<=st;A++){let F=bt(ot,N,A);i.beginPath(),i.ellipse(R,F,b,v,0,0,Ve),i.stroke()}i.setLineDash([]);let sn=[],Ne=[];for(let A=0;A<st;A++){let F=bt(ot,N,A+.5);for(let tt=0;tt<it;tt++){let q=$t[A][tt];if(!q)continue;let et=pt(R,F,b,v,tt,P),nt=Math.sin(et.ang),rt={y:A,s:tt,yScr:F,p:et,depth:nt,color:q};nt<-.1?sn.push(rt):Ne.push(rt)}}let fe=Pt.getMagicTargetColor(),{isHighlighting:Ze,highlightedCells:ge,highlightStartTime:Ge,isMagicAnimation:En}=y,Ee=null,on=1,pe=1,Be=!1;if(Ze&&ge.length>0){Ee=new Set(ge.map(F=>`${F.y},${F.s}`));let A=(performance.now()-Ge)/1e3;if(En){let F=Math.min(1,A/O);on=1-F*.85,pe=1-F*.9,Be=!0}else{let F=Math.min(1,A/m),tt=1-T;if(F>tt){let q=(F-tt)/T;on=1-q*.85,pe=1-q*.9,Be=!0}}}sn.sort((A,F)=>A.depth-F.depth);for(let A of sn){let F=N/st*.9,tt=wt[A.color]||null,q=.35,et=1,nt=`${A.y},${A.s}`;Ee&&Ee.has(nt)&&(q*=pe,et=on),Ft(R,A.yScr,b,v,A.s,P,F,_t,q,tt,.5,null,0,1,et)}let{isRingAnimation:Ue}=y;if(Ze&&ge.length>0&&!En){let A=(performance.now()-Ge)/1e3,tt=Math.min(1,A/(Ue?$:m)),q=1-T,et=tt>q,nt=et?(tt-q)/T:0,rt=Ue?Math.floor(tt*q*it*2)%it:-1,_=4+tt/q*10,H=Math.sin(A*_*Ve),dt=et?1:.3+H*.3,k=et?1-nt*.8:1,ut=et?1-nt:1;for(let Ct of ge){let Nt=bt(ot,N,Ct.y+.5),Zt=Tt(R,Nt,b,v,Ct.s,P);if(Math.sin(Zt.ang)>=-.1)continue;let Lt=N/st*.9,Me,Ae,we;if(Ue){let Xe=(Ct.s-rt+it)%it,pn=Xe<3?1-Xe/3:0;Me=(et?ut:.2+pn*.5)*.5,Ae=`rgba(255, 159, 67, ${Me})`,we=et?k:1+pn*.15}else Me=dt*ut,Ae=Ct.isLine?`rgba(255, 255, 255, ${Me*.5})`:`rgba(255, 220, 100, ${Me*.4})`,we=et?k:1.1;Ft(R,Nt,b,v,Ct.s,P,Lt,Ae,1,null,1,null,0,1,we)}}Ne.sort((A,F)=>A.depth-F.depth);for(let A of Ne){let F=N/st*.9,tt=wt[A.color]||null,q=1,et=1,nt=1,rt=1,_=`${A.y},${A.s}`,H=Ee&&Ee.has(_);H&&(q=pe,et=on),fe!==null&&!H&&(A.color!==fe?(nt=Gt,rt=kt):rt=I),Ft(R,A.yScr,b,v,A.s,P,F,Kt,q,tt,nt,null,0,rt,et)}if(Ze&&ge.length>0&&!En){let A=(performance.now()-Ge)/1e3,tt=Math.min(1,A/(Ue?$:m)),q=1-T,et=tt>q,nt=et?(tt-q)/T:0,rt=Ue?Math.floor(tt*q*it*2)%it:-1,_=4+tt/q*10,H=Math.sin(A*_*Ve),dt=et?1:.5+H*.5,k=et?1-nt*.8:1,ut=et?1-nt:1;for(let Ct of ge){let Nt=bt(ot,N,Ct.y+.5),Zt=Tt(R,Nt,b,v,Ct.s,P);if(Math.sin(Zt.ang)<-.1)continue;let Lt=N/st*.9,Me,Ae,we;if(Ue){let Xe=(Ct.s-rt+it)%it,pn=Xe<4?1-Xe/4:0;Me=et?ut:.3+pn*.7,Ae=`rgba(255, 159, 67, ${Me})`,we=et?k:1+pn*.2}else Me=dt*ut,Ae=Ct.isLine?`rgba(255, 255, 255, ${Me*.7})`:`rgba(255, 220, 100, ${Me*.6})`,we=et?k:1.15;Ft(R,Nt,b,v,Ct.s,P,Lt,Ae,1,null,1,null,0,1,we)}}let Fn=y.spellState||y,{transmuteState:$n,transmuteSourceBlock:un,transmuteTargetColor:_s,transmuteAreaCells:fn,transmuteBlocksToChange:Mn}=Fn;if($n==="selecting_source"){let A=N/st*.9,F=.35+Math.sin(h/150)*.15;for(let tt of Ne){let q=bt(ot,N,tt.y+.5);Ft(R,q,b,v,tt.s,P,A,`rgba(0, 40, 20, ${F})`,1,null,1,null,0,1,1)}}if($n==="selecting_target"&&Mn&&Mn.length>0){let A=N/st*.9,F=.4+Math.sin(h/120)*.25,tt=.6+Math.sin(h/120)*.4;for(let q of Mn){if(q.y<0||q.y>=st)continue;let et=bt(ot,N,q.y+.5),nt=Tt(R,et,b,v,q.s,P);Math.sin(nt.ang)<-.1||(Ft(R,et,b,v,q.s,P,A,`rgba(0, 50, 30, ${F})`,1,null,1,null,0,1,1),Ft(R,et,b,v,q.s,P,A,"transparent",1,null,1,`rgba(100, 255, 150, ${tt})`,3,1,1.02))}}if($n==="animating"&&Pt.getTransmuteAnimState){let A=Pt.getTransmuteAnimState(h);if(A){let F=N/st*.9,{phase:tt,progress:q,areaFlash:et}=A;if(et>0&&fn)for(let nt of fn){if(nt.y<0||nt.y>=st)continue;let rt=bt(ot,N,nt.y+.5),_=Tt(R,rt,b,v,nt.s,P);Math.sin(_.ang)<-.1||Ft(R,rt,b,v,nt.s,P,F,`rgba(150, 255, 200, ${et*.4})`,1,null,1,null,0,1,1)}if(Mn&&Mn.length>0){let nt=un?un.color:1,rt=_s||1;for(let _ of Mn){if(_.y<0||_.y>=st)continue;let H=bt(ot,N,_.y+.5),dt=Tt(R,H,b,v,_.s,P);if(Math.sin(dt.ang)<-.1)continue;let ut=1,Ct=wt[nt],Nt=0;if(tt==="shrink"?(ut=1-q*.95,Ct=wt[nt],Nt=.5+q*.3):tt==="grow"&&(ut=q,Ct=wt[rt],Nt=.8-q*.5),Nt>0&&Ft(R,H,b,v,_.s,P,F,`rgba(200, 255, 220, ${Nt})`,1,null,1,null,0,1,1),ut>.05){let Zt=Re(R,H,b,v,_.s,P,F,1),Ie=Math.min(Zt.wApprox,Zt.hApprox)*.28*ut;i.save(),i.globalAlpha=1,i.fillStyle=Ct,i.beginPath(),i.arc(Zt.cx,Zt.cy,Ie,0,Ve),i.fill(),i.restore()}}}}}let{lightningState:Gn,lightningSourceBlock:Rs,lightningAreaCells:Jn,lightningBlocksToHit:gn}=Fn;if(Gn==="selecting_source"){let A=N/st*.9,F=.35+Math.sin(h/150)*.15;for(let tt of Ne){let q=bt(ot,N,tt.y+.5);Ft(R,q,b,v,tt.s,P,A,`rgba(20, 20, 60, ${F})`,1,null,1,null,0,1,1)}}if(Gn==="animating"&&Pt.getLightningAnimState){let A=Pt.getLightningAnimState(h);if(A&&gn&&gn.length>0){let F=N/st*.9,{phase:tt,flashProgress:q,currentTarget:et,jumpProgress:nt,struckTargets:rt}=A;if(tt==="flash"&&q>0&&Jn)for(let _ of Jn){if(_.y<0||_.y>=st)continue;let H=bt(ot,N,_.y+.5),dt=Tt(R,H,b,v,_.s,P);Math.sin(dt.ang)<-.1||Ft(R,H,b,v,_.s,P,F,`rgba(100, 150, 255, ${q*.5})`,1,null,1,null,0,1,1)}if(rt&&rt.length>0)for(let _ of rt){let H=gn[_];if(!H||H.y<0||H.y>=st)continue;let dt=bt(ot,N,H.y+.5),k=Tt(R,dt,b,v,H.s,P);if(Math.sin(k.ang)<-.1)continue;let Ct=(rt.length-1-rt.indexOf(_))*.1,Nt=Math.max(0,.8-Ct);Ft(R,dt,b,v,H.s,P,F,`rgba(255, 255, 255, ${Nt})`,1,null,1,`rgba(150, 200, 255, ${Nt})`,2,1,1.05)}if(tt==="chain"&&et>=0&&et<gn.length){let _=gn[et];if(_&&_.y>=0&&_.y<st){let H=bt(ot,N,_.y+.5),dt=Tt(R,H,b,v,_.s,P);if(Math.sin(dt.ang)>=-.1){let ut=1-nt;Ft(R,H,b,v,_.s,P,F,`rgba(200, 220, 255, ${ut*.9})`,1,null,1,`rgba(100, 180, 255, ${ut})`,3,1,1.1-nt*.05)}}if(et>0){let H=gn[et-1],dt=gn[et];if(H&&dt){let k=bt(ot,N,H.y+.5),ut=bt(ot,N,dt.y+.5),Ct=Re(R,k,b,v,H.s,P,F,1),Nt=Re(R,ut,b,v,dt.s,P,F,1);i.save(),i.strokeStyle=`rgba(150, 200, 255, ${1-nt*.5})`,i.lineWidth=2+(1-nt)*2,i.lineCap="round",i.beginPath();let Zt=Ct.cx,Ie=Ct.cy,Lt=Nt.cx,Me=Nt.cy;i.moveTo(Zt,Ie);let Ae=4;for(let we=1;we<=Ae;we++){let Xe=we/Ae,pn=Zt+(Lt-Zt)*Xe,_n=Ie+(Me-Ie)*Xe,Rn=we<Ae?(Math.random()-.5)*8:0;i.lineTo(pn+Rn,_n+Rn)}i.stroke(),i.strokeStyle=`rgba(100, 150, 255, ${(1-nt)*.3})`,i.lineWidth=6,i.stroke(),i.restore()}}}}}let{fireState:ts,fireSourceBlock:es,fireLineCells:Bn,fireTargets:In}=Fn;if(ts==="selecting_source"){let A=N/st*.9,F=.3+Math.sin(h/140)*.2;for(let tt of Ne){let q=bt(ot,N,tt.y+.5);Ft(R,q,b,v,tt.s,P,A,`rgba(70, 25, 10, ${F})`,1,null,1,null,0,1,1)}}if(ts==="animating"&&Pt.getFireAnimState){let A=Pt.getFireAnimState(h);if(A&&Bn&&Bn.length>0){let F=N/st*.9,{progress:tt,flashProgress:q}=A,et=Math.sin(tt*Math.PI);if(q>0)for(let nt of Bn){if(nt.y<0||nt.y>=st)continue;let rt=bt(ot,N,nt.y+.5),_=Tt(R,rt,b,v,nt.s,P);Math.sin(_.ang)<-.1||Ft(R,rt,b,v,nt.s,P,F,`rgba(255, 120, 50, ${q*.45})`,1,null,1,`rgba(255, 200, 140, ${q*.5})`,2,1,1.03)}if(es){let nt=new Map;for(let _ of Bn){if(_.y<0||_.y>=st)continue;let H=bt(ot,N,_.y+.5),dt=Tt(R,H,b,v,_.s,P);if(Math.sin(dt.ang)<-.1)continue;let ut=Re(R,H,b,v,_.s,P,F,1),Ct=_.s-es.s;Ct>it/2&&(Ct-=it),Ct<-it/2&&(Ct+=it);let Nt=_.y;nt.has(Nt)||nt.set(Nt,[]),nt.get(Nt).push({x:ut.cx,y:ut.cy,offset:Ct})}let rt=Array.from(nt.keys()).sort((_,H)=>H-_);if(rt.length>0){let _=.35+.3*Math.sin(h/60)+et*.2;i.save(),i.lineCap="round";for(let H of rt){let dt=nt.get(H)||[];if(dt.sort((k,ut)=>k.offset-ut.offset),dt.length!==0){i.beginPath(),i.moveTo(dt[0].x,dt[0].y);for(let k=1;k<dt.length;k++)i.lineTo(dt[k].x,dt[k].y);i.strokeStyle=`rgba(255, 140, 60, ${_})`,i.lineWidth=Math.max(2,F*.15),i.stroke(),i.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,i.lineWidth=Math.max(6,F*.35),i.stroke()}}i.restore()}}if(In&&In.length>0){let nt=.2+et*.6;for(let rt of In){if(rt.y<0||rt.y>=st)continue;let _=bt(ot,N,rt.y+.5),H=Tt(R,_,b,v,rt.s,P);Math.sin(H.ang)<-.1||Ft(R,_,b,v,rt.s,P,F,`rgba(255, 160, 70, ${nt})`,1,null,1,`rgba(255, 230, 180, ${et*.6})`,2,1,1.05)}}}}let{pieceY:ns,lockTimer:ss}=y;if(x){let{dropSpeed:A}=Zn(x,ns,h,E),F=Pt.snappedRot(),tt=F,q=Pt.computeGhostY(),et=N/st*.9;if(q!==null){let _=[];for(let H=0;H<x.cells.length;H++){let dt=x.cells[H],k=x.colors[H],ut=q+dt.y,Ct=Pt.normSector(F+dt.x);if(ut<0||ut>=st)continue;let Nt=bt(ot,N,ut+.5),Zt=Tt(R,Nt,b,v,Ct,tt);_.push({cy:ut,cs:Ct,yScr:Nt,depth:Math.sin(Zt.ang),color:k})}_.sort((H,dt)=>H.depth-dt.depth);for(let H of _){let dt=wt[H.color]||null;Ft(R,H.yScr,b,v,H.cs,tt,et,at,1,dt,.5,Z,Bt,1,1)}}let nt=Xt;if(B&&ss>0){let _=Math.min(1,ss/Q),H=255,dt=Math.round(170+85*_),k=Math.round(180+75*_),ut=.75+(1-.75)*_;nt=`rgba(${H},${dt},${k},${ut})`}let rt=[];for(let _=0;_<x.cells.length;_++){let H=x.cells[_],dt=x.colors[_],k=Pt.normSector(F+H.x),ut=ns+H.y;if(ut<0||ut>=st)continue;let Ct=bt(ot,N,ut+.5),Nt=Tt(R,Ct,b,v,k,tt),Zt=Re(R,Ct,b,v,k,tt,et,1),[Ie,Lt]=Zt.corners;rt.push({cs:k,yScr:Ct,x:Nt.x,depth:Math.sin(Nt.ang),color:dt,cy:ut,topY:Math.max(Ie.y,Lt.y),topLeftX:Math.min(Ie.x,Lt.x),topRightX:Math.max(Ie.x,Lt.x)})}_e(rt,et,A,h),rt.sort((_,H)=>_.depth-H.depth);for(let _ of rt){let H=wt[_.color]||null;Ft(R,_.yScr,b,v,_.cs,tt,et,nt,1,H,1,null,0,1,1)}}else tn(),en(E,!0);i.restore()},drawNextPreview(E,h){if(!E)return;let y=E.getContext("2d"),x=E.width,B=E.height;if(y.clearRect(0,0,x,B),!h)return;let w=1/0,G=-1/0,X=1/0,R=-1/0;for(let N of h.cells)w=Math.min(w,N.x),G=Math.max(G,N.x),X=Math.min(X,N.y),R=Math.max(R,N.y);let St=G-w+1,z=R-X+1,j=Math.min(x/(St+.5),B/(z+.5)),ft=(x-St*j)/2,b=(B-z*j)/2;y.fillStyle=Kt;for(let N=0;N<h.cells.length;N++){let ot=h.cells[N],ce=ft+(ot.x-w)*j,v=b+(z-1-(ot.y-X))*j;y.fillRect(ce+1,v+1,j-2,j-2);let At=h.colors[N],P=wt[At];if(P){let $t=(j-2)*.32;y.fillStyle=P,y.beginPath(),y.arc(ce+j/2,v+j/2,$t,0,Ve),y.fill(),y.fillStyle=Kt}}},spawnBonusBubbles(E){let{left:h,right:y,h:x,w:B}=ae;B>0&&lt(E,h,y,x,B)}}}(()=>{let e=No(),s=e.canvas,r=s.getContext("2d");s.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let f=Math.PI*2,a=30,n=24,c=120,g={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function p(t){let o=g[t]||g["30_24"];a=o.N,n=o.H,c=o.survivalTime}function u(){return n/c}let l=Math.PI/2,m=70,T=120,O=30,$=320,Q=.42,vt="rgb(235,240,250)",wt="rgb(55,62,75)",ne="rgba(255,170,180,0.75)",Kt="rgba(110,255,150,0.15)",_t="rgba(110,255,150,0.85)",Xt=2,at={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Z={1:"fire",2:"water",3:"lightning",4:"earth"},Bt={fire:1,water:2,lightning:3,earth:4},Gt=1,kt=.58,I=!0,Ot=12,zt=25,Pt=1,i=2,it=3,st=1,ie={fire:1,water:1,lightning:1,earth:1},V=5,K=7,U=10,Y=3,Yt=50,D=2,jt=.3,lt=.5,Ht=1,Qt=.3,ae=.5,bt=1.3,se=10,pt=1e3,ee=[1,1.25,1.5,1.75,2],Ce=10,Tt=20,Re=5,Ft=[1,1.3,1.6,2,2.4,2.8],Jt=[1,1.1,1.2,1.3,1.4,1.5],qe=[1,1.5,2,2.5,3,3.5],Ke=[1,1.3,1.6,2,2.4,2.8],mt=Do(),xt=mt.loadGameSettings();xt.hapticsEnabled===void 0&&(xt.hapticsEnabled=!0);let ze=xt.invertSwipe?-1:1,tn=xt.showControls!==!1,en=xt.tapRotate===!0,_e=!1,Dt=-1,ln=Xo({enabled:xt.hapticsEnabled}),yt=Array.from({length:n},()=>new Uint8Array(a));function Hn(){yt=Array.from({length:n},()=>new Uint8Array(a))}let E=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],h=null,y=n+3,x=0,B=0,w=!1,G=0,X=0,R=0,St=3,z=0,j=0,ft=0,b=Ko({canvas:s,rotDir:ze}),N="0.18.0",ot=!0,ce="blue",v=Ao();v.preload();let At=zo(),P="intro",$t=0,$e=0,ye=0,je=0,dn=0,re=null,J=At.stats,te=0,Tn=e.overlay,S=e.gameContainer,L=Fo({elementColors:at}),M=L.showBonus.bind(L),gt=L.getElementIcon.bind(L),ht=$o(),Rt=e.overlayTitle,oe=e.overlayStats,le=e.startBtn,De=e.hud,nn=e.scoreHud,xn=e.timeHud,Qe=e.remainingHud,Se=e.nextCanvas,de=Se.getContext("2d"),ue=e.pauseBtn,Le=e.pauseOverlay,Cn=e.resumeBtn,Sn=e.restartBtn,sn=e.exitToMenuBtn,Ne=e.pauseSettingsBtn,fe=e.pauseSoundBtn,Ze=e.pauseMusicBtn,ge=e.pauseBestScore,Ge=e.pauseBestTime,En=e.pauseBestMode,Ee=e.pauseCurrentScore,on=e.pauseCurrentTime,pe=e.pauseCurrentMode,Be=e.confirmDialog,Ue=e.confirmText,Fn=e.confirmCancel,$n=e.confirmOk,un=e.settingsOverlay,_s=e.settingsClose,fn=e.fullscreenBtn,Mn=e.rotateBtn,Gn=e.startPanel,Rs=e.gameoverPanel,Jn=e.goScore,gn=e.goTime,ts=e.goRing,es=e.goMatches,Bn=e.goBonuses,In=e.goNewRecord,ns=e.goRestartBtn,ss=e.goExitBtn,A=e.bestScore,F=e.bestTimeVal,tt=e.startVersion,q=e.modeBtns,et=e.recordsBtn,nt=e.startSettingsBtn,rt=e.helpBtn;Uo({helpBtn:rt});let _="25_20";function H(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function dt(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let d=o.dataset.mode,C=g[d];if(!C)return;let W=o.querySelector(".mode-tag.time-tag");if(!W)return;let ct=H(C.survivalTime);ct&&(W.textContent=ct)})}dt();let k=Yo({buttons:e.magicBtns,onActivate:()=>v.play("spells"),onChange:(t,o)=>{Bs()}}),ut=e.magicBtns,Ct=k.charges,Nt=t=>Pe()?k.select(t):!1,Zt=()=>k.updateButtons(),Ie=e.magicRow,Lt=e.magicActiveIndicator,Me=e.magicActiveIcon,Ae=e.magicActiveCost,we={ice:"water",air:"lightning",earth:"earth",fire:"fire"},Xe={fire:"fire",water:"ice",lightning:"air",earth:"earth"},pn=["ice","earth","air","fire"];te=mt.loadHighTowerRings();function _n(t){return typeof me?.getUnlockRings=="function"?me.getUnlockRings(t):0}function Rn(t){let o=_n(t);return o===0||te>=o}let js=["fire","water","lightning","earth"],An=null,os=!1,ai=500,ci=30,ri=220,wn=null,Ls=null,Qs={fire:!1,water:!1,lightning:!1,earth:!1};function Zs(){if(!Lt)return;let t=Lt.getBoundingClientRect();t.width>0&&t.height>0&&(Ls=t)}function li(){if(!Lt)return null;let t=Lt.getBoundingClientRect();return t.width>0&&t.height>0?Lt:Ls?{getBoundingClientRect:()=>Ls}:null}function Un(t=k.active){if(!Lt||!Me)return;t?(An=t,os=!1):os||(An=null);let o=An;if(!o||!Pe()||(k.charges[o]??0)<=0){Zs(),Lt.classList.add("hidden"),Lt.classList.remove("active","ult-ready",...js),Lt.style.setProperty("--progress","0%"),wn&&clearTimeout(wn),wn=setTimeout(()=>{Lt.classList.add("gone")},ri);return}wn&&(clearTimeout(wn),wn=null),Lt.classList.remove("gone"),Lt.classList.contains("hidden")?requestAnimationFrame(()=>Lt.classList.remove("hidden")):Lt.classList.remove("hidden"),Me.textContent=gt(o);let C=Xe[o];C&&me.selectSpell(C);let W=C?Yn(C):0,ct=k.charges[o]??0,Mt=!!C&&cs()&&Rn(C),Wt=!!C&&cs()&&!Mt,he=Mt&&W>0?Math.min(ct/W,1):0,ke=Mt&&W>0,He=ke&&ct>=W;Ae&&(Ae.textContent=ke?`-${W}`:Wt?"\u{1F512}":""),Lt.classList.toggle("no-cost",!ke&&!Wt),Lt.classList.toggle("locked",Wt),Lt.classList.toggle("ult-ready",He),Lt.style.setProperty("--progress",`${Math.round(he*100)}%`),Lt.classList.remove("hidden",...js),Lt.classList.add("active",o),Zs()}function di(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),ai))}function is(){for(let[t,o]of Object.entries(ut)){if(!o)continue;let d=Xe[t],C=Yn(d),W=cs()&&Pe()&&d,ct=typeof Rn=="function"?Rn(d):!0,Mt=W&&ct&&C>0&&(k.charges[t]??0)>=C;o.classList.toggle("ult-ready",Mt),Mt&&!Qs[t]&&(di(o),P==="playing"&&v.play("readysuper")),Qs[t]=Mt}}function Pe(t=_){return t==="30_24"?!0:_e}function Bs(){Un(k.active),is()}function da(t){_e=t,_==="25_20"&&(_e?k.reset():(k.deactivate(),Object.keys(k.charges).forEach(o=>{k.charges[o]=0})),Zt()),as(),Bs()}function as(){Ie&&(Ie.style.display=Pe()?"":"none",Un(k.active),is())}function ua(t){let o=Pn(t),d=Yn(t);return!o||d<=0?!1:k.charges[o]>=d}function fa(t){let o=Pn(t),d=Yn(t);return!o||d<=0||k.charges[o]<d?!1:(k.charges[o]-=d,k.updateButtons(),me.pulse(),!0)}let Xn=e.spellWave;function ui(){Xn&&(Xn.classList.remove("active"),Xn.offsetWidth,Xn.classList.add("active"),setTimeout(()=>Xn.classList.remove("active"),1200))}let mn=null,me=Wo({button:Lt,onReady:()=>{v.play("readysuper")}}),fi=()=>me.getEffect("earth"),gi=()=>me.getEffect("air"),pi=()=>me.getEffect("fire"),Yn=t=>typeof me?.getCost=="function"?me.getCost(t):0,Pn=t=>we[t]??null;mn=qo({canvas:s,dom:e,getGrid:()=>yt,getN:()=>a,getH:()=>n,getRotFloat:()=>z,constants:{TOP_PAD_PX:m,BOTTOM_PAD_PX:T,SIDE_MARGIN_PX:O,MAX_RADIUS_X:$,SCORE_MAGIC_DESTROY:Re},helpers:{normSector:fs,levelYToScreenY:ls,sectorCenterXY:ds},Spell:me,Magic:k,SoundModule:v,State:At,isGamePlaying:()=>P==="playing",addPendingKzDrop:t=>{R+=t},getKillRate:u,triggerSpellWave:ui,spawnSpellBubbles:t=>{let o=Pn(me.currentSpell)??"water";ht.spawnSpellBubbles(me.button,o,t)},spawnBonusBubbles:t=>{Dn.spawnBonusBubbles(t)},getTransmuteEffect:fi,getLightningEffect:gi,getFireEffect:pi,continueMatchProcessing:us,updateScoreHud:Kn,showBonus:M,getSpellCost:Yn,getSpellElement:Pn,onUltimateApplied:t=>{let o=Pn(t)??Pn(me.currentSpell)??"water";if(typeof ht?.spawnSpellBubbles=="function"){let d=li();d&&ht.spawnSpellBubbles(d,o,ci)}os=!1,An=null,Un(null),is()},isSpellBlocked:mi,setScore:t=>{$t=t},setCascadeLevel:t=>{rn=t}});function cs(){return _==="30_24"}function rs(){Un(k.active),is()}let hn=[],Wn=0,an=!1,vn=!1,kn=!1,Ye=0,cn=0,rn=0,On=[];function mi(){return an||vn||kn}function ls(t,o,d){let C=1-d/n;return t+C*o}function ds(t,o,d,C,W,ct){let Mt=(W-ct)/a*f+l;return{x:t+Math.cos(Mt)*d,y:o+Math.sin(Mt)*C,ang:Mt}}function Is(t,o){let d=s.clientWidth,C=s.clientHeight,W=d*.5,ct=(d-2*O)/2,Mt=C-m-T,Wt=6,he=a*Mt/(Wt*n),ke=C-T,He,be,ve;he<=Math.min(ct,$)?(He=he,be=Mt,ve=m):(He=Math.min(ct,$),be=He*Wt*n/a,ve=ke-be);let Vt=He*.28,It=ls(ve,be,t+.5),Et=ds(W,It,He,Vt,o,z),qt=s.getBoundingClientRect();return{x:qt.left+Et.x,y:qt.top+Et.y}}function hi(t,o){if(!Pe()||!k.canUse()||an)return!1;let d=Bt[k.active],C=s.clientWidth,W=s.clientHeight,ct=C*.5,Mt=(C-2*O)/2,Wt=W-m-T,he=6,ke=a*Wt/(he*n),He=W-T,be,ve,Vt;ke<=Math.min(Mt,$)?(be=ke,ve=Wt,Vt=m):(be=Math.min(Mt,$),ve=be*he*n/a,Vt=He-ve);let It=be*.28,Et=null,qt=1/0;for(let Te=0;Te<n;Te++){let Oe=ls(Vt,ve,Te+.5);for(let xe=0;xe<a;xe++){let Fe=yt[Te][xe];if(!Fe||Fe!==d)continue;let We=ds(ct,Oe,be,It,xe,z);if(Math.sin(We.ang)<-.1)continue;let bs=t-We.x,_o=o-We.y,Ro=Math.hypot(bs,_o),Lo=ve/n*.9,Ki=Lo*1.2;Math.abs(bs)<Ki/2&&Math.abs(_o)<Lo/2&&Ro<qt&&(qt=Ro,Et={y:Te,s:xe})}}if(Et){let Te=ls(Vt,ve,Et.y+.5),Oe=ds(ct,Te,be,It,Et.s,z),xe=s.getBoundingClientRect(),Fe=xe.left+Oe.x,We=xe.top+Oe.y,Co=ut[k.active];return ht.spawnMagicShot(k.active,Co,Fe,We,()=>{let bs=yt[Et.y][Et.s];hn=[{y:Et.y,s:Et.s,color:bs,isLine:!1,isMagic:!0}],Wn=performance.now(),an=!0,vn=!0,Ye=0,cn=Re,M(`+${Re}`,"score")}),rn=1,k.useCharge(),J.magicUsed++,!0}return!1}let ga=100;function pa(t,o){return Ks(t,o,n,a)}function vi(){return Zo(yt,n,a)}let yi=Jo;function Si(t){let o=t.map(C=>({...C,color:yt[C.y][C.s]}));for(let C of t)yt[C.y][C.s]=0;let d=n;for(let C of t){let W=C.y;for(let ct=1;ct<=C.y;ct++){let Mt=C.y-ct;if(yt[Mt][C.s]){W=ct-1;break}}d=Math.min(d,W)}for(let C of o)yt[C.y-d][C.s]=C.color;return d>0}function Ei(){let t=!0;for(;t;){t=!1;let o=vi();for(let d of o)yi(d)||Si(d)&&(t=!0)}}function Mi(){us()}let Vn=jo;function Js(t,o){let d=new Map,C=0,W=0,ct=0,Mt={},Wt=t.length+o.length;for(let It of t){let Et=Z[It.color],qt=0,Te=0;if(It.length>=5?(qt=it,Te=U,J.lines5++):It.length===4?(qt=i,Te=K,J.lines4++):It.length===3&&(qt=Pt,Te=V,J.lines3++),Pe()&&Et&&qt>0){k.addCharges(Et,qt),Mt[Et]=(Mt[Et]||0)+qt;let Oe=It.cells[Math.floor(It.cells.length/2)],xe=Is(Oe.y,Oe.s),Fe=ut[Et];for(let We=0;We<qt;We++)setTimeout(()=>{ht.spawnMagicOrb(Et,xe.x,xe.y,Fe)},We*100)}C+=Te*u(),ct+=Te,W+=It.length*Ce;for(let Oe of It.cells){let xe=`${Oe.y},${Oe.s}`;d.has(xe)||d.set(xe,{y:Oe.y,s:Oe.s,color:It.color,isLine:!0})}}for(let It of o){if(J.pairs++,C+=Y*u(),ct+=Y,W+=Tt,Pe()){let Et=[...new Set(It.cells.map(qt=>yt[qt.y][qt.s]).filter(Boolean))];if(Et.length>0){let qt=It.cells[Math.floor(It.cells.length/2)],Te=Is(qt.y,qt.s);Et.forEach((Oe,xe)=>{let Fe=Z[Oe];if(!Fe)return;k.addCharges(Fe,st),Mt[Fe]=(Mt[Fe]||0)+st;let We=ut[Fe];We&&setTimeout(()=>{ht.spawnMagicOrb(Fe,Te.x,Te.y,We)},xe*100)})}}for(let Et of It.cells){let qt=`${Et.y},${Et.s}`;d.has(qt)||d.set(qt,{y:Et.y,s:Et.s,color:yt[Et.y][Et.s],isLine:!1})}}let he=Vn(Ft,Wt-1),ke=Vn(Jt,Wt-1),He=Vn(qe,rn),be=Vn(Ke,rn),ve=Math.round(W*he*He);ct=Math.round(ct*ke*be),C=Math.round(C*ke*be);let Vt=0;Wt>1&&(J.combos++,J.maxCombo=Math.max(J.maxCombo,Wt),setTimeout(()=>M(`COMBO \xD7${Wt}`,"combo"),Vt),Vt+=180,v.play("combo2")),rn>0&&(J.cascades++,J.maxCascade=Math.max(J.maxCascade,rn),setTimeout(()=>M(`CASCADE \xD7${rn}`,"cascade"),Vt),Vt+=180,v.play("cascade")),(t.length>0||o.length>0)&&v.play("combo");for(let It of t){let Et=It.length,qt=Et*Ce;setTimeout(()=>M(`Line-${Et} +${qt}`,"line",It.color),Vt),Vt+=100}for(let It of o){let Et=It.cells.length>0?yt[It.cells[0].y][It.cells[0].s]:null;setTimeout(()=>M(`Pair +${Tt}`,"pair",Et),Vt),Vt+=100}ve>0&&(setTimeout(()=>M(`+${ve}`,"score"),Vt),Vt+=120),ct>0&&(setTimeout(()=>M(`+${ct}s`,"time"),Vt),Vt+=120);for(let[It,Et]of Object.entries(Mt))Et>0&&(setTimeout(()=>M(`+${Et}${gt(It)}`,"charge"),Vt),Vt+=120);hn=Array.from(d.values()),Wn=performance.now(),an=!0,vn=!1,Ye=C,cn=ve,Zt()}function bi(){let t=vn;for(let o of hn)yt[o.y][o.s]=0;if(hn.length>0&&v.playRandom("disappear"),Ye>0){R+=Ye;let o=Ye/u();Dn.spawnBonusBubbles(o)}At.addScore(cn),$t+=cn,Kn(),hn=[],an=!1,vn=!1,Ye=0,cn=0,t||rn++,us()}function us(){Ei();let{lineMatches:t,pairMatches:o}=wi();if(t.length>0||o.length>0)Js(t,o);else{let d=io();d.length>0?Bi(d):!h&&P==="playing"&&oo()}}function ma(t,o){Js(t,o)}function fs(t){return Nn(t,a)}function gs(){return fs(Math.round(z))}function to(t,o){return zs(h,t,o,yt,n,a)}function ps(t){return to(t,gs())}let ms=Qo;function eo(){I&&(Ot!==0&&G>=Ot||(B=0,G+=1))}function Ti(){if(!h)return;let t=h.cells,o=h.colors,d={cells:t,colors:o};if(Dt>=0||(d=ms(d.cells,d.colors),d=ms(d.cells,d.colors)),d=ms(d.cells,d.colors),h.cells=d.cells,h.colors=d.colors,!ps(Math.floor(y))){h.cells=t,h.colors=o;return}v.play("turn"),w&&eo()}function xi(){return ti(h,y,gs(),yt,n,a)}function Ci(){if(!h)return!1;let t=Math.floor(y)-1,o=!ps(t);return o&&!w?(w=!0,B=0,G=0):!o&&w&&(w=!1,B=0,G=0),o}let Ln=Cs;function qn(){if(P==="playing"){Tn.classList.add("hidden"),ue.classList.remove("hidden");return}if(Tn.classList.remove("hidden"),ue.classList.add("hidden"),P==="intro"){Gn.classList.remove("hidden"),Rs.classList.add("hidden");let t=mt.loadHighscore(_);t.score>0?(A.textContent=t.score.toLocaleString(),F.textContent=Ln(t.time)):(A.textContent="0",F.textContent="0:00"),Us(),tt.textContent=`v${N}`,le.classList.remove("idlePulse"),le.offsetWidth,le.classList.add("idlePulse")}else{Gn.classList.add("hidden"),Rs.classList.remove("hidden"),Jn.textContent=$t.toLocaleString(),gn.textContent=Ln(ye);let t=mt.loadHighscore(_);$t>0&&$t>=t.score?In.classList.remove("hidden"):In.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${J.rings}</span>
          <span class="count ring-max">${J.maxRing>0?"max \xD7"+J.maxRing:""}</span>
        </div>
      `;ts.innerHTML=o;let d=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${J.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${J.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${J.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${J.pairs}</span>
        </div>
      `;es.innerHTML=d;let C=Pe()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${J.magicUsed}</span>
        </div>
      `:"",W=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${J.combos}</span>
          <span class="count max-combo">${J.maxCombo>0?"max \xD7"+J.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${J.cascades}</span>
          <span class="count max-cascade">${J.maxCascade>0?"max \xD7"+J.maxCascade:""}</span>
        </div>
        ${C}
      `;Bn.innerHTML=W}}function Kn(){nn.textContent=`Score: ${$t}`}function As(){xn.textContent=`Time: ${Ln(ye)}`}function no(){let t=Math.max(0,(n-X)/u()),o=Math.floor(t/60),d=Math.floor(t%60);Qe.textContent=`Left: ${o}:${d.toString().padStart(2,"0")}`,t<30?Qe.classList.add("warning"):Qe.classList.remove("warning")}function _i(){p(_),Hn(),X=0,R=0,z=j=0,ft=0,At.start(),J=At.stats,$t=0,$e=performance.now(),ye=0,dn=0,je=0,P="playing",re=null,Pe()?k.reset():(k.deactivate(),Object.keys(k.charges).forEach(t=>{k.charges[t]=0}),Zt()),me.reset(),rs(),hn=[],On=[],an=!1,vn=!1,kn=!1,Ye=0,cn=0,rn=0,mn.reset(),Zt(),Kn(),As(),no(),Bs(),oo(),Dn.drawNextPreview(Se,re),qn(),v.getSettings().musicEnabled&&v.startGameMusic()}function ws(){At.gameOver(),P="gameover",h=null,w=!1,B=0,G=0;let t=mt.saveHighscore($t,ye,_);v.stopMusic(),v.play("gameover"),As(),qn(),t&&$t>0&&setTimeout(()=>{M("\u{1F3C6} NEW RECORD!","score")},500)}function Ri(t){for(let d=0;d<50;d++){let C=t.map(()=>1+(Math.random()*4|0));if(!Li(t,C))return C}return t.map((d,C)=>1+C%4)}let Li=si;function so(t){let o=t.cells.map(C=>({x:C.x,y:C.y})),d=Ri(o);return{name:t.name,cells:o,colors:d}}function oo(){if(!re){let W=E[Math.random()*E.length|0];re=so(W)}h=re;let t=E[Math.random()*E.length|0];re=so(t),Dn.drawNextPreview(Se,re);let o=1/0,d=-1/0;for(let W of h.cells)W.x<o&&(o=W.x),W.x>d&&(d=W.x);let C=(o+d)/2;for(let W of h.cells)W.x=W.x-Math.round(C);y=n+3,x=0,w=!1,B=0,G=0,ps(Math.floor(y))?v.playRandom("appear"):ws()}function io(){return ni(yt,n,a)}function Bi(t){if(t.length===0)return;let o=[];for(let Wt of t)for(let he=0;he<a;he++)o.push({y:Wt,s:he,color:yt[Wt][he],isLine:!1});On=t,hn=o,Wn=performance.now(),an=!0,kn=!0,vn=!1;let d=t.length;J.rings+=d,J.maxRing=Math.max(J.maxRing,d);let C=Vn(ee,d-1),W=Math.round(pt*d*C),ct=Yt*d;if(cn=W,Ye=ct*u(),Pe()){for(let[Wt,he]of Object.entries(ie))if(he>0){let ke=he*d;k.addCharges(Wt,ke);let He=Math.floor(a/2),be=t[0],ve=Is(be,He),Vt=ut[Wt];if(Vt)for(let It=0;It<ke;It++)setTimeout(()=>{ht.spawnMagicOrb(Wt,ve.x,ve.y,Vt)},It*100)}}v.play("ring");let Mt=`RING \xD7${d}`;M(Mt,"ring"),setTimeout(()=>M(`+${W}`,"score"),150),setTimeout(()=>M(`+${ct}s`,"time"),300)}function Ii(){let t=[...On].sort((o,d)=>d-o);for(let o of t){for(let d=o;d<n-1;d++)yt[d].set(yt[d+1]);yt[n-1].fill(0)}if(Ye>0){R+=Ye;let o=Ye/u();Dn.spawnBonusBubbles(o)}At.addScore(cn),$t+=cn,Kn(),_==="30_24"&&On.length>0&&(te=mt.addHighTowerRings(On.length)),hn=[],On=[],an=!1,kn=!1,Ye=0,cn=0,us()}function ha(){return io().length}function Ai(){if(!h)return;let t=gs();z=t,j=t,ft=0;let o=!1;for(let d=0;d<h.cells.length;d++){let C=h.cells[d],W=h.colors[d],ct=Math.floor(y)+C.y,Mt=fs(t+C.x);ct>=n&&(o=!0),ct>=0&&ct<n&&(yt[ct][Mt]=W)}if(o){ws();return}At.addScore(se),$t+=se,Kn(),M(`+${se}`,"score"),v.playRandom("drop"),h=null,rn=0,Mi()}function wi(){return ei(yt,n,a)}function Pi(){if(!h)return!1;let t=Math.floor(y)-1;return ps(t)?(y=t,w=!1,B=0,G=0,!0):(w=!0,!1)}s.addEventListener("pointerdown",t=>{if(Ut.state!=="playing")return;t.preventDefault?.();let o=s.getBoundingClientRect(),d=t.clientX-o.left,C=t.clientY-o.top;b.handlePointerDown(t,{onMagicTap:Pe()?()=>mn.handleTap(d,C)?!0:Ut.applyCommand("magic_shoot",{x:d,y:C}):null,onDoubleTap:()=>Ut.applyCommand("rotate_piece")},j)||(ft=0)},{passive:!1}),s.addEventListener("pointermove",t=>{if(Ut.state!=="playing"||!b.dragging)return;t.preventDefault?.();let o=b.handlePointerMove(t,{canRotateTo:(d,C)=>Ut.canRotateTo(d,C),onDrop:()=>Ut.applyCommand("move_down"),onGroundedMove:()=>Ut.onGroundedMove(),onRotateStep:()=>ln.trigger("tower_rotate")},Ut.pieceY,Ut.isGrounded);o&&Ut.setRotation(o.targetRot)},{passive:!1}),s.addEventListener("pointerup",t=>{Ut.state==="playing"&&b.handlePointerUp(t,{onSingleTap:()=>Ut.applyCommand("rotate_piece")})},{passive:!1}),s.addEventListener("pointercancel",t=>{b.handlePointerUp(t)},{passive:!1}),s.addEventListener("pointerleave",t=>{b.dragging&&b.handlePointerUp(t)},{passive:!1}),Mn.addEventListener("click",()=>{Ut.state==="playing"&&Ut.applyCommand("rotate_piece")});let hs=e.dropBtn,vs=null;function ki(){Ut.state==="playing"&&(Ut.applyCommand("move_down"),vs=setInterval(()=>{if(Ut.state!=="playing"){ys();return}Ut.applyCommand("move_down")},zt))}function ys(){vs&&(clearInterval(vs),vs=null)}hs.addEventListener("pointerdown",t=>{t.preventDefault(),ki()}),hs.addEventListener("pointerup",ys),hs.addEventListener("pointerleave",ys),hs.addEventListener("pointercancel",ys);for(let[t,o]of Object.entries(ut))o.addEventListener("click",()=>{Ut.state==="playing"&&Pe()&&Ut.applyCommand("select_magic",{element:t})});Lt&&Lt.addEventListener("click",()=>{if(Ut.state!=="playing"||!cs()||!Pe())return;let t=k.active??An;if(!t)return;let o=Xe[t];!o||!Rn(o)||(me.selectSpell(o),k.active&&(An=k.active,os=!0,k.deactivate()),mn.handleSpellButtonClick())});let Ps=e.soundsToggle,ks=e.musicToggle;function bn(){let t=v.getSettings();t.soundsEnabled?Ps.classList.add("active"):Ps.classList.remove("active"),t.musicEnabled?ks.classList.add("active"):ks.classList.remove("active");for(let o=0;o<=4;o++){let d=e.soundVolBtns[o],C=e.musicVolBtns[o];d&&d.classList.toggle("active",t.soundVolume===o),C&&C.classList.toggle("active",t.musicVolume===o)}}let ao=e.tabBtns,Oi=e.tabContents;ao.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;ao.forEach(d=>d.classList.remove("active")),Oi.forEach(d=>d.classList.remove("active")),t.classList.add("active"),Ho(o).classList.add("active"),o==="sounds"&&bn()})});let co=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,ro=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Di=e.iosHint,Ni=e.standaloneBadge;function lo(){let t=document.fullscreenElement||document.webkitFullscreenElement;fn.textContent=t?"Disable":"Enable"}co&&(ro?(Ni.style.display="block",fn.style.display="none"):(Di.style.display="block",fn.textContent="Not supported",fn.style.opacity="0.5",fn.style.cursor="default")),fn.addEventListener("click",()=>{if(co&&!ro)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",()=>{lo();let t=document.fullscreenElement||document.webkitFullscreenElement;document.documentElement.classList.toggle("is-fullscreen",!!t)}),document.addEventListener("webkitfullscreenchange",()=>{lo();let t=document.fullscreenElement||document.webkitFullscreenElement;document.documentElement.classList.toggle("is-fullscreen",!!t)});let Ss=e.invertSwipeToggle,yn=e.hapticsToggle;xt.invertSwipe&&Ss.classList.add("active"),yn&&(ln.supports()?xt.hapticsEnabled&&yn.classList.add("active"):(yn.classList.add("disabled"),yn.classList.remove("active"),xt.hapticsEnabled=!1,ln.setEnabled(!1),mt.saveGameSettings(xt))),Ss.addEventListener("click",()=>{Ss.classList.toggle("active");let t=Ss.classList.contains("active");b.rotDir=t?-1:1,xt.invertSwipe=t,mt.saveGameSettings(xt)}),yn&&yn.addEventListener("click",()=>{if(yn.classList.contains("disabled"))return;yn.classList.toggle("active");let t=yn.classList.contains("active");xt.hapticsEnabled=t,mt.saveGameSettings(xt),ln.setEnabled(t)});let zn=e.showControlsToggle,Hi=e.controlsRight;function uo(t){Hi.style.display=t?"":"none",tn=t}tn?zn.classList.add("active"):zn.classList.remove("active"),uo(tn),zn.addEventListener("click",()=>{zn.classList.toggle("active");let t=zn.classList.contains("active");uo(t),xt.showControls=t,mt.saveGameSettings(xt)});let Es=e.tapRotateToggle;en&&Es.classList.add("active"),b.tapRotateEnabled=en,Es.addEventListener("click",()=>{Es.classList.toggle("active");let t=Es.classList.contains("active");en=t,b.tapRotateEnabled=t,xt.tapRotate=t,mt.saveGameSettings(xt)}),Ps.addEventListener("click",()=>{let o=!v.getSettings().soundsEnabled;v.updateSettings({soundsEnabled:o}),bn(),jn()}),ks.addEventListener("click",()=>{let o=!v.getSettings().musicEnabled;v.updateSettings({musicEnabled:o}),bn(),jn(),P!=="paused"&&(o?P==="playing"?v.startGameMusic():v.startMenuMusic():v.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{v.updateSettings({soundVolume:t}),bn(),v.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{v.updateSettings({musicVolume:t}),bn()})}bn();function fo(){P==="playing"&&(At.pause(),je=performance.now(),P="paused",v.musicAudio&&v.musicAudio.pause())}function Ms(){P==="paused"&&(At.resume(),dn+=performance.now()-je,je=0,P="playing",Ns=performance.now(),v.getSettings().musicEnabled&&v.startGameMusic())}function jn(){let t=v.getSettings();fe.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",fe.classList.toggle("off",!t.soundsEnabled),Ze.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Ze.classList.toggle("off",!t.musicEnabled)}function Fi(){Le.classList.remove("hidden"),ue.classList.add("hidden");let t=mt.loadHighscore(_);if(ge.textContent=t.score?t.score.toLocaleString():"0",Ge.textContent=t.time?Cs(t.time):"0:00",En.textContent=_==="30_24"?"High Tower":"Quick Tower",Ee.textContent=$t.toLocaleString(),on.textContent=Cs(ye),pe.textContent=_==="30_24"?"High Tower":"Quick Tower",jn(),vo){let o=_==="30_24";vo.style.display=o?"":"none",o&&Us()}}function Qn(){Le.classList.add("hidden"),ue.classList.remove("hidden")}ue.addEventListener("click",()=>{fo(),Fi()}),Cn.addEventListener("click",()=>{Qn(),Ms()});let Os=null;function go(t,o){Ue.textContent=t,Os=o,Be.classList.remove("hidden")}function po(){Be.classList.add("hidden"),Os=null}Fn.addEventListener("click",()=>{po()}),$n.addEventListener("click",()=>{let t=Os;po(),t&&t()}),Sn.addEventListener("click",()=>{go("Restart game?",()=>{Qn(),Ut.applyCommand("start_game")})}),sn.addEventListener("click",()=>{go("Exit to menu?",()=>{Qn(),ue.classList.add("hidden"),P="intro",At.reset(),v.stopMusic(),v.getSettings().musicEnabled&&v.startMenuMusic(),qn()})}),Ne.addEventListener("click",()=>{un.classList.remove("hidden")}),fe.addEventListener("click",()=>{let t=v.getSettings();v.updateSettings({soundsEnabled:!t.soundsEnabled}),jn(),bn()}),Ze.addEventListener("click",()=>{let o=!v.getSettings().musicEnabled;v.updateSettings({musicEnabled:o}),jn(),bn()}),Le.addEventListener("click",t=>{t.target===Le&&(Qn(),Ms())}),document.addEventListener("keydown",t=>{P==="paused"&&!Le.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Qn(),Ms())}),_s.addEventListener("click",()=>{un.classList.add("hidden")}),un.addEventListener("click",t=>{t.target===un&&un.classList.add("hidden")});let Ds=!1;document.addEventListener("visibilitychange",()=>{document.hidden?P==="playing"&&(fo(),Ds=!0):Ds&&P==="paused"&&(Ms(),Ds=!1)});let Ut=oi({getN:()=>a,getH:()=>n,FALL_INTERVAL:Gt,LOCK_DELAY_SEC:kt,getKillRate:u,MATCH_HIGHLIGHT_SEC:D,MAGIC_SHRINK_SEC:lt,RING_HIGHLIGHT_SEC:Ht,getState:()=>({gameState:P,score:$t,elapsedMs:ye,startTime:$e,totalPausedMs:dn,stats:J,activePiece:h,pieceY:y,targetRot:j,rotFloat:z,rotVel:ft,isGrounded:w,isHighlighting:an,isMagicAnimation:vn,isRingAnimation:kn,highlightStartTime:Wn,killLevel:X,grid:yt,fallTimer:x,lockTimer:B}),setState:t=>{"elapsedMs"in t&&(ye=t.elapsedMs),"killLevel"in t&&(X=t.killLevel),"fallTimer"in t&&(x=t.fallTimer),"lockTimer"in t&&(B=t.lockTimer),"targetRot"in t&&(j=t.targetRot),"rotFloat"in t&&(z=t.rotFloat),"rotVel"in t&&(ft=t.rotVel)},funcs:{startGame:_i,endGame:ws,rotatePieceByDir:Ti,tryMoveDown:Pi,canPlaceAtRot:to,maybeResetLockDelay:eo,shootMagic:hi,selectMagic:Nt,updateGroundedState:Ci,lockPiece:Ai,finishHighlight:bi,finishRingHighlight:Ii},ui:{updateTimeHud:As,updateRemainingHud:no}}),Dn=ii({canvas:s,canvasCtx:r,getN:()=>a,getH:()=>n,TOP_PAD_PX:m,BOTTOM_PAD_PX:T,SIDE_MARGIN_PX:O,MAX_RADIUS_X:$,RADIUS_X_FACTOR:Q,ANG_OFFSET:l,MATCH_HIGHLIGHT_SEC:D,MATCH_SHRINK_PHASE:jt,MAGIC_SHRINK_SEC:lt,RING_HIGHLIGHT_SEC:Ht,LOCK_DELAY_SEC:kt,getKillRate:u,ELEMENT_COLORS:at,ELEMENT_TO_COLOR:Bt,BLOCK_COLOR_FRONT:vt,BLOCK_COLOR_BACK:wt,ACTIVE_COLOR_FRONT:ne,GHOST_COLOR_FILL:Kt,GHOST_COLOR_STROKE:_t,GHOST_STROKE_WIDTH:Xt,MAGIC_DIM_DOT_ALPHA:Qt,MAGIC_DIM_DOT_SCALE:ae,MAGIC_TARGET_DOT_SCALE:bt,getState:()=>({gameState:P,grid:yt,activePiece:h,pieceY:y,rotFloat:z,killLevel:X,isHighlighting:an,highlightedCells:hn,highlightStartTime:Wn,isMagicAnimation:vn,isRingAnimation:kn,isGrounded:w,lockTimer:B,spellState:mn.getRenderState()}),getVisualSettings:()=>({waterBubbles:ot,waterColor:ce}),funcs:{snappedRot:gs,computeGhostY:xi,normSector:fs,getMagicTargetColor:()=>Pe()&&k.canUse()?Bt[k.active]:null,getTransmuteAnimState:t=>mn.getTransmuteAnimState(t),getLightningAnimState:t=>mn.getLightningAnimState(t),getFireAnimState:t=>mn.getFireAnimState(t)}}),Ns=performance.now();function mo(t){let o=Math.min(.05,Math.max(.001,(t-Ns)/1e3));if(Ns=t,Ut.update(o,t),mn.update(t),R>0){let d=Math.min(R,St*o);X=Math.max(0,X-d),R-=d}z=j,z>1e6&&(z%=a),z<-1e6&&(z%=a),Dn.render(o,t),requestAnimationFrame(mo)}le.addEventListener("click",()=>{Ut.applyCommand("start_game")}),ns.addEventListener("click",()=>{Ut.applyCommand("start_game")});function $i(){P="intro",At.reset(),v.stopMusic(),v.getSettings().musicEnabled&&v.startMenuMusic(),qn()}ss.addEventListener("click",()=>{$i()}),q.forEach(t=>{t.addEventListener("click",o=>{q.forEach(C=>C.classList.remove("active")),t.classList.add("active"),_=t.dataset.mode,rs(),as();let d=mt.loadHighscore(_);d.score>0?(A.textContent=d.score.toLocaleString(),F.textContent=Ln(d.time)):(A.textContent="0",F.textContent="0:00"),le.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>le.classList.add("idlePulse"),2e3)})});let Hs=document.querySelectorAll(".spell-select-btn"),Fs=document.getElementById("spellDesc"),Gi=document.getElementById("spellProgressFill"),ho=document.getElementById("spellProgressMarkers"),vo=document.getElementById("pauseSpellProgress"),Ui=document.getElementById("pauseSpellProgressFill"),yo=document.getElementById("pauseSpellProgressMarkers"),So=document.getElementById("pauseSpellProgressLabel");function $s(){return pn.map(t=>_n(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Gs(t){return t.length?Math.max(...t):0}function Xi(t){let o=$s(),d=Gs(o);return d<=0?"":`${Math.min(t,d)}/${d}`}function Eo(t){if(!t)return;t.innerHTML="";let o=$s(),d=Gs(o);o.forEach(C=>{let W=document.createElement("span");W.className="marker",W.dataset.threshold=C;let ct=d>0?C/d*100:0;W.style.left=`${ct}%`,t.appendChild(W)})}function Mo(t,o){if(!t)return;let d=Yi(o);t.style.width=`${d}%`}function bo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(C=>{let W=parseInt(C.dataset.threshold,10)||0;C.classList.toggle("reached",o>=W)})}function Yi(t){let o=$s(),d=Gs(o);return t<=0||d<=0?0:t>=d?100:t/d*100}function To(t){if(!Fs)return;let o=_n(t),d=me.getDescription(t);o===0||te>=o?Fs.innerHTML=d:Fs.innerHTML=`${d} <span class="spell-progress-text">${te}/${o}</span>`}function Us(){te=mt.loadHighTowerRings(),Hs.forEach(o=>{let d=o.dataset.spell,C=_n(d),W=te>=C;o.classList.toggle("locked",!W);let ct=o.querySelector(".spell-lock");ct&&(ct.style.display=W?"none":"")}),Mo(Gi,te),Mo(Ui,te),bo(ho,te),bo(yo,te),So&&(So.textContent=Xi(te));let t=document.querySelector(".spell-select-btn.active");t&&To(t.dataset.spell)}Eo(ho),Eo(yo),Us(),Hs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let d=document.querySelector('.mode-btn[data-mode="30_24"]');if(d&&!d.classList.contains("active")){q.forEach(Wt=>Wt.classList.remove("active")),d.classList.add("active"),_="30_24",rs(),as();let Mt=mt.loadHighscore(_);Mt.score>0?(A.textContent=Mt.score.toLocaleString(),F.textContent=Ln(Mt.time)):(A.textContent="0",F.textContent="0:00")}let C=t.dataset.spell,W=_n(C),ct=te>=W;To(C),ct&&(Hs.forEach(Mt=>Mt.classList.remove("active")),t.classList.add("active"),me.selectSpell(C),Un(k.active))})}),et.addEventListener("click",()=>{let t=mt.loadHighscore("30_24"),o=mt.loadHighscore("25_20"),d=`Records

`;d+=`High Tower (30\xD724):
`,d+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ln(t.time)}
`:`  No record yet
`,d+=`
Quick Tower (25\xD720):
`,d+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Ln(o.time)}
`:`  No record yet
`,alert(d)}),nt.addEventListener("click",()=>{un.classList.remove("hidden")}),Zt(),as(),rs(),qn(),v.startMenuMusic();let Wi=()=>{if(v.unlock(),!v.getSettings().musicEnabled)return;let t=v.musicAudio;!t||t.paused||t.ended?Ut.state==="playing"?v.startGameMusic():v.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},xo=0,Vi=10,qi=()=>{xo>=Vi||(xo++,Wi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,qi,{passive:!0})}),requestAnimationFrame(mo)})();})();
