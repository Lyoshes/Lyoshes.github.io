(()=>{var es=[0,.25,.5,.75,1],ns=[0,.05,.15,.25,.5],os={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},Jn={menu:"music/mm.mp3",game:"sounds/amb1.wav"},jn="soundSettings";function ss(){try{let e=localStorage.getItem(jn);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function is(e){try{localStorage.setItem(jn,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Qn(){return{audioContext:null,buffers:{},settings:ss(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=n,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return es[this.settings.soundVolume]},getMusicVolume(){return ns[this.settings.musicVolume]},async loadSound(n,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(l)).arrayBuffer(),o=await this.audioContext.decodeAudioData(i);this.buffers[n]=o}catch(u){console.debug(`Failed to load sound: ${n} from ${l}`,u)}},preload(){this.initContext();for(let[n,l]of Object.entries(os))this.loadSound(n,l)},play(n,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;l!==null&&(u=`${n}${l}`);let i=this.buffers[u];if(i)try{let o=this.audioContext.createGain();o.gain.value=this.getSoundVolume(),o.connect(this.audioContext.destination);let s=this.audioContext.createBufferSource();s.buffer=i,s.connect(o),s.start(0),s.onended=()=>{s.disconnect(),o.disconnect()}}catch(o){console.debug("Sound play failed:",o)}},playRandom(n){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(n,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Jn.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Jn.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},is(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var to="eb_highscore",eo="eb_settings",cs={invertSwipe:!1,difficulty:"easy"};function no(){return{loadHighscore(){try{let e=localStorage.getItem(to);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load highscore:",e)}return{score:0,time:0}},saveHighscore(e,n){try{let l=this.loadHighscore();if(e>l.score||e===l.score&&n>l.time)return localStorage.setItem(to,JSON.stringify({score:e,time:n})),!0}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(eo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...cs}},saveGameSettings(e){try{localStorage.setItem(eo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}}}}function oo(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function so(e){return document.getElementById("tab-"+e)}var io={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function co(e={}){let{elementColors:n={}}=e,l=0;return{showBonus(u,i="score",o=null){let s=document.createElement("div");s.className=`bonus-popup ${i}`,s.textContent=u,o&&n[o]&&(s.style.color=n[o]);let r=window.innerWidth/2,f=window.innerHeight/2-40,p=(Math.random()-.5)*200,g=(Math.random()-.5)*100+l*36;s.style.left=`${r+p}px`,s.style.top=`${f+g}px`,s.style.transform="translate(-50%, -50%)",document.body.appendChild(s),l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{s.remove()},1800)},getElementIcon(u){return io[u]||"\u2726"},spawnMagicOrb(u,i,o,s){if(!s)return;let r=document.createElement("div");r.className=`magic-orb ${u}`,r.textContent=io[u]||"\u2726";let f=s.getBoundingClientRect(),p=f.left+f.width/2-i,g=f.top+f.height/2-o,S=Math.hypot(p,g),z=Math.atan2(g,p),P=S*.35*(Math.random()>.5?1:-1),J=z+Math.PI/2,O=p*.5+Math.cos(J)*P,R=g*.5+Math.sin(J)*P;r.style.setProperty("--mid-x",`${O}px`),r.style.setProperty("--mid-y",`${R}px`),r.style.setProperty("--end-x",`${p}px`),r.style.setProperty("--end-y",`${g}px`),r.style.left=`${i}px`,r.style.top=`${o}px`,document.body.appendChild(r),setTimeout(()=>{r.remove(),s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))},700)}}}function ao(e={}){let{buttons:n={},onActivate:l=null}=e,u={fire:3,water:3,lightning:3,earth:3},i=null;function o(){for(let[s,r]of Object.entries(n)){if(!r)continue;let f=u[s],p=r.querySelector(".charges");p&&(p.textContent=f),r.classList.toggle("empty",f<=0),r.classList.toggle("active",i===s&&f>0)}}return{get charges(){return u},get active(){return i},set active(s){i=s},select(s){if(u[s]<=0)return!1;let r=i===s;return i=r?null:s,o(),!r&&i===s&&l&&l(),!r},useCharge(){return!i||u[i]<=0?!1:(u[i]--,i=null,o(),!0)},addCharges(s,r){u[s]!==void 0&&(u[s]+=r,o())},canUse(){return i!==null&&u[i]>0},deactivate(){i=null,o()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,i=null,o()},updateButtons:o,initButtons(s){for(let[r,f]of Object.entries(n))f&&f.addEventListener("click",()=>{s&&s(r)})}}}var as={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function ro(e={}){let{canvas:n}=e,l=e.rotDir||1,u=!1,i=0,o=0,s=0,r=0,f=0,p=1,g=null,S=0,z=0,P=0,J=0,O=0,R=0,Bt=0,_t=0,K=as;return{get rotDir(){return l},set rotDir(A){l=A},get dragging(){return u},get dragMode(){return g},handlePointerDown(A,nt,de){if(nt.onMagicTap&&nt.onMagicTap(A.clientX,A.clientY))return!0;let Dt=performance.now(),Yt=Dt-R,vt=A.clientX-Bt,Et=A.clientY-_t,ee=Math.hypot(vt,Et);return Yt<=K.DOUBLE_TAP_MS&&ee<=K.DOUBLE_TAP_MAX_DIST?(nt.onDoubleTap&&nt.onDoubleTap(),R=0):(R=Dt,Bt=A.clientX,_t=A.clientY),u=!0,p=-1,i=A.clientX,o=A.clientY,s=de,r=0,f=0,g=null,S=Dt,z=A.clientX,P=A.clientY,J=S,O=0,n&&n.setPointerCapture(A.pointerId),!1},handlePointerMove(A,nt,de,Dt){if(!u)return null;let Yt=A.clientX-i,vt=A.clientY-o,Et=performance.now();if(Math.abs(Yt)<K.DEADZONE_PX&&Math.abs(vt)<K.DEADZONE_PX)return null;if(!g){let Tt=Math.abs(Yt),dt=Math.abs(vt);if(vt<0)Tt>=K.DEADZONE_PX&&(g="rotate");else if(dt>=Tt*K.AXIS_DOMINANCE){if(dt>=K.DROP_SWIPE_MIN_DISTANCE){let a=Math.max(1,Et-S);dt/a*1e3>=K.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else Tt>=dt*K.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let ee=null;if(g==="rotate"&&Math.abs(Yt)>=K.DEADZONE_PX){let Tt=Math.max(1,Et-J),dt=A.clientX-z,a=Math.max(1,Math.abs(dt)/Tt*1e3),Wt=Math.max(K.MIN_ROT_PX,Math.min(K.MAX_ROT_PX,K.PX_PER_STEP*(K.SWIPE_SPEED_REF/a)));O+=-dt/Wt*l*p;let ht=Math.trunc(O);ht!==0&&(O-=ht);let kt=r+ht;if(kt!==r&&nt.canRotateTo){let ne=Math.sign(kt-r),oe=s+r;for(;r!==kt;){let ye=r+ne,Ct=s+ye;if(!nt.canRotateTo(Math.floor(de),Ct))break;r=ye,oe=Ct,Dt&&nt.onGroundedMove&&nt.onGroundedMove()}ee={targetRot:oe,rotFloat:oe}}}if(g==="drop"&&vt>K.DEADZONE_PX&&nt.onDrop){let Tt=Math.max(1,Et-J),dt=A.clientY-P,a=Math.max(1,dt/Tt*1e3),Wt=Math.max(K.MIN_DROP_PX,Math.min(K.MAX_DROP_PX,K.PX_PER_DROP*(K.SWIPE_SPEED_REF/a))),ht=Math.trunc(vt/Wt);if(ht>f){let kt=ht-f;for(let ne=0;ne<kt;ne++)nt.onDrop();f=ht}}return z=A.clientX,P=A.clientY,J=Et,ee},handlePointerUp(A){if(u&&(u=!1,g=null,n&&A&&A.pointerId!==void 0))try{n.releasePointerCapture(A.pointerId)}catch{}},reset(){u=!1,g=null,r=0,f=0,O=0}}}var vn={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function lo(){let e="intro",n=0,l=0,u=0,i=0,o=0,s={...vn};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return l},get stats(){return s},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,l=performance.now(),u=0,i=0,o=0,s={...vn}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(o+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){n+=r},setScore(r){n=r},updateTime(){e==="playing"&&l>0&&(u=performance.now()-l-o)},getFormattedTime(){let r=Math.floor(u/1e3),f=Math.floor(r/60),p=r%60;return`${f}:${p.toString().padStart(2,"0")}`},incrementStat(r,f=1){r in s&&(s[r]+=f)},updateMaxStat(r,f){r in s&&f>s[r]&&(s[r]=f)},reset(){e="intro",n=0,l=0,u=0,i=0,o=0,s={...vn}}}}function _e(e,n){return e%=n,e<0&&(e+=n),e}function uo(e,n){return e[Math.min(n,e.length-1)]}function je(e){let n=Math.max(0,Math.floor(e/1e3)),l=Math.floor(n/60),u=n%60;return`${l}:${u.toString().padStart(2,"0")}`}function mo(e,n){let l=e.map(({x:r,y:f},p)=>({x:f,y:-r,color:n[p]})),u=1/0,i=-1/0,o=1/0;for(let r of l)u=Math.min(u,r.x),i=Math.max(i,r.x),o=Math.min(o,r.y);let s=Math.round((u+i)/2);for(let r of l)r.x-=s,r.y-=o;return l.sort((r,f)=>r.y-f.y||r.x-f.x),{cells:l.map(r=>({x:r.x,y:r.y})),colors:l.map(r=>r.color)}}function Cn(e,n,l,u){let i=[];return e+1<l&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:_e(n-1,u)}),i.push({y:e,s:_e(n+1,u)}),i}function go(e,n,l){let u=Array.from({length:n},()=>new Uint8Array(l)),i=[];for(let o=0;o<n;o++)for(let s=0;s<l;s++){if(!e[o][s]||u[o][s])continue;let r=[],f=[{y:o,s}];for(u[o][s]=1;f.length>0;){let p=f.shift();r.push(p);for(let g of Cn(p.y,p.s,n,l))e[g.y][g.s]&&!u[g.y][g.s]&&(u[g.y][g.s]=1,f.push(g))}i.push(r)}return i}function fo(e){return e.some(n=>n.y===0)}function bn(e,n,l,u,i,o){if(!e)return!1;let s=_e(l,o);for(let r of e.cells){let f=n+r.y,p=_e(s+r.x,o);if(f<0)return!1;if(!(f>=i)&&u[f][p])return!1}return!0}function po(e,n,l,u,i,o){if(!e)return null;let s=Math.floor(n);for(;bn(e,s-1,l,u,i,o);)s-=1;return s}function ho(e,n,l){let u=[],i=[];for(let o=0;o<n;o++){let s=[],r=0,f=e[o][0],p=f?1:0;for(let g=1;g<=l;g++){let S=g<l?e[o][g]:0;S&&S===f?p++:(p>=1&&f&&s.push({start:r,length:p,color:f}),r=g,f=S,p=S?1:0)}if(s.length>=2){let g=s[0],S=s[s.length-1];if(g.start===0&&S.start+S.length===l&&g.color===S.color){let z=g.length+S.length;s[0]={start:S.start,length:z,color:g.color},s.pop()}}for(let g of s)if(g.length>=3){let S=[];for(let z=0;z<g.length;z++)S.push({y:o,s:(g.start+z)%l});u.push({color:g.color,length:g.length,cells:S})}}for(let o=0;o<l;o++){let s=0,r=e[0][o],f=r?1:0;for(let p=1;p<=n;p++){let g=p<n?e[p][o]:0;if(g&&g===r)f++;else{if(f>=3&&r){let S=[];for(let z=0;z<f;z++)S.push({y:s+z,s:o});u.push({color:r,length:f,cells:S})}s=p,r=g,f=g?1:0}}}for(let o=0;o<n;o++)for(let s=0;s<l;s++){let r=e[o][s],f=e[o][(s+1)%l],p=e[o][(s+2)%l],g=e[o][(s+3)%l];r&&r===f&&p&&p===g&&r!==p&&i.push({cells:[{y:o,s},{y:o,s:(s+1)%l},{y:o,s:(s+2)%l},{y:o,s:(s+3)%l}]})}for(let o=0;o<l;o++)for(let s=0;s<n-3;s++){let r=e[s][o],f=e[s+1][o],p=e[s+2][o],g=e[s+3][o];r&&r===f&&p&&p===g&&r!==p&&i.push({cells:[{y:s,s:o},{y:s+1,s:o},{y:s+2,s:o},{y:s+3,s:o}]})}return{lineMatches:u,pairMatches:i}}function yo(e,n,l){let u=[];for(let i=0;i<n;i++){let o=!0;for(let s=0;s<l;s++)if(!e[i][s]){o=!1;break}o&&u.push(i)}return u}function Eo(e,n){let l=new Map;e.forEach((u,i)=>l.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],o=n[u],s=1;for(let R=1;R<=2&&l.get(`${i.x+R},${i.y}`)===o;R++)s++;if(s>=3)return!0;let r=1;for(let R=1;R<=2&&l.get(`${i.x},${i.y+R}`)===o;R++)r++;if(r>=3)return!0;let f=o,p=l.get(`${i.x+1},${i.y}`),g=l.get(`${i.x+2},${i.y}`),S=l.get(`${i.x+3},${i.y}`);if(f&&p&&g&&S&&f===p&&g===S&&f!==g)return!0;let z=o,P=l.get(`${i.x},${i.y+1}`),J=l.get(`${i.x},${i.y+2}`),O=l.get(`${i.x},${i.y+3}`);if(z&&P&&J&&O&&z===P&&J===O&&z!==J)return!0}return!1}function So(e){let{N:n,H:l,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,KILL_RATE:o,MATCH_HIGHLIGHT_SEC:s,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:f,getState:p,setState:g,funcs:S,ui:z}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(P,J={}){let O=p();if(P==="start_game")return O.gameState!=="playing"?(S.startGame(),!0):!1;if(O.gameState!=="playing")return!1;switch(P){case"rotate_piece":return S.rotatePieceByDir(),!0;case"move_down":return S.tryMoveDown();case"rotate_cylinder":{let{rot:R}=J;return typeof R=="number"&&S.canPlaceAtRot(Math.floor(O.pieceY),R)?(g({targetRot:R,rotFloat:R,rotVel:0}),O.isGrounded&&S.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:R,y:Bt}=J;return S.shootMagic(R,Bt)}case"select_magic":{let{element:R}=J;return S.selectMagic(R),!0}default:return console.warn("GameEngine: unknown command",P),!1}},update(P,J){let O=p();if(O.gameState!=="playing")return;let R=J-O.startTime-O.totalPausedMs;g({elapsedMs:R}),z.updateTimeHud();let Bt=O.killLevel+o*P;if(g({killLevel:Bt}),Bt>=l){S.endGame();return}if(O.isHighlighting){let A=(J-O.highlightStartTime)/1e3,nt;O.isRingAnimation?nt=f:O.isMagicAnimation?nt=r:nt=s,A>=nt&&(O.isRingAnimation?S.finishRingHighlight():S.finishHighlight())}let _t=O.fallTimer+P;if(_t>=u&&(_t-=u,S.tryMoveDown()),g({fallTimer:_t}),S.updateGroundedState()){let A=O.lockTimer+P;g({lockTimer:A}),A>=i&&S.lockPiece()}},reset(){S.startGame()},canRotateTo(P,J){return S.canPlaceAtRot(P,J)},getRotation(){let P=p();return{targetRot:P.targetRot,rotFloat:P.rotFloat,rotVel:P.rotVel}},setRotation(P){g({targetRot:P,rotFloat:P,rotVel:0})},onGroundedMove(){S.maybeResetLockDelay()}}}var Ot=Math.PI*2;function Mo(e){let{canvas:n,canvasCtx:l,N:u,H:i,TOP_PAD_PX:o,BOTTOM_PAD_PX:s,MAX_RADIUS_X:r,RADIUS_X_FACTOR:f,ANG_OFFSET:p,MATCH_HIGHLIGHT_SEC:g,MATCH_SHRINK_PHASE:S,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:P,LOCK_DELAY_SEC:J,KILL_RATE:O,ELEMENT_COLORS:R,ELEMENT_TO_COLOR:Bt,BLOCK_COLOR_FRONT:_t,BLOCK_COLOR_BACK:K,ACTIVE_COLOR_FRONT:A,GHOST_COLOR_FILL:nt,GHOST_COLOR_STROKE:de,GHOST_STROKE_WIDTH:Dt,MAGIC_DIM_DOT_ALPHA:Yt,MAGIC_DIM_DOT_SCALE:vt,MAGIC_TARGET_DOT_SCALE:Et,getState:ee,getVisualSettings:Tt,funcs:dt}=e,a=l,Wt={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},ht=[],kt=15,ne=2;function oe(_,b,M,B,C,I,y){for(ht=ht.filter(m=>m.y>_+m.size);ht.length<kt;){let m=Math.random()>.5?"left":"right",E=10,q=m==="left"?E+Math.random()*(b-E*2):M+E+Math.random()*(C-M-E*2),L=B+20+Math.random()*100;ht.push({x:q,baseX:q,y:L,size:1.5+Math.random()*3,speedFactor:.9+Math.random()*.2,wobble:Math.random()*Math.PI*2,wobbleSpeed:.4+Math.random()*.4,wobbleAmp:3+Math.random()*4,side:m,minX:m==="left"?E:M+E,maxX:m==="left"?b-E:C-E})}let T=I*ne;for(let m of ht){m.y-=T*m.speedFactor*y,m.wobble+=m.wobbleSpeed*y;let E=m.baseX+Math.sin(m.wobble)*m.wobbleAmp;m.x=Math.max(m.minX,Math.min(m.maxX,E))}}function ye(_){a.fillStyle="rgba(255, 255, 255, 0.25)",a.strokeStyle="rgba(255, 255, 255, 0.4)",a.lineWidth=1;for(let b of ht)b.y<_+b.size||(a.beginPath(),a.arc(b.x,b.y,b.size,0,Math.PI*2),a.fill(),a.stroke())}function Ct(_,b,M){let B=1-M/i;return _+B*b}function Ee(_){return _=_%u,_<0?_+u:_}function Se(_,b,M,B,C,I){let y=Ee(I),T=(C-y)/u*Ot+p;return{x:_+Math.cos(T)*M,y:b+Math.sin(T)*B,ang:T}}let De=.52,Qe=1.02;function It(_,b,M,B,C,I){let y=Ee(I),T=(C-y)/u*Ot+p;return{x:_+Math.cos(T)*M,y:b+Math.sin(T)*B,ang:T}}function tn(_,b,M,B,C,I,y,T=1){let m=It(_,b,M,B,C-De,I),E=It(_,b,M,B,C+De,I),q={x:m.x,y:m.y-y*.5},L={x:m.x,y:m.y+y*.5},j={x:E.x,y:E.y-y*.5},at={x:E.x,y:E.y+y*.5},G=(q.x+j.x+at.x+L.x)*.25,N=(q.y+j.y+at.y+L.y)*.25,mt=Qe*T,gt=T,H=[q,j,at,L].map(ot=>({x:G+(ot.x-G)*mt,y:N+(ot.y-N)*gt})),bt=Math.abs((E.x-m.x)*mt),Gt=Math.abs(y*gt);return{corners:H,cx:G,cy:N,wApprox:bt,hApprox:Gt,ang:It(_,b,M,B,C,I).ang}}function se(_,b,M,B,C,I,y,T,m=1,E=null,q=1,L=null,j=0,at=1,G=1){let N=tn(_,b,M,B,C,I,y,G),[mt,gt,H,bt]=N.corners;if(a.save(),a.globalAlpha=m,a.fillStyle=T,a.beginPath(),a.moveTo(mt.x,mt.y),a.lineTo(gt.x,gt.y),a.lineTo(H.x,H.y),a.lineTo(bt.x,bt.y),a.closePath(),a.fill(),L&&j>0&&(a.strokeStyle=L,a.lineWidth=j,a.stroke()),E){let Gt=Math.min(N.wApprox,N.hApprox)*.28*at;a.globalAlpha=m*q,a.fillStyle=E,a.beginPath(),a.arc(N.cx,N.cy,Gt,0,Ot),a.fill()}a.restore(),a.globalAlpha=1}function en(_,b,M,B,C,I){let y=Se(_,b,M,B,C,I),T=Se(_,b,M,B,C+1,I),m=Se(_,b,M,B,C-1,I),E=Math.abs(T.x-y.x),q=Math.abs(y.x-m.x),L=(E+q)*.5*1.06;return Math.max(1,L)}function nn(_,b,M,B,C,I){let y=(C-I)/u*Ot+p;return{x:_+Math.cos(y)*M,y:b+Math.sin(y)*B,ang:y}}function on(_,b,M,B,C,I,y,T=1,m=null,E=1,q=null,L=0,j=1){a.save(),a.translate(_,b);let at=Math.atan2(B,M);if(a.rotate(at),a.globalAlpha=T,a.fillStyle=y,a.fillRect(-C/2,-I/2,C,I),q&&L>0&&(a.strokeStyle=q,a.lineWidth=L,a.strokeRect(-C/2,-I/2,C,I)),m){let G=Math.min(C,I)*.28*j;a.globalAlpha=T*E,a.fillStyle=m,a.beginPath(),a.arc(0,0,G,0,Ot),a.fill()}a.restore(),a.globalAlpha=1}return{resize(){let _=Math.max(1,Math.min(2,window.devicePixelRatio||1)),b=Math.floor(n.clientWidth*_),M=Math.floor(n.clientHeight*_);(n.width!==b||n.height!==M)&&(n.width=b,n.height=M,a.setTransform(_,0,0,_,0,0))},render(_=.016){this.resize();let b=ee(),M=n.clientWidth,B=n.clientHeight;a.clearRect(0,0,M,B),a.fillStyle="#0b0f14",a.fillRect(0,0,M,B);let C=M*.5,I=o,y=B-s,T=Math.max(1,y-I),m=Math.min(M*f,r),E=m*.28,{killLevel:q,rotFloat:L,grid:j,gameState:at}=b,G=Tt?Tt():{},N=G.waterColor||"blue",mt=G.waterBubbles||!1,gt=Wt[N]||Wt.blue,H=Ct(I,T,q),bt=.7,Gt=q/i,ot={...gt.top},h={...gt.bottom};if(Gt>bt){let x=(Gt-bt)/(1-bt);ot.r=Math.round(ot.r+(255-ot.r)*x*.5),ot.g=Math.round(ot.g+(150-ot.g)*x*.5),ot.b=Math.round(ot.b+(150-ot.b)*x*.5),h.r=Math.round(h.r+(180-h.r)*x),h.g=Math.round(h.g*(1-x*.6)),h.b=Math.round(h.b*(1-x*.6))}let rt=C-m-8,U=C+m+8,yt=I,Ht=y+5,At=a.createLinearGradient(0,H,0,B);At.addColorStop(0,`rgba(${ot.r},${ot.g},${ot.b},0.5)`),At.addColorStop(1,`rgba(${h.r},${h.g},${h.b},0.7)`),a.fillStyle=At;let Me=Math.round((ot.r+h.r)/2),Te=Math.round((ot.g+h.g)/2),Kt=Math.round((ot.b+h.b)/2),X=m+8,Le=E+4;a.fillRect(0,H,rt,B-H),a.fillRect(U,H,M-U,B-H),a.beginPath();let ie=Math.max(H,Ht);if(a.moveTo(rt,ie),H<=Ht+Le?a.ellipse(C,Ht,X,Le,0,Math.PI,0,!1):a.lineTo(U,ie),a.lineTo(U,B),a.lineTo(rt,B),a.closePath(),a.fill(),a.strokeStyle="rgba(100,180,255,0.6)",a.lineWidth=3,a.lineCap="round",a.beginPath(),a.moveTo(rt,yt),a.lineTo(rt,Ht),a.stroke(),a.beginPath(),a.moveTo(U,yt),a.lineTo(U,Ht),a.stroke(),a.beginPath(),a.ellipse(C,Ht,m+8,E+4,0,0,Math.PI),a.stroke(),a.fillStyle="#0b0f14",a.beginPath(),a.ellipse(C,Ht,m+8,E+4,0,0,Ot),a.fill(),q>.5&&(a.strokeStyle=`rgba(${Math.min(255,Me+60)},${Math.min(255,Te+40)},${Math.min(255,Kt+40)},0.6)`,a.lineWidth=2,a.beginPath(),a.moveTo(0,H),a.lineTo(rt,H),a.moveTo(U,H),a.lineTo(M,H),a.stroke()),mt&&q>.5){let x=O*T/i;oe(H,rt,U,B,M,x,_),ye(H)}a.strokeStyle="rgba(160,190,220,0.3)",a.lineWidth=1;let ft=Ot*m,ke=10,_n=ft/ke*.7,Tn=ft/ke*.3;a.setLineDash([_n,Tn]);let ce=ft/u;a.lineDashOffset=Ee(L)*ce;for(let x=0;x<=i;x++){let k=Ct(I,T,x);a.beginPath(),a.ellipse(C,k,m,E,0,0,Ot),a.stroke()}a.setLineDash([]);let Ge=[],Be=[];for(let x=0;x<i;x++){let k=Ct(I,T,x+.5);for(let V=0;V<u;V++){let Y=j[x][V];if(!Y)continue;let F=Se(C,k,m,E,V,L),st=Math.sin(F.ang),D={y:x,s:V,yScr:k,p:F,depth:st,color:Y};st<-.1?Ge.push(D):Be.push(D)}}let He=dt.getMagicTargetColor(),{isHighlighting:me,highlightedCells:ge,highlightStartTime:Ft,isMagicAnimation:qt}=b,fe=null,xe=1,ve=1,Fe=!1;if(me&&ge.length>0){fe=new Set(ge.map(k=>`${k.y},${k.s}`));let x=(performance.now()-Ft)/1e3;if(qt){let k=Math.min(1,x/z);xe=1-k*.85,ve=1-k*.9,Fe=!0}else{let k=Math.min(1,x/g),V=1-S;if(k>V){let Y=(k-V)/S;xe=1-Y*.85,ve=1-Y*.9,Fe=!0}}}Ge.sort((x,k)=>x.depth-k.depth);for(let x of Ge){let k=T/i*.9,V=R[x.color]||null,Y=.35,F=1,st=`${x.y},${x.s}`;fe&&fe.has(st)&&(Y*=ve,F=xe),se(C,x.yScr,m,E,x.s,L,k,K,Y,V,.5,null,0,1,F)}let{isRingAnimation:$t}=b;if(me&&ge.length>0&&!qt){let x=(performance.now()-Ft)/1e3,V=Math.min(1,x/($t?P:g)),Y=1-S,F=V>Y,st=F?(V-Y)/S:0,D=$t?Math.floor(V*Y*u*2)%u:-1,w=4+V/Y*10,it=Math.sin(x*w*Ot),pt=F?1:.3+it*.3,lt=F?1-st*.8:1,St=F?1-st:1;for(let ct of ge){let zt=Ct(I,T,ct.y+.5),Ie=It(C,zt,m,E,ct.s,L);if(Math.sin(Ie.ang)>=-.1)continue;let Ae=T/i*.9,Mt,Zt,Jt;if($t){let ae=(ct.s-D+u)%u,re=ae<3?1-ae/3:0;Mt=(F?St:.2+re*.5)*.5,Zt=`rgba(255, 159, 67, ${Mt})`,Jt=F?lt:1+re*.15}else Mt=pt*St,Zt=ct.isLine?`rgba(255, 255, 255, ${Mt*.5})`:`rgba(255, 220, 100, ${Mt*.4})`,Jt=F?lt:1.1;se(C,zt,m,E,ct.s,L,Ae,Zt,1,null,1,null,0,1,Jt)}}Be.sort((x,k)=>x.depth-k.depth);for(let x of Be){let k=T/i*.9,V=R[x.color]||null,Y=1,F=1,st=1,D=1,w=`${x.y},${x.s}`,it=fe&&fe.has(w);it&&(Y=ve,F=xe),He!==null&&!it&&(x.color!==He?(st=Yt,D=vt):D=Et),se(C,x.yScr,m,E,x.s,L,k,_t,Y,V,st,null,0,D,F)}if(me&&ge.length>0&&!qt){let x=(performance.now()-Ft)/1e3,V=Math.min(1,x/($t?P:g)),Y=1-S,F=V>Y,st=F?(V-Y)/S:0,D=$t?Math.floor(V*Y*u*2)%u:-1,w=4+V/Y*10,it=Math.sin(x*w*Ot),pt=F?1:.5+it*.5,lt=F?1-st*.8:1,St=F?1-st:1;for(let ct of ge){let zt=Ct(I,T,ct.y+.5),Ie=It(C,zt,m,E,ct.s,L);if(Math.sin(Ie.ang)<-.1)continue;let Ae=T/i*.9,Mt,Zt,Jt;if($t){let ae=(ct.s-D+u)%u,re=ae<4?1-ae/4:0;Mt=F?St:.3+re*.7,Zt=`rgba(255, 159, 67, ${Mt})`,Jt=F?lt:1+re*.2}else Mt=pt*St,Zt=ct.isLine?`rgba(255, 255, 255, ${Mt*.7})`:`rgba(255, 220, 100, ${Mt*.6})`,Jt=F?lt:1.15;se(C,zt,m,E,ct.s,L,Ae,Zt,1,null,1,null,0,1,Jt)}}let{activePiece:Rt,pieceY:sn,isGrounded:cn,lockTimer:$e}=b;if(Rt){let x=dt.snappedRot(),k=x,V=dt.computeGhostY(),Y=T/i*.9;if(V!==null){let D=[];for(let w=0;w<Rt.cells.length;w++){let it=Rt.cells[w],pt=Rt.colors[w],lt=V+it.y,St=dt.normSector(x+it.x);if(lt<0||lt>=i)continue;let ct=Ct(I,T,lt+.5),zt=It(C,ct,m,E,St,k);D.push({cy:lt,cs:St,yScr:ct,depth:Math.sin(zt.ang),color:pt})}D.sort((w,it)=>w.depth-it.depth);for(let w of D){let it=R[w.color]||null;se(C,w.yScr,m,E,w.cs,k,Y,nt,1,it,.5,de,Dt,1,1)}}let F=A;if(cn&&$e>0){let D=Math.min(1,$e/J),w=255,it=Math.round(170+85*D),pt=Math.round(180+75*D),lt=.75+(1-.75)*D;F=`rgba(${w},${it},${pt},${lt})`}let st=[];for(let D=0;D<Rt.cells.length;D++){let w=Rt.cells[D],it=Rt.colors[D],pt=dt.normSector(x+w.x),lt=sn+w.y;if(lt<0||lt>=i)continue;let St=Ct(I,T,lt+.5),ct=It(C,St,m,E,pt,k);st.push({cs:pt,yScr:St,depth:Math.sin(ct.ang),color:it})}st.sort((D,w)=>D.depth-w.depth);for(let D of st){let w=R[D.color]||null;se(C,D.yScr,m,E,D.cs,k,Y,F,1,w,1,null,0,1,1)}}},drawNextPreview(_,b){if(!_)return;let M=_.getContext("2d"),B=_.width,C=_.height;if(M.clearRect(0,0,B,C),!b)return;let I=1/0,y=-1/0,T=1/0,m=-1/0;for(let G of b.cells)I=Math.min(I,G.x),y=Math.max(y,G.x),T=Math.min(T,G.y),m=Math.max(m,G.y);let E=y-I+1,q=m-T+1,L=Math.min(B/(E+.5),C/(q+.5)),j=(B-E*L)/2,at=(C-q*L)/2;M.fillStyle=_t;for(let G=0;G<b.cells.length;G++){let N=b.cells[G],mt=j+(N.x-I)*L,gt=at+(q-1-(N.y-T))*L;M.fillRect(mt+1,gt+1,L-2,L-2);let H=b.colors[G],bt=R[H];if(bt){let Gt=(L-2)*.32;M.fillStyle=bt,M.beginPath(),M.arc(mt+L/2,gt+L/2,Gt,0,Ot),M.fill(),M.fillStyle=_t}}}}}(()=>{let e=oo(),n=e.canvas,l=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,o=24,s=Math.PI/2,r=18,f=90,p=260,g=.36,S="rgb(235,240,250)",z="rgb(55,62,75)",P="rgba(255,170,180,0.75)",J="rgba(110,255,150,0.15)",O="rgba(110,255,150,0.85)",R=2,Bt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},_t={1:"fire",2:"water",3:"lightning",4:"earth"},K={fire:1,water:2,lightning:3,earth:4},A=1,nt=.58,de=!0,Dt=12,Yt=25,vt=120,Et=o/vt,ee=1,Tt=2,dt=3,a=5,Wt=8,ht=10,kt=15,ne=30,oe=2,ye=.3,Ct=.5,Ee=1,Se=.3,De=.5,Qe=1.3,It=10,tn=500,se=[1,1.25,1.5,1.75,2],en=10,nn=100,on=25,_=[1,1.3,1.6,2],b=[1,1.5,2,2.5],M=no(),B=M.loadGameSettings(),C=B.invertSwipe?-1:1,I=-1,y=Array.from({length:o},()=>new Uint8Array(i)),T=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],m=null,E=o+3,q=0,L=0,j=!1,at=0,G=0,N=0,mt=0,gt=0,H=ro({canvas:n,rotDir:C}),bt="0.12.2",Gt=!0,ot="blue",h=Qn();h.preload();let rt=lo(),U="intro",yt=0,Ht=0,At=0,Me=0,Te=0,Kt=null,X=rt.stats,Le=e.overlay,ie=co({elementColors:Bt}),ft=ie.showBonus.bind(ie),ke=ie.getElementIcon.bind(ie),_n=e.overlayTitle,Tn=e.overlayStats,ce=e.startBtn,Ge=e.hud,Be=e.scoreHud,He=e.timeHud,me=e.nextCanvas,ge=me.getContext("2d"),Ft=e.pauseBtn,qt=e.pauseOverlay,fe=e.resumeBtn,xe=e.restartBtn,ve=e.exitToMenuBtn,Fe=e.pauseSettingsBtn,$t=e.pauseSoundBtn,Rt=e.pauseMusicBtn,sn=e.pauseBestScore,cn=e.pauseBestTime,$e=e.pauseBestMode,x=e.pauseCurrentScore,k=e.pauseCurrentTime,V=e.pauseCurrentMode,Y=e.confirmDialog,F=e.confirmText,st=e.confirmCancel,D=e.confirmOk,w=e.settingsOverlay,it=e.settingsClose,pt=e.fullscreenBtn,lt=e.rotateBtn,St=e.startPanel,ct=e.gameoverPanel,zt=e.goScore,Ie=e.goTime,an=e.goMatches,Ae=e.goBonuses,Mt=e.goNewRecord,Zt=e.goRestartBtn,Jt=e.goExitBtn,ae=e.bestScore,re=e.bestExtra,xo=e.surviveVal,vo=e.startVersion,Ln=e.modeBtns,Co=e.recordsBtn,bo=e.startSettingsBtn,_o=e.helpBtn,rn="30_24",Nt=ao({buttons:e.magicBtns,onActivate:()=>h.play("spells")}),Bn=e.magicBtns,ls=Nt.charges,To=t=>Nt.select(t),ln=()=>Nt.updateButtons(),jt=[],Re=0,Qt=!1,pe=!1,we=!1,Ut=0,Xt=0,le=0,Ne=[];function In(t,c,d){let v=1-d/o;return t+v*c}function An(t,c,d,v,W,Q){let ut=(W-Q)/i*u+s;return{x:t+Math.cos(ut)*d,y:c+Math.sin(ut)*v,ang:ut}}function Lo(t,c){let d=n.clientWidth,v=n.clientHeight,W=d*.5,Q=r,ut=v-f,wt=Math.max(1,ut-Q),Lt=Math.min(d*g,p),Ce=Lt*.28,he=In(Q,wt,t+.5),tt=An(W,he,Lt,Ce,c,N);return{x:tt.x,y:tt.y}}function Bo(t,c){if(!Nt.canUse()||Qt)return!1;let d=K[Nt.active],v=n.clientWidth,W=n.clientHeight,Q=v*.5,ut=r,wt=W-f,Lt=Math.max(1,wt-ut),Ce=Math.min(v*g,p),he=Ce*.28,tt=null,et=1/0;for(let $=0;$<o;$++){let xt=In(ut,Lt,$+.5);for(let Pt=0;Pt<i;Pt++){let Vt=y[$][Pt];if(!Vt||Vt!==d)continue;let te=An(Q,xt,Ce,he,Pt,N);if(Math.sin(te.ang)<-.1)continue;let be=t-te.x,qn=c-te.y,zn=Math.hypot(be,qn),Zn=Lt/o*.9,ts=Zn*1.2;Math.abs(be)<ts/2&&Math.abs(qn)<Zn/2&&zn<et&&(et=zn,tt={y:$,s:Pt})}}if(tt){let $=y[tt.y][tt.s];return jt=[{y:tt.y,s:tt.s,color:$,isLine:!1,isMagic:!0}],Re=performance.now(),Qt=!0,pe=!0,Ut=0,Xt=on,ft(`+${on}`,"score"),le=0,Nt.useCharge(),X.magicUsed++,!0}return!1}let us=100;function ds(t,c){return Cn(t,c,o,i)}function Io(){return go(y,o,i)}let Ao=fo;function Ro(t){let c=t.map(v=>({...v,color:y[v.y][v.s]}));for(let v of t)y[v.y][v.s]=0;let d=o;for(let v of t){let W=v.y;for(let Q=1;Q<=v.y;Q++){let ut=v.y-Q;if(y[ut][v.s]){W=Q-1;break}}d=Math.min(d,W)}for(let v of c)y[v.y-d][v.s]=v.color;return d>0}function wo(){let t=!0;for(;t;){t=!1;let c=Io();for(let d of c)Ao(d)||Ro(d)&&(t=!0)}}function Po(){dn()}let un=uo;function Rn(t,c){let d=new Map,v=0,W=0,Q=0,ut={},wt=t.length+c.length;for(let et of t){let $=_t[et.color],xt=0,Pt=0;if(et.length>=5?(xt=dt,Pt=ht,X.lines5++):et.length===4?(xt=Tt,Pt=Wt,X.lines4++):et.length===3&&(xt=ee,Pt=a,X.lines3++),$&&xt>0){Nt.addCharges($,xt),ut[$]=(ut[$]||0)+xt;let Vt=et.cells[Math.floor(et.cells.length/2)],te=Lo(Vt.y,Vt.s),Kn=Bn[$];for(let be=0;be<xt;be++)setTimeout(()=>{ie.spawnMagicOrb($,te.x,te.y,Kn)},be*100)}v+=Pt*Et,Q+=Pt,W+=et.length*en;for(let Vt of et.cells){let te=`${Vt.y},${Vt.s}`;d.has(te)||d.set(te,{y:Vt.y,s:Vt.s,color:et.color,isLine:!0})}}for(let et of c){X.pairs++,v+=kt*Et,Q+=kt,W+=nn;for(let $ of et.cells){let xt=`${$.y},${$.s}`;d.has(xt)||d.set(xt,{y:$.y,s:$.s,color:y[$.y][$.s],isLine:!1})}}let Lt=un(_,wt-1),Ce=un(b,le),he=Math.round(W*Lt*Ce),tt=0;wt>1&&(X.combos++,X.maxCombo=Math.max(X.maxCombo,wt),setTimeout(()=>ft(`COMBO \xD7${wt}`,"combo"),tt),tt+=180,h.play("combo2")),le>0&&(X.cascades++,X.maxCascade=Math.max(X.maxCascade,le),setTimeout(()=>ft(`CASCADE \xD7${le}`,"cascade"),tt),tt+=180,h.play("cascade")),(t.length>0||c.length>0)&&h.play("combo");for(let et of t){let $=et.length,xt=$*en;setTimeout(()=>ft(`Line-${$} +${xt}`,"line",et.color),tt),tt+=100}for(let et of c){let $=et.cells.length>0?y[et.cells[0].y][et.cells[0].s]:null;setTimeout(()=>ft(`Pair +${nn}`,"pair",$),tt),tt+=100}he>0&&(setTimeout(()=>ft(`+${he}`,"score"),tt),tt+=120),Q>0&&(setTimeout(()=>ft(`+${Q}s`,"time"),tt),tt+=120);for(let[et,$]of Object.entries(ut))$>0&&(setTimeout(()=>ft(`+${$}${ke(et)}`,"charge"),tt),tt+=120);jt=Array.from(d.values()),Re=performance.now(),Qt=!0,pe=!1,Ut=v,Xt=he,ln()}function Oo(){for(let t of jt)y[t.y][t.s]=0;jt.length>0&&h.playRandom("disappear"),Ut>0&&(G=Math.max(0,G-Ut)),rt.addScore(Xt),yt+=Xt,We(),jt=[],Qt=!1,pe=!1,Ut=0,Xt=0,le++,dn()}function dn(){wo();let{lineMatches:t,pairMatches:c}=Vo();if(t.length>0||c.length>0)Rn(t,c);else{let d=kn();d.length>0?No(d):!m&&U==="playing"&&Dn()}}function ms(t,c){Rn(t,c)}function mn(t){return _e(t,i)}function Ue(){return mn(Math.round(N))}function wn(t,c){return bn(m,t,c,y,o,i)}function Xe(t){return wn(t,Ue())}let Ve=mo;function Pn(){de&&(Dt!==0&&at>=Dt||(L=0,at+=1))}function Do(){if(!m)return;let t=m.cells,c=m.colors,d={cells:t,colors:c};if(I>=0||(d=Ve(d.cells,d.colors),d=Ve(d.cells,d.colors)),d=Ve(d.cells,d.colors),m.cells=d.cells,m.colors=d.colors,!Xe(Math.floor(E))){m.cells=t,m.colors=c;return}h.play("turn"),j&&Pn()}function ko(){return po(m,E,Ue(),y,o,i)}function Go(){if(!m)return!1;let t=Math.floor(E)-1,c=!Xe(t);return c&&!j?(j=!0,L=0,at=0):!c&&j&&(j=!1,L=0,at=0),c}let Ye=je;function Pe(){if(U==="playing"){Le.classList.add("hidden"),Ft.classList.remove("hidden");return}if(Le.classList.remove("hidden"),Ft.classList.add("hidden"),U==="intro"){St.classList.remove("hidden"),ct.classList.add("hidden");let t=Math.floor(vt/60),c=vt%60;xo.textContent=`${t}:${c.toString().padStart(2,"0")}`;let d=M.loadHighscore();d.score>0?(ae.textContent=d.score.toLocaleString(),re.textContent=`(${Ye(d.time)})`):(ae.textContent="0",re.textContent=""),vo.textContent=`v${bt}`,ce.classList.remove("idlePulse"),ce.offsetWidth,ce.classList.add("idlePulse")}else{St.classList.add("hidden"),ct.classList.remove("hidden"),zt.textContent=yt.toLocaleString(),Ie.textContent=Ye(At);let t=M.loadHighscore();yt>0&&yt>=t.score?Mt.classList.remove("hidden"):Mt.classList.add("hidden");let c=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${X.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${X.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${X.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${X.pairs}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2B55</span>
          <span class="name">Ring</span>
          <span class="count">\xD7${X.rings}</span>
        </div>
      `;an.innerHTML=c;let d=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${X.combos}</span>
          <span class="count">${X.maxCombo>0?"max \xD7"+X.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${X.cascades}</span>
          <span class="count">${X.maxCascade>0?"max \xD7"+X.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${X.magicUsed}</span>
        </div>
      `;Ae.innerHTML=d}}function We(){Be.textContent=`Score: ${yt}`}function gn(){He.textContent=`Time: ${Ye(At)}`}function Ho(){for(let t=0;t<o;t++)y[t].fill(0);G=0,N=mt=0,gt=0,rt.start(),yt=0,Ht=performance.now(),At=0,Te=0,Me=0,U="playing",Kt=null,Nt.reset(),jt=[],Ne=[],Qt=!1,pe=!1,we=!1,Ut=0,Xt=0,le=0,ln(),We(),gn(),Dn(),Mn.drawNextPreview(me,Kt),Pe(),h.getSettings().musicEnabled&&h.startGameMusic()}function fn(){rt.gameOver(),U="gameover",m=null,j=!1,L=0,at=0;let t=M.saveHighscore(yt,At);h.stopMusic(),h.play("gameover"),setTimeout(()=>{(U==="gameover"||U==="intro")&&h.startMenuMusic()},2500),gn(),Pe(),t&&yt>0&&setTimeout(()=>{ft("\u{1F3C6} NEW RECORD!","score")},500)}function Fo(t){for(let d=0;d<50;d++){let v=t.map(()=>1+(Math.random()*4|0));if(!$o(t,v))return v}return t.map((d,v)=>1+v%4)}let $o=Eo;function On(t){let c=t.cells.map(v=>({x:v.x,y:v.y})),d=Fo(c);return{name:t.name,cells:c,colors:d}}function Dn(){if(!Kt){let W=T[Math.random()*T.length|0];Kt=On(W)}m=Kt;let t=T[Math.random()*T.length|0];Kt=On(t),Mn.drawNextPreview(me,Kt);let c=1/0,d=-1/0;for(let W of m.cells)W.x<c&&(c=W.x),W.x>d&&(d=W.x);let v=(c+d)/2;for(let W of m.cells)W.x=W.x-Math.round(v);E=o+3,q=0,j=!1,L=0,at=0,Xe(Math.floor(E))?h.playRandom("appear"):fn()}function kn(){return yo(y,o,i)}function No(t){if(t.length===0)return;let c=[];for(let wt of t)for(let Lt=0;Lt<i;Lt++)c.push({y:wt,s:Lt,color:y[wt][Lt],isLine:!1});Ne=t,jt=c,Re=performance.now(),Qt=!0,we=!0,pe=!1;let d=t.length;X.rings+=d;let v=un(se,d-1),W=Math.round(tn*d*v),Q=ne*d;Xt=W,Ut=Q*Et,h.play("ring");let ut=`RING \xD7${d}`;ft(ut,"ring"),setTimeout(()=>ft(`+${W}`,"score"),150),setTimeout(()=>ft(`+${Q}s`,"time"),300)}function Uo(){let t=[...Ne].sort((c,d)=>d-c);for(let c of t){for(let d=c;d<o-1;d++)y[d].set(y[d+1]);y[o-1].fill(0)}Ut>0&&(G=Math.max(0,G-Ut)),rt.addScore(Xt),yt+=Xt,We(),jt=[],Ne=[],Qt=!1,we=!1,Ut=0,Xt=0,dn()}function gs(){return kn().length}function Xo(){if(!m)return;let t=Ue();N=t,mt=t,gt=0;let c=!1;for(let d=0;d<m.cells.length;d++){let v=m.cells[d],W=m.colors[d],Q=Math.floor(E)+v.y,ut=mn(t+v.x);Q>=o&&(c=!0),Q>=0&&Q<o&&(y[Q][ut]=W)}if(c){fn();return}rt.addScore(It),yt+=It,We(),ft(`+${It}`,"score"),h.playRandom("drop"),m=null,le=0,Po()}function Vo(){return ho(y,o,i)}function Yo(){if(!m)return!1;let t=Math.floor(E)-1;return Xe(t)?(E=t,j=!1,L=0,at=0,!0):(j=!0,!1)}n.addEventListener("pointerdown",t=>{if(Z.state!=="playing")return;t.preventDefault?.(),H.handlePointerDown(t,{onMagicTap:(d,v)=>Z.applyCommand("magic_shoot",{x:d,y:v}),onDoubleTap:()=>Z.applyCommand("rotate_piece")},mt)||(gt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Z.state!=="playing"||!H.dragging)return;t.preventDefault?.();let c=H.handlePointerMove(t,{canRotateTo:(d,v)=>Z.canRotateTo(d,v),onDrop:()=>Z.applyCommand("move_down"),onGroundedMove:()=>Z.onGroundedMove()},Z.pieceY,Z.isGrounded);c&&Z.setRotation(c.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Z.state==="playing"&&H.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{H.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{H.dragging&&H.handlePointerUp(t)},{passive:!1}),lt.addEventListener("click",()=>{Z.state==="playing"&&Z.applyCommand("rotate_piece")});let Ke=e.dropBtn,qe=null;function Wo(){Z.state==="playing"&&(Z.applyCommand("move_down"),qe=setInterval(()=>{if(Z.state!=="playing"){ze();return}Z.applyCommand("move_down")},Yt))}function ze(){qe&&(clearInterval(qe),qe=null)}Ke.addEventListener("pointerdown",t=>{t.preventDefault(),Wo()}),Ke.addEventListener("pointerup",ze),Ke.addEventListener("pointerleave",ze),Ke.addEventListener("pointercancel",ze);for(let[t,c]of Object.entries(Bn))c.addEventListener("click",()=>{Z.state==="playing"&&Z.applyCommand("select_magic",{element:t})});let pn=e.soundsToggle,hn=e.musicToggle;function ue(){let t=h.getSettings();t.soundsEnabled?pn.classList.add("active"):pn.classList.remove("active"),t.musicEnabled?hn.classList.add("active"):hn.classList.remove("active");for(let c=0;c<=4;c++){let d=e.soundVolBtns[c],v=e.musicVolBtns[c];d&&d.classList.toggle("active",t.soundVolume===c),v&&v.classList.toggle("active",t.musicVolume===c)}}let Gn=e.tabBtns,Ko=e.tabContents;Gn.forEach(t=>{t.addEventListener("click",()=>{let c=t.dataset.tab;Gn.forEach(d=>d.classList.remove("active")),Ko.forEach(d=>d.classList.remove("active")),t.classList.add("active"),so(c).classList.add("active"),c==="sounds"&&ue()})});let Hn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Fn=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,qo=e.iosHint,zo=e.standaloneBadge;function $n(){let t=document.fullscreenElement||document.webkitFullscreenElement;pt.textContent=t?"Disable":"Enable"}Hn&&(Fn?(zo.style.display="block",pt.style.display="none"):(qo.style.display="block",pt.textContent="Not supported",pt.style.opacity="0.5",pt.style.cursor="default")),pt.addEventListener("click",()=>{if(Hn&&!Fn)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let c=document.documentElement;c.requestFullscreen?c.requestFullscreen():c.webkitRequestFullscreen&&c.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",$n),document.addEventListener("webkitfullscreenchange",$n);let Ze=e.invertSwipeToggle;B.invertSwipe&&Ze.classList.add("active"),Ze.addEventListener("click",()=>{Ze.classList.toggle("active");let t=Ze.classList.contains("active");H.rotDir=t?-1:1,B.invertSwipe=t,M.saveGameSettings(B)});let Nn=e.diffBtns;Nn.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Nn.forEach(c=>{c.classList.remove("active");let d=c.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let c=document.createElement("span");c.className="check-icon",c.textContent="\u2713",t.appendChild(c)}})}),pn.addEventListener("click",()=>{let c=!h.getSettings().soundsEnabled;h.updateSettings({soundsEnabled:c}),ue()}),hn.addEventListener("click",()=>{let c=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:c}),ue(),c?Z.state==="playing"?h.startGameMusic():h.startMenuMusic():c||h.stopMusic()});for(let t=0;t<=4;t++){let c=e.soundVolBtns[t];c&&c.addEventListener("click",()=>{h.updateSettings({soundVolume:t}),ue(),h.play("turn")})}for(let t=0;t<=4;t++){let c=e.musicVolBtns[t];c&&c.addEventListener("click",()=>{h.updateSettings({musicVolume:t}),ue()})}ue();function Un(){U==="playing"&&(rt.pause(),Me=performance.now(),U="paused",h.musicAudio&&h.musicAudio.pause())}function Je(){U==="paused"&&(rt.resume(),Te+=performance.now()-Me,Me=0,U="playing",xn=performance.now(),h.getSettings().musicEnabled&&h.startGameMusic())}function yn(){let t=h.getSettings();$t.textContent=t.soundEnabled?"\u{1F50A}":"\u{1F507}",$t.classList.toggle("off",!t.soundEnabled),Rt.textContent=(t.musicEnabled,"\u{1F3B5}"),Rt.classList.toggle("off",!t.musicEnabled)}function Zo(){qt.classList.remove("hidden"),Ft.classList.add("hidden");let t=M.loadHighscore();sn.textContent=t.score?t.score.toLocaleString():"0",cn.textContent=t.time?je(t.time):"0:00",$e.textContent=rn==="30_24"?"High Tower":"Quick Tower",x.textContent=yt.toLocaleString(),k.textContent=je(At),V.textContent=rn==="30_24"?"High Tower":"Quick Tower",yn()}function Oe(){qt.classList.add("hidden"),Ft.classList.remove("hidden")}Ft.addEventListener("click",()=>{Un(),Zo()}),fe.addEventListener("click",()=>{Oe(),Je()});let En=null;function Xn(t,c){F.textContent=t,En=c,Y.classList.remove("hidden")}function Vn(){Y.classList.add("hidden"),En=null}st.addEventListener("click",()=>{Vn()}),D.addEventListener("click",()=>{let t=En;Vn(),t&&t()}),xe.addEventListener("click",()=>{Xn("Restart game?",()=>{Oe(),Z.applyCommand("start_game")})}),ve.addEventListener("click",()=>{Xn("Exit to menu?",()=>{Oe(),Ft.classList.add("hidden"),U="intro",rt.reset(),h.stopMusic(),h.getSettings().musicEnabled&&h.startMenuMusic(),Pe()})}),Fe.addEventListener("click",()=>{w.classList.remove("hidden")}),$t.addEventListener("click",()=>{let t=h.getSettings();h.updateSettings({soundEnabled:!t.soundEnabled}),yn(),ue()}),Rt.addEventListener("click",()=>{let c=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:c}),yn(),ue()}),qt.addEventListener("click",t=>{t.target===qt&&(Oe(),Je())}),document.addEventListener("keydown",t=>{U==="paused"&&!qt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Oe(),Je())}),it.addEventListener("click",()=>{w.classList.add("hidden")}),w.addEventListener("click",t=>{t.target===w&&w.classList.add("hidden")});let Sn=!1;document.addEventListener("visibilitychange",()=>{document.hidden?U==="playing"&&(Un(),Sn=!0):Sn&&U==="paused"&&(Je(),Sn=!1)});let Z=So({N:i,H:o,FALL_INTERVAL:A,LOCK_DELAY_SEC:nt,KILL_RATE:Et,MATCH_HIGHLIGHT_SEC:oe,MAGIC_SHRINK_SEC:Ct,RING_HIGHLIGHT_SEC:Ee,getState:()=>({gameState:U,score:yt,elapsedMs:At,startTime:Ht,totalPausedMs:Te,stats:X,activePiece:m,pieceY:E,targetRot:mt,rotFloat:N,rotVel:gt,isGrounded:j,isHighlighting:Qt,isMagicAnimation:pe,isRingAnimation:we,highlightStartTime:Re,killLevel:G,grid:y,fallTimer:q,lockTimer:L}),setState:t=>{"elapsedMs"in t&&(At=t.elapsedMs),"killLevel"in t&&(G=t.killLevel),"fallTimer"in t&&(q=t.fallTimer),"lockTimer"in t&&(L=t.lockTimer),"targetRot"in t&&(mt=t.targetRot),"rotFloat"in t&&(N=t.rotFloat),"rotVel"in t&&(gt=t.rotVel)},funcs:{startGame:Ho,endGame:fn,rotatePieceByDir:Do,tryMoveDown:Yo,canPlaceAtRot:wn,maybeResetLockDelay:Pn,shootMagic:Bo,selectMagic:To,updateGroundedState:Go,lockPiece:Xo,finishHighlight:Oo,finishRingHighlight:Uo},ui:{updateTimeHud:gn}}),Mn=Mo({canvas:n,canvasCtx:l,N:i,H:o,TOP_PAD_PX:r,BOTTOM_PAD_PX:f,MAX_RADIUS_X:p,RADIUS_X_FACTOR:g,ANG_OFFSET:s,MATCH_HIGHLIGHT_SEC:oe,MATCH_SHRINK_PHASE:ye,MAGIC_SHRINK_SEC:Ct,RING_HIGHLIGHT_SEC:Ee,LOCK_DELAY_SEC:nt,KILL_RATE:Et,ELEMENT_COLORS:Bt,ELEMENT_TO_COLOR:K,BLOCK_COLOR_FRONT:S,BLOCK_COLOR_BACK:z,ACTIVE_COLOR_FRONT:P,GHOST_COLOR_FILL:J,GHOST_COLOR_STROKE:O,GHOST_STROKE_WIDTH:R,MAGIC_DIM_DOT_ALPHA:Se,MAGIC_DIM_DOT_SCALE:De,MAGIC_TARGET_DOT_SCALE:Qe,getState:()=>({gameState:U,grid:y,activePiece:m,pieceY:E,rotFloat:N,killLevel:G,isHighlighting:Qt,highlightedCells:jt,highlightStartTime:Re,isMagicAnimation:pe,isRingAnimation:we,isGrounded:j,lockTimer:L}),getVisualSettings:()=>({waterBubbles:Gt,waterColor:ot}),funcs:{snappedRot:Ue,computeGhostY:ko,normSector:mn,getMagicTargetColor:()=>Nt.canUse()?K[Nt.active]:null}}),xn=performance.now();function Yn(t){let c=Math.min(.05,Math.max(.001,(t-xn)/1e3));xn=t,Z.update(c,t),N=mt,N>1e6&&(N%=i),N<-1e6&&(N%=i),Mn.render(c),requestAnimationFrame(Yn)}ce.addEventListener("click",()=>{Z.applyCommand("start_game")}),Zt.addEventListener("click",()=>{Z.applyCommand("start_game")}),Jt.addEventListener("click",()=>{U="intro",rt.reset(),h.stopMusic(),h.getSettings().musicEnabled&&h.startMenuMusic(),Pe()}),Ln.forEach(t=>{t.addEventListener("click",()=>{Ln.forEach(c=>c.classList.remove("active")),t.classList.add("active"),rn=t.dataset.mode,ce.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ce.classList.add("idlePulse"),2e3)})}),Co.addEventListener("click",()=>{let t=M.loadHighscore();t.score>0?alert(`Records (demo)

Best Score: ${t.score.toLocaleString()}
Time: ${Ye(t.time)}`):alert(`Records (demo)

No records yet. Play to set your first highscore!`)}),bo.addEventListener("click",()=>{w.classList.remove("hidden")}),_o.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),ln(),Pe(),h.startMenuMusic();let Jo=()=>{if(h.unlock(),!h.getSettings().musicEnabled)return;let t=h.musicAudio;!t||t.paused||t.ended?Z.state==="playing"?h.startGameMusic():h.startMenuMusic():t.play().catch(c=>{console.debug("Music resume on interaction failed:",c)})},Wn=0,jo=10,Qo=()=>{Wn>=jo||(Wn++,Jo())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Qo,{passive:!0})}),requestAnimationFrame(Yn)})();})();
