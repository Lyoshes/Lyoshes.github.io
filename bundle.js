(()=>{var $i=[0,.25,.5,.75,1],Fi=[0,.05,.15,.25,.5],Gi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Eo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Mo="soundSettings";function Ni(){try{let e=localStorage.getItem(Mo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ui(e){try{localStorage.setItem(Mo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function bo(){return{audioContext:null,buffers:{},settings:Ni(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return $i[this.settings.soundVolume]},getMusicVolume(){return Fi[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(u){console.debug(`Failed to load sound: ${n} from ${r}`,u)}},preload(){this.initContext();for(let[n,r]of Object.entries(Gi))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;r!==null&&(u=`${n}${r}`);let i=this.buffers[u];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ui(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var xo="eb_highscore",vo="eb_highscore_quick",Co="eb_settings",To="eb_high_tower_rings",Xi={invertSwipe:!1,magicEnabled:!1,hapticsEnabled:!0};function _o(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?vo:xo,r=localStorage.getItem(n);if(r)return JSON.parse(r)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,r="30_24"){try{let u=this.loadHighscore(r);if(e>u.score||e===u.score&&n>u.time){let i=r==="25_20"?vo:xo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Xi}},saveGameSettings(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(To);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(To,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let r=this.loadHighTowerRings()+e;return this.saveHighTowerRings(r),r}}}function Bo(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),magicToggle:document.getElementById("magicToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Lo(e){return document.getElementById("tab-"+e)}var Yi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ro(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(u,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=u,s&&n[s]&&(c.style.color=n[s]);let m=window.innerWidth/2,f=window.innerHeight/2-40,g=(Math.random()-.5)*200,d=(Math.random()-.5)*100+r*36;c.style.left=`${m+g}px`,c.style.top=`${f+d}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(u){return Yi[u]||"\u2726"}}}var Ls={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ao(){return{spawnMagicOrb(e,n,r,u){if(!u)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Ls[e]||"\u2726";let s=u.getBoundingClientRect(),c=s.left+s.width/2-n,m=s.top+s.height/2-r,f=Math.hypot(c,m),g=Math.atan2(m,c),d=f*.35*(Math.random()>.5?1:-1),p=g+Math.PI/2,L=c*.5+Math.cos(p)*d,q=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${L}px`),i.style.setProperty("--mid-y",`${q}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${r}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,r,u,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,m=s.top+s.height/2,f=document.createElement("div");f.className=`magic-shot ${e}`,f.textContent=Ls[e]||"\u2726";let g=r-c,d=u-m;f.style.setProperty("--end-x",`${g}px`),f.style.setProperty("--end-y",`${d}px`),f.style.left=`${c}px`,f.style.top=`${m}px`,document.body.appendChild(f);let p=setInterval(()=>{let L=f.getBoundingClientRect();this.spawnTrailParticle(e,L.left+L.width/2,L.top+L.height/2)},40);setTimeout(()=>{clearInterval(p),f.remove(),this.spawnExplosion(e,r,u),i&&i()},300)},spawnTrailParticle(e,n,r){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${r}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,r){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,f=Math.cos(c)*m,g=Math.sin(c)*m;s.style.setProperty("--px",`${f}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${r}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",r=18){if(!e)return;let u=n;typeof n=="number"&&(r=n,u="water"),Ls[u]||(u="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,m=Math.max(8,Math.round(r));for(let f=0;f<m;f++){let g=document.createElement("div");g.className=`spell-bubble ${u}`,g.textContent="\u25CF";let d=f/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,L=Math.cos(d)*p,q=Math.sin(d)*p-20;g.style.setProperty("--px",`${L}px`),g.style.setProperty("--py",`${q}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,r){if(!r)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let i=r.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,m=Math.hypot(s,c),f=Math.atan2(c,s),g=m*.35*(Math.random()>.5?1:-1),d=f+Math.PI/2,p=s*.5+Math.cos(d)*g,L=c*.5+Math.sin(d)*g;u.style.setProperty("--mid-x",`${p}px`),u.style.setProperty("--mid-y",`${L}px`),u.style.setProperty("--end-x",`${s}px`),u.style.setProperty("--end-y",`${c}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}var Vi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Wi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let r=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return r?(navigator.vibrate(r),!0):!1}},As=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Io({enabled:e=!0,patterns:n=Vi}={}){let r=Wi(),u=r?new As(r):new Rs,i=u.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let m=n[c];return m?u.trigger({name:c,...m}):!1}}}function wo(e={}){let{buttons:n={},onActivate:r=null,onChange:u=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[f,g]of Object.entries(n)){if(!g)continue;let d=i[f],p=g.querySelector(".charges");p&&(p.textContent=d),g.classList.toggle("empty",d<=0),g.classList.toggle("active",s===f&&d>0)}u&&u({...i},s)}function m(f){let g=n[f];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(f){s=f},select(f){if(i[f]<=0)return!1;let g=s===f;return s=g?null:f,c(),!g&&s===f&&r&&r(),!g},useCharge(){if(!s||i[s]<=0)return!1;let f=s;return i[f]--,s=null,c(),m(f),!0},addCharges(f,g){i[f]!==void 0&&(i[f]+=g,c(),m(f))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(f){for(let[g,d]of Object.entries(n))d&&d.addEventListener("click",()=>{f&&f(g)})}}}var Ge={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Po(e={}){let{button:n=null,onActivate:r=null,onProgress:u=null,onReady:i=null}=e,s="ice",c=0;function m(){return Ge[s]||Ge.ice}function f({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),L=Number.isFinite(p.maxProgress)?p.maxProgress:0,q=L>0?Math.min(c/L,1)*100:0,$=L>0&&c>=L;n.style.setProperty("--progress",`${q}%`);let W=n.querySelector(".spell-icon");W&&(W.textContent=p.icon);let st=n.querySelector(".spell-counter");st&&(st.textContent=L>0?`${Math.min(c,L)}/${L}`:""),n.classList.toggle("ready",$),n.classList.toggle("charging",!$&&c>0),u&&!d&&L>0&&u(c,L)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&c>=d},get effect(){return m().effect},getUnlockRings(d){return(Ge[d]||Ge.ice).unlockRings??0},getCost(d){return(Ge[d]||Ge.ice).cost??0},getDescription(d){return(Ge[d]||Ge.ice).description||""},getEffect(d){return(Ge[d]||Ge.ice).effect},get button(){return n},selectSpell(d){Ge[d]&&(s=d,c=0,f())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||c>=p.maxProgress)return!1;let L=c<p.maxProgress;return c=Math.min(c+d,p.maxProgress),f(),g(),L&&c>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){c=Math.max(0,d),f({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&c>=d},use(){if(!this.canUse())return null;let d=m().effect;return c=0,f(),g(),r&&r(s),d},reset(){c=0,f()},pulse(){g()},updateButton:f,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function Is({centerY:e,centerS:n,size:r,H:u,normSector:i}){let s=[],c=Math.floor(r/2);for(let m=-c;m<=c;m++)for(let f=-c;f<=c;f++){let g=e+m,d=i(n+f);if(g<0||g>=u)continue;let p=m*m+f*f;s.push({y:g,s:d,distSq:p})}return s}function ls(e,n,r){return n.filter(u=>e[u.y][u.s]===r)}function us(e,n){return[...e].sort((u,i)=>u.distSq!==i.distSq?u.distSq-i.distSq:u.y!==i.y?u.y-i.y:u.s-i.s).slice(0,n).map(u=>({y:u.y,s:u.s}))}function ko({centerY:e,centerS:n,beamLength:r,beamWidth:u,N:i,H:s,normSector:c}){if(e<0||e>=s||u<=0||r<0||i<=0)return[];let m=Math.min(u,s),f=[],g=new Set,d=$=>$<0||$>=s||g.has($)?!1:(g.add($),f.push($),!0);d(e);for(let $=1;f.length<m&&(e+$<s||e-$>=0)&&(d(e+$),!(f.length>=m));$++)d(e-$);f.sort(($,W)=>W-$);let p=Math.min(i,r*2+1),L=r%2===0,q=[];for(let $ of f){let W=new Set,st=(mt,ue)=>{let Z=c(mt);return W.has(Z)?!1:(W.add(Z),q.push({y:$,s:Z,dist:ue}),!0)};st(n,0);for(let mt=1;W.size<p&&mt<i;mt++)if(L){if(st(n+mt,mt),W.size>=p)break;st(n-mt,mt)}else{if(st(n-mt,mt),W.size>=p)break;st(n+mt,mt)}}return q}function Oo(e){let{canvas:n,dom:r,getGrid:u,getN:i,getH:s,getRotFloat:c,constants:m,helpers:f,Spell:g,Magic:d,SoundModule:p,State:L,isGamePlaying:q,addPendingKzDrop:$,getKillRate:W,triggerSpellWave:st,spawnSpellBubbles:mt,spawnBonusBubbles:ue,getTransmuteEffect:Z,getLightningEffect:K,getFireEffect:vt,continueMatchProcessing:Le,updateScoreHud:he,showBonus:Wt,getSpellCost:Kt,getSpellElement:zt,onUltimateApplied:qt,isSpellBlocked:jt,setScore:kt,setCascadeLevel:Lt}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:ot,SIDE_MARGIN_PX:j,MAX_RADIUS_X:de,SCORE_MAGIC_DESTROY:se}=m,{normSector:Oe,levelYToScreenY:De,sectorCenterXY:yn}=f,Ln=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],yt="idle",J=null,ie=null,$t=[],Vt=[],qe=0,Rt=null,Ne=0,Q="idle",ye=null,Se=[],Qt=[],F=0,C=0,M="idle",w=null,P=[],S=[],z=0;function A(h){if(typeof Kt!="function"||typeof zt!="function")return!1;let I=zt(h),v=Kt(h);return!I||!v?!1:(d.charges[I]??0)>=v}function bt(h){if(typeof Kt!="function"||typeof zt!="function")return!1;let I=zt(h),v=Kt(h);return!I||!v||(d.charges[I]??0)<v?!1:(d.charges[I]-=v,d.updateButtons(),g.pulse(),!0)}let dt=0,y=350;function b(){return typeof jt=="function"?jt():!1}function R(){let h=performance.now();h-dt<y||(dt=h,p.play("cancel"))}function Ct(){yt="selecting_source",J=null,ie=null,$t=[],Vt=[],Q!=="idle"&&rt(),M!=="idle"&&St(),d.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function x(){yt!=="idle"&&p.play("cancel"),yt="idle",J=null,ie=null,$t=[],Vt=[],gt();let h=r.spellBtn;h&&h.classList.remove("selecting")}function Tt(h,I){if(yt!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,I);if(!v)return x(),!0;let et=u();J={y:v.y,s:v.s,color:et[v.y][v.s]},$t=Is({centerY:v.y,centerS:v.s,size:Z().areaSize,H:s(),normSector:Oe});let Et=J.color,xt=ls(et,$t,Et);return Vt=us(xt,Z().maxBlocks),Ot(J.color,v.y),yt="selecting_target",!0}function D(h,I){let v=n.clientWidth,et=n.clientHeight,Et=v*.5,xt=(v-2*j)/2,Gt=et-l-ot,ee=6,Nt=s(),$e=i(),Ie=c(),Ve=$e*Gt/(ee*Nt),ce=et-ot,Ut,Me,Fe;Ve<=Math.min(xt,de)?(Ut=Ve,Me=Gt,Fe=l):(Ut=Math.min(xt,de),Me=Ut*ee*Nt/$e,Fe=ce-Me);let we=Ut*.28,je=null,gn=1/0,Qe=u();for(let Dt=0;Dt<Nt;Dt++){let Ze=De(Fe,Me,Dt+.5);for(let be=0;be<$e;be++){if(!Qe[Dt][be])continue;let xe=yn(Et,Ze,Ut,we,be,Ie);if(Math.sin(xe.ang)<-.1)continue;let It=h-xe.x,fn=I-xe.y,Xt=Math.hypot(It,fn),ve=Me/Nt*.9,T=ve*1.2;Math.abs(It)<T/2&&Math.abs(fn)<ve/2&&Xt<gn&&(gn=Xt,je={y:Dt,s:be})}}return je}function Ot(h,I){gt();let v=document.createElement("div");v.className="transmute-popup";let et=n.clientWidth,Et=n.clientHeight,xt=(et-2*j)/2,Gt=Et-l-ot,ee=6,Nt=s(),$e=i(),Ie=$e*Gt/(ee*Nt),Ve=Et-ot,ce,Ut;Ie<=Math.min(xt,de)?(ce=Gt,Ut=l):(ce=Math.min(xt,de)*ee*Nt/$e,Ut=Ve-ce);let Me=De(Ut,ce,I+.5),Fe=Math.floor(Z().areaSize/2),we=De(Ut,ce,Math.min(Nt,I+Fe)+.5),je=De(Ut,ce,Math.max(0,I-Fe)+.5),gn=Ut+ce/2,Qe=document.getElementById("gameContainer"),Dt=Qe?Qe.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},Ze=160,be=60,xe=20,on=Dt.left+Dt.width/2-Ze/2,It;Me<gn?It=Dt.top+je+xe:It=Dt.top+we-be-xe,It=Math.max(10,Math.min(window.innerHeight-be-10,It)),v.style.left=`${on}px`,v.style.top=`${It}px`,Ln.filter(Xt=>Xt.color!==h).forEach(Xt=>{let ve=document.createElement("button");ve.className=`transmute-btn ${Xt.name}`,ve.innerHTML=Xt.icon,ve.setAttribute("data-color",Xt.color),ve.addEventListener("click",T=>{T.stopPropagation(),oe(Xt.color)}),v.appendChild(ve)}),document.body.appendChild(v),Rt=v,Ne=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Re)},50)}function Re(h){performance.now()-Ne<200||Rt&&!Rt.contains(h.target)&&x()}function gt(){document.removeEventListener("pointerdown",Re),Rt&&(Rt.remove(),Rt=null)}function oe(h){if(b()){R();return}if(!A(g.currentSpell)){R();return}if(gt(),ie=h,Vt.length===0){x();return}Ae()}function Ae(){if(!J){x();return}if(Vt.length===0){x();return}if(!bt(g.currentSpell)){R(),x();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),yt="animating",qe=performance.now(),p.play("esseffect")}function Ee(){if(yt!=="selecting_target"&&yt!=="animating"||!J||!$t||$t.length===0)return;let h=u(),I=h[J.y]?.[J.s]??0;if(!I||I!==J.color){x();return}let v=ls(h,$t,I),et=Z().maxBlocks??v.length;Vt=us(v,et),Vt.length===0&&x()}function Zt(h){if(yt!=="animating")return!1;let I=(h-qe)/1e3;return Math.min(I/Z().animSec,1)>=1?(Sn(),!1):!0}function an(h){if(yt!=="animating")return null;let I=(h-qe)/1e3,v=Math.min(I/Z().animSec,1),et="flash",Et=0,xt=0;return v<.15?(et="flash",xt=1-v/.15):v<.55?(et="shrink",Et=(v-.15)/.4):(et="grow",Et=(v-.55)/.45),{phase:et,progress:Et,areaFlash:xt}}function Sn(){let h=u();for(let I of Vt)h[I.y][I.s]=ie;yt="idle",J=null,ie=null,$t=[],Vt=[],Lt(0),Le(),typeof qt=="function"&&qt("earth")}function B(){p.play("ulta"),Q="selecting_source",ye=null,Se=[],Qt=[],C=0,yt!=="idle"&&(yt="idle",J=null,ie=null,$t=[],Vt=[],gt()),M!=="idle"&&(M="idle",w=null,P=[],S=[],z=0),d.deactivate();let h=r.spellBtn;h&&h.classList.add("selecting")}function rt(){Q!=="idle"&&p.play("cancel"),Q="idle",ye=null,Se=[],Qt=[],C=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function pt(){M="selecting_source",w=null,P=[],S=[],z=0,yt!=="idle"&&(yt="idle",J=null,ie=null,$t=[],Vt=[],gt()),Q!=="idle"&&(Q="idle",ye=null,Se=[],Qt=[],C=0),d.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function St(){M!=="idle"&&p.play("cancel"),M="idle",w=null,P=[],S=[],z=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function ln(h,I){if(Q!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,I);if(!v)return rt(),!0;let et=u();ye={y:v.y,s:v.s,color:et[v.y][v.s]},Se=Is({centerY:v.y,centerS:v.s,size:K().areaSize,H:s(),normSector:Oe});let Et=ye.color,xt=ls(et,Se,Et);return Qt=us(xt,K().maxBlocks),Qt.length===0?(rt(),!0):A(g.currentSpell)?(Ue(),!0):(R(),!0)}function Jt(h,I){if(M!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,I);if(!v)return St(),!0;let et=u();return w={y:v.y,s:v.s,color:et[v.y][v.s]},P=ko({centerY:v.y,centerS:v.s,beamLength:vt().beamLength,beamWidth:vt().beamWidth,N:i(),H:s(),normSector:Oe}),S=P.filter(Et=>et[Et.y][Et.s]),S.length===0?(St(),!0):A(g.currentSpell)?(te(),!0):(R(),!0)}function Ue(){if(!ye||Qt.length===0){rt();return}if(!bt(g.currentSpell)){R(),rt();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),Q="animating",F=performance.now(),C=0,p.play("asseffect")}function un(h){if(Q!=="animating")return!1;let I=h-F,v=K().flashMs+Qt.length*K().jumpMs;return I>=v?(at(),!1):!0}function He(h){if(Q!=="animating")return null;let I=h-F;if(I<K().flashMs)return{phase:"flash",flashProgress:1-I/K().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let v=I-K().flashMs,et=Math.floor(v/K().jumpMs),Et=v%K().jumpMs/K().jumpMs,xt=[];for(let Gt=0;Gt<Math.min(et,Qt.length);Gt++)xt.push(Gt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(et,Qt.length-1),jumpProgress:Et,struckTargets:xt}}function at(){let h=u(),I=Qt.length,v=I*se;L.addScore(v),kt(L.score),he(),Wt(`+${v}`,"score");for(let Gt of Qt)h[Gt.y][Gt.s]=0;let et=K(),Et=Math.abs(et.kzDropSecPerBlock??0),xt=I*Et;xt>0&&typeof $=="function"&&typeof W=="function"&&($(xt*W()),Wt(`\u26A1 -${xt}s`,"time")),Q="idle",ye=null,Se=[],Qt=[],C=0,Lt(0),Le(),typeof qt=="function"&&qt("air")}function te(){if(!w||S.length===0){St();return}if(!bt(g.currentSpell)){R(),St();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),M="animating",z=performance.now(),p.play("fsseffect")}function dn(h){return M!=="animating"?!1:(h-z)/1e3>=vt().animSec?(Xe(),!1):!0}function Rn(h){if(M!=="animating")return null;let I=Math.max(.001,vt().animSec),v=(h-z)/1e3,et=Math.min(v/I,1),Et=.25,xt=et<Et?1-et/Et:0;return{progress:et,flashProgress:xt}}function Xe(){let h=u(),I=S.length;if(I>0){let v=I*se;L.addScore(v),kt(L.score),he(),Wt(`+${v}`,"score")}for(let v of S)h[v.y][v.s]=0;M="idle",w=null,P=[],S=[],z=0,Lt(0),Le(),typeof qt=="function"&&qt("fire")}function Ft(){let h=typeof q=="function"?q():L.isPlaying(),I=g.currentSpell;if(!h)return!1;if(I==="ice"){if(b()||!A(I)||!bt(g.currentSpell))return R(),!1;let v=g.effect;return typeof $=="function"&&typeof W=="function"&&$(v.duration*W()),p.play("wsseffect"),Wt(`\u{1F4A7} -${v.duration}s`,"time"),typeof st=="function"&&st(),typeof ue=="function"&&ue(v.duration),typeof qt=="function"&&qt(I),!0}return I==="earth"?yt==="selecting_source"||yt==="selecting_target"?(x(),!0):yt!=="idle"||b()||!A(I)?(R(),!1):(yt==="idle"&&Ct(),!0):I==="air"?Q==="selecting_source"?(rt(),!0):Q!=="idle"||b()||!A(I)?(R(),!1):(Q==="idle"&&B(),!0):I==="fire"?M==="selecting_source"?(St(),!0):M!=="idle"||b()||!A(I)?(R(),!1):(M==="idle"&&pt(),!0):!1}function En(h){Ee(),Zt(h),un(h),dn(h)}function Ye(h,I){return b()&&(yt==="selecting_source"||Q==="selecting_source"||M==="selecting_source")?(R(),!0):yt==="selecting_source"?Tt(h,I):Q==="selecting_source"?ln(h,I):M==="selecting_source"?Jt(h,I):!1}function Nn(){yt="idle",J=null,ie=null,$t=[],Vt=[],gt(),Q="idle",ye=null,Se=[],Qt=[],C=0,M="idle",w=null,P=[],S=[],z=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function Mn(){return{transmuteState:yt,transmuteSourceBlock:J,transmuteTargetColor:ie,transmuteAreaCells:$t,transmuteBlocksToChange:Vt,lightningState:Q,lightningSourceBlock:ye,lightningAreaCells:Se,lightningBlocksToHit:Qt,fireState:M,fireSourceBlock:w,fireLineCells:P,fireTargets:S}}return{startTransmuteSourceSelection:Ct,cancelTransmutation:x,startLightningSourceSelection:B,cancelLightning:rt,startFireSourceSelection:pt,cancelFire:St,handleTap:Ye,update:En,reset:Nn,getRenderState:Mn,getTransmuteAnimState:an,getLightningAnimState:He,getFireAnimState:Rn,handleSpellButtonClick:Ft,isTransmuteSelecting:()=>yt==="selecting_source",isLightningSelecting:()=>Q==="selecting_source"}}var Ki={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Do(e={}){let{canvas:n}=e,r=e.rotDir||1,u=!1,i=0,s=0,c=0,m=0,f=0,g=1,d=null,p=0,L=0,q=0,$=0,W=0,st=0,mt=0,ue=0,Z=Ki;return{get rotDir(){return r},set rotDir(K){r=K},get dragging(){return u},get dragMode(){return d},handlePointerDown(K,vt,Le){if(vt.onMagicTap&&vt.onMagicTap(K.clientX,K.clientY))return!0;let he=performance.now(),Wt=he-st,Kt=K.clientX-mt,zt=K.clientY-ue,qt=Math.hypot(Kt,zt);return Wt<=Z.DOUBLE_TAP_MS&&qt<=Z.DOUBLE_TAP_MAX_DIST?(vt.onDoubleTap&&vt.onDoubleTap(),st=0):(st=he,mt=K.clientX,ue=K.clientY),u=!0,g=-1,i=K.clientX,s=K.clientY,c=Le,m=0,f=0,d=null,p=he,L=K.clientX,q=K.clientY,$=p,W=0,n&&n.setPointerCapture(K.pointerId),!1},handlePointerMove(K,vt,Le,he){if(!u)return null;let Wt=K.clientX-i,Kt=K.clientY-s,zt=performance.now();if(Math.abs(Wt)<Z.DEADZONE_PX&&Math.abs(Kt)<Z.DEADZONE_PX)return null;if(d){if(d==="rotate"){let jt=Math.abs(Wt),kt=Math.abs(Kt);if(kt>=jt*Z.AXIS_DOMINANCE&&kt>=Z.DROP_SWIPE_MIN_DISTANCE){let Lt=Math.max(1,zt-p);kt/Lt*1e3>=Z.DROP_SWIPE_MIN_SPEED&&(d="drop",f=0)}}}else{let jt=Math.abs(Wt),kt=Math.abs(Kt);if(Kt<0)jt>=Z.DEADZONE_PX&&(d="rotate");else if(kt>=jt*Z.AXIS_DOMINANCE){if(kt>=Z.DROP_SWIPE_MIN_DISTANCE){let Lt=Math.max(1,zt-p);kt/Lt*1e3>=Z.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else jt>=kt*Z.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let qt=null;if(d==="rotate"&&Math.abs(Wt)>=Z.DEADZONE_PX){let jt=Math.max(1,zt-$),kt=K.clientX-L,Lt=Math.max(1,Math.abs(kt)/jt*1e3),l=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/Lt)));W+=-kt/l*r*g;let ot=Math.trunc(W);ot!==0&&(W-=ot);let j=m+ot;if(j!==m&&vt.canRotateTo){let de=Math.sign(j-m),se=c+m;for(;m!==j;){let Oe=m+de,De=c+Oe;if(!vt.canRotateTo(Math.floor(Le),De))break;m=Oe,se=De,vt.onRotateStep&&vt.onRotateStep(),he&&vt.onGroundedMove&&vt.onGroundedMove()}qt={targetRot:se,rotFloat:se}}}if(d==="drop"&&Kt>=Z.DROP_SWIPE_MIN_DISTANCE&&vt.onDrop){let jt=Math.max(1,zt-$),kt=K.clientY-q,Lt=Math.max(1,kt/jt*1e3),l=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/Lt))),ot=Math.trunc(Kt/l);if(ot>f){let j=ot-f;for(let de=0;de<j;de++)vt.onDrop();f=ot}}return L=K.clientX,q=K.clientY,$=zt,qt},handlePointerUp(K){if(u&&(u=!1,d=null,n&&K&&K.pointerId!==void 0))try{n.releasePointerCapture(K.pointerId)}catch{}},reset(){u=!1,d=null,m=0,f=0,W=0}}}var ws={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ho(){let e="intro",n=0,r=0,u=0,i=0,s=0,c={...ws};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return r},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),u=0,i=0,s=0,c={...ws}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&r>0&&(u=performance.now()-r-s)},getFormattedTime(){let m=Math.floor(u/1e3),f=Math.floor(m/60),g=m%60;return`${f}:${g.toString().padStart(2,"0")}`},incrementStat(m,f=1){m in c&&(c[m]+=f)},updateMaxStat(m,f){m in c&&f>c[m]&&(c[m]=f)},reset(){e="intro",n=0,r=0,u=0,i=0,s=0,c={...ws}}}}function Bn(e,n){return e%=n,e<0&&(e+=n),e}function $o(e,n){return e[Math.min(n,e.length-1)]}function ds(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),u=n%60;return`${r}:${u.toString().padStart(2,"0")}`}function Fo(e,n){let r=e.map(({x:m,y:f},g)=>({x:f,y:-m,color:n[g]})),u=1/0,i=-1/0,s=1/0;for(let m of r)u=Math.min(u,m.x),i=Math.max(i,m.x),s=Math.min(s,m.y);let c=Math.round((u+i)/2);for(let m of r)m.x-=c,m.y-=s;return r.sort((m,f)=>m.y-f.y||m.x-f.x),{cells:r.map(m=>({x:m.x,y:m.y})),colors:r.map(m=>m.color)}}function Ps(e,n,r,u){let i=[];return e+1<r&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Bn(n-1,u)}),i.push({y:e,s:Bn(n+1,u)}),i}function Go(e,n,r){let u=Array.from({length:n},()=>new Uint8Array(r)),i=[];for(let s=0;s<n;s++)for(let c=0;c<r;c++){if(!e[s][c]||u[s][c])continue;let m=[],f=[{y:s,s:c}];for(u[s][c]=1;f.length>0;){let g=f.shift();m.push(g);for(let d of Ps(g.y,g.s,n,r))e[d.y][d.s]&&!u[d.y][d.s]&&(u[d.y][d.s]=1,f.push(d))}i.push(m)}return i}function No(e){return e.some(n=>n.y===0)}function ks(e,n,r,u,i,s){if(!e)return!1;let c=Bn(r,s);for(let m of e.cells){let f=n+m.y,g=Bn(c+m.x,s);if(f<0)return!1;if(!(f>=i)&&u[f][g])return!1}return!0}function Uo(e,n,r,u,i,s){if(!e)return null;let c=Math.floor(n);for(;ks(e,c-1,r,u,i,s);)c-=1;return c}function Xo(e,n,r){let u=[],i=[];for(let s=0;s<n;s++){let c=[],m=0,f=e[s][0],g=f?1:0;for(let d=1;d<=r;d++){let p=d<r?e[s][d]:0;p&&p===f?g++:(g>=1&&f&&c.push({start:m,length:g,color:f}),m=d,f=p,g=p?1:0)}if(c.length>=2){let d=c[0],p=c[c.length-1];if(d.start===0&&p.start+p.length===r&&d.color===p.color){let L=d.length+p.length;c[0]={start:p.start,length:L,color:d.color},c.pop()}}for(let d of c)if(d.length>=3){let p=[];for(let L=0;L<d.length;L++)p.push({y:s,s:(d.start+L)%r});u.push({color:d.color,length:d.length,cells:p})}}for(let s=0;s<r;s++){let c=0,m=e[0][s],f=m?1:0;for(let g=1;g<=n;g++){let d=g<n?e[g][s]:0;if(d&&d===m)f++;else{if(f>=3&&m){let p=[];for(let L=0;L<f;L++)p.push({y:c+L,s});u.push({color:m,length:f,cells:p})}c=g,m=d,f=d?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<r;c++){let m=e[s][c],f=e[s][(c+1)%r],g=e[s][(c+2)%r],d=e[s][(c+3)%r];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%r},{y:s,s:(c+2)%r},{y:s,s:(c+3)%r}]})}for(let s=0;s<r;s++)for(let c=0;c<n-3;c++){let m=e[c][s],f=e[c+1][s],g=e[c+2][s],d=e[c+3][s];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:u,pairMatches:i}}function Yo(e,n,r){let u=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<r;c++)if(!e[i][c]){s=!1;break}s&&u.push(i)}return u}function Vo(e,n){let r=new Map;e.forEach((u,i)=>r.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],s=n[u],c=1;for(let st=1;st<=2&&r.get(`${i.x+st},${i.y}`)===s;st++)c++;if(c>=3)return!0;let m=1;for(let st=1;st<=2&&r.get(`${i.x},${i.y+st}`)===s;st++)m++;if(m>=3)return!0;let f=s,g=r.get(`${i.x+1},${i.y}`),d=r.get(`${i.x+2},${i.y}`),p=r.get(`${i.x+3},${i.y}`);if(f&&g&&d&&p&&f===g&&d===p&&f!==d)return!0;let L=s,q=r.get(`${i.x},${i.y+1}`),$=r.get(`${i.x},${i.y+2}`),W=r.get(`${i.x},${i.y+3}`);if(L&&q&&$&&W&&L===q&&$===W&&L!==$)return!0}return!1}function Wo(e){let{getN:n,getH:r,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:f,getState:g,setState:d,funcs:p,ui:L}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(q,$={}){let W=g();if(q==="start_game")return W.gameState!=="playing"?(p.startGame(),!0):!1;if(W.gameState!=="playing")return!1;switch(q){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:st}=$;return typeof st=="number"&&p.canPlaceAtRot(Math.floor(W.pieceY),st)?(d({targetRot:st,rotFloat:st,rotVel:0}),W.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:st,y:mt}=$;return p.shootMagic(st,mt)}case"select_magic":{let{element:st}=$;return p.selectMagic(st),!0}default:return console.warn("GameEngine: unknown command",q),!1}},update(q,$){let W=g();if(W.gameState!=="playing")return;let st=$-W.startTime-W.totalPausedMs;d({elapsedMs:st}),L.updateTimeHud();let mt=W.killLevel+s()*q;if(d({killLevel:mt}),L.updateRemainingHud(),mt>=r()){p.endGame();return}if(W.isHighlighting){let K=($-W.highlightStartTime)/1e3,vt;W.isRingAnimation?vt=f:W.isMagicAnimation?vt=m:vt=c,K>=vt&&(W.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ue=W.fallTimer+q;if(ue>=u&&(ue-=u,p.tryMoveDown()),d({fallTimer:ue}),p.updateGroundedState()){let K=W.lockTimer+q;d({lockTimer:K}),K>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(q,$){return p.canPlaceAtRot(q,$)},getRotation(){let q=g();return{targetRot:q.targetRot,rotFloat:q.rotFloat,rotVel:q.rotVel}},setRotation(q){d({targetRot:q,rotFloat:q,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var ke=Math.PI*2;function Ko(e){let{canvas:n,canvasCtx:r,getN:u,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:m,MAX_RADIUS_X:f,RADIUS_X_FACTOR:g,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:L,MAGIC_SHRINK_SEC:q,RING_HIGHLIGHT_SEC:$,LOCK_DELAY_SEC:W,getKillRate:st,ELEMENT_COLORS:mt,ELEMENT_TO_COLOR:ue,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:K,ACTIVE_COLOR_FRONT:vt,GHOST_COLOR_FILL:Le,GHOST_COLOR_STROKE:he,GHOST_STROKE_WIDTH:Wt,MAGIC_DIM_DOT_ALPHA:Kt,MAGIC_DIM_DOT_SCALE:zt,MAGIC_TARGET_DOT_SCALE:qt,getState:jt,getVisualSettings:kt,funcs:Lt}=e,l=r,ot=u(),j=i(),de={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},se=[],Oe=40;function De(F,C,M,w,P){let S=Math.max(3,Math.round(F)),z=180;for(let A=0;A<S;A++)setTimeout(()=>{let bt=Math.random()>.5?"left":"right",dt=15,y=bt==="left"?dt+Math.random()*Math.max(10,C-dt*2):M+dt+Math.random()*Math.max(10,P-M-dt*2),b=w-10;se.push({x:y,baseX:y,y:b,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:dt,maxX:P-dt})},A*z)}function yn(F,C,M){se=se.filter(w=>w.y>F+w.size&&w.y>-20);for(let w of se){w.y-=Oe*M,w.wobble+=w.wobbleSpeed*M;let P=w.baseX+Math.sin(w.wobble)*w.wobbleAmp;w.x=Math.max(w.minX,Math.min(w.maxX,P))}}function Ln(F){if(se.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let C of se)C.y<F+C.size||(l.beginPath(),l.arc(C.x,C.y,C.size,0,Math.PI*2),l.fill(),l.stroke())}}let yt={left:0,right:0,h:0,w:0};function J(F,C,M){let w=1-M/j;return F+w*C}function ie(F){return F=F%ot,F<0?F+ot:F}function $t(F,C,M,w,P,S){let z=ie(S),A=(P-z)/ot*ke+d;return{x:F+Math.cos(A)*M,y:C+Math.sin(A)*w,ang:A}}let Vt=.52,qe=1.02;function Rt(F,C,M,w,P,S){let z=ie(S),A=(P-z)/ot*ke+d;return{x:F+Math.cos(A)*M,y:C+Math.sin(A)*w,ang:A}}function Ne(F,C,M,w,P,S,z,A=1){let bt=Rt(F,C,M,w,P-Vt,S),dt=Rt(F,C,M,w,P+Vt,S),y={x:bt.x,y:bt.y-z*.5},b={x:bt.x,y:bt.y+z*.5},R={x:dt.x,y:dt.y-z*.5},Ct={x:dt.x,y:dt.y+z*.5},x=(y.x+R.x+Ct.x+b.x)*.25,Tt=(y.y+R.y+Ct.y+b.y)*.25,D=qe*A,Ot=A,Re=[y,R,Ct,b].map(Ae=>({x:x+(Ae.x-x)*D,y:Tt+(Ae.y-Tt)*Ot})),gt=Math.abs((dt.x-bt.x)*D),oe=Math.abs(z*Ot);return{corners:Re,cx:x,cy:Tt,wApprox:gt,hApprox:oe,ang:Rt(F,C,M,w,P,S).ang}}function Q(F,C,M,w,P,S,z,A,bt=1,dt=null,y=1,b=null,R=0,Ct=1,x=1){let Tt=Ne(F,C,M,w,P,S,z,x),[D,Ot,Re,gt]=Tt.corners;if(l.save(),l.globalAlpha=bt,l.fillStyle=A,l.beginPath(),l.moveTo(D.x,D.y),l.lineTo(Ot.x,Ot.y),l.lineTo(Re.x,Re.y),l.lineTo(gt.x,gt.y),l.closePath(),l.fill(),b&&R>0&&(l.strokeStyle=b,l.lineWidth=R,l.stroke()),dt){let oe=Math.min(Tt.wApprox,Tt.hApprox)*.28*Ct;l.globalAlpha=bt*y,l.fillStyle=dt,l.beginPath(),l.arc(Tt.cx,Tt.cy,oe,0,ke),l.fill()}l.restore(),l.globalAlpha=1}function ye(F,C,M,w,P,S){let z=$t(F,C,M,w,P,S),A=$t(F,C,M,w,P+1,S),bt=$t(F,C,M,w,P-1,S),dt=Math.abs(A.x-z.x),y=Math.abs(z.x-bt.x),b=(dt+y)*.5*1.06;return Math.max(1,b)}function Se(F,C,M,w,P,S){let z=(P-S)/ot*ke+d;return{x:F+Math.cos(z)*M,y:C+Math.sin(z)*w,ang:z}}function Qt(F,C,M,w,P,S,z,A=1,bt=null,dt=1,y=null,b=0,R=1){l.save(),l.translate(F,C);let Ct=Math.atan2(w,M);if(l.rotate(Ct),l.globalAlpha=A,l.fillStyle=z,l.fillRect(-P/2,-S/2,P,S),y&&b>0&&(l.strokeStyle=y,l.lineWidth=b,l.strokeRect(-P/2,-S/2,P,S)),bt){let x=Math.min(P,S)*.28*R;l.globalAlpha=A*dt,l.fillStyle=bt,l.beginPath(),l.arc(0,0,x,0,ke),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let F=Math.max(1,Math.min(2,window.devicePixelRatio||1)),C=Math.floor(n.clientWidth*F),M=Math.floor(n.clientHeight*F);(n.width!==C||n.height!==M)&&(n.width=C,n.height=M,l.setTransform(F,0,0,F,0,0))},render(F=.016,C=performance.now()){this.resize();let M=jt();ot=u(),j=i();let w=n.clientWidth,P=n.clientHeight;l.clearRect(0,0,w,P),l.fillStyle="#0b0f14",l.fillRect(0,0,w,P);let S=w*.5,z=(w-2*m)/2,A=P-s-c,bt=6,dt=ot*A/(bt*j),y,b,R,Ct;Ct=P-c,dt<=Math.min(z,f)?(y=dt,b=A,R=s):(y=Math.min(z,f),b=y*bt*j/ot,R=Ct-b);let x=y*.28,{killLevel:Tt,rotFloat:D,grid:Ot,gameState:Re}=M,gt=kt?kt():{},oe=gt.waterColor||"blue",Ae=gt.waterBubbles||!1,Ee=de[oe]||de.blue,Zt=J(R,b,Tt),an=.7,Sn=Tt/j,B={...Ee.top},rt={...Ee.bottom};if(Sn>an){let T=(Sn-an)/(1-an);B.r=Math.round(B.r+(255-B.r)*T*.5),B.g=Math.round(B.g+(150-B.g)*T*.5),B.b=Math.round(B.b+(150-B.b)*T*.5),rt.r=Math.round(rt.r+(180-rt.r)*T),rt.g=Math.round(rt.g*(1-T*.6)),rt.b=Math.round(rt.b*(1-T*.6))}let pt=S-y-8,St=S+y+8,ln=R,Jt=Ct+5,Ue=l.createLinearGradient(0,Zt,0,P);Ue.addColorStop(0,`rgba(${B.r},${B.g},${B.b},0.5)`),Ue.addColorStop(1,`rgba(${rt.r},${rt.g},${rt.b},0.7)`),l.fillStyle=Ue;let un=Math.round((B.r+rt.r)/2),He=Math.round((B.g+rt.g)/2),at=Math.round((B.b+rt.b)/2),te=y+8,dn=x+4;l.fillRect(0,Zt,pt,P-Zt),l.fillRect(St,Zt,w-St,P-Zt),l.beginPath();let Rn=Math.max(Zt,Jt);l.moveTo(pt,Rn),Zt<=Jt+dn?l.ellipse(S,Jt,te,dn,0,Math.PI,0,!1):l.lineTo(St,Rn),l.lineTo(St,P),l.lineTo(pt,P),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(pt,ln),l.lineTo(pt,Jt),l.stroke(),l.beginPath(),l.moveTo(St,ln),l.lineTo(St,Jt),l.stroke(),l.beginPath(),l.ellipse(S,Jt,y+8,x+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(S,Jt,y+8,x+4,0,0,ke),l.fill(),Tt>.5&&(l.strokeStyle=`rgba(${Math.min(255,un+60)},${Math.min(255,He+40)},${Math.min(255,at+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Zt),l.lineTo(pt,Zt),l.moveTo(St,Zt),l.lineTo(w,Zt),l.stroke()),yt={left:pt,right:St,h:P,w},(se.length>0||Ae)&&(yn(Zt,P,F),Ln(Zt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Xe=ke*y,Ft=10,En=Xe/Ft*.7,Ye=Xe/Ft*.3;l.setLineDash([En,Ye]);let Nn=Xe/ot;l.lineDashOffset=ie(D)*Nn;for(let T=0;T<=j;T++){let k=J(R,b,T);l.beginPath(),l.ellipse(S,k,y,x,0,0,ke),l.stroke()}l.setLineDash([]);let Mn=[],h=[];for(let T=0;T<j;T++){let k=J(R,b,T+.5);for(let Y=0;Y<ot;Y++){let G=Ot[T][Y];if(!G)continue;let X=$t(S,k,y,x,Y,D),U=Math.sin(X.ang),O={y:T,s:Y,yScr:k,p:X,depth:U,color:G};U<-.1?Mn.push(O):h.push(O)}}let I=Lt.getMagicTargetColor(),{isHighlighting:v,highlightedCells:et,highlightStartTime:Et,isMagicAnimation:xt}=M,Gt=null,ee=1,Nt=1,$e=!1;if(v&&et.length>0){Gt=new Set(et.map(k=>`${k.y},${k.s}`));let T=(performance.now()-Et)/1e3;if(xt){let k=Math.min(1,T/q);ee=1-k*.85,Nt=1-k*.9,$e=!0}else{let k=Math.min(1,T/p),Y=1-L;if(k>Y){let G=(k-Y)/L;ee=1-G*.85,Nt=1-G*.9,$e=!0}}}Mn.sort((T,k)=>T.depth-k.depth);for(let T of Mn){let k=b/j*.9,Y=mt[T.color]||null,G=.35,X=1,U=`${T.y},${T.s}`;Gt&&Gt.has(U)&&(G*=Nt,X=ee),Q(S,T.yScr,y,x,T.s,D,k,K,G,Y,.5,null,0,1,X)}let{isRingAnimation:Ie}=M;if(v&&et.length>0&&!xt){let T=(performance.now()-Et)/1e3,Y=Math.min(1,T/(Ie?$:p)),G=1-L,X=Y>G,U=X?(Y-G)/L:0,O=Ie?Math.floor(Y*G*ot*2)%ot:-1,_=4+Y/G*10,N=Math.sin(T*_*ke),it=X?1:.3+N*.3,nt=X?1-U*.8:1,lt=X?1-U:1;for(let ft of et){let _t=J(R,b,ft.y+.5),ge=Rt(S,_t,y,x,ft.s,D);if(Math.sin(ge.ang)>=-.1)continue;let mn=b/j*.9,Mt,Ce,fe;if(Ie){let V=(ft.s-O+ot)%ot,Te=V<3?1-V/3:0;Mt=(X?lt:.2+Te*.5)*.5,Ce=`rgba(255, 159, 67, ${Mt})`,fe=X?nt:1+Te*.15}else Mt=it*lt,Ce=ft.isLine?`rgba(255, 255, 255, ${Mt*.5})`:`rgba(255, 220, 100, ${Mt*.4})`,fe=X?nt:1.1;Q(S,_t,y,x,ft.s,D,mn,Ce,1,null,1,null,0,1,fe)}}h.sort((T,k)=>T.depth-k.depth);for(let T of h){let k=b/j*.9,Y=mt[T.color]||null,G=1,X=1,U=1,O=1,_=`${T.y},${T.s}`,N=Gt&&Gt.has(_);N&&(G=Nt,X=ee),I!==null&&!N&&(T.color!==I?(U=Kt,O=zt):O=qt),Q(S,T.yScr,y,x,T.s,D,k,Z,G,Y,U,null,0,O,X)}if(v&&et.length>0&&!xt){let T=(performance.now()-Et)/1e3,Y=Math.min(1,T/(Ie?$:p)),G=1-L,X=Y>G,U=X?(Y-G)/L:0,O=Ie?Math.floor(Y*G*ot*2)%ot:-1,_=4+Y/G*10,N=Math.sin(T*_*ke),it=X?1:.5+N*.5,nt=X?1-U*.8:1,lt=X?1-U:1;for(let ft of et){let _t=J(R,b,ft.y+.5),ge=Rt(S,_t,y,x,ft.s,D);if(Math.sin(ge.ang)<-.1)continue;let mn=b/j*.9,Mt,Ce,fe;if(Ie){let V=(ft.s-O+ot)%ot,Te=V<4?1-V/4:0;Mt=X?lt:.3+Te*.7,Ce=`rgba(255, 159, 67, ${Mt})`,fe=X?nt:1+Te*.2}else Mt=it*lt,Ce=ft.isLine?`rgba(255, 255, 255, ${Mt*.7})`:`rgba(255, 220, 100, ${Mt*.6})`,fe=X?nt:1.15;Q(S,_t,y,x,ft.s,D,mn,Ce,1,null,1,null,0,1,fe)}}let Ve=M.spellState||M,{transmuteState:ce,transmuteSourceBlock:Ut,transmuteTargetColor:Me,transmuteAreaCells:Fe,transmuteBlocksToChange:we}=Ve;if(ce==="selecting_source"){let T=b/j*.9,k=.35+Math.sin(C/150)*.15;for(let Y of h){let G=J(R,b,Y.y+.5);Q(S,G,y,x,Y.s,D,T,`rgba(0, 40, 20, ${k})`,1,null,1,null,0,1,1)}}if(ce==="selecting_target"&&we&&we.length>0){let T=b/j*.9,k=.4+Math.sin(C/120)*.25,Y=.6+Math.sin(C/120)*.4;for(let G of we){if(G.y<0||G.y>=j)continue;let X=J(R,b,G.y+.5),U=Rt(S,X,y,x,G.s,D);Math.sin(U.ang)<-.1||(Q(S,X,y,x,G.s,D,T,`rgba(0, 50, 30, ${k})`,1,null,1,null,0,1,1),Q(S,X,y,x,G.s,D,T,"transparent",1,null,1,`rgba(100, 255, 150, ${Y})`,3,1,1.02))}}if(ce==="animating"&&Lt.getTransmuteAnimState){let T=Lt.getTransmuteAnimState(C);if(T){let k=b/j*.9,{phase:Y,progress:G,areaFlash:X}=T;if(X>0&&Fe)for(let U of Fe){if(U.y<0||U.y>=j)continue;let O=J(R,b,U.y+.5),_=Rt(S,O,y,x,U.s,D);Math.sin(_.ang)<-.1||Q(S,O,y,x,U.s,D,k,`rgba(150, 255, 200, ${X*.4})`,1,null,1,null,0,1,1)}if(we&&we.length>0){let U=Ut?Ut.color:1,O=Me||1;for(let _ of we){if(_.y<0||_.y>=j)continue;let N=J(R,b,_.y+.5),it=Rt(S,N,y,x,_.s,D);if(Math.sin(it.ang)<-.1)continue;let lt=1,ft=mt[U],_t=0;if(Y==="shrink"?(lt=1-G*.95,ft=mt[U],_t=.5+G*.3):Y==="grow"&&(lt=G,ft=mt[O],_t=.8-G*.5),_t>0&&Q(S,N,y,x,_.s,D,k,`rgba(200, 255, 220, ${_t})`,1,null,1,null,0,1,1),lt>.05){let ge=Ne(S,N,y,x,_.s,D,k,1),Je=Math.min(ge.wApprox,ge.hApprox)*.28*lt;l.save(),l.globalAlpha=1,l.fillStyle=ft,l.beginPath(),l.arc(ge.cx,ge.cy,Je,0,ke),l.fill(),l.restore()}}}}}let{lightningState:je,lightningSourceBlock:gn,lightningAreaCells:Qe,lightningBlocksToHit:Dt}=Ve;if(je==="selecting_source"){let T=b/j*.9,k=.35+Math.sin(C/150)*.15;for(let Y of h){let G=J(R,b,Y.y+.5);Q(S,G,y,x,Y.s,D,T,`rgba(20, 20, 60, ${k})`,1,null,1,null,0,1,1)}}if(je==="animating"&&Lt.getLightningAnimState){let T=Lt.getLightningAnimState(C);if(T&&Dt&&Dt.length>0){let k=b/j*.9,{phase:Y,flashProgress:G,currentTarget:X,jumpProgress:U,struckTargets:O}=T;if(Y==="flash"&&G>0&&Qe)for(let _ of Qe){if(_.y<0||_.y>=j)continue;let N=J(R,b,_.y+.5),it=Rt(S,N,y,x,_.s,D);Math.sin(it.ang)<-.1||Q(S,N,y,x,_.s,D,k,`rgba(100, 150, 255, ${G*.5})`,1,null,1,null,0,1,1)}if(O&&O.length>0)for(let _ of O){let N=Dt[_];if(!N||N.y<0||N.y>=j)continue;let it=J(R,b,N.y+.5),nt=Rt(S,it,y,x,N.s,D);if(Math.sin(nt.ang)<-.1)continue;let ft=(O.length-1-O.indexOf(_))*.1,_t=Math.max(0,.8-ft);Q(S,it,y,x,N.s,D,k,`rgba(255, 255, 255, ${_t})`,1,null,1,`rgba(150, 200, 255, ${_t})`,2,1,1.05)}if(Y==="chain"&&X>=0&&X<Dt.length){let _=Dt[X];if(_&&_.y>=0&&_.y<j){let N=J(R,b,_.y+.5),it=Rt(S,N,y,x,_.s,D);if(Math.sin(it.ang)>=-.1){let lt=1-U;Q(S,N,y,x,_.s,D,k,`rgba(200, 220, 255, ${lt*.9})`,1,null,1,`rgba(100, 180, 255, ${lt})`,3,1,1.1-U*.05)}}if(X>0){let N=Dt[X-1],it=Dt[X];if(N&&it){let nt=J(R,b,N.y+.5),lt=J(R,b,it.y+.5),ft=Ne(S,nt,y,x,N.s,D,k,1),_t=Ne(S,lt,y,x,it.s,D,k,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-U*.5})`,l.lineWidth=2+(1-U)*2,l.lineCap="round",l.beginPath();let ge=ft.cx,Je=ft.cy,mn=_t.cx,Mt=_t.cy;l.moveTo(ge,Je);let Ce=4;for(let fe=1;fe<=Ce;fe++){let V=fe/Ce,Te=ge+(mn-ge)*V,Os=Je+(Mt-Je)*V,Un=fe<Ce?(Math.random()-.5)*8:0;l.lineTo(Te+Un,Os+Un)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-U)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:Ze,fireSourceBlock:be,fireLineCells:xe,fireTargets:on}=Ve;if(Ze==="selecting_source"){let T=b/j*.9,k=.3+Math.sin(C/140)*.2;for(let Y of h){let G=J(R,b,Y.y+.5);Q(S,G,y,x,Y.s,D,T,`rgba(70, 25, 10, ${k})`,1,null,1,null,0,1,1)}}if(Ze==="animating"&&Lt.getFireAnimState){let T=Lt.getFireAnimState(C);if(T&&xe&&xe.length>0){let k=b/j*.9,{progress:Y,flashProgress:G}=T,X=Math.sin(Y*Math.PI);if(G>0)for(let U of xe){if(U.y<0||U.y>=j)continue;let O=J(R,b,U.y+.5),_=Rt(S,O,y,x,U.s,D);Math.sin(_.ang)<-.1||Q(S,O,y,x,U.s,D,k,`rgba(255, 120, 50, ${G*.45})`,1,null,1,`rgba(255, 200, 140, ${G*.5})`,2,1,1.03)}if(be){let U=new Map;for(let _ of xe){if(_.y<0||_.y>=j)continue;let N=J(R,b,_.y+.5),it=Rt(S,N,y,x,_.s,D);if(Math.sin(it.ang)<-.1)continue;let lt=Ne(S,N,y,x,_.s,D,k,1),ft=_.s-be.s;ft>ot/2&&(ft-=ot),ft<-ot/2&&(ft+=ot);let _t=_.y;U.has(_t)||U.set(_t,[]),U.get(_t).push({x:lt.cx,y:lt.cy,offset:ft})}let O=Array.from(U.keys()).sort((_,N)=>N-_);if(O.length>0){let _=.35+.3*Math.sin(C/60)+X*.2;l.save(),l.lineCap="round";for(let N of O){let it=U.get(N)||[];if(it.sort((nt,lt)=>nt.offset-lt.offset),it.length!==0){l.beginPath(),l.moveTo(it[0].x,it[0].y);for(let nt=1;nt<it.length;nt++)l.lineTo(it[nt].x,it[nt].y);l.strokeStyle=`rgba(255, 140, 60, ${_})`,l.lineWidth=Math.max(2,k*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,l.lineWidth=Math.max(6,k*.35),l.stroke()}}l.restore()}}if(on&&on.length>0){let U=.2+X*.6;for(let O of on){if(O.y<0||O.y>=j)continue;let _=J(R,b,O.y+.5),N=Rt(S,_,y,x,O.s,D);Math.sin(N.ang)<-.1||Q(S,_,y,x,O.s,D,k,`rgba(255, 160, 70, ${U})`,1,null,1,`rgba(255, 230, 180, ${X*.6})`,2,1,1.05)}}}}let{activePiece:It,pieceY:fn,isGrounded:Xt,lockTimer:ve}=M;if(It){let T=Lt.snappedRot(),k=T,Y=Lt.computeGhostY(),G=b/j*.9;if(Y!==null){let O=[];for(let _=0;_<It.cells.length;_++){let N=It.cells[_],it=It.colors[_],nt=Y+N.y,lt=Lt.normSector(T+N.x);if(nt<0||nt>=j)continue;let ft=J(R,b,nt+.5),_t=Rt(S,ft,y,x,lt,k);O.push({cy:nt,cs:lt,yScr:ft,depth:Math.sin(_t.ang),color:it})}O.sort((_,N)=>_.depth-N.depth);for(let _ of O){let N=mt[_.color]||null;Q(S,_.yScr,y,x,_.cs,k,G,Le,1,N,.5,he,Wt,1,1)}}let X=vt;if(Xt&&ve>0){let O=Math.min(1,ve/W),_=255,N=Math.round(170+85*O),it=Math.round(180+75*O),nt=.75+(1-.75)*O;X=`rgba(${_},${N},${it},${nt})`}let U=[];for(let O=0;O<It.cells.length;O++){let _=It.cells[O],N=It.colors[O],it=Lt.normSector(T+_.x),nt=fn+_.y;if(nt<0||nt>=j)continue;let lt=J(R,b,nt+.5),ft=Rt(S,lt,y,x,it,k);U.push({cs:it,yScr:lt,depth:Math.sin(ft.ang),color:N})}U.sort((O,_)=>O.depth-_.depth);for(let O of U){let _=mt[O.color]||null;Q(S,O.yScr,y,x,O.cs,k,G,X,1,_,1,null,0,1,1)}}},drawNextPreview(F,C){if(!F)return;let M=F.getContext("2d"),w=F.width,P=F.height;if(M.clearRect(0,0,w,P),!C)return;let S=1/0,z=-1/0,A=1/0,bt=-1/0;for(let x of C.cells)S=Math.min(S,x.x),z=Math.max(z,x.x),A=Math.min(A,x.y),bt=Math.max(bt,x.y);let dt=z-S+1,y=bt-A+1,b=Math.min(w/(dt+.5),P/(y+.5)),R=(w-dt*b)/2,Ct=(P-y*b)/2;M.fillStyle=Z;for(let x=0;x<C.cells.length;x++){let Tt=C.cells[x],D=R+(Tt.x-S)*b,Ot=Ct+(y-1-(Tt.y-A))*b;M.fillRect(D+1,Ot+1,b-2,b-2);let Re=C.colors[x],gt=mt[Re];if(gt){let oe=(b-2)*.32;M.fillStyle=gt,M.beginPath(),M.arc(D+b/2,Ot+b/2,oe,0,ke),M.fill(),M.fillStyle=Z}}},spawnBonusBubbles(F){let{left:C,right:M,h:w,w:P}=yt;P>0&&De(F,C,M,w,P)}}}(()=>{let e=Bo(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,s=24,c=120,m={"30_24":{N:30,H:24,survivalTime:90,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function f(t){let o=m[t]||m["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let d=Math.PI/2,p=70,L=120,q=30,$=320,W=.42,st="rgb(235,240,250)",mt="rgb(55,62,75)",ue="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",K="rgba(110,255,150,0.85)",vt=2,Le={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},he={1:"fire",2:"water",3:"lightning",4:"earth"},Wt={fire:1,water:2,lightning:3,earth:4},Kt=1,zt=.58,qt=!0,jt=12,kt=25,Lt=1,l=2,ot=3,j=5,de=8,se=10,Oe=15,De=30,yn=2,Ln=.3,yt=.5,J=1,ie=.3,$t=.5,Vt=1.3,qe=10,Rt=500,Ne=[1,1.25,1.5,1.75,2],Q=10,ye=100,Se=25,Qt=[1,1.3,1.6,2],F=[1,1.5,2,2.5],C=_o(),M=C.loadGameSettings();M.hapticsEnabled===void 0&&(M.hapticsEnabled=!0);let w=M.invertSwipe?-1:1,P=M.magicEnabled??!1,S=-1,z=Io({enabled:M.hapticsEnabled}),A=Array.from({length:s},()=>new Uint8Array(i));function bt(){A=Array.from({length:s},()=>new Uint8Array(i))}let dt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,b=s+3,R=0,Ct=0,x=!1,Tt=0,D=0,Ot=0,Re=3,gt=0,oe=0,Ae=0,Ee=Do({canvas:n,rotDir:w}),Zt="0.16.6",an=!0,Sn="blue",B=bo();B.preload();let rt=Ho(),pt="intro",St=0,ln=0,Jt=0,Ue=0,un=0,He=null,at=rt.stats,te=0,dn=e.overlay,Rn=e.gameContainer,Xe=Ro({elementColors:Le}),Ft=Xe.showBonus.bind(Xe),En=Xe.getElementIcon.bind(Xe),Ye=Ao(),Nn=e.overlayTitle,Mn=e.overlayStats,h=e.startBtn,I=e.hud,v=e.scoreHud,et=e.timeHud,Et=e.remainingHud,xt=e.nextCanvas,Gt=xt.getContext("2d"),ee=e.pauseBtn,Nt=e.pauseOverlay,$e=e.resumeBtn,Ie=e.restartBtn,Ve=e.exitToMenuBtn,ce=e.pauseSettingsBtn,Ut=e.pauseSoundBtn,Me=e.pauseMusicBtn,Fe=e.pauseBestScore,we=e.pauseBestTime,je=e.pauseBestMode,gn=e.pauseCurrentScore,Qe=e.pauseCurrentTime,Dt=e.pauseCurrentMode,Ze=e.confirmDialog,be=e.confirmText,xe=e.confirmCancel,on=e.confirmOk,It=e.settingsOverlay,fn=e.settingsClose,Xt=e.fullscreenBtn,ve=e.rotateBtn,T=e.startPanel,k=e.gameoverPanel,Y=e.goScore,G=e.goTime,X=e.goRing,U=e.goMatches,O=e.goBonuses,_=e.goNewRecord,N=e.goRestartBtn,it=e.goExitBtn,nt=e.bestScore,lt=e.bestTimeVal,ft=e.startVersion,_t=e.modeBtns,ge=e.recordsBtn,Je=e.startSettingsBtn,mn=e.helpBtn,Mt="25_20";function Ce(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function fe(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let a=o.dataset.mode,E=m[a];if(!E)return;let H=o.querySelector(".mode-tag.time-tag");if(!H)return;let tt=Ce(E.survivalTime);tt&&(H.textContent=tt)})}fe();let V=wo({buttons:e.magicBtns,onActivate:()=>B.play("spells"),onChange:(t,o)=>{ms()}}),Te=e.magicBtns,Os=V.charges,Un=t=>me()?V.select(t):!1,An=()=>V.updateButtons(),Ds=e.magicRow,pn=e.magicToggle,wt=e.magicActiveIndicator,Hs=e.magicActiveIcon,$s=e.magicActiveCost,zo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},gs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},qo=["ice","earth","air","fire"];te=C.loadHighTowerRings();function In(t){return typeof ne?.getUnlockRings=="function"?ne.getUnlockRings(t):0}function Xn(t){let o=In(t);return o===0||te>=o}let Fs=["fire","water","lightning","earth"],bn=null,Yn=!1,jo=500,Qo=30,Zo=220,xn=null,fs=null,Gs={fire:!1,water:!1,lightning:!1,earth:!1};function Ns(){if(!wt)return;let t=wt.getBoundingClientRect();t.width>0&&t.height>0&&(fs=t)}function Jo(){if(!wt)return null;let t=wt.getBoundingClientRect();return t.width>0&&t.height>0?wt:fs?{getBoundingClientRect:()=>fs}:null}function wn(t=V.active){if(!wt||!Hs)return;t?(bn=t,Yn=!1):Yn||(bn=null);let o=bn;if(!o||!me()||(V.charges[o]??0)<=0){Ns(),wt.classList.add("hidden"),wt.classList.remove("active","ult-ready",...Fs),wt.style.setProperty("--progress","0%"),xn&&clearTimeout(xn),xn=setTimeout(()=>{wt.classList.add("gone")},Zo);return}xn&&(clearTimeout(xn),xn=null),wt.classList.remove("gone"),wt.classList.contains("hidden")?requestAnimationFrame(()=>wt.classList.remove("hidden")):wt.classList.remove("hidden"),Hs.textContent=En(o);let E=gs[o];E&&ne.selectSpell(E);let H=E?kn(E):0,tt=V.charges[o]??0,ct=!!E&&Kn()&&Xn(E),Yt=!!E&&Kn()&&!ct,pe=ct&&H>0?Math.min(tt/H,1):0,ze=ct&&H>0,_e=ze&&tt>=H;$s&&($s.textContent=ze?`-${H}`:Yt?"\u{1F512}":""),wt.classList.toggle("no-cost",!ze&&!Yt),wt.classList.toggle("locked",Yt),wt.classList.toggle("ult-ready",_e),wt.style.setProperty("--progress",`${Math.round(pe*100)}%`),wt.classList.remove("hidden",...Fs),wt.classList.add("active",o),Ns()}function ti(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),jo))}function Vn(){for(let[t,o]of Object.entries(Te)){if(!o)continue;let a=gs[t],E=kn(a),H=Kn()&&me()&&a,tt=typeof Xn=="function"?Xn(a):!0,ct=H&&tt&&E>0&&(V.charges[t]??0)>=E;o.classList.toggle("ult-ready",ct),ct&&!Gs[t]&&(ti(o),pt==="playing"&&B.play("readysuper")),Gs[t]=ct}}function me(t=Mt){return t==="30_24"?!0:P}function Us(){pn&&pn.classList.toggle("active",P)}function ms(){wn(V.active),Vn()}function ei(t){P=t,M.magicEnabled=t,C.saveGameSettings(M),Mt==="25_20"&&(P?V.reset():(V.deactivate(),Object.keys(V.charges).forEach(o=>{V.charges[o]=0})),An()),Wn(),Us(),ms()}function Wn(){Ds&&(Ds.style.display=me()?"":"none",wn(V.active),Vn())}function qi(t){let o=vn(t),a=kn(t);return!o||a<=0?!1:V.charges[o]>=a}function ji(t){let o=vn(t),a=kn(t);return!o||a<=0||V.charges[o]<a?!1:(V.charges[o]-=a,V.updateButtons(),ne.pulse(),!0)}let Pn=e.spellWave;function ni(){Pn&&(Pn.classList.remove("active"),Pn.offsetWidth,Pn.classList.add("active"),setTimeout(()=>Pn.classList.remove("active"),1200))}let tn=null,ne=Po({button:wt,onReady:()=>{B.play("readysuper")}}),si=()=>ne.getEffect("earth"),oi=()=>ne.getEffect("air"),ii=()=>ne.getEffect("fire"),kn=t=>typeof ne?.getCost=="function"?ne.getCost(t):0,vn=t=>zo[t]??null;tn=Oo({canvas:n,dom:e,getGrid:()=>A,getN:()=>i,getH:()=>s,getRotFloat:()=>gt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:q,MAX_RADIUS_X:$,SCORE_MAGIC_DESTROY:Se},helpers:{normSector:Zn,levelYToScreenY:qn,sectorCenterXY:jn},Spell:ne,Magic:V,SoundModule:B,State:rt,isGamePlaying:()=>pt==="playing",addPendingKzDrop:t=>{Ot+=t},getKillRate:g,triggerSpellWave:ni,spawnSpellBubbles:t=>{let o=vn(ne.currentSpell)??"water";Ye.spawnSpellBubbles(ne.button,o,t)},spawnBonusBubbles:t=>{_n.spawnBonusBubbles(t)},getTransmuteEffect:si,getLightningEffect:oi,getFireEffect:ii,continueMatchProcessing:Qn,updateScoreHud:Hn,showBonus:Ft,getSpellCost:kn,getSpellElement:vn,onUltimateApplied:t=>{let o=vn(t)??vn(ne.currentSpell)??"water";if(typeof Ye?.spawnSpellBubbles=="function"){let a=Jo();a&&Ye.spawnSpellBubbles(a,o,Qo)}Yn=!1,bn=null,wn(null),Vn()},isSpellBlocked:ci,setScore:t=>{St=t},setCascadeLevel:t=>{nn=t}});function Kn(){return Mt==="30_24"}function zn(){wn(V.active),Vn()}let en=[],On=0,We=!1,cn=!1,Cn=!1,Pe=0,Ke=0,nn=0,Tn=[];function ci(){return We||cn||Cn}function qn(t,o,a){let E=1-a/s;return t+E*o}function jn(t,o,a,E,H,tt){let ct=(H-tt)/i*u+d;return{x:t+Math.cos(ct)*a,y:o+Math.sin(ct)*E,ang:ct}}function Xs(t,o){let a=n.clientWidth,E=n.clientHeight,H=a*.5,tt=(a-2*q)/2,ct=E-p-L,Yt=6,pe=i*ct/(Yt*s),ze=E-L,_e,Bt,ut;pe<=Math.min(tt,$)?(_e=pe,Bt=ct,ut=p):(_e=Math.min(tt,$),Bt=_e*Yt*s/i,ut=ze-Bt);let ht=_e*.28,Pt=qn(ut,Bt,t+.5),Ht=jn(H,Pt,_e,ht,o,gt),re=n.getBoundingClientRect();return{x:re.left+Ht.x,y:re.top+Ht.y}}function ri(t,o){if(!me()||!V.canUse()||We)return!1;let a=Wt[V.active],E=n.clientWidth,H=n.clientHeight,tt=E*.5,ct=(E-2*q)/2,Yt=H-p-L,pe=6,ze=i*Yt/(pe*s),_e=H-L,Bt,ut,ht;ze<=Math.min(ct,$)?(Bt=ze,ut=Yt,ht=p):(Bt=Math.min(ct,$),ut=Bt*pe*s/i,ht=_e-ut);let Pt=Bt*.28,Ht=null,re=1/0;for(let ae=0;ae<s;ae++){let Be=qn(ht,ut,ae+.5);for(let le=0;le<i;le++){let rs=A[ae][le];if(!rs||rs!==a)continue;let Gn=jn(tt,Be,Bt,Pt,le,gt);if(Math.sin(Gn.ang)<-.1)continue;let as=t-Gn.x,ho=o-Gn.y,yo=Math.hypot(as,ho),So=ut/s*.9,Hi=So*1.2;Math.abs(as)<Hi/2&&Math.abs(ho)<So/2&&yo<re&&(re=yo,Ht={y:ae,s:le})}}if(Ht){let ae=qn(ht,ut,Ht.y+.5),Be=jn(tt,ae,Bt,Pt,Ht.s,gt),le=n.getBoundingClientRect(),rs=le.left+Be.x,Gn=le.top+Be.y,po=Te[V.active];return Ye.spawnMagicShot(V.active,po,rs,Gn,()=>{let as=A[Ht.y][Ht.s];en=[{y:Ht.y,s:Ht.s,color:as,isLine:!1,isMagic:!0}],On=performance.now(),We=!0,cn=!0,Pe=0,Ke=Se,Ft(`+${Se}`,"score")}),nn=0,V.useCharge(),at.magicUsed++,!0}return!1}let Qi=100;function Zi(t,o){return Ps(t,o,s,i)}function ai(){return Go(A,s,i)}let li=No;function ui(t){let o=t.map(E=>({...E,color:A[E.y][E.s]}));for(let E of t)A[E.y][E.s]=0;let a=s;for(let E of t){let H=E.y;for(let tt=1;tt<=E.y;tt++){let ct=E.y-tt;if(A[ct][E.s]){H=tt-1;break}}a=Math.min(a,H)}for(let E of o)A[E.y-a][E.s]=E.color;return a>0}function di(){let t=!0;for(;t;){t=!1;let o=ai();for(let a of o)li(a)||ui(a)&&(t=!0)}}function gi(){Qn()}let ps=$o;function Ys(t,o){let a=new Map,E=0,H=0,tt=0,ct={},Yt=t.length+o.length;for(let ut of t){let ht=he[ut.color],Pt=0,Ht=0;if(ut.length>=5?(Pt=ot,Ht=se,at.lines5++):ut.length===4?(Pt=l,Ht=de,at.lines4++):ut.length===3&&(Pt=Lt,Ht=j,at.lines3++),me()&&ht&&Pt>0){V.addCharges(ht,Pt),ct[ht]=(ct[ht]||0)+Pt;let re=ut.cells[Math.floor(ut.cells.length/2)],ae=Xs(re.y,re.s),Be=Te[ht];for(let le=0;le<Pt;le++)setTimeout(()=>{Ye.spawnMagicOrb(ht,ae.x,ae.y,Be)},le*100)}E+=Ht*g(),tt+=Ht,H+=ut.length*Q;for(let re of ut.cells){let ae=`${re.y},${re.s}`;a.has(ae)||a.set(ae,{y:re.y,s:re.s,color:ut.color,isLine:!0})}}for(let ut of o){if(at.pairs++,E+=Oe*g(),tt+=Oe,H+=ye,me()){let ht=[...new Set(ut.cells.map(Pt=>A[Pt.y][Pt.s]).filter(Boolean))];if(ht.length>0){let Pt=ut.cells[Math.floor(ut.cells.length/2)],Ht=Xs(Pt.y,Pt.s);ht.forEach((re,ae)=>{let Be=he[re];if(!Be)return;V.addCharges(Be,1),ct[Be]=(ct[Be]||0)+1;let le=Te[Be];le&&setTimeout(()=>{Ye.spawnMagicOrb(Be,Ht.x,Ht.y,le)},ae*100)})}}for(let ht of ut.cells){let Pt=`${ht.y},${ht.s}`;a.has(Pt)||a.set(Pt,{y:ht.y,s:ht.s,color:A[ht.y][ht.s],isLine:!1})}}let pe=ps(Qt,Yt-1),ze=ps(F,nn),_e=Math.round(H*pe*ze),Bt=0;Yt>1&&(at.combos++,at.maxCombo=Math.max(at.maxCombo,Yt),setTimeout(()=>Ft(`COMBO \xD7${Yt}`,"combo"),Bt),Bt+=180,B.play("combo2")),nn>0&&(at.cascades++,at.maxCascade=Math.max(at.maxCascade,nn),setTimeout(()=>Ft(`CASCADE \xD7${nn}`,"cascade"),Bt),Bt+=180,B.play("cascade")),(t.length>0||o.length>0)&&B.play("combo");for(let ut of t){let ht=ut.length,Pt=ht*Q;setTimeout(()=>Ft(`Line-${ht} +${Pt}`,"line",ut.color),Bt),Bt+=100}for(let ut of o){let ht=ut.cells.length>0?A[ut.cells[0].y][ut.cells[0].s]:null;setTimeout(()=>Ft(`Pair +${ye}`,"pair",ht),Bt),Bt+=100}_e>0&&(setTimeout(()=>Ft(`+${_e}`,"score"),Bt),Bt+=120),tt>0&&(setTimeout(()=>Ft(`+${tt}s`,"time"),Bt),Bt+=120);for(let[ut,ht]of Object.entries(ct))ht>0&&(setTimeout(()=>Ft(`+${ht}${En(ut)}`,"charge"),Bt),Bt+=120);en=Array.from(a.values()),On=performance.now(),We=!0,cn=!1,Pe=E,Ke=_e,An()}function fi(){for(let t of en)A[t.y][t.s]=0;if(en.length>0&&B.playRandom("disappear"),Pe>0){Ot+=Pe;let t=Pe/g();_n.spawnBonusBubbles(t)}rt.addScore(Ke),St+=Ke,Hn(),en=[],We=!1,cn=!1,Pe=0,Ke=0,nn++,Qn()}function Qn(){di();let{lineMatches:t,pairMatches:o}=vi();if(t.length>0||o.length>0)Ys(t,o);else{let a=js();a.length>0?Mi(a):!y&&pt==="playing"&&qs()}}function Ji(t,o){Ys(t,o)}function Zn(t){return Bn(t,i)}function Jn(){return Zn(Math.round(gt))}function Vs(t,o){return ks(y,t,o,A,s,i)}function ts(t){return Vs(t,Jn())}let es=Fo;function Ws(){qt&&(jt!==0&&Tt>=jt||(Ct=0,Tt+=1))}function mi(){if(!y)return;let t=y.cells,o=y.colors,a={cells:t,colors:o};if(S>=0||(a=es(a.cells,a.colors),a=es(a.cells,a.colors)),a=es(a.cells,a.colors),y.cells=a.cells,y.colors=a.colors,!ts(Math.floor(b))){y.cells=t,y.colors=o;return}B.play("turn"),x&&Ws()}function pi(){return Uo(y,b,Jn(),A,s,i)}function hi(){if(!y)return!1;let t=Math.floor(b)-1,o=!ts(t);return o&&!x?(x=!0,Ct=0,Tt=0):!o&&x&&(x=!1,Ct=0,Tt=0),o}let hn=ds;function Dn(){if(pt==="playing"){dn.classList.add("hidden"),ee.classList.remove("hidden");return}if(dn.classList.remove("hidden"),ee.classList.add("hidden"),pt==="intro"){T.classList.remove("hidden"),k.classList.add("hidden");let t=C.loadHighscore(Mt);t.score>0?(nt.textContent=t.score.toLocaleString(),lt.textContent=hn(t.time)):(nt.textContent="0",lt.textContent="0:00"),Bs(),ft.textContent=`v${Zt}`,h.classList.remove("idlePulse"),h.offsetWidth,h.classList.add("idlePulse")}else{T.classList.add("hidden"),k.classList.remove("hidden"),Y.textContent=St.toLocaleString(),G.textContent=hn(Jt);let t=C.loadHighscore(Mt);St>0&&St>=t.score?_.classList.remove("hidden"):_.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${at.rings}</span>
          <span class="count ring-max">${at.maxRing>0?"max \xD7"+at.maxRing:""}</span>
        </div>
      `;X.innerHTML=o;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${at.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${at.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${at.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${at.pairs}</span>
        </div>
      `;U.innerHTML=a;let E=me()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${at.magicUsed}</span>
        </div>
      `:"",H=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${at.combos}</span>
          <span class="count max-combo">${at.maxCombo>0?"max \xD7"+at.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${at.cascades}</span>
          <span class="count max-cascade">${at.maxCascade>0?"max \xD7"+at.maxCascade:""}</span>
        </div>
        ${E}
      `;O.innerHTML=H}}function Hn(){v.textContent=`Score: ${St}`}function hs(){et.textContent=`Time: ${hn(Jt)}`}function Ks(){let t=Math.max(0,(s-D)/g()),o=Math.floor(t/60),a=Math.floor(t%60);Et.textContent=`Left: ${o}:${a.toString().padStart(2,"0")}`,t<30?Et.classList.add("warning"):Et.classList.remove("warning")}function yi(){f(Mt),bt(),D=0,Ot=0,gt=oe=0,Ae=0,rt.start(),at=rt.stats,St=0,ln=performance.now(),Jt=0,un=0,Ue=0,pt="playing",He=null,me()?V.reset():(V.deactivate(),Object.keys(V.charges).forEach(t=>{V.charges[t]=0}),An()),ne.reset(),zn(),en=[],Tn=[],We=!1,cn=!1,Cn=!1,Pe=0,Ke=0,nn=0,tn.reset(),An(),Hn(),hs(),Ks(),ms(),qs(),_n.drawNextPreview(xt,He),Dn(),B.getSettings().musicEnabled&&B.startGameMusic()}function ys(){rt.gameOver(),pt="gameover",y=null,x=!1,Ct=0,Tt=0;let t=C.saveHighscore(St,Jt,Mt);B.stopMusic(),B.play("gameover"),hs(),Dn(),t&&St>0&&setTimeout(()=>{Ft("\u{1F3C6} NEW RECORD!","score")},500)}function Si(t){for(let a=0;a<50;a++){let E=t.map(()=>1+(Math.random()*4|0));if(!Ei(t,E))return E}return t.map((a,E)=>1+E%4)}let Ei=Vo;function zs(t){let o=t.cells.map(E=>({x:E.x,y:E.y})),a=Si(o);return{name:t.name,cells:o,colors:a}}function qs(){if(!He){let H=dt[Math.random()*dt.length|0];He=zs(H)}y=He;let t=dt[Math.random()*dt.length|0];He=zs(t),_n.drawNextPreview(xt,He);let o=1/0,a=-1/0;for(let H of y.cells)H.x<o&&(o=H.x),H.x>a&&(a=H.x);let E=(o+a)/2;for(let H of y.cells)H.x=H.x-Math.round(E);b=s+3,R=0,x=!1,Ct=0,Tt=0,ts(Math.floor(b))?B.playRandom("appear"):ys()}function js(){return Yo(A,s,i)}function Mi(t){if(t.length===0)return;let o=[];for(let Yt of t)for(let pe=0;pe<i;pe++)o.push({y:Yt,s:pe,color:A[Yt][pe],isLine:!1});Tn=t,en=o,On=performance.now(),We=!0,Cn=!0,cn=!1;let a=t.length;at.rings+=a,at.maxRing=Math.max(at.maxRing,a);let E=ps(Ne,a-1),H=Math.round(Rt*a*E),tt=De*a;Ke=H,Pe=tt*g(),B.play("ring");let ct=`RING \xD7${a}`;Ft(ct,"ring"),setTimeout(()=>Ft(`+${H}`,"score"),150),setTimeout(()=>Ft(`+${tt}s`,"time"),300)}function bi(){let t=[...Tn].sort((o,a)=>a-o);for(let o of t){for(let a=o;a<s-1;a++)A[a].set(A[a+1]);A[s-1].fill(0)}if(Pe>0){Ot+=Pe;let o=Pe/g();_n.spawnBonusBubbles(o)}rt.addScore(Ke),St+=Ke,Hn(),Mt==="30_24"&&Tn.length>0&&(te=C.addHighTowerRings(Tn.length)),en=[],Tn=[],We=!1,Cn=!1,Pe=0,Ke=0,Qn()}function tc(){return js().length}function xi(){if(!y)return;let t=Jn();gt=t,oe=t,Ae=0;let o=!1;for(let a=0;a<y.cells.length;a++){let E=y.cells[a],H=y.colors[a],tt=Math.floor(b)+E.y,ct=Zn(t+E.x);tt>=s&&(o=!0),tt>=0&&tt<s&&(A[tt][ct]=H)}if(o){ys();return}rt.addScore(qe),St+=qe,Hn(),Ft(`+${qe}`,"score"),B.playRandom("drop"),y=null,nn=0,gi()}function vi(){return Xo(A,s,i)}function Ci(){if(!y)return!1;let t=Math.floor(b)-1;return ts(t)?(b=t,x=!1,Ct=0,Tt=0,!0):(x=!0,!1)}n.addEventListener("pointerdown",t=>{if(At.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),a=t.clientX-o.left,E=t.clientY-o.top;Ee.handlePointerDown(t,{onMagicTap:me()?()=>tn.handleTap(a,E)?!0:At.applyCommand("magic_shoot",{x:a,y:E}):null,onDoubleTap:()=>At.applyCommand("rotate_piece")},oe)||(Ae=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(At.state!=="playing"||!Ee.dragging)return;t.preventDefault?.();let o=Ee.handlePointerMove(t,{canRotateTo:(a,E)=>At.canRotateTo(a,E),onDrop:()=>At.applyCommand("move_down"),onGroundedMove:()=>At.onGroundedMove(),onRotateStep:()=>z.trigger("tower_rotate")},At.pieceY,At.isGrounded);o&&At.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{At.state==="playing"&&Ee.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Ee.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Ee.dragging&&Ee.handlePointerUp(t)},{passive:!1}),ve.addEventListener("click",()=>{At.state==="playing"&&At.applyCommand("rotate_piece")});let ns=e.dropBtn,ss=null;function Ti(){At.state==="playing"&&(At.applyCommand("move_down"),ss=setInterval(()=>{if(At.state!=="playing"){os();return}At.applyCommand("move_down")},kt))}function os(){ss&&(clearInterval(ss),ss=null)}ns.addEventListener("pointerdown",t=>{t.preventDefault(),Ti()}),ns.addEventListener("pointerup",os),ns.addEventListener("pointerleave",os),ns.addEventListener("pointercancel",os);for(let[t,o]of Object.entries(Te))o.addEventListener("click",()=>{At.state==="playing"&&me()&&At.applyCommand("select_magic",{element:t})});wt&&wt.addEventListener("click",()=>{if(At.state!=="playing"||!Kn()||!me())return;let t=V.active??bn;if(!t)return;let o=gs[t];!o||!Xn(o)||(ne.selectSpell(o),V.active&&(bn=V.active,Yn=!0,V.deactivate()),tn.handleSpellButtonClick())});let Ss=e.soundsToggle,Es=e.musicToggle;function rn(){let t=B.getSettings();t.soundsEnabled?Ss.classList.add("active"):Ss.classList.remove("active"),t.musicEnabled?Es.classList.add("active"):Es.classList.remove("active");for(let o=0;o<=4;o++){let a=e.soundVolBtns[o],E=e.musicVolBtns[o];a&&a.classList.toggle("active",t.soundVolume===o),E&&E.classList.toggle("active",t.musicVolume===o)}}let Qs=e.tabBtns,_i=e.tabContents;Qs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;Qs.forEach(a=>a.classList.remove("active")),_i.forEach(a=>a.classList.remove("active")),t.classList.add("active"),Lo(o).classList.add("active"),o==="sounds"&&rn()})});let Zs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Js=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Bi=e.iosHint,Li=e.standaloneBadge;function to(){let t=document.fullscreenElement||document.webkitFullscreenElement;Xt.textContent=t?"Disable":"Enable"}Zs&&(Js?(Li.style.display="block",Xt.style.display="none"):(Bi.style.display="block",Xt.textContent="Not supported",Xt.style.opacity="0.5",Xt.style.cursor="default")),Xt.addEventListener("click",()=>{if(Zs&&!Js)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",to),document.addEventListener("webkitfullscreenchange",to);let is=e.invertSwipeToggle,sn=e.hapticsToggle;M.invertSwipe&&is.classList.add("active"),sn&&(z.supports()?M.hapticsEnabled&&sn.classList.add("active"):(sn.classList.add("disabled"),sn.classList.remove("active"),M.hapticsEnabled=!1,z.setEnabled(!1),C.saveGameSettings(M))),pn&&Us(),is.addEventListener("click",()=>{is.classList.toggle("active");let t=is.classList.contains("active");Ee.rotDir=t?-1:1,M.invertSwipe=t,C.saveGameSettings(M)}),sn&&sn.addEventListener("click",()=>{if(sn.classList.contains("disabled"))return;sn.classList.toggle("active");let t=sn.classList.contains("active");M.hapticsEnabled=t,C.saveGameSettings(M),z.setEnabled(t)}),pn&&pn.addEventListener("click",()=>{pn.classList.toggle("active");let t=pn.classList.contains("active");ei(t)}),Ss.addEventListener("click",()=>{let o=!B.getSettings().soundsEnabled;B.updateSettings({soundsEnabled:o}),rn(),$n()}),Es.addEventListener("click",()=>{let o=!B.getSettings().musicEnabled;B.updateSettings({musicEnabled:o}),rn(),$n(),pt!=="paused"&&(o?pt==="playing"?B.startGameMusic():B.startMenuMusic():B.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{B.updateSettings({soundVolume:t}),rn(),B.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{B.updateSettings({musicVolume:t}),rn()})}rn();function eo(){pt==="playing"&&(rt.pause(),Ue=performance.now(),pt="paused",B.musicAudio&&B.musicAudio.pause())}function cs(){pt==="paused"&&(rt.resume(),un+=performance.now()-Ue,Ue=0,pt="playing",xs=performance.now(),B.getSettings().musicEnabled&&B.startGameMusic())}function $n(){let t=B.getSettings();Ut.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Ut.classList.toggle("off",!t.soundsEnabled),Me.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Me.classList.toggle("off",!t.musicEnabled)}function Ri(){Nt.classList.remove("hidden"),ee.classList.add("hidden");let t=C.loadHighscore(Mt);if(Fe.textContent=t.score?t.score.toLocaleString():"0",we.textContent=t.time?ds(t.time):"0:00",je.textContent=Mt==="30_24"?"High Tower":"Quick Tower",gn.textContent=St.toLocaleString(),Qe.textContent=ds(Jt),Dt.textContent=Mt==="30_24"?"High Tower":"Quick Tower",$n(),co){let o=Mt==="30_24";co.style.display=o?"":"none",o&&Bs()}}function Fn(){Nt.classList.add("hidden"),ee.classList.remove("hidden")}ee.addEventListener("click",()=>{eo(),Ri()}),$e.addEventListener("click",()=>{Fn(),cs()});let Ms=null;function no(t,o){be.textContent=t,Ms=o,Ze.classList.remove("hidden")}function so(){Ze.classList.add("hidden"),Ms=null}xe.addEventListener("click",()=>{so()}),on.addEventListener("click",()=>{let t=Ms;so(),t&&t()}),Ie.addEventListener("click",()=>{no("Restart game?",()=>{Fn(),At.applyCommand("start_game")})}),Ve.addEventListener("click",()=>{no("Exit to menu?",()=>{Fn(),ee.classList.add("hidden"),pt="intro",rt.reset(),B.stopMusic(),B.getSettings().musicEnabled&&B.startMenuMusic(),Dn()})}),ce.addEventListener("click",()=>{It.classList.remove("hidden")}),Ut.addEventListener("click",()=>{let t=B.getSettings();B.updateSettings({soundsEnabled:!t.soundsEnabled}),$n(),rn()}),Me.addEventListener("click",()=>{let o=!B.getSettings().musicEnabled;B.updateSettings({musicEnabled:o}),$n(),rn()}),Nt.addEventListener("click",t=>{t.target===Nt&&(Fn(),cs())}),document.addEventListener("keydown",t=>{pt==="paused"&&!Nt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Fn(),cs())}),fn.addEventListener("click",()=>{It.classList.add("hidden")}),It.addEventListener("click",t=>{t.target===It&&It.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?pt==="playing"&&(eo(),bs=!0):bs&&pt==="paused"&&(cs(),bs=!1)});let At=Wo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Kt,LOCK_DELAY_SEC:zt,getKillRate:g,MATCH_HIGHLIGHT_SEC:yn,MAGIC_SHRINK_SEC:yt,RING_HIGHLIGHT_SEC:J,getState:()=>({gameState:pt,score:St,elapsedMs:Jt,startTime:ln,totalPausedMs:un,stats:at,activePiece:y,pieceY:b,targetRot:oe,rotFloat:gt,rotVel:Ae,isGrounded:x,isHighlighting:We,isMagicAnimation:cn,isRingAnimation:Cn,highlightStartTime:On,killLevel:D,grid:A,fallTimer:R,lockTimer:Ct}),setState:t=>{"elapsedMs"in t&&(Jt=t.elapsedMs),"killLevel"in t&&(D=t.killLevel),"fallTimer"in t&&(R=t.fallTimer),"lockTimer"in t&&(Ct=t.lockTimer),"targetRot"in t&&(oe=t.targetRot),"rotFloat"in t&&(gt=t.rotFloat),"rotVel"in t&&(Ae=t.rotVel)},funcs:{startGame:yi,endGame:ys,rotatePieceByDir:mi,tryMoveDown:Ci,canPlaceAtRot:Vs,maybeResetLockDelay:Ws,shootMagic:ri,selectMagic:Un,updateGroundedState:hi,lockPiece:xi,finishHighlight:fi,finishRingHighlight:bi},ui:{updateTimeHud:hs,updateRemainingHud:Ks}}),_n=Ko({canvas:n,canvasCtx:r,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:q,MAX_RADIUS_X:$,RADIUS_X_FACTOR:W,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:yn,MATCH_SHRINK_PHASE:Ln,MAGIC_SHRINK_SEC:yt,RING_HIGHLIGHT_SEC:J,LOCK_DELAY_SEC:zt,getKillRate:g,ELEMENT_COLORS:Le,ELEMENT_TO_COLOR:Wt,BLOCK_COLOR_FRONT:st,BLOCK_COLOR_BACK:mt,ACTIVE_COLOR_FRONT:ue,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:K,GHOST_STROKE_WIDTH:vt,MAGIC_DIM_DOT_ALPHA:ie,MAGIC_DIM_DOT_SCALE:$t,MAGIC_TARGET_DOT_SCALE:Vt,getState:()=>({gameState:pt,grid:A,activePiece:y,pieceY:b,rotFloat:gt,killLevel:D,isHighlighting:We,highlightedCells:en,highlightStartTime:On,isMagicAnimation:cn,isRingAnimation:Cn,isGrounded:x,lockTimer:Ct,spellState:tn.getRenderState()}),getVisualSettings:()=>({waterBubbles:an,waterColor:Sn}),funcs:{snappedRot:Jn,computeGhostY:pi,normSector:Zn,getMagicTargetColor:()=>me()&&V.canUse()?Wt[V.active]:null,getTransmuteAnimState:t=>tn.getTransmuteAnimState(t),getLightningAnimState:t=>tn.getLightningAnimState(t),getFireAnimState:t=>tn.getFireAnimState(t)}}),xs=performance.now();function oo(t){let o=Math.min(.05,Math.max(.001,(t-xs)/1e3));if(xs=t,At.update(o,t),tn.update(t),Ot>0){let a=Math.min(Ot,Re*o);D=Math.max(0,D-a),Ot-=a}gt=oe,gt>1e6&&(gt%=i),gt<-1e6&&(gt%=i),_n.render(o,t),requestAnimationFrame(oo)}h.addEventListener("click",()=>{At.applyCommand("start_game")}),N.addEventListener("click",()=>{At.applyCommand("start_game")}),it.addEventListener("click",()=>{pt="intro",rt.reset(),B.stopMusic(),B.getSettings().musicEnabled&&B.startMenuMusic(),Dn()}),_t.forEach(t=>{t.addEventListener("click",o=>{_t.forEach(E=>E.classList.remove("active")),t.classList.add("active"),Mt=t.dataset.mode,zn(),Wn();let a=C.loadHighscore(Mt);a.score>0?(nt.textContent=a.score.toLocaleString(),lt.textContent=hn(a.time)):(nt.textContent="0",lt.textContent="0:00"),h.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>h.classList.add("idlePulse"),2e3)})});let vs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),Ai=document.getElementById("spellProgressFill"),io=document.getElementById("spellProgressMarkers"),co=document.getElementById("pauseSpellProgress"),Ii=document.getElementById("pauseSpellProgressFill"),ro=document.getElementById("pauseSpellProgressMarkers"),ao=document.getElementById("pauseSpellProgressLabel");function Ts(){return qo.map(t=>In(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function wi(t){let o=Ts(),a=_s(o);return a<=0?"":`${Math.min(t,a)}/${a}`}function lo(t){if(!t)return;t.innerHTML="";let o=Ts(),a=_s(o);o.forEach(E=>{let H=document.createElement("span");H.className="marker",H.dataset.threshold=E;let tt=a>0?E/a*100:0;H.style.left=`${tt}%`,t.appendChild(H)})}function uo(t,o){if(!t)return;let a=Pi(o);t.style.width=`${a}%`}function go(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(E=>{let H=parseInt(E.dataset.threshold,10)||0;E.classList.toggle("reached",o>=H)})}function Pi(t){let o=Ts(),a=_s(o);return t<=0||a<=0?0:t>=a?100:t/a*100}function fo(t){if(!Cs)return;let o=In(t),a=ne.getDescription(t);o===0||te>=o?Cs.innerHTML=a:Cs.innerHTML=`${a} <span class="spell-progress-text">${te}/${o}</span>`}function Bs(){te=C.loadHighTowerRings(),vs.forEach(o=>{let a=o.dataset.spell,E=In(a),H=te>=E;o.classList.toggle("locked",!H);let tt=o.querySelector(".spell-lock");tt&&(tt.style.display=H?"none":"")}),uo(Ai,te),uo(Ii,te),go(io,te),go(ro,te),ao&&(ao.textContent=wi(te));let t=document.querySelector(".spell-select-btn.active");t&&fo(t.dataset.spell)}lo(io),lo(ro),Bs(),vs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){_t.forEach(Yt=>Yt.classList.remove("active")),a.classList.add("active"),Mt="30_24",zn(),Wn();let ct=C.loadHighscore(Mt);ct.score>0?(nt.textContent=ct.score.toLocaleString(),lt.textContent=hn(ct.time)):(nt.textContent="0",lt.textContent="0:00")}let E=t.dataset.spell,H=In(E),tt=te>=H;fo(E),tt&&(vs.forEach(ct=>ct.classList.remove("active")),t.classList.add("active"),ne.selectSpell(E),wn(V.active))})}),ge.addEventListener("click",()=>{let t=C.loadHighscore("30_24"),o=C.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${hn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${hn(o.time)}
`:`  No record yet
`,alert(a)}),Je.addEventListener("click",()=>{It.classList.remove("hidden")}),mn.addEventListener("click",()=>{let t=me()?`6) Use magic: tap element button, then tap matching block

`:`6) Magic is disabled in settings (Quick Tower)

`;alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
`+t+"Survive as long as you can!")}),An(),Wn(),zn(),Dn(),B.startMenuMusic();let ki=()=>{if(B.unlock(),!B.getSettings().musicEnabled)return;let t=B.musicAudio;!t||t.paused||t.ended?At.state==="playing"?B.startGameMusic():B.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},mo=0,Oi=10,Di=()=>{mo>=Oi||(mo++,ki())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Di,{passive:!0})}),requestAnimationFrame(oo)})();})();
