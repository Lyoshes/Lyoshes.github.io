(()=>{var $i=[0,.25,.5,.75,1],Fi=[0,.05,.15,.25,.5],Gi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Eo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Mo="soundSettings";function Ni(){try{let e=localStorage.getItem(Mo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ui(e){try{localStorage.setItem(Mo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function bo(){return{audioContext:null,buffers:{},settings:Ni(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return $i[this.settings.soundVolume]},getMusicVolume(){return Fi[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(u){console.debug(`Failed to load sound: ${n} from ${c}`,u)}},preload(){this.initContext();for(let[n,c]of Object.entries(Gi))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;c!==null&&(u=`${n}${c}`);let i=this.buffers[u];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Eo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ui(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var xo="eb_highscore",vo="eb_highscore_quick",Co="eb_settings",To="eb_high_tower_rings",Xi={invertSwipe:!1,magicEnabled:!1,hapticsEnabled:!0};function _o(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?vo:xo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let u=this.loadHighscore(c);if(e>u.score||e===u.score&&n>u.time){let i=c==="25_20"?vo:xo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Xi}},saveGameSettings(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(To);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(To,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function Bo(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),magicToggle:document.getElementById("magicToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Lo(e){return document.getElementById("tab-"+e)}var Yi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ro(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(u,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=u,s&&n[s]&&(r.style.color=n[s]);let m=window.innerWidth/2,f=window.innerHeight/2-40,g=(Math.random()-.5)*200,d=(Math.random()-.5)*100+c*36;r.style.left=`${m+g}px`,r.style.top=`${f+d}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(u){return Yi[u]||"\u2726"}}}var Ls={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ao(){return{spawnMagicOrb(e,n,c,u){if(!u)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Ls[e]||"\u2726";let s=u.getBoundingClientRect(),r=s.left+s.width/2-n,m=s.top+s.height/2-c,f=Math.hypot(r,m),g=Math.atan2(m,r),d=f*.35*(Math.random()>.5?1:-1),p=g+Math.PI/2,L=r*.5+Math.cos(p)*d,z=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${L}px`),i.style.setProperty("--mid-y",`${z}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,u,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,m=s.top+s.height/2,f=document.createElement("div");f.className=`magic-shot ${e}`,f.textContent=Ls[e]||"\u2726";let g=c-r,d=u-m;f.style.setProperty("--end-x",`${g}px`),f.style.setProperty("--end-y",`${d}px`),f.style.left=`${r}px`,f.style.top=`${m}px`,document.body.appendChild(f);let p=setInterval(()=>{let L=f.getBoundingClientRect();this.spawnTrailParticle(e,L.left+L.width/2,L.top+L.height/2)},40);setTimeout(()=>{clearInterval(p),f.remove(),this.spawnExplosion(e,c,u),i&&i()},300)},spawnTrailParticle(e,n,c){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${c}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,f=Math.cos(r)*m,g=Math.sin(r)*m;s.style.setProperty("--px",`${f}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let u=n;typeof n=="number"&&(c=n,u="water"),Ls[u]||(u="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,m=Math.max(8,Math.round(c));for(let f=0;f<m;f++){let g=document.createElement("div");g.className=`spell-bubble ${u}`,g.textContent="\u25CF";let d=f/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,L=Math.cos(d)*p,z=Math.sin(d)*p-20;g.style.setProperty("--px",`${L}px`),g.style.setProperty("--py",`${z}px`),g.style.left=`${s}px`,g.style.top=`${r}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,m=Math.hypot(s,r),f=Math.atan2(r,s),g=m*.35*(Math.random()>.5?1:-1),d=f+Math.PI/2,p=s*.5+Math.cos(d)*g,L=r*.5+Math.sin(d)*g;u.style.setProperty("--mid-x",`${p}px`),u.style.setProperty("--mid-y",`${L}px`),u.style.setProperty("--end-x",`${s}px`),u.style.setProperty("--end-y",`${r}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}var Vi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Wi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},As=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Io({enabled:e=!0,patterns:n=Vi}={}){let c=Wi(),u=c?new As(c):new Rs,i=u.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let m=n[r];return m?u.trigger({name:r,...m}):!1}}}function wo(e={}){let{buttons:n={},onActivate:c=null,onChange:u=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[f,g]of Object.entries(n)){if(!g)continue;let d=i[f],p=g.querySelector(".charges");p&&(p.textContent=d),g.classList.toggle("empty",d<=0),g.classList.toggle("active",s===f&&d>0)}u&&u({...i},s)}function m(f){let g=n[f];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(f){s=f},select(f){if(i[f]<=0)return!1;let g=s===f;return s=g?null:f,r(),!g&&s===f&&c&&c(),!g},useCharge(){if(!s||i[s]<=0)return!1;let f=s;return i[f]--,s=null,r(),m(f),!0},addCharges(f,g){i[f]!==void 0&&(i[f]+=g,r(),m(f))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(f){for(let[g,d]of Object.entries(n))d&&d.addEventListener("click",()=>{f&&f(g)})}}}var Ge={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Po(e={}){let{button:n=null,onActivate:c=null,onProgress:u=null,onReady:i=null}=e,s="ice",r=0;function m(){return Ge[s]||Ge.ice}function f({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),L=Number.isFinite(p.maxProgress)?p.maxProgress:0,z=L>0?Math.min(r/L,1)*100:0,U=L>0&&r>=L;n.style.setProperty("--progress",`${z}%`);let K=n.querySelector(".spell-icon");K&&(K.textContent=p.icon);let st=n.querySelector(".spell-counter");st&&(st.textContent=L>0?`${Math.min(r,L)}/${L}`:""),n.classList.toggle("ready",U),n.classList.toggle("charging",!U&&r>0),u&&!d&&L>0&&u(r,L)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},get effect(){return m().effect},getUnlockRings(d){return(Ge[d]||Ge.ice).unlockRings??0},getCost(d){return(Ge[d]||Ge.ice).cost??0},getDescription(d){return(Ge[d]||Ge.ice).description||""},getEffect(d){return(Ge[d]||Ge.ice).effect},get button(){return n},selectSpell(d){Ge[d]&&(s=d,r=0,f())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let L=r<p.maxProgress;return r=Math.min(r+d,p.maxProgress),f(),g(),L&&r>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){r=Math.max(0,d),f({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},use(){if(!this.canUse())return null;let d=m().effect;return r=0,f(),g(),c&&c(s),d},reset(){r=0,f()},pulse(){g()},updateButton:f,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function Is({centerY:e,centerS:n,size:c,H:u,normSector:i}){let s=[],r=Math.floor(c/2);for(let m=-r;m<=r;m++)for(let f=-r;f<=r;f++){let g=e+m,d=i(n+f);if(g<0||g>=u)continue;let p=m*m+f*f;s.push({y:g,s:d,distSq:p})}return s}function ls(e,n,c){return n.filter(u=>e[u.y][u.s]===c)}function us(e,n){return[...e].sort((u,i)=>u.distSq!==i.distSq?u.distSq-i.distSq:u.y!==i.y?u.y-i.y:u.s-i.s).slice(0,n).map(u=>({y:u.y,s:u.s}))}function ko({centerY:e,centerS:n,beamLength:c,beamWidth:u,N:i,H:s,normSector:r}){if(e<0||e>=s||u<=0||c<0||i<=0)return[];let m=Math.min(u,s),f=[],g=new Set,d=U=>U<0||U>=s||g.has(U)?!1:(g.add(U),f.push(U),!0);d(e);for(let U=1;f.length<m&&(e+U<s||e-U>=0)&&(d(e+U),!(f.length>=m));U++)d(e-U);f.sort((U,K)=>K-U);let p=Math.min(i,c*2+1),L=c%2===0,z=[];for(let U of f){let K=new Set,st=(mt,ue)=>{let Z=r(mt);return K.has(Z)?!1:(K.add(Z),z.push({y:U,s:Z,dist:ue}),!0)};st(n,0);for(let mt=1;K.size<p&&mt<i;mt++)if(L){if(st(n+mt,mt),K.size>=p)break;st(n-mt,mt)}else{if(st(n-mt,mt),K.size>=p)break;st(n+mt,mt)}}return z}function Oo(e){let{canvas:n,dom:c,getGrid:u,getN:i,getH:s,getRotFloat:r,constants:m,helpers:f,Spell:g,Magic:d,SoundModule:p,State:L,isGamePlaying:z,addPendingKzDrop:U,getKillRate:K,triggerSpellWave:st,spawnSpellBubbles:mt,spawnBonusBubbles:ue,getTransmuteEffect:Z,getLightningEffect:W,getFireEffect:bt,continueMatchProcessing:Le,updateScoreHud:he,showBonus:ee,getSpellCost:Vt,getSpellElement:Wt,onUltimateApplied:Kt,isSpellBlocked:qt,setScore:kt,setCascadeLevel:Bt}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:ot,SIDE_MARGIN_PX:j,MAX_RADIUS_X:de,SCORE_MAGIC_DESTROY:ne}=m,{normSector:Oe,levelYToScreenY:De,sectorCenterXY:yn}=f,Ln=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],yt="idle",J=null,ie=null,$t=[],Yt=[],ze=0,Lt=null,Ne=0,Q="idle",ye=null,Se=[],zt=[],$=0,C=0,M="idle",I=null,P=[],S=[],q=0;function A(h){if(typeof Vt!="function"||typeof Wt!="function")return!1;let w=Wt(h),v=Vt(h);return!w||!v?!1:(d.charges[w]??0)>=v}function Mt(h){if(typeof Vt!="function"||typeof Wt!="function")return!1;let w=Wt(h),v=Vt(h);return!w||!v||(d.charges[w]??0)<v?!1:(d.charges[w]-=v,d.updateButtons(),g.pulse(),!0)}let dt=0,y=350;function b(){return typeof qt=="function"?qt():!1}function R(){let h=performance.now();h-dt<y||(dt=h,p.play("cancel"))}function vt(){yt="selecting_source",J=null,ie=null,$t=[],Yt=[],Q!=="idle"&&ct(),M!=="idle"&&St(),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function x(){yt!=="idle"&&p.play("cancel"),yt="idle",J=null,ie=null,$t=[],Yt=[],gt();let h=c.spellBtn;h&&h.classList.remove("selecting")}function Ct(h,w){if(yt!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,w);if(!v)return x(),!0;let et=u();J={y:v.y,s:v.s,color:et[v.y][v.s]},$t=Is({centerY:v.y,centerS:v.s,size:Z().areaSize,H:s(),normSector:Oe});let xt=J.color,Rt=ls(et,$t,xt);return Yt=us(Rt,Z().maxBlocks),Ot(J.color,v.y),yt="selecting_target",!0}function D(h,w){let v=n.clientWidth,et=n.clientHeight,xt=v*.5,Rt=(v-2*j)/2,oe=et-l-ot,Jt=6,Gt=s(),$e=i(),Ie=r(),Ve=$e*oe/(Jt*Gt),re=et-ot,Nt,Me,Fe;Ve<=Math.min(Rt,de)?(Nt=Ve,Me=oe,Fe=l):(Nt=Math.min(Rt,de),Me=Nt*Jt*Gt/$e,Fe=re-Me);let we=Nt*.28,je=null,gn=1/0,Qe=u();for(let Dt=0;Dt<Gt;Dt++){let Ze=De(Fe,Me,Dt+.5);for(let be=0;be<$e;be++){if(!Qe[Dt][be])continue;let xe=yn(xt,Ze,Nt,we,be,Ie);if(Math.sin(xe.ang)<-.1)continue;let It=h-xe.x,fn=w-xe.y,Ut=Math.hypot(It,fn),ve=Me/Gt*.9,T=ve*1.2;Math.abs(It)<T/2&&Math.abs(fn)<ve/2&&Ut<gn&&(gn=Ut,je={y:Dt,s:be})}}return je}function Ot(h,w){gt();let v=document.createElement("div");v.className="transmute-popup";let et=n.clientWidth,xt=n.clientHeight,Rt=(et-2*j)/2,oe=xt-l-ot,Jt=6,Gt=s(),$e=i(),Ie=$e*oe/(Jt*Gt),Ve=xt-ot,re,Nt;Ie<=Math.min(Rt,de)?(re=oe,Nt=l):(re=Math.min(Rt,de)*Jt*Gt/$e,Nt=Ve-re);let Me=De(Nt,re,w+.5),Fe=Math.floor(Z().areaSize/2),we=De(Nt,re,Math.min(Gt,w+Fe)+.5),je=De(Nt,re,Math.max(0,w-Fe)+.5),gn=Nt+re/2,Qe=document.getElementById("gameContainer"),Dt=Qe?Qe.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},Ze=160,be=60,xe=20,on=Dt.left+Dt.width/2-Ze/2,It;Me<gn?It=Dt.top+je+xe:It=Dt.top+we-be-xe,It=Math.max(10,Math.min(window.innerHeight-be-10,It)),v.style.left=`${on}px`,v.style.top=`${It}px`,Ln.filter(Ut=>Ut.color!==h).forEach(Ut=>{let ve=document.createElement("button");ve.className=`transmute-btn ${Ut.name}`,ve.innerHTML=Ut.icon,ve.setAttribute("data-color",Ut.color),ve.addEventListener("click",T=>{T.stopPropagation(),se(Ut.color)}),v.appendChild(ve)}),document.body.appendChild(v),Lt=v,Ne=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Re)},50)}function Re(h){performance.now()-Ne<200||Lt&&!Lt.contains(h.target)&&x()}function gt(){document.removeEventListener("pointerdown",Re),Lt&&(Lt.remove(),Lt=null)}function se(h){if(b()){R();return}if(!A(g.currentSpell)){R();return}if(gt(),ie=h,Yt.length===0){x();return}Ae()}function Ae(){if(!J){x();return}if(Yt.length===0){x();return}if(!Mt(g.currentSpell)){R(),x();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),yt="animating",ze=performance.now(),p.play("esseffect")}function Ee(){if(yt!=="selecting_target"&&yt!=="animating"||!J||!$t||$t.length===0)return;let h=u(),w=h[J.y]?.[J.s]??0;if(!w||w!==J.color){x();return}let v=ls(h,$t,w),et=Z().maxBlocks??v.length;Yt=us(v,et),Yt.length===0&&x()}function jt(h){if(yt!=="animating")return!1;let w=(h-ze)/1e3;return Math.min(w/Z().animSec,1)>=1?(Sn(),!1):!0}function an(h){if(yt!=="animating")return null;let w=(h-ze)/1e3,v=Math.min(w/Z().animSec,1),et="flash",xt=0,Rt=0;return v<.15?(et="flash",Rt=1-v/.15):v<.55?(et="shrink",xt=(v-.15)/.4):(et="grow",xt=(v-.55)/.45),{phase:et,progress:xt,areaFlash:Rt}}function Sn(){let h=u();for(let w of Yt)h[w.y][w.s]=ie;yt="idle",J=null,ie=null,$t=[],Yt=[],Bt(0),Le(),typeof Kt=="function"&&Kt("earth")}function B(){p.play("ulta"),Q="selecting_source",ye=null,Se=[],zt=[],C=0,yt!=="idle"&&(yt="idle",J=null,ie=null,$t=[],Yt=[],gt()),M!=="idle"&&(M="idle",I=null,P=[],S=[],q=0),d.deactivate();let h=c.spellBtn;h&&h.classList.add("selecting")}function ct(){Q!=="idle"&&p.play("cancel"),Q="idle",ye=null,Se=[],zt=[],C=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function pt(){M="selecting_source",I=null,P=[],S=[],q=0,yt!=="idle"&&(yt="idle",J=null,ie=null,$t=[],Yt=[],gt()),Q!=="idle"&&(Q="idle",ye=null,Se=[],zt=[],C=0),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function St(){M!=="idle"&&p.play("cancel"),M="idle",I=null,P=[],S=[],q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function ln(h,w){if(Q!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,w);if(!v)return ct(),!0;let et=u();ye={y:v.y,s:v.s,color:et[v.y][v.s]},Se=Is({centerY:v.y,centerS:v.s,size:W().areaSize,H:s(),normSector:Oe});let xt=ye.color,Rt=ls(et,Se,xt);return zt=us(Rt,W().maxBlocks),zt.length===0?(ct(),!0):A(g.currentSpell)?(Ue(),!0):(R(),!0)}function Qt(h,w){if(M!=="selecting_source")return!1;if(b())return R(),!0;let v=D(h,w);if(!v)return St(),!0;let et=u();return I={y:v.y,s:v.s,color:et[v.y][v.s]},P=ko({centerY:v.y,centerS:v.s,beamLength:bt().beamLength,beamWidth:bt().beamWidth,N:i(),H:s(),normSector:Oe}),S=P.filter(xt=>et[xt.y][xt.s]),S.length===0?(St(),!0):A(g.currentSpell)?(Zt(),!0):(R(),!0)}function Ue(){if(!ye||zt.length===0){ct();return}if(!Mt(g.currentSpell)){R(),ct();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),Q="animating",$=performance.now(),C=0,p.play("asseffect")}function un(h){if(Q!=="animating")return!1;let w=h-$,v=W().flashMs+zt.length*W().jumpMs;return w>=v?(at(),!1):!0}function He(h){if(Q!=="animating")return null;let w=h-$;if(w<W().flashMs)return{phase:"flash",flashProgress:1-w/W().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let v=w-W().flashMs,et=Math.floor(v/W().jumpMs),xt=v%W().jumpMs/W().jumpMs,Rt=[];for(let oe=0;oe<Math.min(et,zt.length);oe++)Rt.push(oe);return{phase:"chain",flashProgress:0,currentTarget:Math.min(et,zt.length-1),jumpProgress:xt,struckTargets:Rt}}function at(){let h=u(),v=zt.length*ne;L.addScore(v),kt(L.score),he(),ee(`+${v}`,"score");for(let et of zt)h[et.y][et.s]=0;Q="idle",ye=null,Se=[],zt=[],C=0,Bt(0),Le(),typeof Kt=="function"&&Kt("air")}function Zt(){if(!I||S.length===0){St();return}if(!Mt(g.currentSpell)){R(),St();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),M="animating",q=performance.now(),p.play("fsseffect")}function dn(h){return M!=="animating"?!1:(h-q)/1e3>=bt().animSec?(Xe(),!1):!0}function Rn(h){if(M!=="animating")return null;let w=Math.max(.001,bt().animSec),v=(h-q)/1e3,et=Math.min(v/w,1),xt=.25,Rt=et<xt?1-et/xt:0;return{progress:et,flashProgress:Rt}}function Xe(){let h=u(),w=S.length;if(w>0){let v=w*ne;L.addScore(v),kt(L.score),he(),ee(`+${v}`,"score")}for(let v of S)h[v.y][v.s]=0;M="idle",I=null,P=[],S=[],q=0,Bt(0),Le(),typeof Kt=="function"&&Kt("fire")}function Ft(){let h=typeof z=="function"?z():L.isPlaying(),w=g.currentSpell;if(!h)return!1;if(w==="ice"){if(b()||!A(w)||!Mt(g.currentSpell))return R(),!1;let v=g.effect;return typeof U=="function"&&typeof K=="function"&&U(v.duration*K()),p.play("wsseffect"),ee(`\u{1F4A7} -${v.duration}s`,"time"),typeof st=="function"&&st(),typeof ue=="function"&&ue(v.duration),typeof Kt=="function"&&Kt(w),!0}return w==="earth"?yt==="selecting_source"||yt==="selecting_target"?(x(),!0):yt!=="idle"||b()||!A(w)?(R(),!1):(yt==="idle"&&vt(),!0):w==="air"?Q==="selecting_source"?(ct(),!0):Q!=="idle"||b()||!A(w)?(R(),!1):(Q==="idle"&&B(),!0):w==="fire"?M==="selecting_source"?(St(),!0):M!=="idle"||b()||!A(w)?(R(),!1):(M==="idle"&&pt(),!0):!1}function En(h){Ee(),jt(h),un(h),dn(h)}function Ye(h,w){return b()&&(yt==="selecting_source"||Q==="selecting_source"||M==="selecting_source")?(R(),!0):yt==="selecting_source"?Ct(h,w):Q==="selecting_source"?ln(h,w):M==="selecting_source"?Qt(h,w):!1}function Nn(){yt="idle",J=null,ie=null,$t=[],Yt=[],gt(),Q="idle",ye=null,Se=[],zt=[],C=0,M="idle",I=null,P=[],S=[],q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function Mn(){return{transmuteState:yt,transmuteSourceBlock:J,transmuteTargetColor:ie,transmuteAreaCells:$t,transmuteBlocksToChange:Yt,lightningState:Q,lightningSourceBlock:ye,lightningAreaCells:Se,lightningBlocksToHit:zt,fireState:M,fireSourceBlock:I,fireLineCells:P,fireTargets:S}}return{startTransmuteSourceSelection:vt,cancelTransmutation:x,startLightningSourceSelection:B,cancelLightning:ct,startFireSourceSelection:pt,cancelFire:St,handleTap:Ye,update:En,reset:Nn,getRenderState:Mn,getTransmuteAnimState:an,getLightningAnimState:He,getFireAnimState:Rn,handleSpellButtonClick:Ft,isTransmuteSelecting:()=>yt==="selecting_source",isLightningSelecting:()=>Q==="selecting_source"}}var Ki={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Do(e={}){let{canvas:n}=e,c=e.rotDir||1,u=!1,i=0,s=0,r=0,m=0,f=0,g=1,d=null,p=0,L=0,z=0,U=0,K=0,st=0,mt=0,ue=0,Z=Ki;return{get rotDir(){return c},set rotDir(W){c=W},get dragging(){return u},get dragMode(){return d},handlePointerDown(W,bt,Le){if(bt.onMagicTap&&bt.onMagicTap(W.clientX,W.clientY))return!0;let he=performance.now(),ee=he-st,Vt=W.clientX-mt,Wt=W.clientY-ue,Kt=Math.hypot(Vt,Wt);return ee<=Z.DOUBLE_TAP_MS&&Kt<=Z.DOUBLE_TAP_MAX_DIST?(bt.onDoubleTap&&bt.onDoubleTap(),st=0):(st=he,mt=W.clientX,ue=W.clientY),u=!0,g=-1,i=W.clientX,s=W.clientY,r=Le,m=0,f=0,d=null,p=he,L=W.clientX,z=W.clientY,U=p,K=0,n&&n.setPointerCapture(W.pointerId),!1},handlePointerMove(W,bt,Le,he){if(!u)return null;let ee=W.clientX-i,Vt=W.clientY-s,Wt=performance.now();if(Math.abs(ee)<Z.DEADZONE_PX&&Math.abs(Vt)<Z.DEADZONE_PX)return null;if(d){if(d==="rotate"){let qt=Math.abs(ee),kt=Math.abs(Vt);if(kt>=qt*Z.AXIS_DOMINANCE&&kt>=Z.DROP_SWIPE_MIN_DISTANCE){let Bt=Math.max(1,Wt-p);kt/Bt*1e3>=Z.DROP_SWIPE_MIN_SPEED&&(d="drop",f=0)}}}else{let qt=Math.abs(ee),kt=Math.abs(Vt);if(Vt<0)qt>=Z.DEADZONE_PX&&(d="rotate");else if(kt>=qt*Z.AXIS_DOMINANCE){if(kt>=Z.DROP_SWIPE_MIN_DISTANCE){let Bt=Math.max(1,Wt-p);kt/Bt*1e3>=Z.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else qt>=kt*Z.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let Kt=null;if(d==="rotate"&&Math.abs(ee)>=Z.DEADZONE_PX){let qt=Math.max(1,Wt-U),kt=W.clientX-L,Bt=Math.max(1,Math.abs(kt)/qt*1e3),l=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/Bt)));K+=-kt/l*c*g;let ot=Math.trunc(K);ot!==0&&(K-=ot);let j=m+ot;if(j!==m&&bt.canRotateTo){let de=Math.sign(j-m),ne=r+m;for(;m!==j;){let Oe=m+de,De=r+Oe;if(!bt.canRotateTo(Math.floor(Le),De))break;m=Oe,ne=De,bt.onRotateStep&&bt.onRotateStep(),he&&bt.onGroundedMove&&bt.onGroundedMove()}Kt={targetRot:ne,rotFloat:ne}}}if(d==="drop"&&Vt>=Z.DROP_SWIPE_MIN_DISTANCE&&bt.onDrop){let qt=Math.max(1,Wt-U),kt=W.clientY-z,Bt=Math.max(1,kt/qt*1e3),l=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/Bt))),ot=Math.trunc(Vt/l);if(ot>f){let j=ot-f;for(let de=0;de<j;de++)bt.onDrop();f=ot}}return L=W.clientX,z=W.clientY,U=Wt,Kt},handlePointerUp(W){if(u&&(u=!1,d=null,n&&W&&W.pointerId!==void 0))try{n.releasePointerCapture(W.pointerId)}catch{}},reset(){u=!1,d=null,m=0,f=0,K=0}}}var ws={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ho(){let e="intro",n=0,c=0,u=0,i=0,s=0,r={...ws};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),u=0,i=0,s=0,r={...ws}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&c>0&&(u=performance.now()-c-s)},getFormattedTime(){let m=Math.floor(u/1e3),f=Math.floor(m/60),g=m%60;return`${f}:${g.toString().padStart(2,"0")}`},incrementStat(m,f=1){m in r&&(r[m]+=f)},updateMaxStat(m,f){m in r&&f>r[m]&&(r[m]=f)},reset(){e="intro",n=0,c=0,u=0,i=0,s=0,r={...ws}}}}function Bn(e,n){return e%=n,e<0&&(e+=n),e}function $o(e,n){return e[Math.min(n,e.length-1)]}function ds(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),u=n%60;return`${c}:${u.toString().padStart(2,"0")}`}function Fo(e,n){let c=e.map(({x:m,y:f},g)=>({x:f,y:-m,color:n[g]})),u=1/0,i=-1/0,s=1/0;for(let m of c)u=Math.min(u,m.x),i=Math.max(i,m.x),s=Math.min(s,m.y);let r=Math.round((u+i)/2);for(let m of c)m.x-=r,m.y-=s;return c.sort((m,f)=>m.y-f.y||m.x-f.x),{cells:c.map(m=>({x:m.x,y:m.y})),colors:c.map(m=>m.color)}}function Ps(e,n,c,u){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Bn(n-1,u)}),i.push({y:e,s:Bn(n+1,u)}),i}function Go(e,n,c){let u=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||u[s][r])continue;let m=[],f=[{y:s,s:r}];for(u[s][r]=1;f.length>0;){let g=f.shift();m.push(g);for(let d of Ps(g.y,g.s,n,c))e[d.y][d.s]&&!u[d.y][d.s]&&(u[d.y][d.s]=1,f.push(d))}i.push(m)}return i}function No(e){return e.some(n=>n.y===0)}function ks(e,n,c,u,i,s){if(!e)return!1;let r=Bn(c,s);for(let m of e.cells){let f=n+m.y,g=Bn(r+m.x,s);if(f<0)return!1;if(!(f>=i)&&u[f][g])return!1}return!0}function Uo(e,n,c,u,i,s){if(!e)return null;let r=Math.floor(n);for(;ks(e,r-1,c,u,i,s);)r-=1;return r}function Xo(e,n,c){let u=[],i=[];for(let s=0;s<n;s++){let r=[],m=0,f=e[s][0],g=f?1:0;for(let d=1;d<=c;d++){let p=d<c?e[s][d]:0;p&&p===f?g++:(g>=1&&f&&r.push({start:m,length:g,color:f}),m=d,f=p,g=p?1:0)}if(r.length>=2){let d=r[0],p=r[r.length-1];if(d.start===0&&p.start+p.length===c&&d.color===p.color){let L=d.length+p.length;r[0]={start:p.start,length:L,color:d.color},r.pop()}}for(let d of r)if(d.length>=3){let p=[];for(let L=0;L<d.length;L++)p.push({y:s,s:(d.start+L)%c});u.push({color:d.color,length:d.length,cells:p})}}for(let s=0;s<c;s++){let r=0,m=e[0][s],f=m?1:0;for(let g=1;g<=n;g++){let d=g<n?e[g][s]:0;if(d&&d===m)f++;else{if(f>=3&&m){let p=[];for(let L=0;L<f;L++)p.push({y:r+L,s});u.push({color:m,length:f,cells:p})}r=g,m=d,f=d?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let m=e[s][r],f=e[s][(r+1)%c],g=e[s][(r+2)%c],d=e[s][(r+3)%c];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let m=e[r][s],f=e[r+1][s],g=e[r+2][s],d=e[r+3][s];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:u,pairMatches:i}}function Yo(e,n,c){let u=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&u.push(i)}return u}function Vo(e,n){let c=new Map;e.forEach((u,i)=>c.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],s=n[u],r=1;for(let st=1;st<=2&&c.get(`${i.x+st},${i.y}`)===s;st++)r++;if(r>=3)return!0;let m=1;for(let st=1;st<=2&&c.get(`${i.x},${i.y+st}`)===s;st++)m++;if(m>=3)return!0;let f=s,g=c.get(`${i.x+1},${i.y}`),d=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(f&&g&&d&&p&&f===g&&d===p&&f!==d)return!0;let L=s,z=c.get(`${i.x},${i.y+1}`),U=c.get(`${i.x},${i.y+2}`),K=c.get(`${i.x},${i.y+3}`);if(L&&z&&U&&K&&L===z&&U===K&&L!==U)return!0}return!1}function Wo(e){let{getN:n,getH:c,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:f,getState:g,setState:d,funcs:p,ui:L}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(z,U={}){let K=g();if(z==="start_game")return K.gameState!=="playing"?(p.startGame(),!0):!1;if(K.gameState!=="playing")return!1;switch(z){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:st}=U;return typeof st=="number"&&p.canPlaceAtRot(Math.floor(K.pieceY),st)?(d({targetRot:st,rotFloat:st,rotVel:0}),K.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:st,y:mt}=U;return p.shootMagic(st,mt)}case"select_magic":{let{element:st}=U;return p.selectMagic(st),!0}default:return console.warn("GameEngine: unknown command",z),!1}},update(z,U){let K=g();if(K.gameState!=="playing")return;let st=U-K.startTime-K.totalPausedMs;d({elapsedMs:st}),L.updateTimeHud();let mt=K.killLevel+s()*z;if(d({killLevel:mt}),L.updateRemainingHud(),mt>=c()){p.endGame();return}if(K.isHighlighting){let W=(U-K.highlightStartTime)/1e3,bt;K.isRingAnimation?bt=f:K.isMagicAnimation?bt=m:bt=r,W>=bt&&(K.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ue=K.fallTimer+z;if(ue>=u&&(ue-=u,p.tryMoveDown()),d({fallTimer:ue}),p.updateGroundedState()){let W=K.lockTimer+z;d({lockTimer:W}),W>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(z,U){return p.canPlaceAtRot(z,U)},getRotation(){let z=g();return{targetRot:z.targetRot,rotFloat:z.rotFloat,rotVel:z.rotVel}},setRotation(z){d({targetRot:z,rotFloat:z,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var ke=Math.PI*2;function Ko(e){let{canvas:n,canvasCtx:c,getN:u,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:m,MAX_RADIUS_X:f,RADIUS_X_FACTOR:g,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:L,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:U,LOCK_DELAY_SEC:K,getKillRate:st,ELEMENT_COLORS:mt,ELEMENT_TO_COLOR:ue,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:W,ACTIVE_COLOR_FRONT:bt,GHOST_COLOR_FILL:Le,GHOST_COLOR_STROKE:he,GHOST_STROKE_WIDTH:ee,MAGIC_DIM_DOT_ALPHA:Vt,MAGIC_DIM_DOT_SCALE:Wt,MAGIC_TARGET_DOT_SCALE:Kt,getState:qt,getVisualSettings:kt,funcs:Bt}=e,l=c,ot=u(),j=i(),de={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},ne=[],Oe=40;function De($,C,M,I,P){let S=Math.max(3,Math.round($)),q=180;for(let A=0;A<S;A++)setTimeout(()=>{let Mt=Math.random()>.5?"left":"right",dt=15,y=Mt==="left"?dt+Math.random()*Math.max(10,C-dt*2):M+dt+Math.random()*Math.max(10,P-M-dt*2),b=I-10;ne.push({x:y,baseX:y,y:b,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:dt,maxX:P-dt})},A*q)}function yn($,C,M){ne=ne.filter(I=>I.y>$+I.size&&I.y>-20);for(let I of ne){I.y-=Oe*M,I.wobble+=I.wobbleSpeed*M;let P=I.baseX+Math.sin(I.wobble)*I.wobbleAmp;I.x=Math.max(I.minX,Math.min(I.maxX,P))}}function Ln($){if(ne.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let C of ne)C.y<$+C.size||(l.beginPath(),l.arc(C.x,C.y,C.size,0,Math.PI*2),l.fill(),l.stroke())}}let yt={left:0,right:0,h:0,w:0};function J($,C,M){let I=1-M/j;return $+I*C}function ie($){return $=$%ot,$<0?$+ot:$}function $t($,C,M,I,P,S){let q=ie(S),A=(P-q)/ot*ke+d;return{x:$+Math.cos(A)*M,y:C+Math.sin(A)*I,ang:A}}let Yt=.52,ze=1.02;function Lt($,C,M,I,P,S){let q=ie(S),A=(P-q)/ot*ke+d;return{x:$+Math.cos(A)*M,y:C+Math.sin(A)*I,ang:A}}function Ne($,C,M,I,P,S,q,A=1){let Mt=Lt($,C,M,I,P-Yt,S),dt=Lt($,C,M,I,P+Yt,S),y={x:Mt.x,y:Mt.y-q*.5},b={x:Mt.x,y:Mt.y+q*.5},R={x:dt.x,y:dt.y-q*.5},vt={x:dt.x,y:dt.y+q*.5},x=(y.x+R.x+vt.x+b.x)*.25,Ct=(y.y+R.y+vt.y+b.y)*.25,D=ze*A,Ot=A,Re=[y,R,vt,b].map(Ae=>({x:x+(Ae.x-x)*D,y:Ct+(Ae.y-Ct)*Ot})),gt=Math.abs((dt.x-Mt.x)*D),se=Math.abs(q*Ot);return{corners:Re,cx:x,cy:Ct,wApprox:gt,hApprox:se,ang:Lt($,C,M,I,P,S).ang}}function Q($,C,M,I,P,S,q,A,Mt=1,dt=null,y=1,b=null,R=0,vt=1,x=1){let Ct=Ne($,C,M,I,P,S,q,x),[D,Ot,Re,gt]=Ct.corners;if(l.save(),l.globalAlpha=Mt,l.fillStyle=A,l.beginPath(),l.moveTo(D.x,D.y),l.lineTo(Ot.x,Ot.y),l.lineTo(Re.x,Re.y),l.lineTo(gt.x,gt.y),l.closePath(),l.fill(),b&&R>0&&(l.strokeStyle=b,l.lineWidth=R,l.stroke()),dt){let se=Math.min(Ct.wApprox,Ct.hApprox)*.28*vt;l.globalAlpha=Mt*y,l.fillStyle=dt,l.beginPath(),l.arc(Ct.cx,Ct.cy,se,0,ke),l.fill()}l.restore(),l.globalAlpha=1}function ye($,C,M,I,P,S){let q=$t($,C,M,I,P,S),A=$t($,C,M,I,P+1,S),Mt=$t($,C,M,I,P-1,S),dt=Math.abs(A.x-q.x),y=Math.abs(q.x-Mt.x),b=(dt+y)*.5*1.06;return Math.max(1,b)}function Se($,C,M,I,P,S){let q=(P-S)/ot*ke+d;return{x:$+Math.cos(q)*M,y:C+Math.sin(q)*I,ang:q}}function zt($,C,M,I,P,S,q,A=1,Mt=null,dt=1,y=null,b=0,R=1){l.save(),l.translate($,C);let vt=Math.atan2(I,M);if(l.rotate(vt),l.globalAlpha=A,l.fillStyle=q,l.fillRect(-P/2,-S/2,P,S),y&&b>0&&(l.strokeStyle=y,l.lineWidth=b,l.strokeRect(-P/2,-S/2,P,S)),Mt){let x=Math.min(P,S)*.28*R;l.globalAlpha=A*dt,l.fillStyle=Mt,l.beginPath(),l.arc(0,0,x,0,ke),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let $=Math.max(1,Math.min(2,window.devicePixelRatio||1)),C=Math.floor(n.clientWidth*$),M=Math.floor(n.clientHeight*$);(n.width!==C||n.height!==M)&&(n.width=C,n.height=M,l.setTransform($,0,0,$,0,0))},render($=.016,C=performance.now()){this.resize();let M=qt();ot=u(),j=i();let I=n.clientWidth,P=n.clientHeight;l.clearRect(0,0,I,P),l.fillStyle="#0b0f14",l.fillRect(0,0,I,P);let S=I*.5,q=(I-2*m)/2,A=P-s-r,Mt=6,dt=ot*A/(Mt*j),y,b,R,vt;vt=P-r,dt<=Math.min(q,f)?(y=dt,b=A,R=s):(y=Math.min(q,f),b=y*Mt*j/ot,R=vt-b);let x=y*.28,{killLevel:Ct,rotFloat:D,grid:Ot,gameState:Re}=M,gt=kt?kt():{},se=gt.waterColor||"blue",Ae=gt.waterBubbles||!1,Ee=de[se]||de.blue,jt=J(R,b,Ct),an=.7,Sn=Ct/j,B={...Ee.top},ct={...Ee.bottom};if(Sn>an){let T=(Sn-an)/(1-an);B.r=Math.round(B.r+(255-B.r)*T*.5),B.g=Math.round(B.g+(150-B.g)*T*.5),B.b=Math.round(B.b+(150-B.b)*T*.5),ct.r=Math.round(ct.r+(180-ct.r)*T),ct.g=Math.round(ct.g*(1-T*.6)),ct.b=Math.round(ct.b*(1-T*.6))}let pt=S-y-8,St=S+y+8,ln=R,Qt=vt+5,Ue=l.createLinearGradient(0,jt,0,P);Ue.addColorStop(0,`rgba(${B.r},${B.g},${B.b},0.5)`),Ue.addColorStop(1,`rgba(${ct.r},${ct.g},${ct.b},0.7)`),l.fillStyle=Ue;let un=Math.round((B.r+ct.r)/2),He=Math.round((B.g+ct.g)/2),at=Math.round((B.b+ct.b)/2),Zt=y+8,dn=x+4;l.fillRect(0,jt,pt,P-jt),l.fillRect(St,jt,I-St,P-jt),l.beginPath();let Rn=Math.max(jt,Qt);l.moveTo(pt,Rn),jt<=Qt+dn?l.ellipse(S,Qt,Zt,dn,0,Math.PI,0,!1):l.lineTo(St,Rn),l.lineTo(St,P),l.lineTo(pt,P),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(pt,ln),l.lineTo(pt,Qt),l.stroke(),l.beginPath(),l.moveTo(St,ln),l.lineTo(St,Qt),l.stroke(),l.beginPath(),l.ellipse(S,Qt,y+8,x+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(S,Qt,y+8,x+4,0,0,ke),l.fill(),Ct>.5&&(l.strokeStyle=`rgba(${Math.min(255,un+60)},${Math.min(255,He+40)},${Math.min(255,at+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,jt),l.lineTo(pt,jt),l.moveTo(St,jt),l.lineTo(I,jt),l.stroke()),yt={left:pt,right:St,h:P,w:I},(ne.length>0||Ae)&&(yn(jt,P,$),Ln(jt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Xe=ke*y,Ft=10,En=Xe/Ft*.7,Ye=Xe/Ft*.3;l.setLineDash([En,Ye]);let Nn=Xe/ot;l.lineDashOffset=ie(D)*Nn;for(let T=0;T<=j;T++){let k=J(R,b,T);l.beginPath(),l.ellipse(S,k,y,x,0,0,ke),l.stroke()}l.setLineDash([]);let Mn=[],h=[];for(let T=0;T<j;T++){let k=J(R,b,T+.5);for(let Y=0;Y<ot;Y++){let F=Ot[T][Y];if(!F)continue;let X=$t(S,k,y,x,Y,D),N=Math.sin(X.ang),O={y:T,s:Y,yScr:k,p:X,depth:N,color:F};N<-.1?Mn.push(O):h.push(O)}}let w=Bt.getMagicTargetColor(),{isHighlighting:v,highlightedCells:et,highlightStartTime:xt,isMagicAnimation:Rt}=M,oe=null,Jt=1,Gt=1,$e=!1;if(v&&et.length>0){oe=new Set(et.map(k=>`${k.y},${k.s}`));let T=(performance.now()-xt)/1e3;if(Rt){let k=Math.min(1,T/z);Jt=1-k*.85,Gt=1-k*.9,$e=!0}else{let k=Math.min(1,T/p),Y=1-L;if(k>Y){let F=(k-Y)/L;Jt=1-F*.85,Gt=1-F*.9,$e=!0}}}Mn.sort((T,k)=>T.depth-k.depth);for(let T of Mn){let k=b/j*.9,Y=mt[T.color]||null,F=.35,X=1,N=`${T.y},${T.s}`;oe&&oe.has(N)&&(F*=Gt,X=Jt),Q(S,T.yScr,y,x,T.s,D,k,W,F,Y,.5,null,0,1,X)}let{isRingAnimation:Ie}=M;if(v&&et.length>0&&!Rt){let T=(performance.now()-xt)/1e3,Y=Math.min(1,T/(Ie?U:p)),F=1-L,X=Y>F,N=X?(Y-F)/L:0,O=Ie?Math.floor(Y*F*ot*2)%ot:-1,_=4+Y/F*10,G=Math.sin(T*_*ke),it=X?1:.3+G*.3,nt=X?1-N*.8:1,lt=X?1-N:1;for(let ft of et){let Tt=J(R,b,ft.y+.5),ge=Lt(S,Tt,y,x,ft.s,D);if(Math.sin(ge.ang)>=-.1)continue;let mn=b/j*.9,Et,Ce,fe;if(Ie){let V=(ft.s-O+ot)%ot,Te=V<3?1-V/3:0;Et=(X?lt:.2+Te*.5)*.5,Ce=`rgba(255, 159, 67, ${Et})`,fe=X?nt:1+Te*.15}else Et=it*lt,Ce=ft.isLine?`rgba(255, 255, 255, ${Et*.5})`:`rgba(255, 220, 100, ${Et*.4})`,fe=X?nt:1.1;Q(S,Tt,y,x,ft.s,D,mn,Ce,1,null,1,null,0,1,fe)}}h.sort((T,k)=>T.depth-k.depth);for(let T of h){let k=b/j*.9,Y=mt[T.color]||null,F=1,X=1,N=1,O=1,_=`${T.y},${T.s}`,G=oe&&oe.has(_);G&&(F=Gt,X=Jt),w!==null&&!G&&(T.color!==w?(N=Vt,O=Wt):O=Kt),Q(S,T.yScr,y,x,T.s,D,k,Z,F,Y,N,null,0,O,X)}if(v&&et.length>0&&!Rt){let T=(performance.now()-xt)/1e3,Y=Math.min(1,T/(Ie?U:p)),F=1-L,X=Y>F,N=X?(Y-F)/L:0,O=Ie?Math.floor(Y*F*ot*2)%ot:-1,_=4+Y/F*10,G=Math.sin(T*_*ke),it=X?1:.5+G*.5,nt=X?1-N*.8:1,lt=X?1-N:1;for(let ft of et){let Tt=J(R,b,ft.y+.5),ge=Lt(S,Tt,y,x,ft.s,D);if(Math.sin(ge.ang)<-.1)continue;let mn=b/j*.9,Et,Ce,fe;if(Ie){let V=(ft.s-O+ot)%ot,Te=V<4?1-V/4:0;Et=X?lt:.3+Te*.7,Ce=`rgba(255, 159, 67, ${Et})`,fe=X?nt:1+Te*.2}else Et=it*lt,Ce=ft.isLine?`rgba(255, 255, 255, ${Et*.7})`:`rgba(255, 220, 100, ${Et*.6})`,fe=X?nt:1.15;Q(S,Tt,y,x,ft.s,D,mn,Ce,1,null,1,null,0,1,fe)}}let Ve=M.spellState||M,{transmuteState:re,transmuteSourceBlock:Nt,transmuteTargetColor:Me,transmuteAreaCells:Fe,transmuteBlocksToChange:we}=Ve;if(re==="selecting_source"){let T=b/j*.9,k=.35+Math.sin(C/150)*.15;for(let Y of h){let F=J(R,b,Y.y+.5);Q(S,F,y,x,Y.s,D,T,`rgba(0, 40, 20, ${k})`,1,null,1,null,0,1,1)}}if(re==="selecting_target"&&we&&we.length>0){let T=b/j*.9,k=.4+Math.sin(C/120)*.25,Y=.6+Math.sin(C/120)*.4;for(let F of we){if(F.y<0||F.y>=j)continue;let X=J(R,b,F.y+.5),N=Lt(S,X,y,x,F.s,D);Math.sin(N.ang)<-.1||(Q(S,X,y,x,F.s,D,T,`rgba(0, 50, 30, ${k})`,1,null,1,null,0,1,1),Q(S,X,y,x,F.s,D,T,"transparent",1,null,1,`rgba(100, 255, 150, ${Y})`,3,1,1.02))}}if(re==="animating"&&Bt.getTransmuteAnimState){let T=Bt.getTransmuteAnimState(C);if(T){let k=b/j*.9,{phase:Y,progress:F,areaFlash:X}=T;if(X>0&&Fe)for(let N of Fe){if(N.y<0||N.y>=j)continue;let O=J(R,b,N.y+.5),_=Lt(S,O,y,x,N.s,D);Math.sin(_.ang)<-.1||Q(S,O,y,x,N.s,D,k,`rgba(150, 255, 200, ${X*.4})`,1,null,1,null,0,1,1)}if(we&&we.length>0){let N=Nt?Nt.color:1,O=Me||1;for(let _ of we){if(_.y<0||_.y>=j)continue;let G=J(R,b,_.y+.5),it=Lt(S,G,y,x,_.s,D);if(Math.sin(it.ang)<-.1)continue;let lt=1,ft=mt[N],Tt=0;if(Y==="shrink"?(lt=1-F*.95,ft=mt[N],Tt=.5+F*.3):Y==="grow"&&(lt=F,ft=mt[O],Tt=.8-F*.5),Tt>0&&Q(S,G,y,x,_.s,D,k,`rgba(200, 255, 220, ${Tt})`,1,null,1,null,0,1,1),lt>.05){let ge=Ne(S,G,y,x,_.s,D,k,1),Je=Math.min(ge.wApprox,ge.hApprox)*.28*lt;l.save(),l.globalAlpha=1,l.fillStyle=ft,l.beginPath(),l.arc(ge.cx,ge.cy,Je,0,ke),l.fill(),l.restore()}}}}}let{lightningState:je,lightningSourceBlock:gn,lightningAreaCells:Qe,lightningBlocksToHit:Dt}=Ve;if(je==="selecting_source"){let T=b/j*.9,k=.35+Math.sin(C/150)*.15;for(let Y of h){let F=J(R,b,Y.y+.5);Q(S,F,y,x,Y.s,D,T,`rgba(20, 20, 60, ${k})`,1,null,1,null,0,1,1)}}if(je==="animating"&&Bt.getLightningAnimState){let T=Bt.getLightningAnimState(C);if(T&&Dt&&Dt.length>0){let k=b/j*.9,{phase:Y,flashProgress:F,currentTarget:X,jumpProgress:N,struckTargets:O}=T;if(Y==="flash"&&F>0&&Qe)for(let _ of Qe){if(_.y<0||_.y>=j)continue;let G=J(R,b,_.y+.5),it=Lt(S,G,y,x,_.s,D);Math.sin(it.ang)<-.1||Q(S,G,y,x,_.s,D,k,`rgba(100, 150, 255, ${F*.5})`,1,null,1,null,0,1,1)}if(O&&O.length>0)for(let _ of O){let G=Dt[_];if(!G||G.y<0||G.y>=j)continue;let it=J(R,b,G.y+.5),nt=Lt(S,it,y,x,G.s,D);if(Math.sin(nt.ang)<-.1)continue;let ft=(O.length-1-O.indexOf(_))*.1,Tt=Math.max(0,.8-ft);Q(S,it,y,x,G.s,D,k,`rgba(255, 255, 255, ${Tt})`,1,null,1,`rgba(150, 200, 255, ${Tt})`,2,1,1.05)}if(Y==="chain"&&X>=0&&X<Dt.length){let _=Dt[X];if(_&&_.y>=0&&_.y<j){let G=J(R,b,_.y+.5),it=Lt(S,G,y,x,_.s,D);if(Math.sin(it.ang)>=-.1){let lt=1-N;Q(S,G,y,x,_.s,D,k,`rgba(200, 220, 255, ${lt*.9})`,1,null,1,`rgba(100, 180, 255, ${lt})`,3,1,1.1-N*.05)}}if(X>0){let G=Dt[X-1],it=Dt[X];if(G&&it){let nt=J(R,b,G.y+.5),lt=J(R,b,it.y+.5),ft=Ne(S,nt,y,x,G.s,D,k,1),Tt=Ne(S,lt,y,x,it.s,D,k,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-N*.5})`,l.lineWidth=2+(1-N)*2,l.lineCap="round",l.beginPath();let ge=ft.cx,Je=ft.cy,mn=Tt.cx,Et=Tt.cy;l.moveTo(ge,Je);let Ce=4;for(let fe=1;fe<=Ce;fe++){let V=fe/Ce,Te=ge+(mn-ge)*V,Os=Je+(Et-Je)*V,Un=fe<Ce?(Math.random()-.5)*8:0;l.lineTo(Te+Un,Os+Un)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-N)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:Ze,fireSourceBlock:be,fireLineCells:xe,fireTargets:on}=Ve;if(Ze==="selecting_source"){let T=b/j*.9,k=.3+Math.sin(C/140)*.2;for(let Y of h){let F=J(R,b,Y.y+.5);Q(S,F,y,x,Y.s,D,T,`rgba(70, 25, 10, ${k})`,1,null,1,null,0,1,1)}}if(Ze==="animating"&&Bt.getFireAnimState){let T=Bt.getFireAnimState(C);if(T&&xe&&xe.length>0){let k=b/j*.9,{progress:Y,flashProgress:F}=T,X=Math.sin(Y*Math.PI);if(F>0)for(let N of xe){if(N.y<0||N.y>=j)continue;let O=J(R,b,N.y+.5),_=Lt(S,O,y,x,N.s,D);Math.sin(_.ang)<-.1||Q(S,O,y,x,N.s,D,k,`rgba(255, 120, 50, ${F*.45})`,1,null,1,`rgba(255, 200, 140, ${F*.5})`,2,1,1.03)}if(be){let N=new Map;for(let _ of xe){if(_.y<0||_.y>=j)continue;let G=J(R,b,_.y+.5),it=Lt(S,G,y,x,_.s,D);if(Math.sin(it.ang)<-.1)continue;let lt=Ne(S,G,y,x,_.s,D,k,1),ft=_.s-be.s;ft>ot/2&&(ft-=ot),ft<-ot/2&&(ft+=ot);let Tt=_.y;N.has(Tt)||N.set(Tt,[]),N.get(Tt).push({x:lt.cx,y:lt.cy,offset:ft})}let O=Array.from(N.keys()).sort((_,G)=>G-_);if(O.length>0){let _=.35+.3*Math.sin(C/60)+X*.2;l.save(),l.lineCap="round";for(let G of O){let it=N.get(G)||[];if(it.sort((nt,lt)=>nt.offset-lt.offset),it.length!==0){l.beginPath(),l.moveTo(it[0].x,it[0].y);for(let nt=1;nt<it.length;nt++)l.lineTo(it[nt].x,it[nt].y);l.strokeStyle=`rgba(255, 140, 60, ${_})`,l.lineWidth=Math.max(2,k*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,l.lineWidth=Math.max(6,k*.35),l.stroke()}}l.restore()}}if(on&&on.length>0){let N=.2+X*.6;for(let O of on){if(O.y<0||O.y>=j)continue;let _=J(R,b,O.y+.5),G=Lt(S,_,y,x,O.s,D);Math.sin(G.ang)<-.1||Q(S,_,y,x,O.s,D,k,`rgba(255, 160, 70, ${N})`,1,null,1,`rgba(255, 230, 180, ${X*.6})`,2,1,1.05)}}}}let{activePiece:It,pieceY:fn,isGrounded:Ut,lockTimer:ve}=M;if(It){let T=Bt.snappedRot(),k=T,Y=Bt.computeGhostY(),F=b/j*.9;if(Y!==null){let O=[];for(let _=0;_<It.cells.length;_++){let G=It.cells[_],it=It.colors[_],nt=Y+G.y,lt=Bt.normSector(T+G.x);if(nt<0||nt>=j)continue;let ft=J(R,b,nt+.5),Tt=Lt(S,ft,y,x,lt,k);O.push({cy:nt,cs:lt,yScr:ft,depth:Math.sin(Tt.ang),color:it})}O.sort((_,G)=>_.depth-G.depth);for(let _ of O){let G=mt[_.color]||null;Q(S,_.yScr,y,x,_.cs,k,F,Le,1,G,.5,he,ee,1,1)}}let X=bt;if(Ut&&ve>0){let O=Math.min(1,ve/K),_=255,G=Math.round(170+85*O),it=Math.round(180+75*O),nt=.75+(1-.75)*O;X=`rgba(${_},${G},${it},${nt})`}let N=[];for(let O=0;O<It.cells.length;O++){let _=It.cells[O],G=It.colors[O],it=Bt.normSector(T+_.x),nt=fn+_.y;if(nt<0||nt>=j)continue;let lt=J(R,b,nt+.5),ft=Lt(S,lt,y,x,it,k);N.push({cs:it,yScr:lt,depth:Math.sin(ft.ang),color:G})}N.sort((O,_)=>O.depth-_.depth);for(let O of N){let _=mt[O.color]||null;Q(S,O.yScr,y,x,O.cs,k,F,X,1,_,1,null,0,1,1)}}},drawNextPreview($,C){if(!$)return;let M=$.getContext("2d"),I=$.width,P=$.height;if(M.clearRect(0,0,I,P),!C)return;let S=1/0,q=-1/0,A=1/0,Mt=-1/0;for(let x of C.cells)S=Math.min(S,x.x),q=Math.max(q,x.x),A=Math.min(A,x.y),Mt=Math.max(Mt,x.y);let dt=q-S+1,y=Mt-A+1,b=Math.min(I/(dt+.5),P/(y+.5)),R=(I-dt*b)/2,vt=(P-y*b)/2;M.fillStyle=Z;for(let x=0;x<C.cells.length;x++){let Ct=C.cells[x],D=R+(Ct.x-S)*b,Ot=vt+(y-1-(Ct.y-A))*b;M.fillRect(D+1,Ot+1,b-2,b-2);let Re=C.colors[x],gt=mt[Re];if(gt){let se=(b-2)*.32;M.fillStyle=gt,M.beginPath(),M.arc(D+b/2,Ot+b/2,se,0,ke),M.fill(),M.fillStyle=Z}}},spawnBonusBubbles($){let{left:C,right:M,h:I,w:P}=yt;P>0&&De($,C,M,I,P)}}}(()=>{let e=Bo(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,s=24,r=120,m={"30_24":{N:30,H:24,survivalTime:90,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function f(t){let o=m[t]||m["30_24"];i=o.N,s=o.H,r=o.survivalTime}function g(){return s/r}let d=Math.PI/2,p=70,L=120,z=30,U=320,K=.42,st="rgb(235,240,250)",mt="rgb(55,62,75)",ue="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",W="rgba(110,255,150,0.85)",bt=2,Le={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},he={1:"fire",2:"water",3:"lightning",4:"earth"},ee={fire:1,water:2,lightning:3,earth:4},Vt=1,Wt=.58,Kt=!0,qt=12,kt=25,Bt=1,l=2,ot=3,j=5,de=8,ne=10,Oe=15,De=30,yn=2,Ln=.3,yt=.5,J=1,ie=.3,$t=.5,Yt=1.3,ze=10,Lt=500,Ne=[1,1.25,1.5,1.75,2],Q=10,ye=100,Se=25,zt=[1,1.3,1.6,2],$=[1,1.5,2,2.5],C=_o(),M=C.loadGameSettings();M.hapticsEnabled===void 0&&(M.hapticsEnabled=!0);let I=M.invertSwipe?-1:1,P=M.magicEnabled??!1,S=-1,q=Io({enabled:M.hapticsEnabled}),A=Array.from({length:s},()=>new Uint8Array(i));function Mt(){A=Array.from({length:s},()=>new Uint8Array(i))}let dt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,b=s+3,R=0,vt=0,x=!1,Ct=0,D=0,Ot=0,Re=3,gt=0,se=0,Ae=0,Ee=Do({canvas:n,rotDir:I}),jt="0.16.1",an=!0,Sn="blue",B=bo();B.preload();let ct=Ho(),pt="intro",St=0,ln=0,Qt=0,Ue=0,un=0,He=null,at=ct.stats,Zt=0,dn=e.overlay,Rn=e.gameContainer,Xe=Ro({elementColors:Le}),Ft=Xe.showBonus.bind(Xe),En=Xe.getElementIcon.bind(Xe),Ye=Ao(),Nn=e.overlayTitle,Mn=e.overlayStats,h=e.startBtn,w=e.hud,v=e.scoreHud,et=e.timeHud,xt=e.remainingHud,Rt=e.nextCanvas,oe=Rt.getContext("2d"),Jt=e.pauseBtn,Gt=e.pauseOverlay,$e=e.resumeBtn,Ie=e.restartBtn,Ve=e.exitToMenuBtn,re=e.pauseSettingsBtn,Nt=e.pauseSoundBtn,Me=e.pauseMusicBtn,Fe=e.pauseBestScore,we=e.pauseBestTime,je=e.pauseBestMode,gn=e.pauseCurrentScore,Qe=e.pauseCurrentTime,Dt=e.pauseCurrentMode,Ze=e.confirmDialog,be=e.confirmText,xe=e.confirmCancel,on=e.confirmOk,It=e.settingsOverlay,fn=e.settingsClose,Ut=e.fullscreenBtn,ve=e.rotateBtn,T=e.startPanel,k=e.gameoverPanel,Y=e.goScore,F=e.goTime,X=e.goRing,N=e.goMatches,O=e.goBonuses,_=e.goNewRecord,G=e.goRestartBtn,it=e.goExitBtn,nt=e.bestScore,lt=e.bestTimeVal,ft=e.startVersion,Tt=e.modeBtns,ge=e.recordsBtn,Je=e.startSettingsBtn,mn=e.helpBtn,Et="25_20";function Ce(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function fe(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let a=o.dataset.mode,E=m[a];if(!E)return;let H=o.querySelector(".mode-tag.time-tag");if(!H)return;let tt=Ce(E.survivalTime);tt&&(H.textContent=tt)})}fe();let V=wo({buttons:e.magicBtns,onActivate:()=>B.play("spells"),onChange:(t,o)=>{ms()}}),Te=e.magicBtns,Os=V.charges,Un=t=>me()?V.select(t):!1,An=()=>V.updateButtons(),Ds=e.magicRow,pn=e.magicToggle,wt=e.magicActiveIndicator,Hs=e.magicActiveIcon,$s=e.magicActiveCost,qo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},gs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},zo=["ice","earth","air","fire"];Zt=C.loadHighTowerRings();function In(t){return typeof te?.getUnlockRings=="function"?te.getUnlockRings(t):0}function Xn(t){let o=In(t);return o===0||Zt>=o}let Fs=["fire","water","lightning","earth"],bn=null,Yn=!1,jo=500,Qo=30,Zo=220,xn=null,fs=null,Gs={fire:!1,water:!1,lightning:!1,earth:!1};function Ns(){if(!wt)return;let t=wt.getBoundingClientRect();t.width>0&&t.height>0&&(fs=t)}function Jo(){if(!wt)return null;let t=wt.getBoundingClientRect();return t.width>0&&t.height>0?wt:fs?{getBoundingClientRect:()=>fs}:null}function wn(t=V.active){if(!wt||!Hs)return;t?(bn=t,Yn=!1):Yn||(bn=null);let o=bn;if(!o||!me()||(V.charges[o]??0)<=0){Ns(),wt.classList.add("hidden"),wt.classList.remove("active","ult-ready",...Fs),wt.style.setProperty("--progress","0%"),xn&&clearTimeout(xn),xn=setTimeout(()=>{wt.classList.add("gone")},Zo);return}xn&&(clearTimeout(xn),xn=null),wt.classList.remove("gone"),wt.classList.contains("hidden")?requestAnimationFrame(()=>wt.classList.remove("hidden")):wt.classList.remove("hidden"),Hs.textContent=En(o);let E=gs[o];E&&te.selectSpell(E);let H=E?kn(E):0,tt=V.charges[o]??0,rt=!!E&&Kn()&&Xn(E),Xt=!!E&&Kn()&&!rt,pe=rt&&H>0?Math.min(tt/H,1):0,qe=rt&&H>0,_e=qe&&tt>=H;$s&&($s.textContent=qe?`-${H}`:Xt?"\u{1F512}":""),wt.classList.toggle("no-cost",!qe&&!Xt),wt.classList.toggle("locked",Xt),wt.classList.toggle("ult-ready",_e),wt.style.setProperty("--progress",`${Math.round(pe*100)}%`),wt.classList.remove("hidden",...Fs),wt.classList.add("active",o),Ns()}function ti(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),jo))}function Vn(){for(let[t,o]of Object.entries(Te)){if(!o)continue;let a=gs[t],E=kn(a),H=Kn()&&me()&&a,tt=typeof Xn=="function"?Xn(a):!0,rt=H&&tt&&E>0&&(V.charges[t]??0)>=E;o.classList.toggle("ult-ready",rt),rt&&!Gs[t]&&(ti(o),pt==="playing"&&B.play("readysuper")),Gs[t]=rt}}function me(t=Et){return t==="30_24"?!0:P}function Us(){pn&&pn.classList.toggle("active",P)}function ms(){wn(V.active),Vn()}function ei(t){P=t,M.magicEnabled=t,C.saveGameSettings(M),Et==="25_20"&&(P?V.reset():(V.deactivate(),Object.keys(V.charges).forEach(o=>{V.charges[o]=0})),An()),Wn(),Us(),ms()}function Wn(){Ds&&(Ds.style.display=me()?"":"none",wn(V.active),Vn())}function zi(t){let o=vn(t),a=kn(t);return!o||a<=0?!1:V.charges[o]>=a}function ji(t){let o=vn(t),a=kn(t);return!o||a<=0||V.charges[o]<a?!1:(V.charges[o]-=a,V.updateButtons(),te.pulse(),!0)}let Pn=e.spellWave;function ni(){Pn&&(Pn.classList.remove("active"),Pn.offsetWidth,Pn.classList.add("active"),setTimeout(()=>Pn.classList.remove("active"),1200))}let tn=null,te=Po({button:wt,onReady:()=>{B.play("readysuper")}}),si=()=>te.getEffect("earth"),oi=()=>te.getEffect("air"),ii=()=>te.getEffect("fire"),kn=t=>typeof te?.getCost=="function"?te.getCost(t):0,vn=t=>qo[t]??null;tn=Oo({canvas:n,dom:e,getGrid:()=>A,getN:()=>i,getH:()=>s,getRotFloat:()=>gt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:z,MAX_RADIUS_X:U,SCORE_MAGIC_DESTROY:Se},helpers:{normSector:Zn,levelYToScreenY:zn,sectorCenterXY:jn},Spell:te,Magic:V,SoundModule:B,State:ct,isGamePlaying:()=>pt==="playing",addPendingKzDrop:t=>{Ot+=t},getKillRate:g,triggerSpellWave:ni,spawnSpellBubbles:t=>{let o=vn(te.currentSpell)??"water";Ye.spawnSpellBubbles(te.button,o,t)},spawnBonusBubbles:t=>{_n.spawnBonusBubbles(t)},getTransmuteEffect:si,getLightningEffect:oi,getFireEffect:ii,continueMatchProcessing:Qn,updateScoreHud:Hn,showBonus:Ft,getSpellCost:kn,getSpellElement:vn,onUltimateApplied:t=>{let o=vn(t)??vn(te.currentSpell)??"water";if(typeof Ye?.spawnSpellBubbles=="function"){let a=Jo();a&&Ye.spawnSpellBubbles(a,o,Qo)}Yn=!1,bn=null,wn(null),Vn()},isSpellBlocked:ri,setScore:t=>{St=t},setCascadeLevel:t=>{nn=t}});function Kn(){return Et==="30_24"}function qn(){wn(V.active),Vn()}let en=[],On=0,We=!1,rn=!1,Cn=!1,Pe=0,Ke=0,nn=0,Tn=[];function ri(){return We||rn||Cn}function zn(t,o,a){let E=1-a/s;return t+E*o}function jn(t,o,a,E,H,tt){let rt=(H-tt)/i*u+d;return{x:t+Math.cos(rt)*a,y:o+Math.sin(rt)*E,ang:rt}}function Xs(t,o){let a=n.clientWidth,E=n.clientHeight,H=a*.5,tt=(a-2*z)/2,rt=E-p-L,Xt=6,pe=i*rt/(Xt*s),qe=E-L,_e,_t,ut;pe<=Math.min(tt,U)?(_e=pe,_t=rt,ut=p):(_e=Math.min(tt,U),_t=_e*Xt*s/i,ut=qe-_t);let ht=_e*.28,Pt=zn(ut,_t,t+.5),Ht=jn(H,Pt,_e,ht,o,gt),ce=n.getBoundingClientRect();return{x:ce.left+Ht.x,y:ce.top+Ht.y}}function ci(t,o){if(!me()||!V.canUse()||We)return!1;let a=ee[V.active],E=n.clientWidth,H=n.clientHeight,tt=E*.5,rt=(E-2*z)/2,Xt=H-p-L,pe=6,qe=i*Xt/(pe*s),_e=H-L,_t,ut,ht;qe<=Math.min(rt,U)?(_t=qe,ut=Xt,ht=p):(_t=Math.min(rt,U),ut=_t*pe*s/i,ht=_e-ut);let Pt=_t*.28,Ht=null,ce=1/0;for(let ae=0;ae<s;ae++){let Be=zn(ht,ut,ae+.5);for(let le=0;le<i;le++){let cs=A[ae][le];if(!cs||cs!==a)continue;let Gn=jn(tt,Be,_t,Pt,le,gt);if(Math.sin(Gn.ang)<-.1)continue;let as=t-Gn.x,ho=o-Gn.y,yo=Math.hypot(as,ho),So=ut/s*.9,Hi=So*1.2;Math.abs(as)<Hi/2&&Math.abs(ho)<So/2&&yo<ce&&(ce=yo,Ht={y:ae,s:le})}}if(Ht){let ae=zn(ht,ut,Ht.y+.5),Be=jn(tt,ae,_t,Pt,Ht.s,gt),le=n.getBoundingClientRect(),cs=le.left+Be.x,Gn=le.top+Be.y,po=Te[V.active];return Ye.spawnMagicShot(V.active,po,cs,Gn,()=>{let as=A[Ht.y][Ht.s];en=[{y:Ht.y,s:Ht.s,color:as,isLine:!1,isMagic:!0}],On=performance.now(),We=!0,rn=!0,Pe=0,Ke=Se,Ft(`+${Se}`,"score")}),nn=0,V.useCharge(),at.magicUsed++,!0}return!1}let Qi=100;function Zi(t,o){return Ps(t,o,s,i)}function ai(){return Go(A,s,i)}let li=No;function ui(t){let o=t.map(E=>({...E,color:A[E.y][E.s]}));for(let E of t)A[E.y][E.s]=0;let a=s;for(let E of t){let H=E.y;for(let tt=1;tt<=E.y;tt++){let rt=E.y-tt;if(A[rt][E.s]){H=tt-1;break}}a=Math.min(a,H)}for(let E of o)A[E.y-a][E.s]=E.color;return a>0}function di(){let t=!0;for(;t;){t=!1;let o=ai();for(let a of o)li(a)||ui(a)&&(t=!0)}}function gi(){Qn()}let ps=$o;function Ys(t,o){let a=new Map,E=0,H=0,tt=0,rt={},Xt=t.length+o.length;for(let ut of t){let ht=he[ut.color],Pt=0,Ht=0;if(ut.length>=5?(Pt=ot,Ht=ne,at.lines5++):ut.length===4?(Pt=l,Ht=de,at.lines4++):ut.length===3&&(Pt=Bt,Ht=j,at.lines3++),me()&&ht&&Pt>0){V.addCharges(ht,Pt),rt[ht]=(rt[ht]||0)+Pt;let ce=ut.cells[Math.floor(ut.cells.length/2)],ae=Xs(ce.y,ce.s),Be=Te[ht];for(let le=0;le<Pt;le++)setTimeout(()=>{Ye.spawnMagicOrb(ht,ae.x,ae.y,Be)},le*100)}E+=Ht*g(),tt+=Ht,H+=ut.length*Q;for(let ce of ut.cells){let ae=`${ce.y},${ce.s}`;a.has(ae)||a.set(ae,{y:ce.y,s:ce.s,color:ut.color,isLine:!0})}}for(let ut of o){if(at.pairs++,E+=Oe*g(),tt+=Oe,H+=ye,me()){let ht=[...new Set(ut.cells.map(Pt=>A[Pt.y][Pt.s]).filter(Boolean))];if(ht.length>0){let Pt=ut.cells[Math.floor(ut.cells.length/2)],Ht=Xs(Pt.y,Pt.s);ht.forEach((ce,ae)=>{let Be=he[ce];if(!Be)return;V.addCharges(Be,1),rt[Be]=(rt[Be]||0)+1;let le=Te[Be];le&&setTimeout(()=>{Ye.spawnMagicOrb(Be,Ht.x,Ht.y,le)},ae*100)})}}for(let ht of ut.cells){let Pt=`${ht.y},${ht.s}`;a.has(Pt)||a.set(Pt,{y:ht.y,s:ht.s,color:A[ht.y][ht.s],isLine:!1})}}let pe=ps(zt,Xt-1),qe=ps($,nn),_e=Math.round(H*pe*qe),_t=0;Xt>1&&(at.combos++,at.maxCombo=Math.max(at.maxCombo,Xt),setTimeout(()=>Ft(`COMBO \xD7${Xt}`,"combo"),_t),_t+=180,B.play("combo2")),nn>0&&(at.cascades++,at.maxCascade=Math.max(at.maxCascade,nn),setTimeout(()=>Ft(`CASCADE \xD7${nn}`,"cascade"),_t),_t+=180,B.play("cascade")),(t.length>0||o.length>0)&&B.play("combo");for(let ut of t){let ht=ut.length,Pt=ht*Q;setTimeout(()=>Ft(`Line-${ht} +${Pt}`,"line",ut.color),_t),_t+=100}for(let ut of o){let ht=ut.cells.length>0?A[ut.cells[0].y][ut.cells[0].s]:null;setTimeout(()=>Ft(`Pair +${ye}`,"pair",ht),_t),_t+=100}_e>0&&(setTimeout(()=>Ft(`+${_e}`,"score"),_t),_t+=120),tt>0&&(setTimeout(()=>Ft(`+${tt}s`,"time"),_t),_t+=120);for(let[ut,ht]of Object.entries(rt))ht>0&&(setTimeout(()=>Ft(`+${ht}${En(ut)}`,"charge"),_t),_t+=120);en=Array.from(a.values()),On=performance.now(),We=!0,rn=!1,Pe=E,Ke=_e,An()}function fi(){for(let t of en)A[t.y][t.s]=0;if(en.length>0&&B.playRandom("disappear"),Pe>0){Ot+=Pe;let t=Pe/g();_n.spawnBonusBubbles(t)}ct.addScore(Ke),St+=Ke,Hn(),en=[],We=!1,rn=!1,Pe=0,Ke=0,nn++,Qn()}function Qn(){di();let{lineMatches:t,pairMatches:o}=vi();if(t.length>0||o.length>0)Ys(t,o);else{let a=js();a.length>0?Mi(a):!y&&pt==="playing"&&zs()}}function Ji(t,o){Ys(t,o)}function Zn(t){return Bn(t,i)}function Jn(){return Zn(Math.round(gt))}function Vs(t,o){return ks(y,t,o,A,s,i)}function ts(t){return Vs(t,Jn())}let es=Fo;function Ws(){Kt&&(qt!==0&&Ct>=qt||(vt=0,Ct+=1))}function mi(){if(!y)return;let t=y.cells,o=y.colors,a={cells:t,colors:o};if(S>=0||(a=es(a.cells,a.colors),a=es(a.cells,a.colors)),a=es(a.cells,a.colors),y.cells=a.cells,y.colors=a.colors,!ts(Math.floor(b))){y.cells=t,y.colors=o;return}B.play("turn"),x&&Ws()}function pi(){return Uo(y,b,Jn(),A,s,i)}function hi(){if(!y)return!1;let t=Math.floor(b)-1,o=!ts(t);return o&&!x?(x=!0,vt=0,Ct=0):!o&&x&&(x=!1,vt=0,Ct=0),o}let hn=ds;function Dn(){if(pt==="playing"){dn.classList.add("hidden"),Jt.classList.remove("hidden");return}if(dn.classList.remove("hidden"),Jt.classList.add("hidden"),pt==="intro"){T.classList.remove("hidden"),k.classList.add("hidden");let t=C.loadHighscore(Et);t.score>0?(nt.textContent=t.score.toLocaleString(),lt.textContent=hn(t.time)):(nt.textContent="0",lt.textContent="0:00"),Bs(),ft.textContent=`v${jt}`,h.classList.remove("idlePulse"),h.offsetWidth,h.classList.add("idlePulse")}else{T.classList.add("hidden"),k.classList.remove("hidden"),Y.textContent=St.toLocaleString(),F.textContent=hn(Qt);let t=C.loadHighscore(Et);St>0&&St>=t.score?_.classList.remove("hidden"):_.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${at.rings}</span>
          <span class="count ring-max">${at.maxRing>0?"max \xD7"+at.maxRing:""}</span>
        </div>
      `;X.innerHTML=o;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${at.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${at.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${at.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${at.pairs}</span>
        </div>
      `;N.innerHTML=a;let E=me()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${at.magicUsed}</span>
        </div>
      `:"",H=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${at.combos}</span>
          <span class="count max-combo">${at.maxCombo>0?"max \xD7"+at.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${at.cascades}</span>
          <span class="count max-cascade">${at.maxCascade>0?"max \xD7"+at.maxCascade:""}</span>
        </div>
        ${E}
      `;O.innerHTML=H}}function Hn(){v.textContent=`Score: ${St}`}function hs(){et.textContent=`Time: ${hn(Qt)}`}function Ks(){let t=Math.max(0,(s-D)/g()),o=Math.floor(t/60),a=Math.floor(t%60);xt.textContent=`Left: ${o}:${a.toString().padStart(2,"0")}`,t<30?xt.classList.add("warning"):xt.classList.remove("warning")}function yi(){f(Et),Mt(),D=0,Ot=0,gt=se=0,Ae=0,ct.start(),at=ct.stats,St=0,ln=performance.now(),Qt=0,un=0,Ue=0,pt="playing",He=null,me()?V.reset():(V.deactivate(),Object.keys(V.charges).forEach(t=>{V.charges[t]=0}),An()),te.reset(),qn(),en=[],Tn=[],We=!1,rn=!1,Cn=!1,Pe=0,Ke=0,nn=0,tn.reset(),An(),Hn(),hs(),Ks(),ms(),zs(),_n.drawNextPreview(Rt,He),Dn(),B.getSettings().musicEnabled&&B.startGameMusic()}function ys(){ct.gameOver(),pt="gameover",y=null,x=!1,vt=0,Ct=0;let t=C.saveHighscore(St,Qt,Et);B.stopMusic(),B.play("gameover"),hs(),Dn(),t&&St>0&&setTimeout(()=>{Ft("\u{1F3C6} NEW RECORD!","score")},500)}function Si(t){for(let a=0;a<50;a++){let E=t.map(()=>1+(Math.random()*4|0));if(!Ei(t,E))return E}return t.map((a,E)=>1+E%4)}let Ei=Vo;function qs(t){let o=t.cells.map(E=>({x:E.x,y:E.y})),a=Si(o);return{name:t.name,cells:o,colors:a}}function zs(){if(!He){let H=dt[Math.random()*dt.length|0];He=qs(H)}y=He;let t=dt[Math.random()*dt.length|0];He=qs(t),_n.drawNextPreview(Rt,He);let o=1/0,a=-1/0;for(let H of y.cells)H.x<o&&(o=H.x),H.x>a&&(a=H.x);let E=(o+a)/2;for(let H of y.cells)H.x=H.x-Math.round(E);b=s+3,R=0,x=!1,vt=0,Ct=0,ts(Math.floor(b))?B.playRandom("appear"):ys()}function js(){return Yo(A,s,i)}function Mi(t){if(t.length===0)return;let o=[];for(let Xt of t)for(let pe=0;pe<i;pe++)o.push({y:Xt,s:pe,color:A[Xt][pe],isLine:!1});Tn=t,en=o,On=performance.now(),We=!0,Cn=!0,rn=!1;let a=t.length;at.rings+=a,at.maxRing=Math.max(at.maxRing,a);let E=ps(Ne,a-1),H=Math.round(Lt*a*E),tt=De*a;Ke=H,Pe=tt*g(),B.play("ring");let rt=`RING \xD7${a}`;Ft(rt,"ring"),setTimeout(()=>Ft(`+${H}`,"score"),150),setTimeout(()=>Ft(`+${tt}s`,"time"),300)}function bi(){let t=[...Tn].sort((o,a)=>a-o);for(let o of t){for(let a=o;a<s-1;a++)A[a].set(A[a+1]);A[s-1].fill(0)}if(Pe>0){Ot+=Pe;let o=Pe/g();_n.spawnBonusBubbles(o)}ct.addScore(Ke),St+=Ke,Hn(),Et==="30_24"&&Tn.length>0&&(Zt=C.addHighTowerRings(Tn.length)),en=[],Tn=[],We=!1,Cn=!1,Pe=0,Ke=0,Qn()}function tr(){return js().length}function xi(){if(!y)return;let t=Jn();gt=t,se=t,Ae=0;let o=!1;for(let a=0;a<y.cells.length;a++){let E=y.cells[a],H=y.colors[a],tt=Math.floor(b)+E.y,rt=Zn(t+E.x);tt>=s&&(o=!0),tt>=0&&tt<s&&(A[tt][rt]=H)}if(o){ys();return}ct.addScore(ze),St+=ze,Hn(),Ft(`+${ze}`,"score"),B.playRandom("drop"),y=null,nn=0,gi()}function vi(){return Xo(A,s,i)}function Ci(){if(!y)return!1;let t=Math.floor(b)-1;return ts(t)?(b=t,x=!1,vt=0,Ct=0,!0):(x=!0,!1)}n.addEventListener("pointerdown",t=>{if(At.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),a=t.clientX-o.left,E=t.clientY-o.top;Ee.handlePointerDown(t,{onMagicTap:me()?()=>tn.handleTap(a,E)?!0:At.applyCommand("magic_shoot",{x:a,y:E}):null,onDoubleTap:()=>At.applyCommand("rotate_piece")},se)||(Ae=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(At.state!=="playing"||!Ee.dragging)return;t.preventDefault?.();let o=Ee.handlePointerMove(t,{canRotateTo:(a,E)=>At.canRotateTo(a,E),onDrop:()=>At.applyCommand("move_down"),onGroundedMove:()=>At.onGroundedMove(),onRotateStep:()=>q.trigger("tower_rotate")},At.pieceY,At.isGrounded);o&&At.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{At.state==="playing"&&Ee.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Ee.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Ee.dragging&&Ee.handlePointerUp(t)},{passive:!1}),ve.addEventListener("click",()=>{At.state==="playing"&&At.applyCommand("rotate_piece")});let ns=e.dropBtn,ss=null;function Ti(){At.state==="playing"&&(At.applyCommand("move_down"),ss=setInterval(()=>{if(At.state!=="playing"){os();return}At.applyCommand("move_down")},kt))}function os(){ss&&(clearInterval(ss),ss=null)}ns.addEventListener("pointerdown",t=>{t.preventDefault(),Ti()}),ns.addEventListener("pointerup",os),ns.addEventListener("pointerleave",os),ns.addEventListener("pointercancel",os);for(let[t,o]of Object.entries(Te))o.addEventListener("click",()=>{At.state==="playing"&&me()&&At.applyCommand("select_magic",{element:t})});wt&&wt.addEventListener("click",()=>{if(At.state!=="playing"||!Kn()||!me())return;let t=V.active??bn;if(!t)return;let o=gs[t];!o||!Xn(o)||(te.selectSpell(o),V.active&&(bn=V.active,Yn=!0,V.deactivate()),tn.handleSpellButtonClick())});let Ss=e.soundsToggle,Es=e.musicToggle;function cn(){let t=B.getSettings();t.soundsEnabled?Ss.classList.add("active"):Ss.classList.remove("active"),t.musicEnabled?Es.classList.add("active"):Es.classList.remove("active");for(let o=0;o<=4;o++){let a=e.soundVolBtns[o],E=e.musicVolBtns[o];a&&a.classList.toggle("active",t.soundVolume===o),E&&E.classList.toggle("active",t.musicVolume===o)}}let Qs=e.tabBtns,_i=e.tabContents;Qs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;Qs.forEach(a=>a.classList.remove("active")),_i.forEach(a=>a.classList.remove("active")),t.classList.add("active"),Lo(o).classList.add("active"),o==="sounds"&&cn()})});let Zs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Js=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Bi=e.iosHint,Li=e.standaloneBadge;function to(){let t=document.fullscreenElement||document.webkitFullscreenElement;Ut.textContent=t?"Disable":"Enable"}Zs&&(Js?(Li.style.display="block",Ut.style.display="none"):(Bi.style.display="block",Ut.textContent="Not supported",Ut.style.opacity="0.5",Ut.style.cursor="default")),Ut.addEventListener("click",()=>{if(Zs&&!Js)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",to),document.addEventListener("webkitfullscreenchange",to);let is=e.invertSwipeToggle,sn=e.hapticsToggle;M.invertSwipe&&is.classList.add("active"),sn&&(q.supports()?M.hapticsEnabled&&sn.classList.add("active"):(sn.classList.add("disabled"),sn.classList.remove("active"),M.hapticsEnabled=!1,q.setEnabled(!1),C.saveGameSettings(M))),pn&&Us(),is.addEventListener("click",()=>{is.classList.toggle("active");let t=is.classList.contains("active");Ee.rotDir=t?-1:1,M.invertSwipe=t,C.saveGameSettings(M)}),sn&&sn.addEventListener("click",()=>{if(sn.classList.contains("disabled"))return;sn.classList.toggle("active");let t=sn.classList.contains("active");M.hapticsEnabled=t,C.saveGameSettings(M),q.setEnabled(t)}),pn&&pn.addEventListener("click",()=>{pn.classList.toggle("active");let t=pn.classList.contains("active");ei(t)}),Ss.addEventListener("click",()=>{let o=!B.getSettings().soundsEnabled;B.updateSettings({soundsEnabled:o}),cn(),$n()}),Es.addEventListener("click",()=>{let o=!B.getSettings().musicEnabled;B.updateSettings({musicEnabled:o}),cn(),$n(),pt!=="paused"&&(o?pt==="playing"?B.startGameMusic():B.startMenuMusic():B.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{B.updateSettings({soundVolume:t}),cn(),B.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{B.updateSettings({musicVolume:t}),cn()})}cn();function eo(){pt==="playing"&&(ct.pause(),Ue=performance.now(),pt="paused",B.musicAudio&&B.musicAudio.pause())}function rs(){pt==="paused"&&(ct.resume(),un+=performance.now()-Ue,Ue=0,pt="playing",xs=performance.now(),B.getSettings().musicEnabled&&B.startGameMusic())}function $n(){let t=B.getSettings();Nt.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Nt.classList.toggle("off",!t.soundsEnabled),Me.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Me.classList.toggle("off",!t.musicEnabled)}function Ri(){Gt.classList.remove("hidden"),Jt.classList.add("hidden");let t=C.loadHighscore(Et);if(Fe.textContent=t.score?t.score.toLocaleString():"0",we.textContent=t.time?ds(t.time):"0:00",je.textContent=Et==="30_24"?"High Tower":"Quick Tower",gn.textContent=St.toLocaleString(),Qe.textContent=ds(Qt),Dt.textContent=Et==="30_24"?"High Tower":"Quick Tower",$n(),ro){let o=Et==="30_24";ro.style.display=o?"":"none",o&&Bs()}}function Fn(){Gt.classList.add("hidden"),Jt.classList.remove("hidden")}Jt.addEventListener("click",()=>{eo(),Ri()}),$e.addEventListener("click",()=>{Fn(),rs()});let Ms=null;function no(t,o){be.textContent=t,Ms=o,Ze.classList.remove("hidden")}function so(){Ze.classList.add("hidden"),Ms=null}xe.addEventListener("click",()=>{so()}),on.addEventListener("click",()=>{let t=Ms;so(),t&&t()}),Ie.addEventListener("click",()=>{no("Restart game?",()=>{Fn(),At.applyCommand("start_game")})}),Ve.addEventListener("click",()=>{no("Exit to menu?",()=>{Fn(),Jt.classList.add("hidden"),pt="intro",ct.reset(),B.stopMusic(),B.getSettings().musicEnabled&&B.startMenuMusic(),Dn()})}),re.addEventListener("click",()=>{It.classList.remove("hidden")}),Nt.addEventListener("click",()=>{let t=B.getSettings();B.updateSettings({soundsEnabled:!t.soundsEnabled}),$n(),cn()}),Me.addEventListener("click",()=>{let o=!B.getSettings().musicEnabled;B.updateSettings({musicEnabled:o}),$n(),cn()}),Gt.addEventListener("click",t=>{t.target===Gt&&(Fn(),rs())}),document.addEventListener("keydown",t=>{pt==="paused"&&!Gt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Fn(),rs())}),fn.addEventListener("click",()=>{It.classList.add("hidden")}),It.addEventListener("click",t=>{t.target===It&&It.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?pt==="playing"&&(eo(),bs=!0):bs&&pt==="paused"&&(rs(),bs=!1)});let At=Wo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Vt,LOCK_DELAY_SEC:Wt,getKillRate:g,MATCH_HIGHLIGHT_SEC:yn,MAGIC_SHRINK_SEC:yt,RING_HIGHLIGHT_SEC:J,getState:()=>({gameState:pt,score:St,elapsedMs:Qt,startTime:ln,totalPausedMs:un,stats:at,activePiece:y,pieceY:b,targetRot:se,rotFloat:gt,rotVel:Ae,isGrounded:x,isHighlighting:We,isMagicAnimation:rn,isRingAnimation:Cn,highlightStartTime:On,killLevel:D,grid:A,fallTimer:R,lockTimer:vt}),setState:t=>{"elapsedMs"in t&&(Qt=t.elapsedMs),"killLevel"in t&&(D=t.killLevel),"fallTimer"in t&&(R=t.fallTimer),"lockTimer"in t&&(vt=t.lockTimer),"targetRot"in t&&(se=t.targetRot),"rotFloat"in t&&(gt=t.rotFloat),"rotVel"in t&&(Ae=t.rotVel)},funcs:{startGame:yi,endGame:ys,rotatePieceByDir:mi,tryMoveDown:Ci,canPlaceAtRot:Vs,maybeResetLockDelay:Ws,shootMagic:ci,selectMagic:Un,updateGroundedState:hi,lockPiece:xi,finishHighlight:fi,finishRingHighlight:bi},ui:{updateTimeHud:hs,updateRemainingHud:Ks}}),_n=Ko({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:z,MAX_RADIUS_X:U,RADIUS_X_FACTOR:K,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:yn,MATCH_SHRINK_PHASE:Ln,MAGIC_SHRINK_SEC:yt,RING_HIGHLIGHT_SEC:J,LOCK_DELAY_SEC:Wt,getKillRate:g,ELEMENT_COLORS:Le,ELEMENT_TO_COLOR:ee,BLOCK_COLOR_FRONT:st,BLOCK_COLOR_BACK:mt,ACTIVE_COLOR_FRONT:ue,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:W,GHOST_STROKE_WIDTH:bt,MAGIC_DIM_DOT_ALPHA:ie,MAGIC_DIM_DOT_SCALE:$t,MAGIC_TARGET_DOT_SCALE:Yt,getState:()=>({gameState:pt,grid:A,activePiece:y,pieceY:b,rotFloat:gt,killLevel:D,isHighlighting:We,highlightedCells:en,highlightStartTime:On,isMagicAnimation:rn,isRingAnimation:Cn,isGrounded:x,lockTimer:vt,spellState:tn.getRenderState()}),getVisualSettings:()=>({waterBubbles:an,waterColor:Sn}),funcs:{snappedRot:Jn,computeGhostY:pi,normSector:Zn,getMagicTargetColor:()=>me()&&V.canUse()?ee[V.active]:null,getTransmuteAnimState:t=>tn.getTransmuteAnimState(t),getLightningAnimState:t=>tn.getLightningAnimState(t),getFireAnimState:t=>tn.getFireAnimState(t)}}),xs=performance.now();function oo(t){let o=Math.min(.05,Math.max(.001,(t-xs)/1e3));if(xs=t,At.update(o,t),tn.update(t),Ot>0){let a=Math.min(Ot,Re*o);D=Math.max(0,D-a),Ot-=a}gt=se,gt>1e6&&(gt%=i),gt<-1e6&&(gt%=i),_n.render(o,t),requestAnimationFrame(oo)}h.addEventListener("click",()=>{At.applyCommand("start_game")}),G.addEventListener("click",()=>{At.applyCommand("start_game")}),it.addEventListener("click",()=>{pt="intro",ct.reset(),B.stopMusic(),B.getSettings().musicEnabled&&B.startMenuMusic(),Dn()}),Tt.forEach(t=>{t.addEventListener("click",o=>{Tt.forEach(E=>E.classList.remove("active")),t.classList.add("active"),Et=t.dataset.mode,qn(),Wn();let a=C.loadHighscore(Et);a.score>0?(nt.textContent=a.score.toLocaleString(),lt.textContent=hn(a.time)):(nt.textContent="0",lt.textContent="0:00"),h.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>h.classList.add("idlePulse"),2e3)})});let vs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),Ai=document.getElementById("spellProgressFill"),io=document.getElementById("spellProgressMarkers"),ro=document.getElementById("pauseSpellProgress"),Ii=document.getElementById("pauseSpellProgressFill"),co=document.getElementById("pauseSpellProgressMarkers"),ao=document.getElementById("pauseSpellProgressLabel");function Ts(){return zo.map(t=>In(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function wi(t){let o=Ts(),a=_s(o);return a<=0?"":`${Math.min(t,a)}/${a}`}function lo(t){if(!t)return;t.innerHTML="";let o=Ts(),a=_s(o);o.forEach(E=>{let H=document.createElement("span");H.className="marker",H.dataset.threshold=E;let tt=a>0?E/a*100:0;H.style.left=`${tt}%`,t.appendChild(H)})}function uo(t,o){if(!t)return;let a=Pi(o);t.style.width=`${a}%`}function go(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(E=>{let H=parseInt(E.dataset.threshold,10)||0;E.classList.toggle("reached",o>=H)})}function Pi(t){let o=Ts(),a=_s(o);return t<=0||a<=0?0:t>=a?100:t/a*100}function fo(t){if(!Cs)return;let o=In(t),a=te.getDescription(t);o===0||Zt>=o?Cs.innerHTML=a:Cs.innerHTML=`${a} <span class="spell-progress-text">${Zt}/${o}</span>`}function Bs(){Zt=C.loadHighTowerRings(),vs.forEach(o=>{let a=o.dataset.spell,E=In(a),H=Zt>=E;o.classList.toggle("locked",!H);let tt=o.querySelector(".spell-lock");tt&&(tt.style.display=H?"none":"")}),uo(Ai,Zt),uo(Ii,Zt),go(io,Zt),go(co,Zt),ao&&(ao.textContent=wi(Zt));let t=document.querySelector(".spell-select-btn.active");t&&fo(t.dataset.spell)}lo(io),lo(co),Bs(),vs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){Tt.forEach(Xt=>Xt.classList.remove("active")),a.classList.add("active"),Et="30_24",qn(),Wn();let rt=C.loadHighscore(Et);rt.score>0?(nt.textContent=rt.score.toLocaleString(),lt.textContent=hn(rt.time)):(nt.textContent="0",lt.textContent="0:00")}let E=t.dataset.spell,H=In(E),tt=Zt>=H;fo(E),tt&&(vs.forEach(rt=>rt.classList.remove("active")),t.classList.add("active"),te.selectSpell(E),wn(V.active))})}),ge.addEventListener("click",()=>{let t=C.loadHighscore("30_24"),o=C.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${hn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${hn(o.time)}
`:`  No record yet
`,alert(a)}),Je.addEventListener("click",()=>{It.classList.remove("hidden")}),mn.addEventListener("click",()=>{let t=me()?`6) Use magic: tap element button, then tap matching block

`:`6) Magic is disabled in settings (Quick Tower)

`;alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
`+t+"Survive as long as you can!")}),An(),Wn(),qn(),Dn(),B.startMenuMusic();let ki=()=>{if(B.unlock(),!B.getSettings().musicEnabled)return;let t=B.musicAudio;!t||t.paused||t.ended?At.state==="playing"?B.startGameMusic():B.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},mo=0,Oi=10,Di=()=>{mo>=Oi||(mo++,ki())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Di,{passive:!0})}),requestAnimationFrame(oo)})();})();
