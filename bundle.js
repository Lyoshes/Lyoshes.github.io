(()=>{var $i=[0,.25,.5,.75,1],Ni=[0,.05,.15,.25,.5],Gi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},yo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},So="soundSettings";function Ui(){try{let e=localStorage.getItem(So);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Xi(e){try{localStorage.setItem(So,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Eo(){return{audioContext:null,buffers:{},settings:Ui(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return $i[this.settings.soundVolume]},getMusicVolume(){return Ni[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${c}`,l)}},preload(){this.initContext();for(let[n,c]of Object.entries(Gi))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;c!==null&&(l=`${n}${c}`);let i=this.buffers[l];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Xi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var bo="eb_highscore",Mo="eb_highscore_quick",xo="eb_settings",Co="eb_high_tower_rings",Yi={invertSwipe:!1,hapticsEnabled:!0};function To(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Mo:bo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let l=this.loadHighscore(c);if(e>l.score||e===l.score&&n>l.time){let i=c==="25_20"?Mo:bo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(xo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Yi}},saveGameSettings(e){try{localStorage.setItem(xo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Co);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Co,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function _o(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Lo(e){return document.getElementById("tab-"+e)}var Wi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Bo(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(l,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=l,s&&n[s]&&(r.style.color=n[s]);let g=window.innerWidth/2,m=window.innerHeight/2-40,f=(Math.random()-.5)*200,u=(Math.random()-.5)*100+c*36;r.style.left=`${g+f}px`,r.style.top=`${m+u}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(l){return Wi[l]||"\u2726"}}}var Rs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ro(){return{spawnMagicOrb(e,n,c,l){if(!l)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Rs[e]||"\u2726";let s=l.getBoundingClientRect(),r=s.left+s.width/2-n,g=s.top+s.height/2-c,m=Math.hypot(r,g),f=Math.atan2(g,r),u=m*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,b=r*.5+Math.cos(p)*u,O=g*.5+Math.sin(p)*u;i.style.setProperty("--mid-x",`${b}px`),i.style.setProperty("--mid-y",`${O}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${g}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,l,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,g=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Rs[e]||"\u2726";let f=c-r,u=l-g;m.style.setProperty("--end-x",`${f}px`),m.style.setProperty("--end-y",`${u}px`),m.style.left=`${r}px`,m.style.top=`${g}px`,document.body.appendChild(m);let p=setInterval(()=>{let b=m.getBoundingClientRect();this.spawnTrailParticle(e,b.left+b.width/2,b.top+b.height/2)},40);setTimeout(()=>{clearInterval(p),m.remove(),this.spawnExplosion(e,c,l),i&&i()},300)},spawnTrailParticle(e,n,c){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${c}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,g=40+Math.random()*40,m=Math.cos(r)*g,f=Math.sin(r)*g;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let l=n;typeof n=="number"&&(c=n,l="water"),Rs[l]||(l="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,g=Math.max(8,Math.round(c));for(let m=0;m<g;m++){let f=document.createElement("div");f.className=`spell-bubble ${l}`,f.textContent="\u25CF";let u=m/g*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,b=Math.cos(u)*p,O=Math.sin(u)*p-20;f.style.setProperty("--px",`${b}px`),f.style.setProperty("--py",`${O}px`),f.style.left=`${s}px`,f.style.top=`${r}px`,f.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,g=Math.hypot(s,r),m=Math.atan2(r,s),f=g*.35*(Math.random()>.5?1:-1),u=m+Math.PI/2,p=s*.5+Math.cos(u)*f,b=r*.5+Math.sin(u)*f;l.style.setProperty("--mid-x",`${p}px`),l.style.setProperty("--mid-y",`${b}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${r}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}var Vi=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Ao=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Ki=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function qi(e){let n=e.querySelector(".ring"),c=e.querySelector(".falling-figure"),l=e.querySelector(".clock");if(!n||!c||!l)return()=>{};let i=!1,s=[],r=[],g=(K,q)=>{let lt=setTimeout(()=>{i||K()},q);return s.push(lt),lt},m=(K,q)=>{let lt=setInterval(()=>{if(i){clearInterval(lt);return}K()},q);return r.push(lt),lt},f=48,u=.9,p=9,b=9,O=3,P=2,F=18,ot=-12,ut=.5,ce=12,Z=10,G=["--fire","--water","--light","--earth"],pt=["--light","--fire","--water"],Zt=3,Ot=Math.floor(p/2)-1,Yt=8e3,wt=[];function It(K,q){let lt=(q-1)/2,Kt=Math.abs(K-lt)/lt;return 1-(1-ut)*Kt}function R(K,q,lt,Kt){let be=(q-1)/2,j=Math.abs(K-be)/be;return Kt?j*lt:-j*lt}function Ct(){n.innerHTML="";let K=[],q=[];for(let nt=0;nt<b;nt++)q.push(f*u*It(nt,b));let lt=q.reduce((nt,_t)=>nt+_t,0)+(b-1)*P,Kt=[];for(let nt=0;nt<p;nt++)Kt.push(f*It(nt,p));let be=Kt.reduce((nt,_t)=>nt+_t,0)+(p-1)*O,j=-lt/2;for(let nt=0;nt<b;nt++){let _t=q[nt],Nt=f*u,fe=p+nt,Et=R(nt,b,Z,!0),Jt=document.createElement("div");Jt.className="block back",Jt.style.cssText=`left:${j.toFixed(1)}px;top:${(ot-Nt/2+Et).toFixed(1)}px;width:${_t.toFixed(1)}px;height:${Nt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let U=document.createElement("div");U.className="dot";let te=u*It(nt,b);U.style.cssText=`--c:var(${G[fe%4]});transform:scale(${te.toFixed(2)});`,Jt.appendChild(U),Jt.dataset.index=fe,n.appendChild(Jt),K[fe]=Jt,j+=_t+P}let tt=-be/2;for(let nt=0;nt<p;nt++){let _t=Kt[nt],Nt=f,fe=nt,Et=R(nt,p,ce,!1),Jt=fe>=Ot&&fe<Ot+Zt,U=document.createElement("div");U.className="block",Jt&&U.classList.add("gap"),U.style.cssText=`left:${tt.toFixed(1)}px;top:${(F-Nt/2+Et).toFixed(1)}px;width:${_t.toFixed(1)}px;height:${Nt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let te=document.createElement("div");te.className="dot";let Te=It(nt,p);te.style.cssText=`--c:var(${G[fe%4]});transform:scale(${Te.toFixed(2)});`,U.appendChild(te),U.dataset.index=fe,n.appendChild(U),K[fe]=U,tt+=_t+O}wt=K}function Tt(){let K=[];for(let q=Ot-1;q>=0;q--)K.push(q);for(let q=0;q<b;q++)K.push(p+q);for(let q=p-1;q>=Ot;q--)K.push(q);return K}function St(){wt.forEach((K,q)=>{K&&(K.classList.remove("hi","vanish","gap"),K.style.opacity="",K.style.transform="",q>=Ot&&q<Ot+Zt&&K.classList.add("gap"))})}function a(){for(let K=0;K<Zt;K++){let q=wt[Ot+K];if(q){q.classList.remove("gap");let lt=q.querySelector(".dot");if(lt){let Kt=It(Ot+K,p);lt.style.cssText=`--c:var(${pt[K]});transform:scale(${Kt.toFixed(2)});`}}}}function at(K){let q=Tt(),lt=0,Kt=q.length,be=m(()=>{if(lt>0&&lt<=Kt){let j=wt[q[lt-1]];j&&j.classList.remove("hi")}if(lt<Kt){let j=wt[q[lt]];j&&j.classList.add("hi"),lt++}else clearInterval(be),wt.forEach(j=>{j&&j.classList.add("hi")}),g(K,300)},30)}function J(K){let q=Tt(),lt=q.length;q.forEach((Kt,be)=>{let j=wt[Kt];j&&g(()=>{j.classList.add("vanish")},be*40)}),g(K,lt*40+500)}function ue(){i||(St(),c.classList.add("active"),g(()=>{a(),c.classList.remove("active"),c.style.opacity="0",g(()=>{at(()=>{i||(l.classList.add("show"),g(()=>{J(()=>{i||(l.classList.remove("show"),c.style.opacity="",g(ue,500))})},400))})},200)},Yt*.38))}return Ct(),ue(),()=>{i=!0,s.forEach(clearTimeout),r.forEach(clearInterval)}}var zi=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:Vi},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Ao},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:Ki,onEnter:e=>qi(e)}];function wo(e={}){let{helpBtn:n,mount:c=document.body,combosTemplate:l}=e;if(!n||!c)return{open(){},close(){},setCombosTemplate(){}};let i=zi.map(R=>({...R}));typeof l=="string"&&l.trim()&&(i[1].illustrationHtml=l);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,c.appendChild(s);let r=s.querySelector(".help-next-btn"),g=s.querySelector(".help-slide-title"),m=s.querySelector(".help-slide-text"),f=s.querySelector(".help-illustration"),u=s.querySelector(".help-dots"),p=i.map(()=>{let R=document.createElement("span");return R.className="help-dot",u.appendChild(R),R}),b=0,O=!1,P=null,F=null,ot=180,ut=560,ce=460,Z=480,G=R=>{F&&(F(),F=null);let Ct=i[R];Ct&&(b=R,g.textContent=Ct.title,m.textContent=Ct.text,f.innerHTML=Ct.illustrationHtml||"",p.forEach((Tt,St)=>{Tt.classList.toggle("active",St===R)}),r.textContent=R===i.length-1?"Done":"Next",pt(),Ct.onEnter&&(F=Ct.onEnter(f)))},pt=()=>{if(!O||s.classList.contains("hidden"))return;let R=f.getBoundingClientRect();if(!R.width||!R.height)return;let Ct=f.querySelector(".help-combos");if(Ct){let a=Math.min(1,Math.min(R.width,R.height)/ut);Ct.style.setProperty("--help-combos-scale",a.toFixed(3))}let Tt=f.querySelector(".help-controls");if(Tt){let a=Math.min(1,Math.min(R.width,R.height)/ce);Tt.style.setProperty("--help-controls-scale",a.toFixed(3))}let St=f.querySelector(".help-rings");if(St){let a=Math.min(1,Math.min(R.width,R.height)/Z);St.style.setProperty("--help-rings-scale",a.toFixed(3))}},Zt=()=>{O&&pt()},Ot=R=>{O&&R.stopPropagation()},Yt=R=>{if(O){if(R.key==="Escape"){R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.(),It();return}R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.()}},wt=()=>{O||(O=!0,P&&(clearTimeout(P),P=null),G(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),pt()}),document.addEventListener("keydown",Yt,!0),window.addEventListener("resize",Zt))},It=()=>{O&&(O=!1,F&&(F(),F=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",Yt,!0),window.removeEventListener("resize",Zt),P=window.setTimeout(()=>{s.classList.add("hidden")},ot))};return s.addEventListener("click",R=>{O&&(R.target===s&&It(),R.stopPropagation())}),s.addEventListener("pointerdown",Ot),s.addEventListener("pointerup",Ot),s.addEventListener("touchstart",Ot,{passive:!0}),s.addEventListener("touchmove",R=>{O&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),s.addEventListener("wheel",R=>{O&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),r.addEventListener("click",R=>{R.stopPropagation(),b<i.length-1?G(b+1):It()}),n.addEventListener("click",R=>{R.preventDefault(),wt()}),{open:wt,close:It,setCombosTemplate(R){typeof R=="string"&&(i[1].illustrationHtml=R.trim()||Ao,O&&b===1&&G(1))}}}var ji={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Qi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var As=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},ws=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Io({enabled:e=!0,patterns:n=ji}={}){let c=Qi(),l=c?new ws(c):new As,i=l.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let g=n[r];return g?l.trigger({name:r,...g}):!1}}}function Po(e={}){let{buttons:n={},onActivate:c=null,onChange:l=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[m,f]of Object.entries(n)){if(!f)continue;let u=i[m],p=f.querySelector(".charges");p&&(p.textContent=u),f.classList.toggle("empty",u<=0),f.classList.toggle("active",s===m&&u>0)}l&&l({...i},s)}function g(m){let f=n[m];f&&(f.classList.remove("pulse"),f.offsetWidth,f.classList.add("pulse"),setTimeout(()=>f.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(m){s=m},select(m){if(i[m]<=0)return!1;let f=s===m;return s=f?null:m,r(),!f&&s===m&&c&&c(),!f},useCharge(){if(!s||i[s]<=0)return!1;let m=s;return i[m]--,s=null,r(),g(m),!0},addCharges(m,f){i[m]!==void 0&&(i[m]+=f,r(),g(m))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(m){for(let[f,u]of Object.entries(n))u&&u.addEventListener("click",()=>{m&&m(f)})}}}var je={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function ko(e={}){let{button:n=null,onActivate:c=null,onProgress:l=null,onReady:i=null}=e,s="ice",r=0;function g(){return je[s]||je.ice}function m({silent:u=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=g(),b=Number.isFinite(p.maxProgress)?p.maxProgress:0,O=b>0?Math.min(r/b,1)*100:0,P=b>0&&r>=b;n.style.setProperty("--progress",`${O}%`);let F=n.querySelector(".spell-icon");F&&(F.textContent=p.icon);let ot=n.querySelector(".spell-counter");ot&&(ot.textContent=b>0?`${Math.min(r,b)}/${b}`:""),n.classList.toggle("ready",P),n.classList.toggle("charging",!P&&r>0),l&&!u&&b>0&&l(r,b)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return g().maxProgress??0},get isReady(){let u=g().maxProgress;return Number.isFinite(u)&&u>0&&r>=u},get effect(){return g().effect},getUnlockRings(u){return(je[u]||je.ice).unlockRings??0},getCost(u){return(je[u]||je.ice).cost??0},getDescription(u){return(je[u]||je.ice).description||""},getEffect(u){return(je[u]||je.ice).effect},get button(){return n},selectSpell(u){je[u]&&(s=u,r=0,m())},addProgress(u=1){let p=g();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let b=r<p.maxProgress;return r=Math.min(r+u,p.maxProgress),m(),f(),b&&r>=p.maxProgress&&i&&i(),!0},setProgress(u,{silent:p=!1}={}){r=Math.max(0,u),m({silent:p})},canUse(){let u=g().maxProgress;return Number.isFinite(u)&&u>0&&r>=u},use(){if(!this.canUse())return null;let u=g().effect;return r=0,m(),f(),c&&c(s),u},reset(){r=0,m()},pulse(){f()},updateButton:m,initButton(u){n&&n.addEventListener("click",()=>{u&&u()})}}}function Is({centerY:e,centerS:n,size:c,H:l,normSector:i}){let s=[],r=Math.floor(c/2);for(let g=-r;g<=r;g++)for(let m=-r;m<=r;m++){let f=e+g,u=i(n+m);if(f<0||f>=l)continue;let p=g*g+m*m;s.push({y:f,s:u,distSq:p})}return s}function ds(e,n,c){return n.filter(l=>e[l.y][l.s]===c)}function us(e,n){return[...e].sort((l,i)=>l.distSq!==i.distSq?l.distSq-i.distSq:l.y!==i.y?l.y-i.y:l.s-i.s).slice(0,n).map(l=>({y:l.y,s:l.s}))}function Oo({centerY:e,centerS:n,beamLength:c,beamWidth:l,N:i,H:s,normSector:r}){if(e<0||e>=s||l<=0||c<0||i<=0)return[];let g=Math.min(l,s),m=[],f=new Set,u=P=>P<0||P>=s||f.has(P)?!1:(f.add(P),m.push(P),!0);u(e);for(let P=1;m.length<g&&(e+P<s||e-P>=0)&&(u(e+P),!(m.length>=g));P++)u(e-P);m.sort((P,F)=>F-P);let p=Math.min(i,c*2+1),b=c%2===0,O=[];for(let P of m){let F=new Set,ot=(ut,ce)=>{let Z=r(ut);return F.has(Z)?!1:(F.add(Z),O.push({y:P,s:Z,dist:ce}),!0)};ot(n,0);for(let ut=1;F.size<p&&ut<i;ut++)if(b){if(ot(n+ut,ut),F.size>=p)break;ot(n-ut,ut)}else{if(ot(n-ut,ut),F.size>=p)break;ot(n+ut,ut)}}return O}function Do(e){let{canvas:n,dom:c,getGrid:l,getN:i,getH:s,getRotFloat:r,constants:g,helpers:m,Spell:f,Magic:u,SoundModule:p,State:b,isGamePlaying:O,addPendingKzDrop:P,getKillRate:F,triggerSpellWave:ot,spawnSpellBubbles:ut,spawnBonusBubbles:ce,getTransmuteEffect:Z,getLightningEffect:G,getFireEffect:pt,continueMatchProcessing:Zt,updateScoreHud:Ot,showBonus:Yt,getSpellCost:wt,getSpellElement:It,onUltimateApplied:R,isSpellBlocked:Ct,setScore:Tt,setCascadeLevel:St}=e,{TOP_PAD_PX:a,BOTTOM_PAD_PX:at,SIDE_MARGIN_PX:J,MAX_RADIUS_X:ue,SCORE_MAGIC_DESTROY:K}=g,{normSector:q,levelYToScreenY:lt,sectorCenterXY:Kt}=m,be=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],j="idle",tt=null,nt=null,_t=[],Nt=[],fe=0,Et=null,Jt=0,U="idle",te=null,Te=[],ee=[],Y=0,D=0,L="idle",x=null,B=[],y=[],dt=0;function it(h){if(typeof wt!="function"||typeof It!="function")return!1;let I=It(h),M=wt(h);return!I||!M?!1:(u.charges[I]??0)>=M}function Lt(h){if(typeof wt!="function"||typeof It!="function")return!1;let I=It(h),M=wt(h);return!I||!M||(u.charges[I]??0)<M?!1:(u.charges[I]-=M,u.updateButtons(),f.pulse(),!0)}let vt=0,v=350;function C(){return typeof Ct=="function"?Ct():!1}function w(){let h=performance.now();h-vt<v||(vt=h,p.play("cancel"))}function ct(){j="selecting_source",tt=null,nt=null,_t=[],Nt=[],U!=="idle"&&Ut(),L!=="idle"&&A(),u.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function E(){j!=="idle"&&p.play("cancel"),j="idle",tt=null,nt=null,_t=[],Nt=[],Dt();let h=c.spellBtn;h&&h.classList.remove("selecting")}function Wt(h,I){if(j!=="selecting_source")return!1;if(C())return w(),!0;let M=H(h,I);if(!M)return E(),!0;let et=l();tt={y:M.y,s:M.s,color:et[M.y][M.s]},_t=Is({centerY:M.y,centerS:M.s,size:Z().areaSize,H:s(),normSector:q});let Pt=tt.color,kt=ds(et,_t,Pt);return Nt=us(kt,Z().maxBlocks),Gt(tt.color,M.y),j="selecting_target",!0}function H(h,I){let M=n.clientWidth,et=n.clientHeight,Pt=M*.5,kt=(M-2*J)/2,jt=et-a-at,_e=6,pe=s(),Qe=i(),he=r(),Le=Qe*jt/(_e*pe),Me=et-at,ve,Ve,Ke;Le<=Math.min(kt,ue)?(ve=Le,Ve=jt,Ke=a):(ve=Math.min(kt,ue),Ve=ve*_e*pe/Qe,Ke=Me-Ve);let Be=ve*.28,qe=null,En=1/0,nn=l();for(let Qt=0;Qt<pe;Qt++){let pn=lt(Ke,Ve,Qt+.5);for(let ke=0;ke<Qe;ke++){if(!nn[Qt][ke])continue;let Oe=Kt(Pt,pn,ve,Be,ke,he);if(Math.sin(Oe.ang)<-.1)continue;let le=h-Oe.x,bn=I-Oe.y,Re=Math.hypot(le,bn),de=Ve/pe*.9,T=de*1.2;Math.abs(le)<T/2&&Math.abs(bn)<de/2&&Re<En&&(En=Re,qe={y:Qt,s:ke})}}return qe}function Gt(h,I){Dt();let M=document.createElement("div");M.className="transmute-popup";let et=n.clientWidth,Pt=n.clientHeight,kt=(et-2*J)/2,jt=Pt-a-at,_e=6,pe=s(),Qe=i(),he=Qe*jt/(_e*pe),Le=Pt-at,Me,ve;he<=Math.min(kt,ue)?(Me=jt,ve=a):(Me=Math.min(kt,ue)*_e*pe/Qe,ve=Le-Me);let Ve=lt(ve,Me,I+.5),Ke=Math.floor(Z().areaSize/2),Be=lt(ve,Me,Math.min(pe,I+Ke)+.5),qe=lt(ve,Me,Math.max(0,I-Ke)+.5),En=ve+Me/2,nn=document.getElementById("gameContainer"),Qt=nn?nn.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},pn=160,ke=60,Oe=20,sn=Qt.left+Qt.width/2-pn/2,le;Ve<En?le=Qt.top+qe+Oe:le=Qt.top+Be-ke-Oe,le=Math.max(10,Math.min(window.innerHeight-ke-10,le)),M.style.left=`${sn}px`,M.style.top=`${le}px`,be.filter(Re=>Re.color!==h).forEach(Re=>{let de=document.createElement("button");de.className=`transmute-btn ${Re.name}`,de.innerHTML=Re.icon,de.setAttribute("data-color",Re.color),de.addEventListener("click",T=>{T.stopPropagation(),ge(Re.color)}),M.appendChild(de)}),document.body.appendChild(M),Et=M,Jt=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",re)},50)}function re(h){performance.now()-Jt<200||Et&&!Et.contains(h.target)&&E()}function Dt(){document.removeEventListener("pointerdown",re),Et&&(Et.remove(),Et=null)}function ge(h){if(C()){w();return}if(!it(f.currentSpell)){w();return}if(Dt(),nt=h,Nt.length===0){E();return}un()}function un(){if(!tt){E();return}if(Nt.length===0){E();return}if(!Lt(f.currentSpell)){w(),E();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),j="animating",fe=performance.now(),p.play("esseffect")}function qt(){if(j!=="selecting_target"&&j!=="animating"||!tt||!_t||_t.length===0)return;let h=l(),I=h[tt.y]?.[tt.s]??0;if(!I||I!==tt.color){E();return}let M=ds(h,_t,I),et=Z().maxBlocks??M.length;Nt=us(M,et),Nt.length===0&&E()}function Vt(h){if(j!=="animating")return!1;let I=(h-fe)/1e3;return Math.min(I/Z().animSec,1)>=1?(Pe(),!1):!0}function Ye(h){if(j!=="animating")return null;let I=(h-fe)/1e3,M=Math.min(I/Z().animSec,1),et="flash",Pt=0,kt=0;return M<.15?(et="flash",kt=1-M/.15):M<.55?(et="shrink",Pt=(M-.15)/.4):(et="grow",Pt=(M-.55)/.45),{phase:et,progress:Pt,areaFlash:kt}}function Pe(){let h=l();for(let I of Nt)h[I.y][I.s]=nt;j="idle",tt=null,nt=null,_t=[],Nt=[],St(0),Zt(),typeof R=="function"&&R("earth")}function zt(){p.play("ulta"),U="selecting_source",te=null,Te=[],ee=[],D=0,j!=="idle"&&(j="idle",tt=null,nt=null,_t=[],Nt=[],Dt()),L!=="idle"&&(L="idle",x=null,B=[],y=[],dt=0),u.deactivate();let h=c.spellBtn;h&&h.classList.add("selecting")}function Ut(){U!=="idle"&&p.play("cancel"),U="idle",te=null,Te=[],ee=[],D=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function Fe(){L="selecting_source",x=null,B=[],y=[],dt=0,j!=="idle"&&(j="idle",tt=null,nt=null,_t=[],Nt=[],Dt()),U!=="idle"&&(U="idle",te=null,Te=[],ee=[],D=0),u.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function A(){L!=="idle"&&p.play("cancel"),L="idle",x=null,B=[],y=[],dt=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function me(h,I){if(U!=="selecting_source")return!1;if(C())return w(),!0;let M=H(h,I);if(!M)return Ut(),!0;let et=l();te={y:M.y,s:M.s,color:et[M.y][M.s]},Te=Is({centerY:M.y,centerS:M.s,size:G().areaSize,H:s(),normSector:q});let Pt=te.color,kt=ds(et,Te,Pt);return ee=us(kt,G().maxBlocks),ee.length===0?(Ut(),!0):it(f.currentSpell)?(ne(),!0):(w(),!0)}function bt(h,I){if(L!=="selecting_source")return!1;if(C())return w(),!0;let M=H(h,I);if(!M)return A(),!0;let et=l();return x={y:M.y,s:M.s,color:et[M.y][M.s]},B=Oo({centerY:M.y,centerS:M.s,beamLength:pt().beamLength,beamWidth:pt().beamWidth,N:i(),H:s(),normSector:q}),y=B.filter(Pt=>et[Pt.y][Pt.s]),y.length===0?(A(),!0):it(f.currentSpell)?(yn(),!0):(w(),!0)}function ne(){if(!te||ee.length===0){Ut();return}if(!Lt(f.currentSpell)){w(),Ut();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),U="animating",Y=performance.now(),D=0,p.play("asseffect")}function xn(h){if(U!=="animating")return!1;let I=h-Y,M=G().flashMs+ee.length*G().jumpMs;return I>=M?(fn(),!1):!0}function We(h){if(U!=="animating")return null;let I=h-Y;if(I<G().flashMs)return{phase:"flash",flashProgress:1-I/G().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let M=I-G().flashMs,et=Math.floor(M/G().jumpMs),Pt=M%G().jumpMs/G().jumpMs,kt=[];for(let jt=0;jt<Math.min(et,ee.length);jt++)kt.push(jt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(et,ee.length-1),jumpProgress:Pt,struckTargets:kt}}function fn(){let h=l(),I=ee.length,M=I*K;b.addScore(M),Tt(b.score),Ot(),Yt(`+${M}`,"score");for(let jt of ee)h[jt.y][jt.s]=0;let et=G(),Pt=Math.abs(et.kzDropSecPerBlock??0),kt=I*Pt;kt>0&&typeof P=="function"&&typeof F=="function"&&(P(kt*F()),Yt(`\u26A1 -${kt}s`,"time")),U="idle",te=null,Te=[],ee=[],D=0,St(0),Zt(),typeof R=="function"&&R("air")}function yn(){if(!x||y.length===0){A();return}if(!Lt(f.currentSpell)){w(),A();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),L="animating",dt=performance.now(),p.play("fsseffect")}function $e(h){return L!=="animating"?!1:(h-dt)/1e3>=pt().animSec?(se(),!1):!0}function gt(h){if(L!=="animating")return null;let I=Math.max(.001,pt().animSec),M=(h-dt)/1e3,et=Math.min(M/I,1),Pt=.25,kt=et<Pt?1-et/Pt:0;return{progress:et,flashProgress:kt}}function se(){let h=l(),I=y.length;if(I>0){let M=I*K;b.addScore(M),Tt(b.score),Ot(),Yt(`+${M}`,"score")}for(let M of y)h[M.y][M.s]=0;L="idle",x=null,B=[],y=[],dt=0,St(0),Zt(),typeof R=="function"&&R("fire")}function Sn(){let h=typeof O=="function"?O():b.isPlaying(),I=f.currentSpell;if(!h)return!1;if(I==="ice"){if(C()||!it(I)||!Lt(f.currentSpell))return w(),!1;let M=f.effect;return typeof P=="function"&&typeof F=="function"&&P(M.duration*F()),p.play("wsseffect"),Yt(`\u{1F4A7} -${M.duration}s`,"time"),typeof ot=="function"&&ot(),typeof ce=="function"&&ce(M.duration),typeof R=="function"&&R(I),!0}return I==="earth"?j==="selecting_source"||j==="selecting_target"?(E(),!0):j!=="idle"||C()||!it(I)?(w(),!1):(j==="idle"&&ct(),!0):I==="air"?U==="selecting_source"?(Ut(),!0):U!=="idle"||C()||!it(I)?(w(),!1):(U==="idle"&&zt(),!0):I==="fire"?L==="selecting_source"?(A(),!0):L!=="idle"||C()||!it(I)?(w(),!1):(L==="idle"&&Fe(),!0):!1}function Xn(h){qt(),Vt(h),xn(h),$e(h)}function gn(h,I){return C()&&(j==="selecting_source"||U==="selecting_source"||L==="selecting_source")?(w(),!0):j==="selecting_source"?Wt(h,I):U==="selecting_source"?me(h,I):L==="selecting_source"?bt(h,I):!1}function ae(){j="idle",tt=null,nt=null,_t=[],Nt=[],Dt(),U="idle",te=null,Te=[],ee=[],D=0,L="idle",x=null,B=[],y=[],dt=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function mn(){return{transmuteState:j,transmuteSourceBlock:tt,transmuteTargetColor:nt,transmuteAreaCells:_t,transmuteBlocksToChange:Nt,lightningState:U,lightningSourceBlock:te,lightningAreaCells:Te,lightningBlocksToHit:ee,fireState:L,fireSourceBlock:x,fireLineCells:B,fireTargets:y}}return{startTransmuteSourceSelection:ct,cancelTransmutation:E,startLightningSourceSelection:zt,cancelLightning:Ut,startFireSourceSelection:Fe,cancelFire:A,handleTap:gn,update:Xn,reset:ae,getRenderState:mn,getTransmuteAnimState:Ye,getLightningAnimState:We,getFireAnimState:gt,handleSpellButtonClick:Sn,isTransmuteSelecting:()=>j==="selecting_source",isLightningSelecting:()=>U==="selecting_source"}}var Zi={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Ho(e={}){let{canvas:n}=e,c=e.rotDir||1,l=!1,i=0,s=0,r=0,g=0,m=0,f=1,u=null,p=0,b=0,O=0,P=0,F=0,ot=0,ut=0,ce=0,Z=Zi;return{get rotDir(){return c},set rotDir(G){c=G},get dragging(){return l},get dragMode(){return u},handlePointerDown(G,pt,Zt){if(pt.onMagicTap&&pt.onMagicTap(G.clientX,G.clientY))return!0;let Ot=performance.now(),Yt=Ot-ot,wt=G.clientX-ut,It=G.clientY-ce,R=Math.hypot(wt,It);return Yt<=Z.DOUBLE_TAP_MS&&R<=Z.DOUBLE_TAP_MAX_DIST?(pt.onDoubleTap&&pt.onDoubleTap(),ot=0):(ot=Ot,ut=G.clientX,ce=G.clientY),l=!0,f=-1,i=G.clientX,s=G.clientY,r=Zt,g=0,m=0,u=null,p=Ot,b=G.clientX,O=G.clientY,P=p,F=0,n&&n.setPointerCapture(G.pointerId),!1},handlePointerMove(G,pt,Zt,Ot){if(!l)return null;let Yt=G.clientX-i,wt=G.clientY-s,It=performance.now();if(Math.abs(Yt)<Z.DEADZONE_PX&&Math.abs(wt)<Z.DEADZONE_PX)return null;if(u){if(u==="rotate"){let Ct=Math.abs(Yt),Tt=Math.abs(wt);if(Tt>=Ct*Z.AXIS_DOMINANCE&&Tt>=Z.DROP_SWIPE_MIN_DISTANCE){let St=Math.max(1,It-p);Tt/St*1e3>=Z.DROP_SWIPE_MIN_SPEED&&(u="drop",m=0)}}}else{let Ct=Math.abs(Yt),Tt=Math.abs(wt);if(wt<0)Ct>=Z.DEADZONE_PX&&(u="rotate");else if(Tt>=Ct*Z.AXIS_DOMINANCE){if(Tt>=Z.DROP_SWIPE_MIN_DISTANCE){let St=Math.max(1,It-p);Tt/St*1e3>=Z.DROP_SWIPE_MIN_SPEED?u="drop":u="rotate"}}else Ct>=Tt*Z.AXIS_DOMINANCE&&(u="rotate");if(!u)return null}let R=null;if(u==="rotate"&&Math.abs(Yt)>=Z.DEADZONE_PX){let Ct=Math.max(1,It-P),Tt=G.clientX-b,St=Math.max(1,Math.abs(Tt)/Ct*1e3),a=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/St)));F+=-Tt/a*c*f;let at=Math.trunc(F);at!==0&&(F-=at);let J=g+at;if(J!==g&&pt.canRotateTo){let ue=Math.sign(J-g),K=r+g;for(;g!==J;){let q=g+ue,lt=r+q;if(!pt.canRotateTo(Math.floor(Zt),lt))break;g=q,K=lt,pt.onRotateStep&&pt.onRotateStep(),Ot&&pt.onGroundedMove&&pt.onGroundedMove()}R={targetRot:K,rotFloat:K}}}if(u==="drop"&&wt>=Z.DROP_SWIPE_MIN_DISTANCE&&pt.onDrop){let Ct=Math.max(1,It-P),Tt=G.clientY-O,St=Math.max(1,Tt/Ct*1e3),a=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/St))),at=Math.trunc(wt/a);if(at>m){let J=at-m;for(let ue=0;ue<J;ue++)pt.onDrop();m=at}}return b=G.clientX,O=G.clientY,P=It,R},handlePointerUp(G){if(l&&(l=!1,u=null,n&&G&&G.pointerId!==void 0))try{n.releasePointerCapture(G.pointerId)}catch{}},reset(){l=!1,u=null,g=0,m=0,F=0}}}var Ps={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Fo(){let e="intro",n=0,c=0,l=0,i=0,s=0,r={...Ps};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),l=0,i=0,s=0,r={...Ps}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(g){n+=g},setScore(g){n=g},updateTime(){e==="playing"&&c>0&&(l=performance.now()-c-s)},getFormattedTime(){let g=Math.floor(l/1e3),m=Math.floor(g/60),f=g%60;return`${m}:${f.toString().padStart(2,"0")}`},incrementStat(g,m=1){g in r&&(r[g]+=m)},updateMaxStat(g,m){g in r&&m>r[g]&&(r[g]=m)},reset(){e="intro",n=0,c=0,l=0,i=0,s=0,r={...Ps}}}}function An(e,n){return e%=n,e<0&&(e+=n),e}function $o(e,n){return e[Math.min(n,e.length-1)]}function fs(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),l=n%60;return`${c}:${l.toString().padStart(2,"0")}`}function No(e,n){let c=e.map(({x:g,y:m},f)=>({x:m,y:-g,color:n[f]})),l=1/0,i=-1/0,s=1/0;for(let g of c)l=Math.min(l,g.x),i=Math.max(i,g.x),s=Math.min(s,g.y);let r=Math.round((l+i)/2);for(let g of c)g.x-=r,g.y-=s;return c.sort((g,m)=>g.y-m.y||g.x-m.x),{cells:c.map(g=>({x:g.x,y:g.y})),colors:c.map(g=>g.color)}}function ks(e,n,c,l){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:An(n-1,l)}),i.push({y:e,s:An(n+1,l)}),i}function Go(e,n,c){let l=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||l[s][r])continue;let g=[],m=[{y:s,s:r}];for(l[s][r]=1;m.length>0;){let f=m.shift();g.push(f);for(let u of ks(f.y,f.s,n,c))e[u.y][u.s]&&!l[u.y][u.s]&&(l[u.y][u.s]=1,m.push(u))}i.push(g)}return i}function Uo(e){return e.some(n=>n.y===0)}function Os(e,n,c,l,i,s){if(!e)return!1;let r=An(c,s);for(let g of e.cells){let m=n+g.y,f=An(r+g.x,s);if(m<0)return!1;if(!(m>=i)&&l[m][f])return!1}return!0}function Xo(e,n,c,l,i,s){if(!e)return null;let r=Math.floor(n);for(;Os(e,r-1,c,l,i,s);)r-=1;return r}function Yo(e,n,c){let l=[],i=[];for(let s=0;s<n;s++){let r=[],g=0,m=e[s][0],f=m?1:0;for(let u=1;u<=c;u++){let p=u<c?e[s][u]:0;p&&p===m?f++:(f>=1&&m&&r.push({start:g,length:f,color:m}),g=u,m=p,f=p?1:0)}if(r.length>=2){let u=r[0],p=r[r.length-1];if(u.start===0&&p.start+p.length===c&&u.color===p.color){let b=u.length+p.length;r[0]={start:p.start,length:b,color:u.color},r.pop()}}for(let u of r)if(u.length>=3){let p=[];for(let b=0;b<u.length;b++)p.push({y:s,s:(u.start+b)%c});l.push({color:u.color,length:u.length,cells:p})}}for(let s=0;s<c;s++){let r=0,g=e[0][s],m=g?1:0;for(let f=1;f<=n;f++){let u=f<n?e[f][s]:0;if(u&&u===g)m++;else{if(m>=3&&g){let p=[];for(let b=0;b<m;b++)p.push({y:r+b,s});l.push({color:g,length:m,cells:p})}r=f,g=u,m=u?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let g=e[s][r],m=e[s][(r+1)%c],f=e[s][(r+2)%c],u=e[s][(r+3)%c];g&&g===m&&f&&f===u&&g!==f&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let g=e[r][s],m=e[r+1][s],f=e[r+2][s],u=e[r+3][s];g&&g===m&&f&&f===u&&g!==f&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:l,pairMatches:i}}function Wo(e,n,c){let l=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&l.push(i)}return l}function Vo(e,n){let c=new Map;e.forEach((l,i)=>c.set(`${l.x},${l.y}`,n[i]));for(let l=0;l<e.length;l++){let i=e[l],s=n[l],r=1;for(let ot=1;ot<=2&&c.get(`${i.x+ot},${i.y}`)===s;ot++)r++;if(r>=3)return!0;let g=1;for(let ot=1;ot<=2&&c.get(`${i.x},${i.y+ot}`)===s;ot++)g++;if(g>=3)return!0;let m=s,f=c.get(`${i.x+1},${i.y}`),u=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(m&&f&&u&&p&&m===f&&u===p&&m!==u)return!0;let b=s,O=c.get(`${i.x},${i.y+1}`),P=c.get(`${i.x},${i.y+2}`),F=c.get(`${i.x},${i.y+3}`);if(b&&O&&P&&F&&b===O&&P===F&&b!==P)return!0}return!1}function Ko(e){let{getN:n,getH:c,FALL_INTERVAL:l,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:g,RING_HIGHLIGHT_SEC:m,getState:f,setState:u,funcs:p,ui:b}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(O,P={}){let F=f();if(O==="start_game")return F.gameState!=="playing"?(p.startGame(),!0):!1;if(F.gameState!=="playing")return!1;switch(O){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:ot}=P;return typeof ot=="number"&&p.canPlaceAtRot(Math.floor(F.pieceY),ot)?(u({targetRot:ot,rotFloat:ot,rotVel:0}),F.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ot,y:ut}=P;return p.shootMagic(ot,ut)}case"select_magic":{let{element:ot}=P;return p.selectMagic(ot),!0}default:return console.warn("GameEngine: unknown command",O),!1}},update(O,P){let F=f();if(F.gameState!=="playing")return;let ot=P-F.startTime-F.totalPausedMs;u({elapsedMs:ot}),b.updateTimeHud();let ut=F.killLevel+s()*O;if(u({killLevel:ut}),b.updateRemainingHud(),ut>=c()){p.endGame();return}if(F.isHighlighting){let G=(P-F.highlightStartTime)/1e3,pt;F.isRingAnimation?pt=m:F.isMagicAnimation?pt=g:pt=r,G>=pt&&(F.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ce=F.fallTimer+O;if(ce>=l&&(ce-=l,p.tryMoveDown()),u({fallTimer:ce}),p.updateGroundedState()){let G=F.lockTimer+O;u({lockTimer:G}),G>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(O,P){return p.canPlaceAtRot(O,P)},getRotation(){let O=f();return{targetRot:O.targetRot,rotFloat:O.rotFloat,rotVel:O.rotVel}},setRotation(O){u({targetRot:O,rotFloat:O,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var Xe=Math.PI*2;function qo(e){let{canvas:n,canvasCtx:c,getN:l,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:g,MAX_RADIUS_X:m,RADIUS_X_FACTOR:f,ANG_OFFSET:u,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:b,MAGIC_SHRINK_SEC:O,RING_HIGHLIGHT_SEC:P,LOCK_DELAY_SEC:F,getKillRate:ot,ELEMENT_COLORS:ut,ELEMENT_TO_COLOR:ce,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:G,ACTIVE_COLOR_FRONT:pt,GHOST_COLOR_FILL:Zt,GHOST_COLOR_STROKE:Ot,GHOST_STROKE_WIDTH:Yt,MAGIC_DIM_DOT_ALPHA:wt,MAGIC_DIM_DOT_SCALE:It,MAGIC_TARGET_DOT_SCALE:R,getState:Ct,getVisualSettings:Tt,funcs:St}=e,a=c,at=l(),J=i(),ue={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},K=[],q=40;function lt(Y,D,L,x,B){let y=Math.max(3,Math.round(Y)),dt=180;for(let it=0;it<y;it++)setTimeout(()=>{let Lt=Math.random()>.5?"left":"right",vt=15,v=Lt==="left"?vt+Math.random()*Math.max(10,D-vt*2):L+vt+Math.random()*Math.max(10,B-L-vt*2),C=x-10;K.push({x:v,baseX:v,y:C,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:vt,maxX:B-vt})},it*dt)}function Kt(Y,D,L){K=K.filter(x=>x.y>Y+x.size&&x.y>-20);for(let x of K){x.y-=q*L,x.wobble+=x.wobbleSpeed*L;let B=x.baseX+Math.sin(x.wobble)*x.wobbleAmp;x.x=Math.max(x.minX,Math.min(x.maxX,B))}}function be(Y){if(K.length!==0){a.fillStyle="rgba(255, 255, 255, 0.3)",a.strokeStyle="rgba(255, 255, 255, 0.5)",a.lineWidth=1;for(let D of K)D.y<Y+D.size||(a.beginPath(),a.arc(D.x,D.y,D.size,0,Math.PI*2),a.fill(),a.stroke())}}let j={left:0,right:0,h:0,w:0};function tt(Y,D,L){let x=1-L/J;return Y+x*D}function nt(Y){return Y=Y%at,Y<0?Y+at:Y}function _t(Y,D,L,x,B,y){let dt=nt(y),it=(B-dt)/at*Xe+u;return{x:Y+Math.cos(it)*L,y:D+Math.sin(it)*x,ang:it}}let Nt=.52,fe=1.02;function Et(Y,D,L,x,B,y){let dt=nt(y),it=(B-dt)/at*Xe+u;return{x:Y+Math.cos(it)*L,y:D+Math.sin(it)*x,ang:it}}function Jt(Y,D,L,x,B,y,dt,it=1){let Lt=Et(Y,D,L,x,B-Nt,y),vt=Et(Y,D,L,x,B+Nt,y),v={x:Lt.x,y:Lt.y-dt*.5},C={x:Lt.x,y:Lt.y+dt*.5},w={x:vt.x,y:vt.y-dt*.5},ct={x:vt.x,y:vt.y+dt*.5},E=(v.x+w.x+ct.x+C.x)*.25,Wt=(v.y+w.y+ct.y+C.y)*.25,H=fe*it,Gt=it,re=[v,w,ct,C].map(un=>({x:E+(un.x-E)*H,y:Wt+(un.y-Wt)*Gt})),Dt=Math.abs((vt.x-Lt.x)*H),ge=Math.abs(dt*Gt);return{corners:re,cx:E,cy:Wt,wApprox:Dt,hApprox:ge,ang:Et(Y,D,L,x,B,y).ang}}function U(Y,D,L,x,B,y,dt,it,Lt=1,vt=null,v=1,C=null,w=0,ct=1,E=1){let Wt=Jt(Y,D,L,x,B,y,dt,E),[H,Gt,re,Dt]=Wt.corners;if(a.save(),a.globalAlpha=Lt,a.fillStyle=it,a.beginPath(),a.moveTo(H.x,H.y),a.lineTo(Gt.x,Gt.y),a.lineTo(re.x,re.y),a.lineTo(Dt.x,Dt.y),a.closePath(),a.fill(),C&&w>0&&(a.strokeStyle=C,a.lineWidth=w,a.stroke()),vt){let ge=Math.min(Wt.wApprox,Wt.hApprox)*.28*ct;a.globalAlpha=Lt*v,a.fillStyle=vt,a.beginPath(),a.arc(Wt.cx,Wt.cy,ge,0,Xe),a.fill()}a.restore(),a.globalAlpha=1}function te(Y,D,L,x,B,y){let dt=_t(Y,D,L,x,B,y),it=_t(Y,D,L,x,B+1,y),Lt=_t(Y,D,L,x,B-1,y),vt=Math.abs(it.x-dt.x),v=Math.abs(dt.x-Lt.x),C=(vt+v)*.5*1.06;return Math.max(1,C)}function Te(Y,D,L,x,B,y){let dt=(B-y)/at*Xe+u;return{x:Y+Math.cos(dt)*L,y:D+Math.sin(dt)*x,ang:dt}}function ee(Y,D,L,x,B,y,dt,it=1,Lt=null,vt=1,v=null,C=0,w=1){a.save(),a.translate(Y,D);let ct=Math.atan2(x,L);if(a.rotate(ct),a.globalAlpha=it,a.fillStyle=dt,a.fillRect(-B/2,-y/2,B,y),v&&C>0&&(a.strokeStyle=v,a.lineWidth=C,a.strokeRect(-B/2,-y/2,B,y)),Lt){let E=Math.min(B,y)*.28*w;a.globalAlpha=it*vt,a.fillStyle=Lt,a.beginPath(),a.arc(0,0,E,0,Xe),a.fill()}a.restore(),a.globalAlpha=1}return{resize(){let Y=Math.max(1,Math.min(2,window.devicePixelRatio||1)),D=Math.floor(n.clientWidth*Y),L=Math.floor(n.clientHeight*Y);(n.width!==D||n.height!==L)&&(n.width=D,n.height=L,a.setTransform(Y,0,0,Y,0,0))},render(Y=.016,D=performance.now()){this.resize();let L=Ct();at=l(),J=i();let x=n.clientWidth,B=n.clientHeight;a.clearRect(0,0,x,B),a.fillStyle="#0b0f14",a.fillRect(0,0,x,B);let y=x*.5,dt=(x-2*g)/2,it=B-s-r,Lt=6,vt=at*it/(Lt*J),v,C,w,ct;ct=B-r,vt<=Math.min(dt,m)?(v=vt,C=it,w=s):(v=Math.min(dt,m),C=v*Lt*J/at,w=ct-C);let E=v*.28,{killLevel:Wt,rotFloat:H,grid:Gt,gameState:re}=L,Dt=Tt?Tt():{},ge=Dt.waterColor||"blue",un=Dt.waterBubbles||!1,qt=ue[ge]||ue.blue,Vt=tt(w,C,Wt),Ye=.7,Pe=Wt/J,zt={...qt.top},Ut={...qt.bottom};if(Pe>Ye){let T=(Pe-Ye)/(1-Ye);zt.r=Math.round(zt.r+(255-zt.r)*T*.5),zt.g=Math.round(zt.g+(150-zt.g)*T*.5),zt.b=Math.round(zt.b+(150-zt.b)*T*.5),Ut.r=Math.round(Ut.r+(180-Ut.r)*T),Ut.g=Math.round(Ut.g*(1-T*.6)),Ut.b=Math.round(Ut.b*(1-T*.6))}let Fe=y-v-8,A=y+v+8,me=w,bt=ct+5,ne=a.createLinearGradient(0,Vt,0,B);ne.addColorStop(0,`rgba(${zt.r},${zt.g},${zt.b},0.5)`),ne.addColorStop(1,`rgba(${Ut.r},${Ut.g},${Ut.b},0.7)`),a.fillStyle=ne;let xn=Math.round((zt.r+Ut.r)/2),We=Math.round((zt.g+Ut.g)/2),fn=Math.round((zt.b+Ut.b)/2),yn=v+8,$e=E+4;a.fillRect(0,Vt,Fe,B-Vt),a.fillRect(A,Vt,x-A,B-Vt),a.beginPath();let gt=Math.max(Vt,bt);a.moveTo(Fe,gt),Vt<=bt+$e?a.ellipse(y,bt,yn,$e,0,Math.PI,0,!1):a.lineTo(A,gt),a.lineTo(A,B),a.lineTo(Fe,B),a.closePath(),a.fill(),a.strokeStyle="rgba(100,180,255,0.6)",a.lineWidth=3,a.lineCap="round",a.beginPath(),a.moveTo(Fe,me),a.lineTo(Fe,bt),a.stroke(),a.beginPath(),a.moveTo(A,me),a.lineTo(A,bt),a.stroke(),a.beginPath(),a.ellipse(y,bt,v+8,E+4,0,0,Math.PI),a.stroke(),a.fillStyle="#0b0f14",a.beginPath(),a.ellipse(y,bt,v+8,E+4,0,0,Xe),a.fill(),Wt>.5&&(a.strokeStyle=`rgba(${Math.min(255,xn+60)},${Math.min(255,We+40)},${Math.min(255,fn+40)},0.6)`,a.lineWidth=2,a.beginPath(),a.moveTo(0,Vt),a.lineTo(Fe,Vt),a.moveTo(A,Vt),a.lineTo(x,Vt),a.stroke()),j={left:Fe,right:A,h:B,w:x},(K.length>0||un)&&(Kt(Vt,B,Y),be(Vt)),a.strokeStyle="rgba(160,190,220,0.3)",a.lineWidth=1;let se=Xe*v,Sn=10,Xn=se/Sn*.7,gn=se/Sn*.3;a.setLineDash([Xn,gn]);let ae=se/at;a.lineDashOffset=nt(H)*ae;for(let T=0;T<=J;T++){let k=tt(w,C,T);a.beginPath(),a.ellipse(y,k,v,E,0,0,Xe),a.stroke()}a.setLineDash([]);let mn=[],h=[];for(let T=0;T<J;T++){let k=tt(w,C,T+.5);for(let Q=0;Q<at;Q++){let X=Gt[T][Q];if(!X)continue;let z=_t(y,k,v,E,Q,H),V=Math.sin(z.ang),$={y:T,s:Q,yScr:k,p:z,depth:V,color:X};V<-.1?mn.push($):h.push($)}}let I=St.getMagicTargetColor(),{isHighlighting:M,highlightedCells:et,highlightStartTime:Pt,isMagicAnimation:kt}=L,jt=null,_e=1,pe=1,Qe=!1;if(M&&et.length>0){jt=new Set(et.map(k=>`${k.y},${k.s}`));let T=(performance.now()-Pt)/1e3;if(kt){let k=Math.min(1,T/O);_e=1-k*.85,pe=1-k*.9,Qe=!0}else{let k=Math.min(1,T/p),Q=1-b;if(k>Q){let X=(k-Q)/b;_e=1-X*.85,pe=1-X*.9,Qe=!0}}}mn.sort((T,k)=>T.depth-k.depth);for(let T of mn){let k=C/J*.9,Q=ut[T.color]||null,X=.35,z=1,V=`${T.y},${T.s}`;jt&&jt.has(V)&&(X*=pe,z=_e),U(y,T.yScr,v,E,T.s,H,k,G,X,Q,.5,null,0,1,z)}let{isRingAnimation:he}=L;if(M&&et.length>0&&!kt){let T=(performance.now()-Pt)/1e3,Q=Math.min(1,T/(he?P:p)),X=1-b,z=Q>X,V=z?(Q-X)/b:0,$=he?Math.floor(Q*X*at*2)%at:-1,_=4+Q/X*10,W=Math.sin(T*_*Xe),ft=z?1:.3+W*.3,ht=z?1-V*.8:1,Bt=z?1-V:1;for(let yt of et){let Rt=tt(w,C,yt.y+.5),oe=Et(y,Rt,v,E,yt.s,H);if(Math.sin(oe.ang)>=-.1)continue;let cn=C/J*.9,xe,De,Ae;if(he){let Ht=(yt.s-$+at)%at,rn=Ht<3?1-Ht/3:0;xe=(z?Bt:.2+rn*.5)*.5,De=`rgba(255, 159, 67, ${xe})`,Ae=z?ht:1+rn*.15}else xe=ft*Bt,De=yt.isLine?`rgba(255, 255, 255, ${xe*.5})`:`rgba(255, 220, 100, ${xe*.4})`,Ae=z?ht:1.1;U(y,Rt,v,E,yt.s,H,cn,De,1,null,1,null,0,1,Ae)}}h.sort((T,k)=>T.depth-k.depth);for(let T of h){let k=C/J*.9,Q=ut[T.color]||null,X=1,z=1,V=1,$=1,_=`${T.y},${T.s}`,W=jt&&jt.has(_);W&&(X=pe,z=_e),I!==null&&!W&&(T.color!==I?(V=wt,$=It):$=R),U(y,T.yScr,v,E,T.s,H,k,Z,X,Q,V,null,0,$,z)}if(M&&et.length>0&&!kt){let T=(performance.now()-Pt)/1e3,Q=Math.min(1,T/(he?P:p)),X=1-b,z=Q>X,V=z?(Q-X)/b:0,$=he?Math.floor(Q*X*at*2)%at:-1,_=4+Q/X*10,W=Math.sin(T*_*Xe),ft=z?1:.5+W*.5,ht=z?1-V*.8:1,Bt=z?1-V:1;for(let yt of et){let Rt=tt(w,C,yt.y+.5),oe=Et(y,Rt,v,E,yt.s,H);if(Math.sin(oe.ang)<-.1)continue;let cn=C/J*.9,xe,De,Ae;if(he){let Ht=(yt.s-$+at)%at,rn=Ht<4?1-Ht/4:0;xe=z?Bt:.3+rn*.7,De=`rgba(255, 159, 67, ${xe})`,Ae=z?ht:1+rn*.2}else xe=ft*Bt,De=yt.isLine?`rgba(255, 255, 255, ${xe*.7})`:`rgba(255, 220, 100, ${xe*.6})`,Ae=z?ht:1.15;U(y,Rt,v,E,yt.s,H,cn,De,1,null,1,null,0,1,Ae)}}let Le=L.spellState||L,{transmuteState:Me,transmuteSourceBlock:ve,transmuteTargetColor:Ve,transmuteAreaCells:Ke,transmuteBlocksToChange:Be}=Le;if(Me==="selecting_source"){let T=C/J*.9,k=.35+Math.sin(D/150)*.15;for(let Q of h){let X=tt(w,C,Q.y+.5);U(y,X,v,E,Q.s,H,T,`rgba(0, 40, 20, ${k})`,1,null,1,null,0,1,1)}}if(Me==="selecting_target"&&Be&&Be.length>0){let T=C/J*.9,k=.4+Math.sin(D/120)*.25,Q=.6+Math.sin(D/120)*.4;for(let X of Be){if(X.y<0||X.y>=J)continue;let z=tt(w,C,X.y+.5),V=Et(y,z,v,E,X.s,H);Math.sin(V.ang)<-.1||(U(y,z,v,E,X.s,H,T,`rgba(0, 50, 30, ${k})`,1,null,1,null,0,1,1),U(y,z,v,E,X.s,H,T,"transparent",1,null,1,`rgba(100, 255, 150, ${Q})`,3,1,1.02))}}if(Me==="animating"&&St.getTransmuteAnimState){let T=St.getTransmuteAnimState(D);if(T){let k=C/J*.9,{phase:Q,progress:X,areaFlash:z}=T;if(z>0&&Ke)for(let V of Ke){if(V.y<0||V.y>=J)continue;let $=tt(w,C,V.y+.5),_=Et(y,$,v,E,V.s,H);Math.sin(_.ang)<-.1||U(y,$,v,E,V.s,H,k,`rgba(150, 255, 200, ${z*.4})`,1,null,1,null,0,1,1)}if(Be&&Be.length>0){let V=ve?ve.color:1,$=Ve||1;for(let _ of Be){if(_.y<0||_.y>=J)continue;let W=tt(w,C,_.y+.5),ft=Et(y,W,v,E,_.s,H);if(Math.sin(ft.ang)<-.1)continue;let Bt=1,yt=ut[V],Rt=0;if(Q==="shrink"?(Bt=1-X*.95,yt=ut[V],Rt=.5+X*.3):Q==="grow"&&(Bt=X,yt=ut[$],Rt=.8-X*.5),Rt>0&&U(y,W,v,E,_.s,H,k,`rgba(200, 255, 220, ${Rt})`,1,null,1,null,0,1,1),Bt>.05){let oe=Jt(y,W,v,E,_.s,H,k,1),on=Math.min(oe.wApprox,oe.hApprox)*.28*Bt;a.save(),a.globalAlpha=1,a.fillStyle=yt,a.beginPath(),a.arc(oe.cx,oe.cy,on,0,Xe),a.fill(),a.restore()}}}}}let{lightningState:qe,lightningSourceBlock:En,lightningAreaCells:nn,lightningBlocksToHit:Qt}=Le;if(qe==="selecting_source"){let T=C/J*.9,k=.35+Math.sin(D/150)*.15;for(let Q of h){let X=tt(w,C,Q.y+.5);U(y,X,v,E,Q.s,H,T,`rgba(20, 20, 60, ${k})`,1,null,1,null,0,1,1)}}if(qe==="animating"&&St.getLightningAnimState){let T=St.getLightningAnimState(D);if(T&&Qt&&Qt.length>0){let k=C/J*.9,{phase:Q,flashProgress:X,currentTarget:z,jumpProgress:V,struckTargets:$}=T;if(Q==="flash"&&X>0&&nn)for(let _ of nn){if(_.y<0||_.y>=J)continue;let W=tt(w,C,_.y+.5),ft=Et(y,W,v,E,_.s,H);Math.sin(ft.ang)<-.1||U(y,W,v,E,_.s,H,k,`rgba(100, 150, 255, ${X*.5})`,1,null,1,null,0,1,1)}if($&&$.length>0)for(let _ of $){let W=Qt[_];if(!W||W.y<0||W.y>=J)continue;let ft=tt(w,C,W.y+.5),ht=Et(y,ft,v,E,W.s,H);if(Math.sin(ht.ang)<-.1)continue;let yt=($.length-1-$.indexOf(_))*.1,Rt=Math.max(0,.8-yt);U(y,ft,v,E,W.s,H,k,`rgba(255, 255, 255, ${Rt})`,1,null,1,`rgba(150, 200, 255, ${Rt})`,2,1,1.05)}if(Q==="chain"&&z>=0&&z<Qt.length){let _=Qt[z];if(_&&_.y>=0&&_.y<J){let W=tt(w,C,_.y+.5),ft=Et(y,W,v,E,_.s,H);if(Math.sin(ft.ang)>=-.1){let Bt=1-V;U(y,W,v,E,_.s,H,k,`rgba(200, 220, 255, ${Bt*.9})`,1,null,1,`rgba(100, 180, 255, ${Bt})`,3,1,1.1-V*.05)}}if(z>0){let W=Qt[z-1],ft=Qt[z];if(W&&ft){let ht=tt(w,C,W.y+.5),Bt=tt(w,C,ft.y+.5),yt=Jt(y,ht,v,E,W.s,H,k,1),Rt=Jt(y,Bt,v,E,ft.s,H,k,1);a.save(),a.strokeStyle=`rgba(150, 200, 255, ${1-V*.5})`,a.lineWidth=2+(1-V)*2,a.lineCap="round",a.beginPath();let oe=yt.cx,on=yt.cy,cn=Rt.cx,xe=Rt.cy;a.moveTo(oe,on);let De=4;for(let Ae=1;Ae<=De;Ae++){let Ht=Ae/De,rn=oe+(cn-oe)*Ht,gs=on+(xe-on)*Ht,rt=Ae<De?(Math.random()-.5)*8:0;a.lineTo(rn+rt,gs+rt)}a.stroke(),a.strokeStyle=`rgba(100, 150, 255, ${(1-V)*.3})`,a.lineWidth=6,a.stroke(),a.restore()}}}}}let{fireState:pn,fireSourceBlock:ke,fireLineCells:Oe,fireTargets:sn}=Le;if(pn==="selecting_source"){let T=C/J*.9,k=.3+Math.sin(D/140)*.2;for(let Q of h){let X=tt(w,C,Q.y+.5);U(y,X,v,E,Q.s,H,T,`rgba(70, 25, 10, ${k})`,1,null,1,null,0,1,1)}}if(pn==="animating"&&St.getFireAnimState){let T=St.getFireAnimState(D);if(T&&Oe&&Oe.length>0){let k=C/J*.9,{progress:Q,flashProgress:X}=T,z=Math.sin(Q*Math.PI);if(X>0)for(let V of Oe){if(V.y<0||V.y>=J)continue;let $=tt(w,C,V.y+.5),_=Et(y,$,v,E,V.s,H);Math.sin(_.ang)<-.1||U(y,$,v,E,V.s,H,k,`rgba(255, 120, 50, ${X*.45})`,1,null,1,`rgba(255, 200, 140, ${X*.5})`,2,1,1.03)}if(ke){let V=new Map;for(let _ of Oe){if(_.y<0||_.y>=J)continue;let W=tt(w,C,_.y+.5),ft=Et(y,W,v,E,_.s,H);if(Math.sin(ft.ang)<-.1)continue;let Bt=Jt(y,W,v,E,_.s,H,k,1),yt=_.s-ke.s;yt>at/2&&(yt-=at),yt<-at/2&&(yt+=at);let Rt=_.y;V.has(Rt)||V.set(Rt,[]),V.get(Rt).push({x:Bt.cx,y:Bt.cy,offset:yt})}let $=Array.from(V.keys()).sort((_,W)=>W-_);if($.length>0){let _=.35+.3*Math.sin(D/60)+z*.2;a.save(),a.lineCap="round";for(let W of $){let ft=V.get(W)||[];if(ft.sort((ht,Bt)=>ht.offset-Bt.offset),ft.length!==0){a.beginPath(),a.moveTo(ft[0].x,ft[0].y);for(let ht=1;ht<ft.length;ht++)a.lineTo(ft[ht].x,ft[ht].y);a.strokeStyle=`rgba(255, 140, 60, ${_})`,a.lineWidth=Math.max(2,k*.15),a.stroke(),a.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,a.lineWidth=Math.max(6,k*.35),a.stroke()}}a.restore()}}if(sn&&sn.length>0){let V=.2+z*.6;for(let $ of sn){if($.y<0||$.y>=J)continue;let _=tt(w,C,$.y+.5),W=Et(y,_,v,E,$.s,H);Math.sin(W.ang)<-.1||U(y,_,v,E,$.s,H,k,`rgba(255, 160, 70, ${V})`,1,null,1,`rgba(255, 230, 180, ${z*.6})`,2,1,1.05)}}}}let{activePiece:le,pieceY:bn,isGrounded:Re,lockTimer:de}=L;if(le){let T=St.snappedRot(),k=T,Q=St.computeGhostY(),X=C/J*.9;if(Q!==null){let $=[];for(let _=0;_<le.cells.length;_++){let W=le.cells[_],ft=le.colors[_],ht=Q+W.y,Bt=St.normSector(T+W.x);if(ht<0||ht>=J)continue;let yt=tt(w,C,ht+.5),Rt=Et(y,yt,v,E,Bt,k);$.push({cy:ht,cs:Bt,yScr:yt,depth:Math.sin(Rt.ang),color:ft})}$.sort((_,W)=>_.depth-W.depth);for(let _ of $){let W=ut[_.color]||null;U(y,_.yScr,v,E,_.cs,k,X,Zt,1,W,.5,Ot,Yt,1,1)}}let z=pt;if(Re&&de>0){let $=Math.min(1,de/F),_=255,W=Math.round(170+85*$),ft=Math.round(180+75*$),ht=.75+(1-.75)*$;z=`rgba(${_},${W},${ft},${ht})`}let V=[];for(let $=0;$<le.cells.length;$++){let _=le.cells[$],W=le.colors[$],ft=St.normSector(T+_.x),ht=bn+_.y;if(ht<0||ht>=J)continue;let Bt=tt(w,C,ht+.5),yt=Et(y,Bt,v,E,ft,k);V.push({cs:ft,yScr:Bt,depth:Math.sin(yt.ang),color:W})}V.sort(($,_)=>$.depth-_.depth);for(let $ of V){let _=ut[$.color]||null;U(y,$.yScr,v,E,$.cs,k,X,z,1,_,1,null,0,1,1)}}},drawNextPreview(Y,D){if(!Y)return;let L=Y.getContext("2d"),x=Y.width,B=Y.height;if(L.clearRect(0,0,x,B),!D)return;let y=1/0,dt=-1/0,it=1/0,Lt=-1/0;for(let E of D.cells)y=Math.min(y,E.x),dt=Math.max(dt,E.x),it=Math.min(it,E.y),Lt=Math.max(Lt,E.y);let vt=dt-y+1,v=Lt-it+1,C=Math.min(x/(vt+.5),B/(v+.5)),w=(x-vt*C)/2,ct=(B-v*C)/2;L.fillStyle=Z;for(let E=0;E<D.cells.length;E++){let Wt=D.cells[E],H=w+(Wt.x-y)*C,Gt=ct+(v-1-(Wt.y-it))*C;L.fillRect(H+1,Gt+1,C-2,C-2);let re=D.colors[E],Dt=ut[re];if(Dt){let ge=(C-2)*.32;L.fillStyle=Dt,L.beginPath(),L.arc(H+C/2,Gt+C/2,ge,0,Xe),L.fill(),L.fillStyle=Z}}},spawnBonusBubbles(Y){let{left:D,right:L,h:x,w:B}=j;B>0&&lt(Y,D,L,x,B)}}}(()=>{let e=_o(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,i=30,s=24,r=120,g={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let o=g[t]||g["30_24"];i=o.N,s=o.H,r=o.survivalTime}function f(){return s/r}let u=Math.PI/2,p=70,b=120,O=30,P=320,F=.42,ot="rgb(235,240,250)",ut="rgb(55,62,75)",ce="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",G="rgba(110,255,150,0.85)",pt=2,Zt={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Ot={1:"fire",2:"water",3:"lightning",4:"earth"},Yt={fire:1,water:2,lightning:3,earth:4},wt=1,It=.58,R=!0,Ct=12,Tt=25,St=1,a=2,at=3,J=1,ue=5,K=7,q=10,lt=3,Kt=50,be=2,j=.3,tt=.5,nt=1,_t=.3,Nt=.5,fe=1.3,Et=10,Jt=1e3,U=[1,1.25,1.5,1.75,2],te=10,Te=20,ee=5,Y=[1,1.3,1.6,2],D=[1,1.5,2,2.5,3,3.5],L=[1,1.3,1.6,2,2.4,2.8],x=To(),B=x.loadGameSettings();B.hapticsEnabled===void 0&&(B.hapticsEnabled=!0);let y=B.invertSwipe?-1:1,it=!1,Lt=-1,vt=Io({enabled:B.hapticsEnabled}),v=Array.from({length:s},()=>new Uint8Array(i));function C(){v=Array.from({length:s},()=>new Uint8Array(i))}let w=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],ct=null,E=s+3,Wt=0,H=0,Gt=!1,re=0,Dt=0,ge=0,un=3,qt=0,Vt=0,Ye=0,Pe=Ho({canvas:n,rotDir:y}),zt="0.17.0",Ut=!0,Fe="blue",A=Eo();A.preload();let me=Fo(),bt="intro",ne=0,xn=0,We=0,fn=0,yn=0,$e=null,gt=me.stats,se=0,Sn=e.overlay,Xn=e.gameContainer,gn=Bo({elementColors:Zt}),ae=gn.showBonus.bind(gn),mn=gn.getElementIcon.bind(gn),h=Ro(),I=e.overlayTitle,M=e.overlayStats,et=e.startBtn,Pt=e.hud,kt=e.scoreHud,jt=e.timeHud,_e=e.remainingHud,pe=e.nextCanvas,Qe=pe.getContext("2d"),he=e.pauseBtn,Le=e.pauseOverlay,Me=e.resumeBtn,ve=e.restartBtn,Ve=e.exitToMenuBtn,Ke=e.pauseSettingsBtn,Be=e.pauseSoundBtn,qe=e.pauseMusicBtn,En=e.pauseBestScore,nn=e.pauseBestTime,Qt=e.pauseBestMode,pn=e.pauseCurrentScore,ke=e.pauseCurrentTime,Oe=e.pauseCurrentMode,sn=e.confirmDialog,le=e.confirmText,bn=e.confirmCancel,Re=e.confirmOk,de=e.settingsOverlay,T=e.settingsClose,k=e.fullscreenBtn,Q=e.rotateBtn,X=e.startPanel,z=e.gameoverPanel,V=e.goScore,$=e.goTime,_=e.goRing,W=e.goMatches,ft=e.goBonuses,ht=e.goNewRecord,Bt=e.goRestartBtn,yt=e.goExitBtn,Rt=e.bestScore,oe=e.bestTimeVal,on=e.startVersion,cn=e.modeBtns,xe=e.recordsBtn,De=e.startSettingsBtn,Ae=e.helpBtn;wo({helpBtn:Ae});let Ht="25_20";function rn(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function gs(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let d=o.dataset.mode,S=g[d];if(!S)return;let N=o.querySelector(".mode-tag.time-tag");if(!N)return;let st=rn(S.survivalTime);st&&(N.textContent=st)})}gs();let rt=Po({buttons:e.magicBtns,onActivate:()=>A.play("spells"),onChange:(t,o)=>{hs()}}),wn=e.magicBtns,tc=rt.charges,zo=t=>He()?rt.select(t):!1,In=()=>rt.updateButtons(),Ds=e.magicRow,Xt=e.magicActiveIndicator,Hs=e.magicActiveIcon,Fs=e.magicActiveCost,jo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ms={fire:"fire",water:"ice",lightning:"air",earth:"earth"},Qo=["ice","earth","air","fire"];se=x.loadHighTowerRings();function Pn(t){return typeof ye?.getUnlockRings=="function"?ye.getUnlockRings(t):0}function Yn(t){let o=Pn(t);return o===0||se>=o}let $s=["fire","water","lightning","earth"],Cn=null,Wn=!1,Zo=500,Jo=30,ti=220,Tn=null,ps=null,Ns={fire:!1,water:!1,lightning:!1,earth:!1};function Gs(){if(!Xt)return;let t=Xt.getBoundingClientRect();t.width>0&&t.height>0&&(ps=t)}function ei(){if(!Xt)return null;let t=Xt.getBoundingClientRect();return t.width>0&&t.height>0?Xt:ps?{getBoundingClientRect:()=>ps}:null}function kn(t=rt.active){if(!Xt||!Hs)return;t?(Cn=t,Wn=!1):Wn||(Cn=null);let o=Cn;if(!o||!He()||(rt.charges[o]??0)<=0){Gs(),Xt.classList.add("hidden"),Xt.classList.remove("active","ult-ready",...$s),Xt.style.setProperty("--progress","0%"),Tn&&clearTimeout(Tn),Tn=setTimeout(()=>{Xt.classList.add("gone")},ti);return}Tn&&(clearTimeout(Tn),Tn=null),Xt.classList.remove("gone"),Xt.classList.contains("hidden")?requestAnimationFrame(()=>Xt.classList.remove("hidden")):Xt.classList.remove("hidden"),Hs.textContent=mn(o);let S=ms[o];S&&ye.selectSpell(S);let N=S?Dn(S):0,st=rt.charges[o]??0,mt=!!S&&qn()&&Yn(S),ie=!!S&&qn()&&!mt,we=mt&&N>0?Math.min(st/N,1):0,en=mt&&N>0,Ge=en&&st>=N;Fs&&(Fs.textContent=en?`-${N}`:ie?"\u{1F512}":""),Xt.classList.toggle("no-cost",!en&&!ie),Xt.classList.toggle("locked",ie),Xt.classList.toggle("ult-ready",Ge),Xt.style.setProperty("--progress",`${Math.round(we*100)}%`),Xt.classList.remove("hidden",...$s),Xt.classList.add("active",o),Gs()}function ni(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Zo))}function Vn(){for(let[t,o]of Object.entries(wn)){if(!o)continue;let d=ms[t],S=Dn(d),N=qn()&&He()&&d,st=typeof Yn=="function"?Yn(d):!0,mt=N&&st&&S>0&&(rt.charges[t]??0)>=S;o.classList.toggle("ult-ready",mt),mt&&!Ns[t]&&(ni(o),bt==="playing"&&A.play("readysuper")),Ns[t]=mt}}function He(t=Ht){return t==="30_24"?!0:it}function hs(){kn(rt.active),Vn()}function ec(t){it=t,Ht==="25_20"&&(it?rt.reset():(rt.deactivate(),Object.keys(rt.charges).forEach(o=>{rt.charges[o]=0})),In()),Kn(),hs()}function Kn(){Ds&&(Ds.style.display=He()?"":"none",kn(rt.active),Vn())}function nc(t){let o=_n(t),d=Dn(t);return!o||d<=0?!1:rt.charges[o]>=d}function sc(t){let o=_n(t),d=Dn(t);return!o||d<=0||rt.charges[o]<d?!1:(rt.charges[o]-=d,rt.updateButtons(),ye.pulse(),!0)}let On=e.spellWave;function si(){On&&(On.classList.remove("active"),On.offsetWidth,On.classList.add("active"),setTimeout(()=>On.classList.remove("active"),1200))}let an=null,ye=ko({button:Xt,onReady:()=>{A.play("readysuper")}}),oi=()=>ye.getEffect("earth"),ii=()=>ye.getEffect("air"),ci=()=>ye.getEffect("fire"),Dn=t=>typeof ye?.getCost=="function"?ye.getCost(t):0,_n=t=>jo[t]??null;an=Do({canvas:n,dom:e,getGrid:()=>v,getN:()=>i,getH:()=>s,getRotFloat:()=>qt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:O,MAX_RADIUS_X:P,SCORE_MAGIC_DESTROY:ee},helpers:{normSector:ts,levelYToScreenY:jn,sectorCenterXY:Qn},Spell:ye,Magic:rt,SoundModule:A,State:me,isGamePlaying:()=>bt==="playing",addPendingKzDrop:t=>{ge+=t},getKillRate:f,triggerSpellWave:si,spawnSpellBubbles:t=>{let o=_n(ye.currentSpell)??"water";h.spawnSpellBubbles(ye.button,o,t)},spawnBonusBubbles:t=>{Rn.spawnBonusBubbles(t)},getTransmuteEffect:oi,getLightningEffect:ii,getFireEffect:ci,continueMatchProcessing:Jn,updateScoreHud:$n,showBonus:ae,getSpellCost:Dn,getSpellElement:_n,onUltimateApplied:t=>{let o=_n(t)??_n(ye.currentSpell)??"water";if(typeof h?.spawnSpellBubbles=="function"){let d=ei();d&&h.spawnSpellBubbles(d,o,Jo)}Wn=!1,Cn=null,kn(null),Vn()},isSpellBlocked:ri,setScore:t=>{ne=t},setCascadeLevel:t=>{tn=t}});function qn(){return Ht==="30_24"}function zn(){kn(rt.active),Vn()}let ln=[],Hn=0,Ze=!1,hn=!1,Ln=!1,Ne=0,Je=0,tn=0,Bn=[];function ri(){return Ze||hn||Ln}function jn(t,o,d){let S=1-d/s;return t+S*o}function Qn(t,o,d,S,N,st){let mt=(N-st)/i*l+u;return{x:t+Math.cos(mt)*d,y:o+Math.sin(mt)*S,ang:mt}}function Us(t,o){let d=n.clientWidth,S=n.clientHeight,N=d*.5,st=(d-2*O)/2,mt=S-p-b,ie=6,we=i*mt/(ie*s),en=S-b,Ge,Ce,$t;we<=Math.min(st,P)?(Ge=we,Ce=mt,$t=p):(Ge=Math.min(st,P),Ce=Ge*ie*s/i,$t=en-Ce);let Mt=Ge*.28,At=jn($t,Ce,t+.5),xt=Qn(N,At,Ge,Mt,o,qt),Ie=n.getBoundingClientRect();return{x:Ie.left+xt.x,y:Ie.top+xt.y}}function ai(t,o){if(!He()||!rt.canUse()||Ze)return!1;let d=Yt[rt.active],S=n.clientWidth,N=n.clientHeight,st=S*.5,mt=(S-2*O)/2,ie=N-p-b,we=6,en=i*ie/(we*s),Ge=N-b,Ce,$t,Mt;en<=Math.min(mt,P)?(Ce=en,$t=ie,Mt=p):(Ce=Math.min(mt,P),$t=Ce*we*s/i,Mt=Ge-$t);let At=Ce*.28,xt=null,Ie=1/0;for(let Se=0;Se<s;Se++){let Ue=jn(Mt,$t,Se+.5);for(let Ee=0;Ee<i;Ee++){let ze=v[Se][Ee];if(!ze||ze!==d)continue;let Un=Qn(st,Ue,Ce,At,Ee,qt);if(Math.sin(Un.ang)<-.1)continue;let ls=t-Un.x,po=o-Un.y,ho=Math.hypot(ls,po),vo=$t/s*.9,Fi=vo*1.2;Math.abs(ls)<Fi/2&&Math.abs(po)<vo/2&&ho<Ie&&(Ie=ho,xt={y:Se,s:Ee})}}if(xt){let Se=jn(Mt,$t,xt.y+.5),Ue=Qn(st,Se,Ce,At,xt.s,qt),Ee=n.getBoundingClientRect(),ze=Ee.left+Ue.x,Un=Ee.top+Ue.y,mo=wn[rt.active];return h.spawnMagicShot(rt.active,mo,ze,Un,()=>{let ls=v[xt.y][xt.s];ln=[{y:xt.y,s:xt.s,color:ls,isLine:!1,isMagic:!0}],Hn=performance.now(),Ze=!0,hn=!0,Ne=0,Je=ee,ae(`+${ee}`,"score")}),tn=0,rt.useCharge(),gt.magicUsed++,!0}return!1}let oc=100;function ic(t,o){return ks(t,o,s,i)}function li(){return Go(v,s,i)}let di=Uo;function ui(t){let o=t.map(S=>({...S,color:v[S.y][S.s]}));for(let S of t)v[S.y][S.s]=0;let d=s;for(let S of t){let N=S.y;for(let st=1;st<=S.y;st++){let mt=S.y-st;if(v[mt][S.s]){N=st-1;break}}d=Math.min(d,N)}for(let S of o)v[S.y-d][S.s]=S.color;return d>0}function fi(){let t=!0;for(;t;){t=!1;let o=li();for(let d of o)di(d)||ui(d)&&(t=!0)}}function gi(){Jn()}let Zn=$o;function Xs(t,o){let d=new Map,S=0,N=0,st=0,mt={},ie=t.length+o.length;for(let Mt of t){let At=Ot[Mt.color],xt=0,Ie=0;if(Mt.length>=5?(xt=at,Ie=q,gt.lines5++):Mt.length===4?(xt=a,Ie=K,gt.lines4++):Mt.length===3&&(xt=St,Ie=ue,gt.lines3++),He()&&At&&xt>0){rt.addCharges(At,xt),mt[At]=(mt[At]||0)+xt;let Se=Mt.cells[Math.floor(Mt.cells.length/2)],Ue=Us(Se.y,Se.s),Ee=wn[At];for(let ze=0;ze<xt;ze++)setTimeout(()=>{h.spawnMagicOrb(At,Ue.x,Ue.y,Ee)},ze*100)}S+=Ie*f(),st+=Ie,N+=Mt.length*te;for(let Se of Mt.cells){let Ue=`${Se.y},${Se.s}`;d.has(Ue)||d.set(Ue,{y:Se.y,s:Se.s,color:Mt.color,isLine:!0})}}for(let Mt of o){if(gt.pairs++,S+=lt*f(),st+=lt,N+=Te,He()){let At=[...new Set(Mt.cells.map(xt=>v[xt.y][xt.s]).filter(Boolean))];if(At.length>0){let xt=Mt.cells[Math.floor(Mt.cells.length/2)],Ie=Us(xt.y,xt.s);At.forEach((Se,Ue)=>{let Ee=Ot[Se];if(!Ee)return;rt.addCharges(Ee,J),mt[Ee]=(mt[Ee]||0)+J;let ze=wn[Ee];ze&&setTimeout(()=>{h.spawnMagicOrb(Ee,Ie.x,Ie.y,ze)},Ue*100)})}}for(let At of Mt.cells){let xt=`${At.y},${At.s}`;d.has(xt)||d.set(xt,{y:At.y,s:At.s,color:v[At.y][At.s],isLine:!1})}}let we=Zn(Y,ie-1),en=Zn(D,tn),Ge=Zn(L,tn),Ce=Math.round(N*we*en);st=Math.round(st*Ge),S=Math.round(S*Ge);let $t=0;ie>1&&(gt.combos++,gt.maxCombo=Math.max(gt.maxCombo,ie),setTimeout(()=>ae(`COMBO \xD7${ie}`,"combo"),$t),$t+=180,A.play("combo2")),tn>0&&(gt.cascades++,gt.maxCascade=Math.max(gt.maxCascade,tn),setTimeout(()=>ae(`CASCADE \xD7${tn}`,"cascade"),$t),$t+=180,A.play("cascade")),(t.length>0||o.length>0)&&A.play("combo");for(let Mt of t){let At=Mt.length,xt=At*te;setTimeout(()=>ae(`Line-${At} +${xt}`,"line",Mt.color),$t),$t+=100}for(let Mt of o){let At=Mt.cells.length>0?v[Mt.cells[0].y][Mt.cells[0].s]:null;setTimeout(()=>ae(`Pair +${Te}`,"pair",At),$t),$t+=100}Ce>0&&(setTimeout(()=>ae(`+${Ce}`,"score"),$t),$t+=120),st>0&&(setTimeout(()=>ae(`+${st}s`,"time"),$t),$t+=120);for(let[Mt,At]of Object.entries(mt))At>0&&(setTimeout(()=>ae(`+${At}${mn(Mt)}`,"charge"),$t),$t+=120);ln=Array.from(d.values()),Hn=performance.now(),Ze=!0,hn=!1,Ne=S,Je=Ce,In()}function mi(){for(let t of ln)v[t.y][t.s]=0;if(ln.length>0&&A.playRandom("disappear"),Ne>0){ge+=Ne;let t=Ne/f();Rn.spawnBonusBubbles(t)}me.addScore(Je),ne+=Je,$n(),ln=[],Ze=!1,hn=!1,Ne=0,Je=0,tn++,Jn()}function Jn(){fi();let{lineMatches:t,pairMatches:o}=Ci();if(t.length>0||o.length>0)Xs(t,o);else{let d=zs();d.length>0?bi(d):!ct&&bt==="playing"&&qs()}}function cc(t,o){Xs(t,o)}function ts(t){return An(t,i)}function es(){return ts(Math.round(qt))}function Ys(t,o){return Os(ct,t,o,v,s,i)}function ns(t){return Ys(t,es())}let ss=No;function Ws(){R&&(Ct!==0&&re>=Ct||(H=0,re+=1))}function pi(){if(!ct)return;let t=ct.cells,o=ct.colors,d={cells:t,colors:o};if(Lt>=0||(d=ss(d.cells,d.colors),d=ss(d.cells,d.colors)),d=ss(d.cells,d.colors),ct.cells=d.cells,ct.colors=d.colors,!ns(Math.floor(E))){ct.cells=t,ct.colors=o;return}A.play("turn"),Gt&&Ws()}function hi(){return Xo(ct,E,es(),v,s,i)}function vi(){if(!ct)return!1;let t=Math.floor(E)-1,o=!ns(t);return o&&!Gt?(Gt=!0,H=0,re=0):!o&&Gt&&(Gt=!1,H=0,re=0),o}let Mn=fs;function Fn(){if(bt==="playing"){Sn.classList.add("hidden"),he.classList.remove("hidden");return}if(Sn.classList.remove("hidden"),he.classList.add("hidden"),bt==="intro"){X.classList.remove("hidden"),z.classList.add("hidden");let t=x.loadHighscore(Ht);t.score>0?(Rt.textContent=t.score.toLocaleString(),oe.textContent=Mn(t.time)):(Rt.textContent="0",oe.textContent="0:00"),Bs(),on.textContent=`v${zt}`,et.classList.remove("idlePulse"),et.offsetWidth,et.classList.add("idlePulse")}else{X.classList.add("hidden"),z.classList.remove("hidden"),V.textContent=ne.toLocaleString(),$.textContent=Mn(We);let t=x.loadHighscore(Ht);ne>0&&ne>=t.score?ht.classList.remove("hidden"):ht.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${gt.rings}</span>
          <span class="count ring-max">${gt.maxRing>0?"max \xD7"+gt.maxRing:""}</span>
        </div>
      `;_.innerHTML=o;let d=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${gt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${gt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${gt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${gt.pairs}</span>
        </div>
      `;W.innerHTML=d;let S=He()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${gt.magicUsed}</span>
        </div>
      `:"",N=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${gt.combos}</span>
          <span class="count max-combo">${gt.maxCombo>0?"max \xD7"+gt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${gt.cascades}</span>
          <span class="count max-cascade">${gt.maxCascade>0?"max \xD7"+gt.maxCascade:""}</span>
        </div>
        ${S}
      `;ft.innerHTML=N}}function $n(){kt.textContent=`Score: ${ne}`}function vs(){jt.textContent=`Time: ${Mn(We)}`}function Vs(){let t=Math.max(0,(s-Dt)/f()),o=Math.floor(t/60),d=Math.floor(t%60);_e.textContent=`Left: ${o}:${d.toString().padStart(2,"0")}`,t<30?_e.classList.add("warning"):_e.classList.remove("warning")}function yi(){m(Ht),C(),Dt=0,ge=0,qt=Vt=0,Ye=0,me.start(),gt=me.stats,ne=0,xn=performance.now(),We=0,yn=0,fn=0,bt="playing",$e=null,He()?rt.reset():(rt.deactivate(),Object.keys(rt.charges).forEach(t=>{rt.charges[t]=0}),In()),ye.reset(),zn(),ln=[],Bn=[],Ze=!1,hn=!1,Ln=!1,Ne=0,Je=0,tn=0,an.reset(),In(),$n(),vs(),Vs(),hs(),qs(),Rn.drawNextPreview(pe,$e),Fn(),A.getSettings().musicEnabled&&A.startGameMusic()}function ys(){me.gameOver(),bt="gameover",ct=null,Gt=!1,H=0,re=0;let t=x.saveHighscore(ne,We,Ht);A.stopMusic(),A.play("gameover"),vs(),Fn(),t&&ne>0&&setTimeout(()=>{ae("\u{1F3C6} NEW RECORD!","score")},500)}function Si(t){for(let d=0;d<50;d++){let S=t.map(()=>1+(Math.random()*4|0));if(!Ei(t,S))return S}return t.map((d,S)=>1+S%4)}let Ei=Vo;function Ks(t){let o=t.cells.map(S=>({x:S.x,y:S.y})),d=Si(o);return{name:t.name,cells:o,colors:d}}function qs(){if(!$e){let N=w[Math.random()*w.length|0];$e=Ks(N)}ct=$e;let t=w[Math.random()*w.length|0];$e=Ks(t),Rn.drawNextPreview(pe,$e);let o=1/0,d=-1/0;for(let N of ct.cells)N.x<o&&(o=N.x),N.x>d&&(d=N.x);let S=(o+d)/2;for(let N of ct.cells)N.x=N.x-Math.round(S);E=s+3,Wt=0,Gt=!1,H=0,re=0,ns(Math.floor(E))?A.playRandom("appear"):ys()}function zs(){return Wo(v,s,i)}function bi(t){if(t.length===0)return;let o=[];for(let ie of t)for(let we=0;we<i;we++)o.push({y:ie,s:we,color:v[ie][we],isLine:!1});Bn=t,ln=o,Hn=performance.now(),Ze=!0,Ln=!0,hn=!1;let d=t.length;gt.rings+=d,gt.maxRing=Math.max(gt.maxRing,d);let S=Zn(U,d-1),N=Math.round(Jt*d*S),st=Kt*d;Je=N,Ne=st*f(),A.play("ring");let mt=`RING \xD7${d}`;ae(mt,"ring"),setTimeout(()=>ae(`+${N}`,"score"),150),setTimeout(()=>ae(`+${st}s`,"time"),300)}function Mi(){let t=[...Bn].sort((o,d)=>d-o);for(let o of t){for(let d=o;d<s-1;d++)v[d].set(v[d+1]);v[s-1].fill(0)}if(Ne>0){ge+=Ne;let o=Ne/f();Rn.spawnBonusBubbles(o)}me.addScore(Je),ne+=Je,$n(),Ht==="30_24"&&Bn.length>0&&(se=x.addHighTowerRings(Bn.length)),ln=[],Bn=[],Ze=!1,Ln=!1,Ne=0,Je=0,Jn()}function rc(){return zs().length}function xi(){if(!ct)return;let t=es();qt=t,Vt=t,Ye=0;let o=!1;for(let d=0;d<ct.cells.length;d++){let S=ct.cells[d],N=ct.colors[d],st=Math.floor(E)+S.y,mt=ts(t+S.x);st>=s&&(o=!0),st>=0&&st<s&&(v[st][mt]=N)}if(o){ys();return}me.addScore(Et),ne+=Et,$n(),ae(`+${Et}`,"score"),A.playRandom("drop"),ct=null,tn=0,gi()}function Ci(){return Yo(v,s,i)}function Ti(){if(!ct)return!1;let t=Math.floor(E)-1;return ns(t)?(E=t,Gt=!1,H=0,re=0,!0):(Gt=!0,!1)}n.addEventListener("pointerdown",t=>{if(Ft.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),d=t.clientX-o.left,S=t.clientY-o.top;Pe.handlePointerDown(t,{onMagicTap:He()?()=>an.handleTap(d,S)?!0:Ft.applyCommand("magic_shoot",{x:d,y:S}):null,onDoubleTap:()=>Ft.applyCommand("rotate_piece")},Vt)||(Ye=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Ft.state!=="playing"||!Pe.dragging)return;t.preventDefault?.();let o=Pe.handlePointerMove(t,{canRotateTo:(d,S)=>Ft.canRotateTo(d,S),onDrop:()=>Ft.applyCommand("move_down"),onGroundedMove:()=>Ft.onGroundedMove(),onRotateStep:()=>vt.trigger("tower_rotate")},Ft.pieceY,Ft.isGrounded);o&&Ft.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Ft.state==="playing"&&Pe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Pe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Pe.dragging&&Pe.handlePointerUp(t)},{passive:!1}),Q.addEventListener("click",()=>{Ft.state==="playing"&&Ft.applyCommand("rotate_piece")});let os=e.dropBtn,is=null;function _i(){Ft.state==="playing"&&(Ft.applyCommand("move_down"),is=setInterval(()=>{if(Ft.state!=="playing"){cs();return}Ft.applyCommand("move_down")},Tt))}function cs(){is&&(clearInterval(is),is=null)}os.addEventListener("pointerdown",t=>{t.preventDefault(),_i()}),os.addEventListener("pointerup",cs),os.addEventListener("pointerleave",cs),os.addEventListener("pointercancel",cs);for(let[t,o]of Object.entries(wn))o.addEventListener("click",()=>{Ft.state==="playing"&&He()&&Ft.applyCommand("select_magic",{element:t})});Xt&&Xt.addEventListener("click",()=>{if(Ft.state!=="playing"||!qn()||!He())return;let t=rt.active??Cn;if(!t)return;let o=ms[t];!o||!Yn(o)||(ye.selectSpell(o),rt.active&&(Cn=rt.active,Wn=!0,rt.deactivate()),an.handleSpellButtonClick())});let Ss=e.soundsToggle,Es=e.musicToggle;function vn(){let t=A.getSettings();t.soundsEnabled?Ss.classList.add("active"):Ss.classList.remove("active"),t.musicEnabled?Es.classList.add("active"):Es.classList.remove("active");for(let o=0;o<=4;o++){let d=e.soundVolBtns[o],S=e.musicVolBtns[o];d&&d.classList.toggle("active",t.soundVolume===o),S&&S.classList.toggle("active",t.musicVolume===o)}}let js=e.tabBtns,Li=e.tabContents;js.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;js.forEach(d=>d.classList.remove("active")),Li.forEach(d=>d.classList.remove("active")),t.classList.add("active"),Lo(o).classList.add("active"),o==="sounds"&&vn()})});let Qs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Zs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Bi=e.iosHint,Ri=e.standaloneBadge;function Js(){let t=document.fullscreenElement||document.webkitFullscreenElement;k.textContent=t?"Disable":"Enable"}Qs&&(Zs?(Ri.style.display="block",k.style.display="none"):(Bi.style.display="block",k.textContent="Not supported",k.style.opacity="0.5",k.style.cursor="default")),k.addEventListener("click",()=>{if(Qs&&!Zs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Js),document.addEventListener("webkitfullscreenchange",Js);let rs=e.invertSwipeToggle,dn=e.hapticsToggle;B.invertSwipe&&rs.classList.add("active"),dn&&(vt.supports()?B.hapticsEnabled&&dn.classList.add("active"):(dn.classList.add("disabled"),dn.classList.remove("active"),B.hapticsEnabled=!1,vt.setEnabled(!1),x.saveGameSettings(B))),rs.addEventListener("click",()=>{rs.classList.toggle("active");let t=rs.classList.contains("active");Pe.rotDir=t?-1:1,B.invertSwipe=t,x.saveGameSettings(B)}),dn&&dn.addEventListener("click",()=>{if(dn.classList.contains("disabled"))return;dn.classList.toggle("active");let t=dn.classList.contains("active");B.hapticsEnabled=t,x.saveGameSettings(B),vt.setEnabled(t)}),Ss.addEventListener("click",()=>{let o=!A.getSettings().soundsEnabled;A.updateSettings({soundsEnabled:o}),vn(),Nn()}),Es.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),vn(),Nn(),bt!=="paused"&&(o?bt==="playing"?A.startGameMusic():A.startMenuMusic():A.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({soundVolume:t}),vn(),A.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({musicVolume:t}),vn()})}vn();function to(){bt==="playing"&&(me.pause(),fn=performance.now(),bt="paused",A.musicAudio&&A.musicAudio.pause())}function as(){bt==="paused"&&(me.resume(),yn+=performance.now()-fn,fn=0,bt="playing",xs=performance.now(),A.getSettings().musicEnabled&&A.startGameMusic())}function Nn(){let t=A.getSettings();Be.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Be.classList.toggle("off",!t.soundsEnabled),qe.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",qe.classList.toggle("off",!t.musicEnabled)}function Ai(){Le.classList.remove("hidden"),he.classList.add("hidden");let t=x.loadHighscore(Ht);if(En.textContent=t.score?t.score.toLocaleString():"0",nn.textContent=t.time?fs(t.time):"0:00",Qt.textContent=Ht==="30_24"?"High Tower":"Quick Tower",pn.textContent=ne.toLocaleString(),ke.textContent=fs(We),Oe.textContent=Ht==="30_24"?"High Tower":"Quick Tower",Nn(),io){let o=Ht==="30_24";io.style.display=o?"":"none",o&&Bs()}}function Gn(){Le.classList.add("hidden"),he.classList.remove("hidden")}he.addEventListener("click",()=>{to(),Ai()}),Me.addEventListener("click",()=>{Gn(),as()});let bs=null;function eo(t,o){le.textContent=t,bs=o,sn.classList.remove("hidden")}function no(){sn.classList.add("hidden"),bs=null}bn.addEventListener("click",()=>{no()}),Re.addEventListener("click",()=>{let t=bs;no(),t&&t()}),ve.addEventListener("click",()=>{eo("Restart game?",()=>{Gn(),Ft.applyCommand("start_game")})}),Ve.addEventListener("click",()=>{eo("Exit to menu?",()=>{Gn(),he.classList.add("hidden"),bt="intro",me.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),Fn()})}),Ke.addEventListener("click",()=>{de.classList.remove("hidden")}),Be.addEventListener("click",()=>{let t=A.getSettings();A.updateSettings({soundsEnabled:!t.soundsEnabled}),Nn(),vn()}),qe.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),Nn(),vn()}),Le.addEventListener("click",t=>{t.target===Le&&(Gn(),as())}),document.addEventListener("keydown",t=>{bt==="paused"&&!Le.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Gn(),as())}),T.addEventListener("click",()=>{de.classList.add("hidden")}),de.addEventListener("click",t=>{t.target===de&&de.classList.add("hidden")});let Ms=!1;document.addEventListener("visibilitychange",()=>{document.hidden?bt==="playing"&&(to(),Ms=!0):Ms&&bt==="paused"&&(as(),Ms=!1)});let Ft=Ko({getN:()=>i,getH:()=>s,FALL_INTERVAL:wt,LOCK_DELAY_SEC:It,getKillRate:f,MATCH_HIGHLIGHT_SEC:be,MAGIC_SHRINK_SEC:tt,RING_HIGHLIGHT_SEC:nt,getState:()=>({gameState:bt,score:ne,elapsedMs:We,startTime:xn,totalPausedMs:yn,stats:gt,activePiece:ct,pieceY:E,targetRot:Vt,rotFloat:qt,rotVel:Ye,isGrounded:Gt,isHighlighting:Ze,isMagicAnimation:hn,isRingAnimation:Ln,highlightStartTime:Hn,killLevel:Dt,grid:v,fallTimer:Wt,lockTimer:H}),setState:t=>{"elapsedMs"in t&&(We=t.elapsedMs),"killLevel"in t&&(Dt=t.killLevel),"fallTimer"in t&&(Wt=t.fallTimer),"lockTimer"in t&&(H=t.lockTimer),"targetRot"in t&&(Vt=t.targetRot),"rotFloat"in t&&(qt=t.rotFloat),"rotVel"in t&&(Ye=t.rotVel)},funcs:{startGame:yi,endGame:ys,rotatePieceByDir:pi,tryMoveDown:Ti,canPlaceAtRot:Ys,maybeResetLockDelay:Ws,shootMagic:ai,selectMagic:zo,updateGroundedState:vi,lockPiece:xi,finishHighlight:mi,finishRingHighlight:Mi},ui:{updateTimeHud:vs,updateRemainingHud:Vs}}),Rn=qo({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:O,MAX_RADIUS_X:P,RADIUS_X_FACTOR:F,ANG_OFFSET:u,MATCH_HIGHLIGHT_SEC:be,MATCH_SHRINK_PHASE:j,MAGIC_SHRINK_SEC:tt,RING_HIGHLIGHT_SEC:nt,LOCK_DELAY_SEC:It,getKillRate:f,ELEMENT_COLORS:Zt,ELEMENT_TO_COLOR:Yt,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:ut,ACTIVE_COLOR_FRONT:ce,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:G,GHOST_STROKE_WIDTH:pt,MAGIC_DIM_DOT_ALPHA:_t,MAGIC_DIM_DOT_SCALE:Nt,MAGIC_TARGET_DOT_SCALE:fe,getState:()=>({gameState:bt,grid:v,activePiece:ct,pieceY:E,rotFloat:qt,killLevel:Dt,isHighlighting:Ze,highlightedCells:ln,highlightStartTime:Hn,isMagicAnimation:hn,isRingAnimation:Ln,isGrounded:Gt,lockTimer:H,spellState:an.getRenderState()}),getVisualSettings:()=>({waterBubbles:Ut,waterColor:Fe}),funcs:{snappedRot:es,computeGhostY:hi,normSector:ts,getMagicTargetColor:()=>He()&&rt.canUse()?Yt[rt.active]:null,getTransmuteAnimState:t=>an.getTransmuteAnimState(t),getLightningAnimState:t=>an.getLightningAnimState(t),getFireAnimState:t=>an.getFireAnimState(t)}}),xs=performance.now();function so(t){let o=Math.min(.05,Math.max(.001,(t-xs)/1e3));if(xs=t,Ft.update(o,t),an.update(t),ge>0){let d=Math.min(ge,un*o);Dt=Math.max(0,Dt-d),ge-=d}qt=Vt,qt>1e6&&(qt%=i),qt<-1e6&&(qt%=i),Rn.render(o,t),requestAnimationFrame(so)}et.addEventListener("click",()=>{Ft.applyCommand("start_game")}),Bt.addEventListener("click",()=>{Ft.applyCommand("start_game")}),yt.addEventListener("click",()=>{bt="intro",me.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),Fn()}),cn.forEach(t=>{t.addEventListener("click",o=>{cn.forEach(S=>S.classList.remove("active")),t.classList.add("active"),Ht=t.dataset.mode,zn(),Kn();let d=x.loadHighscore(Ht);d.score>0?(Rt.textContent=d.score.toLocaleString(),oe.textContent=Mn(d.time)):(Rt.textContent="0",oe.textContent="0:00"),et.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>et.classList.add("idlePulse"),2e3)})});let Cs=document.querySelectorAll(".spell-select-btn"),Ts=document.getElementById("spellDesc"),wi=document.getElementById("spellProgressFill"),oo=document.getElementById("spellProgressMarkers"),io=document.getElementById("pauseSpellProgress"),Ii=document.getElementById("pauseSpellProgressFill"),co=document.getElementById("pauseSpellProgressMarkers"),ro=document.getElementById("pauseSpellProgressLabel");function _s(){return Qo.map(t=>Pn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Ls(t){return t.length?Math.max(...t):0}function Pi(t){let o=_s(),d=Ls(o);return d<=0?"":`${Math.min(t,d)}/${d}`}function ao(t){if(!t)return;t.innerHTML="";let o=_s(),d=Ls(o);o.forEach(S=>{let N=document.createElement("span");N.className="marker",N.dataset.threshold=S;let st=d>0?S/d*100:0;N.style.left=`${st}%`,t.appendChild(N)})}function lo(t,o){if(!t)return;let d=ki(o);t.style.width=`${d}%`}function uo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(S=>{let N=parseInt(S.dataset.threshold,10)||0;S.classList.toggle("reached",o>=N)})}function ki(t){let o=_s(),d=Ls(o);return t<=0||d<=0?0:t>=d?100:t/d*100}function fo(t){if(!Ts)return;let o=Pn(t),d=ye.getDescription(t);o===0||se>=o?Ts.innerHTML=d:Ts.innerHTML=`${d} <span class="spell-progress-text">${se}/${o}</span>`}function Bs(){se=x.loadHighTowerRings(),Cs.forEach(o=>{let d=o.dataset.spell,S=Pn(d),N=se>=S;o.classList.toggle("locked",!N);let st=o.querySelector(".spell-lock");st&&(st.style.display=N?"none":"")}),lo(wi,se),lo(Ii,se),uo(oo,se),uo(co,se),ro&&(ro.textContent=Pi(se));let t=document.querySelector(".spell-select-btn.active");t&&fo(t.dataset.spell)}ao(oo),ao(co),Bs(),Cs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let d=document.querySelector('.mode-btn[data-mode="30_24"]');if(d&&!d.classList.contains("active")){cn.forEach(ie=>ie.classList.remove("active")),d.classList.add("active"),Ht="30_24",zn(),Kn();let mt=x.loadHighscore(Ht);mt.score>0?(Rt.textContent=mt.score.toLocaleString(),oe.textContent=Mn(mt.time)):(Rt.textContent="0",oe.textContent="0:00")}let S=t.dataset.spell,N=Pn(S),st=se>=N;fo(S),st&&(Cs.forEach(mt=>mt.classList.remove("active")),t.classList.add("active"),ye.selectSpell(S),kn(rt.active))})}),xe.addEventListener("click",()=>{let t=x.loadHighscore("30_24"),o=x.loadHighscore("25_20"),d=`Records

`;d+=`High Tower (30\xD724):
`,d+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Mn(t.time)}
`:`  No record yet
`,d+=`
Quick Tower (25\xD720):
`,d+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Mn(o.time)}
`:`  No record yet
`,alert(d)}),De.addEventListener("click",()=>{de.classList.remove("hidden")}),In(),Kn(),zn(),Fn(),A.startMenuMusic();let Oi=()=>{if(A.unlock(),!A.getSettings().musicEnabled)return;let t=A.musicAudio;!t||t.paused||t.ended?Ft.state==="playing"?A.startGameMusic():A.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},go=0,Di=10,Hi=()=>{go>=Di||(go++,Oi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Hi,{passive:!0})}),requestAnimationFrame(so)})();})();
