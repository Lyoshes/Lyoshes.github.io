(()=>{var $i=[0,.25,.5,.75,1],Fi=[0,.05,.15,.25,.5],Gi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},yo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},vo="soundSettings";function Ni(){try{let e=localStorage.getItem(vo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ui(e){try{localStorage.setItem(vo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function So(){return{audioContext:null,buffers:{},settings:Ni(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return $i[this.settings.soundVolume]},getMusicVolume(){return Fi[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${c}`,l)}},preload(){this.initContext();for(let[n,c]of Object.entries(Gi))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;c!==null&&(l=`${n}${c}`);let i=this.buffers[l];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(yo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ui(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Eo="eb_highscore",bo="eb_highscore_quick",Mo="eb_settings",xo="eb_high_tower_rings",Xi={invertSwipe:!1,hapticsEnabled:!0};function Co(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?bo:Eo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let l=this.loadHighscore(c);if(e>l.score||e===l.score&&n>l.time){let i=c==="25_20"?bo:Eo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Mo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Xi}},saveGameSettings(e){try{localStorage.setItem(Mo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(xo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(xo,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function To(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function _o(e){return document.getElementById("tab-"+e)}var Yi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Lo(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(l,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=l,s&&n[s]&&(r.style.color=n[s]);let m=window.innerWidth/2,f=window.innerHeight/2-40,g=(Math.random()-.5)*200,d=(Math.random()-.5)*100+c*36;r.style.left=`${m+g}px`,r.style.top=`${f+d}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(l){return Yi[l]||"\u2726"}}}var Bs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Bo(){return{spawnMagicOrb(e,n,c,l){if(!l)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Bs[e]||"\u2726";let s=l.getBoundingClientRect(),r=s.left+s.width/2-n,m=s.top+s.height/2-c,f=Math.hypot(r,m),g=Math.atan2(m,r),d=f*.35*(Math.random()>.5?1:-1),p=g+Math.PI/2,_=r*.5+Math.cos(p)*d,D=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${_}px`),i.style.setProperty("--mid-y",`${D}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,l,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,m=s.top+s.height/2,f=document.createElement("div");f.className=`magic-shot ${e}`,f.textContent=Bs[e]||"\u2726";let g=c-r,d=l-m;f.style.setProperty("--end-x",`${g}px`),f.style.setProperty("--end-y",`${d}px`),f.style.left=`${r}px`,f.style.top=`${m}px`,document.body.appendChild(f);let p=setInterval(()=>{let _=f.getBoundingClientRect();this.spawnTrailParticle(e,_.left+_.width/2,_.top+_.height/2)},40);setTimeout(()=>{clearInterval(p),f.remove(),this.spawnExplosion(e,c,l),i&&i()},300)},spawnTrailParticle(e,n,c){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${c}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,f=Math.cos(r)*m,g=Math.sin(r)*m;s.style.setProperty("--px",`${f}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let l=n;typeof n=="number"&&(c=n,l="water"),Bs[l]||(l="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,m=Math.max(8,Math.round(c));for(let f=0;f<m;f++){let g=document.createElement("div");g.className=`spell-bubble ${l}`,g.textContent="\u25CF";let d=f/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,_=Math.cos(d)*p,D=Math.sin(d)*p-20;g.style.setProperty("--px",`${_}px`),g.style.setProperty("--py",`${D}px`),g.style.left=`${s}px`,g.style.top=`${r}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,m=Math.hypot(s,r),f=Math.atan2(r,s),g=m*.35*(Math.random()>.5?1:-1),d=f+Math.PI/2,p=s*.5+Math.cos(d)*g,_=r*.5+Math.sin(d)*g;l.style.setProperty("--mid-x",`${p}px`),l.style.setProperty("--mid-y",`${_}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${r}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}var Vi=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></div>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"></div>
                  <div class="d b"></div>
                  <div class="d c"></div>
                  <div class="d t"></div>
                  <div class="d r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"></div>
            <div class="p b0"></div>
            <div class="p b1"></div>
            <div class="p b2"></div>
            <div class="p b4"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Ro=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"></div>
          <div class="b s2"></div>
          <div class="b s22"></div>

          <div class="b s3 match1"></div>
          <div class="b s4 match1"></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"></div>
            <div class="b f1 grav12"></div>
            <div class="b f2 gravPair"></div>
            <div class="b f2r gravPair"></div>
            <div class="b f3 match1"></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"></div>
            <div class="b pR0 grav2"></div>
            <div class="b pR1 grav2"></div>
            <div class="b pB0 pair2"></div>
            <div class="b pB1 pair2"></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"></div>
          <div class="b s2"></div>
          <div class="b s22"></div>

          <div class="b s3"></div>
          <div class="b s4"></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"></div>
            <div class="b f1"></div>
            <div class="b f2"></div>
            <div class="b f2r"></div>
            <div class="b f3"></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"></div>
            <div class="b pR0"></div>
            <div class="b pR1"></div>
            <div class="b pB0"></div>
            <div class="b pB1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Wi=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:Vi},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Ro},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:""}];function Ao(e={}){let{helpBtn:n,mount:c=document.body,combosTemplate:l}=e;if(!n||!c)return{open(){},close(){},setCombosTemplate(){}};let i=Wi.map(A=>({...A}));typeof l=="string"&&l.trim()&&(i[1].illustrationHtml=l);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,c.appendChild(s);let r=s.querySelector(".help-next-btn"),m=s.querySelector(".help-slide-title"),f=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),d=s.querySelector(".help-dots"),p=i.map(()=>{let A=document.createElement("span");return A.className="help-dot",d.appendChild(A),A}),_=0,D=!1,k=null,W=180,et=560,ut=460,Qt=A=>{let Lt=i[A];Lt&&(_=A,m.textContent=Lt.title,f.textContent=Lt.text,g.innerHTML=Lt.illustrationHtml||"",p.forEach(($t,It)=>{$t.classList.toggle("active",It===A)}),r.textContent=A===i.length-1?"Done":"Next",z())},z=()=>{if(!D||s.classList.contains("hidden"))return;let A=g.getBoundingClientRect();if(!A.width||!A.height)return;let Lt=g.querySelector(".help-combos");if(Lt){let It=Math.min(1,Math.min(A.width,A.height)/et);Lt.style.setProperty("--help-combos-scale",It.toFixed(3))}let $t=g.querySelector(".help-controls");if($t){let It=Math.min(1,Math.min(A.width,A.height)/ut);$t.style.setProperty("--help-controls-scale",It.toFixed(3))}},V=()=>{D&&z()},ft=A=>{D&&A.stopPropagation()},ue=A=>{if(D){if(A.key==="Escape"){A.preventDefault(),A.stopPropagation(),A.stopImmediatePropagation?.(),Ht();return}A.preventDefault(),A.stopPropagation(),A.stopImmediatePropagation?.()}},ie=()=>{D||(D=!0,k&&(clearTimeout(k),k=null),Qt(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),z()}),document.addEventListener("keydown",ue,!0),window.addEventListener("resize",V))},Ht=()=>{D&&(D=!1,s.classList.remove("is-visible"),document.removeEventListener("keydown",ue,!0),window.removeEventListener("resize",V),k=window.setTimeout(()=>{s.classList.add("hidden")},W))};return s.addEventListener("click",A=>{D&&(A.target===s&&Ht(),A.stopPropagation())}),s.addEventListener("pointerdown",ft),s.addEventListener("pointerup",ft),s.addEventListener("touchstart",ft,{passive:!0}),s.addEventListener("touchmove",A=>{D&&(A.preventDefault(),A.stopPropagation())},{passive:!1}),s.addEventListener("wheel",A=>{D&&(A.preventDefault(),A.stopPropagation())},{passive:!1}),r.addEventListener("click",A=>{A.stopPropagation(),_<i.length-1?Qt(_+1):Ht()}),n.addEventListener("click",A=>{A.preventDefault(),ie()}),{open:ie,close:Ht,setCombosTemplate(A){typeof A=="string"&&(i[1].illustrationHtml=A.trim()||Ro,D&&_===1&&Qt(1))}}}var Ki={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function qi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},As=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function wo({enabled:e=!0,patterns:n=Ki}={}){let c=qi(),l=c?new As(c):new Rs,i=l.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let m=n[r];return m?l.trigger({name:r,...m}):!1}}}function Io(e={}){let{buttons:n={},onActivate:c=null,onChange:l=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[f,g]of Object.entries(n)){if(!g)continue;let d=i[f],p=g.querySelector(".charges");p&&(p.textContent=d),g.classList.toggle("empty",d<=0),g.classList.toggle("active",s===f&&d>0)}l&&l({...i},s)}function m(f){let g=n[f];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(f){s=f},select(f){if(i[f]<=0)return!1;let g=s===f;return s=g?null:f,r(),!g&&s===f&&c&&c(),!g},useCharge(){if(!s||i[s]<=0)return!1;let f=s;return i[f]--,s=null,r(),m(f),!0},addCharges(f,g){i[f]!==void 0&&(i[f]+=g,r(),m(f))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(f){for(let[g,d]of Object.entries(n))d&&d.addEventListener("click",()=>{f&&f(g)})}}}var Xe={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Po(e={}){let{button:n=null,onActivate:c=null,onProgress:l=null,onReady:i=null}=e,s="ice",r=0;function m(){return Xe[s]||Xe.ice}function f({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),_=Number.isFinite(p.maxProgress)?p.maxProgress:0,D=_>0?Math.min(r/_,1)*100:0,k=_>0&&r>=_;n.style.setProperty("--progress",`${D}%`);let W=n.querySelector(".spell-icon");W&&(W.textContent=p.icon);let et=n.querySelector(".spell-counter");et&&(et.textContent=_>0?`${Math.min(r,_)}/${_}`:""),n.classList.toggle("ready",k),n.classList.toggle("charging",!k&&r>0),l&&!d&&_>0&&l(r,_)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},get effect(){return m().effect},getUnlockRings(d){return(Xe[d]||Xe.ice).unlockRings??0},getCost(d){return(Xe[d]||Xe.ice).cost??0},getDescription(d){return(Xe[d]||Xe.ice).description||""},getEffect(d){return(Xe[d]||Xe.ice).effect},get button(){return n},selectSpell(d){Xe[d]&&(s=d,r=0,f())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let _=r<p.maxProgress;return r=Math.min(r+d,p.maxProgress),f(),g(),_&&r>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){r=Math.max(0,d),f({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&r>=d},use(){if(!this.canUse())return null;let d=m().effect;return r=0,f(),g(),c&&c(s),d},reset(){r=0,f()},pulse(){g()},updateButton:f,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function ws({centerY:e,centerS:n,size:c,H:l,normSector:i}){let s=[],r=Math.floor(c/2);for(let m=-r;m<=r;m++)for(let f=-r;f<=r;f++){let g=e+m,d=i(n+f);if(g<0||g>=l)continue;let p=m*m+f*f;s.push({y:g,s:d,distSq:p})}return s}function ls(e,n,c){return n.filter(l=>e[l.y][l.s]===c)}function us(e,n){return[...e].sort((l,i)=>l.distSq!==i.distSq?l.distSq-i.distSq:l.y!==i.y?l.y-i.y:l.s-i.s).slice(0,n).map(l=>({y:l.y,s:l.s}))}function ko({centerY:e,centerS:n,beamLength:c,beamWidth:l,N:i,H:s,normSector:r}){if(e<0||e>=s||l<=0||c<0||i<=0)return[];let m=Math.min(l,s),f=[],g=new Set,d=k=>k<0||k>=s||g.has(k)?!1:(g.add(k),f.push(k),!0);d(e);for(let k=1;f.length<m&&(e+k<s||e-k>=0)&&(d(e+k),!(f.length>=m));k++)d(e-k);f.sort((k,W)=>W-k);let p=Math.min(i,c*2+1),_=c%2===0,D=[];for(let k of f){let W=new Set,et=(ut,Qt)=>{let z=r(ut);return W.has(z)?!1:(W.add(z),D.push({y:k,s:z,dist:Qt}),!0)};et(n,0);for(let ut=1;W.size<p&&ut<i;ut++)if(_){if(et(n+ut,ut),W.size>=p)break;et(n-ut,ut)}else{if(et(n-ut,ut),W.size>=p)break;et(n+ut,ut)}}return D}function Oo(e){let{canvas:n,dom:c,getGrid:l,getN:i,getH:s,getRotFloat:r,constants:m,helpers:f,Spell:g,Magic:d,SoundModule:p,State:_,isGamePlaying:D,addPendingKzDrop:k,getKillRate:W,triggerSpellWave:et,spawnSpellBubbles:ut,spawnBonusBubbles:Qt,getTransmuteEffect:z,getLightningEffect:V,getFireEffect:ft,continueMatchProcessing:ue,updateScoreHud:ie,showBonus:Ht,getSpellCost:A,getSpellElement:Lt,onUltimateApplied:$t,isSpellBlocked:It,setScore:Nt,setCascadeLevel:Bt}=e,{TOP_PAD_PX:u,BOTTOM_PAD_PX:it,SIDE_MARGIN_PX:j,MAX_RADIUS_X:he,SCORE_MAGIC_DESTROY:re}=m,{normSector:Ye,levelYToScreenY:Ie,sectorCenterXY:An}=f,En=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],ht="idle",Z=null,ce=null,Kt=[],Zt=[],mn=0,xt=null,Ve=0,J="idle",Ce=null,Pe=[],qt=[],U=0,I=0,b="idle",T=null,O=[],y=[],Q=0;function nt(h){if(typeof A!="function"||typeof Lt!="function")return!1;let R=Lt(h),E=A(h);return!R||!E?!1:(d.charges[R]??0)>=E}function mt(h){if(typeof A!="function"||typeof Lt!="function")return!1;let R=Lt(h),E=A(h);return!R||!E||(d.charges[R]??0)<E?!1:(d.charges[R]-=E,d.updateButtons(),g.pulse(),!0)}let G=0,B=350;function M(){return typeof It=="function"?It():!1}function v(){let h=performance.now();h-G<B||(G=h,p.play("cancel"))}function Ct(){ht="selecting_source",Z=null,ce=null,Kt=[],Zt=[],J!=="idle"&&Pt(),b!=="idle"&&yt(),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function C(){ht!=="idle"&&p.play("cancel"),ht="idle",Z=null,ce=null,Kt=[],Zt=[],Rt();let h=c.spellBtn;h&&h.classList.remove("selecting")}function bt(h,R){if(ht!=="selecting_source")return!1;if(M())return v(),!0;let E=P(h,R);if(!E)return C(),!0;let rt=l();Z={y:E.y,s:E.s,color:rt[E.y][E.s]},Kt=ws({centerY:E.y,centerS:E.s,size:z().areaSize,H:s(),normSector:Ye});let Mt=Z.color,Tt=ls(rt,Kt,Mt);return Zt=us(Tt,z().maxBlocks),Xt(Z.color,E.y),ht="selecting_target",!0}function P(h,R){let E=n.clientWidth,rt=n.clientHeight,Mt=E*.5,Tt=(E-2*j)/2,Gt=rt-u-it,ve=6,Se=s(),ae=i(),le=r(),We=ae*Gt/(ve*Se),de=rt-it,se,Ne,Te;We<=Math.min(Tt,he)?(se=We,Ne=Gt,Te=u):(se=Math.min(Tt,he),Ne=se*ve*Se/ae,Te=de-Ne);let Ee=se*.28,Qe=null,hn=1/0,Ze=l();for(let Vt=0;Vt<Se;Vt++){let ln=Ie(Te,Ne,Vt+.5);for(let _e=0;_e<ae;_e++){if(!Ze[Vt][_e])continue;let be=An(Mt,ln,se,Ee,_e,le);if(Math.sin(be.ang)<-.1)continue;let ne=h-be.x,yn=R-be.y,zt=Math.hypot(ne,yn),Le=Ne/Se*.9,x=Le*1.2;Math.abs(ne)<x/2&&Math.abs(yn)<Le/2&&zt<hn&&(hn=zt,Qe={y:Vt,s:_e})}}return Qe}function Xt(h,R){Rt();let E=document.createElement("div");E.className="transmute-popup";let rt=n.clientWidth,Mt=n.clientHeight,Tt=(rt-2*j)/2,Gt=Mt-u-it,ve=6,Se=s(),ae=i(),le=ae*Gt/(ve*Se),We=Mt-it,de,se;le<=Math.min(Tt,he)?(de=Gt,se=u):(de=Math.min(Tt,he)*ve*Se/ae,se=We-de);let Ne=Ie(se,de,R+.5),Te=Math.floor(z().areaSize/2),Ee=Ie(se,de,Math.min(Se,R+Te)+.5),Qe=Ie(se,de,Math.max(0,R-Te)+.5),hn=se+de/2,Ze=document.getElementById("gameContainer"),Vt=Ze?Ze.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},ln=160,_e=60,be=20,un=Vt.left+Vt.width/2-ln/2,ne;Ne<hn?ne=Vt.top+Qe+be:ne=Vt.top+Ee-_e-be,ne=Math.max(10,Math.min(window.innerHeight-_e-10,ne)),E.style.left=`${un}px`,E.style.top=`${ne}px`,En.filter(zt=>zt.color!==h).forEach(zt=>{let Le=document.createElement("button");Le.className=`transmute-btn ${zt.name}`,Le.innerHTML=zt.icon,Le.setAttribute("data-color",zt.color),Le.addEventListener("click",x=>{x.stopPropagation(),He(zt.color)}),E.appendChild(Le)}),document.body.appendChild(E),xt=E,Ve=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Jt)},50)}function Jt(h){performance.now()-Ve<200||xt&&!xt.contains(h.target)&&C()}function Rt(){document.removeEventListener("pointerdown",Jt),xt&&(xt.remove(),xt=null)}function He(h){if(M()){v();return}if(!nt(g.currentSpell)){v();return}if(Rt(),ce=h,Zt.length===0){C();return}Ft()}function Ft(){if(!Z){C();return}if(Zt.length===0){C();return}if(!mt(g.currentSpell)){v(),C();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),ht="animating",mn=performance.now(),p.play("esseffect")}function $e(){if(ht!=="selecting_target"&&ht!=="animating"||!Z||!Kt||Kt.length===0)return;let h=l(),R=h[Z.y]?.[Z.s]??0;if(!R||R!==Z.color){C();return}let E=ls(h,Kt,R),rt=z().maxBlocks??E.length;Zt=us(E,rt),Zt.length===0&&C()}function Ut(h){if(ht!=="animating")return!1;let R=(h-mn)/1e3;return Math.min(R/z().animSec,1)>=1?(bn(),!1):!0}function ye(h){if(ht!=="animating")return null;let R=(h-mn)/1e3,E=Math.min(R/z().animSec,1),rt="flash",Mt=0,Tt=0;return E<.15?(rt="flash",Tt=1-E/.15):E<.55?(rt="shrink",Mt=(E-.15)/.4):(rt="grow",Mt=(E-.55)/.45),{phase:rt,progress:Mt,areaFlash:Tt}}function bn(){let h=l();for(let R of Zt)h[R.y][R.s]=ce;ht="idle",Z=null,ce=null,Kt=[],Zt=[],Bt(0),ue(),typeof $t=="function"&&$t("earth")}function Yt(){p.play("ulta"),J="selecting_source",Ce=null,Pe=[],qt=[],I=0,ht!=="idle"&&(ht="idle",Z=null,ce=null,Kt=[],Zt=[],Rt()),b!=="idle"&&(b="idle",T=null,O=[],y=[],Q=0),d.deactivate();let h=c.spellBtn;h&&h.classList.add("selecting")}function Pt(){J!=="idle"&&p.play("cancel"),J="idle",Ce=null,Pe=[],qt=[],I=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function w(){b="selecting_source",T=null,O=[],y=[],Q=0,ht!=="idle"&&(ht="idle",Z=null,ce=null,Kt=[],Zt=[],Rt()),J!=="idle"&&(J="idle",Ce=null,Pe=[],qt=[],I=0),d.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function yt(){b!=="idle"&&p.play("cancel"),b="idle",T=null,O=[],y=[],Q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function At(h,R){if(J!=="selecting_source")return!1;if(M())return v(),!0;let E=P(h,R);if(!E)return Pt(),!0;let rt=l();Ce={y:E.y,s:E.s,color:rt[E.y][E.s]},Pe=ws({centerY:E.y,centerS:E.s,size:V().areaSize,H:s(),normSector:Ye});let Mt=Ce.color,Tt=ls(rt,Pe,Mt);return qt=us(Tt,V().maxBlocks),qt.length===0?(Pt(),!0):nt(g.currentSpell)?(on(),!0):(v(),!0)}function kt(h,R){if(b!=="selecting_source")return!1;if(M())return v(),!0;let E=P(h,R);if(!E)return yt(),!0;let rt=l();return T={y:E.y,s:E.s,color:rt[E.y][E.s]},O=ko({centerY:E.y,centerS:E.s,beamLength:ft().beamLength,beamWidth:ft().beamWidth,N:i(),H:s(),normSector:Ye}),y=O.filter(Mt=>rt[Mt.y][Mt.s]),y.length===0?(yt(),!0):nt(g.currentSpell)?(Ge(),!0):(v(),!0)}function on(){if(!Ce||qt.length===0){Pt();return}if(!mt(g.currentSpell)){v(),Pt();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),J="animating",U=performance.now(),I=0,p.play("asseffect")}function Fe(h){if(J!=="animating")return!1;let R=h-U,E=V().flashMs+qt.length*V().jumpMs;return R>=E?(pn(),!1):!0}function rn(h){if(J!=="animating")return null;let R=h-U;if(R<V().flashMs)return{phase:"flash",flashProgress:1-R/V().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let E=R-V().flashMs,rt=Math.floor(E/V().jumpMs),Mt=E%V().jumpMs/V().jumpMs,Tt=[];for(let Gt=0;Gt<Math.min(rt,qt.length);Gt++)Tt.push(Gt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(rt,qt.length-1),jumpProgress:Mt,struckTargets:Tt}}function pn(){let h=l(),R=qt.length,E=R*re;_.addScore(E),Nt(_.score),ie(),Ht(`+${E}`,"score");for(let Gt of qt)h[Gt.y][Gt.s]=0;let rt=V(),Mt=Math.abs(rt.kzDropSecPerBlock??0),Tt=R*Mt;Tt>0&&typeof k=="function"&&typeof W=="function"&&(k(Tt*W()),Ht(`\u26A1 -${Tt}s`,"time")),J="idle",Ce=null,Pe=[],qt=[],I=0,Bt(0),ue(),typeof $t=="function"&&$t("air")}function Ge(){if(!T||y.length===0){yt();return}if(!mt(g.currentSpell)){v(),yt();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),b="animating",Q=performance.now(),p.play("fsseffect")}function at(h){return b!=="animating"?!1:(h-Q)/1e3>=ft().animSec?(cn(),!1):!0}function te(h){if(b!=="animating")return null;let R=Math.max(.001,ft().animSec),E=(h-Q)/1e3,rt=Math.min(E/R,1),Mt=.25,Tt=rt<Mt?1-rt/Mt:0;return{progress:rt,flashProgress:Tt}}function cn(){let h=l(),R=y.length;if(R>0){let E=R*re;_.addScore(E),Nt(_.score),ie(),Ht(`+${E}`,"score")}for(let E of y)h[E.y][E.s]=0;b="idle",T=null,O=[],y=[],Q=0,Bt(0),ue(),typeof $t=="function"&&$t("fire")}function wn(){let h=typeof D=="function"?D():_.isPlaying(),R=g.currentSpell;if(!h)return!1;if(R==="ice"){if(M()||!nt(R)||!mt(g.currentSpell))return v(),!1;let E=g.effect;return typeof k=="function"&&typeof W=="function"&&k(E.duration*W()),p.play("wsseffect"),Ht(`\u{1F4A7} -${E.duration}s`,"time"),typeof et=="function"&&et(),typeof Qt=="function"&&Qt(E.duration),typeof $t=="function"&&$t(R),!0}return R==="earth"?ht==="selecting_source"||ht==="selecting_target"?(C(),!0):ht!=="idle"||M()||!nt(R)?(v(),!1):(ht==="idle"&&Ct(),!0):R==="air"?J==="selecting_source"?(Pt(),!0):J!=="idle"||M()||!nt(R)?(v(),!1):(J==="idle"&&Yt(),!0):R==="fire"?b==="selecting_source"?(yt(),!0):b!=="idle"||M()||!nt(R)?(v(),!1):(b==="idle"&&w(),!0):!1}function an(h){$e(),Ut(h),Fe(h),at(h)}function ee(h,R){return M()&&(ht==="selecting_source"||J==="selecting_source"||b==="selecting_source")?(v(),!0):ht==="selecting_source"?bt(h,R):J==="selecting_source"?At(h,R):b==="selecting_source"?kt(h,R):!1}function Mn(){ht="idle",Z=null,ce=null,Kt=[],Zt=[],Rt(),J="idle",Ce=null,Pe=[],qt=[],I=0,b="idle",T=null,O=[],y=[],Q=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function ke(){return{transmuteState:ht,transmuteSourceBlock:Z,transmuteTargetColor:ce,transmuteAreaCells:Kt,transmuteBlocksToChange:Zt,lightningState:J,lightningSourceBlock:Ce,lightningAreaCells:Pe,lightningBlocksToHit:qt,fireState:b,fireSourceBlock:T,fireLineCells:O,fireTargets:y}}return{startTransmuteSourceSelection:Ct,cancelTransmutation:C,startLightningSourceSelection:Yt,cancelLightning:Pt,startFireSourceSelection:w,cancelFire:yt,handleTap:ee,update:an,reset:Mn,getRenderState:ke,getTransmuteAnimState:ye,getLightningAnimState:rn,getFireAnimState:te,handleSpellButtonClick:wn,isTransmuteSelecting:()=>ht==="selecting_source",isLightningSelecting:()=>J==="selecting_source"}}var zi={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Do(e={}){let{canvas:n}=e,c=e.rotDir||1,l=!1,i=0,s=0,r=0,m=0,f=0,g=1,d=null,p=0,_=0,D=0,k=0,W=0,et=0,ut=0,Qt=0,z=zi;return{get rotDir(){return c},set rotDir(V){c=V},get dragging(){return l},get dragMode(){return d},handlePointerDown(V,ft,ue){if(ft.onMagicTap&&ft.onMagicTap(V.clientX,V.clientY))return!0;let ie=performance.now(),Ht=ie-et,A=V.clientX-ut,Lt=V.clientY-Qt,$t=Math.hypot(A,Lt);return Ht<=z.DOUBLE_TAP_MS&&$t<=z.DOUBLE_TAP_MAX_DIST?(ft.onDoubleTap&&ft.onDoubleTap(),et=0):(et=ie,ut=V.clientX,Qt=V.clientY),l=!0,g=-1,i=V.clientX,s=V.clientY,r=ue,m=0,f=0,d=null,p=ie,_=V.clientX,D=V.clientY,k=p,W=0,n&&n.setPointerCapture(V.pointerId),!1},handlePointerMove(V,ft,ue,ie){if(!l)return null;let Ht=V.clientX-i,A=V.clientY-s,Lt=performance.now();if(Math.abs(Ht)<z.DEADZONE_PX&&Math.abs(A)<z.DEADZONE_PX)return null;if(d){if(d==="rotate"){let It=Math.abs(Ht),Nt=Math.abs(A);if(Nt>=It*z.AXIS_DOMINANCE&&Nt>=z.DROP_SWIPE_MIN_DISTANCE){let Bt=Math.max(1,Lt-p);Nt/Bt*1e3>=z.DROP_SWIPE_MIN_SPEED&&(d="drop",f=0)}}}else{let It=Math.abs(Ht),Nt=Math.abs(A);if(A<0)It>=z.DEADZONE_PX&&(d="rotate");else if(Nt>=It*z.AXIS_DOMINANCE){if(Nt>=z.DROP_SWIPE_MIN_DISTANCE){let Bt=Math.max(1,Lt-p);Nt/Bt*1e3>=z.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else It>=Nt*z.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let $t=null;if(d==="rotate"&&Math.abs(Ht)>=z.DEADZONE_PX){let It=Math.max(1,Lt-k),Nt=V.clientX-_,Bt=Math.max(1,Math.abs(Nt)/It*1e3),u=Math.max(z.MIN_ROT_PX,Math.min(z.MAX_ROT_PX,z.PX_PER_STEP*(z.SWIPE_SPEED_REF/Bt)));W+=-Nt/u*c*g;let it=Math.trunc(W);it!==0&&(W-=it);let j=m+it;if(j!==m&&ft.canRotateTo){let he=Math.sign(j-m),re=r+m;for(;m!==j;){let Ye=m+he,Ie=r+Ye;if(!ft.canRotateTo(Math.floor(ue),Ie))break;m=Ye,re=Ie,ft.onRotateStep&&ft.onRotateStep(),ie&&ft.onGroundedMove&&ft.onGroundedMove()}$t={targetRot:re,rotFloat:re}}}if(d==="drop"&&A>=z.DROP_SWIPE_MIN_DISTANCE&&ft.onDrop){let It=Math.max(1,Lt-k),Nt=V.clientY-D,Bt=Math.max(1,Nt/It*1e3),u=Math.max(z.MIN_DROP_PX,Math.min(z.MAX_DROP_PX,z.PX_PER_DROP*(z.SWIPE_SPEED_REF/Bt))),it=Math.trunc(A/u);if(it>f){let j=it-f;for(let he=0;he<j;he++)ft.onDrop();f=it}}return _=V.clientX,D=V.clientY,k=Lt,$t},handlePointerUp(V){if(l&&(l=!1,d=null,n&&V&&V.pointerId!==void 0))try{n.releasePointerCapture(V.pointerId)}catch{}},reset(){l=!1,d=null,m=0,f=0,W=0}}}var Is={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ho(){let e="intro",n=0,c=0,l=0,i=0,s=0,r={...Is};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),l=0,i=0,s=0,r={...Is}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&c>0&&(l=performance.now()-c-s)},getFormattedTime(){let m=Math.floor(l/1e3),f=Math.floor(m/60),g=m%60;return`${f}:${g.toString().padStart(2,"0")}`},incrementStat(m,f=1){m in r&&(r[m]+=f)},updateMaxStat(m,f){m in r&&f>r[m]&&(r[m]=f)},reset(){e="intro",n=0,c=0,l=0,i=0,s=0,r={...Is}}}}function Rn(e,n){return e%=n,e<0&&(e+=n),e}function $o(e,n){return e[Math.min(n,e.length-1)]}function ds(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),l=n%60;return`${c}:${l.toString().padStart(2,"0")}`}function Fo(e,n){let c=e.map(({x:m,y:f},g)=>({x:f,y:-m,color:n[g]})),l=1/0,i=-1/0,s=1/0;for(let m of c)l=Math.min(l,m.x),i=Math.max(i,m.x),s=Math.min(s,m.y);let r=Math.round((l+i)/2);for(let m of c)m.x-=r,m.y-=s;return c.sort((m,f)=>m.y-f.y||m.x-f.x),{cells:c.map(m=>({x:m.x,y:m.y})),colors:c.map(m=>m.color)}}function Ps(e,n,c,l){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Rn(n-1,l)}),i.push({y:e,s:Rn(n+1,l)}),i}function Go(e,n,c){let l=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||l[s][r])continue;let m=[],f=[{y:s,s:r}];for(l[s][r]=1;f.length>0;){let g=f.shift();m.push(g);for(let d of Ps(g.y,g.s,n,c))e[d.y][d.s]&&!l[d.y][d.s]&&(l[d.y][d.s]=1,f.push(d))}i.push(m)}return i}function No(e){return e.some(n=>n.y===0)}function ks(e,n,c,l,i,s){if(!e)return!1;let r=Rn(c,s);for(let m of e.cells){let f=n+m.y,g=Rn(r+m.x,s);if(f<0)return!1;if(!(f>=i)&&l[f][g])return!1}return!0}function Uo(e,n,c,l,i,s){if(!e)return null;let r=Math.floor(n);for(;ks(e,r-1,c,l,i,s);)r-=1;return r}function Xo(e,n,c){let l=[],i=[];for(let s=0;s<n;s++){let r=[],m=0,f=e[s][0],g=f?1:0;for(let d=1;d<=c;d++){let p=d<c?e[s][d]:0;p&&p===f?g++:(g>=1&&f&&r.push({start:m,length:g,color:f}),m=d,f=p,g=p?1:0)}if(r.length>=2){let d=r[0],p=r[r.length-1];if(d.start===0&&p.start+p.length===c&&d.color===p.color){let _=d.length+p.length;r[0]={start:p.start,length:_,color:d.color},r.pop()}}for(let d of r)if(d.length>=3){let p=[];for(let _=0;_<d.length;_++)p.push({y:s,s:(d.start+_)%c});l.push({color:d.color,length:d.length,cells:p})}}for(let s=0;s<c;s++){let r=0,m=e[0][s],f=m?1:0;for(let g=1;g<=n;g++){let d=g<n?e[g][s]:0;if(d&&d===m)f++;else{if(f>=3&&m){let p=[];for(let _=0;_<f;_++)p.push({y:r+_,s});l.push({color:m,length:f,cells:p})}r=g,m=d,f=d?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let m=e[s][r],f=e[s][(r+1)%c],g=e[s][(r+2)%c],d=e[s][(r+3)%c];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let m=e[r][s],f=e[r+1][s],g=e[r+2][s],d=e[r+3][s];m&&m===f&&g&&g===d&&m!==g&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:l,pairMatches:i}}function Yo(e,n,c){let l=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&l.push(i)}return l}function Vo(e,n){let c=new Map;e.forEach((l,i)=>c.set(`${l.x},${l.y}`,n[i]));for(let l=0;l<e.length;l++){let i=e[l],s=n[l],r=1;for(let et=1;et<=2&&c.get(`${i.x+et},${i.y}`)===s;et++)r++;if(r>=3)return!0;let m=1;for(let et=1;et<=2&&c.get(`${i.x},${i.y+et}`)===s;et++)m++;if(m>=3)return!0;let f=s,g=c.get(`${i.x+1},${i.y}`),d=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(f&&g&&d&&p&&f===g&&d===p&&f!==d)return!0;let _=s,D=c.get(`${i.x},${i.y+1}`),k=c.get(`${i.x},${i.y+2}`),W=c.get(`${i.x},${i.y+3}`);if(_&&D&&k&&W&&_===D&&k===W&&_!==k)return!0}return!1}function Wo(e){let{getN:n,getH:c,FALL_INTERVAL:l,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:f,getState:g,setState:d,funcs:p,ui:_}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(D,k={}){let W=g();if(D==="start_game")return W.gameState!=="playing"?(p.startGame(),!0):!1;if(W.gameState!=="playing")return!1;switch(D){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:et}=k;return typeof et=="number"&&p.canPlaceAtRot(Math.floor(W.pieceY),et)?(d({targetRot:et,rotFloat:et,rotVel:0}),W.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:et,y:ut}=k;return p.shootMagic(et,ut)}case"select_magic":{let{element:et}=k;return p.selectMagic(et),!0}default:return console.warn("GameEngine: unknown command",D),!1}},update(D,k){let W=g();if(W.gameState!=="playing")return;let et=k-W.startTime-W.totalPausedMs;d({elapsedMs:et}),_.updateTimeHud();let ut=W.killLevel+s()*D;if(d({killLevel:ut}),_.updateRemainingHud(),ut>=c()){p.endGame();return}if(W.isHighlighting){let V=(k-W.highlightStartTime)/1e3,ft;W.isRingAnimation?ft=f:W.isMagicAnimation?ft=m:ft=r,V>=ft&&(W.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let Qt=W.fallTimer+D;if(Qt>=l&&(Qt-=l,p.tryMoveDown()),d({fallTimer:Qt}),p.updateGroundedState()){let V=W.lockTimer+D;d({lockTimer:V}),V>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(D,k){return p.canPlaceAtRot(D,k)},getRotation(){let D=g();return{targetRot:D.targetRot,rotFloat:D.rotFloat,rotVel:D.rotVel}},setRotation(D){d({targetRot:D,rotFloat:D,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var De=Math.PI*2;function Ko(e){let{canvas:n,canvasCtx:c,getN:l,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:m,MAX_RADIUS_X:f,RADIUS_X_FACTOR:g,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:_,MAGIC_SHRINK_SEC:D,RING_HIGHLIGHT_SEC:k,LOCK_DELAY_SEC:W,getKillRate:et,ELEMENT_COLORS:ut,ELEMENT_TO_COLOR:Qt,BLOCK_COLOR_FRONT:z,BLOCK_COLOR_BACK:V,ACTIVE_COLOR_FRONT:ft,GHOST_COLOR_FILL:ue,GHOST_COLOR_STROKE:ie,GHOST_STROKE_WIDTH:Ht,MAGIC_DIM_DOT_ALPHA:A,MAGIC_DIM_DOT_SCALE:Lt,MAGIC_TARGET_DOT_SCALE:$t,getState:It,getVisualSettings:Nt,funcs:Bt}=e,u=c,it=l(),j=i(),he={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},re=[],Ye=40;function Ie(U,I,b,T,O){let y=Math.max(3,Math.round(U)),Q=180;for(let nt=0;nt<y;nt++)setTimeout(()=>{let mt=Math.random()>.5?"left":"right",G=15,B=mt==="left"?G+Math.random()*Math.max(10,I-G*2):b+G+Math.random()*Math.max(10,O-b-G*2),M=T-10;re.push({x:B,baseX:B,y:M,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:G,maxX:O-G})},nt*Q)}function An(U,I,b){re=re.filter(T=>T.y>U+T.size&&T.y>-20);for(let T of re){T.y-=Ye*b,T.wobble+=T.wobbleSpeed*b;let O=T.baseX+Math.sin(T.wobble)*T.wobbleAmp;T.x=Math.max(T.minX,Math.min(T.maxX,O))}}function En(U){if(re.length!==0){u.fillStyle="rgba(255, 255, 255, 0.3)",u.strokeStyle="rgba(255, 255, 255, 0.5)",u.lineWidth=1;for(let I of re)I.y<U+I.size||(u.beginPath(),u.arc(I.x,I.y,I.size,0,Math.PI*2),u.fill(),u.stroke())}}let ht={left:0,right:0,h:0,w:0};function Z(U,I,b){let T=1-b/j;return U+T*I}function ce(U){return U=U%it,U<0?U+it:U}function Kt(U,I,b,T,O,y){let Q=ce(y),nt=(O-Q)/it*De+d;return{x:U+Math.cos(nt)*b,y:I+Math.sin(nt)*T,ang:nt}}let Zt=.52,mn=1.02;function xt(U,I,b,T,O,y){let Q=ce(y),nt=(O-Q)/it*De+d;return{x:U+Math.cos(nt)*b,y:I+Math.sin(nt)*T,ang:nt}}function Ve(U,I,b,T,O,y,Q,nt=1){let mt=xt(U,I,b,T,O-Zt,y),G=xt(U,I,b,T,O+Zt,y),B={x:mt.x,y:mt.y-Q*.5},M={x:mt.x,y:mt.y+Q*.5},v={x:G.x,y:G.y-Q*.5},Ct={x:G.x,y:G.y+Q*.5},C=(B.x+v.x+Ct.x+M.x)*.25,bt=(B.y+v.y+Ct.y+M.y)*.25,P=mn*nt,Xt=nt,Jt=[B,v,Ct,M].map(Ft=>({x:C+(Ft.x-C)*P,y:bt+(Ft.y-bt)*Xt})),Rt=Math.abs((G.x-mt.x)*P),He=Math.abs(Q*Xt);return{corners:Jt,cx:C,cy:bt,wApprox:Rt,hApprox:He,ang:xt(U,I,b,T,O,y).ang}}function J(U,I,b,T,O,y,Q,nt,mt=1,G=null,B=1,M=null,v=0,Ct=1,C=1){let bt=Ve(U,I,b,T,O,y,Q,C),[P,Xt,Jt,Rt]=bt.corners;if(u.save(),u.globalAlpha=mt,u.fillStyle=nt,u.beginPath(),u.moveTo(P.x,P.y),u.lineTo(Xt.x,Xt.y),u.lineTo(Jt.x,Jt.y),u.lineTo(Rt.x,Rt.y),u.closePath(),u.fill(),M&&v>0&&(u.strokeStyle=M,u.lineWidth=v,u.stroke()),G){let He=Math.min(bt.wApprox,bt.hApprox)*.28*Ct;u.globalAlpha=mt*B,u.fillStyle=G,u.beginPath(),u.arc(bt.cx,bt.cy,He,0,De),u.fill()}u.restore(),u.globalAlpha=1}function Ce(U,I,b,T,O,y){let Q=Kt(U,I,b,T,O,y),nt=Kt(U,I,b,T,O+1,y),mt=Kt(U,I,b,T,O-1,y),G=Math.abs(nt.x-Q.x),B=Math.abs(Q.x-mt.x),M=(G+B)*.5*1.06;return Math.max(1,M)}function Pe(U,I,b,T,O,y){let Q=(O-y)/it*De+d;return{x:U+Math.cos(Q)*b,y:I+Math.sin(Q)*T,ang:Q}}function qt(U,I,b,T,O,y,Q,nt=1,mt=null,G=1,B=null,M=0,v=1){u.save(),u.translate(U,I);let Ct=Math.atan2(T,b);if(u.rotate(Ct),u.globalAlpha=nt,u.fillStyle=Q,u.fillRect(-O/2,-y/2,O,y),B&&M>0&&(u.strokeStyle=B,u.lineWidth=M,u.strokeRect(-O/2,-y/2,O,y)),mt){let C=Math.min(O,y)*.28*v;u.globalAlpha=nt*G,u.fillStyle=mt,u.beginPath(),u.arc(0,0,C,0,De),u.fill()}u.restore(),u.globalAlpha=1}return{resize(){let U=Math.max(1,Math.min(2,window.devicePixelRatio||1)),I=Math.floor(n.clientWidth*U),b=Math.floor(n.clientHeight*U);(n.width!==I||n.height!==b)&&(n.width=I,n.height=b,u.setTransform(U,0,0,U,0,0))},render(U=.016,I=performance.now()){this.resize();let b=It();it=l(),j=i();let T=n.clientWidth,O=n.clientHeight;u.clearRect(0,0,T,O),u.fillStyle="#0b0f14",u.fillRect(0,0,T,O);let y=T*.5,Q=(T-2*m)/2,nt=O-s-r,mt=6,G=it*nt/(mt*j),B,M,v,Ct;Ct=O-r,G<=Math.min(Q,f)?(B=G,M=nt,v=s):(B=Math.min(Q,f),M=B*mt*j/it,v=Ct-M);let C=B*.28,{killLevel:bt,rotFloat:P,grid:Xt,gameState:Jt}=b,Rt=Nt?Nt():{},He=Rt.waterColor||"blue",Ft=Rt.waterBubbles||!1,$e=he[He]||he.blue,Ut=Z(v,M,bt),ye=.7,bn=bt/j,Yt={...$e.top},Pt={...$e.bottom};if(bn>ye){let x=(bn-ye)/(1-ye);Yt.r=Math.round(Yt.r+(255-Yt.r)*x*.5),Yt.g=Math.round(Yt.g+(150-Yt.g)*x*.5),Yt.b=Math.round(Yt.b+(150-Yt.b)*x*.5),Pt.r=Math.round(Pt.r+(180-Pt.r)*x),Pt.g=Math.round(Pt.g*(1-x*.6)),Pt.b=Math.round(Pt.b*(1-x*.6))}let w=y-B-8,yt=y+B+8,At=v,kt=Ct+5,on=u.createLinearGradient(0,Ut,0,O);on.addColorStop(0,`rgba(${Yt.r},${Yt.g},${Yt.b},0.5)`),on.addColorStop(1,`rgba(${Pt.r},${Pt.g},${Pt.b},0.7)`),u.fillStyle=on;let Fe=Math.round((Yt.r+Pt.r)/2),rn=Math.round((Yt.g+Pt.g)/2),pn=Math.round((Yt.b+Pt.b)/2),Ge=B+8,at=C+4;u.fillRect(0,Ut,w,O-Ut),u.fillRect(yt,Ut,T-yt,O-Ut),u.beginPath();let te=Math.max(Ut,kt);u.moveTo(w,te),Ut<=kt+at?u.ellipse(y,kt,Ge,at,0,Math.PI,0,!1):u.lineTo(yt,te),u.lineTo(yt,O),u.lineTo(w,O),u.closePath(),u.fill(),u.strokeStyle="rgba(100,180,255,0.6)",u.lineWidth=3,u.lineCap="round",u.beginPath(),u.moveTo(w,At),u.lineTo(w,kt),u.stroke(),u.beginPath(),u.moveTo(yt,At),u.lineTo(yt,kt),u.stroke(),u.beginPath(),u.ellipse(y,kt,B+8,C+4,0,0,Math.PI),u.stroke(),u.fillStyle="#0b0f14",u.beginPath(),u.ellipse(y,kt,B+8,C+4,0,0,De),u.fill(),bt>.5&&(u.strokeStyle=`rgba(${Math.min(255,Fe+60)},${Math.min(255,rn+40)},${Math.min(255,pn+40)},0.6)`,u.lineWidth=2,u.beginPath(),u.moveTo(0,Ut),u.lineTo(w,Ut),u.moveTo(yt,Ut),u.lineTo(T,Ut),u.stroke()),ht={left:w,right:yt,h:O,w:T},(re.length>0||Ft)&&(An(Ut,O,U),En(Ut)),u.strokeStyle="rgba(160,190,220,0.3)",u.lineWidth=1;let cn=De*B,wn=10,an=cn/wn*.7,ee=cn/wn*.3;u.setLineDash([an,ee]);let Mn=cn/it;u.lineDashOffset=ce(P)*Mn;for(let x=0;x<=j;x++){let $=Z(v,M,x);u.beginPath(),u.ellipse(y,$,B,C,0,0,De),u.stroke()}u.setLineDash([]);let ke=[],h=[];for(let x=0;x<j;x++){let $=Z(v,M,x+.5);for(let K=0;K<it;K++){let N=Xt[x][K];if(!N)continue;let q=Kt(y,$,B,C,K,P),Y=Math.sin(q.ang),H={y:x,s:K,yScr:$,p:q,depth:Y,color:N};Y<-.1?ke.push(H):h.push(H)}}let R=Bt.getMagicTargetColor(),{isHighlighting:E,highlightedCells:rt,highlightStartTime:Mt,isMagicAnimation:Tt}=b,Gt=null,ve=1,Se=1,ae=!1;if(E&&rt.length>0){Gt=new Set(rt.map($=>`${$.y},${$.s}`));let x=(performance.now()-Mt)/1e3;if(Tt){let $=Math.min(1,x/D);ve=1-$*.85,Se=1-$*.9,ae=!0}else{let $=Math.min(1,x/p),K=1-_;if($>K){let N=($-K)/_;ve=1-N*.85,Se=1-N*.9,ae=!0}}}ke.sort((x,$)=>x.depth-$.depth);for(let x of ke){let $=M/j*.9,K=ut[x.color]||null,N=.35,q=1,Y=`${x.y},${x.s}`;Gt&&Gt.has(Y)&&(N*=Se,q=ve),J(y,x.yScr,B,C,x.s,P,$,V,N,K,.5,null,0,1,q)}let{isRingAnimation:le}=b;if(E&&rt.length>0&&!Tt){let x=(performance.now()-Mt)/1e3,K=Math.min(1,x/(le?k:p)),N=1-_,q=K>N,Y=q?(K-N)/_:0,H=le?Math.floor(K*N*it*2)%it:-1,L=4+K/N*10,X=Math.sin(x*L*De),ct=q?1:.3+X*.3,gt=q?1-Y*.8:1,vt=q?1-Y:1;for(let ot of rt){let St=Z(v,M,ot.y+.5),Me=xt(y,St,B,C,ot.s,P);if(Math.sin(Me.ang)>=-.1)continue;let vn=M/j*.9,ge,Be,Et;if(le){let Ke=(ot.s-H+it)%it,Je=Ke<3?1-Ke/3:0;ge=(q?vt:.2+Je*.5)*.5,Be=`rgba(255, 159, 67, ${ge})`,Et=q?gt:1+Je*.15}else ge=ct*vt,Be=ot.isLine?`rgba(255, 255, 255, ${ge*.5})`:`rgba(255, 220, 100, ${ge*.4})`,Et=q?gt:1.1;J(y,St,B,C,ot.s,P,vn,Be,1,null,1,null,0,1,Et)}}h.sort((x,$)=>x.depth-$.depth);for(let x of h){let $=M/j*.9,K=ut[x.color]||null,N=1,q=1,Y=1,H=1,L=`${x.y},${x.s}`,X=Gt&&Gt.has(L);X&&(N=Se,q=ve),R!==null&&!X&&(x.color!==R?(Y=A,H=Lt):H=$t),J(y,x.yScr,B,C,x.s,P,$,z,N,K,Y,null,0,H,q)}if(E&&rt.length>0&&!Tt){let x=(performance.now()-Mt)/1e3,K=Math.min(1,x/(le?k:p)),N=1-_,q=K>N,Y=q?(K-N)/_:0,H=le?Math.floor(K*N*it*2)%it:-1,L=4+K/N*10,X=Math.sin(x*L*De),ct=q?1:.5+X*.5,gt=q?1-Y*.8:1,vt=q?1-Y:1;for(let ot of rt){let St=Z(v,M,ot.y+.5),Me=xt(y,St,B,C,ot.s,P);if(Math.sin(Me.ang)<-.1)continue;let vn=M/j*.9,ge,Be,Et;if(le){let Ke=(ot.s-H+it)%it,Je=Ke<4?1-Ke/4:0;ge=q?vt:.3+Je*.7,Be=`rgba(255, 159, 67, ${ge})`,Et=q?gt:1+Je*.2}else ge=ct*vt,Be=ot.isLine?`rgba(255, 255, 255, ${ge*.7})`:`rgba(255, 220, 100, ${ge*.6})`,Et=q?gt:1.15;J(y,St,B,C,ot.s,P,vn,Be,1,null,1,null,0,1,Et)}}let We=b.spellState||b,{transmuteState:de,transmuteSourceBlock:se,transmuteTargetColor:Ne,transmuteAreaCells:Te,transmuteBlocksToChange:Ee}=We;if(de==="selecting_source"){let x=M/j*.9,$=.35+Math.sin(I/150)*.15;for(let K of h){let N=Z(v,M,K.y+.5);J(y,N,B,C,K.s,P,x,`rgba(0, 40, 20, ${$})`,1,null,1,null,0,1,1)}}if(de==="selecting_target"&&Ee&&Ee.length>0){let x=M/j*.9,$=.4+Math.sin(I/120)*.25,K=.6+Math.sin(I/120)*.4;for(let N of Ee){if(N.y<0||N.y>=j)continue;let q=Z(v,M,N.y+.5),Y=xt(y,q,B,C,N.s,P);Math.sin(Y.ang)<-.1||(J(y,q,B,C,N.s,P,x,`rgba(0, 50, 30, ${$})`,1,null,1,null,0,1,1),J(y,q,B,C,N.s,P,x,"transparent",1,null,1,`rgba(100, 255, 150, ${K})`,3,1,1.02))}}if(de==="animating"&&Bt.getTransmuteAnimState){let x=Bt.getTransmuteAnimState(I);if(x){let $=M/j*.9,{phase:K,progress:N,areaFlash:q}=x;if(q>0&&Te)for(let Y of Te){if(Y.y<0||Y.y>=j)continue;let H=Z(v,M,Y.y+.5),L=xt(y,H,B,C,Y.s,P);Math.sin(L.ang)<-.1||J(y,H,B,C,Y.s,P,$,`rgba(150, 255, 200, ${q*.4})`,1,null,1,null,0,1,1)}if(Ee&&Ee.length>0){let Y=se?se.color:1,H=Ne||1;for(let L of Ee){if(L.y<0||L.y>=j)continue;let X=Z(v,M,L.y+.5),ct=xt(y,X,B,C,L.s,P);if(Math.sin(ct.ang)<-.1)continue;let vt=1,ot=ut[Y],St=0;if(K==="shrink"?(vt=1-N*.95,ot=ut[Y],St=.5+N*.3):K==="grow"&&(vt=N,ot=ut[H],St=.8-N*.5),St>0&&J(y,X,B,C,L.s,P,$,`rgba(200, 255, 220, ${St})`,1,null,1,null,0,1,1),vt>.05){let Me=Ve(y,X,B,C,L.s,P,$,1),Ue=Math.min(Me.wApprox,Me.hApprox)*.28*vt;u.save(),u.globalAlpha=1,u.fillStyle=ot,u.beginPath(),u.arc(Me.cx,Me.cy,Ue,0,De),u.fill(),u.restore()}}}}}let{lightningState:Qe,lightningSourceBlock:hn,lightningAreaCells:Ze,lightningBlocksToHit:Vt}=We;if(Qe==="selecting_source"){let x=M/j*.9,$=.35+Math.sin(I/150)*.15;for(let K of h){let N=Z(v,M,K.y+.5);J(y,N,B,C,K.s,P,x,`rgba(20, 20, 60, ${$})`,1,null,1,null,0,1,1)}}if(Qe==="animating"&&Bt.getLightningAnimState){let x=Bt.getLightningAnimState(I);if(x&&Vt&&Vt.length>0){let $=M/j*.9,{phase:K,flashProgress:N,currentTarget:q,jumpProgress:Y,struckTargets:H}=x;if(K==="flash"&&N>0&&Ze)for(let L of Ze){if(L.y<0||L.y>=j)continue;let X=Z(v,M,L.y+.5),ct=xt(y,X,B,C,L.s,P);Math.sin(ct.ang)<-.1||J(y,X,B,C,L.s,P,$,`rgba(100, 150, 255, ${N*.5})`,1,null,1,null,0,1,1)}if(H&&H.length>0)for(let L of H){let X=Vt[L];if(!X||X.y<0||X.y>=j)continue;let ct=Z(v,M,X.y+.5),gt=xt(y,ct,B,C,X.s,P);if(Math.sin(gt.ang)<-.1)continue;let ot=(H.length-1-H.indexOf(L))*.1,St=Math.max(0,.8-ot);J(y,ct,B,C,X.s,P,$,`rgba(255, 255, 255, ${St})`,1,null,1,`rgba(150, 200, 255, ${St})`,2,1,1.05)}if(K==="chain"&&q>=0&&q<Vt.length){let L=Vt[q];if(L&&L.y>=0&&L.y<j){let X=Z(v,M,L.y+.5),ct=xt(y,X,B,C,L.s,P);if(Math.sin(ct.ang)>=-.1){let vt=1-Y;J(y,X,B,C,L.s,P,$,`rgba(200, 220, 255, ${vt*.9})`,1,null,1,`rgba(100, 180, 255, ${vt})`,3,1,1.1-Y*.05)}}if(q>0){let X=Vt[q-1],ct=Vt[q];if(X&&ct){let gt=Z(v,M,X.y+.5),vt=Z(v,M,ct.y+.5),ot=Ve(y,gt,B,C,X.s,P,$,1),St=Ve(y,vt,B,C,ct.s,P,$,1);u.save(),u.strokeStyle=`rgba(150, 200, 255, ${1-Y*.5})`,u.lineWidth=2+(1-Y)*2,u.lineCap="round",u.beginPath();let Me=ot.cx,Ue=ot.cy,vn=St.cx,ge=St.cy;u.moveTo(Me,Ue);let Be=4;for(let Et=1;Et<=Be;Et++){let Ke=Et/Be,Je=Me+(vn-Me)*Ke,st=Ue+(ge-Ue)*Ke,dn=Et<Be?(Math.random()-.5)*8:0;u.lineTo(Je+dn,st+dn)}u.stroke(),u.strokeStyle=`rgba(100, 150, 255, ${(1-Y)*.3})`,u.lineWidth=6,u.stroke(),u.restore()}}}}}let{fireState:ln,fireSourceBlock:_e,fireLineCells:be,fireTargets:un}=We;if(ln==="selecting_source"){let x=M/j*.9,$=.3+Math.sin(I/140)*.2;for(let K of h){let N=Z(v,M,K.y+.5);J(y,N,B,C,K.s,P,x,`rgba(70, 25, 10, ${$})`,1,null,1,null,0,1,1)}}if(ln==="animating"&&Bt.getFireAnimState){let x=Bt.getFireAnimState(I);if(x&&be&&be.length>0){let $=M/j*.9,{progress:K,flashProgress:N}=x,q=Math.sin(K*Math.PI);if(N>0)for(let Y of be){if(Y.y<0||Y.y>=j)continue;let H=Z(v,M,Y.y+.5),L=xt(y,H,B,C,Y.s,P);Math.sin(L.ang)<-.1||J(y,H,B,C,Y.s,P,$,`rgba(255, 120, 50, ${N*.45})`,1,null,1,`rgba(255, 200, 140, ${N*.5})`,2,1,1.03)}if(_e){let Y=new Map;for(let L of be){if(L.y<0||L.y>=j)continue;let X=Z(v,M,L.y+.5),ct=xt(y,X,B,C,L.s,P);if(Math.sin(ct.ang)<-.1)continue;let vt=Ve(y,X,B,C,L.s,P,$,1),ot=L.s-_e.s;ot>it/2&&(ot-=it),ot<-it/2&&(ot+=it);let St=L.y;Y.has(St)||Y.set(St,[]),Y.get(St).push({x:vt.cx,y:vt.cy,offset:ot})}let H=Array.from(Y.keys()).sort((L,X)=>X-L);if(H.length>0){let L=.35+.3*Math.sin(I/60)+q*.2;u.save(),u.lineCap="round";for(let X of H){let ct=Y.get(X)||[];if(ct.sort((gt,vt)=>gt.offset-vt.offset),ct.length!==0){u.beginPath(),u.moveTo(ct[0].x,ct[0].y);for(let gt=1;gt<ct.length;gt++)u.lineTo(ct[gt].x,ct[gt].y);u.strokeStyle=`rgba(255, 140, 60, ${L})`,u.lineWidth=Math.max(2,$*.15),u.stroke(),u.strokeStyle=`rgba(255, 210, 140, ${L*.35})`,u.lineWidth=Math.max(6,$*.35),u.stroke()}}u.restore()}}if(un&&un.length>0){let Y=.2+q*.6;for(let H of un){if(H.y<0||H.y>=j)continue;let L=Z(v,M,H.y+.5),X=xt(y,L,B,C,H.s,P);Math.sin(X.ang)<-.1||J(y,L,B,C,H.s,P,$,`rgba(255, 160, 70, ${Y})`,1,null,1,`rgba(255, 230, 180, ${q*.6})`,2,1,1.05)}}}}let{activePiece:ne,pieceY:yn,isGrounded:zt,lockTimer:Le}=b;if(ne){let x=Bt.snappedRot(),$=x,K=Bt.computeGhostY(),N=M/j*.9;if(K!==null){let H=[];for(let L=0;L<ne.cells.length;L++){let X=ne.cells[L],ct=ne.colors[L],gt=K+X.y,vt=Bt.normSector(x+X.x);if(gt<0||gt>=j)continue;let ot=Z(v,M,gt+.5),St=xt(y,ot,B,C,vt,$);H.push({cy:gt,cs:vt,yScr:ot,depth:Math.sin(St.ang),color:ct})}H.sort((L,X)=>L.depth-X.depth);for(let L of H){let X=ut[L.color]||null;J(y,L.yScr,B,C,L.cs,$,N,ue,1,X,.5,ie,Ht,1,1)}}let q=ft;if(zt&&Le>0){let H=Math.min(1,Le/W),L=255,X=Math.round(170+85*H),ct=Math.round(180+75*H),gt=.75+(1-.75)*H;q=`rgba(${L},${X},${ct},${gt})`}let Y=[];for(let H=0;H<ne.cells.length;H++){let L=ne.cells[H],X=ne.colors[H],ct=Bt.normSector(x+L.x),gt=yn+L.y;if(gt<0||gt>=j)continue;let vt=Z(v,M,gt+.5),ot=xt(y,vt,B,C,ct,$);Y.push({cs:ct,yScr:vt,depth:Math.sin(ot.ang),color:X})}Y.sort((H,L)=>H.depth-L.depth);for(let H of Y){let L=ut[H.color]||null;J(y,H.yScr,B,C,H.cs,$,N,q,1,L,1,null,0,1,1)}}},drawNextPreview(U,I){if(!U)return;let b=U.getContext("2d"),T=U.width,O=U.height;if(b.clearRect(0,0,T,O),!I)return;let y=1/0,Q=-1/0,nt=1/0,mt=-1/0;for(let C of I.cells)y=Math.min(y,C.x),Q=Math.max(Q,C.x),nt=Math.min(nt,C.y),mt=Math.max(mt,C.y);let G=Q-y+1,B=mt-nt+1,M=Math.min(T/(G+.5),O/(B+.5)),v=(T-G*M)/2,Ct=(O-B*M)/2;b.fillStyle=z;for(let C=0;C<I.cells.length;C++){let bt=I.cells[C],P=v+(bt.x-y)*M,Xt=Ct+(B-1-(bt.y-nt))*M;b.fillRect(P+1,Xt+1,M-2,M-2);let Jt=I.colors[C],Rt=ut[Jt];if(Rt){let He=(M-2)*.32;b.fillStyle=Rt,b.beginPath(),b.arc(P+M/2,Xt+M/2,He,0,De),b.fill(),b.fillStyle=z}}},spawnBonusBubbles(U){let{left:I,right:b,h:T,w:O}=ht;O>0&&Ie(U,I,b,T,O)}}}(()=>{let e=To(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,i=30,s=24,r=120,m={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function f(t){let o=m[t]||m["30_24"];i=o.N,s=o.H,r=o.survivalTime}function g(){return s/r}let d=Math.PI/2,p=70,_=120,D=30,k=320,W=.42,et="rgb(235,240,250)",ut="rgb(55,62,75)",Qt="rgba(255,170,180,0.75)",z="rgba(110,255,150,0.15)",V="rgba(110,255,150,0.85)",ft=2,ue={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},ie={1:"fire",2:"water",3:"lightning",4:"earth"},Ht={fire:1,water:2,lightning:3,earth:4},A=1,Lt=.58,$t=!0,It=12,Nt=25,Bt=1,u=2,it=3,j=1,he=5,re=7,Ye=10,Ie=3,An=50,En=2,ht=.3,Z=.5,ce=1,Kt=.3,Zt=.5,mn=1.3,xt=10,Ve=1e3,J=[1,1.25,1.5,1.75,2],Ce=10,Pe=20,qt=5,U=[1,1.3,1.6,2],I=[1,1.5,2,2.5],b=Co(),T=b.loadGameSettings();T.hapticsEnabled===void 0&&(T.hapticsEnabled=!0);let O=T.invertSwipe?-1:1,Q=!1,nt=-1,mt=wo({enabled:T.hapticsEnabled}),G=Array.from({length:s},()=>new Uint8Array(i));function B(){G=Array.from({length:s},()=>new Uint8Array(i))}let M=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],v=null,Ct=s+3,C=0,bt=0,P=!1,Xt=0,Jt=0,Rt=0,He=3,Ft=0,$e=0,Ut=0,ye=Do({canvas:n,rotDir:O}),bn="0.16.8",Yt=!0,Pt="blue",w=So();w.preload();let yt=Ho(),At="intro",kt=0,on=0,Fe=0,rn=0,pn=0,Ge=null,at=yt.stats,te=0,cn=e.overlay,wn=e.gameContainer,an=Lo({elementColors:ue}),ee=an.showBonus.bind(an),Mn=an.getElementIcon.bind(an),ke=Bo(),h=e.overlayTitle,R=e.overlayStats,E=e.startBtn,rt=e.hud,Mt=e.scoreHud,Tt=e.timeHud,Gt=e.remainingHud,ve=e.nextCanvas,Se=ve.getContext("2d"),ae=e.pauseBtn,le=e.pauseOverlay,We=e.resumeBtn,de=e.restartBtn,se=e.exitToMenuBtn,Ne=e.pauseSettingsBtn,Te=e.pauseSoundBtn,Ee=e.pauseMusicBtn,Qe=e.pauseBestScore,hn=e.pauseBestTime,Ze=e.pauseBestMode,Vt=e.pauseCurrentScore,ln=e.pauseCurrentTime,_e=e.pauseCurrentMode,be=e.confirmDialog,un=e.confirmText,ne=e.confirmCancel,yn=e.confirmOk,zt=e.settingsOverlay,Le=e.settingsClose,x=e.fullscreenBtn,$=e.rotateBtn,K=e.startPanel,N=e.gameoverPanel,q=e.goScore,Y=e.goTime,H=e.goRing,L=e.goMatches,X=e.goBonuses,ct=e.goNewRecord,gt=e.goRestartBtn,vt=e.goExitBtn,ot=e.bestScore,St=e.bestTimeVal,Me=e.startVersion,Ue=e.modeBtns,vn=e.recordsBtn,ge=e.startSettingsBtn,Be=e.helpBtn;Ao({helpBtn:Be});let Et="25_20";function Ke(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function Je(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let a=o.dataset.mode,S=m[a];if(!S)return;let F=o.querySelector(".mode-tag.time-tag");if(!F)return;let tt=Ke(S.survivalTime);tt&&(F.textContent=tt)})}Je();let st=Io({buttons:e.magicBtns,onActivate:()=>w.play("spells"),onChange:(t,o)=>{ms()}}),dn=e.magicBtns,Qi=st.charges,qo=t=>Re()?st.select(t):!1,In=()=>st.updateButtons(),Os=e.magicRow,Ot=e.magicActiveIndicator,Ds=e.magicActiveIcon,Hs=e.magicActiveCost,zo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},gs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},jo=["ice","earth","air","fire"];te=b.loadHighTowerRings();function Pn(t){return typeof oe?.getUnlockRings=="function"?oe.getUnlockRings(t):0}function Xn(t){let o=Pn(t);return o===0||te>=o}let $s=["fire","water","lightning","earth"],xn=null,Yn=!1,Qo=500,Zo=30,Jo=220,Cn=null,fs=null,Fs={fire:!1,water:!1,lightning:!1,earth:!1};function Gs(){if(!Ot)return;let t=Ot.getBoundingClientRect();t.width>0&&t.height>0&&(fs=t)}function ti(){if(!Ot)return null;let t=Ot.getBoundingClientRect();return t.width>0&&t.height>0?Ot:fs?{getBoundingClientRect:()=>fs}:null}function kn(t=st.active){if(!Ot||!Ds)return;t?(xn=t,Yn=!1):Yn||(xn=null);let o=xn;if(!o||!Re()||(st.charges[o]??0)<=0){Gs(),Ot.classList.add("hidden"),Ot.classList.remove("active","ult-ready",...$s),Ot.style.setProperty("--progress","0%"),Cn&&clearTimeout(Cn),Cn=setTimeout(()=>{Ot.classList.add("gone")},Jo);return}Cn&&(clearTimeout(Cn),Cn=null),Ot.classList.remove("gone"),Ot.classList.contains("hidden")?requestAnimationFrame(()=>Ot.classList.remove("hidden")):Ot.classList.remove("hidden"),Ds.textContent=Mn(o);let S=gs[o];S&&oe.selectSpell(S);let F=S?Dn(S):0,tt=st.charges[o]??0,lt=!!S&&Kn()&&Xn(S),jt=!!S&&Kn()&&!lt,xe=lt&&F>0?Math.min(tt/F,1):0,je=lt&&F>0,Ae=je&&tt>=F;Hs&&(Hs.textContent=je?`-${F}`:jt?"\u{1F512}":""),Ot.classList.toggle("no-cost",!je&&!jt),Ot.classList.toggle("locked",jt),Ot.classList.toggle("ult-ready",Ae),Ot.style.setProperty("--progress",`${Math.round(xe*100)}%`),Ot.classList.remove("hidden",...$s),Ot.classList.add("active",o),Gs()}function ei(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Qo))}function Vn(){for(let[t,o]of Object.entries(dn)){if(!o)continue;let a=gs[t],S=Dn(a),F=Kn()&&Re()&&a,tt=typeof Xn=="function"?Xn(a):!0,lt=F&&tt&&S>0&&(st.charges[t]??0)>=S;o.classList.toggle("ult-ready",lt),lt&&!Fs[t]&&(ei(o),At==="playing"&&w.play("readysuper")),Fs[t]=lt}}function Re(t=Et){return t==="30_24"?!0:Q}function ms(){kn(st.active),Vn()}function Zi(t){Q=t,Et==="25_20"&&(Q?st.reset():(st.deactivate(),Object.keys(st.charges).forEach(o=>{st.charges[o]=0})),In()),Wn(),ms()}function Wn(){Os&&(Os.style.display=Re()?"":"none",kn(st.active),Vn())}function Ji(t){let o=Tn(t),a=Dn(t);return!o||a<=0?!1:st.charges[o]>=a}function tr(t){let o=Tn(t),a=Dn(t);return!o||a<=0||st.charges[o]<a?!1:(st.charges[o]-=a,st.updateButtons(),oe.pulse(),!0)}let On=e.spellWave;function ni(){On&&(On.classList.remove("active"),On.offsetWidth,On.classList.add("active"),setTimeout(()=>On.classList.remove("active"),1200))}let tn=null,oe=Po({button:Ot,onReady:()=>{w.play("readysuper")}}),si=()=>oe.getEffect("earth"),oi=()=>oe.getEffect("air"),ii=()=>oe.getEffect("fire"),Dn=t=>typeof oe?.getCost=="function"?oe.getCost(t):0,Tn=t=>zo[t]??null;tn=Oo({canvas:n,dom:e,getGrid:()=>G,getN:()=>i,getH:()=>s,getRotFloat:()=>Ft,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:D,MAX_RADIUS_X:k,SCORE_MAGIC_DESTROY:qt},helpers:{normSector:Zn,levelYToScreenY:zn,sectorCenterXY:jn},Spell:oe,Magic:st,SoundModule:w,State:yt,isGamePlaying:()=>At==="playing",addPendingKzDrop:t=>{Rt+=t},getKillRate:g,triggerSpellWave:ni,spawnSpellBubbles:t=>{let o=Tn(oe.currentSpell)??"water";ke.spawnSpellBubbles(oe.button,o,t)},spawnBonusBubbles:t=>{Bn.spawnBonusBubbles(t)},getTransmuteEffect:si,getLightningEffect:oi,getFireEffect:ii,continueMatchProcessing:Qn,updateScoreHud:Fn,showBonus:ee,getSpellCost:Dn,getSpellElement:Tn,onUltimateApplied:t=>{let o=Tn(t)??Tn(oe.currentSpell)??"water";if(typeof ke?.spawnSpellBubbles=="function"){let a=ti();a&&ke.spawnSpellBubbles(a,o,Zo)}Yn=!1,xn=null,kn(null),Vn()},isSpellBlocked:ri,setScore:t=>{kt=t},setCascadeLevel:t=>{nn=t}});function Kn(){return Et==="30_24"}function qn(){kn(st.active),Vn()}let en=[],Hn=0,qe=!1,gn=!1,_n=!1,Oe=0,ze=0,nn=0,Ln=[];function ri(){return qe||gn||_n}function zn(t,o,a){let S=1-a/s;return t+S*o}function jn(t,o,a,S,F,tt){let lt=(F-tt)/i*l+d;return{x:t+Math.cos(lt)*a,y:o+Math.sin(lt)*S,ang:lt}}function Ns(t,o){let a=n.clientWidth,S=n.clientHeight,F=a*.5,tt=(a-2*D)/2,lt=S-p-_,jt=6,xe=i*lt/(jt*s),je=S-_,Ae,_t,dt;xe<=Math.min(tt,k)?(Ae=xe,_t=lt,dt=p):(Ae=Math.min(tt,k),_t=Ae*jt*s/i,dt=je-_t);let pt=Ae*.28,Dt=zn(dt,_t,t+.5),Wt=jn(F,Dt,Ae,pt,o,Ft),fe=n.getBoundingClientRect();return{x:fe.left+Wt.x,y:fe.top+Wt.y}}function ci(t,o){if(!Re()||!st.canUse()||qe)return!1;let a=Ht[st.active],S=n.clientWidth,F=n.clientHeight,tt=S*.5,lt=(S-2*D)/2,jt=F-p-_,xe=6,je=i*jt/(xe*s),Ae=F-_,_t,dt,pt;je<=Math.min(lt,k)?(_t=je,dt=jt,pt=p):(_t=Math.min(lt,k),dt=_t*xe*s/i,pt=Ae-dt);let Dt=_t*.28,Wt=null,fe=1/0;for(let me=0;me<s;me++){let we=zn(pt,dt,me+.5);for(let pe=0;pe<i;pe++){let cs=G[me][pe];if(!cs||cs!==a)continue;let Un=jn(tt,we,_t,Dt,pe,Ft);if(Math.sin(Un.ang)<-.1)continue;let as=t-Un.x,mo=o-Un.y,po=Math.hypot(as,mo),ho=dt/s*.9,Hi=ho*1.2;Math.abs(as)<Hi/2&&Math.abs(mo)<ho/2&&po<fe&&(fe=po,Wt={y:me,s:pe})}}if(Wt){let me=zn(pt,dt,Wt.y+.5),we=jn(tt,me,_t,Dt,Wt.s,Ft),pe=n.getBoundingClientRect(),cs=pe.left+we.x,Un=pe.top+we.y,fo=dn[st.active];return ke.spawnMagicShot(st.active,fo,cs,Un,()=>{let as=G[Wt.y][Wt.s];en=[{y:Wt.y,s:Wt.s,color:as,isLine:!1,isMagic:!0}],Hn=performance.now(),qe=!0,gn=!0,Oe=0,ze=qt,ee(`+${qt}`,"score")}),nn=0,st.useCharge(),at.magicUsed++,!0}return!1}let er=100;function nr(t,o){return Ps(t,o,s,i)}function ai(){return Go(G,s,i)}let li=No;function ui(t){let o=t.map(S=>({...S,color:G[S.y][S.s]}));for(let S of t)G[S.y][S.s]=0;let a=s;for(let S of t){let F=S.y;for(let tt=1;tt<=S.y;tt++){let lt=S.y-tt;if(G[lt][S.s]){F=tt-1;break}}a=Math.min(a,F)}for(let S of o)G[S.y-a][S.s]=S.color;return a>0}function di(){let t=!0;for(;t;){t=!1;let o=ai();for(let a of o)li(a)||ui(a)&&(t=!0)}}function gi(){Qn()}let ps=$o;function Us(t,o){let a=new Map,S=0,F=0,tt=0,lt={},jt=t.length+o.length;for(let dt of t){let pt=ie[dt.color],Dt=0,Wt=0;if(dt.length>=5?(Dt=it,Wt=Ye,at.lines5++):dt.length===4?(Dt=u,Wt=re,at.lines4++):dt.length===3&&(Dt=Bt,Wt=he,at.lines3++),Re()&&pt&&Dt>0){st.addCharges(pt,Dt),lt[pt]=(lt[pt]||0)+Dt;let fe=dt.cells[Math.floor(dt.cells.length/2)],me=Ns(fe.y,fe.s),we=dn[pt];for(let pe=0;pe<Dt;pe++)setTimeout(()=>{ke.spawnMagicOrb(pt,me.x,me.y,we)},pe*100)}S+=Wt*g(),tt+=Wt,F+=dt.length*Ce;for(let fe of dt.cells){let me=`${fe.y},${fe.s}`;a.has(me)||a.set(me,{y:fe.y,s:fe.s,color:dt.color,isLine:!0})}}for(let dt of o){if(at.pairs++,S+=Ie*g(),tt+=Ie,F+=Pe,Re()){let pt=[...new Set(dt.cells.map(Dt=>G[Dt.y][Dt.s]).filter(Boolean))];if(pt.length>0){let Dt=dt.cells[Math.floor(dt.cells.length/2)],Wt=Ns(Dt.y,Dt.s);pt.forEach((fe,me)=>{let we=ie[fe];if(!we)return;st.addCharges(we,j),lt[we]=(lt[we]||0)+j;let pe=dn[we];pe&&setTimeout(()=>{ke.spawnMagicOrb(we,Wt.x,Wt.y,pe)},me*100)})}}for(let pt of dt.cells){let Dt=`${pt.y},${pt.s}`;a.has(Dt)||a.set(Dt,{y:pt.y,s:pt.s,color:G[pt.y][pt.s],isLine:!1})}}let xe=ps(U,jt-1),je=ps(I,nn),Ae=Math.round(F*xe*je),_t=0;jt>1&&(at.combos++,at.maxCombo=Math.max(at.maxCombo,jt),setTimeout(()=>ee(`COMBO \xD7${jt}`,"combo"),_t),_t+=180,w.play("combo2")),nn>0&&(at.cascades++,at.maxCascade=Math.max(at.maxCascade,nn),setTimeout(()=>ee(`CASCADE \xD7${nn}`,"cascade"),_t),_t+=180,w.play("cascade")),(t.length>0||o.length>0)&&w.play("combo");for(let dt of t){let pt=dt.length,Dt=pt*Ce;setTimeout(()=>ee(`Line-${pt} +${Dt}`,"line",dt.color),_t),_t+=100}for(let dt of o){let pt=dt.cells.length>0?G[dt.cells[0].y][dt.cells[0].s]:null;setTimeout(()=>ee(`Pair +${Pe}`,"pair",pt),_t),_t+=100}Ae>0&&(setTimeout(()=>ee(`+${Ae}`,"score"),_t),_t+=120),tt>0&&(setTimeout(()=>ee(`+${tt}s`,"time"),_t),_t+=120);for(let[dt,pt]of Object.entries(lt))pt>0&&(setTimeout(()=>ee(`+${pt}${Mn(dt)}`,"charge"),_t),_t+=120);en=Array.from(a.values()),Hn=performance.now(),qe=!0,gn=!1,Oe=S,ze=Ae,In()}function fi(){for(let t of en)G[t.y][t.s]=0;if(en.length>0&&w.playRandom("disappear"),Oe>0){Rt+=Oe;let t=Oe/g();Bn.spawnBonusBubbles(t)}yt.addScore(ze),kt+=ze,Fn(),en=[],qe=!1,gn=!1,Oe=0,ze=0,nn++,Qn()}function Qn(){di();let{lineMatches:t,pairMatches:o}=xi();if(t.length>0||o.length>0)Us(t,o);else{let a=qs();a.length>0?Ei(a):!v&&At==="playing"&&Ks()}}function sr(t,o){Us(t,o)}function Zn(t){return Rn(t,i)}function Jn(){return Zn(Math.round(Ft))}function Xs(t,o){return ks(v,t,o,G,s,i)}function ts(t){return Xs(t,Jn())}let es=Fo;function Ys(){$t&&(It!==0&&Xt>=It||(bt=0,Xt+=1))}function mi(){if(!v)return;let t=v.cells,o=v.colors,a={cells:t,colors:o};if(nt>=0||(a=es(a.cells,a.colors),a=es(a.cells,a.colors)),a=es(a.cells,a.colors),v.cells=a.cells,v.colors=a.colors,!ts(Math.floor(Ct))){v.cells=t,v.colors=o;return}w.play("turn"),P&&Ys()}function pi(){return Uo(v,Ct,Jn(),G,s,i)}function hi(){if(!v)return!1;let t=Math.floor(Ct)-1,o=!ts(t);return o&&!P?(P=!0,bt=0,Xt=0):!o&&P&&(P=!1,bt=0,Xt=0),o}let Sn=ds;function $n(){if(At==="playing"){cn.classList.add("hidden"),ae.classList.remove("hidden");return}if(cn.classList.remove("hidden"),ae.classList.add("hidden"),At==="intro"){K.classList.remove("hidden"),N.classList.add("hidden");let t=b.loadHighscore(Et);t.score>0?(ot.textContent=t.score.toLocaleString(),St.textContent=Sn(t.time)):(ot.textContent="0",St.textContent="0:00"),Ls(),Me.textContent=`v${bn}`,E.classList.remove("idlePulse"),E.offsetWidth,E.classList.add("idlePulse")}else{K.classList.add("hidden"),N.classList.remove("hidden"),q.textContent=kt.toLocaleString(),Y.textContent=Sn(Fe);let t=b.loadHighscore(Et);kt>0&&kt>=t.score?ct.classList.remove("hidden"):ct.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${at.rings}</span>
          <span class="count ring-max">${at.maxRing>0?"max \xD7"+at.maxRing:""}</span>
        </div>
      `;H.innerHTML=o;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${at.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${at.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${at.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${at.pairs}</span>
        </div>
      `;L.innerHTML=a;let S=Re()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${at.magicUsed}</span>
        </div>
      `:"",F=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${at.combos}</span>
          <span class="count max-combo">${at.maxCombo>0?"max \xD7"+at.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${at.cascades}</span>
          <span class="count max-cascade">${at.maxCascade>0?"max \xD7"+at.maxCascade:""}</span>
        </div>
        ${S}
      `;X.innerHTML=F}}function Fn(){Mt.textContent=`Score: ${kt}`}function hs(){Tt.textContent=`Time: ${Sn(Fe)}`}function Vs(){let t=Math.max(0,(s-Jt)/g()),o=Math.floor(t/60),a=Math.floor(t%60);Gt.textContent=`Left: ${o}:${a.toString().padStart(2,"0")}`,t<30?Gt.classList.add("warning"):Gt.classList.remove("warning")}function yi(){f(Et),B(),Jt=0,Rt=0,Ft=$e=0,Ut=0,yt.start(),at=yt.stats,kt=0,on=performance.now(),Fe=0,pn=0,rn=0,At="playing",Ge=null,Re()?st.reset():(st.deactivate(),Object.keys(st.charges).forEach(t=>{st.charges[t]=0}),In()),oe.reset(),qn(),en=[],Ln=[],qe=!1,gn=!1,_n=!1,Oe=0,ze=0,nn=0,tn.reset(),In(),Fn(),hs(),Vs(),ms(),Ks(),Bn.drawNextPreview(ve,Ge),$n(),w.getSettings().musicEnabled&&w.startGameMusic()}function ys(){yt.gameOver(),At="gameover",v=null,P=!1,bt=0,Xt=0;let t=b.saveHighscore(kt,Fe,Et);w.stopMusic(),w.play("gameover"),hs(),$n(),t&&kt>0&&setTimeout(()=>{ee("\u{1F3C6} NEW RECORD!","score")},500)}function vi(t){for(let a=0;a<50;a++){let S=t.map(()=>1+(Math.random()*4|0));if(!Si(t,S))return S}return t.map((a,S)=>1+S%4)}let Si=Vo;function Ws(t){let o=t.cells.map(S=>({x:S.x,y:S.y})),a=vi(o);return{name:t.name,cells:o,colors:a}}function Ks(){if(!Ge){let F=M[Math.random()*M.length|0];Ge=Ws(F)}v=Ge;let t=M[Math.random()*M.length|0];Ge=Ws(t),Bn.drawNextPreview(ve,Ge);let o=1/0,a=-1/0;for(let F of v.cells)F.x<o&&(o=F.x),F.x>a&&(a=F.x);let S=(o+a)/2;for(let F of v.cells)F.x=F.x-Math.round(S);Ct=s+3,C=0,P=!1,bt=0,Xt=0,ts(Math.floor(Ct))?w.playRandom("appear"):ys()}function qs(){return Yo(G,s,i)}function Ei(t){if(t.length===0)return;let o=[];for(let jt of t)for(let xe=0;xe<i;xe++)o.push({y:jt,s:xe,color:G[jt][xe],isLine:!1});Ln=t,en=o,Hn=performance.now(),qe=!0,_n=!0,gn=!1;let a=t.length;at.rings+=a,at.maxRing=Math.max(at.maxRing,a);let S=ps(J,a-1),F=Math.round(Ve*a*S),tt=An*a;ze=F,Oe=tt*g(),w.play("ring");let lt=`RING \xD7${a}`;ee(lt,"ring"),setTimeout(()=>ee(`+${F}`,"score"),150),setTimeout(()=>ee(`+${tt}s`,"time"),300)}function bi(){let t=[...Ln].sort((o,a)=>a-o);for(let o of t){for(let a=o;a<s-1;a++)G[a].set(G[a+1]);G[s-1].fill(0)}if(Oe>0){Rt+=Oe;let o=Oe/g();Bn.spawnBonusBubbles(o)}yt.addScore(ze),kt+=ze,Fn(),Et==="30_24"&&Ln.length>0&&(te=b.addHighTowerRings(Ln.length)),en=[],Ln=[],qe=!1,_n=!1,Oe=0,ze=0,Qn()}function or(){return qs().length}function Mi(){if(!v)return;let t=Jn();Ft=t,$e=t,Ut=0;let o=!1;for(let a=0;a<v.cells.length;a++){let S=v.cells[a],F=v.colors[a],tt=Math.floor(Ct)+S.y,lt=Zn(t+S.x);tt>=s&&(o=!0),tt>=0&&tt<s&&(G[tt][lt]=F)}if(o){ys();return}yt.addScore(xt),kt+=xt,Fn(),ee(`+${xt}`,"score"),w.playRandom("drop"),v=null,nn=0,gi()}function xi(){return Xo(G,s,i)}function Ci(){if(!v)return!1;let t=Math.floor(Ct)-1;return ts(t)?(Ct=t,P=!1,bt=0,Xt=0,!0):(P=!0,!1)}n.addEventListener("pointerdown",t=>{if(wt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),a=t.clientX-o.left,S=t.clientY-o.top;ye.handlePointerDown(t,{onMagicTap:Re()?()=>tn.handleTap(a,S)?!0:wt.applyCommand("magic_shoot",{x:a,y:S}):null,onDoubleTap:()=>wt.applyCommand("rotate_piece")},$e)||(Ut=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(wt.state!=="playing"||!ye.dragging)return;t.preventDefault?.();let o=ye.handlePointerMove(t,{canRotateTo:(a,S)=>wt.canRotateTo(a,S),onDrop:()=>wt.applyCommand("move_down"),onGroundedMove:()=>wt.onGroundedMove(),onRotateStep:()=>mt.trigger("tower_rotate")},wt.pieceY,wt.isGrounded);o&&wt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{wt.state==="playing"&&ye.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{ye.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ye.dragging&&ye.handlePointerUp(t)},{passive:!1}),$.addEventListener("click",()=>{wt.state==="playing"&&wt.applyCommand("rotate_piece")});let ns=e.dropBtn,ss=null;function Ti(){wt.state==="playing"&&(wt.applyCommand("move_down"),ss=setInterval(()=>{if(wt.state!=="playing"){os();return}wt.applyCommand("move_down")},Nt))}function os(){ss&&(clearInterval(ss),ss=null)}ns.addEventListener("pointerdown",t=>{t.preventDefault(),Ti()}),ns.addEventListener("pointerup",os),ns.addEventListener("pointerleave",os),ns.addEventListener("pointercancel",os);for(let[t,o]of Object.entries(dn))o.addEventListener("click",()=>{wt.state==="playing"&&Re()&&wt.applyCommand("select_magic",{element:t})});Ot&&Ot.addEventListener("click",()=>{if(wt.state!=="playing"||!Kn()||!Re())return;let t=st.active??xn;if(!t)return;let o=gs[t];!o||!Xn(o)||(oe.selectSpell(o),st.active&&(xn=st.active,Yn=!0,st.deactivate()),tn.handleSpellButtonClick())});let vs=e.soundsToggle,Ss=e.musicToggle;function fn(){let t=w.getSettings();t.soundsEnabled?vs.classList.add("active"):vs.classList.remove("active"),t.musicEnabled?Ss.classList.add("active"):Ss.classList.remove("active");for(let o=0;o<=4;o++){let a=e.soundVolBtns[o],S=e.musicVolBtns[o];a&&a.classList.toggle("active",t.soundVolume===o),S&&S.classList.toggle("active",t.musicVolume===o)}}let zs=e.tabBtns,_i=e.tabContents;zs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;zs.forEach(a=>a.classList.remove("active")),_i.forEach(a=>a.classList.remove("active")),t.classList.add("active"),_o(o).classList.add("active"),o==="sounds"&&fn()})});let js=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Qs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Li=e.iosHint,Bi=e.standaloneBadge;function Zs(){let t=document.fullscreenElement||document.webkitFullscreenElement;x.textContent=t?"Disable":"Enable"}js&&(Qs?(Bi.style.display="block",x.style.display="none"):(Li.style.display="block",x.textContent="Not supported",x.style.opacity="0.5",x.style.cursor="default")),x.addEventListener("click",()=>{if(js&&!Qs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Zs),document.addEventListener("webkitfullscreenchange",Zs);let is=e.invertSwipeToggle,sn=e.hapticsToggle;T.invertSwipe&&is.classList.add("active"),sn&&(mt.supports()?T.hapticsEnabled&&sn.classList.add("active"):(sn.classList.add("disabled"),sn.classList.remove("active"),T.hapticsEnabled=!1,mt.setEnabled(!1),b.saveGameSettings(T))),is.addEventListener("click",()=>{is.classList.toggle("active");let t=is.classList.contains("active");ye.rotDir=t?-1:1,T.invertSwipe=t,b.saveGameSettings(T)}),sn&&sn.addEventListener("click",()=>{if(sn.classList.contains("disabled"))return;sn.classList.toggle("active");let t=sn.classList.contains("active");T.hapticsEnabled=t,b.saveGameSettings(T),mt.setEnabled(t)}),vs.addEventListener("click",()=>{let o=!w.getSettings().soundsEnabled;w.updateSettings({soundsEnabled:o}),fn(),Gn()}),Ss.addEventListener("click",()=>{let o=!w.getSettings().musicEnabled;w.updateSettings({musicEnabled:o}),fn(),Gn(),At!=="paused"&&(o?At==="playing"?w.startGameMusic():w.startMenuMusic():w.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{w.updateSettings({soundVolume:t}),fn(),w.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{w.updateSettings({musicVolume:t}),fn()})}fn();function Js(){At==="playing"&&(yt.pause(),rn=performance.now(),At="paused",w.musicAudio&&w.musicAudio.pause())}function rs(){At==="paused"&&(yt.resume(),pn+=performance.now()-rn,rn=0,At="playing",Ms=performance.now(),w.getSettings().musicEnabled&&w.startGameMusic())}function Gn(){let t=w.getSettings();Te.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Te.classList.toggle("off",!t.soundsEnabled),Ee.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Ee.classList.toggle("off",!t.musicEnabled)}function Ri(){le.classList.remove("hidden"),ae.classList.add("hidden");let t=b.loadHighscore(Et);if(Qe.textContent=t.score?t.score.toLocaleString():"0",hn.textContent=t.time?ds(t.time):"0:00",Ze.textContent=Et==="30_24"?"High Tower":"Quick Tower",Vt.textContent=kt.toLocaleString(),ln.textContent=ds(Fe),_e.textContent=Et==="30_24"?"High Tower":"Quick Tower",Gn(),oo){let o=Et==="30_24";oo.style.display=o?"":"none",o&&Ls()}}function Nn(){le.classList.add("hidden"),ae.classList.remove("hidden")}ae.addEventListener("click",()=>{Js(),Ri()}),We.addEventListener("click",()=>{Nn(),rs()});let Es=null;function to(t,o){un.textContent=t,Es=o,be.classList.remove("hidden")}function eo(){be.classList.add("hidden"),Es=null}ne.addEventListener("click",()=>{eo()}),yn.addEventListener("click",()=>{let t=Es;eo(),t&&t()}),de.addEventListener("click",()=>{to("Restart game?",()=>{Nn(),wt.applyCommand("start_game")})}),se.addEventListener("click",()=>{to("Exit to menu?",()=>{Nn(),ae.classList.add("hidden"),At="intro",yt.reset(),w.stopMusic(),w.getSettings().musicEnabled&&w.startMenuMusic(),$n()})}),Ne.addEventListener("click",()=>{zt.classList.remove("hidden")}),Te.addEventListener("click",()=>{let t=w.getSettings();w.updateSettings({soundsEnabled:!t.soundsEnabled}),Gn(),fn()}),Ee.addEventListener("click",()=>{let o=!w.getSettings().musicEnabled;w.updateSettings({musicEnabled:o}),Gn(),fn()}),le.addEventListener("click",t=>{t.target===le&&(Nn(),rs())}),document.addEventListener("keydown",t=>{At==="paused"&&!le.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Nn(),rs())}),Le.addEventListener("click",()=>{zt.classList.add("hidden")}),zt.addEventListener("click",t=>{t.target===zt&&zt.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?At==="playing"&&(Js(),bs=!0):bs&&At==="paused"&&(rs(),bs=!1)});let wt=Wo({getN:()=>i,getH:()=>s,FALL_INTERVAL:A,LOCK_DELAY_SEC:Lt,getKillRate:g,MATCH_HIGHLIGHT_SEC:En,MAGIC_SHRINK_SEC:Z,RING_HIGHLIGHT_SEC:ce,getState:()=>({gameState:At,score:kt,elapsedMs:Fe,startTime:on,totalPausedMs:pn,stats:at,activePiece:v,pieceY:Ct,targetRot:$e,rotFloat:Ft,rotVel:Ut,isGrounded:P,isHighlighting:qe,isMagicAnimation:gn,isRingAnimation:_n,highlightStartTime:Hn,killLevel:Jt,grid:G,fallTimer:C,lockTimer:bt}),setState:t=>{"elapsedMs"in t&&(Fe=t.elapsedMs),"killLevel"in t&&(Jt=t.killLevel),"fallTimer"in t&&(C=t.fallTimer),"lockTimer"in t&&(bt=t.lockTimer),"targetRot"in t&&($e=t.targetRot),"rotFloat"in t&&(Ft=t.rotFloat),"rotVel"in t&&(Ut=t.rotVel)},funcs:{startGame:yi,endGame:ys,rotatePieceByDir:mi,tryMoveDown:Ci,canPlaceAtRot:Xs,maybeResetLockDelay:Ys,shootMagic:ci,selectMagic:qo,updateGroundedState:hi,lockPiece:Mi,finishHighlight:fi,finishRingHighlight:bi},ui:{updateTimeHud:hs,updateRemainingHud:Vs}}),Bn=Ko({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:D,MAX_RADIUS_X:k,RADIUS_X_FACTOR:W,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:En,MATCH_SHRINK_PHASE:ht,MAGIC_SHRINK_SEC:Z,RING_HIGHLIGHT_SEC:ce,LOCK_DELAY_SEC:Lt,getKillRate:g,ELEMENT_COLORS:ue,ELEMENT_TO_COLOR:Ht,BLOCK_COLOR_FRONT:et,BLOCK_COLOR_BACK:ut,ACTIVE_COLOR_FRONT:Qt,GHOST_COLOR_FILL:z,GHOST_COLOR_STROKE:V,GHOST_STROKE_WIDTH:ft,MAGIC_DIM_DOT_ALPHA:Kt,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:mn,getState:()=>({gameState:At,grid:G,activePiece:v,pieceY:Ct,rotFloat:Ft,killLevel:Jt,isHighlighting:qe,highlightedCells:en,highlightStartTime:Hn,isMagicAnimation:gn,isRingAnimation:_n,isGrounded:P,lockTimer:bt,spellState:tn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Yt,waterColor:Pt}),funcs:{snappedRot:Jn,computeGhostY:pi,normSector:Zn,getMagicTargetColor:()=>Re()&&st.canUse()?Ht[st.active]:null,getTransmuteAnimState:t=>tn.getTransmuteAnimState(t),getLightningAnimState:t=>tn.getLightningAnimState(t),getFireAnimState:t=>tn.getFireAnimState(t)}}),Ms=performance.now();function no(t){let o=Math.min(.05,Math.max(.001,(t-Ms)/1e3));if(Ms=t,wt.update(o,t),tn.update(t),Rt>0){let a=Math.min(Rt,He*o);Jt=Math.max(0,Jt-a),Rt-=a}Ft=$e,Ft>1e6&&(Ft%=i),Ft<-1e6&&(Ft%=i),Bn.render(o,t),requestAnimationFrame(no)}E.addEventListener("click",()=>{wt.applyCommand("start_game")}),gt.addEventListener("click",()=>{wt.applyCommand("start_game")}),vt.addEventListener("click",()=>{At="intro",yt.reset(),w.stopMusic(),w.getSettings().musicEnabled&&w.startMenuMusic(),$n()}),Ue.forEach(t=>{t.addEventListener("click",o=>{Ue.forEach(S=>S.classList.remove("active")),t.classList.add("active"),Et=t.dataset.mode,qn(),Wn();let a=b.loadHighscore(Et);a.score>0?(ot.textContent=a.score.toLocaleString(),St.textContent=Sn(a.time)):(ot.textContent="0",St.textContent="0:00"),E.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>E.classList.add("idlePulse"),2e3)})});let xs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),Ai=document.getElementById("spellProgressFill"),so=document.getElementById("spellProgressMarkers"),oo=document.getElementById("pauseSpellProgress"),wi=document.getElementById("pauseSpellProgressFill"),io=document.getElementById("pauseSpellProgressMarkers"),ro=document.getElementById("pauseSpellProgressLabel");function Ts(){return jo.map(t=>Pn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function Ii(t){let o=Ts(),a=_s(o);return a<=0?"":`${Math.min(t,a)}/${a}`}function co(t){if(!t)return;t.innerHTML="";let o=Ts(),a=_s(o);o.forEach(S=>{let F=document.createElement("span");F.className="marker",F.dataset.threshold=S;let tt=a>0?S/a*100:0;F.style.left=`${tt}%`,t.appendChild(F)})}function ao(t,o){if(!t)return;let a=Pi(o);t.style.width=`${a}%`}function lo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(S=>{let F=parseInt(S.dataset.threshold,10)||0;S.classList.toggle("reached",o>=F)})}function Pi(t){let o=Ts(),a=_s(o);return t<=0||a<=0?0:t>=a?100:t/a*100}function uo(t){if(!Cs)return;let o=Pn(t),a=oe.getDescription(t);o===0||te>=o?Cs.innerHTML=a:Cs.innerHTML=`${a} <span class="spell-progress-text">${te}/${o}</span>`}function Ls(){te=b.loadHighTowerRings(),xs.forEach(o=>{let a=o.dataset.spell,S=Pn(a),F=te>=S;o.classList.toggle("locked",!F);let tt=o.querySelector(".spell-lock");tt&&(tt.style.display=F?"none":"")}),ao(Ai,te),ao(wi,te),lo(so,te),lo(io,te),ro&&(ro.textContent=Ii(te));let t=document.querySelector(".spell-select-btn.active");t&&uo(t.dataset.spell)}co(so),co(io),Ls(),xs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){Ue.forEach(jt=>jt.classList.remove("active")),a.classList.add("active"),Et="30_24",qn(),Wn();let lt=b.loadHighscore(Et);lt.score>0?(ot.textContent=lt.score.toLocaleString(),St.textContent=Sn(lt.time)):(ot.textContent="0",St.textContent="0:00")}let S=t.dataset.spell,F=Pn(S),tt=te>=F;uo(S),tt&&(xs.forEach(lt=>lt.classList.remove("active")),t.classList.add("active"),oe.selectSpell(S),kn(st.active))})}),vn.addEventListener("click",()=>{let t=b.loadHighscore("30_24"),o=b.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Sn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Sn(o.time)}
`:`  No record yet
`,alert(a)}),ge.addEventListener("click",()=>{zt.classList.remove("hidden")}),In(),Wn(),qn(),$n(),w.startMenuMusic();let ki=()=>{if(w.unlock(),!w.getSettings().musicEnabled)return;let t=w.musicAudio;!t||t.paused||t.ended?wt.state==="playing"?w.startGameMusic():w.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},go=0,Oi=10,Di=()=>{go>=Oi||(go++,ki())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Di,{passive:!0})}),requestAnimationFrame(no)})();})();
