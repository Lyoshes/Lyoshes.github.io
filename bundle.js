(()=>{var Ri=[0,.25,.5,.75,1],Ai=[0,.05,.15,.25,.5],Ii={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},fo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},go="soundSettings";function wi(){try{let e=localStorage.getItem(go);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Pi(e){try{localStorage.setItem(go,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function mo(){return{audioContext:null,buffers:{},settings:wi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Ri[this.settings.soundVolume]},getMusicVolume(){return Ai[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),o=await this.audioContext.decodeAudioData(i);this.buffers[n]=o}catch(u){console.debug(`Failed to load sound: ${n} from ${r}`,u)}},preload(){this.initContext();for(let[n,r]of Object.entries(Ii))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;r!==null&&(u=`${n}${r}`);let i=this.buffers[u];if(i)try{let o=this.audioContext.createGain();o.gain.value=this.getSoundVolume(),o.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(o),c.start(0),c.onended=()=>{c.disconnect(),o.disconnect()}}catch(o){console.debug("Sound play failed:",o)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(fo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(fo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Pi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var po="eb_highscore",ho="eb_highscore_quick",yo="eb_settings",So="eb_high_tower_rings",ki={invertSwipe:!1,difficulty:"easy",magicEnabled:!1};function Eo(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?ho:po,r=localStorage.getItem(n);if(r)return JSON.parse(r)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,r="30_24"){try{let u=this.loadHighscore(r);if(e>u.score||e===u.score&&n>u.time){let i=r==="25_20"?ho:po;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(yo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ki}},saveGameSettings(e){try{localStorage.setItem(yo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(So);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(So,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let r=this.loadHighTowerRings()+e;return this.saveHighTowerRings(r),r}}}function Mo(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),magicToggle:document.getElementById("magicToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function xo(e){return document.getElementById("tab-"+e)}var Oi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function bo(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(u,i="score",o=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=u,o&&n[o]&&(c.style.color=n[o]);let m=window.innerWidth/2,g=window.innerHeight/2-40,f=(Math.random()-.5)*200,d=(Math.random()-.5)*100+r*36;c.style.left=`${m+f}px`,c.style.top=`${g+d}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(u){return Oi[u]||"\u2726"}}}var vs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function vo(){return{spawnMagicOrb(e,n,r,u){if(!u)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=vs[e]||"\u2726";let o=u.getBoundingClientRect(),c=o.left+o.width/2-n,m=o.top+o.height/2-r,g=Math.hypot(c,m),f=Math.atan2(m,c),d=g*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,L=c*.5+Math.cos(p)*d,z=m*.5+Math.sin(p)*d;i.style.setProperty("--mid-x",`${L}px`),i.style.setProperty("--mid-y",`${z}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${m}px`),i.style.left=`${n}px`,i.style.top=`${r}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,r,u,i){if(!n){i&&i();return}let o=n.getBoundingClientRect(),c=o.left+o.width/2,m=o.top+o.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=vs[e]||"\u2726";let f=r-c,d=u-m;g.style.setProperty("--end-x",`${f}px`),g.style.setProperty("--end-y",`${d}px`),g.style.left=`${c}px`,g.style.top=`${m}px`,document.body.appendChild(g);let p=setInterval(()=>{let L=g.getBoundingClientRect();this.spawnTrailParticle(e,L.left+L.width/2,L.top+L.height/2)},40);setTimeout(()=>{clearInterval(p),g.remove(),this.spawnExplosion(e,r,u),i&&i()},300)},spawnTrailParticle(e,n,r){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${r}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,r){for(let i=0;i<12;i++){let o=document.createElement("div");o.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,m=40+Math.random()*40,g=Math.cos(c)*m,f=Math.sin(c)*m;o.style.setProperty("--px",`${g}px`),o.style.setProperty("--py",`${f}px`),o.style.left=`${n}px`,o.style.top=`${r}px`,document.body.appendChild(o),setTimeout(()=>o.remove(),500)}},spawnSpellBubbles(e,n="water",r=18){if(!e)return;let u=n;typeof n=="number"&&(r=n,u="water"),vs[u]||(u="water");let i=e.getBoundingClientRect(),o=i.left+i.width/2,c=i.top+i.height/2,m=Math.max(8,Math.round(r));for(let g=0;g<m;g++){let f=document.createElement("div");f.className=`spell-bubble ${u}`,f.textContent="\u25CF";let d=g/m*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,L=Math.cos(d)*p,z=Math.sin(d)*p-20;f.style.setProperty("--px",`${L}px`),f.style.setProperty("--py",`${z}px`),f.style.left=`${o}px`,f.style.top=`${c}px`,f.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),800)}},spawnSpellOrb(e,n,r){if(!r)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let i=r.getBoundingClientRect(),o=i.left+i.width/2-e,c=i.top+i.height/2-n,m=Math.hypot(o,c),g=Math.atan2(c,o),f=m*.35*(Math.random()>.5?1:-1),d=g+Math.PI/2,p=o*.5+Math.cos(d)*f,L=c*.5+Math.sin(d)*f;u.style.setProperty("--mid-x",`${p}px`),u.style.setProperty("--mid-y",`${L}px`),u.style.setProperty("--end-x",`${o}px`),u.style.setProperty("--end-y",`${c}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}function Co(e={}){let{buttons:n={},onActivate:r=null,onChange:u=null}=e,i={fire:3,water:3,lightning:3,earth:3},o=null;function c(){for(let[g,f]of Object.entries(n)){if(!f)continue;let d=i[g],p=f.querySelector(".charges");p&&(p.textContent=d),f.classList.toggle("empty",d<=0),f.classList.toggle("active",o===g&&d>0)}u&&u({...i},o)}function m(g){let f=n[g];f&&(f.classList.remove("pulse"),f.offsetWidth,f.classList.add("pulse"),setTimeout(()=>f.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return o},set active(g){o=g},select(g){if(i[g]<=0)return!1;let f=o===g;return o=f?null:g,c(),!f&&o===g&&r&&r(),!f},useCharge(){if(!o||i[o]<=0)return!1;let g=o;return i[g]--,o=null,c(),m(g),!0},addCharges(g,f){i[g]!==void 0&&(i[g]+=f,c(),m(g))},canUse(){return o!==null&&i[o]>0},deactivate(){o=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,o=null,c()},updateButtons:c,initButtons(g){for(let[f,d]of Object.entries(n))d&&d.addEventListener("click",()=>{g&&g(f)})}}}var Ue={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:10,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:10,jumpMs:180,flashMs:250}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:8,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:10,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function To(e={}){let{button:n=null,onActivate:r=null,onProgress:u=null,onReady:i=null}=e,o="ice",c=0;function m(){return Ue[o]||Ue.ice}function g({silent:d=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=m(),L=Number.isFinite(p.maxProgress)?p.maxProgress:0,z=L>0?Math.min(c/L,1)*100:0,Y=L>0&&c>=L;n.style.setProperty("--progress",`${z}%`);let q=n.querySelector(".spell-icon");q&&(q.textContent=p.icon);let et=n.querySelector(".spell-counter");et&&(et.textContent=L>0?`${Math.min(c,L)}/${L}`:""),n.classList.toggle("ready",Y),n.classList.toggle("charging",!Y&&c>0),u&&!d&&L>0&&u(c,L)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return o},get progress(){return c},get maxProgress(){return m().maxProgress??0},get isReady(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&c>=d},get effect(){return m().effect},getUnlockRings(d){return(Ue[d]||Ue.ice).unlockRings??0},getCost(d){return(Ue[d]||Ue.ice).cost??0},getDescription(d){return(Ue[d]||Ue.ice).description||""},getEffect(d){return(Ue[d]||Ue.ice).effect},get button(){return n},selectSpell(d){Ue[d]&&(o=d,c=0,g())},addProgress(d=1){let p=m();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||c>=p.maxProgress)return!1;let L=c<p.maxProgress;return c=Math.min(c+d,p.maxProgress),g(),f(),L&&c>=p.maxProgress&&i&&i(),!0},setProgress(d,{silent:p=!1}={}){c=Math.max(0,d),g({silent:p})},canUse(){let d=m().maxProgress;return Number.isFinite(d)&&d>0&&c>=d},use(){if(!this.canUse())return null;let d=m().effect;return c=0,g(),f(),r&&r(o),d},reset(){c=0,g()},pulse(){f()},updateButton:g,initButton(d){n&&n.addEventListener("click",()=>{d&&d()})}}}function Cs({centerY:e,centerS:n,size:r,H:u,normSector:i}){let o=[],c=Math.floor(r/2);for(let m=-c;m<=c;m++)for(let g=-c;g<=c;g++){let f=e+m,d=i(n+g);if(f<0||f>=u)continue;let p=m*m+g*g;o.push({y:f,s:d,distSq:p})}return o}function Ts(e,n,r){return n.filter(u=>e[u.y][u.s]===r)}function _s(e,n){return[...e].sort((u,i)=>u.distSq!==i.distSq?u.distSq-i.distSq:u.y!==i.y?u.y-i.y:u.s-i.s).slice(0,n).map(u=>({y:u.y,s:u.s}))}function _o({centerY:e,centerS:n,beamLength:r,beamWidth:u,N:i,H:o,normSector:c}){if(e<0||e>=o||u<=0||r<0||i<=0)return[];let m=Math.min(u,o),g=[],f=new Set,d=Y=>Y<0||Y>=o||f.has(Y)?!1:(f.add(Y),g.push(Y),!0);d(e);for(let Y=1;g.length<m&&(e+Y<o||e-Y>=0)&&(d(e+Y),!(g.length>=m));Y++)d(e-Y);g.sort((Y,q)=>q-Y);let p=Math.min(i,r*2+1),L=r%2===0,z=[];for(let Y of g){let q=new Set,et=(gt,ue)=>{let ot=c(gt);return q.has(ot)?!1:(q.add(ot),z.push({y:Y,s:ot,dist:ue}),!0)};et(n,0);for(let gt=1;q.size<p&&gt<i;gt++)if(L){if(et(n+gt,gt),q.size>=p)break;et(n-gt,gt)}else{if(et(n-gt,gt),q.size>=p)break;et(n+gt,gt)}}return z}function Bo(e){let{canvas:n,dom:r,getGrid:u,getN:i,getH:o,getRotFloat:c,constants:m,helpers:g,Spell:f,Magic:d,SoundModule:p,State:L,isGamePlaying:z,addPendingKzDrop:Y,getKillRate:q,triggerSpellWave:et,spawnSpellBubbles:gt,spawnBonusBubbles:ue,getTransmuteEffect:ot,getLightningEffect:K,getFireEffect:xt,continueMatchProcessing:we,updateScoreHud:Me,showBonus:te,getSpellCost:zt,getSpellElement:jt,onUltimateApplied:Ut,isSpellBlocked:ee,setScore:Xt,setCascadeLevel:At}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:nt,SIDE_MARGIN_PX:j,MAX_RADIUS_X:de,SCORE_MAGIC_DESTROY:Qt}=m,{normSector:He,levelYToScreenY:$e,sectorCenterXY:hn}=g,_n=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],Et="idle",it=null,ne=null,Zt=[],Jt=[],je=0,Tt=null,Xe=0,Q="idle",xe=null,be=[],Yt=[],$=0,C=0,b="idle",A=null,w=[],y=[],R=0;function J(h){if(typeof zt!="function"||typeof jt!="function")return!1;let I=jt(h),v=zt(h);return!I||!v?!1:(d.charges[I]??0)>=v}function mt(h){if(typeof zt!="function"||typeof jt!="function")return!1;let I=jt(h),v=zt(h);return!I||!v||(d.charges[I]??0)<v?!1:(d.charges[I]-=v,d.updateButtons(),f.pulse(),!0)}let H=0,E=350;function x(){return typeof ee=="function"?ee():!1}function _(){let h=performance.now();h-H<E||(H=h,p.play("cancel"))}function Mt(){Et="selecting_source",it=null,ne=null,Zt=[],Jt=[],Q!=="idle"&&ct(),b!=="idle"&&yt(),d.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function M(){Et!=="idle"&&p.play("cancel"),Et="idle",it=null,ne=null,Zt=[],Jt=[],Lt();let h=r.spellBtn;h&&h.classList.remove("selecting")}function bt(h,I){if(Et!=="selecting_source")return!1;if(x())return _(),!0;let v=O(h,I);if(!v)return M(),!0;let dt=u();it={y:v.y,s:v.s,color:dt[v.y][v.s]},Zt=Cs({centerY:v.y,centerS:v.s,size:ot().areaSize,H:o(),normSector:He});let pt=it.color,_t=Ts(dt,Zt,pt);return Jt=_s(_t,ot().maxBlocks),fe(it.color,v.y),Et="selecting_target",!0}function O(h,I){let v=n.clientWidth,dt=n.clientHeight,pt=v*.5,_t=(v-2*j)/2,me=dt-l-nt,Gt=6,Dt=o(),Ce=i(),ln=c(),Te=Ce*me/(Gt*Dt),ie=dt-nt,kt,pe,Ve;Te<=Math.min(_t,de)?(kt=Te,pe=me,Ve=l):(kt=Math.min(_t,de),pe=kt*Gt*Dt/Ce,Ve=ie-pe);let an=kt*.28,_e=null,Je=1/0,mn=u();for(let ce=0;ce<Dt;ce++){let he=$e(Ve,pe,ce+.5);for(let Be=0;Be<Ce;Be++){if(!mn[ce][Be])continue;let Ge=hn(pt,he,kt,an,Be,ln);if(Math.sin(Ge.ang)<-.1)continue;let Ht=h-Ge.x,Le=I-Ge.y,$t=Math.hypot(Ht,Le),ke=pe/Dt*.9,en=ke*1.2;Math.abs(Ht)<en/2&&Math.abs(Le)<ke/2&&$t<Je&&(Je=$t,_e={y:ce,s:Be})}}return _e}function fe(h,I){Lt();let v=document.createElement("div");v.className="transmute-popup";let dt=n.clientWidth,pt=n.clientHeight,_t=(dt-2*j)/2,me=pt-l-nt,Gt=6,Dt=o(),Ce=i(),ln=Ce*me/(Gt*Dt),Te=pt-nt,ie,kt;ln<=Math.min(_t,de)?(ie=me,kt=l):(ie=Math.min(_t,de)*Gt*Dt/Ce,kt=Te-ie);let pe=$e(kt,ie,I+.5),Ve=Math.floor(ot().areaSize/2),an=$e(kt,ie,Math.min(Dt,I+Ve)+.5),_e=$e(kt,ie,Math.max(0,I-Ve)+.5),Je=kt+ie/2,mn=document.getElementById("gameContainer"),ce=mn?mn.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},he=160,Be=60,Ge=20,tn=ce.left+ce.width/2-he/2,Ht;pe<Je?Ht=ce.top+_e+Ge:Ht=ce.top+an-Be-Ge,Ht=Math.max(10,Math.min(window.innerHeight-Be-10,Ht)),v.style.left=`${tn}px`,v.style.top=`${Ht}px`,_n.filter($t=>$t.color!==h).forEach($t=>{let ke=document.createElement("button");ke.className=`transmute-btn ${$t.name}`,ke.innerHTML=$t.icon,ke.setAttribute("data-color",$t.color),ke.addEventListener("click",en=>{en.stopPropagation(),se($t.color)}),v.appendChild(ke)}),document.body.appendChild(v),Tt=v,Xe=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",vt)},50)}function vt(h){performance.now()-Xe<200||Tt&&!Tt.contains(h.target)&&M()}function Lt(){document.removeEventListener("pointerdown",vt),Tt&&(Tt.remove(),Tt=null)}function se(h){if(x()){_();return}if(!J(f.currentSpell)){_();return}if(Lt(),ne=h,Jt.length===0){M();return}oe()}function oe(){if(!it){M();return}if(Jt.length===0){M();return}if(!mt(f.currentSpell)){_(),M();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),Et="animating",je=performance.now(),p.play("esseffect")}function yn(h){if(Et!=="animating")return!1;let I=(h-je)/1e3;return Math.min(I/ot().animSec,1)>=1?(fn(),!1):!0}function Vt(h){if(Et!=="animating")return null;let I=(h-je)/1e3,v=Math.min(I/ot().animSec,1),dt="flash",pt=0,_t=0;return v<.15?(dt="flash",_t=1-v/.15):v<.55?(dt="shrink",pt=(v-.15)/.4):(dt="grow",pt=(v-.55)/.45),{phase:dt,progress:pt,areaFlash:_t}}function fn(){let h=u();for(let I of Jt)h[I.y][I.s]=ne;Et="idle",it=null,ne=null,Zt=[],Jt=[],At(0),we(),typeof Ut=="function"&&Ut("earth")}function k(){p.play("ulta"),Q="selecting_source",xe=null,be=[],Yt=[],C=0,Et!=="idle"&&(Et="idle",it=null,ne=null,Zt=[],Jt=[],Lt()),b!=="idle"&&(b="idle",A=null,w=[],y=[],R=0),d.deactivate();let h=r.spellBtn;h&&h.classList.add("selecting")}function ct(){Q!=="idle"&&p.play("cancel"),Q="idle",xe=null,be=[],Yt=[],C=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function st(){b="selecting_source",A=null,w=[],y=[],R=0,Et!=="idle"&&(Et="idle",it=null,ne=null,Zt=[],Jt=[],Lt()),Q!=="idle"&&(Q="idle",xe=null,be=[],Yt=[],C=0),d.deactivate(),p.play("ulta");let h=r.spellBtn;h&&h.classList.add("selecting")}function yt(){b!=="idle"&&p.play("cancel"),b="idle",A=null,w=[],y=[],R=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function ve(h,I){if(Q!=="selecting_source")return!1;if(x())return _(),!0;let v=O(h,I);if(!v)return ct(),!0;let dt=u();xe={y:v.y,s:v.s,color:dt[v.y][v.s]},be=Cs({centerY:v.y,centerS:v.s,size:K().areaSize,H:o(),normSector:He});let pt=xe.color,_t=Ts(dt,be,pt);return Yt=_s(_t,K().maxBlocks),Yt.length===0?(ct(),!0):J(f.currentSpell)?(ge(),!0):(_(),!0)}function Pe(h,I){if(b!=="selecting_source")return!1;if(x())return _(),!0;let v=O(h,I);if(!v)return yt(),!0;let dt=u();return A={y:v.y,s:v.s,color:dt[v.y][v.s]},w=_o({centerY:v.y,centerS:v.s,beamLength:xt().beamLength,beamWidth:xt().beamWidth,N:i(),H:o(),normSector:He}),y=w.filter(pt=>dt[pt.y][pt.s]),y.length===0?(yt(),!0):J(f.currentSpell)?(Wt(),!0):(_(),!0)}function ge(){if(!xe||Yt.length===0){ct();return}if(!mt(f.currentSpell)){_(),ct();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),Q="animating",$=performance.now(),C=0,p.play("asseffect")}function Qe(h){if(Q!=="animating")return!1;let I=h-$,v=K().flashMs+Yt.length*K().jumpMs;return I>=v?(ut(),!1):!0}function Fe(h){if(Q!=="animating")return null;let I=h-$;if(I<K().flashMs)return{phase:"flash",flashProgress:1-I/K().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let v=I-K().flashMs,dt=Math.floor(v/K().jumpMs),pt=v%K().jumpMs/K().jumpMs,_t=[];for(let me=0;me<Math.min(dt,Yt.length);me++)_t.push(me);return{phase:"chain",flashProgress:0,currentTarget:Math.min(dt,Yt.length-1),jumpProgress:pt,struckTargets:_t}}function ut(){let h=u(),v=Yt.length*Qt;L.addScore(v),Xt(L.score),Me(),te(`+${v}`,"score");for(let dt of Yt)h[dt.y][dt.s]=0;Q="idle",xe=null,be=[],Yt=[],C=0,At(0),we(),typeof Ut=="function"&&Ut("air")}function Wt(){if(!A||y.length===0){yt();return}if(!mt(f.currentSpell)){_(),yt();return}let h=r.spellBtn;h&&h.classList.remove("selecting"),b="animating",R=performance.now(),p.play("fsseffect")}function Sn(h){return b!=="animating"?!1:(h-R)/1e3>=xt().animSec?(Ze(),!1):!0}function Bn(h){if(b!=="animating")return null;let I=Math.max(.001,xt().animSec),v=(h-R)/1e3,dt=Math.min(v/I,1),pt=.25,_t=dt<pt?1-dt/pt:0;return{progress:dt,flashProgress:_t}}function Ze(){let h=u(),I=y.length;if(I>0){let v=I*Qt;L.addScore(v),Xt(L.score),Me(),te(`+${v}`,"score")}for(let v of y)h[v.y][v.s]=0;b="idle",A=null,w=[],y=[],R=0,At(0),we(),typeof Ut=="function"&&Ut("fire")}function Pt(){let h=typeof z=="function"?z():L.isPlaying(),I=f.currentSpell;if(!h)return!1;if(I==="ice"){if(x()||!J(I)||!mt(f.currentSpell))return _(),!1;let v=f.effect;return typeof Y=="function"&&typeof q=="function"&&Y(v.duration*q()),p.play("wsseffect"),te(`\u{1F4A7} -${v.duration}s`,"time"),typeof et=="function"&&et(),typeof ue=="function"&&ue(v.duration),typeof Ut=="function"&&Ut(I),!0}return I==="earth"?Et==="selecting_source"||Et==="selecting_target"?(M(),!0):Et!=="idle"||x()||!J(I)?(_(),!1):(Et==="idle"&&Mt(),!0):I==="air"?Q==="selecting_source"?(ct(),!0):Q!=="idle"||x()||!J(I)?(_(),!1):(Q==="idle"&&k(),!0):I==="fire"?b==="selecting_source"?(yt(),!0):b!=="idle"||x()||!J(I)?(_(),!1):(b==="idle"&&st(),!0):!1}function gn(h){yn(h),Qe(h),Sn(h)}function Ye(h,I){return x()&&(Et==="selecting_source"||Q==="selecting_source"||b==="selecting_source")?(_(),!0):Et==="selecting_source"?bt(h,I):Q==="selecting_source"?ve(h,I):b==="selecting_source"?Pe(h,I):!1}function $n(){Et="idle",it=null,ne=null,Zt=[],Jt=[],Lt(),Q="idle",xe=null,be=[],Yt=[],C=0,b="idle",A=null,w=[],y=[],R=0;let h=r.spellBtn;h&&h.classList.remove("selecting")}function Fn(){return{transmuteState:Et,transmuteSourceBlock:it,transmuteTargetColor:ne,transmuteAreaCells:Zt,transmuteBlocksToChange:Jt,lightningState:Q,lightningSourceBlock:xe,lightningAreaCells:be,lightningBlocksToHit:Yt,fireState:b,fireSourceBlock:A,fireLineCells:w,fireTargets:y}}return{startTransmuteSourceSelection:Mt,cancelTransmutation:M,startLightningSourceSelection:k,cancelLightning:ct,startFireSourceSelection:st,cancelFire:yt,handleTap:Ye,update:gn,reset:$n,getRenderState:Fn,getTransmuteAnimState:Vt,getLightningAnimState:Fe,getFireAnimState:Bn,handleSpellButtonClick:Pt,isTransmuteSelecting:()=>Et==="selecting_source",isLightningSelecting:()=>Q==="selecting_source"}}var Di={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Lo(e={}){let{canvas:n}=e,r=e.rotDir||1,u=!1,i=0,o=0,c=0,m=0,g=0,f=1,d=null,p=0,L=0,z=0,Y=0,q=0,et=0,gt=0,ue=0,ot=Di;return{get rotDir(){return r},set rotDir(K){r=K},get dragging(){return u},get dragMode(){return d},handlePointerDown(K,xt,we){if(xt.onMagicTap&&xt.onMagicTap(K.clientX,K.clientY))return!0;let Me=performance.now(),te=Me-et,zt=K.clientX-gt,jt=K.clientY-ue,Ut=Math.hypot(zt,jt);return te<=ot.DOUBLE_TAP_MS&&Ut<=ot.DOUBLE_TAP_MAX_DIST?(xt.onDoubleTap&&xt.onDoubleTap(),et=0):(et=Me,gt=K.clientX,ue=K.clientY),u=!0,f=-1,i=K.clientX,o=K.clientY,c=we,m=0,g=0,d=null,p=Me,L=K.clientX,z=K.clientY,Y=p,q=0,n&&n.setPointerCapture(K.pointerId),!1},handlePointerMove(K,xt,we,Me){if(!u)return null;let te=K.clientX-i,zt=K.clientY-o,jt=performance.now();if(Math.abs(te)<ot.DEADZONE_PX&&Math.abs(zt)<ot.DEADZONE_PX)return null;if(!d){let ee=Math.abs(te),Xt=Math.abs(zt);if(zt<0)ee>=ot.DEADZONE_PX&&(d="rotate");else if(Xt>=ee*ot.AXIS_DOMINANCE){if(Xt>=ot.DROP_SWIPE_MIN_DISTANCE){let At=Math.max(1,jt-p);Xt/At*1e3>=ot.DROP_SWIPE_MIN_SPEED?d="drop":d="rotate"}}else ee>=Xt*ot.AXIS_DOMINANCE&&(d="rotate");if(!d)return null}let Ut=null;if(d==="rotate"&&Math.abs(te)>=ot.DEADZONE_PX){let ee=Math.max(1,jt-Y),Xt=K.clientX-L,At=Math.max(1,Math.abs(Xt)/ee*1e3),l=Math.max(ot.MIN_ROT_PX,Math.min(ot.MAX_ROT_PX,ot.PX_PER_STEP*(ot.SWIPE_SPEED_REF/At)));q+=-Xt/l*r*f;let nt=Math.trunc(q);nt!==0&&(q-=nt);let j=m+nt;if(j!==m&&xt.canRotateTo){let de=Math.sign(j-m),Qt=c+m;for(;m!==j;){let He=m+de,$e=c+He;if(!xt.canRotateTo(Math.floor(we),$e))break;m=He,Qt=$e,Me&&xt.onGroundedMove&&xt.onGroundedMove()}Ut={targetRot:Qt,rotFloat:Qt}}}if(d==="drop"&&zt>ot.DEADZONE_PX&&xt.onDrop){let ee=Math.max(1,jt-Y),Xt=K.clientY-z,At=Math.max(1,Xt/ee*1e3),l=Math.max(ot.MIN_DROP_PX,Math.min(ot.MAX_DROP_PX,ot.PX_PER_DROP*(ot.SWIPE_SPEED_REF/At))),nt=Math.trunc(zt/l);if(nt>g){let j=nt-g;for(let de=0;de<j;de++)xt.onDrop();g=nt}}return L=K.clientX,z=K.clientY,Y=jt,Ut},handlePointerUp(K){if(u&&(u=!1,d=null,n&&K&&K.pointerId!==void 0))try{n.releasePointerCapture(K.pointerId)}catch{}},reset(){u=!1,d=null,m=0,g=0,q=0}}}var Bs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ro(){let e="intro",n=0,r=0,u=0,i=0,o=0,c={...Bs};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return r},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),u=0,i=0,o=0,c={...Bs}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(o+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(m){n+=m},setScore(m){n=m},updateTime(){e==="playing"&&r>0&&(u=performance.now()-r-o)},getFormattedTime(){let m=Math.floor(u/1e3),g=Math.floor(m/60),f=m%60;return`${g}:${f.toString().padStart(2,"0")}`},incrementStat(m,g=1){m in c&&(c[m]+=g)},updateMaxStat(m,g){m in c&&g>c[m]&&(c[m]=g)},reset(){e="intro",n=0,r=0,u=0,i=0,o=0,c={...Bs}}}}function Tn(e,n){return e%=n,e<0&&(e+=n),e}function Ao(e,n){return e[Math.min(n,e.length-1)]}function rs(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),u=n%60;return`${r}:${u.toString().padStart(2,"0")}`}function Io(e,n){let r=e.map(({x:m,y:g},f)=>({x:g,y:-m,color:n[f]})),u=1/0,i=-1/0,o=1/0;for(let m of r)u=Math.min(u,m.x),i=Math.max(i,m.x),o=Math.min(o,m.y);let c=Math.round((u+i)/2);for(let m of r)m.x-=c,m.y-=o;return r.sort((m,g)=>m.y-g.y||m.x-g.x),{cells:r.map(m=>({x:m.x,y:m.y})),colors:r.map(m=>m.color)}}function Ls(e,n,r,u){let i=[];return e+1<r&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:Tn(n-1,u)}),i.push({y:e,s:Tn(n+1,u)}),i}function wo(e,n,r){let u=Array.from({length:n},()=>new Uint8Array(r)),i=[];for(let o=0;o<n;o++)for(let c=0;c<r;c++){if(!e[o][c]||u[o][c])continue;let m=[],g=[{y:o,s:c}];for(u[o][c]=1;g.length>0;){let f=g.shift();m.push(f);for(let d of Ls(f.y,f.s,n,r))e[d.y][d.s]&&!u[d.y][d.s]&&(u[d.y][d.s]=1,g.push(d))}i.push(m)}return i}function Po(e){return e.some(n=>n.y===0)}function Rs(e,n,r,u,i,o){if(!e)return!1;let c=Tn(r,o);for(let m of e.cells){let g=n+m.y,f=Tn(c+m.x,o);if(g<0)return!1;if(!(g>=i)&&u[g][f])return!1}return!0}function ko(e,n,r,u,i,o){if(!e)return null;let c=Math.floor(n);for(;Rs(e,c-1,r,u,i,o);)c-=1;return c}function Oo(e,n,r){let u=[],i=[];for(let o=0;o<n;o++){let c=[],m=0,g=e[o][0],f=g?1:0;for(let d=1;d<=r;d++){let p=d<r?e[o][d]:0;p&&p===g?f++:(f>=1&&g&&c.push({start:m,length:f,color:g}),m=d,g=p,f=p?1:0)}if(c.length>=2){let d=c[0],p=c[c.length-1];if(d.start===0&&p.start+p.length===r&&d.color===p.color){let L=d.length+p.length;c[0]={start:p.start,length:L,color:d.color},c.pop()}}for(let d of c)if(d.length>=3){let p=[];for(let L=0;L<d.length;L++)p.push({y:o,s:(d.start+L)%r});u.push({color:d.color,length:d.length,cells:p})}}for(let o=0;o<r;o++){let c=0,m=e[0][o],g=m?1:0;for(let f=1;f<=n;f++){let d=f<n?e[f][o]:0;if(d&&d===m)g++;else{if(g>=3&&m){let p=[];for(let L=0;L<g;L++)p.push({y:c+L,s:o});u.push({color:m,length:g,cells:p})}c=f,m=d,g=d?1:0}}}for(let o=0;o<n;o++)for(let c=0;c<r;c++){let m=e[o][c],g=e[o][(c+1)%r],f=e[o][(c+2)%r],d=e[o][(c+3)%r];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:o,s:c},{y:o,s:(c+1)%r},{y:o,s:(c+2)%r},{y:o,s:(c+3)%r}]})}for(let o=0;o<r;o++)for(let c=0;c<n-3;c++){let m=e[c][o],g=e[c+1][o],f=e[c+2][o],d=e[c+3][o];m&&m===g&&f&&f===d&&m!==f&&i.push({cells:[{y:c,s:o},{y:c+1,s:o},{y:c+2,s:o},{y:c+3,s:o}]})}return{lineMatches:u,pairMatches:i}}function Do(e,n,r){let u=[];for(let i=0;i<n;i++){let o=!0;for(let c=0;c<r;c++)if(!e[i][c]){o=!1;break}o&&u.push(i)}return u}function Ho(e,n){let r=new Map;e.forEach((u,i)=>r.set(`${u.x},${u.y}`,n[i]));for(let u=0;u<e.length;u++){let i=e[u],o=n[u],c=1;for(let et=1;et<=2&&r.get(`${i.x+et},${i.y}`)===o;et++)c++;if(c>=3)return!0;let m=1;for(let et=1;et<=2&&r.get(`${i.x},${i.y+et}`)===o;et++)m++;if(m>=3)return!0;let g=o,f=r.get(`${i.x+1},${i.y}`),d=r.get(`${i.x+2},${i.y}`),p=r.get(`${i.x+3},${i.y}`);if(g&&f&&d&&p&&g===f&&d===p&&g!==d)return!0;let L=o,z=r.get(`${i.x},${i.y+1}`),Y=r.get(`${i.x},${i.y+2}`),q=r.get(`${i.x},${i.y+3}`);if(L&&z&&Y&&q&&L===z&&Y===q&&L!==Y)return!0}return!1}function $o(e){let{getN:n,getH:r,FALL_INTERVAL:u,LOCK_DELAY_SEC:i,getKillRate:o,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:m,RING_HIGHLIGHT_SEC:g,getState:f,setState:d,funcs:p,ui:L}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(z,Y={}){let q=f();if(z==="start_game")return q.gameState!=="playing"?(p.startGame(),!0):!1;if(q.gameState!=="playing")return!1;switch(z){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:et}=Y;return typeof et=="number"&&p.canPlaceAtRot(Math.floor(q.pieceY),et)?(d({targetRot:et,rotFloat:et,rotVel:0}),q.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:et,y:gt}=Y;return p.shootMagic(et,gt)}case"select_magic":{let{element:et}=Y;return p.selectMagic(et),!0}default:return console.warn("GameEngine: unknown command",z),!1}},update(z,Y){let q=f();if(q.gameState!=="playing")return;let et=Y-q.startTime-q.totalPausedMs;d({elapsedMs:et}),L.updateTimeHud();let gt=q.killLevel+o()*z;if(d({killLevel:gt}),L.updateRemainingHud(),gt>=r()){p.endGame();return}if(q.isHighlighting){let K=(Y-q.highlightStartTime)/1e3,xt;q.isRingAnimation?xt=g:q.isMagicAnimation?xt=m:xt=c,K>=xt&&(q.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ue=q.fallTimer+z;if(ue>=u&&(ue-=u,p.tryMoveDown()),d({fallTimer:ue}),p.updateGroundedState()){let K=q.lockTimer+z;d({lockTimer:K}),K>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(z,Y){return p.canPlaceAtRot(z,Y)},getRotation(){let z=f();return{targetRot:z.targetRot,rotFloat:z.rotFloat,rotVel:z.rotVel}},setRotation(z){d({targetRot:z,rotFloat:z,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var De=Math.PI*2;function Fo(e){let{canvas:n,canvasCtx:r,getN:u,getH:i,TOP_PAD_PX:o,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:m,MAX_RADIUS_X:g,RADIUS_X_FACTOR:f,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:L,MAGIC_SHRINK_SEC:z,RING_HIGHLIGHT_SEC:Y,LOCK_DELAY_SEC:q,getKillRate:et,ELEMENT_COLORS:gt,ELEMENT_TO_COLOR:ue,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:K,ACTIVE_COLOR_FRONT:xt,GHOST_COLOR_FILL:we,GHOST_COLOR_STROKE:Me,GHOST_STROKE_WIDTH:te,MAGIC_DIM_DOT_ALPHA:zt,MAGIC_DIM_DOT_SCALE:jt,MAGIC_TARGET_DOT_SCALE:Ut,getState:ee,getVisualSettings:Xt,funcs:At}=e,l=r,nt=u(),j=i(),de={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},Qt=[],He=40;function $e($,C,b,A,w){let y=Math.max(3,Math.round($)),R=180;for(let J=0;J<y;J++)setTimeout(()=>{let mt=Math.random()>.5?"left":"right",H=15,E=mt==="left"?H+Math.random()*Math.max(10,C-H*2):b+H+Math.random()*Math.max(10,w-b-H*2),x=A-10;Qt.push({x:E,baseX:E,y:x,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:H,maxX:w-H})},J*R)}function hn($,C,b){Qt=Qt.filter(A=>A.y>$+A.size&&A.y>-20);for(let A of Qt){A.y-=He*b,A.wobble+=A.wobbleSpeed*b;let w=A.baseX+Math.sin(A.wobble)*A.wobbleAmp;A.x=Math.max(A.minX,Math.min(A.maxX,w))}}function _n($){if(Qt.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let C of Qt)C.y<$+C.size||(l.beginPath(),l.arc(C.x,C.y,C.size,0,Math.PI*2),l.fill(),l.stroke())}}let Et={left:0,right:0,h:0,w:0};function it($,C,b){let A=1-b/j;return $+A*C}function ne($){return $=$%nt,$<0?$+nt:$}function Zt($,C,b,A,w,y){let R=ne(y),J=(w-R)/nt*De+d;return{x:$+Math.cos(J)*b,y:C+Math.sin(J)*A,ang:J}}let Jt=.52,je=1.02;function Tt($,C,b,A,w,y){let R=ne(y),J=(w-R)/nt*De+d;return{x:$+Math.cos(J)*b,y:C+Math.sin(J)*A,ang:J}}function Xe($,C,b,A,w,y,R,J=1){let mt=Tt($,C,b,A,w-Jt,y),H=Tt($,C,b,A,w+Jt,y),E={x:mt.x,y:mt.y-R*.5},x={x:mt.x,y:mt.y+R*.5},_={x:H.x,y:H.y-R*.5},Mt={x:H.x,y:H.y+R*.5},M=(E.x+_.x+Mt.x+x.x)*.25,bt=(E.y+_.y+Mt.y+x.y)*.25,O=je*J,fe=J,vt=[E,_,Mt,x].map(oe=>({x:M+(oe.x-M)*O,y:bt+(oe.y-bt)*fe})),Lt=Math.abs((H.x-mt.x)*O),se=Math.abs(R*fe);return{corners:vt,cx:M,cy:bt,wApprox:Lt,hApprox:se,ang:Tt($,C,b,A,w,y).ang}}function Q($,C,b,A,w,y,R,J,mt=1,H=null,E=1,x=null,_=0,Mt=1,M=1){let bt=Xe($,C,b,A,w,y,R,M),[O,fe,vt,Lt]=bt.corners;if(l.save(),l.globalAlpha=mt,l.fillStyle=J,l.beginPath(),l.moveTo(O.x,O.y),l.lineTo(fe.x,fe.y),l.lineTo(vt.x,vt.y),l.lineTo(Lt.x,Lt.y),l.closePath(),l.fill(),x&&_>0&&(l.strokeStyle=x,l.lineWidth=_,l.stroke()),H){let se=Math.min(bt.wApprox,bt.hApprox)*.28*Mt;l.globalAlpha=mt*E,l.fillStyle=H,l.beginPath(),l.arc(bt.cx,bt.cy,se,0,De),l.fill()}l.restore(),l.globalAlpha=1}function xe($,C,b,A,w,y){let R=Zt($,C,b,A,w,y),J=Zt($,C,b,A,w+1,y),mt=Zt($,C,b,A,w-1,y),H=Math.abs(J.x-R.x),E=Math.abs(R.x-mt.x),x=(H+E)*.5*1.06;return Math.max(1,x)}function be($,C,b,A,w,y){let R=(w-y)/nt*De+d;return{x:$+Math.cos(R)*b,y:C+Math.sin(R)*A,ang:R}}function Yt($,C,b,A,w,y,R,J=1,mt=null,H=1,E=null,x=0,_=1){l.save(),l.translate($,C);let Mt=Math.atan2(A,b);if(l.rotate(Mt),l.globalAlpha=J,l.fillStyle=R,l.fillRect(-w/2,-y/2,w,y),E&&x>0&&(l.strokeStyle=E,l.lineWidth=x,l.strokeRect(-w/2,-y/2,w,y)),mt){let M=Math.min(w,y)*.28*_;l.globalAlpha=J*H,l.fillStyle=mt,l.beginPath(),l.arc(0,0,M,0,De),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let $=Math.max(1,Math.min(2,window.devicePixelRatio||1)),C=Math.floor(n.clientWidth*$),b=Math.floor(n.clientHeight*$);(n.width!==C||n.height!==b)&&(n.width=C,n.height=b,l.setTransform($,0,0,$,0,0))},render($=.016,C=performance.now()){this.resize();let b=ee();nt=u(),j=i();let A=n.clientWidth,w=n.clientHeight;l.clearRect(0,0,A,w),l.fillStyle="#0b0f14",l.fillRect(0,0,A,w);let y=A*.5,R=(A-2*m)/2,J=w-o-c,mt=6,H=nt*J/(mt*j),E,x,_,Mt;Mt=w-c,H<=Math.min(R,g)?(E=H,x=J,_=o):(E=Math.min(R,g),x=E*mt*j/nt,_=Mt-x);let M=E*.28,{killLevel:bt,rotFloat:O,grid:fe,gameState:vt}=b,Lt=Xt?Xt():{},se=Lt.waterColor||"blue",oe=Lt.waterBubbles||!1,yn=de[se]||de.blue,Vt=it(_,x,bt),fn=.7,k=bt/j,ct={...yn.top},st={...yn.bottom};if(k>fn){let B=(k-fn)/(1-fn);ct.r=Math.round(ct.r+(255-ct.r)*B*.5),ct.g=Math.round(ct.g+(150-ct.g)*B*.5),ct.b=Math.round(ct.b+(150-ct.b)*B*.5),st.r=Math.round(st.r+(180-st.r)*B),st.g=Math.round(st.g*(1-B*.6)),st.b=Math.round(st.b*(1-B*.6))}let yt=y-E-8,ve=y+E+8,Pe=_,ge=Mt+5,Qe=l.createLinearGradient(0,Vt,0,w);Qe.addColorStop(0,`rgba(${ct.r},${ct.g},${ct.b},0.5)`),Qe.addColorStop(1,`rgba(${st.r},${st.g},${st.b},0.7)`),l.fillStyle=Qe;let Fe=Math.round((ct.r+st.r)/2),ut=Math.round((ct.g+st.g)/2),Wt=Math.round((ct.b+st.b)/2),Sn=E+8,Bn=M+4;l.fillRect(0,Vt,yt,w-Vt),l.fillRect(ve,Vt,A-ve,w-Vt),l.beginPath();let Ze=Math.max(Vt,ge);l.moveTo(yt,Ze),Vt<=ge+Bn?l.ellipse(y,ge,Sn,Bn,0,Math.PI,0,!1):l.lineTo(ve,Ze),l.lineTo(ve,w),l.lineTo(yt,w),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(yt,Pe),l.lineTo(yt,ge),l.stroke(),l.beginPath(),l.moveTo(ve,Pe),l.lineTo(ve,ge),l.stroke(),l.beginPath(),l.ellipse(y,ge,E+8,M+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(y,ge,E+8,M+4,0,0,De),l.fill(),bt>.5&&(l.strokeStyle=`rgba(${Math.min(255,Fe+60)},${Math.min(255,ut+40)},${Math.min(255,Wt+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Vt),l.lineTo(yt,Vt),l.moveTo(ve,Vt),l.lineTo(A,Vt),l.stroke()),Et={left:yt,right:ve,h:w,w:A},(Qt.length>0||oe)&&(hn(Vt,w,$),_n(Vt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let Pt=De*E,gn=10,Ye=Pt/gn*.7,$n=Pt/gn*.3;l.setLineDash([Ye,$n]);let Fn=Pt/nt;l.lineDashOffset=ne(O)*Fn;for(let B=0;B<=j;B++){let D=it(_,x,B);l.beginPath(),l.ellipse(y,D,E,M,0,0,De),l.stroke()}l.setLineDash([]);let h=[],I=[];for(let B=0;B<j;B++){let D=it(_,x,B+.5);for(let W=0;W<nt;W++){let F=fe[B][W];if(!F)continue;let V=Zt(y,D,E,M,W,O),U=Math.sin(V.ang),P={y:B,s:W,yScr:D,p:V,depth:U,color:F};U<-.1?h.push(P):I.push(P)}}let v=At.getMagicTargetColor(),{isHighlighting:dt,highlightedCells:pt,highlightStartTime:_t,isMagicAnimation:me}=b,Gt=null,Dt=1,Ce=1,ln=!1;if(dt&&pt.length>0){Gt=new Set(pt.map(D=>`${D.y},${D.s}`));let B=(performance.now()-_t)/1e3;if(me){let D=Math.min(1,B/z);Dt=1-D*.85,Ce=1-D*.9,ln=!0}else{let D=Math.min(1,B/p),W=1-L;if(D>W){let F=(D-W)/L;Dt=1-F*.85,Ce=1-F*.9,ln=!0}}}h.sort((B,D)=>B.depth-D.depth);for(let B of h){let D=x/j*.9,W=gt[B.color]||null,F=.35,V=1,U=`${B.y},${B.s}`;Gt&&Gt.has(U)&&(F*=Ce,V=Dt),Q(y,B.yScr,E,M,B.s,O,D,K,F,W,.5,null,0,1,V)}let{isRingAnimation:Te}=b;if(dt&&pt.length>0&&!me){let B=(performance.now()-_t)/1e3,W=Math.min(1,B/(Te?Y:p)),F=1-L,V=W>F,U=V?(W-F)/L:0,P=Te?Math.floor(W*F*nt*2)%nt:-1,T=4+W/F*10,G=Math.sin(B*T*De),Z=V?1:.3+G*.3,tt=V?1-U*.8:1,St=V?1-U:1;for(let lt of pt){let Rt=it(_,x,lt.y+.5),ye=Tt(y,Rt,E,M,lt.s,O);if(Math.sin(ye.ang)>=-.1)continue;let wt=x/j*.9,N,Kt,Re;if(Te){let We=(lt.s-P+nt)%nt,Ae=We<3?1-We/3:0;N=(V?St:.2+Ae*.5)*.5,Kt=`rgba(255, 159, 67, ${N})`,Re=V?tt:1+Ae*.15}else N=Z*St,Kt=lt.isLine?`rgba(255, 255, 255, ${N*.5})`:`rgba(255, 220, 100, ${N*.4})`,Re=V?tt:1.1;Q(y,Rt,E,M,lt.s,O,wt,Kt,1,null,1,null,0,1,Re)}}I.sort((B,D)=>B.depth-D.depth);for(let B of I){let D=x/j*.9,W=gt[B.color]||null,F=1,V=1,U=1,P=1,T=`${B.y},${B.s}`,G=Gt&&Gt.has(T);G&&(F=Ce,V=Dt),v!==null&&!G&&(B.color!==v?(U=zt,P=jt):P=Ut),Q(y,B.yScr,E,M,B.s,O,D,ot,F,W,U,null,0,P,V)}if(dt&&pt.length>0&&!me){let B=(performance.now()-_t)/1e3,W=Math.min(1,B/(Te?Y:p)),F=1-L,V=W>F,U=V?(W-F)/L:0,P=Te?Math.floor(W*F*nt*2)%nt:-1,T=4+W/F*10,G=Math.sin(B*T*De),Z=V?1:.5+G*.5,tt=V?1-U*.8:1,St=V?1-U:1;for(let lt of pt){let Rt=it(_,x,lt.y+.5),ye=Tt(y,Rt,E,M,lt.s,O);if(Math.sin(ye.ang)<-.1)continue;let wt=x/j*.9,N,Kt,Re;if(Te){let We=(lt.s-P+nt)%nt,Ae=We<4?1-We/4:0;N=V?St:.3+Ae*.7,Kt=`rgba(255, 159, 67, ${N})`,Re=V?tt:1+Ae*.2}else N=Z*St,Kt=lt.isLine?`rgba(255, 255, 255, ${N*.7})`:`rgba(255, 220, 100, ${N*.6})`,Re=V?tt:1.15;Q(y,Rt,E,M,lt.s,O,wt,Kt,1,null,1,null,0,1,Re)}}let ie=b.spellState||b,{transmuteState:kt,transmuteSourceBlock:pe,transmuteTargetColor:Ve,transmuteAreaCells:an,transmuteBlocksToChange:_e}=ie;if(kt==="selecting_source"){let B=x/j*.9,D=.35+Math.sin(C/150)*.15;for(let W of I){let F=it(_,x,W.y+.5);Q(y,F,E,M,W.s,O,B,`rgba(0, 40, 20, ${D})`,1,null,1,null,0,1,1)}}if(kt==="selecting_target"&&_e&&_e.length>0){let B=x/j*.9,D=.4+Math.sin(C/120)*.25,W=.6+Math.sin(C/120)*.4;for(let F of _e){if(F.y<0||F.y>=j)continue;let V=it(_,x,F.y+.5),U=Tt(y,V,E,M,F.s,O);Math.sin(U.ang)<-.1||(Q(y,V,E,M,F.s,O,B,`rgba(0, 50, 30, ${D})`,1,null,1,null,0,1,1),Q(y,V,E,M,F.s,O,B,"transparent",1,null,1,`rgba(100, 255, 150, ${W})`,3,1,1.02))}}if(kt==="animating"&&At.getTransmuteAnimState){let B=At.getTransmuteAnimState(C);if(B){let D=x/j*.9,{phase:W,progress:F,areaFlash:V}=B;if(V>0&&an)for(let U of an){if(U.y<0||U.y>=j)continue;let P=it(_,x,U.y+.5),T=Tt(y,P,E,M,U.s,O);Math.sin(T.ang)<-.1||Q(y,P,E,M,U.s,O,D,`rgba(150, 255, 200, ${V*.4})`,1,null,1,null,0,1,1)}if(_e&&_e.length>0){let U=pe?pe.color:1,P=Ve||1;for(let T of _e){if(T.y<0||T.y>=j)continue;let G=it(_,x,T.y+.5),Z=Tt(y,G,E,M,T.s,O);if(Math.sin(Z.ang)<-.1)continue;let St=1,lt=gt[U],Rt=0;if(W==="shrink"?(St=1-F*.95,lt=gt[U],Rt=.5+F*.3):W==="grow"&&(St=F,lt=gt[P],Rt=.8-F*.5),Rt>0&&Q(y,G,E,M,T.s,O,D,`rgba(200, 255, 220, ${Rt})`,1,null,1,null,0,1,1),St>.05){let ye=Xe(y,G,E,M,T.s,O,D,1),nn=Math.min(ye.wApprox,ye.hApprox)*.28*St;l.save(),l.globalAlpha=1,l.fillStyle=lt,l.beginPath(),l.arc(ye.cx,ye.cy,nn,0,De),l.fill(),l.restore()}}}}}let{lightningState:Je,lightningSourceBlock:mn,lightningAreaCells:ce,lightningBlocksToHit:he}=ie;if(Je==="selecting_source"){let B=x/j*.9,D=.35+Math.sin(C/150)*.15;for(let W of I){let F=it(_,x,W.y+.5);Q(y,F,E,M,W.s,O,B,`rgba(20, 20, 60, ${D})`,1,null,1,null,0,1,1)}}if(Je==="animating"&&At.getLightningAnimState){let B=At.getLightningAnimState(C);if(B&&he&&he.length>0){let D=x/j*.9,{phase:W,flashProgress:F,currentTarget:V,jumpProgress:U,struckTargets:P}=B;if(W==="flash"&&F>0&&ce)for(let T of ce){if(T.y<0||T.y>=j)continue;let G=it(_,x,T.y+.5),Z=Tt(y,G,E,M,T.s,O);Math.sin(Z.ang)<-.1||Q(y,G,E,M,T.s,O,D,`rgba(100, 150, 255, ${F*.5})`,1,null,1,null,0,1,1)}if(P&&P.length>0)for(let T of P){let G=he[T];if(!G||G.y<0||G.y>=j)continue;let Z=it(_,x,G.y+.5),tt=Tt(y,Z,E,M,G.s,O);if(Math.sin(tt.ang)<-.1)continue;let lt=(P.length-1-P.indexOf(T))*.1,Rt=Math.max(0,.8-lt);Q(y,Z,E,M,G.s,O,D,`rgba(255, 255, 255, ${Rt})`,1,null,1,`rgba(150, 200, 255, ${Rt})`,2,1,1.05)}if(W==="chain"&&V>=0&&V<he.length){let T=he[V];if(T&&T.y>=0&&T.y<j){let G=it(_,x,T.y+.5),Z=Tt(y,G,E,M,T.s,O);if(Math.sin(Z.ang)>=-.1){let St=1-U;Q(y,G,E,M,T.s,O,D,`rgba(200, 220, 255, ${St*.9})`,1,null,1,`rgba(100, 180, 255, ${St})`,3,1,1.1-U*.05)}}if(V>0){let G=he[V-1],Z=he[V];if(G&&Z){let tt=it(_,x,G.y+.5),St=it(_,x,Z.y+.5),lt=Xe(y,tt,E,M,G.s,O,D,1),Rt=Xe(y,St,E,M,Z.s,O,D,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-U*.5})`,l.lineWidth=2+(1-U)*2,l.lineCap="round",l.beginPath();let ye=lt.cx,nn=lt.cy,wt=Rt.cx,N=Rt.cy;l.moveTo(ye,nn);let Kt=4;for(let Re=1;Re<=Kt;Re++){let We=Re/Kt,Ae=ye+(wt-ye)*We,Gn=nn+(N-nn)*We,Ke=Re<Kt?(Math.random()-.5)*8:0;l.lineTo(Ae+Ke,Gn+Ke)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-U)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:Be,fireSourceBlock:Ge,fireLineCells:tn,fireTargets:Ht}=ie;if(Be==="selecting_source"){let B=x/j*.9,D=.3+Math.sin(C/140)*.2;for(let W of I){let F=it(_,x,W.y+.5);Q(y,F,E,M,W.s,O,B,`rgba(70, 25, 10, ${D})`,1,null,1,null,0,1,1)}}if(Be==="animating"&&At.getFireAnimState){let B=At.getFireAnimState(C);if(B&&tn&&tn.length>0){let D=x/j*.9,{progress:W,flashProgress:F}=B,V=Math.sin(W*Math.PI);if(F>0)for(let U of tn){if(U.y<0||U.y>=j)continue;let P=it(_,x,U.y+.5),T=Tt(y,P,E,M,U.s,O);Math.sin(T.ang)<-.1||Q(y,P,E,M,U.s,O,D,`rgba(255, 120, 50, ${F*.45})`,1,null,1,`rgba(255, 200, 140, ${F*.5})`,2,1,1.03)}if(Ge){let U=new Map;for(let T of tn){if(T.y<0||T.y>=j)continue;let G=it(_,x,T.y+.5),Z=Tt(y,G,E,M,T.s,O);if(Math.sin(Z.ang)<-.1)continue;let St=Xe(y,G,E,M,T.s,O,D,1),lt=T.s-Ge.s;lt>nt/2&&(lt-=nt),lt<-nt/2&&(lt+=nt);let Rt=T.y;U.has(Rt)||U.set(Rt,[]),U.get(Rt).push({x:St.cx,y:St.cy,offset:lt})}let P=Array.from(U.keys()).sort((T,G)=>G-T);if(P.length>0){let T=.35+.3*Math.sin(C/60)+V*.2;l.save(),l.lineCap="round";for(let G of P){let Z=U.get(G)||[];if(Z.sort((tt,St)=>tt.offset-St.offset),Z.length!==0){l.beginPath(),l.moveTo(Z[0].x,Z[0].y);for(let tt=1;tt<Z.length;tt++)l.lineTo(Z[tt].x,Z[tt].y);l.strokeStyle=`rgba(255, 140, 60, ${T})`,l.lineWidth=Math.max(2,D*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${T*.35})`,l.lineWidth=Math.max(6,D*.35),l.stroke()}}l.restore()}}if(Ht&&Ht.length>0){let U=.2+V*.6;for(let P of Ht){if(P.y<0||P.y>=j)continue;let T=it(_,x,P.y+.5),G=Tt(y,T,E,M,P.s,O);Math.sin(G.ang)<-.1||Q(y,T,E,M,P.s,O,D,`rgba(255, 160, 70, ${U})`,1,null,1,`rgba(255, 230, 180, ${V*.6})`,2,1,1.05)}}}}let{activePiece:Le,pieceY:$t,isGrounded:ke,lockTimer:en}=b;if(Le){let B=At.snappedRot(),D=B,W=At.computeGhostY(),F=x/j*.9;if(W!==null){let P=[];for(let T=0;T<Le.cells.length;T++){let G=Le.cells[T],Z=Le.colors[T],tt=W+G.y,St=At.normSector(B+G.x);if(tt<0||tt>=j)continue;let lt=it(_,x,tt+.5),Rt=Tt(y,lt,E,M,St,D);P.push({cy:tt,cs:St,yScr:lt,depth:Math.sin(Rt.ang),color:Z})}P.sort((T,G)=>T.depth-G.depth);for(let T of P){let G=gt[T.color]||null;Q(y,T.yScr,E,M,T.cs,D,F,we,1,G,.5,Me,te,1,1)}}let V=xt;if(ke&&en>0){let P=Math.min(1,en/q),T=255,G=Math.round(170+85*P),Z=Math.round(180+75*P),tt=.75+(1-.75)*P;V=`rgba(${T},${G},${Z},${tt})`}let U=[];for(let P=0;P<Le.cells.length;P++){let T=Le.cells[P],G=Le.colors[P],Z=At.normSector(B+T.x),tt=$t+T.y;if(tt<0||tt>=j)continue;let St=it(_,x,tt+.5),lt=Tt(y,St,E,M,Z,D);U.push({cs:Z,yScr:St,depth:Math.sin(lt.ang),color:G})}U.sort((P,T)=>P.depth-T.depth);for(let P of U){let T=gt[P.color]||null;Q(y,P.yScr,E,M,P.cs,D,F,V,1,T,1,null,0,1,1)}}},drawNextPreview($,C){if(!$)return;let b=$.getContext("2d"),A=$.width,w=$.height;if(b.clearRect(0,0,A,w),!C)return;let y=1/0,R=-1/0,J=1/0,mt=-1/0;for(let M of C.cells)y=Math.min(y,M.x),R=Math.max(R,M.x),J=Math.min(J,M.y),mt=Math.max(mt,M.y);let H=R-y+1,E=mt-J+1,x=Math.min(A/(H+.5),w/(E+.5)),_=(A-H*x)/2,Mt=(w-E*x)/2;b.fillStyle=ot;for(let M=0;M<C.cells.length;M++){let bt=C.cells[M],O=_+(bt.x-y)*x,fe=Mt+(E-1-(bt.y-J))*x;b.fillRect(O+1,fe+1,x-2,x-2);let vt=C.colors[M],Lt=gt[vt];if(Lt){let se=(x-2)*.32;b.fillStyle=Lt,b.beginPath(),b.arc(O+x/2,fe+x/2,se,0,De),b.fill(),b.fillStyle=ot}}},spawnBonusBubbles($){let{left:C,right:b,h:A,w}=Et;w>0&&$e($,C,b,A,w)}}}(()=>{let e=Mo(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,i=30,o=24,c=120,m={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:180,name:"Quick Tower"}};function g(t){let s=m[t]||m["30_24"];i=s.N,o=s.H,c=s.survivalTime}function f(){return o/c}let d=Math.PI/2,p=70,L=120,z=30,Y=320,q=.42,et="rgb(235,240,250)",gt="rgb(55,62,75)",ue="rgba(255,170,180,0.75)",ot="rgba(110,255,150,0.15)",K="rgba(110,255,150,0.85)",xt=2,we={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Me={1:"fire",2:"water",3:"lightning",4:"earth"},te={fire:1,water:2,lightning:3,earth:4},zt=1,jt=.58,Ut=!0,ee=12,Xt=25,At=1,l=2,nt=3,j=5,de=8,Qt=10,He=15,$e=30,hn=2,_n=.3,Et=.5,it=1,ne=.3,Zt=.5,Jt=1.3,je=10,Tt=500,Xe=[1,1.25,1.5,1.75,2],Q=10,xe=100,be=25,Yt=[1,1.3,1.6,2],$=[1,1.5,2,2.5],C=Eo(),b=C.loadGameSettings(),A=b.invertSwipe?-1:1,w=b.magicEnabled??!1,y=-1,R=Array.from({length:o},()=>new Uint8Array(i));function J(){R=Array.from({length:o},()=>new Uint8Array(i))}let mt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],H=null,E=o+3,x=0,_=0,Mt=!1,M=0,bt=0,O=0,fe=3,vt=0,Lt=0,se=0,oe=Lo({canvas:n,rotDir:A}),yn="0.16.1",Vt=!0,fn="blue",k=mo();k.preload();let ct=Ro(),st="intro",yt=0,ve=0,Pe=0,ge=0,Qe=0,Fe=null,ut=ct.stats,Wt=0,Sn=e.overlay,Bn=e.gameContainer,Ze=bo({elementColors:we}),Pt=Ze.showBonus.bind(Ze),gn=Ze.getElementIcon.bind(Ze),Ye=vo(),$n=e.overlayTitle,Fn=e.overlayStats,h=e.startBtn,I=e.hud,v=e.scoreHud,dt=e.timeHud,pt=e.remainingHud,_t=e.nextCanvas,me=_t.getContext("2d"),Gt=e.pauseBtn,Dt=e.pauseOverlay,Ce=e.resumeBtn,ln=e.restartBtn,Te=e.exitToMenuBtn,ie=e.pauseSettingsBtn,kt=e.pauseSoundBtn,pe=e.pauseMusicBtn,Ve=e.pauseBestScore,an=e.pauseBestTime,_e=e.pauseBestMode,Je=e.pauseCurrentScore,mn=e.pauseCurrentTime,ce=e.pauseCurrentMode,he=e.confirmDialog,Be=e.confirmText,Ge=e.confirmCancel,tn=e.confirmOk,Ht=e.settingsOverlay,Le=e.settingsClose,$t=e.fullscreenBtn,ke=e.rotateBtn,en=e.startPanel,B=e.gameoverPanel,D=e.goScore,W=e.goTime,F=e.goRing,V=e.goMatches,U=e.goBonuses,P=e.goNewRecord,T=e.goRestartBtn,G=e.goExitBtn,Z=e.bestScore,tt=e.bestTimeVal,St=e.startVersion,lt=e.modeBtns,Rt=e.recordsBtn,ye=e.startSettingsBtn,nn=e.helpBtn,wt="25_20",N=Co({buttons:e.magicBtns,onActivate:()=>k.play("spells"),onChange:(t,s)=>{as()}}),Kt=e.magicBtns,Re=N.charges,We=t=>Se()?N.select(t):!1,Ae=()=>N.updateButtons(),Gn=e.magicRow,Ke=e.magicToggle,qt=e.magicActiveIndicator,As=e.magicActiveIcon,Is=e.magicActiveCost,Go={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ls={fire:"fire",water:"ice",lightning:"air",earth:"earth"},No=["ice","earth","air","fire"];Wt=C.loadHighTowerRings();function Ln(t){return typeof Nt?.getUnlockRings=="function"?Nt.getUnlockRings(t):0}function Nn(t){let s=Ln(t);return s===0||Wt>=s}let ws=["fire","water","lightning","earth"],En=null,Un=!1,Uo=500,Xo=30,Yo=220,Mn=null,Ps={fire:!1,water:!1,lightning:!1,earth:!1};function Rn(t=N.active){if(!qt||!As)return;t?(En=t,Un=!1):Un||(En=null);let s=En;if(!s||!Se()||(N.charges[s]??0)<=0){qt.classList.add("hidden"),qt.classList.remove("active",...ws),qt.style.setProperty("--progress","0%"),Mn&&clearTimeout(Mn),Mn=setTimeout(()=>{qt.classList.add("gone")},Yo);return}Mn&&(clearTimeout(Mn),Mn=null),qt.classList.remove("gone"),qt.classList.contains("hidden")?requestAnimationFrame(()=>qt.classList.remove("hidden")):qt.classList.remove("hidden"),As.textContent=gn(s);let S=ls[s];S&&Nt.selectSpell(S);let X=S?In(S):0,rt=N.charges[s]??0,at=!!S&&Vn()&&Nn(S),Ft=!!S&&Vn()&&!at,Ee=at&&X>0?Math.min(rt/X,1):0,rn=at&&X>0;Is&&(Is.textContent=rn?`-${X}`:Ft?"\u{1F512}":""),qt.classList.toggle("no-cost",!rn&&!Ft),qt.classList.toggle("locked",Ft),qt.style.setProperty("--progress",`${Math.round(Ee*100)}%`),qt.classList.remove("hidden",...ws),qt.classList.add("active",s)}function Vo(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Uo))}function Xn(){for(let[t,s]of Object.entries(Kt)){if(!s)continue;let a=ls[t],S=In(a),X=Vn()&&Se()&&a,rt=typeof Nn=="function"?Nn(a):!0,at=X&&rt&&S>0&&(N.charges[t]??0)>=S;s.classList.toggle("ult-ready",at),at&&!Ps[t]&&(Vo(s),st==="playing"&&k.play("readysuper")),Ps[t]=at}}function Se(t=wt){return t==="30_24"?!0:w}function ks(){Ke&&Ke.classList.toggle("active",w)}function as(){Rn(N.active),Xn()}function Wo(t){w=t,b.magicEnabled=t,C.saveGameSettings(b),wt==="25_20"&&(w?N.reset():(N.deactivate(),Object.keys(N.charges).forEach(s=>{N.charges[s]=0})),Ae()),Yn(),ks(),as()}function Yn(){Gn&&(Gn.style.display=Se()?"":"none",Rn(N.active),Xn())}function $i(t){let s=xn(t),a=In(t);return!s||a<=0?!1:N.charges[s]>=a}function Fi(t){let s=xn(t),a=In(t);return!s||a<=0||N.charges[s]<a?!1:(N.charges[s]-=a,N.updateButtons(),Nt.pulse(),!0)}let An=e.spellWave;function Ko(){An&&(An.classList.remove("active"),An.offsetWidth,An.classList.add("active"),setTimeout(()=>An.classList.remove("active"),1200))}let sn=null,Nt=To({button:qt,onReady:()=>{k.play("readysuper")}}),qo=()=>Nt.getEffect("earth"),zo=()=>Nt.getEffect("air"),jo=()=>Nt.getEffect("fire"),In=t=>typeof Nt?.getCost=="function"?Nt.getCost(t):0,xn=t=>Go[t]??null;sn=Bo({canvas:n,dom:e,getGrid:()=>R,getN:()=>i,getH:()=>o,getRotFloat:()=>vt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:z,MAX_RADIUS_X:Y,SCORE_MAGIC_DESTROY:be},helpers:{normSector:jn,levelYToScreenY:Kn,sectorCenterXY:qn},Spell:Nt,Magic:N,SoundModule:k,State:ct,isGamePlaying:()=>st==="playing",addPendingKzDrop:t=>{O+=t},getKillRate:f,triggerSpellWave:Ko,spawnSpellBubbles:t=>{let s=xn(Nt.currentSpell)??"water";Ye.spawnSpellBubbles(Nt.button,s,t)},spawnBonusBubbles:t=>{Cn.spawnBonusBubbles(t)},getTransmuteEffect:qo,getLightningEffect:zo,getFireEffect:jo,continueMatchProcessing:zn,updateScoreHud:kn,showBonus:Pt,getSpellCost:In,getSpellElement:xn,onUltimateApplied:t=>{let s=xn(t)??xn(Nt.currentSpell)??"water";typeof Ye?.spawnSpellBubbles=="function"&&Ye.spawnSpellBubbles(Nt.button,s,Xo),Un=!1,En=null,Rn(null),Xn()},isSpellBlocked:Qo,setScore:t=>{yt=t},setCascadeLevel:t=>{cn=t}});function Vn(){return wt==="30_24"}function Wn(){Rn(N.active),Xn()}let on=[],wn=0,qe=!1,un=!1,bn=!1,Oe=0,ze=0,cn=0,vn=[];function Qo(){return qe||un||bn}function Kn(t,s,a){let S=1-a/o;return t+S*s}function qn(t,s,a,S,X,rt){let at=(X-rt)/i*u+d;return{x:t+Math.cos(at)*a,y:s+Math.sin(at)*S,ang:at}}function Os(t,s){let a=n.clientWidth,S=n.clientHeight,X=a*.5,rt=(a-2*z)/2,at=S-p-L,Ft=6,Ee=i*at/(Ft*o),rn=S-L,Ne,Ct,ft;Ee<=Math.min(rt,Y)?(Ne=Ee,Ct=at,ft=p):(Ne=Math.min(rt,Y),Ct=Ne*Ft*o/i,ft=rn-Ct);let ht=Ne*.28,It=Kn(ft,Ct,t+.5),Ot=qn(X,It,Ne,ht,s,vt),re=n.getBoundingClientRect();return{x:re.left+Ot.x,y:re.top+Ot.y}}function Zo(t,s){if(!Se()||!N.canUse()||qe)return!1;let a=te[N.active],S=n.clientWidth,X=n.clientHeight,rt=S*.5,at=(S-2*z)/2,Ft=X-p-L,Ee=6,rn=i*Ft/(Ee*o),Ne=X-L,Ct,ft,ht;rn<=Math.min(at,Y)?(Ct=rn,ft=Ft,ht=p):(Ct=Math.min(at,Y),ft=Ct*Ee*o/i,ht=Ne-ft);let It=Ct*.28,Ot=null,re=1/0;for(let le=0;le<o;le++){let Ie=Kn(ht,ft,le+.5);for(let ae=0;ae<i;ae++){let is=R[le][ae];if(!is||is!==a)continue;let Hn=qn(rt,Ie,Ct,It,ae,vt);if(Math.sin(Hn.ang)<-.1)continue;let cs=t-Hn.x,lo=s-Hn.y,ao=Math.hypot(cs,lo),uo=ft/o*.9,Li=uo*1.2;Math.abs(cs)<Li/2&&Math.abs(lo)<uo/2&&ao<re&&(re=ao,Ot={y:le,s:ae})}}if(Ot){let le=Kn(ht,ft,Ot.y+.5),Ie=qn(rt,le,Ct,It,Ot.s,vt),ae=n.getBoundingClientRect(),is=ae.left+Ie.x,Hn=ae.top+Ie.y,ro=Kt[N.active];return Ye.spawnMagicShot(N.active,ro,is,Hn,()=>{let cs=R[Ot.y][Ot.s];on=[{y:Ot.y,s:Ot.s,color:cs,isLine:!1,isMagic:!0}],wn=performance.now(),qe=!0,un=!0,Oe=0,ze=be,Pt(`+${be}`,"score")}),cn=0,N.useCharge(),ut.magicUsed++,!0}return!1}let Gi=100;function Ni(t,s){return Ls(t,s,o,i)}function Jo(){return wo(R,o,i)}let ti=Po;function ei(t){let s=t.map(S=>({...S,color:R[S.y][S.s]}));for(let S of t)R[S.y][S.s]=0;let a=o;for(let S of t){let X=S.y;for(let rt=1;rt<=S.y;rt++){let at=S.y-rt;if(R[at][S.s]){X=rt-1;break}}a=Math.min(a,X)}for(let S of s)R[S.y-a][S.s]=S.color;return a>0}function ni(){let t=!0;for(;t;){t=!1;let s=Jo();for(let a of s)ti(a)||ei(a)&&(t=!0)}}function si(){zn()}let us=Ao;function Ds(t,s){let a=new Map,S=0,X=0,rt=0,at={},Ft=t.length+s.length;for(let ft of t){let ht=Me[ft.color],It=0,Ot=0;if(ft.length>=5?(It=nt,Ot=Qt,ut.lines5++):ft.length===4?(It=l,Ot=de,ut.lines4++):ft.length===3&&(It=At,Ot=j,ut.lines3++),Se()&&ht&&It>0){N.addCharges(ht,It),at[ht]=(at[ht]||0)+It;let re=ft.cells[Math.floor(ft.cells.length/2)],le=Os(re.y,re.s),Ie=Kt[ht];for(let ae=0;ae<It;ae++)setTimeout(()=>{Ye.spawnMagicOrb(ht,le.x,le.y,Ie)},ae*100)}S+=Ot*f(),rt+=Ot,X+=ft.length*Q;for(let re of ft.cells){let le=`${re.y},${re.s}`;a.has(le)||a.set(le,{y:re.y,s:re.s,color:ft.color,isLine:!0})}}for(let ft of s){if(ut.pairs++,S+=He*f(),rt+=He,X+=xe,Se()){let ht=[...new Set(ft.cells.map(It=>R[It.y][It.s]).filter(Boolean))];if(ht.length>0){let It=ft.cells[Math.floor(ft.cells.length/2)],Ot=Os(It.y,It.s);ht.forEach((re,le)=>{let Ie=Me[re];if(!Ie)return;N.addCharges(Ie,1),at[Ie]=(at[Ie]||0)+1;let ae=Kt[Ie];ae&&setTimeout(()=>{Ye.spawnMagicOrb(Ie,Ot.x,Ot.y,ae)},le*100)})}}for(let ht of ft.cells){let It=`${ht.y},${ht.s}`;a.has(It)||a.set(It,{y:ht.y,s:ht.s,color:R[ht.y][ht.s],isLine:!1})}}let Ee=us(Yt,Ft-1),rn=us($,cn),Ne=Math.round(X*Ee*rn),Ct=0;Ft>1&&(ut.combos++,ut.maxCombo=Math.max(ut.maxCombo,Ft),setTimeout(()=>Pt(`COMBO \xD7${Ft}`,"combo"),Ct),Ct+=180,k.play("combo2")),cn>0&&(ut.cascades++,ut.maxCascade=Math.max(ut.maxCascade,cn),setTimeout(()=>Pt(`CASCADE \xD7${cn}`,"cascade"),Ct),Ct+=180,k.play("cascade")),(t.length>0||s.length>0)&&k.play("combo");for(let ft of t){let ht=ft.length,It=ht*Q;setTimeout(()=>Pt(`Line-${ht} +${It}`,"line",ft.color),Ct),Ct+=100}for(let ft of s){let ht=ft.cells.length>0?R[ft.cells[0].y][ft.cells[0].s]:null;setTimeout(()=>Pt(`Pair +${xe}`,"pair",ht),Ct),Ct+=100}Ne>0&&(setTimeout(()=>Pt(`+${Ne}`,"score"),Ct),Ct+=120),rt>0&&(setTimeout(()=>Pt(`+${rt}s`,"time"),Ct),Ct+=120);for(let[ft,ht]of Object.entries(at))ht>0&&(setTimeout(()=>Pt(`+${ht}${gn(ft)}`,"charge"),Ct),Ct+=120);on=Array.from(a.values()),wn=performance.now(),qe=!0,un=!1,Oe=S,ze=Ne,Ae()}function oi(){for(let t of on)R[t.y][t.s]=0;if(on.length>0&&k.playRandom("disappear"),Oe>0){O+=Oe;let t=Oe/f();Cn.spawnBonusBubbles(t)}ct.addScore(ze),yt+=ze,kn(),on=[],qe=!1,un=!1,Oe=0,ze=0,cn++,zn()}function zn(){ni();let{lineMatches:t,pairMatches:s}=mi();if(t.length>0||s.length>0)Ds(t,s);else{let a=Us();a.length>0?di(a):!H&&st==="playing"&&Ns()}}function Ui(t,s){Ds(t,s)}function jn(t){return Tn(t,i)}function Qn(){return jn(Math.round(vt))}function Hs(t,s){return Rs(H,t,s,R,o,i)}function Zn(t){return Hs(t,Qn())}let Jn=Io;function $s(){Ut&&(ee!==0&&M>=ee||(_=0,M+=1))}function ii(){if(!H)return;let t=H.cells,s=H.colors,a={cells:t,colors:s};if(y>=0||(a=Jn(a.cells,a.colors),a=Jn(a.cells,a.colors)),a=Jn(a.cells,a.colors),H.cells=a.cells,H.colors=a.colors,!Zn(Math.floor(E))){H.cells=t,H.colors=s;return}k.play("turn"),Mt&&$s()}function ci(){return ko(H,E,Qn(),R,o,i)}function ri(){if(!H)return!1;let t=Math.floor(E)-1,s=!Zn(t);return s&&!Mt?(Mt=!0,_=0,M=0):!s&&Mt&&(Mt=!1,_=0,M=0),s}let pn=rs;function Pn(){if(st==="playing"){Sn.classList.add("hidden"),Gt.classList.remove("hidden");return}if(Sn.classList.remove("hidden"),Gt.classList.add("hidden"),st==="intro"){en.classList.remove("hidden"),B.classList.add("hidden");let t=C.loadHighscore(wt);t.score>0?(Z.textContent=t.score.toLocaleString(),tt.textContent=pn(t.time)):(Z.textContent="0",tt.textContent="0:00"),bs(),St.textContent=`v${yn}`,h.classList.remove("idlePulse"),h.offsetWidth,h.classList.add("idlePulse")}else{en.classList.add("hidden"),B.classList.remove("hidden"),D.textContent=yt.toLocaleString(),W.textContent=pn(Pe);let t=C.loadHighscore(wt);yt>0&&yt>=t.score?P.classList.remove("hidden"):P.classList.add("hidden");let s=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${ut.rings}</span>
          <span class="count ring-max">${ut.maxRing>0?"max \xD7"+ut.maxRing:""}</span>
        </div>
      `;F.innerHTML=s;let a=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${ut.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${ut.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${ut.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${ut.pairs}</span>
        </div>
      `;V.innerHTML=a;let S=Se()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${ut.magicUsed}</span>
        </div>
      `:"",X=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${ut.combos}</span>
          <span class="count max-combo">${ut.maxCombo>0?"max \xD7"+ut.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${ut.cascades}</span>
          <span class="count max-cascade">${ut.maxCascade>0?"max \xD7"+ut.maxCascade:""}</span>
        </div>
        ${S}
      `;U.innerHTML=X}}function kn(){v.textContent=`Score: ${yt}`}function ds(){dt.textContent=`Time: ${pn(Pe)}`}function Fs(){let t=Math.max(0,(o-bt)/f()),s=Math.floor(t/60),a=Math.floor(t%60);pt.textContent=`Left: ${s}:${a.toString().padStart(2,"0")}`,t<30?pt.classList.add("warning"):pt.classList.remove("warning")}function li(){g(wt),J(),bt=0,O=0,vt=Lt=0,se=0,ct.start(),ut=ct.stats,yt=0,ve=performance.now(),Pe=0,Qe=0,ge=0,st="playing",Fe=null,Se()?N.reset():(N.deactivate(),Object.keys(N.charges).forEach(t=>{N.charges[t]=0}),Ae()),Nt.reset(),Wn(),on=[],vn=[],qe=!1,un=!1,bn=!1,Oe=0,ze=0,cn=0,sn.reset(),Ae(),kn(),ds(),Fs(),as(),Ns(),Cn.drawNextPreview(_t,Fe),Pn(),k.getSettings().musicEnabled&&k.startGameMusic()}function fs(){ct.gameOver(),st="gameover",H=null,Mt=!1,_=0,M=0;let t=C.saveHighscore(yt,Pe,wt);k.stopMusic(),k.play("gameover"),ds(),Pn(),t&&yt>0&&setTimeout(()=>{Pt("\u{1F3C6} NEW RECORD!","score")},500)}function ai(t){for(let a=0;a<50;a++){let S=t.map(()=>1+(Math.random()*4|0));if(!ui(t,S))return S}return t.map((a,S)=>1+S%4)}let ui=Ho;function Gs(t){let s=t.cells.map(S=>({x:S.x,y:S.y})),a=ai(s);return{name:t.name,cells:s,colors:a}}function Ns(){if(!Fe){let X=mt[Math.random()*mt.length|0];Fe=Gs(X)}H=Fe;let t=mt[Math.random()*mt.length|0];Fe=Gs(t),Cn.drawNextPreview(_t,Fe);let s=1/0,a=-1/0;for(let X of H.cells)X.x<s&&(s=X.x),X.x>a&&(a=X.x);let S=(s+a)/2;for(let X of H.cells)X.x=X.x-Math.round(S);E=o+3,x=0,Mt=!1,_=0,M=0,Zn(Math.floor(E))?k.playRandom("appear"):fs()}function Us(){return Do(R,o,i)}function di(t){if(t.length===0)return;let s=[];for(let Ft of t)for(let Ee=0;Ee<i;Ee++)s.push({y:Ft,s:Ee,color:R[Ft][Ee],isLine:!1});vn=t,on=s,wn=performance.now(),qe=!0,bn=!0,un=!1;let a=t.length;ut.rings+=a,ut.maxRing=Math.max(ut.maxRing,a);let S=us(Xe,a-1),X=Math.round(Tt*a*S),rt=$e*a;ze=X,Oe=rt*f(),k.play("ring");let at=`RING \xD7${a}`;Pt(at,"ring"),setTimeout(()=>Pt(`+${X}`,"score"),150),setTimeout(()=>Pt(`+${rt}s`,"time"),300)}function fi(){let t=[...vn].sort((s,a)=>a-s);for(let s of t){for(let a=s;a<o-1;a++)R[a].set(R[a+1]);R[o-1].fill(0)}if(Oe>0){O+=Oe;let s=Oe/f();Cn.spawnBonusBubbles(s)}ct.addScore(ze),yt+=ze,kn(),wt==="30_24"&&vn.length>0&&(Wt=C.addHighTowerRings(vn.length)),on=[],vn=[],qe=!1,bn=!1,Oe=0,ze=0,zn()}function Xi(){return Us().length}function gi(){if(!H)return;let t=Qn();vt=t,Lt=t,se=0;let s=!1;for(let a=0;a<H.cells.length;a++){let S=H.cells[a],X=H.colors[a],rt=Math.floor(E)+S.y,at=jn(t+S.x);rt>=o&&(s=!0),rt>=0&&rt<o&&(R[rt][at]=X)}if(s){fs();return}ct.addScore(je),yt+=je,kn(),Pt(`+${je}`,"score"),k.playRandom("drop"),H=null,cn=0,si()}function mi(){return Oo(R,o,i)}function pi(){if(!H)return!1;let t=Math.floor(E)-1;return Zn(t)?(E=t,Mt=!1,_=0,M=0,!0):(Mt=!0,!1)}n.addEventListener("pointerdown",t=>{if(Bt.state!=="playing")return;t.preventDefault?.();let s=n.getBoundingClientRect(),a=t.clientX-s.left,S=t.clientY-s.top;oe.handlePointerDown(t,{onMagicTap:Se()?()=>sn.handleTap(a,S)?!0:Bt.applyCommand("magic_shoot",{x:a,y:S}):null,onDoubleTap:()=>Bt.applyCommand("rotate_piece")},Lt)||(se=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Bt.state!=="playing"||!oe.dragging)return;t.preventDefault?.();let s=oe.handlePointerMove(t,{canRotateTo:(a,S)=>Bt.canRotateTo(a,S),onDrop:()=>Bt.applyCommand("move_down"),onGroundedMove:()=>Bt.onGroundedMove()},Bt.pieceY,Bt.isGrounded);s&&Bt.setRotation(s.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Bt.state==="playing"&&oe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{oe.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{oe.dragging&&oe.handlePointerUp(t)},{passive:!1}),ke.addEventListener("click",()=>{Bt.state==="playing"&&Bt.applyCommand("rotate_piece")});let ts=e.dropBtn,es=null;function hi(){Bt.state==="playing"&&(Bt.applyCommand("move_down"),es=setInterval(()=>{if(Bt.state!=="playing"){ns();return}Bt.applyCommand("move_down")},Xt))}function ns(){es&&(clearInterval(es),es=null)}ts.addEventListener("pointerdown",t=>{t.preventDefault(),hi()}),ts.addEventListener("pointerup",ns),ts.addEventListener("pointerleave",ns),ts.addEventListener("pointercancel",ns);for(let[t,s]of Object.entries(Kt))s.addEventListener("click",()=>{Bt.state==="playing"&&Se()&&Bt.applyCommand("select_magic",{element:t})});qt&&qt.addEventListener("click",()=>{if(Bt.state!=="playing"||!Vn()||!Se())return;let t=N.active??En;if(!t)return;let s=ls[t];!s||!Nn(s)||(Nt.selectSpell(s),N.active&&(En=N.active,Un=!0,N.deactivate()),sn.handleSpellButtonClick())});let gs=e.soundsToggle,ms=e.musicToggle;function dn(){let t=k.getSettings();t.soundsEnabled?gs.classList.add("active"):gs.classList.remove("active"),t.musicEnabled?ms.classList.add("active"):ms.classList.remove("active");for(let s=0;s<=4;s++){let a=e.soundVolBtns[s],S=e.musicVolBtns[s];a&&a.classList.toggle("active",t.soundVolume===s),S&&S.classList.toggle("active",t.musicVolume===s)}}let Xs=e.tabBtns,yi=e.tabContents;Xs.forEach(t=>{t.addEventListener("click",()=>{let s=t.dataset.tab;Xs.forEach(a=>a.classList.remove("active")),yi.forEach(a=>a.classList.remove("active")),t.classList.add("active"),xo(s).classList.add("active"),s==="sounds"&&dn()})});let Ys=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Vs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Si=e.iosHint,Ei=e.standaloneBadge;function Ws(){let t=document.fullscreenElement||document.webkitFullscreenElement;$t.textContent=t?"Disable":"Enable"}Ys&&(Vs?(Ei.style.display="block",$t.style.display="none"):(Si.style.display="block",$t.textContent="Not supported",$t.style.opacity="0.5",$t.style.cursor="default")),$t.addEventListener("click",()=>{if(Ys&&!Vs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let s=document.documentElement;s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Ws),document.addEventListener("webkitfullscreenchange",Ws);let ss=e.invertSwipeToggle;b.invertSwipe&&ss.classList.add("active"),Ke&&ks(),ss.addEventListener("click",()=>{ss.classList.toggle("active");let t=ss.classList.contains("active");oe.rotDir=t?-1:1,b.invertSwipe=t,C.saveGameSettings(b)}),Ke&&Ke.addEventListener("click",()=>{Ke.classList.toggle("active");let t=Ke.classList.contains("active");Wo(t)});let Ks=e.diffBtns;Ks.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Ks.forEach(s=>{s.classList.remove("active");let a=s.querySelector(".check-icon");a&&a.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let s=document.createElement("span");s.className="check-icon",s.textContent="\u2713",t.appendChild(s)}})}),gs.addEventListener("click",()=>{let s=!k.getSettings().soundsEnabled;k.updateSettings({soundsEnabled:s}),dn(),On()}),ms.addEventListener("click",()=>{let s=!k.getSettings().musicEnabled;k.updateSettings({musicEnabled:s}),dn(),On(),st!=="paused"&&(s?st==="playing"?k.startGameMusic():k.startMenuMusic():k.stopMusic())});for(let t=0;t<=4;t++){let s=e.soundVolBtns[t];s&&s.addEventListener("click",()=>{k.updateSettings({soundVolume:t}),dn(),k.play("turn")})}for(let t=0;t<=4;t++){let s=e.musicVolBtns[t];s&&s.addEventListener("click",()=>{k.updateSettings({musicVolume:t}),dn()})}dn();function qs(){st==="playing"&&(ct.pause(),ge=performance.now(),st="paused",k.musicAudio&&k.musicAudio.pause())}function os(){st==="paused"&&(ct.resume(),Qe+=performance.now()-ge,ge=0,st="playing",ys=performance.now(),k.getSettings().musicEnabled&&k.startGameMusic())}function On(){let t=k.getSettings();kt.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",kt.classList.toggle("off",!t.soundsEnabled),pe.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",pe.classList.toggle("off",!t.musicEnabled)}function Mi(){Dt.classList.remove("hidden"),Gt.classList.add("hidden");let t=C.loadHighscore(wt);if(Ve.textContent=t.score?t.score.toLocaleString():"0",an.textContent=t.time?rs(t.time):"0:00",_e.textContent=wt==="30_24"?"High Tower":"Quick Tower",Je.textContent=yt.toLocaleString(),mn.textContent=rs(Pe),ce.textContent=wt==="30_24"?"High Tower":"Quick Tower",On(),Js){let s=wt==="30_24";Js.style.display=s?"":"none",s&&bs()}}function Dn(){Dt.classList.add("hidden"),Gt.classList.remove("hidden")}Gt.addEventListener("click",()=>{qs(),Mi()}),Ce.addEventListener("click",()=>{Dn(),os()});let ps=null;function zs(t,s){Be.textContent=t,ps=s,he.classList.remove("hidden")}function js(){he.classList.add("hidden"),ps=null}Ge.addEventListener("click",()=>{js()}),tn.addEventListener("click",()=>{let t=ps;js(),t&&t()}),ln.addEventListener("click",()=>{zs("Restart game?",()=>{Dn(),Bt.applyCommand("start_game")})}),Te.addEventListener("click",()=>{zs("Exit to menu?",()=>{Dn(),Gt.classList.add("hidden"),st="intro",ct.reset(),k.stopMusic(),k.getSettings().musicEnabled&&k.startMenuMusic(),Pn()})}),ie.addEventListener("click",()=>{Ht.classList.remove("hidden")}),kt.addEventListener("click",()=>{let t=k.getSettings();k.updateSettings({soundsEnabled:!t.soundsEnabled}),On(),dn()}),pe.addEventListener("click",()=>{let s=!k.getSettings().musicEnabled;k.updateSettings({musicEnabled:s}),On(),dn()}),Dt.addEventListener("click",t=>{t.target===Dt&&(Dn(),os())}),document.addEventListener("keydown",t=>{st==="paused"&&!Dt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Dn(),os())}),Le.addEventListener("click",()=>{Ht.classList.add("hidden")}),Ht.addEventListener("click",t=>{t.target===Ht&&Ht.classList.add("hidden")});let hs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?st==="playing"&&(qs(),hs=!0):hs&&st==="paused"&&(os(),hs=!1)});let Bt=$o({getN:()=>i,getH:()=>o,FALL_INTERVAL:zt,LOCK_DELAY_SEC:jt,getKillRate:f,MATCH_HIGHLIGHT_SEC:hn,MAGIC_SHRINK_SEC:Et,RING_HIGHLIGHT_SEC:it,getState:()=>({gameState:st,score:yt,elapsedMs:Pe,startTime:ve,totalPausedMs:Qe,stats:ut,activePiece:H,pieceY:E,targetRot:Lt,rotFloat:vt,rotVel:se,isGrounded:Mt,isHighlighting:qe,isMagicAnimation:un,isRingAnimation:bn,highlightStartTime:wn,killLevel:bt,grid:R,fallTimer:x,lockTimer:_}),setState:t=>{"elapsedMs"in t&&(Pe=t.elapsedMs),"killLevel"in t&&(bt=t.killLevel),"fallTimer"in t&&(x=t.fallTimer),"lockTimer"in t&&(_=t.lockTimer),"targetRot"in t&&(Lt=t.targetRot),"rotFloat"in t&&(vt=t.rotFloat),"rotVel"in t&&(se=t.rotVel)},funcs:{startGame:li,endGame:fs,rotatePieceByDir:ii,tryMoveDown:pi,canPlaceAtRot:Hs,maybeResetLockDelay:$s,shootMagic:Zo,selectMagic:We,updateGroundedState:ri,lockPiece:gi,finishHighlight:oi,finishRingHighlight:fi},ui:{updateTimeHud:ds,updateRemainingHud:Fs}}),Cn=Fo({canvas:n,canvasCtx:r,getN:()=>i,getH:()=>o,TOP_PAD_PX:p,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:z,MAX_RADIUS_X:Y,RADIUS_X_FACTOR:q,ANG_OFFSET:d,MATCH_HIGHLIGHT_SEC:hn,MATCH_SHRINK_PHASE:_n,MAGIC_SHRINK_SEC:Et,RING_HIGHLIGHT_SEC:it,LOCK_DELAY_SEC:jt,getKillRate:f,ELEMENT_COLORS:we,ELEMENT_TO_COLOR:te,BLOCK_COLOR_FRONT:et,BLOCK_COLOR_BACK:gt,ACTIVE_COLOR_FRONT:ue,GHOST_COLOR_FILL:ot,GHOST_COLOR_STROKE:K,GHOST_STROKE_WIDTH:xt,MAGIC_DIM_DOT_ALPHA:ne,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:Jt,getState:()=>({gameState:st,grid:R,activePiece:H,pieceY:E,rotFloat:vt,killLevel:bt,isHighlighting:qe,highlightedCells:on,highlightStartTime:wn,isMagicAnimation:un,isRingAnimation:bn,isGrounded:Mt,lockTimer:_,spellState:sn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Vt,waterColor:fn}),funcs:{snappedRot:Qn,computeGhostY:ci,normSector:jn,getMagicTargetColor:()=>Se()&&N.canUse()?te[N.active]:null,getTransmuteAnimState:t=>sn.getTransmuteAnimState(t),getLightningAnimState:t=>sn.getLightningAnimState(t),getFireAnimState:t=>sn.getFireAnimState(t)}}),ys=performance.now();function Qs(t){let s=Math.min(.05,Math.max(.001,(t-ys)/1e3));if(ys=t,Bt.update(s,t),sn.update(t),O>0){let a=Math.min(O,fe*s);bt=Math.max(0,bt-a),O-=a}vt=Lt,vt>1e6&&(vt%=i),vt<-1e6&&(vt%=i),Cn.render(s,t),requestAnimationFrame(Qs)}h.addEventListener("click",()=>{Bt.applyCommand("start_game")}),T.addEventListener("click",()=>{Bt.applyCommand("start_game")}),G.addEventListener("click",()=>{st="intro",ct.reset(),k.stopMusic(),k.getSettings().musicEnabled&&k.startMenuMusic(),Pn()}),lt.forEach(t=>{t.addEventListener("click",s=>{lt.forEach(S=>S.classList.remove("active")),t.classList.add("active"),wt=t.dataset.mode,Wn(),Yn();let a=C.loadHighscore(wt);a.score>0?(Z.textContent=a.score.toLocaleString(),tt.textContent=pn(a.time)):(Z.textContent="0",tt.textContent="0:00"),h.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>h.classList.add("idlePulse"),2e3)})});let Ss=document.querySelectorAll(".spell-select-btn"),Es=document.getElementById("spellDesc"),xi=document.getElementById("spellProgressFill"),Zs=document.getElementById("spellProgressMarkers"),Js=document.getElementById("pauseSpellProgress"),bi=document.getElementById("pauseSpellProgressFill"),to=document.getElementById("pauseSpellProgressMarkers"),eo=document.getElementById("pauseSpellProgressLabel");function Ms(){return No.map(t=>Ln(t)).filter(t=>Number.isFinite(t)).sort((t,s)=>t-s)}function xs(t){return t.length?Math.max(...t):0}function vi(t){let s=Ms(),a=xs(s);return a<=0?"":`${Math.min(t,a)}/${a}`}function no(t){if(!t)return;t.innerHTML="";let s=Ms(),a=xs(s);s.forEach(S=>{let X=document.createElement("span");X.className="marker",X.dataset.threshold=S;let rt=a>0?S/a*100:0;X.style.left=`${rt}%`,t.appendChild(X)})}function so(t,s){if(!t)return;let a=Ci(s);t.style.width=`${a}%`}function oo(t,s){if(!t)return;t.querySelectorAll(".marker").forEach(S=>{let X=parseInt(S.dataset.threshold,10)||0;S.classList.toggle("reached",s>=X)})}function Ci(t){let s=Ms(),a=xs(s);return t<=0||a<=0?0:t>=a?100:t/a*100}function io(t){if(!Es)return;let s=Ln(t),a=Nt.getDescription(t);s===0||Wt>=s?Es.innerHTML=a:Es.innerHTML=`${a} <span class="spell-progress-text">${Wt}/${s}</span>`}function bs(){Wt=C.loadHighTowerRings(),Ss.forEach(s=>{let a=s.dataset.spell,S=Ln(a),X=Wt>=S;s.classList.toggle("locked",!X);let rt=s.querySelector(".spell-lock");rt&&(rt.style.display=X?"none":"")}),so(xi,Wt),so(bi,Wt),oo(Zs,Wt),oo(to,Wt),eo&&(eo.textContent=vi(Wt));let t=document.querySelector(".spell-select-btn.active");t&&io(t.dataset.spell)}no(Zs),no(to),bs(),Ss.forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation();let a=document.querySelector('.mode-btn[data-mode="30_24"]');if(a&&!a.classList.contains("active")){lt.forEach(Ft=>Ft.classList.remove("active")),a.classList.add("active"),wt="30_24",Wn(),Yn();let at=C.loadHighscore(wt);at.score>0?(Z.textContent=at.score.toLocaleString(),tt.textContent=pn(at.time)):(Z.textContent="0",tt.textContent="0:00")}let S=t.dataset.spell,X=Ln(S),rt=Wt>=X;io(S),rt&&(Ss.forEach(at=>at.classList.remove("active")),t.classList.add("active"),Nt.selectSpell(S),Rn(N.active))})}),Rt.addEventListener("click",()=>{let t=C.loadHighscore("30_24"),s=C.loadHighscore("25_20"),a=`Records

`;a+=`High Tower (30\xD724):
`,a+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${pn(t.time)}
`:`  No record yet
`,a+=`
Quick Tower (25\xD720):
`,a+=s.score>0?`  Score: ${s.score.toLocaleString()}, Time: ${pn(s.time)}
`:`  No record yet
`,alert(a)}),ye.addEventListener("click",()=>{Ht.classList.remove("hidden")}),nn.addEventListener("click",()=>{let t=Se()?`6) Use magic: tap element button, then tap matching block

`:`6) Magic is disabled in settings (Quick Tower)

`;alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
`+t+"Survive as long as you can!")}),Ae(),Yn(),Wn(),Pn(),k.startMenuMusic();let Ti=()=>{if(k.unlock(),!k.getSettings().musicEnabled)return;let t=k.musicAudio;!t||t.paused||t.ended?Bt.state==="playing"?k.startGameMusic():k.startMenuMusic():t.play().catch(s=>{console.debug("Music resume on interaction failed:",s)})},co=0,_i=10,Bi=()=>{co>=_i||(co++,Ti())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Bi,{passive:!0})}),requestAnimationFrame(Qs)})();})();
