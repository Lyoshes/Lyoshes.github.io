(()=>{var Vo=[0,.25,.5,.75,1],Wo=[0,.05,.15,.25,.5],Ko={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Gs={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Fs="soundSettings";function zo(){try{let e=localStorage.getItem(Fs);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function qo(e){try{localStorage.setItem(Fs,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Ns(){return{audioContext:null,buffers:{},settings:zo(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Vo[this.settings.soundVolume]},getMusicVolume(){return Wo[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let o=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(o);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${c}`,l)}},preload(){this.initContext();for(let[n,c]of Object.entries(Ko))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;c!==null&&(l=`${n}${c}`);let o=this.buffers[l];if(o)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let i=this.audioContext.createBufferSource();i.buffer=o,i.connect(s),i.start(0),i.onended=()=>{i.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Gs.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Gs.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},qo(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Xs="eb_highscore",Us="eb_highscore_quick",Ys="eb_settings",Vs="eb_high_tower_rings",jo={invertSwipe:!1,difficulty:"easy"};function Ws(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Us:Xs,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let l=this.loadHighscore(c);if(e>l.score||e===l.score&&n>l.time){let o=c==="25_20"?Us:Xs;return localStorage.setItem(o,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Ys);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...jo}},saveGameSettings(e){try{localStorage.setItem(Ys,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Vs);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Vs,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function Ks(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function zs(e){return document.getElementById("tab-"+e)}var Qo={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function qs(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(l,o="score",s=null){let i=document.createElement("div");i.className=`bonus-popup ${o}`,i.textContent=l,s&&n[s]&&(i.style.color=n[s]);let r=window.innerWidth/2,g=window.innerHeight/2-40,m=(Math.random()-.5)*200,f=(Math.random()-.5)*100+c*36;i.style.left=`${r+m}px`,i.style.top=`${g+f}px`,i.style.transform="translate(-50%, -50%)",document.body.appendChild(i),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{i.remove()},1800)},getElementIcon(l){return Qo[l]||"\u2726"}}}var js={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Qs(){return{spawnMagicOrb(e,n,c,l){if(!l)return;let o=document.createElement("div");o.className=`magic-orb ${e}`,o.textContent=js[e]||"\u2726";let s=l.getBoundingClientRect(),i=s.left+s.width/2-n,r=s.top+s.height/2-c,g=Math.hypot(i,r),m=Math.atan2(r,i),f=g*.35*(Math.random()>.5?1:-1),h=m+Math.PI/2,L=i*.5+Math.cos(h)*f,K=r*.5+Math.sin(h)*f;o.style.setProperty("--mid-x",`${L}px`),o.style.setProperty("--mid-y",`${K}px`),o.style.setProperty("--end-x",`${i}px`),o.style.setProperty("--end-y",`${r}px`),o.style.left=`${n}px`,o.style.top=`${c}px`,document.body.appendChild(o),setTimeout(()=>{o.remove()},700)},spawnMagicShot(e,n,c,l,o){if(!n){o&&o();return}let s=n.getBoundingClientRect(),i=s.left+s.width/2,r=s.top+s.height/2,g=document.createElement("div");g.className=`magic-shot ${e}`,g.textContent=js[e]||"\u2726";let m=c-i,f=l-r;g.style.setProperty("--end-x",`${m}px`),g.style.setProperty("--end-y",`${f}px`),g.style.left=`${i}px`,g.style.top=`${r}px`,document.body.appendChild(g);let h=setInterval(()=>{let L=g.getBoundingClientRect();this.spawnTrailParticle(e,L.left+L.width/2,L.top+L.height/2)},40);setTimeout(()=>{clearInterval(h),g.remove(),this.spawnExplosion(e,c,l),o&&o()},300)},spawnTrailParticle(e,n,c){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${c}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,c){for(let o=0;o<12;o++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let i=o/12*Math.PI*2+(Math.random()-.5)*.5,r=40+Math.random()*40,g=Math.cos(i)*r,m=Math.sin(i)*r;s.style.setProperty("--px",`${g}px`),s.style.setProperty("--py",`${m}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let c=e.getBoundingClientRect(),l=c.left+c.width/2,o=c.top+c.height/2,s=Math.max(8,Math.round(n));for(let i=0;i<s;i++){let r=document.createElement("div");r.className="spell-bubble",r.textContent="\u25CF";let g=i/s*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,f=Math.cos(g)*m,h=Math.sin(g)*m-20;r.style.setProperty("--px",`${f}px`),r.style.setProperty("--py",`${h}px`),r.style.left=`${l}px`,r.style.top=`${o}px`,r.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(r),setTimeout(()=>r.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let o=c.getBoundingClientRect(),s=o.left+o.width/2-e,i=o.top+o.height/2-n,r=Math.hypot(s,i),g=Math.atan2(i,s),m=r*.35*(Math.random()>.5?1:-1),f=g+Math.PI/2,h=s*.5+Math.cos(f)*m,L=i*.5+Math.sin(f)*m;l.style.setProperty("--mid-x",`${h}px`),l.style.setProperty("--mid-y",`${L}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${i}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}function Zs(e={}){let{buttons:n={},onActivate:c=null}=e,l={fire:3,water:3,lightning:3,earth:3},o=null;function s(){for(let[r,g]of Object.entries(n)){if(!g)continue;let m=l[r],f=g.querySelector(".charges");f&&(f.textContent=m),g.classList.toggle("empty",m<=0),g.classList.toggle("active",o===r&&m>0)}}function i(r){let g=n[r];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return l},get active(){return o},set active(r){o=r},select(r){if(l[r]<=0)return!1;let g=o===r;return o=g?null:r,s(),!g&&o===r&&c&&c(),!g},useCharge(){if(!o||l[o]<=0)return!1;let r=o;return l[r]--,o=null,s(),i(r),!0},addCharges(r,g){l[r]!==void 0&&(l[r]+=g,s(),i(r))},canUse(){return o!==null&&l[o]>0},deactivate(){o=null,s()},reset(){l.fire=3,l.water=3,l.lightning=3,l.earth=3,o=null,s()},updateButtons:s,initButtons(r){for(let[g,m]of Object.entries(n))m&&m.addEventListener("click",()=>{r&&r(g)})}}}var vn={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:6,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:10,effect:{type:"chain_lightning",areaSize:6,maxBlocks:10,jumpMs:180,flashMs:250}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:8,effect:{type:"transmutation",areaSize:6,maxBlocks:10,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:12,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Js(e={}){let{button:n=null,onActivate:c=null,onProgress:l=null,onReady:o=null}=e,s="ice",i=0;function r(){return vn[s]||vn.ice}function g(){if(!n)return;let f=r(),h=Math.min(i/f.maxProgress,1)*100,L=i>=f.maxProgress;n.style.setProperty("--progress",`${h}%`);let K=n.querySelector(".spell-icon");K&&(K.textContent=f.icon);let $=n.querySelector(".spell-counter");$&&($.textContent=`${Math.min(i,f.maxProgress)}/${f.maxProgress}`),n.classList.toggle("ready",L),n.classList.toggle("charging",!L&&i>0),l&&l(i,f.maxProgress)}function m(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return i},get maxProgress(){return r().maxProgress},get isReady(){return i>=r().maxProgress},get effect(){return r().effect},getEffect(f){return(vn[f]||vn.ice).effect},get button(){return n},selectSpell(f){vn[f]&&(s=f,i=0,g())},addProgress(f=1){let h=r();if(i>=h.maxProgress)return!1;let L=i<h.maxProgress;return i=Math.min(i+f,h.maxProgress),g(),m(),L&&i>=h.maxProgress&&o&&o(),!0},canUse(){return i>=r().maxProgress},use(){if(!this.canUse())return null;let f=r().effect;return i=0,g(),m(),c&&c(s),f},reset(){i=0,g()},updateButton:g,initButton(f){n&&n.addEventListener("click",()=>{f&&f()})}}}function cs({centerY:e,centerS:n,size:c,H:l,normSector:o}){let s=[],i=Math.floor(c/2);for(let r=-i;r<=i;r++)for(let g=-i;g<=i;g++){let m=e+r,f=o(n+g);if(m<0||m>=l)continue;let h=r*r+g*g;s.push({y:m,s:f,distSq:h})}return s}function rs(e,n,c){return n.filter(l=>e[l.y][l.s]===c)}function ls(e,n){return[...e].sort((l,o)=>l.distSq!==o.distSq?l.distSq-o.distSq:l.y!==o.y?l.y-o.y:l.s-o.s).slice(0,n).map(l=>({y:l.y,s:l.s}))}function to({centerY:e,centerS:n,beamLength:c,beamWidth:l,N:o,H:s,normSector:i}){if(e<0||e>=s||l<=0||c<0||o<=0)return[];let r=Math.min(l,s),g=[],m=new Set,f=$=>$<0||$>=s||m.has($)?!1:(m.add($),g.push($),!0);f(e);for(let $=1;g.length<r&&(e+$<s||e-$>=0)&&(f(e+$),!(g.length>=r));$++)f(e-$);g.sort(($,z)=>z-$);let h=Math.min(o,c*2+1),L=c%2===0,K=[];for(let $ of g){let z=new Set,nt=(st,ce)=>{let Q=i(st);return z.has(Q)?!1:(z.add(Q),K.push({y:$,s:Q,dist:ce}),!0)};nt(n,0);for(let st=1;z.size<h&&st<o;st++)if(L){if(nt(n+st,st),z.size>=h)break;nt(n-st,st)}else{if(nt(n-st,st),z.size>=h)break;nt(n+st,st)}}return K}function eo(e){let{canvas:n,dom:c,getGrid:l,getN:o,getH:s,getRotFloat:i,constants:r,helpers:g,Spell:m,Magic:f,SoundModule:h,State:L,isGamePlaying:K,addPendingKzDrop:$,getKillRate:z,triggerSpellWave:nt,spawnSpellBubbles:st,spawnBonusBubbles:ce,getTransmuteEffect:Q,getLightningEffect:Y,getFireEffect:Mt,continueMatchProcessing:Me,updateScoreHud:xe,showBonus:Zt,setScore:re,setCascadeLevel:Jt}=e,{TOP_PAD_PX:fe,BOTTOM_PAD_PX:Nt,SIDE_MARGIN_PX:Xt,MAX_RADIUS_X:Tt,SCORE_MAGIC_DESTROY:a}=r,{normSector:Z,levelYToScreenY:V,sectorCenterXY:we}=g,te=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],xt="idle",Dt=null,le=null,me=[],qt=[],pt=0,be=null,Ve=0,At="idle",ee=null,St=[],Lt=[],vt=0,Fe=0,It="idle",Ie=null,R=[],S=[],_=0;function A(){xt="selecting_source",Dt=null,le=null,me=[],qt=[],At!=="idle"&&k(),It!=="idle"&&Pt(),f.deactivate(),h.play("ulta");let E=c.spellBtn;E&&E.classList.add("selecting")}function P(){xt!=="idle"&&h.play("cancel"),xt="idle",Dt=null,le=null,me=[],qt=[],W();let E=c.spellBtn;E&&E.classList.remove("selecting")}function p(E,N){if(xt!=="selecting_source")return!1;let y=et(E,N);if(!y)return P(),!0;let it=l();Dt={y:y.y,s:y.s,color:it[y.y][y.s]},me=cs({centerY:y.y,centerS:y.s,size:Q().areaSize,H:s(),normSector:Z});let ht=Dt.color,Rt=rs(it,me,ht);return qt=ls(Rt,Q().maxBlocks),J(Dt.color,y.y),xt="selecting_target",!0}function et(E,N){let y=n.clientWidth,it=n.clientHeight,ht=y*.5,Rt=(y-2*Xt)/2,ye=it-fe-Nt,ae=6,Oe=s(),Ne=o(),Ke=i(),ne=Ne*ye/(ae*Oe),jt=it-Nt,Vt,wt,Qt;ne<=Math.min(Rt,Tt)?(Vt=ne,wt=ye,Qt=fe):(Vt=Math.min(Rt,Tt),wt=Vt*ae*Oe/Ne,Qt=jt-wt);let ze=Vt*.28,ve=null,ke=1/0,De=l();for(let Wt=0;Wt<Oe;Wt++){let ue=V(Qt,wt,Wt+.5);for(let de=0;de<Ne;de++){if(!De[Wt][de])continue;let Te=we(ht,ue,Vt,ze,de,Ke);if(Math.sin(Te.ang)<-.1)continue;let _e=E-Te.x,en=N-Te.y,kt=Math.hypot(_e,en),ge=wt/Oe*.9,an=ge*1.2;Math.abs(_e)<an/2&&Math.abs(en)<ge/2&&kt<ke&&(ke=kt,ve={y:Wt,s:de})}}return ve}function J(E,N){W();let y=document.createElement("div");y.className="transmute-popup";let it=n.clientWidth,ht=n.clientHeight,Rt=(it-2*Xt)/2,ye=ht-fe-Nt,ae=6,Oe=s(),Ne=o(),Ke=Ne*ye/(ae*Oe),ne=ht-Nt,jt,Vt;Ke<=Math.min(Rt,Tt)?(jt=ye,Vt=fe):(jt=Math.min(Rt,Tt)*ae*Oe/Ne,Vt=ne-jt);let wt=V(Vt,jt,N+.5),Qt=Math.floor(Q().areaSize/2),ze=V(Vt,jt,Math.min(Oe,N+Qt)+.5),ve=V(Vt,jt,Math.max(0,N-Qt)+.5),ke=Vt+jt/2,De=document.getElementById("gameContainer"),Wt=De?De.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},ue=160,de=60,Te=20,on=Wt.left+Wt.width/2-ue/2,_e;wt<ke?_e=Wt.top+ve+Te:_e=Wt.top+ze-de-Te,_e=Math.max(10,Math.min(window.innerHeight-de-10,_e)),y.style.left=`${on}px`,y.style.top=`${_e}px`,te.filter(kt=>kt.color!==E).forEach(kt=>{let ge=document.createElement("button");ge.className=`transmute-btn ${kt.name}`,ge.innerHTML=kt.icon,ge.setAttribute("data-color",kt.color),ge.addEventListener("click",an=>{an.stopPropagation(),b(kt.color)}),y.appendChild(ge)}),document.body.appendChild(y),be=y,Ve=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",G)},50)}function G(E){performance.now()-Ve<200||be&&!be.contains(E.target)&&P()}function W(){document.removeEventListener("pointerdown",G),be&&(be.remove(),be=null)}function b(E){W(),le=E,m.use(),x()}function x(){if(!Dt){P();return}if(qt.length===0){P();return}let E=c.spellBtn;E&&E.classList.remove("selecting"),xt="animating",pt=performance.now(),h.play("esseffect")}function F(E){if(xt!=="animating")return!1;let N=(E-pt)/1e3;return Math.min(N/Q().animSec,1)>=1?(C(),!1):!0}function Bt(E){if(xt!=="animating")return null;let N=(E-pt)/1e3,y=Math.min(N/Q().animSec,1),it="flash",ht=0,Rt=0;return y<.15?(it="flash",Rt=1-y/.15):y<.55?(it="shrink",ht=(y-.15)/.4):(it="grow",ht=(y-.55)/.45),{phase:it,progress:ht,areaFlash:Rt}}function C(){let E=l();for(let N of qt)E[N.y][N.s]=le;xt="idle",Dt=null,le=null,me=[],qt=[],Jt(0),Me()}function Et(){h.play("ulta"),At="selecting_source",ee=null,St=[],Lt=[],Fe=0,xt!=="idle"&&(xt="idle",Dt=null,le=null,me=[],qt=[],W()),It!=="idle"&&(It="idle",Ie=null,R=[],S=[],_=0),f.deactivate();let E=c.spellBtn;E&&E.classList.add("selecting")}function k(){At!=="idle"&&h.play("cancel"),At="idle",ee=null,St=[],Lt=[],Fe=0;let E=c.spellBtn;E&&E.classList.remove("selecting")}function gt(){It="selecting_source",Ie=null,R=[],S=[],_=0,xt!=="idle"&&(xt="idle",Dt=null,le=null,me=[],qt=[],W()),At!=="idle"&&(At="idle",ee=null,St=[],Lt=[],Fe=0),f.deactivate(),h.play("ulta");let E=c.spellBtn;E&&E.classList.add("selecting")}function Pt(){It!=="idle"&&h.play("cancel"),It="idle",Ie=null,R=[],S=[],_=0;let E=c.spellBtn;E&&E.classList.remove("selecting")}function Ht(E,N){if(At!=="selecting_source")return!1;let y=et(E,N);if(!y)return k(),!0;let it=l();ee={y:y.y,s:y.s,color:it[y.y][y.s]},St=cs({centerY:y.y,centerS:y.s,size:Y().areaSize,H:s(),normSector:Z});let ht=ee.color,Rt=rs(it,St,ht);return Lt=ls(Rt,Y().maxBlocks),Lt.length===0?(k(),!0):(m.use(),tn(),!0)}function $t(E,N){if(It!=="selecting_source")return!1;let y=et(E,N);if(!y)return Pt(),!0;let it=l();return Ie={y:y.y,s:y.s,color:it[y.y][y.s]},R=to({centerY:y.y,centerS:y.s,beamLength:Mt().beamLength,beamWidth:Mt().beamWidth,N:o(),H:s(),normSector:Z}),S=R.filter(ht=>it[ht.y][ht.s]),S.length===0?(Pt(),!0):(m.use(),Yt(),!0)}function tn(){if(!ee||Lt.length===0){k();return}let E=c.spellBtn;E&&E.classList.remove("selecting"),At="animating",vt=performance.now(),Fe=0,h.play("asseffect")}function ln(E){if(At!=="animating")return!1;let N=E-vt,y=Y().flashMs+Lt.length*Y().jumpMs;return N>=y?(w(),!1):!0}function Ut(E){if(At!=="animating")return null;let N=E-vt;if(N<Y().flashMs)return{phase:"flash",flashProgress:1-N/Y().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let y=N-Y().flashMs,it=Math.floor(y/Y().jumpMs),ht=y%Y().jumpMs/Y().jumpMs,Rt=[];for(let ye=0;ye<Math.min(it,Lt.length);ye++)Rt.push(ye);return{phase:"chain",flashProgress:0,currentTarget:Math.min(it,Lt.length-1),jumpProgress:ht,struckTargets:Rt}}function w(){let E=l(),y=Lt.length*a;L.addScore(y),re(L.score),xe(),Zt(`+${y}`,"score");for(let it of Lt)E[it.y][it.s]=0;At="idle",ee=null,St=[],Lt=[],Fe=0,Jt(0),Me()}function Yt(){if(!Ie||S.length===0){Pt();return}let E=c.spellBtn;E&&E.classList.remove("selecting"),It="animating",_=performance.now(),h.play("fsseffect")}function j(E){return It!=="animating"?!1:(E-_)/1e3>=Mt().animSec?(Ce(),!1):!0}function ft(E){if(It!=="animating")return null;let N=Math.max(.001,Mt().animSec),y=(E-_)/1e3,it=Math.min(y/N,1),ht=.25,Rt=it<ht?1-it/ht:0;return{progress:it,flashProgress:Rt}}function Ce(){let E=l(),N=S.length;if(N>0){let y=N*a;L.addScore(y),re(L.score),xe(),Zt(`+${y}`,"score")}for(let y of S)E[y.y][y.s]=0;It="idle",Ie=null,R=[],S=[],_=0,Jt(0),Me()}function Gt(){if(!(typeof K=="function"?K():L.isPlaying())||!m.canUse())return!1;let N=m.currentSpell;if(N==="ice"){let y=m.use();return y?(typeof $=="function"&&typeof z=="function"&&$(y.duration*z()),h.play("wsseffect"),Zt(`\u{1F4A7} -${y.duration}s`,"time"),typeof nt=="function"&&nt(),typeof st=="function"&&st(y.duration),typeof ce=="function"&&ce(y.duration),!0):!1}return N==="earth"?(xt==="idle"?A():P(),!0):N==="air"?(At==="idle"?Et():k(),!0):N==="fire"?(It==="idle"?gt():Pt(),!0):(m.use(),!0)}function We(E){F(E),ln(E),j(E)}function pe(E,N){return xt==="selecting_source"?p(E,N):At==="selecting_source"?Ht(E,N):It==="selecting_source"?$t(E,N):!1}function he(){xt="idle",Dt=null,le=null,me=[],qt=[],W(),At="idle",ee=null,St=[],Lt=[],Fe=0,It="idle",Ie=null,R=[],S=[],_=0;let E=c.spellBtn;E&&E.classList.remove("selecting")}function ot(){return{transmuteState:xt,transmuteSourceBlock:Dt,transmuteTargetColor:le,transmuteAreaCells:me,transmuteBlocksToChange:qt,lightningState:At,lightningSourceBlock:ee,lightningAreaCells:St,lightningBlocksToHit:Lt,fireState:It,fireSourceBlock:Ie,fireLineCells:R,fireTargets:S}}return{startTransmuteSourceSelection:A,cancelTransmutation:P,startLightningSourceSelection:Et,cancelLightning:k,startFireSourceSelection:gt,cancelFire:Pt,handleTap:pe,update:We,reset:he,getRenderState:ot,getTransmuteAnimState:Bt,getLightningAnimState:Ut,getFireAnimState:ft,handleSpellButtonClick:Gt,isTransmuteSelecting:()=>xt==="selecting_source",isLightningSelecting:()=>At==="selecting_source"}}var Zo={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function no(e={}){let{canvas:n}=e,c=e.rotDir||1,l=!1,o=0,s=0,i=0,r=0,g=0,m=1,f=null,h=0,L=0,K=0,$=0,z=0,nt=0,st=0,ce=0,Q=Zo;return{get rotDir(){return c},set rotDir(Y){c=Y},get dragging(){return l},get dragMode(){return f},handlePointerDown(Y,Mt,Me){if(Mt.onMagicTap&&Mt.onMagicTap(Y.clientX,Y.clientY))return!0;let xe=performance.now(),Zt=xe-nt,re=Y.clientX-st,Jt=Y.clientY-ce,fe=Math.hypot(re,Jt);return Zt<=Q.DOUBLE_TAP_MS&&fe<=Q.DOUBLE_TAP_MAX_DIST?(Mt.onDoubleTap&&Mt.onDoubleTap(),nt=0):(nt=xe,st=Y.clientX,ce=Y.clientY),l=!0,m=-1,o=Y.clientX,s=Y.clientY,i=Me,r=0,g=0,f=null,h=xe,L=Y.clientX,K=Y.clientY,$=h,z=0,n&&n.setPointerCapture(Y.pointerId),!1},handlePointerMove(Y,Mt,Me,xe){if(!l)return null;let Zt=Y.clientX-o,re=Y.clientY-s,Jt=performance.now();if(Math.abs(Zt)<Q.DEADZONE_PX&&Math.abs(re)<Q.DEADZONE_PX)return null;if(!f){let Nt=Math.abs(Zt),Xt=Math.abs(re);if(re<0)Nt>=Q.DEADZONE_PX&&(f="rotate");else if(Xt>=Nt*Q.AXIS_DOMINANCE){if(Xt>=Q.DROP_SWIPE_MIN_DISTANCE){let Tt=Math.max(1,Jt-h);Xt/Tt*1e3>=Q.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else Nt>=Xt*Q.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let fe=null;if(f==="rotate"&&Math.abs(Zt)>=Q.DEADZONE_PX){let Nt=Math.max(1,Jt-$),Xt=Y.clientX-L,Tt=Math.max(1,Math.abs(Xt)/Nt*1e3),a=Math.max(Q.MIN_ROT_PX,Math.min(Q.MAX_ROT_PX,Q.PX_PER_STEP*(Q.SWIPE_SPEED_REF/Tt)));z+=-Xt/a*c*m;let Z=Math.trunc(z);Z!==0&&(z-=Z);let V=r+Z;if(V!==r&&Mt.canRotateTo){let we=Math.sign(V-r),te=i+r;for(;r!==V;){let xt=r+we,Dt=i+xt;if(!Mt.canRotateTo(Math.floor(Me),Dt))break;r=xt,te=Dt,xe&&Mt.onGroundedMove&&Mt.onGroundedMove()}fe={targetRot:te,rotFloat:te}}}if(f==="drop"&&re>Q.DEADZONE_PX&&Mt.onDrop){let Nt=Math.max(1,Jt-$),Xt=Y.clientY-K,Tt=Math.max(1,Xt/Nt*1e3),a=Math.max(Q.MIN_DROP_PX,Math.min(Q.MAX_DROP_PX,Q.PX_PER_DROP*(Q.SWIPE_SPEED_REF/Tt))),Z=Math.trunc(re/a);if(Z>g){let V=Z-g;for(let we=0;we<V;we++)Mt.onDrop();g=Z}}return L=Y.clientX,K=Y.clientY,$=Jt,fe},handlePointerUp(Y){if(l&&(l=!1,f=null,n&&Y&&Y.pointerId!==void 0))try{n.releasePointerCapture(Y.pointerId)}catch{}},reset(){l=!1,f=null,r=0,g=0,z=0}}}var as={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function so(){let e="intro",n=0,c=0,l=0,o=0,s=0,i={...as};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return c},get stats(){return i},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),l=0,o=0,s=0,i={...as}},pause(){return e!=="playing"?!1:(e="paused",o=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",o>0&&(s+=performance.now()-o,o=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){n+=r},setScore(r){n=r},updateTime(){e==="playing"&&c>0&&(l=performance.now()-c-s)},getFormattedTime(){let r=Math.floor(l/1e3),g=Math.floor(r/60),m=r%60;return`${g}:${m.toString().padStart(2,"0")}`},incrementStat(r,g=1){r in i&&(i[r]+=g)},updateMaxStat(r,g){r in i&&g>i[r]&&(i[r]=g)},reset(){e="intro",n=0,c=0,l=0,o=0,s=0,i={...as}}}}function pn(e,n){return e%=n,e<0&&(e+=n),e}function oo(e,n){return e[Math.min(n,e.length-1)]}function Vn(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),l=n%60;return`${c}:${l.toString().padStart(2,"0")}`}function io(e,n){let c=e.map(({x:r,y:g},m)=>({x:g,y:-r,color:n[m]})),l=1/0,o=-1/0,s=1/0;for(let r of c)l=Math.min(l,r.x),o=Math.max(o,r.x),s=Math.min(s,r.y);let i=Math.round((l+o)/2);for(let r of c)r.x-=i,r.y-=s;return c.sort((r,g)=>r.y-g.y||r.x-g.x),{cells:c.map(r=>({x:r.x,y:r.y})),colors:c.map(r=>r.color)}}function us(e,n,c,l){let o=[];return e+1<c&&o.push({y:e+1,s:n}),e-1>=0&&o.push({y:e-1,s:n}),o.push({y:e,s:pn(n-1,l)}),o.push({y:e,s:pn(n+1,l)}),o}function co(e,n,c){let l=Array.from({length:n},()=>new Uint8Array(c)),o=[];for(let s=0;s<n;s++)for(let i=0;i<c;i++){if(!e[s][i]||l[s][i])continue;let r=[],g=[{y:s,s:i}];for(l[s][i]=1;g.length>0;){let m=g.shift();r.push(m);for(let f of us(m.y,m.s,n,c))e[f.y][f.s]&&!l[f.y][f.s]&&(l[f.y][f.s]=1,g.push(f))}o.push(r)}return o}function ro(e){return e.some(n=>n.y===0)}function ds(e,n,c,l,o,s){if(!e)return!1;let i=pn(c,s);for(let r of e.cells){let g=n+r.y,m=pn(i+r.x,s);if(g<0)return!1;if(!(g>=o)&&l[g][m])return!1}return!0}function lo(e,n,c,l,o,s){if(!e)return null;let i=Math.floor(n);for(;ds(e,i-1,c,l,o,s);)i-=1;return i}function ao(e,n,c){let l=[],o=[];for(let s=0;s<n;s++){let i=[],r=0,g=e[s][0],m=g?1:0;for(let f=1;f<=c;f++){let h=f<c?e[s][f]:0;h&&h===g?m++:(m>=1&&g&&i.push({start:r,length:m,color:g}),r=f,g=h,m=h?1:0)}if(i.length>=2){let f=i[0],h=i[i.length-1];if(f.start===0&&h.start+h.length===c&&f.color===h.color){let L=f.length+h.length;i[0]={start:h.start,length:L,color:f.color},i.pop()}}for(let f of i)if(f.length>=3){let h=[];for(let L=0;L<f.length;L++)h.push({y:s,s:(f.start+L)%c});l.push({color:f.color,length:f.length,cells:h})}}for(let s=0;s<c;s++){let i=0,r=e[0][s],g=r?1:0;for(let m=1;m<=n;m++){let f=m<n?e[m][s]:0;if(f&&f===r)g++;else{if(g>=3&&r){let h=[];for(let L=0;L<g;L++)h.push({y:i+L,s});l.push({color:r,length:g,cells:h})}i=m,r=f,g=f?1:0}}}for(let s=0;s<n;s++)for(let i=0;i<c;i++){let r=e[s][i],g=e[s][(i+1)%c],m=e[s][(i+2)%c],f=e[s][(i+3)%c];r&&r===g&&m&&m===f&&r!==m&&o.push({cells:[{y:s,s:i},{y:s,s:(i+1)%c},{y:s,s:(i+2)%c},{y:s,s:(i+3)%c}]})}for(let s=0;s<c;s++)for(let i=0;i<n-3;i++){let r=e[i][s],g=e[i+1][s],m=e[i+2][s],f=e[i+3][s];r&&r===g&&m&&m===f&&r!==m&&o.push({cells:[{y:i,s},{y:i+1,s},{y:i+2,s},{y:i+3,s}]})}return{lineMatches:l,pairMatches:o}}function uo(e,n,c){let l=[];for(let o=0;o<n;o++){let s=!0;for(let i=0;i<c;i++)if(!e[o][i]){s=!1;break}s&&l.push(o)}return l}function go(e,n){let c=new Map;e.forEach((l,o)=>c.set(`${l.x},${l.y}`,n[o]));for(let l=0;l<e.length;l++){let o=e[l],s=n[l],i=1;for(let nt=1;nt<=2&&c.get(`${o.x+nt},${o.y}`)===s;nt++)i++;if(i>=3)return!0;let r=1;for(let nt=1;nt<=2&&c.get(`${o.x},${o.y+nt}`)===s;nt++)r++;if(r>=3)return!0;let g=s,m=c.get(`${o.x+1},${o.y}`),f=c.get(`${o.x+2},${o.y}`),h=c.get(`${o.x+3},${o.y}`);if(g&&m&&f&&h&&g===m&&f===h&&g!==f)return!0;let L=s,K=c.get(`${o.x},${o.y+1}`),$=c.get(`${o.x},${o.y+2}`),z=c.get(`${o.x},${o.y+3}`);if(L&&K&&$&&z&&L===K&&$===z&&L!==$)return!0}return!1}function fo(e){let{getN:n,getH:c,FALL_INTERVAL:l,LOCK_DELAY_SEC:o,getKillRate:s,MATCH_HIGHLIGHT_SEC:i,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:g,getState:m,setState:f,funcs:h,ui:L}=e;return{get state(){return m().gameState},get score(){return m().score},get elapsedMs(){return m().elapsedMs},get stats(){return m().stats},get activePiece(){return m().activePiece},get pieceY(){return m().pieceY},get targetRot(){return m().targetRot},get isGrounded(){return m().isGrounded},get isHighlighting(){return m().isHighlighting},get killLevel(){return m().killLevel},get grid(){return m().grid},applyCommand(K,$={}){let z=m();if(K==="start_game")return z.gameState!=="playing"?(h.startGame(),!0):!1;if(z.gameState!=="playing")return!1;switch(K){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:nt}=$;return typeof nt=="number"&&h.canPlaceAtRot(Math.floor(z.pieceY),nt)?(f({targetRot:nt,rotFloat:nt,rotVel:0}),z.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:nt,y:st}=$;return h.shootMagic(nt,st)}case"select_magic":{let{element:nt}=$;return h.selectMagic(nt),!0}default:return console.warn("GameEngine: unknown command",K),!1}},update(K,$){let z=m();if(z.gameState!=="playing")return;let nt=$-z.startTime-z.totalPausedMs;f({elapsedMs:nt}),L.updateTimeHud();let st=z.killLevel+s()*K;if(f({killLevel:st}),L.updateRemainingHud(),st>=c()){h.endGame();return}if(z.isHighlighting){let Y=($-z.highlightStartTime)/1e3,Mt;z.isRingAnimation?Mt=g:z.isMagicAnimation?Mt=r:Mt=i,Y>=Mt&&(z.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let ce=z.fallTimer+K;if(ce>=l&&(ce-=l,h.tryMoveDown()),f({fallTimer:ce}),h.updateGroundedState()){let Y=z.lockTimer+K;f({lockTimer:Y}),Y>=o&&h.lockPiece()}},reset(){h.startGame()},canRotateTo(K,$){return h.canPlaceAtRot(K,$)},getRotation(){let K=m();return{targetRot:K.targetRot,rotFloat:K.rotFloat,rotVel:K.rotVel}},setRotation(K){f({targetRot:K,rotFloat:K,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var Pe=Math.PI*2;function mo(e){let{canvas:n,canvasCtx:c,getN:l,getH:o,TOP_PAD_PX:s,BOTTOM_PAD_PX:i,SIDE_MARGIN_PX:r,MAX_RADIUS_X:g,RADIUS_X_FACTOR:m,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:h,MATCH_SHRINK_PHASE:L,MAGIC_SHRINK_SEC:K,RING_HIGHLIGHT_SEC:$,LOCK_DELAY_SEC:z,getKillRate:nt,ELEMENT_COLORS:st,ELEMENT_TO_COLOR:ce,BLOCK_COLOR_FRONT:Q,BLOCK_COLOR_BACK:Y,ACTIVE_COLOR_FRONT:Mt,GHOST_COLOR_FILL:Me,GHOST_COLOR_STROKE:xe,GHOST_STROKE_WIDTH:Zt,MAGIC_DIM_DOT_ALPHA:re,MAGIC_DIM_DOT_SCALE:Jt,MAGIC_TARGET_DOT_SCALE:fe,getState:Nt,getVisualSettings:Xt,funcs:Tt}=e,a=c,Z=l(),V=o(),we={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},te=[],xt=40;function Dt(R,S,_,A,P){let p=Math.max(3,Math.round(R)),et=180;for(let J=0;J<p;J++)setTimeout(()=>{let G=Math.random()>.5?"left":"right",W=15,b=G==="left"?W+Math.random()*Math.max(10,S-W*2):_+W+Math.random()*Math.max(10,P-_-W*2),x=A-10;te.push({x:b,baseX:b,y:x,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:W,maxX:P-W})},J*et)}function le(R,S,_){te=te.filter(A=>A.y>R+A.size&&A.y>-20);for(let A of te){A.y-=xt*_,A.wobble+=A.wobbleSpeed*_;let P=A.baseX+Math.sin(A.wobble)*A.wobbleAmp;A.x=Math.max(A.minX,Math.min(A.maxX,P))}}function me(R){if(te.length!==0){a.fillStyle="rgba(255, 255, 255, 0.3)",a.strokeStyle="rgba(255, 255, 255, 0.5)",a.lineWidth=1;for(let S of te)S.y<R+S.size||(a.beginPath(),a.arc(S.x,S.y,S.size,0,Math.PI*2),a.fill(),a.stroke())}}let qt={left:0,right:0,h:0,w:0};function pt(R,S,_){let A=1-_/V;return R+A*S}function be(R){return R=R%Z,R<0?R+Z:R}function Ve(R,S,_,A,P,p){let et=be(p),J=(P-et)/Z*Pe+f;return{x:R+Math.cos(J)*_,y:S+Math.sin(J)*A,ang:J}}let At=.52,ee=1.02;function St(R,S,_,A,P,p){let et=be(p),J=(P-et)/Z*Pe+f;return{x:R+Math.cos(J)*_,y:S+Math.sin(J)*A,ang:J}}function Lt(R,S,_,A,P,p,et,J=1){let G=St(R,S,_,A,P-At,p),W=St(R,S,_,A,P+At,p),b={x:G.x,y:G.y-et*.5},x={x:G.x,y:G.y+et*.5},F={x:W.x,y:W.y-et*.5},Bt={x:W.x,y:W.y+et*.5},C=(b.x+F.x+Bt.x+x.x)*.25,Et=(b.y+F.y+Bt.y+x.y)*.25,k=ee*J,gt=J,Pt=[b,F,Bt,x].map(tn=>({x:C+(tn.x-C)*k,y:Et+(tn.y-Et)*gt})),Ht=Math.abs((W.x-G.x)*k),$t=Math.abs(et*gt);return{corners:Pt,cx:C,cy:Et,wApprox:Ht,hApprox:$t,ang:St(R,S,_,A,P,p).ang}}function vt(R,S,_,A,P,p,et,J,G=1,W=null,b=1,x=null,F=0,Bt=1,C=1){let Et=Lt(R,S,_,A,P,p,et,C),[k,gt,Pt,Ht]=Et.corners;if(a.save(),a.globalAlpha=G,a.fillStyle=J,a.beginPath(),a.moveTo(k.x,k.y),a.lineTo(gt.x,gt.y),a.lineTo(Pt.x,Pt.y),a.lineTo(Ht.x,Ht.y),a.closePath(),a.fill(),x&&F>0&&(a.strokeStyle=x,a.lineWidth=F,a.stroke()),W){let $t=Math.min(Et.wApprox,Et.hApprox)*.28*Bt;a.globalAlpha=G*b,a.fillStyle=W,a.beginPath(),a.arc(Et.cx,Et.cy,$t,0,Pe),a.fill()}a.restore(),a.globalAlpha=1}function Fe(R,S,_,A,P,p){let et=Ve(R,S,_,A,P,p),J=Ve(R,S,_,A,P+1,p),G=Ve(R,S,_,A,P-1,p),W=Math.abs(J.x-et.x),b=Math.abs(et.x-G.x),x=(W+b)*.5*1.06;return Math.max(1,x)}function It(R,S,_,A,P,p){let et=(P-p)/Z*Pe+f;return{x:R+Math.cos(et)*_,y:S+Math.sin(et)*A,ang:et}}function Ie(R,S,_,A,P,p,et,J=1,G=null,W=1,b=null,x=0,F=1){a.save(),a.translate(R,S);let Bt=Math.atan2(A,_);if(a.rotate(Bt),a.globalAlpha=J,a.fillStyle=et,a.fillRect(-P/2,-p/2,P,p),b&&x>0&&(a.strokeStyle=b,a.lineWidth=x,a.strokeRect(-P/2,-p/2,P,p)),G){let C=Math.min(P,p)*.28*F;a.globalAlpha=J*W,a.fillStyle=G,a.beginPath(),a.arc(0,0,C,0,Pe),a.fill()}a.restore(),a.globalAlpha=1}return{resize(){let R=Math.max(1,Math.min(2,window.devicePixelRatio||1)),S=Math.floor(n.clientWidth*R),_=Math.floor(n.clientHeight*R);(n.width!==S||n.height!==_)&&(n.width=S,n.height=_,a.setTransform(R,0,0,R,0,0))},render(R=.016,S=performance.now()){this.resize();let _=Nt();Z=l(),V=o();let A=n.clientWidth,P=n.clientHeight;a.clearRect(0,0,A,P),a.fillStyle="#0b0f14",a.fillRect(0,0,A,P);let p=A*.5,et=(A-2*r)/2,J=P-s-i,G=6,W=Z*J/(G*V),b,x,F,Bt;Bt=P-i,W<=Math.min(et,g)?(b=W,x=J,F=s):(b=Math.min(et,g),x=b*G*V/Z,F=Bt-x);let C=b*.28,{killLevel:Et,rotFloat:k,grid:gt,gameState:Pt}=_,Ht=Xt?Xt():{},$t=Ht.waterColor||"blue",tn=Ht.waterBubbles||!1,ln=we[$t]||we.blue,Ut=pt(F,x,Et),w=.7,Yt=Et/V,j={...ln.top},ft={...ln.bottom};if(Yt>w){let v=(Yt-w)/(1-w);j.r=Math.round(j.r+(255-j.r)*v*.5),j.g=Math.round(j.g+(150-j.g)*v*.5),j.b=Math.round(j.b+(150-j.b)*v*.5),ft.r=Math.round(ft.r+(180-ft.r)*v),ft.g=Math.round(ft.g*(1-v*.6)),ft.b=Math.round(ft.b*(1-v*.6))}let Ce=p-b-8,Gt=p+b+8,We=F,pe=Bt+5,he=a.createLinearGradient(0,Ut,0,P);he.addColorStop(0,`rgba(${j.r},${j.g},${j.b},0.5)`),he.addColorStop(1,`rgba(${ft.r},${ft.g},${ft.b},0.7)`),a.fillStyle=he;let ot=Math.round((j.r+ft.r)/2),E=Math.round((j.g+ft.g)/2),N=Math.round((j.b+ft.b)/2),y=b+8,it=C+4;a.fillRect(0,Ut,Ce,P-Ut),a.fillRect(Gt,Ut,A-Gt,P-Ut),a.beginPath();let ht=Math.max(Ut,pe);a.moveTo(Ce,ht),Ut<=pe+it?a.ellipse(p,pe,y,it,0,Math.PI,0,!1):a.lineTo(Gt,ht),a.lineTo(Gt,P),a.lineTo(Ce,P),a.closePath(),a.fill(),a.strokeStyle="rgba(100,180,255,0.6)",a.lineWidth=3,a.lineCap="round",a.beginPath(),a.moveTo(Ce,We),a.lineTo(Ce,pe),a.stroke(),a.beginPath(),a.moveTo(Gt,We),a.lineTo(Gt,pe),a.stroke(),a.beginPath(),a.ellipse(p,pe,b+8,C+4,0,0,Math.PI),a.stroke(),a.fillStyle="#0b0f14",a.beginPath(),a.ellipse(p,pe,b+8,C+4,0,0,Pe),a.fill(),Et>.5&&(a.strokeStyle=`rgba(${Math.min(255,ot+60)},${Math.min(255,E+40)},${Math.min(255,N+40)},0.6)`,a.lineWidth=2,a.beginPath(),a.moveTo(0,Ut),a.lineTo(Ce,Ut),a.moveTo(Gt,Ut),a.lineTo(A,Ut),a.stroke()),qt={left:Ce,right:Gt,h:P,w:A},(te.length>0||tn)&&(le(Ut,P,R),me(Ut)),a.strokeStyle="rgba(160,190,220,0.3)",a.lineWidth=1;let Rt=Pe*b,ye=10,ae=Rt/ye*.7,Oe=Rt/ye*.3;a.setLineDash([ae,Oe]);let Ne=Rt/Z;a.lineDashOffset=be(k)*Ne;for(let v=0;v<=V;v++){let I=pt(F,x,v);a.beginPath(),a.ellipse(p,I,b,C,0,0,Pe),a.stroke()}a.setLineDash([]);let Ke=[],ne=[];for(let v=0;v<V;v++){let I=pt(F,x,v+.5);for(let U=0;U<Z;U++){let O=gt[v][U];if(!O)continue;let X=Ve(p,I,b,C,U,k),H=Math.sin(X.ang),B={y:v,s:U,yScr:I,p:X,depth:H,color:O};H<-.1?Ke.push(B):ne.push(B)}}let jt=Tt.getMagicTargetColor(),{isHighlighting:Vt,highlightedCells:wt,highlightStartTime:Qt,isMagicAnimation:ze}=_,ve=null,ke=1,De=1,Wt=!1;if(Vt&&wt.length>0){ve=new Set(wt.map(I=>`${I.y},${I.s}`));let v=(performance.now()-Qt)/1e3;if(ze){let I=Math.min(1,v/K);ke=1-I*.85,De=1-I*.9,Wt=!0}else{let I=Math.min(1,v/h),U=1-L;if(I>U){let O=(I-U)/L;ke=1-O*.85,De=1-O*.9,Wt=!0}}}Ke.sort((v,I)=>v.depth-I.depth);for(let v of Ke){let I=x/V*.9,U=st[v.color]||null,O=.35,X=1,H=`${v.y},${v.s}`;ve&&ve.has(H)&&(O*=De,X=ke),vt(p,v.yScr,b,C,v.s,k,I,Y,O,U,.5,null,0,1,X)}let{isRingAnimation:ue}=_;if(Vt&&wt.length>0&&!ze){let v=(performance.now()-Qt)/1e3,U=Math.min(1,v/(ue?$:h)),O=1-L,X=U>O,H=X?(U-O)/L:0,B=ue?Math.floor(U*O*Z*2)%Z:-1,M=4+U/O*10,D=Math.sin(v*M*Pe),q=X?1:.3+D*.3,ct=X?1-H*.8:1,mt=X?1-H:1;for(let rt of wt){let tt=pt(F,x,rt.y+.5),bt=St(p,tt,b,C,rt.s,k);if(Math.sin(bt.ang)>=-.1)continue;let un=x/V*.9,se,oe,Ft;if(ue){let Ue=(rt.s-B+Z)%Z,Kt=Ue<3?1-Ue/3:0;se=(X?mt:.2+Kt*.5)*.5,oe=`rgba(255, 159, 67, ${se})`,Ft=X?ct:1+Kt*.15}else se=q*mt,oe=rt.isLine?`rgba(255, 255, 255, ${se*.5})`:`rgba(255, 220, 100, ${se*.4})`,Ft=X?ct:1.1;vt(p,tt,b,C,rt.s,k,un,oe,1,null,1,null,0,1,Ft)}}ne.sort((v,I)=>v.depth-I.depth);for(let v of ne){let I=x/V*.9,U=st[v.color]||null,O=1,X=1,H=1,B=1,M=`${v.y},${v.s}`,D=ve&&ve.has(M);D&&(O=De,X=ke),jt!==null&&!D&&(v.color!==jt?(H=re,B=Jt):B=fe),vt(p,v.yScr,b,C,v.s,k,I,Q,O,U,H,null,0,B,X)}if(Vt&&wt.length>0&&!ze){let v=(performance.now()-Qt)/1e3,U=Math.min(1,v/(ue?$:h)),O=1-L,X=U>O,H=X?(U-O)/L:0,B=ue?Math.floor(U*O*Z*2)%Z:-1,M=4+U/O*10,D=Math.sin(v*M*Pe),q=X?1:.5+D*.5,ct=X?1-H*.8:1,mt=X?1-H:1;for(let rt of wt){let tt=pt(F,x,rt.y+.5),bt=St(p,tt,b,C,rt.s,k);if(Math.sin(bt.ang)<-.1)continue;let un=x/V*.9,se,oe,Ft;if(ue){let Ue=(rt.s-B+Z)%Z,Kt=Ue<4?1-Ue/4:0;se=X?mt:.3+Kt*.7,oe=`rgba(255, 159, 67, ${se})`,Ft=X?ct:1+Kt*.2}else se=q*mt,oe=rt.isLine?`rgba(255, 255, 255, ${se*.7})`:`rgba(255, 220, 100, ${se*.6})`,Ft=X?ct:1.15;vt(p,tt,b,C,rt.s,k,un,oe,1,null,1,null,0,1,Ft)}}let de=_.spellState||_,{transmuteState:Te,transmuteSourceBlock:on,transmuteTargetColor:_e,transmuteAreaCells:en,transmuteBlocksToChange:kt}=de;if(Te==="selecting_source"){let v=x/V*.9,I=.35+Math.sin(S/150)*.15;for(let U of ne){let O=pt(F,x,U.y+.5);vt(p,O,b,C,U.s,k,v,`rgba(0, 40, 20, ${I})`,1,null,1,null,0,1,1)}}if(Te==="selecting_target"&&kt&&kt.length>0){let v=x/V*.9,I=.4+Math.sin(S/120)*.25,U=.6+Math.sin(S/120)*.4;for(let O of kt){if(O.y<0||O.y>=V)continue;let X=pt(F,x,O.y+.5),H=St(p,X,b,C,O.s,k);Math.sin(H.ang)<-.1||(vt(p,X,b,C,O.s,k,v,`rgba(0, 50, 30, ${I})`,1,null,1,null,0,1,1),vt(p,X,b,C,O.s,k,v,"transparent",1,null,1,`rgba(100, 255, 150, ${U})`,3,1,1.02))}}if(Te==="animating"&&Tt.getTransmuteAnimState){let v=Tt.getTransmuteAnimState(S);if(v){let I=x/V*.9,{phase:U,progress:O,areaFlash:X}=v;if(X>0&&en)for(let H of en){if(H.y<0||H.y>=V)continue;let B=pt(F,x,H.y+.5),M=St(p,B,b,C,H.s,k);Math.sin(M.ang)<-.1||vt(p,B,b,C,H.s,k,I,`rgba(150, 255, 200, ${X*.4})`,1,null,1,null,0,1,1)}if(kt&&kt.length>0){let H=on?on.color:1,B=_e||1;for(let M of kt){if(M.y<0||M.y>=V)continue;let D=pt(F,x,M.y+.5),q=St(p,D,b,C,M.s,k);if(Math.sin(q.ang)<-.1)continue;let mt=1,rt=st[H],tt=0;if(U==="shrink"?(mt=1-O*.95,rt=st[H],tt=.5+O*.3):U==="grow"&&(mt=O,rt=st[B],tt=.8-O*.5),tt>0&&vt(p,D,b,C,M.s,k,I,`rgba(200, 255, 220, ${tt})`,1,null,1,null,0,1,1),mt>.05){let bt=Lt(p,D,b,C,M.s,k,I,1),$e=Math.min(bt.wApprox,bt.hApprox)*.28*mt;a.save(),a.globalAlpha=1,a.fillStyle=rt,a.beginPath(),a.arc(bt.cx,bt.cy,$e,0,Pe),a.fill(),a.restore()}}}}}let{lightningState:ge,lightningSourceBlock:an,lightningAreaCells:Tn,lightningBlocksToHit:qe}=de;if(ge==="selecting_source"){let v=x/V*.9,I=.35+Math.sin(S/150)*.15;for(let U of ne){let O=pt(F,x,U.y+.5);vt(p,O,b,C,U.s,k,v,`rgba(20, 20, 60, ${I})`,1,null,1,null,0,1,1)}}if(ge==="animating"&&Tt.getLightningAnimState){let v=Tt.getLightningAnimState(S);if(v&&qe&&qe.length>0){let I=x/V*.9,{phase:U,flashProgress:O,currentTarget:X,jumpProgress:H,struckTargets:B}=v;if(U==="flash"&&O>0&&Tn)for(let M of Tn){if(M.y<0||M.y>=V)continue;let D=pt(F,x,M.y+.5),q=St(p,D,b,C,M.s,k);Math.sin(q.ang)<-.1||vt(p,D,b,C,M.s,k,I,`rgba(100, 150, 255, ${O*.5})`,1,null,1,null,0,1,1)}if(B&&B.length>0)for(let M of B){let D=qe[M];if(!D||D.y<0||D.y>=V)continue;let q=pt(F,x,D.y+.5),ct=St(p,q,b,C,D.s,k);if(Math.sin(ct.ang)<-.1)continue;let rt=(B.length-1-B.indexOf(M))*.1,tt=Math.max(0,.8-rt);vt(p,q,b,C,D.s,k,I,`rgba(255, 255, 255, ${tt})`,1,null,1,`rgba(150, 200, 255, ${tt})`,2,1,1.05)}if(U==="chain"&&X>=0&&X<qe.length){let M=qe[X];if(M&&M.y>=0&&M.y<V){let D=pt(F,x,M.y+.5),q=St(p,D,b,C,M.s,k);if(Math.sin(q.ang)>=-.1){let mt=1-H;vt(p,D,b,C,M.s,k,I,`rgba(200, 220, 255, ${mt*.9})`,1,null,1,`rgba(100, 180, 255, ${mt})`,3,1,1.1-H*.05)}}if(X>0){let D=qe[X-1],q=qe[X];if(D&&q){let ct=pt(F,x,D.y+.5),mt=pt(F,x,q.y+.5),rt=Lt(p,ct,b,C,D.s,k,I,1),tt=Lt(p,mt,b,C,q.s,k,I,1);a.save(),a.strokeStyle=`rgba(150, 200, 255, ${1-H*.5})`,a.lineWidth=2+(1-H)*2,a.lineCap="round",a.beginPath();let bt=rt.cx,$e=rt.cy,un=tt.cx,se=tt.cy;a.moveTo(bt,$e);let oe=4;for(let Ft=1;Ft<=oe;Ft++){let Ue=Ft/oe,Kt=bt+(un-bt)*Ue,Be=$e+(se-$e)*Ue,Kn=Ft<oe?(Math.random()-.5)*8:0;a.lineTo(Kt+Kn,Be+Kn)}a.stroke(),a.strokeStyle=`rgba(100, 150, 255, ${(1-H)*.3})`,a.lineWidth=6,a.stroke(),a.restore()}}}}}let{fireState:je,fireSourceBlock:_n,fireLineCells:He,fireTargets:hn}=de;if(je==="selecting_source"){let v=x/V*.9,I=.3+Math.sin(S/140)*.2;for(let U of ne){let O=pt(F,x,U.y+.5);vt(p,O,b,C,U.s,k,v,`rgba(70, 25, 10, ${I})`,1,null,1,null,0,1,1)}}if(je==="animating"&&Tt.getFireAnimState){let v=Tt.getFireAnimState(S);if(v&&He&&He.length>0){let I=x/V*.9,{progress:U,flashProgress:O}=v,X=Math.sin(U*Math.PI);if(O>0)for(let H of He){if(H.y<0||H.y>=V)continue;let B=pt(F,x,H.y+.5),M=St(p,B,b,C,H.s,k);Math.sin(M.ang)<-.1||vt(p,B,b,C,H.s,k,I,`rgba(255, 120, 50, ${O*.45})`,1,null,1,`rgba(255, 200, 140, ${O*.5})`,2,1,1.03)}if(_n){let H=new Map;for(let M of He){if(M.y<0||M.y>=V)continue;let D=pt(F,x,M.y+.5),q=St(p,D,b,C,M.s,k);if(Math.sin(q.ang)<-.1)continue;let mt=Lt(p,D,b,C,M.s,k,I,1),rt=M.s-_n.s;rt>Z/2&&(rt-=Z),rt<-Z/2&&(rt+=Z);let tt=M.y;H.has(tt)||H.set(tt,[]),H.get(tt).push({x:mt.cx,y:mt.cy,offset:rt})}let B=Array.from(H.keys()).sort((M,D)=>D-M);if(B.length>0){let M=.35+.3*Math.sin(S/60)+X*.2;a.save(),a.lineCap="round";for(let D of B){let q=H.get(D)||[];if(q.sort((ct,mt)=>ct.offset-mt.offset),q.length!==0){a.beginPath(),a.moveTo(q[0].x,q[0].y);for(let ct=1;ct<q.length;ct++)a.lineTo(q[ct].x,q[ct].y);a.strokeStyle=`rgba(255, 140, 60, ${M})`,a.lineWidth=Math.max(2,I*.15),a.stroke(),a.strokeStyle=`rgba(255, 210, 140, ${M*.35})`,a.lineWidth=Math.max(6,I*.35),a.stroke()}}a.restore()}}if(hn&&hn.length>0){let H=.2+X*.6;for(let B of hn){if(B.y<0||B.y>=V)continue;let M=pt(F,x,B.y+.5),D=St(p,M,b,C,B.s,k);Math.sin(D.ang)<-.1||vt(p,M,b,C,B.s,k,I,`rgba(255, 160, 70, ${H})`,1,null,1,`rgba(255, 230, 180, ${X*.6})`,2,1,1.05)}}}}let{activePiece:Xe,pieceY:Bn,isGrounded:Wn,lockTimer:Ln}=_;if(Xe){let v=Tt.snappedRot(),I=v,U=Tt.computeGhostY(),O=x/V*.9;if(U!==null){let B=[];for(let M=0;M<Xe.cells.length;M++){let D=Xe.cells[M],q=Xe.colors[M],ct=U+D.y,mt=Tt.normSector(v+D.x);if(ct<0||ct>=V)continue;let rt=pt(F,x,ct+.5),tt=St(p,rt,b,C,mt,I);B.push({cy:ct,cs:mt,yScr:rt,depth:Math.sin(tt.ang),color:q})}B.sort((M,D)=>M.depth-D.depth);for(let M of B){let D=st[M.color]||null;vt(p,M.yScr,b,C,M.cs,I,O,Me,1,D,.5,xe,Zt,1,1)}}let X=Mt;if(Wn&&Ln>0){let B=Math.min(1,Ln/z),M=255,D=Math.round(170+85*B),q=Math.round(180+75*B),ct=.75+(1-.75)*B;X=`rgba(${M},${D},${q},${ct})`}let H=[];for(let B=0;B<Xe.cells.length;B++){let M=Xe.cells[B],D=Xe.colors[B],q=Tt.normSector(v+M.x),ct=Bn+M.y;if(ct<0||ct>=V)continue;let mt=pt(F,x,ct+.5),rt=St(p,mt,b,C,q,I);H.push({cs:q,yScr:mt,depth:Math.sin(rt.ang),color:D})}H.sort((B,M)=>B.depth-M.depth);for(let B of H){let M=st[B.color]||null;vt(p,B.yScr,b,C,B.cs,I,O,X,1,M,1,null,0,1,1)}}},drawNextPreview(R,S){if(!R)return;let _=R.getContext("2d"),A=R.width,P=R.height;if(_.clearRect(0,0,A,P),!S)return;let p=1/0,et=-1/0,J=1/0,G=-1/0;for(let C of S.cells)p=Math.min(p,C.x),et=Math.max(et,C.x),J=Math.min(J,C.y),G=Math.max(G,C.y);let W=et-p+1,b=G-J+1,x=Math.min(A/(W+.5),P/(b+.5)),F=(A-W*x)/2,Bt=(P-b*x)/2;_.fillStyle=Q;for(let C=0;C<S.cells.length;C++){let Et=S.cells[C],k=F+(Et.x-p)*x,gt=Bt+(b-1-(Et.y-J))*x;_.fillRect(k+1,gt+1,x-2,x-2);let Pt=S.colors[C],Ht=st[Pt];if(Ht){let $t=(x-2)*.32;_.fillStyle=Ht,_.beginPath(),_.arc(k+x/2,gt+x/2,$t,0,Pe),_.fill(),_.fillStyle=Q}}},spawnBonusBubbles(R){let{left:S,right:_,h:A,w:P}=qt;P>0&&Dt(R,S,_,A,P)}}}(()=>{let e=Ks(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,o=30,s=24,i=120,r={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function g(t){let u=r[t]||r["30_24"];o=u.N,s=u.H,i=u.survivalTime}function m(){return s/i}let f=Math.PI/2,h=70,L=120,K=30,$=320,z=.42,nt="rgb(235,240,250)",st="rgb(55,62,75)",ce="rgba(255,170,180,0.75)",Q="rgba(110,255,150,0.15)",Y="rgba(110,255,150,0.85)",Mt=2,Me={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},xe={1:"fire",2:"water",3:"lightning",4:"earth"},Zt={fire:1,water:2,lightning:3,earth:4},re=1,Jt=.58,fe=!0,Nt=12,Xt=25,Tt=1,a=2,Z=3,V=5,we=8,te=10,xt=15,Dt=30,le=2,me=.3,qt=.5,pt=1,be=.3,Ve=.5,At=1.3,ee=10,St=500,Lt=[1,1.25,1.5,1.75,2],vt=10,Fe=100,It=25,Ie=[1,1.3,1.6,2],R=[1,1.5,2,2.5],S=Ws(),_=S.loadGameSettings(),A=_.invertSwipe?-1:1,P=-1,p=Array.from({length:s},()=>new Uint8Array(o));function et(){p=Array.from({length:s},()=>new Uint8Array(o))}let J=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],G=null,W=s+3,b=0,x=0,F=!1,Bt=0,C=0,Et=0,k=3,gt=0,Pt=0,Ht=0,$t=no({canvas:n,rotDir:A}),tn="0.15.0",ln=!0,Ut="blue",w=Ns();w.preload();let Yt=so(),j="intro",ft=0,Ce=0,Gt=0,We=0,pe=0,he=null,ot=Yt.stats,E=e.overlay,N=qs({elementColors:Me}),y=N.showBonus.bind(N),it=N.getElementIcon.bind(N),ht=Qs(),Rt=e.overlayTitle,ye=e.overlayStats,ae=e.startBtn,Oe=e.hud,Ne=e.scoreHud,Ke=e.timeHud,ne=e.remainingHud,jt=e.nextCanvas,Vt=jt.getContext("2d"),wt=e.pauseBtn,Qt=e.pauseOverlay,ze=e.resumeBtn,ve=e.restartBtn,ke=e.exitToMenuBtn,De=e.pauseSettingsBtn,Wt=e.pauseSoundBtn,ue=e.pauseMusicBtn,de=e.pauseBestScore,Te=e.pauseBestTime,on=e.pauseBestMode,_e=e.pauseCurrentScore,en=e.pauseCurrentTime,kt=e.pauseCurrentMode,ge=e.confirmDialog,an=e.confirmText,Tn=e.confirmCancel,qe=e.confirmOk,je=e.settingsOverlay,_n=e.settingsClose,He=e.fullscreenBtn,hn=e.rotateBtn,Xe=e.startPanel,Bn=e.gameoverPanel,Wn=e.goScore,Ln=e.goTime,v=e.goRing,I=e.goMatches,U=e.goBonuses,O=e.goNewRecord,X=e.goRestartBtn,H=e.goExitBtn,B=e.bestScore,M=e.bestTimeVal,D=e.startVersion,q=e.modeBtns,ct=e.recordsBtn,mt=e.startSettingsBtn,rt=e.helpBtn,tt="25_20",bt=Zs({buttons:e.magicBtns,onActivate:()=>w.play("spells")}),$e=e.magicBtns,un=bt.charges,se=t=>bt.select(t),oe=()=>bt.updateButtons(),Ft=e.spellWave;function Ue(){Ft&&(Ft.classList.remove("active"),Ft.offsetWidth,Ft.classList.add("active"),setTimeout(()=>Ft.classList.remove("active"),1200))}let Kt=null,Be=Js({button:e.spellBtn,onReady:()=>{w.play("readysuper")}});Kt=eo({canvas:n,dom:e,getGrid:()=>p,getN:()=>o,getH:()=>s,getRotFloat:()=>gt,constants:{TOP_PAD_PX:h,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:K,MAX_RADIUS_X:$,SCORE_MAGIC_DESTROY:It},helpers:{normSector:In,levelYToScreenY:An,sectorCenterXY:Pn},Spell:Be,Magic:bt,SoundModule:w,State:Yt,isGamePlaying:()=>j==="playing",addPendingKzDrop:t=>{Et+=t},getKillRate:m,triggerSpellWave:Ue,spawnSpellBubbles:t=>{ht.spawnSpellBubbles(Be.button,t)},spawnBonusBubbles:t=>{gn.spawnBonusBubbles(t)},getTransmuteEffect:()=>Be.getEffect("earth"),getLightningEffect:()=>Be.getEffect("air"),getFireEffect:()=>Be.getEffect("fire"),continueMatchProcessing:wn,updateScoreHud:Mn,showBonus:y,setScore:t=>{ft=t},setCascadeLevel:t=>{Je=t}}),Be.initButton(()=>{Kt.handleSpellButtonClick()});function gs(){return tt==="30_24"}function Rn(){let t=e.spellBtn;t&&(t.style.display=gs()?"":"none")}let Qe=[],yn=0,Ze=!1,cn=!1,Sn=!1,Le=0,Ye=0,Je=0,dn=[];function An(t,u,d){let T=1-d/s;return t+T*u}function Pn(t,u,d,T,lt,dt){let yt=(lt-dt)/o*l+f;return{x:t+Math.cos(yt)*d,y:u+Math.sin(yt)*T,ang:yt}}function fs(t,u){let d=n.clientWidth,T=n.clientHeight,lt=d*.5,dt=(d-2*K)/2,yt=T-h-L,ie=6,Re=o*yt/(ie*s),fn=T-L,Ge,Ct,at;Re<=Math.min(dt,$)?(Ge=Re,Ct=yt,at=h):(Ge=Math.min(dt,$),Ct=Ge*ie*s/o,at=fn-Ct);let ut=Ge*.28,Ot=An(at,Ct,t+.5),zt=Pn(lt,Ot,Ge,ut,u,gt),Se=n.getBoundingClientRect();return{x:Se.left+zt.x,y:Se.top+zt.y}}function po(t,u){if(!bt.canUse()||Ze)return!1;let d=Zt[bt.active],T=n.clientWidth,lt=n.clientHeight,dt=T*.5,yt=(T-2*K)/2,ie=lt-h-L,Re=6,fn=o*ie/(Re*s),Ge=lt-L,Ct,at,ut;fn<=Math.min(yt,$)?(Ct=fn,at=ie,ut=h):(Ct=Math.min(yt,$),at=Ct*Re*s/o,ut=Ge-at);let Ot=Ct*.28,zt=null,Se=1/0;for(let Ee=0;Ee<s;Ee++){let mn=An(ut,at,Ee+.5);for(let Ae=0;Ae<o;Ae++){let Un=p[Ee][Ae];if(!Un||Un!==d)continue;let Cn=Pn(dt,mn,Ct,Ot,Ae,gt);if(Math.sin(Cn.ang)<-.1)continue;let Yn=t-Cn.x,Ds=u-Cn.y,Hs=Math.hypot(Yn,Ds),$s=at/s*.9,Yo=$s*1.2;Math.abs(Yn)<Yo/2&&Math.abs(Ds)<$s/2&&Hs<Se&&(Se=Hs,zt={y:Ee,s:Ae})}}if(zt){let Ee=An(ut,at,zt.y+.5),mn=Pn(dt,Ee,Ct,Ot,zt.s,gt),Ae=n.getBoundingClientRect(),Un=Ae.left+mn.x,Cn=Ae.top+mn.y,ks=$e[bt.active];return ht.spawnMagicShot(bt.active,ks,Un,Cn,()=>{let Yn=p[zt.y][zt.s];Qe=[{y:zt.y,s:zt.s,color:Yn,isLine:!1,isMagic:!0}],yn=performance.now(),Ze=!0,cn=!0,Le=0,Ye=It,y(`+${It}`,"score")}),Je=0,bt.useCharge(),ot.magicUsed++,!0}return!1}let ni=100;function si(t,u){return us(t,u,s,o)}function ho(){return co(p,s,o)}let yo=ro;function So(t){let u=t.map(T=>({...T,color:p[T.y][T.s]}));for(let T of t)p[T.y][T.s]=0;let d=s;for(let T of t){let lt=T.y;for(let dt=1;dt<=T.y;dt++){let yt=T.y-dt;if(p[yt][T.s]){lt=dt-1;break}}d=Math.min(d,lt)}for(let T of u)p[T.y-d][T.s]=T.color;return d>0}function Eo(){let t=!0;for(;t;){t=!1;let u=ho();for(let d of u)yo(d)||So(d)&&(t=!0)}}function Mo(){wn()}let zn=oo;function ms(t,u){let d=new Map,T=0,lt=0,dt=0,yt={},ie=t.length+u.length;for(let at of t){let ut=xe[at.color],Ot=0,zt=0;if(at.length>=5?(Ot=Z,zt=te,ot.lines5++):at.length===4?(Ot=a,zt=we,ot.lines4++):at.length===3&&(Ot=Tt,zt=V,ot.lines3++),ut&&Ot>0){bt.addCharges(ut,Ot),yt[ut]=(yt[ut]||0)+Ot;let Se=at.cells[Math.floor(at.cells.length/2)],Ee=fs(Se.y,Se.s),mn=$e[ut];for(let Ae=0;Ae<Ot;Ae++)setTimeout(()=>{ht.spawnMagicOrb(ut,Ee.x,Ee.y,mn)},Ae*100)}T+=zt*m(),dt+=zt,lt+=at.length*vt;for(let Se of at.cells){let Ee=`${Se.y},${Se.s}`;d.has(Ee)||d.set(Ee,{y:Se.y,s:Se.s,color:at.color,isLine:!0})}}for(let at of u){if(ot.pairs++,T+=xt*m(),dt+=xt,lt+=Fe,gs()&&Be.addProgress(1)){let ut=at.cells[Math.floor(at.cells.length/2)],Ot=fs(ut.y,ut.s);ht.spawnSpellOrb(Ot.x,Ot.y,Be.button)}for(let ut of at.cells){let Ot=`${ut.y},${ut.s}`;d.has(Ot)||d.set(Ot,{y:ut.y,s:ut.s,color:p[ut.y][ut.s],isLine:!1})}}let Re=zn(Ie,ie-1),fn=zn(R,Je),Ge=Math.round(lt*Re*fn),Ct=0;ie>1&&(ot.combos++,ot.maxCombo=Math.max(ot.maxCombo,ie),setTimeout(()=>y(`COMBO \xD7${ie}`,"combo"),Ct),Ct+=180,w.play("combo2")),Je>0&&(ot.cascades++,ot.maxCascade=Math.max(ot.maxCascade,Je),setTimeout(()=>y(`CASCADE \xD7${Je}`,"cascade"),Ct),Ct+=180,w.play("cascade")),(t.length>0||u.length>0)&&w.play("combo");for(let at of t){let ut=at.length,Ot=ut*vt;setTimeout(()=>y(`Line-${ut} +${Ot}`,"line",at.color),Ct),Ct+=100}for(let at of u){let ut=at.cells.length>0?p[at.cells[0].y][at.cells[0].s]:null;setTimeout(()=>y(`Pair +${Fe}`,"pair",ut),Ct),Ct+=100}Ge>0&&(setTimeout(()=>y(`+${Ge}`,"score"),Ct),Ct+=120),dt>0&&(setTimeout(()=>y(`+${dt}s`,"time"),Ct),Ct+=120);for(let[at,ut]of Object.entries(yt))ut>0&&(setTimeout(()=>y(`+${ut}${it(at)}`,"charge"),Ct),Ct+=120);Qe=Array.from(d.values()),yn=performance.now(),Ze=!0,cn=!1,Le=T,Ye=Ge,oe()}function xo(){for(let t of Qe)p[t.y][t.s]=0;if(Qe.length>0&&w.playRandom("disappear"),Le>0){Et+=Le;let t=Le/m();gn.spawnBonusBubbles(t)}Yt.addScore(Ye),ft+=Ye,Mn(),Qe=[],Ze=!1,cn=!1,Le=0,Ye=0,Je++,wn()}function wn(){Eo();let{lineMatches:t,pairMatches:u}=Po();if(t.length>0||u.length>0)ms(t,u);else{let d=Ms();d.length>0?Lo(d):!G&&j==="playing"&&Es()}}function oi(t,u){ms(t,u)}function In(t){return pn(t,o)}function On(){return In(Math.round(gt))}function ps(t,u){return ds(G,t,u,p,s,o)}function kn(t){return ps(t,On())}let Dn=io;function hs(){fe&&(Nt!==0&&Bt>=Nt||(x=0,Bt+=1))}function bo(){if(!G)return;let t=G.cells,u=G.colors,d={cells:t,colors:u};if(P>=0||(d=Dn(d.cells,d.colors),d=Dn(d.cells,d.colors)),d=Dn(d.cells,d.colors),G.cells=d.cells,G.colors=d.colors,!kn(Math.floor(W))){G.cells=t,G.colors=u;return}w.play("turn"),F&&hs()}function Co(){return lo(G,W,On(),p,s,o)}function vo(){if(!G)return!1;let t=Math.floor(W)-1,u=!kn(t);return u&&!F?(F=!0,x=0,Bt=0):!u&&F&&(F=!1,x=0,Bt=0),u}let rn=Vn;function En(){if(j==="playing"){E.classList.add("hidden"),wt.classList.remove("hidden");return}if(E.classList.remove("hidden"),wt.classList.add("hidden"),j==="intro"){Xe.classList.remove("hidden"),Bn.classList.add("hidden");let t=S.loadHighscore(tt);t.score>0?(B.textContent=t.score.toLocaleString(),M.textContent=rn(t.time)):(B.textContent="0",M.textContent="0:00"),Is(),D.textContent=`v${tn}`,ae.classList.remove("idlePulse"),ae.offsetWidth,ae.classList.add("idlePulse")}else{Xe.classList.add("hidden"),Bn.classList.remove("hidden"),Wn.textContent=ft.toLocaleString(),Ln.textContent=rn(Gt);let t=S.loadHighscore(tt);ft>0&&ft>=t.score?O.classList.remove("hidden"):O.classList.add("hidden");let u=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${ot.rings}</span>
          <span class="count ring-max">${ot.maxRing>0?"max \xD7"+ot.maxRing:""}</span>
        </div>
      `;v.innerHTML=u;let d=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${ot.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${ot.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${ot.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${ot.pairs}</span>
        </div>
      `;I.innerHTML=d;let T=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${ot.combos}</span>
          <span class="count max-combo">${ot.maxCombo>0?"max \xD7"+ot.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${ot.cascades}</span>
          <span class="count max-cascade">${ot.maxCascade>0?"max \xD7"+ot.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${ot.magicUsed}</span>
        </div>
      `;U.innerHTML=T}}function Mn(){Ne.textContent=`Score: ${ft}`}function qn(){Ke.textContent=`Time: ${rn(Gt)}`}function ys(){let t=Math.max(0,(s-C)/m()),u=Math.floor(t/60),d=Math.floor(t%60);ne.textContent=`Left: ${u}:${d.toString().padStart(2,"0")}`,t<30?ne.classList.add("warning"):ne.classList.remove("warning")}function To(){g(tt),et(),C=0,Et=0,gt=Pt=0,Ht=0,Yt.start(),ot=Yt.stats,ft=0,Ce=performance.now(),Gt=0,pe=0,We=0,j="playing",he=null,bt.reset(),Be.reset(),Rn(),Qe=[],dn=[],Ze=!1,cn=!1,Sn=!1,Le=0,Ye=0,Je=0,Kt.reset(),oe(),Mn(),qn(),ys(),Es(),gn.drawNextPreview(jt,he),En(),w.getSettings().musicEnabled&&w.startGameMusic()}function jn(){Yt.gameOver(),j="gameover",G=null,F=!1,x=0,Bt=0;let t=S.saveHighscore(ft,Gt,tt);w.stopMusic(),w.play("gameover"),qn(),En(),t&&ft>0&&setTimeout(()=>{y("\u{1F3C6} NEW RECORD!","score")},500)}function _o(t){for(let d=0;d<50;d++){let T=t.map(()=>1+(Math.random()*4|0));if(!Bo(t,T))return T}return t.map((d,T)=>1+T%4)}let Bo=go;function Ss(t){let u=t.cells.map(T=>({x:T.x,y:T.y})),d=_o(u);return{name:t.name,cells:u,colors:d}}function Es(){if(!he){let lt=J[Math.random()*J.length|0];he=Ss(lt)}G=he;let t=J[Math.random()*J.length|0];he=Ss(t),gn.drawNextPreview(jt,he);let u=1/0,d=-1/0;for(let lt of G.cells)lt.x<u&&(u=lt.x),lt.x>d&&(d=lt.x);let T=(u+d)/2;for(let lt of G.cells)lt.x=lt.x-Math.round(T);W=s+3,b=0,F=!1,x=0,Bt=0,kn(Math.floor(W))?w.playRandom("appear"):jn()}function Ms(){return uo(p,s,o)}function Lo(t){if(t.length===0)return;let u=[];for(let ie of t)for(let Re=0;Re<o;Re++)u.push({y:ie,s:Re,color:p[ie][Re],isLine:!1});dn=t,Qe=u,yn=performance.now(),Ze=!0,Sn=!0,cn=!1;let d=t.length;ot.rings+=d,ot.maxRing=Math.max(ot.maxRing,d);let T=zn(Lt,d-1),lt=Math.round(St*d*T),dt=Dt*d;Ye=lt,Le=dt*m(),w.play("ring");let yt=`RING \xD7${d}`;y(yt,"ring"),setTimeout(()=>y(`+${lt}`,"score"),150),setTimeout(()=>y(`+${dt}s`,"time"),300)}function Ro(){let t=[...dn].sort((u,d)=>d-u);for(let u of t){for(let d=u;d<s-1;d++)p[d].set(p[d+1]);p[s-1].fill(0)}if(Le>0){Et+=Le;let u=Le/m();gn.spawnBonusBubbles(u)}Yt.addScore(Ye),ft+=Ye,Mn(),tt==="30_24"&&dn.length>0&&(sn=S.addHighTowerRings(dn.length)),Qe=[],dn=[],Ze=!1,Sn=!1,Le=0,Ye=0,wn()}function ii(){return Ms().length}function Ao(){if(!G)return;let t=On();gt=t,Pt=t,Ht=0;let u=!1;for(let d=0;d<G.cells.length;d++){let T=G.cells[d],lt=G.colors[d],dt=Math.floor(W)+T.y,yt=In(t+T.x);dt>=s&&(u=!0),dt>=0&&dt<s&&(p[dt][yt]=lt)}if(u){jn();return}Yt.addScore(ee),ft+=ee,Mn(),y(`+${ee}`,"score"),w.playRandom("drop"),G=null,Je=0,Mo()}function Po(){return ao(p,s,o)}function wo(){if(!G)return!1;let t=Math.floor(W)-1;return kn(t)?(W=t,F=!1,x=0,Bt=0,!0):(F=!0,!1)}n.addEventListener("pointerdown",t=>{if(_t.state!=="playing")return;t.preventDefault?.();let u=n.getBoundingClientRect(),d=t.clientX-u.left,T=t.clientY-u.top;$t.handlePointerDown(t,{onMagicTap:()=>Kt.handleTap(d,T)?!0:_t.applyCommand("magic_shoot",{x:d,y:T}),onDoubleTap:()=>_t.applyCommand("rotate_piece")},Pt)||(Ht=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(_t.state!=="playing"||!$t.dragging)return;t.preventDefault?.();let u=$t.handlePointerMove(t,{canRotateTo:(d,T)=>_t.canRotateTo(d,T),onDrop:()=>_t.applyCommand("move_down"),onGroundedMove:()=>_t.onGroundedMove()},_t.pieceY,_t.isGrounded);u&&_t.setRotation(u.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{_t.state==="playing"&&$t.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{$t.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{$t.dragging&&$t.handlePointerUp(t)},{passive:!1}),hn.addEventListener("click",()=>{_t.state==="playing"&&_t.applyCommand("rotate_piece")});let Hn=e.dropBtn,$n=null;function Io(){_t.state==="playing"&&(_t.applyCommand("move_down"),$n=setInterval(()=>{if(_t.state!=="playing"){Gn();return}_t.applyCommand("move_down")},Xt))}function Gn(){$n&&(clearInterval($n),$n=null)}Hn.addEventListener("pointerdown",t=>{t.preventDefault(),Io()}),Hn.addEventListener("pointerup",Gn),Hn.addEventListener("pointerleave",Gn),Hn.addEventListener("pointercancel",Gn);for(let[t,u]of Object.entries($e))u.addEventListener("click",()=>{_t.state==="playing"&&_t.applyCommand("select_magic",{element:t})});let Qn=e.soundsToggle,Zn=e.musicToggle;function nn(){let t=w.getSettings();t.soundsEnabled?Qn.classList.add("active"):Qn.classList.remove("active"),t.musicEnabled?Zn.classList.add("active"):Zn.classList.remove("active");for(let u=0;u<=4;u++){let d=e.soundVolBtns[u],T=e.musicVolBtns[u];d&&d.classList.toggle("active",t.soundVolume===u),T&&T.classList.toggle("active",t.musicVolume===u)}}let xs=e.tabBtns,Oo=e.tabContents;xs.forEach(t=>{t.addEventListener("click",()=>{let u=t.dataset.tab;xs.forEach(d=>d.classList.remove("active")),Oo.forEach(d=>d.classList.remove("active")),t.classList.add("active"),zs(u).classList.add("active"),u==="sounds"&&nn()})});let bs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Cs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,ko=e.iosHint,Do=e.standaloneBadge;function vs(){let t=document.fullscreenElement||document.webkitFullscreenElement;He.textContent=t?"Disable":"Enable"}bs&&(Cs?(Do.style.display="block",He.style.display="none"):(ko.style.display="block",He.textContent="Not supported",He.style.opacity="0.5",He.style.cursor="default")),He.addEventListener("click",()=>{if(bs&&!Cs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let u=document.documentElement;u.requestFullscreen?u.requestFullscreen():u.webkitRequestFullscreen&&u.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",vs),document.addEventListener("webkitfullscreenchange",vs);let Fn=e.invertSwipeToggle;_.invertSwipe&&Fn.classList.add("active"),Fn.addEventListener("click",()=>{Fn.classList.toggle("active");let t=Fn.classList.contains("active");$t.rotDir=t?-1:1,_.invertSwipe=t,S.saveGameSettings(_)});let Ts=e.diffBtns;Ts.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Ts.forEach(u=>{u.classList.remove("active");let d=u.querySelector(".check-icon");d&&d.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let u=document.createElement("span");u.className="check-icon",u.textContent="\u2713",t.appendChild(u)}})}),Qn.addEventListener("click",()=>{let u=!w.getSettings().soundsEnabled;w.updateSettings({soundsEnabled:u}),nn(),xn()}),Zn.addEventListener("click",()=>{let u=!w.getSettings().musicEnabled;w.updateSettings({musicEnabled:u}),nn(),xn(),j!=="paused"&&(u?j==="playing"?w.startGameMusic():w.startMenuMusic():w.stopMusic())});for(let t=0;t<=4;t++){let u=e.soundVolBtns[t];u&&u.addEventListener("click",()=>{w.updateSettings({soundVolume:t}),nn(),w.play("turn")})}for(let t=0;t<=4;t++){let u=e.musicVolBtns[t];u&&u.addEventListener("click",()=>{w.updateSettings({musicVolume:t}),nn()})}nn();function _s(){j==="playing"&&(Yt.pause(),We=performance.now(),j="paused",w.musicAudio&&w.musicAudio.pause())}function Nn(){j==="paused"&&(Yt.resume(),pe+=performance.now()-We,We=0,j="playing",es=performance.now(),w.getSettings().musicEnabled&&w.startGameMusic())}function xn(){let t=w.getSettings();Wt.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Wt.classList.toggle("off",!t.soundsEnabled),ue.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",ue.classList.toggle("off",!t.musicEnabled)}function Ho(){Qt.classList.remove("hidden"),wt.classList.add("hidden");let t=S.loadHighscore(tt);de.textContent=t.score?t.score.toLocaleString():"0",Te.textContent=t.time?Vn(t.time):"0:00",on.textContent=tt==="30_24"?"High Tower":"Quick Tower",_e.textContent=ft.toLocaleString(),en.textContent=Vn(Gt),kt.textContent=tt==="30_24"?"High Tower":"Quick Tower",xn()}function bn(){Qt.classList.add("hidden"),wt.classList.remove("hidden")}wt.addEventListener("click",()=>{_s(),Ho()}),ze.addEventListener("click",()=>{bn(),Nn()});let Jn=null;function Bs(t,u){an.textContent=t,Jn=u,ge.classList.remove("hidden")}function Ls(){ge.classList.add("hidden"),Jn=null}Tn.addEventListener("click",()=>{Ls()}),qe.addEventListener("click",()=>{let t=Jn;Ls(),t&&t()}),ve.addEventListener("click",()=>{Bs("Restart game?",()=>{bn(),_t.applyCommand("start_game")})}),ke.addEventListener("click",()=>{Bs("Exit to menu?",()=>{bn(),wt.classList.add("hidden"),j="intro",Yt.reset(),w.stopMusic(),w.getSettings().musicEnabled&&w.startMenuMusic(),En()})}),De.addEventListener("click",()=>{je.classList.remove("hidden")}),Wt.addEventListener("click",()=>{let t=w.getSettings();w.updateSettings({soundsEnabled:!t.soundsEnabled}),xn(),nn()}),ue.addEventListener("click",()=>{let u=!w.getSettings().musicEnabled;w.updateSettings({musicEnabled:u}),xn(),nn()}),Qt.addEventListener("click",t=>{t.target===Qt&&(bn(),Nn())}),document.addEventListener("keydown",t=>{j==="paused"&&!Qt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(bn(),Nn())}),_n.addEventListener("click",()=>{je.classList.add("hidden")}),je.addEventListener("click",t=>{t.target===je&&je.classList.add("hidden")});let ts=!1;document.addEventListener("visibilitychange",()=>{document.hidden?j==="playing"&&(_s(),ts=!0):ts&&j==="paused"&&(Nn(),ts=!1)});let _t=fo({getN:()=>o,getH:()=>s,FALL_INTERVAL:re,LOCK_DELAY_SEC:Jt,getKillRate:m,MATCH_HIGHLIGHT_SEC:le,MAGIC_SHRINK_SEC:qt,RING_HIGHLIGHT_SEC:pt,getState:()=>({gameState:j,score:ft,elapsedMs:Gt,startTime:Ce,totalPausedMs:pe,stats:ot,activePiece:G,pieceY:W,targetRot:Pt,rotFloat:gt,rotVel:Ht,isGrounded:F,isHighlighting:Ze,isMagicAnimation:cn,isRingAnimation:Sn,highlightStartTime:yn,killLevel:C,grid:p,fallTimer:b,lockTimer:x}),setState:t=>{"elapsedMs"in t&&(Gt=t.elapsedMs),"killLevel"in t&&(C=t.killLevel),"fallTimer"in t&&(b=t.fallTimer),"lockTimer"in t&&(x=t.lockTimer),"targetRot"in t&&(Pt=t.targetRot),"rotFloat"in t&&(gt=t.rotFloat),"rotVel"in t&&(Ht=t.rotVel)},funcs:{startGame:To,endGame:jn,rotatePieceByDir:bo,tryMoveDown:wo,canPlaceAtRot:ps,maybeResetLockDelay:hs,shootMagic:po,selectMagic:se,updateGroundedState:vo,lockPiece:Ao,finishHighlight:xo,finishRingHighlight:Ro},ui:{updateTimeHud:qn,updateRemainingHud:ys}}),gn=mo({canvas:n,canvasCtx:c,getN:()=>o,getH:()=>s,TOP_PAD_PX:h,BOTTOM_PAD_PX:L,SIDE_MARGIN_PX:K,MAX_RADIUS_X:$,RADIUS_X_FACTOR:z,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:le,MATCH_SHRINK_PHASE:me,MAGIC_SHRINK_SEC:qt,RING_HIGHLIGHT_SEC:pt,LOCK_DELAY_SEC:Jt,getKillRate:m,ELEMENT_COLORS:Me,ELEMENT_TO_COLOR:Zt,BLOCK_COLOR_FRONT:nt,BLOCK_COLOR_BACK:st,ACTIVE_COLOR_FRONT:ce,GHOST_COLOR_FILL:Q,GHOST_COLOR_STROKE:Y,GHOST_STROKE_WIDTH:Mt,MAGIC_DIM_DOT_ALPHA:be,MAGIC_DIM_DOT_SCALE:Ve,MAGIC_TARGET_DOT_SCALE:At,getState:()=>({gameState:j,grid:p,activePiece:G,pieceY:W,rotFloat:gt,killLevel:C,isHighlighting:Ze,highlightedCells:Qe,highlightStartTime:yn,isMagicAnimation:cn,isRingAnimation:Sn,isGrounded:F,lockTimer:x,spellState:Kt.getRenderState()}),getVisualSettings:()=>({waterBubbles:ln,waterColor:Ut}),funcs:{snappedRot:On,computeGhostY:Co,normSector:In,getMagicTargetColor:()=>bt.canUse()?Zt[bt.active]:null,getTransmuteAnimState:t=>Kt.getTransmuteAnimState(t),getLightningAnimState:t=>Kt.getLightningAnimState(t),getFireAnimState:t=>Kt.getFireAnimState(t)}}),es=performance.now();function Rs(t){let u=Math.min(.05,Math.max(.001,(t-es)/1e3));if(es=t,_t.update(u,t),Kt.update(t),Et>0){let d=Math.min(Et,k*u);C=Math.max(0,C-d),Et-=d}gt=Pt,gt>1e6&&(gt%=o),gt<-1e6&&(gt%=o),gn.render(u,t),requestAnimationFrame(Rs)}ae.addEventListener("click",()=>{_t.applyCommand("start_game")}),X.addEventListener("click",()=>{_t.applyCommand("start_game")}),H.addEventListener("click",()=>{j="intro",Yt.reset(),w.stopMusic(),w.getSettings().musicEnabled&&w.startMenuMusic(),En()}),q.forEach(t=>{t.addEventListener("click",u=>{q.forEach(T=>T.classList.remove("active")),t.classList.add("active"),tt=t.dataset.mode,Rn();let d=S.loadHighscore(tt);d.score>0?(B.textContent=d.score.toLocaleString(),M.textContent=rn(d.time)):(B.textContent="0",M.textContent="0:00"),ae.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ae.classList.add("idlePulse"),2e3)})});let ns=document.querySelectorAll(".spell-select-btn"),ss=document.getElementById("spellDesc"),As=document.getElementById("spellProgressFill"),os=document.getElementById("spellProgressMarkers"),Xn={ice:0,earth:10,air:25,fire:40},Ps=Object.values(Xn).sort((t,u)=>t-u),is=Math.max(...Ps),$o={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"},sn=S.loadHighTowerRings();function Go(){os&&(os.innerHTML="",Ps.forEach(t=>{let u=document.createElement("span");u.className="marker",u.dataset.threshold=t;let d=t/is*100;u.style.left=`${d}%`,os.appendChild(u)}))}function Fo(t){return t<=0?0:t>=is?100:t/is*100}function ws(t){if(!ss)return;let u=Xn[t]||0,d=$o[t]||"";u===0||sn>=u?ss.innerHTML=d:ss.innerHTML=`${d} <span class="spell-progress-text">${sn}/${u}</span>`}function Is(){if(sn=S.loadHighTowerRings(),ns.forEach(d=>{let T=d.dataset.spell,lt=Xn[T]||0,dt=sn>=lt;d.classList.toggle("locked",!dt);let yt=d.querySelector(".spell-lock");yt&&(yt.style.display=dt?"none":"")}),As){let d=Fo(sn);As.style.width=`${d}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(d=>{let T=parseInt(d.dataset.threshold,10)||0;d.classList.toggle("reached",sn>=T)});let u=document.querySelector(".spell-select-btn.active");u&&ws(u.dataset.spell)}Go(),Is(),ns.forEach(t=>{t.addEventListener("click",u=>{u.stopPropagation();let d=document.querySelector('.mode-btn[data-mode="30_24"]');if(d&&!d.classList.contains("active")){q.forEach(ie=>ie.classList.remove("active")),d.classList.add("active"),tt="30_24",Rn();let yt=S.loadHighscore(tt);yt.score>0?(B.textContent=yt.score.toLocaleString(),M.textContent=rn(yt.time)):(B.textContent="0",M.textContent="0:00")}let T=t.dataset.spell,lt=Xn[T]||0,dt=sn>=lt;ws(T),dt&&(ns.forEach(yt=>yt.classList.remove("active")),t.classList.add("active"),Be.selectSpell(T))})}),ct.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),u=S.loadHighscore("25_20"),d=`Records

`;d+=`High Tower (30\xD724):
`,d+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${rn(t.time)}
`:`  No record yet
`,d+=`
Quick Tower (25\xD720):
`,d+=u.score>0?`  Score: ${u.score.toLocaleString()}, Time: ${rn(u.time)}
`:`  No record yet
`,alert(d)}),mt.addEventListener("click",()=>{je.classList.remove("hidden")}),rt.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),oe(),Rn(),En(),w.startMenuMusic();let No=()=>{if(w.unlock(),!w.getSettings().musicEnabled)return;let t=w.musicAudio;!t||t.paused||t.ended?_t.state==="playing"?w.startGameMusic():w.startMenuMusic():t.play().catch(u=>{console.debug("Music resume on interaction failed:",u)})},Os=0,Xo=10,Uo=()=>{Os>=Xo||(Os++,No())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Uo,{passive:!0})}),requestAnimationFrame(Rs)})();})();
