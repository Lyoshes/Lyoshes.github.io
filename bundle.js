(()=>{var ds=[0,.25,.5,.75,1],ms=[0,.05,.15,.25,.5],gs={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},ro={menu:"music/mm.mp3",game:"sounds/amb1.wav"},lo="soundSettings";function fs(){try{let e=localStorage.getItem(lo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function hs(e){try{localStorage.setItem(lo,JSON.stringify(e))}catch(o){console.debug("Failed to save sound settings:",o)}}function uo(){return{audioContext:null,buffers:{},settings:fs(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let o=window.AudioContext||window.webkitAudioContext;this.audioContext=new o,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(o){console.debug("Failed to create AudioContext:",o)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(o){console.debug("Failed to resume AudioContext:",o)}if(!this.unlocked&&this.audioContext.state==="running"){let o=this.audioContext.createBuffer(1,1,22050),u=this.audioContext.createBufferSource();u.buffer=o,u.connect(this.audioContext.destination),u.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ds[this.settings.soundVolume]},getMusicVolume(){return ms[this.settings.musicVolume]},async loadSound(o,u){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(u)).arrayBuffer(),n=await this.audioContext.decodeAudioData(c);this.buffers[o]=n}catch(d){console.debug(`Failed to load sound: ${o} from ${u}`,d)}},preload(){this.initContext();for(let[o,u]of Object.entries(gs))this.loadSound(o,u)},play(o,u=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=o;u!==null&&(d=`${o}${u}`);let c=this.buffers[d];if(c)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let s=this.audioContext.createBufferSource();s.buffer=c,s.connect(n),s.start(0),s.onended=()=>{s.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(o){if(!this.settings.soundsEnabled)return;let u=1+Math.floor(Math.random()*3);this.play(o,u)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(ro.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Menu music started")}).catch(u=>{console.debug("Menu music autoplay blocked:",u)})}catch(o){console.debug("Menu music start failed:",o)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(ro.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Game music started")}).catch(u=>{console.debug("Game music play failed:",u)})}catch(o){console.debug("Game music start failed:",o)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(o){console.debug("Stop music failed:",o)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(o){if(this.settings={...this.settings,...o},hs(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(u=>{console.debug("Music resume failed:",u)}):this.stopMusic()}catch(u){console.debug("Update music settings failed:",u)}},getSettings(){return{...this.settings}}}}var mo="eb_highscore",go="eb_highscore_quick",fo="eb_settings",ps={invertSwipe:!1,difficulty:"easy"};function ho(){return{loadHighscore(e="30_24"){try{let o=e==="25_20"?go:mo,u=localStorage.getItem(o);if(u)return JSON.parse(u)}catch(o){console.debug("Failed to load highscore:",o)}return{score:0,time:0}},saveHighscore(e,o,u="30_24"){try{let d=this.loadHighscore(u);if(e>d.score||e===d.score&&o>d.time){let c=u==="25_20"?go:mo;return localStorage.setItem(c,JSON.stringify({score:e,time:o})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(fo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ps}},saveGameSettings(e){try{localStorage.setItem(fo,JSON.stringify(e))}catch(o){console.debug("Failed to save game settings:",o)}}}}function po(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function yo(e){return document.getElementById("tab-"+e)}var Eo={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function So(e={}){let{elementColors:o={}}=e,u=0;return{showBonus(d,c="score",n=null){let s=document.createElement("div");s.className=`bonus-popup ${c}`,s.textContent=d,n&&o[n]&&(s.style.color=o[n]);let a=window.innerWidth/2,h=window.innerHeight/2-40,f=(Math.random()-.5)*200,g=(Math.random()-.5)*100+u*36;s.style.left=`${a+f}px`,s.style.top=`${h+g}px`,s.style.transform="translate(-50%, -50%)",document.body.appendChild(s),u++,setTimeout(()=>{u=Math.max(0,u-1)},200),setTimeout(()=>{s.remove()},1800)},getElementIcon(d){return Eo[d]||"\u2726"},spawnMagicOrb(d,c,n,s){if(!s)return;let a=document.createElement("div");a.className=`magic-orb ${d}`,a.textContent=Eo[d]||"\u2726";let h=s.getBoundingClientRect(),f=h.left+h.width/2-c,g=h.top+h.height/2-n,S=Math.hypot(f,g),R=Math.atan2(g,f),O=S*.35*(Math.random()>.5?1:-1),X=R+Math.PI/2,k=f*.5+Math.cos(X)*O,W=g*.5+Math.sin(X)*O;a.style.setProperty("--mid-x",`${k}px`),a.style.setProperty("--mid-y",`${W}px`),a.style.setProperty("--end-x",`${f}px`),a.style.setProperty("--end-y",`${g}px`),a.style.left=`${c}px`,a.style.top=`${n}px`,document.body.appendChild(a),setTimeout(()=>{a.remove(),s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))},700)}}}function Mo(e={}){let{buttons:o={},onActivate:u=null}=e,d={fire:3,water:3,lightning:3,earth:3},c=null;function n(){for(let[s,a]of Object.entries(o)){if(!a)continue;let h=d[s],f=a.querySelector(".charges");f&&(f.textContent=h),a.classList.toggle("empty",h<=0),a.classList.toggle("active",c===s&&h>0)}}return{get charges(){return d},get active(){return c},set active(s){c=s},select(s){if(d[s]<=0)return!1;let a=c===s;return c=a?null:s,n(),!a&&c===s&&u&&u(),!a},useCharge(){return!c||d[c]<=0?!1:(d[c]--,c=null,n(),!0)},addCharges(s,a){d[s]!==void 0&&(d[s]+=a,n())},canUse(){return c!==null&&d[c]>0},deactivate(){c=null,n()},reset(){d.fire=3,d.water=3,d.lightning=3,d.earth=3,c=null,n()},updateButtons:n,initButtons(s){for(let[a,h]of Object.entries(o))h&&h.addEventListener("click",()=>{s&&s(a)})}}}var ys={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function xo(e={}){let{canvas:o}=e,u=e.rotDir||1,d=!1,c=0,n=0,s=0,a=0,h=0,f=1,g=null,S=0,R=0,O=0,X=0,k=0,W=0,pt=0,Zt=0,Z=ys;return{get rotDir(){return u},set rotDir(w){u=w},get dragging(){return d},get dragMode(){return g},handlePointerDown(w,at,ae){if(at.onMagicTap&&at.onMagicTap(w.clientX,w.clientY))return!0;let Jt=performance.now(),Dt=Jt-W,kt=w.clientX-pt,Gt=w.clientY-Zt,re=Math.hypot(kt,Gt);return Dt<=Z.DOUBLE_TAP_MS&&re<=Z.DOUBLE_TAP_MAX_DIST?(at.onDoubleTap&&at.onDoubleTap(),W=0):(W=Jt,pt=w.clientX,Zt=w.clientY),d=!0,f=-1,c=w.clientX,n=w.clientY,s=ae,a=0,h=0,g=null,S=Jt,R=w.clientX,O=w.clientY,X=S,k=0,o&&o.setPointerCapture(w.pointerId),!1},handlePointerMove(w,at,ae,Jt){if(!d)return null;let Dt=w.clientX-c,kt=w.clientY-n,Gt=performance.now();if(Math.abs(Dt)<Z.DEADZONE_PX&&Math.abs(kt)<Z.DEADZONE_PX)return null;if(!g){let It=Math.abs(Dt),xt=Math.abs(kt);if(kt<0)It>=Z.DEADZONE_PX&&(g="rotate");else if(xt>=It*Z.AXIS_DOMINANCE){if(xt>=Z.DROP_SWIPE_MIN_DISTANCE){let vt=Math.max(1,Gt-S);xt/vt*1e3>=Z.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else It>=xt*Z.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let re=null;if(g==="rotate"&&Math.abs(Dt)>=Z.DEADZONE_PX){let It=Math.max(1,Gt-X),xt=w.clientX-R,vt=Math.max(1,Math.abs(xt)/It*1e3),r=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/vt)));k+=-xt/r*u*f;let K=Math.trunc(k);K!==0&&(k-=K);let ct=a+K;if(ct!==a&&at.canRotateTo){let jt=Math.sign(ct-a),At=s+a;for(;a!==ct;){let he=a+jt,_e=s+he;if(!at.canRotateTo(Math.floor(ae),_e))break;a=he,At=_e,Jt&&at.onGroundedMove&&at.onGroundedMove()}re={targetRot:At,rotFloat:At}}}if(g==="drop"&&kt>Z.DEADZONE_PX&&at.onDrop){let It=Math.max(1,Gt-X),xt=w.clientY-O,vt=Math.max(1,xt/It*1e3),r=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/vt))),K=Math.trunc(kt/r);if(K>h){let ct=K-h;for(let jt=0;jt<ct;jt++)at.onDrop();h=K}}return R=w.clientX,O=w.clientY,X=Gt,re},handlePointerUp(w){if(d&&(d=!1,g=null,o&&w&&w.pointerId!==void 0))try{o.releasePointerCapture(w.pointerId)}catch{}},reset(){d=!1,g=null,a=0,h=0,k=0}}}var wn={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function vo(){let e="intro",o=0,u=0,d=0,c=0,n=0,s={...wn};return{get state(){return e},get score(){return o},get elapsedMs(){return d},get startTime(){return u},get stats(){return s},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",o=0,u=performance.now(),d=0,c=0,n=0,s={...wn}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(n+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(a){o+=a},setScore(a){o=a},updateTime(){e==="playing"&&u>0&&(d=performance.now()-u-n)},getFormattedTime(){let a=Math.floor(d/1e3),h=Math.floor(a/60),f=a%60;return`${h}:${f.toString().padStart(2,"0")}`},incrementStat(a,h=1){a in s&&(s[a]+=h)},updateMaxStat(a,h){a in s&&h>s[a]&&(s[a]=h)},reset(){e="intro",o=0,u=0,d=0,c=0,n=0,s={...wn}}}}function Re(e,o){return e%=o,e<0&&(e+=o),e}function Co(e,o){return e[Math.min(o,e.length-1)]}function sn(e){let o=Math.max(0,Math.floor(e/1e3)),u=Math.floor(o/60),d=o%60;return`${u}:${d.toString().padStart(2,"0")}`}function _o(e,o){let u=e.map(({x:a,y:h},f)=>({x:h,y:-a,color:o[f]})),d=1/0,c=-1/0,n=1/0;for(let a of u)d=Math.min(d,a.x),c=Math.max(c,a.x),n=Math.min(n,a.y);let s=Math.round((d+c)/2);for(let a of u)a.x-=s,a.y-=n;return u.sort((a,h)=>a.y-h.y||a.x-h.x),{cells:u.map(a=>({x:a.x,y:a.y})),colors:u.map(a=>a.color)}}function Pn(e,o,u,d){let c=[];return e+1<u&&c.push({y:e+1,s:o}),e-1>=0&&c.push({y:e-1,s:o}),c.push({y:e,s:Re(o-1,d)}),c.push({y:e,s:Re(o+1,d)}),c}function bo(e,o,u){let d=Array.from({length:o},()=>new Uint8Array(u)),c=[];for(let n=0;n<o;n++)for(let s=0;s<u;s++){if(!e[n][s]||d[n][s])continue;let a=[],h=[{y:n,s}];for(d[n][s]=1;h.length>0;){let f=h.shift();a.push(f);for(let g of Pn(f.y,f.s,o,u))e[g.y][g.s]&&!d[g.y][g.s]&&(d[g.y][g.s]=1,h.push(g))}c.push(a)}return c}function To(e){return e.some(o=>o.y===0)}function On(e,o,u,d,c,n){if(!e)return!1;let s=Re(u,n);for(let a of e.cells){let h=o+a.y,f=Re(s+a.x,n);if(h<0)return!1;if(!(h>=c)&&d[h][f])return!1}return!0}function Lo(e,o,u,d,c,n){if(!e)return null;let s=Math.floor(o);for(;On(e,s-1,u,d,c,n);)s-=1;return s}function Bo(e,o,u){let d=[],c=[];for(let n=0;n<o;n++){let s=[],a=0,h=e[n][0],f=h?1:0;for(let g=1;g<=u;g++){let S=g<u?e[n][g]:0;S&&S===h?f++:(f>=1&&h&&s.push({start:a,length:f,color:h}),a=g,h=S,f=S?1:0)}if(s.length>=2){let g=s[0],S=s[s.length-1];if(g.start===0&&S.start+S.length===u&&g.color===S.color){let R=g.length+S.length;s[0]={start:S.start,length:R,color:g.color},s.pop()}}for(let g of s)if(g.length>=3){let S=[];for(let R=0;R<g.length;R++)S.push({y:n,s:(g.start+R)%u});d.push({color:g.color,length:g.length,cells:S})}}for(let n=0;n<u;n++){let s=0,a=e[0][n],h=a?1:0;for(let f=1;f<=o;f++){let g=f<o?e[f][n]:0;if(g&&g===a)h++;else{if(h>=3&&a){let S=[];for(let R=0;R<h;R++)S.push({y:s+R,s:n});d.push({color:a,length:h,cells:S})}s=f,a=g,h=g?1:0}}}for(let n=0;n<o;n++)for(let s=0;s<u;s++){let a=e[n][s],h=e[n][(s+1)%u],f=e[n][(s+2)%u],g=e[n][(s+3)%u];a&&a===h&&f&&f===g&&a!==f&&c.push({cells:[{y:n,s},{y:n,s:(s+1)%u},{y:n,s:(s+2)%u},{y:n,s:(s+3)%u}]})}for(let n=0;n<u;n++)for(let s=0;s<o-3;s++){let a=e[s][n],h=e[s+1][n],f=e[s+2][n],g=e[s+3][n];a&&a===h&&f&&f===g&&a!==f&&c.push({cells:[{y:s,s:n},{y:s+1,s:n},{y:s+2,s:n},{y:s+3,s:n}]})}return{lineMatches:d,pairMatches:c}}function Io(e,o,u){let d=[];for(let c=0;c<o;c++){let n=!0;for(let s=0;s<u;s++)if(!e[c][s]){n=!1;break}n&&d.push(c)}return d}function Ao(e,o){let u=new Map;e.forEach((d,c)=>u.set(`${d.x},${d.y}`,o[c]));for(let d=0;d<e.length;d++){let c=e[d],n=o[d],s=1;for(let W=1;W<=2&&u.get(`${c.x+W},${c.y}`)===n;W++)s++;if(s>=3)return!0;let a=1;for(let W=1;W<=2&&u.get(`${c.x},${c.y+W}`)===n;W++)a++;if(a>=3)return!0;let h=n,f=u.get(`${c.x+1},${c.y}`),g=u.get(`${c.x+2},${c.y}`),S=u.get(`${c.x+3},${c.y}`);if(h&&f&&g&&S&&h===f&&g===S&&h!==g)return!0;let R=n,O=u.get(`${c.x},${c.y+1}`),X=u.get(`${c.x},${c.y+2}`),k=u.get(`${c.x},${c.y+3}`);if(R&&O&&X&&k&&R===O&&X===k&&R!==X)return!0}return!1}function Ro(e){let{getN:o,getH:u,FALL_INTERVAL:d,LOCK_DELAY_SEC:c,getKillRate:n,MATCH_HIGHLIGHT_SEC:s,MAGIC_SHRINK_SEC:a,RING_HIGHLIGHT_SEC:h,getState:f,setState:g,funcs:S,ui:R}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(O,X={}){let k=f();if(O==="start_game")return k.gameState!=="playing"?(S.startGame(),!0):!1;if(k.gameState!=="playing")return!1;switch(O){case"rotate_piece":return S.rotatePieceByDir(),!0;case"move_down":return S.tryMoveDown();case"rotate_cylinder":{let{rot:W}=X;return typeof W=="number"&&S.canPlaceAtRot(Math.floor(k.pieceY),W)?(g({targetRot:W,rotFloat:W,rotVel:0}),k.isGrounded&&S.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:W,y:pt}=X;return S.shootMagic(W,pt)}case"select_magic":{let{element:W}=X;return S.selectMagic(W),!0}default:return console.warn("GameEngine: unknown command",O),!1}},update(O,X){let k=f();if(k.gameState!=="playing")return;let W=X-k.startTime-k.totalPausedMs;g({elapsedMs:W}),R.updateTimeHud();let pt=k.killLevel+n()*O;if(g({killLevel:pt}),R.updateRemainingHud(),pt>=u()){S.endGame();return}if(k.isHighlighting){let w=(X-k.highlightStartTime)/1e3,at;k.isRingAnimation?at=h:k.isMagicAnimation?at=a:at=s,w>=at&&(k.isRingAnimation?S.finishRingHighlight():S.finishHighlight())}let Zt=k.fallTimer+O;if(Zt>=d&&(Zt-=d,S.tryMoveDown()),g({fallTimer:Zt}),S.updateGroundedState()){let w=k.lockTimer+O;g({lockTimer:w}),w>=c&&S.lockPiece()}},reset(){S.startGame()},canRotateTo(O,X){return S.canPlaceAtRot(O,X)},getRotation(){let O=f();return{targetRot:O.targetRot,rotFloat:O.rotFloat,rotVel:O.rotVel}},setRotation(O){g({targetRot:O,rotFloat:O,rotVel:0})},onGroundedMove(){S.maybeResetLockDelay()}}}var Ut=Math.PI*2;function wo(e){let{canvas:o,canvasCtx:u,getN:d,getH:c,TOP_PAD_PX:n,BOTTOM_PAD_PX:s,SIDE_MARGIN_PX:a,MAX_RADIUS_X:h,RADIUS_X_FACTOR:f,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:S,MATCH_SHRINK_PHASE:R,MAGIC_SHRINK_SEC:O,RING_HIGHLIGHT_SEC:X,LOCK_DELAY_SEC:k,getKillRate:W,ELEMENT_COLORS:pt,ELEMENT_TO_COLOR:Zt,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:w,ACTIVE_COLOR_FRONT:at,GHOST_COLOR_FILL:ae,GHOST_COLOR_STROKE:Jt,GHOST_STROKE_WIDTH:Dt,MAGIC_DIM_DOT_ALPHA:kt,MAGIC_DIM_DOT_SCALE:Gt,MAGIC_TARGET_DOT_SCALE:re,getState:It,getVisualSettings:xt,funcs:vt}=e,r=u,K=d(),ct=c(),jt={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},At=[],he=15,_e=2;function $e(T,_,p,L,v,P,y){for(At=At.filter(b=>b.y>T+b.size);At.length<he;){let b=Math.random()>.5?"left":"right",m=10,C=b==="left"?m+Math.random()*(_-m*2):p+m+Math.random()*(v-p-m*2),B=L+20+Math.random()*100;At.push({x:C,baseX:C,y:B,size:1.5+Math.random()*3,speedFactor:.9+Math.random()*.2,wobble:Math.random()*Math.PI*2,wobbleSpeed:.4+Math.random()*.4,wobbleAmp:3+Math.random()*4,side:b,minX:b==="left"?m:p+m,maxX:b==="left"?_-m:v-m})}let V=P*_e;for(let b of At){b.y-=V*b.speedFactor*y,b.wobble+=b.wobbleSpeed*y;let m=b.baseX+Math.sin(b.wobble)*b.wobbleAmp;b.x=Math.max(b.minX,Math.min(b.maxX,m))}}function cn(T){r.fillStyle="rgba(255, 255, 255, 0.25)",r.strokeStyle="rgba(255, 255, 255, 0.4)",r.lineWidth=1;for(let _ of At)_.y<T+_.size||(r.beginPath(),r.arc(_.x,_.y,_.size,0,Math.PI*2),r.fill(),r.stroke())}function Xt(T,_,p){let L=1-p/ct;return T+L*_}function be(T){return T=T%K,T<0?T+K:T}function Te(T,_,p,L,v,P){let y=be(P),V=(v-y)/K*Ut+g;return{x:T+Math.cos(V)*p,y:_+Math.sin(V)*L,ang:V}}let Ue=.52,an=1.02;function Ht(T,_,p,L,v,P){let y=be(P),V=(v-y)/K*Ut+g;return{x:T+Math.cos(V)*p,y:_+Math.sin(V)*L,ang:V}}function rn(T,_,p,L,v,P,y,V=1){let b=Ht(T,_,p,L,v-Ue,P),m=Ht(T,_,p,L,v+Ue,P),C={x:b.x,y:b.y-y*.5},B={x:b.x,y:b.y+y*.5},nt={x:m.x,y:m.y-y*.5},I={x:m.x,y:m.y+y*.5},N=(C.x+nt.x+I.x+B.x)*.25,G=(C.y+nt.y+I.y+B.y)*.25,ot=an*V,gt=V,yt=[C,nt,I,B].map(pe=>({x:N+(pe.x-N)*ot,y:G+(pe.y-G)*gt})),dt=Math.abs((m.x-b.x)*ot),te=Math.abs(y*gt);return{corners:yt,cx:N,cy:G,wApprox:dt,hApprox:te,ang:Ht(T,_,p,L,v,P).ang}}function le(T,_,p,L,v,P,y,V,b=1,m=null,C=1,B=null,nt=0,I=1,N=1){let G=rn(T,_,p,L,v,P,y,N),[ot,gt,yt,dt]=G.corners;if(r.save(),r.globalAlpha=b,r.fillStyle=V,r.beginPath(),r.moveTo(ot.x,ot.y),r.lineTo(gt.x,gt.y),r.lineTo(yt.x,yt.y),r.lineTo(dt.x,dt.y),r.closePath(),r.fill(),B&&nt>0&&(r.strokeStyle=B,r.lineWidth=nt,r.stroke()),m){let te=Math.min(G.wApprox,G.hApprox)*.28*I;r.globalAlpha=b*C,r.fillStyle=m,r.beginPath(),r.arc(G.cx,G.cy,te,0,Ut),r.fill()}r.restore(),r.globalAlpha=1}function ln(T,_,p,L,v,P){let y=Te(T,_,p,L,v,P),V=Te(T,_,p,L,v+1,P),b=Te(T,_,p,L,v-1,P),m=Math.abs(V.x-y.x),C=Math.abs(y.x-b.x),B=(m+C)*.5*1.06;return Math.max(1,B)}function un(T,_,p,L,v,P){let y=(v-P)/K*Ut+g;return{x:T+Math.cos(y)*p,y:_+Math.sin(y)*L,ang:y}}function dn(T,_,p,L,v,P,y,V=1,b=null,m=1,C=null,B=0,nt=1){r.save(),r.translate(T,_);let I=Math.atan2(L,p);if(r.rotate(I),r.globalAlpha=V,r.fillStyle=y,r.fillRect(-v/2,-P/2,v,P),C&&B>0&&(r.strokeStyle=C,r.lineWidth=B,r.strokeRect(-v/2,-P/2,v,P)),b){let N=Math.min(v,P)*.28*nt;r.globalAlpha=V*m,r.fillStyle=b,r.beginPath(),r.arc(0,0,N,0,Ut),r.fill()}r.restore(),r.globalAlpha=1}return{resize(){let T=Math.max(1,Math.min(2,window.devicePixelRatio||1)),_=Math.floor(o.clientWidth*T),p=Math.floor(o.clientHeight*T);(o.width!==_||o.height!==p)&&(o.width=_,o.height=p,r.setTransform(T,0,0,T,0,0))},render(T=.016){this.resize();let _=It();K=d(),ct=c();let p=o.clientWidth,L=o.clientHeight;r.clearRect(0,0,p,L),r.fillStyle="#0b0f14",r.fillRect(0,0,p,L);let v=p*.5,P=(p-2*a)/2,y=L-n-s,V=6,b=K*y/(V*ct),m,C,B,nt;nt=L-s,b<=Math.min(P,h)?(m=b,C=y,B=n):(m=Math.min(P,h),C=m*V*ct/K,B=nt-C);let I=m*.28,{killLevel:N,rotFloat:G,grid:ot,gameState:gt}=_,yt=xt?xt():{},dt=yt.waterColor||"blue",te=yt.waterBubbles||!1,pe=jt[dt]||jt.blue,Et=Xt(B,C,N),M=.7,Ct=N/ct,A={...pe.top},J={...pe.bottom};if(Ct>M){let x=(Ct-M)/(1-M);A.r=Math.round(A.r+(255-A.r)*x*.5),A.g=Math.round(A.g+(150-A.g)*x*.5),A.b=Math.round(A.b+(150-A.b)*x*.5),J.r=Math.round(J.r+(180-J.r)*x),J.g=Math.round(J.g*(1-x*.6)),J.b=Math.round(J.b*(1-x*.6))}let Vt=v-m-8,ft=v+m+8,ye=B,Ft=nt+5,Nt=r.createLinearGradient(0,Et,0,L);Nt.addColorStop(0,`rgba(${A.r},${A.g},${A.b},0.5)`),Nt.addColorStop(1,`rgba(${J.r},${J.g},${J.b},0.7)`),r.fillStyle=Nt;let q=Math.round((A.r+J.r)/2),Xe=Math.round((A.g+J.g)/2),Ee=Math.round((A.b+J.b)/2),St=m+8,Ve=I+4;r.fillRect(0,Et,Vt,L-Et),r.fillRect(ft,Et,p-ft,L-Et),r.beginPath();let mn=Math.max(Et,Ft);if(r.moveTo(Vt,mn),Et<=Ft+Ve?r.ellipse(v,Ft,St,Ve,0,Math.PI,0,!1):r.lineTo(ft,mn),r.lineTo(ft,L),r.lineTo(Vt,L),r.closePath(),r.fill(),r.strokeStyle="rgba(100,180,255,0.6)",r.lineWidth=3,r.lineCap="round",r.beginPath(),r.moveTo(Vt,ye),r.lineTo(Vt,Ft),r.stroke(),r.beginPath(),r.moveTo(ft,ye),r.lineTo(ft,Ft),r.stroke(),r.beginPath(),r.ellipse(v,Ft,m+8,I+4,0,0,Math.PI),r.stroke(),r.fillStyle="#0b0f14",r.beginPath(),r.ellipse(v,Ft,m+8,I+4,0,0,Ut),r.fill(),N>.5&&(r.strokeStyle=`rgba(${Math.min(255,q+60)},${Math.min(255,Xe+40)},${Math.min(255,Ee+40)},0.6)`,r.lineWidth=2,r.beginPath(),r.moveTo(0,Et),r.lineTo(Vt,Et),r.moveTo(ft,Et),r.lineTo(p,Et),r.stroke()),te&&N>.5){let x=W()*C/ct;$e(Et,Vt,ft,L,p,x,T),cn(Et)}r.strokeStyle="rgba(160,190,220,0.3)",r.lineWidth=1;let Ye=Ut*m,ee=10,Dn=Ye/ee*.7,gn=Ye/ee*.3;r.setLineDash([Dn,gn]);let fn=Ye/K;r.lineDashOffset=be(G)*fn;for(let x=0;x<=ct;x++){let H=Xt(B,C,x);r.beginPath(),r.ellipse(v,H,m,I,0,0,Ut),r.stroke()}r.setLineDash([]);let Se=[],Me=[];for(let x=0;x<ct;x++){let H=Xt(B,C,x+.5);for(let z=0;z<K;z++){let j=ot[x][z];if(!j)continue;let Y=Te(v,H,m,I,z,G),st=Math.sin(Y.ang),F={y:x,s:z,yScr:H,p:Y,depth:st,color:j};st<-.1?Se.push(F):Me.push(F)}}let hn=vt.getMagicTargetColor(),{isHighlighting:Yt,highlightedCells:Rt,highlightStartTime:we,isMagicAnimation:Pe}=_,xe=null,Le=1,ue=1,Be=!1;if(Yt&&Rt.length>0){xe=new Set(Rt.map(H=>`${H.y},${H.s}`));let x=(performance.now()-we)/1e3;if(Pe){let H=Math.min(1,x/O);Le=1-H*.85,ue=1-H*.9,Be=!0}else{let H=Math.min(1,x/S),z=1-R;if(H>z){let j=(H-z)/R;Le=1-j*.85,ue=1-j*.9,Be=!0}}}Se.sort((x,H)=>x.depth-H.depth);for(let x of Se){let H=C/ct*.9,z=pt[x.color]||null,j=.35,Y=1,st=`${x.y},${x.s}`;xe&&xe.has(st)&&(j*=ue,Y=Le),le(v,x.yScr,m,I,x.s,G,H,w,j,z,.5,null,0,1,Y)}let{isRingAnimation:de}=_;if(Yt&&Rt.length>0&&!Pe){let x=(performance.now()-we)/1e3,z=Math.min(1,x/(de?X:S)),j=1-R,Y=z>j,st=Y?(z-j)/R:0,F=de?Math.floor(z*j*K*2)%K:-1,D=4+z/j*10,rt=Math.sin(x*D*Ut),_t=Y?1:.3+rt*.3,lt=Y?1-st*.8:1,bt=Y?1-st:1;for(let mt of Rt){let oe=Xt(B,C,mt.y+.5),Oe=Ht(v,oe,m,I,mt.s,G);if(Math.sin(Oe.ang)>=-.1)continue;let De=C/ct*.9,Tt,wt,Pt;if(de){let me=(mt.s-F+K)%K,ve=me<3?1-me/3:0;Tt=(Y?bt:.2+ve*.5)*.5,wt=`rgba(255, 159, 67, ${Tt})`,Pt=Y?lt:1+ve*.15}else Tt=_t*bt,wt=mt.isLine?`rgba(255, 255, 255, ${Tt*.5})`:`rgba(255, 220, 100, ${Tt*.4})`,Pt=Y?lt:1.1;le(v,oe,m,I,mt.s,G,De,wt,1,null,1,null,0,1,Pt)}}Me.sort((x,H)=>x.depth-H.depth);for(let x of Me){let H=C/ct*.9,z=pt[x.color]||null,j=1,Y=1,st=1,F=1,D=`${x.y},${x.s}`,rt=xe&&xe.has(D);rt&&(j=ue,Y=Le),hn!==null&&!rt&&(x.color!==hn?(st=kt,F=Gt):F=re),le(v,x.yScr,m,I,x.s,G,H,Z,j,z,st,null,0,F,Y)}if(Yt&&Rt.length>0&&!Pe){let x=(performance.now()-we)/1e3,z=Math.min(1,x/(de?X:S)),j=1-R,Y=z>j,st=Y?(z-j)/R:0,F=de?Math.floor(z*j*K*2)%K:-1,D=4+z/j*10,rt=Math.sin(x*D*Ut),_t=Y?1:.5+rt*.5,lt=Y?1-st*.8:1,bt=Y?1-st:1;for(let mt of Rt){let oe=Xt(B,C,mt.y+.5),Oe=Ht(v,oe,m,I,mt.s,G);if(Math.sin(Oe.ang)<-.1)continue;let De=C/ct*.9,Tt,wt,Pt;if(de){let me=(mt.s-F+K)%K,ve=me<4?1-me/4:0;Tt=Y?bt:.3+ve*.7,wt=`rgba(255, 159, 67, ${Tt})`,Pt=Y?lt:1+ve*.2}else Tt=_t*bt,wt=mt.isLine?`rgba(255, 255, 255, ${Tt*.7})`:`rgba(255, 220, 100, ${Tt*.6})`,Pt=Y?lt:1.15;le(v,oe,m,I,mt.s,G,De,wt,1,null,1,null,0,1,Pt)}}let{activePiece:ne,pieceY:pn,isGrounded:yn,lockTimer:We}=_;if(ne){let x=vt.snappedRot(),H=x,z=vt.computeGhostY(),j=C/ct*.9;if(z!==null){let F=[];for(let D=0;D<ne.cells.length;D++){let rt=ne.cells[D],_t=ne.colors[D],lt=z+rt.y,bt=vt.normSector(x+rt.x);if(lt<0||lt>=ct)continue;let mt=Xt(B,C,lt+.5),oe=Ht(v,mt,m,I,bt,H);F.push({cy:lt,cs:bt,yScr:mt,depth:Math.sin(oe.ang),color:_t})}F.sort((D,rt)=>D.depth-rt.depth);for(let D of F){let rt=pt[D.color]||null;le(v,D.yScr,m,I,D.cs,H,j,ae,1,rt,.5,Jt,Dt,1,1)}}let Y=at;if(yn&&We>0){let F=Math.min(1,We/k),D=255,rt=Math.round(170+85*F),_t=Math.round(180+75*F),lt=.75+(1-.75)*F;Y=`rgba(${D},${rt},${_t},${lt})`}let st=[];for(let F=0;F<ne.cells.length;F++){let D=ne.cells[F],rt=ne.colors[F],_t=vt.normSector(x+D.x),lt=pn+D.y;if(lt<0||lt>=ct)continue;let bt=Xt(B,C,lt+.5),mt=Ht(v,bt,m,I,_t,H);st.push({cs:_t,yScr:bt,depth:Math.sin(mt.ang),color:rt})}st.sort((F,D)=>F.depth-D.depth);for(let F of st){let D=pt[F.color]||null;le(v,F.yScr,m,I,F.cs,H,j,Y,1,D,1,null,0,1,1)}}},drawNextPreview(T,_){if(!T)return;let p=T.getContext("2d"),L=T.width,v=T.height;if(p.clearRect(0,0,L,v),!_)return;let P=1/0,y=-1/0,V=1/0,b=-1/0;for(let N of _.cells)P=Math.min(P,N.x),y=Math.max(y,N.x),V=Math.min(V,N.y),b=Math.max(b,N.y);let m=y-P+1,C=b-V+1,B=Math.min(L/(m+.5),v/(C+.5)),nt=(L-m*B)/2,I=(v-C*B)/2;p.fillStyle=Z;for(let N=0;N<_.cells.length;N++){let G=_.cells[N],ot=nt+(G.x-P)*B,gt=I+(C-1-(G.y-V))*B;p.fillRect(ot+1,gt+1,B-2,B-2);let yt=_.colors[N],dt=pt[yt];if(dt){let te=(B-2)*.32;p.fillStyle=dt,p.beginPath(),p.arc(ot+B/2,gt+B/2,te,0,Ut),p.fill(),p.fillStyle=Z}}}}}(()=>{let e=po(),o=e.canvas,u=o.getContext("2d");o.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,c=30,n=24,s=120,a={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function h(t){let i=a[t]||a["30_24"];c=i.N,n=i.H,s=i.survivalTime}function f(){return n/s}let g=Math.PI/2,S=70,R=120,O=30,X=320,k=.42,W="rgb(235,240,250)",pt="rgb(55,62,75)",Zt="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",w="rgba(110,255,150,0.85)",at=2,ae={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Jt={1:"fire",2:"water",3:"lightning",4:"earth"},Dt={fire:1,water:2,lightning:3,earth:4},kt=1,Gt=.58,re=!0,It=12,xt=25,vt=1,r=2,K=3,ct=5,jt=8,At=10,he=15,_e=30,$e=2,cn=.3,Xt=.5,be=1,Te=.3,Ue=.5,an=1.3,Ht=10,rn=500,le=[1,1.25,1.5,1.75,2],ln=10,un=100,dn=25,T=[1,1.3,1.6,2],_=[1,1.5,2,2.5],p=ho(),L=p.loadGameSettings(),v=L.invertSwipe?-1:1,P=-1,y=Array.from({length:n},()=>new Uint8Array(c));function V(){y=Array.from({length:n},()=>new Uint8Array(c))}let b=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],m=null,C=n+3,B=0,nt=0,I=!1,N=0,G=0,ot=0,gt=0,yt=0,dt=xo({canvas:o,rotDir:v}),te="0.13.1",pe=!0,Et="blue",M=uo();M.preload();let Ct=vo(),A="intro",J=0,Vt=0,ft=0,ye=0,Ft=0,Nt=null,q=Ct.stats,Xe=e.overlay,Ee=So({elementColors:ae}),St=Ee.showBonus.bind(Ee),Ve=Ee.getElementIcon.bind(Ee),mn=e.overlayTitle,Ye=e.overlayStats,ee=e.startBtn,Dn=e.hud,gn=e.scoreHud,fn=e.timeHud,Se=e.remainingHud,Me=e.nextCanvas,hn=Me.getContext("2d"),Yt=e.pauseBtn,Rt=e.pauseOverlay,we=e.resumeBtn,Pe=e.restartBtn,xe=e.exitToMenuBtn,Le=e.pauseSettingsBtn,ue=e.pauseSoundBtn,Be=e.pauseMusicBtn,de=e.pauseBestScore,ne=e.pauseBestTime,pn=e.pauseBestMode,yn=e.pauseCurrentScore,We=e.pauseCurrentTime,x=e.pauseCurrentMode,H=e.confirmDialog,z=e.confirmText,j=e.confirmCancel,Y=e.confirmOk,st=e.settingsOverlay,F=e.settingsClose,D=e.fullscreenBtn,rt=e.rotateBtn,_t=e.startPanel,lt=e.gameoverPanel,bt=e.goScore,mt=e.goTime,oe=e.goMatches,Oe=e.goBonuses,Ke=e.goNewRecord,De=e.goRestartBtn,Tt=e.goExitBtn,wt=e.bestScore,Pt=e.bestExtra,me=e.surviveVal,ve=e.startVersion,kn=e.modeBtns,Po=e.recordsBtn,Oo=e.startSettingsBtn,Do=e.helpBtn,Wt="25_20",Kt=Mo({buttons:e.magicBtns,onActivate:()=>M.play("spells")}),Gn=e.magicBtns,Ss=Kt.charges,ko=t=>Kt.select(t),En=()=>Kt.updateButtons(),se=[],ke=0,ie=!1,Ce=!1,Ge=!1,qt=0,zt=0,ge=0,qe=[];function Hn(t,i,l){let E=1-l/n;return t+E*i}function Fn(t,i,l,E,$,tt){let ut=($-tt)/c*d+g;return{x:t+Math.cos(ut)*l,y:i+Math.sin(ut)*E,ang:ut}}function Go(t,i){let l=o.clientWidth,E=o.clientHeight,$=l*.5,tt=(l-2*O)/2,ut=E-S-R,Lt=6,Ot=c*ut/(Lt*n),Ae=E-R,$t,et,U;Ot<=Math.min(tt,X)?($t=Ot,et=ut,U=S):($t=Math.min(tt,X),et=$t*Lt*n/c,U=Ae-et);let Q=$t*.28,ht=Hn(U,et,t+.5),Mt=Fn($,ht,$t,Q,i,ot);return{x:Mt.x,y:Mt.y}}function Ho(t,i){if(!Kt.canUse()||ie)return!1;let l=Dt[Kt.active],E=o.clientWidth,$=o.clientHeight,tt=E*.5,ut=(E-2*O)/2,Lt=$-S-R,Ot=6,Ae=c*Lt/(Ot*n),$t=$-R,et,U,Q;Ae<=Math.min(ut,X)?(et=Ae,U=Lt,Q=S):(et=Math.min(ut,X),U=et*Ot*n/c,Q=$t-U);let ht=et*.28,Mt=null,Qt=1/0;for(let Bt=0;Bt<n;Bt++){let An=Hn(Q,U,Bt+.5);for(let ce=0;ce<c;ce++){let oo=y[Bt][ce];if(!oo||oo!==l)continue;let Rn=Fn(tt,An,et,ht,ce,ot);if(Math.sin(Rn.ang)<-.1)continue;let so=t-Rn.x,io=i-Rn.y,co=Math.hypot(so,io),ao=U/n*.9,us=ao*1.2;Math.abs(so)<us/2&&Math.abs(io)<ao/2&&co<Qt&&(Qt=co,Mt={y:Bt,s:ce})}}if(Mt){let Bt=y[Mt.y][Mt.s];return se=[{y:Mt.y,s:Mt.s,color:Bt,isLine:!1,isMagic:!0}],ke=performance.now(),ie=!0,Ce=!0,qt=0,zt=dn,St(`+${dn}`,"score"),ge=0,Kt.useCharge(),q.magicUsed++,!0}return!1}let Ms=100;function xs(t,i){return Pn(t,i,n,c)}function Fo(){return bo(y,n,c)}let No=To;function $o(t){let i=t.map(E=>({...E,color:y[E.y][E.s]}));for(let E of t)y[E.y][E.s]=0;let l=n;for(let E of t){let $=E.y;for(let tt=1;tt<=E.y;tt++){let ut=E.y-tt;if(y[ut][E.s]){$=tt-1;break}}l=Math.min(l,$)}for(let E of i)y[E.y-l][E.s]=E.color;return l>0}function Uo(){let t=!0;for(;t;){t=!1;let i=Fo();for(let l of i)No(l)||$o(l)&&(t=!0)}}function Xo(){Mn()}let Sn=Co;function Nn(t,i){let l=new Map,E=0,$=0,tt=0,ut={},Lt=t.length+i.length;for(let U of t){let Q=Jt[U.color],ht=0,Mt=0;if(U.length>=5?(ht=K,Mt=At,q.lines5++):U.length===4?(ht=r,Mt=jt,q.lines4++):U.length===3&&(ht=vt,Mt=ct,q.lines3++),Q&&ht>0){Kt.addCharges(Q,ht),ut[Q]=(ut[Q]||0)+ht;let Qt=U.cells[Math.floor(U.cells.length/2)],Bt=Go(Qt.y,Qt.s),An=Gn[Q];for(let ce=0;ce<ht;ce++)setTimeout(()=>{Ee.spawnMagicOrb(Q,Bt.x,Bt.y,An)},ce*100)}E+=Mt*f(),tt+=Mt,$+=U.length*ln;for(let Qt of U.cells){let Bt=`${Qt.y},${Qt.s}`;l.has(Bt)||l.set(Bt,{y:Qt.y,s:Qt.s,color:U.color,isLine:!0})}}for(let U of i){q.pairs++,E+=he*f(),tt+=he,$+=un;for(let Q of U.cells){let ht=`${Q.y},${Q.s}`;l.has(ht)||l.set(ht,{y:Q.y,s:Q.s,color:y[Q.y][Q.s],isLine:!1})}}let Ot=Sn(T,Lt-1),Ae=Sn(_,ge),$t=Math.round($*Ot*Ae),et=0;Lt>1&&(q.combos++,q.maxCombo=Math.max(q.maxCombo,Lt),setTimeout(()=>St(`COMBO \xD7${Lt}`,"combo"),et),et+=180,M.play("combo2")),ge>0&&(q.cascades++,q.maxCascade=Math.max(q.maxCascade,ge),setTimeout(()=>St(`CASCADE \xD7${ge}`,"cascade"),et),et+=180,M.play("cascade")),(t.length>0||i.length>0)&&M.play("combo");for(let U of t){let Q=U.length,ht=Q*ln;setTimeout(()=>St(`Line-${Q} +${ht}`,"line",U.color),et),et+=100}for(let U of i){let Q=U.cells.length>0?y[U.cells[0].y][U.cells[0].s]:null;setTimeout(()=>St(`Pair +${un}`,"pair",Q),et),et+=100}$t>0&&(setTimeout(()=>St(`+${$t}`,"score"),et),et+=120),tt>0&&(setTimeout(()=>St(`+${tt}s`,"time"),et),et+=120);for(let[U,Q]of Object.entries(ut))Q>0&&(setTimeout(()=>St(`+${Q}${Ve(U)}`,"charge"),et),et+=120);se=Array.from(l.values()),ke=performance.now(),ie=!0,Ce=!1,qt=E,zt=$t,En()}function Vo(){for(let t of se)y[t.y][t.s]=0;se.length>0&&M.playRandom("disappear"),qt>0&&(G=Math.max(0,G-qt)),Ct.addScore(zt),J+=zt,Je(),se=[],ie=!1,Ce=!1,qt=0,zt=0,ge++,Mn()}function Mn(){Uo();let{lineMatches:t,pairMatches:i}=ts();if(t.length>0||i.length>0)Nn(t,i);else{let l=Wn();l.length>0?Zo(l):!m&&A==="playing"&&Yn()}}function vs(t,i){Nn(t,i)}function xn(t){return Re(t,c)}function ze(){return xn(Math.round(ot))}function $n(t,i){return On(m,t,i,y,n,c)}function Qe(t){return $n(t,ze())}let Ze=_o;function Un(){re&&(It!==0&&N>=It||(nt=0,N+=1))}function Yo(){if(!m)return;let t=m.cells,i=m.colors,l={cells:t,colors:i};if(P>=0||(l=Ze(l.cells,l.colors),l=Ze(l.cells,l.colors)),l=Ze(l.cells,l.colors),m.cells=l.cells,m.colors=l.colors,!Qe(Math.floor(C))){m.cells=t,m.colors=i;return}M.play("turn"),I&&Un()}function Wo(){return Lo(m,C,ze(),y,n,c)}function Ko(){if(!m)return!1;let t=Math.floor(C)-1,i=!Qe(t);return i&&!I?(I=!0,nt=0,N=0):!i&&I&&(I=!1,nt=0,N=0),i}let Ie=sn;function He(){if(A==="playing"){Xe.classList.add("hidden"),Yt.classList.remove("hidden");return}if(Xe.classList.remove("hidden"),Yt.classList.add("hidden"),A==="intro"){_t.classList.remove("hidden"),lt.classList.add("hidden");let t=Math.floor(s/60),i=s%60;me.textContent=`${t}:${i.toString().padStart(2,"0")}`;let l=p.loadHighscore(Wt);l.score>0?(wt.textContent=l.score.toLocaleString(),Pt.textContent=`(${Ie(l.time)})`):(wt.textContent="0",Pt.textContent=""),ve.textContent=`v${te}`,ee.classList.remove("idlePulse"),ee.offsetWidth,ee.classList.add("idlePulse")}else{_t.classList.add("hidden"),lt.classList.remove("hidden"),bt.textContent=J.toLocaleString(),mt.textContent=Ie(ft);let t=p.loadHighscore(Wt);J>0&&J>=t.score?Ke.classList.remove("hidden"):Ke.classList.add("hidden");let i=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${q.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${q.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${q.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${q.pairs}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2B55</span>
          <span class="name">Ring</span>
          <span class="count">\xD7${q.rings}</span>
        </div>
      `;oe.innerHTML=i;let l=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${q.combos}</span>
          <span class="count">${q.maxCombo>0?"max \xD7"+q.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${q.cascades}</span>
          <span class="count">${q.maxCascade>0?"max \xD7"+q.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${q.magicUsed}</span>
        </div>
      `;Oe.innerHTML=l}}function Je(){gn.textContent=`Score: ${J}`}function vn(){fn.textContent=`Time: ${Ie(ft)}`}function Xn(){let t=Math.max(0,(n-G)/f()),i=Math.floor(t/60),l=Math.floor(t%60);Se.textContent=`Left: ${i}:${l.toString().padStart(2,"0")}`,t<30?Se.classList.add("warning"):Se.classList.remove("warning")}function qo(){h(Wt),V(),G=0,ot=gt=0,yt=0,Ct.start(),J=0,Vt=performance.now(),ft=0,Ft=0,ye=0,A="playing",Nt=null,Kt.reset(),se=[],qe=[],ie=!1,Ce=!1,Ge=!1,qt=0,zt=0,ge=0,En(),Je(),vn(),Xn(),Yn(),Bn.drawNextPreview(Me,Nt),He(),M.getSettings().musicEnabled&&M.startGameMusic()}function Cn(){Ct.gameOver(),A="gameover",m=null,I=!1,nt=0,N=0;let t=p.saveHighscore(J,ft,Wt);M.stopMusic(),M.play("gameover"),setTimeout(()=>{(A==="gameover"||A==="intro")&&M.startMenuMusic()},2500),vn(),He(),t&&J>0&&setTimeout(()=>{St("\u{1F3C6} NEW RECORD!","score")},500)}function zo(t){for(let l=0;l<50;l++){let E=t.map(()=>1+(Math.random()*4|0));if(!Qo(t,E))return E}return t.map((l,E)=>1+E%4)}let Qo=Ao;function Vn(t){let i=t.cells.map(E=>({x:E.x,y:E.y})),l=zo(i);return{name:t.name,cells:i,colors:l}}function Yn(){if(!Nt){let $=b[Math.random()*b.length|0];Nt=Vn($)}m=Nt;let t=b[Math.random()*b.length|0];Nt=Vn(t),Bn.drawNextPreview(Me,Nt);let i=1/0,l=-1/0;for(let $ of m.cells)$.x<i&&(i=$.x),$.x>l&&(l=$.x);let E=(i+l)/2;for(let $ of m.cells)$.x=$.x-Math.round(E);C=n+3,B=0,I=!1,nt=0,N=0,Qe(Math.floor(C))?M.playRandom("appear"):Cn()}function Wn(){return Io(y,n,c)}function Zo(t){if(t.length===0)return;let i=[];for(let Lt of t)for(let Ot=0;Ot<c;Ot++)i.push({y:Lt,s:Ot,color:y[Lt][Ot],isLine:!1});qe=t,se=i,ke=performance.now(),ie=!0,Ge=!0,Ce=!1;let l=t.length;q.rings+=l;let E=Sn(le,l-1),$=Math.round(rn*l*E),tt=_e*l;zt=$,qt=tt*f(),M.play("ring");let ut=`RING \xD7${l}`;St(ut,"ring"),setTimeout(()=>St(`+${$}`,"score"),150),setTimeout(()=>St(`+${tt}s`,"time"),300)}function Jo(){let t=[...qe].sort((i,l)=>l-i);for(let i of t){for(let l=i;l<n-1;l++)y[l].set(y[l+1]);y[n-1].fill(0)}qt>0&&(G=Math.max(0,G-qt)),Ct.addScore(zt),J+=zt,Je(),se=[],qe=[],ie=!1,Ge=!1,qt=0,zt=0,Mn()}function Cs(){return Wn().length}function jo(){if(!m)return;let t=ze();ot=t,gt=t,yt=0;let i=!1;for(let l=0;l<m.cells.length;l++){let E=m.cells[l],$=m.colors[l],tt=Math.floor(C)+E.y,ut=xn(t+E.x);tt>=n&&(i=!0),tt>=0&&tt<n&&(y[tt][ut]=$)}if(i){Cn();return}Ct.addScore(Ht),J+=Ht,Je(),St(`+${Ht}`,"score"),M.playRandom("drop"),m=null,ge=0,Xo()}function ts(){return Bo(y,n,c)}function es(){if(!m)return!1;let t=Math.floor(C)-1;return Qe(t)?(C=t,I=!1,nt=0,N=0,!0):(I=!0,!1)}o.addEventListener("pointerdown",t=>{if(it.state!=="playing")return;t.preventDefault?.(),dt.handlePointerDown(t,{onMagicTap:(l,E)=>it.applyCommand("magic_shoot",{x:l,y:E}),onDoubleTap:()=>it.applyCommand("rotate_piece")},gt)||(yt=0)},{passive:!1}),o.addEventListener("pointermove",t=>{if(it.state!=="playing"||!dt.dragging)return;t.preventDefault?.();let i=dt.handlePointerMove(t,{canRotateTo:(l,E)=>it.canRotateTo(l,E),onDrop:()=>it.applyCommand("move_down"),onGroundedMove:()=>it.onGroundedMove()},it.pieceY,it.isGrounded);i&&it.setRotation(i.targetRot)},{passive:!1}),o.addEventListener("pointerup",t=>{it.state==="playing"&&dt.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointercancel",t=>{dt.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointerleave",t=>{dt.dragging&&dt.handlePointerUp(t)},{passive:!1}),rt.addEventListener("click",()=>{it.state==="playing"&&it.applyCommand("rotate_piece")});let je=e.dropBtn,tn=null;function ns(){it.state==="playing"&&(it.applyCommand("move_down"),tn=setInterval(()=>{if(it.state!=="playing"){en();return}it.applyCommand("move_down")},xt))}function en(){tn&&(clearInterval(tn),tn=null)}je.addEventListener("pointerdown",t=>{t.preventDefault(),ns()}),je.addEventListener("pointerup",en),je.addEventListener("pointerleave",en),je.addEventListener("pointercancel",en);for(let[t,i]of Object.entries(Gn))i.addEventListener("click",()=>{it.state==="playing"&&it.applyCommand("select_magic",{element:t})});let _n=e.soundsToggle,bn=e.musicToggle;function fe(){let t=M.getSettings();t.soundsEnabled?_n.classList.add("active"):_n.classList.remove("active"),t.musicEnabled?bn.classList.add("active"):bn.classList.remove("active");for(let i=0;i<=4;i++){let l=e.soundVolBtns[i],E=e.musicVolBtns[i];l&&l.classList.toggle("active",t.soundVolume===i),E&&E.classList.toggle("active",t.musicVolume===i)}}let Kn=e.tabBtns,os=e.tabContents;Kn.forEach(t=>{t.addEventListener("click",()=>{let i=t.dataset.tab;Kn.forEach(l=>l.classList.remove("active")),os.forEach(l=>l.classList.remove("active")),t.classList.add("active"),yo(i).classList.add("active"),i==="sounds"&&fe()})});let qn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,zn=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,ss=e.iosHint,is=e.standaloneBadge;function Qn(){let t=document.fullscreenElement||document.webkitFullscreenElement;D.textContent=t?"Disable":"Enable"}qn&&(zn?(is.style.display="block",D.style.display="none"):(ss.style.display="block",D.textContent="Not supported",D.style.opacity="0.5",D.style.cursor="default")),D.addEventListener("click",()=>{if(qn&&!zn)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let i=document.documentElement;i.requestFullscreen?i.requestFullscreen():i.webkitRequestFullscreen&&i.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Qn),document.addEventListener("webkitfullscreenchange",Qn);let nn=e.invertSwipeToggle;L.invertSwipe&&nn.classList.add("active"),nn.addEventListener("click",()=>{nn.classList.toggle("active");let t=nn.classList.contains("active");dt.rotDir=t?-1:1,L.invertSwipe=t,p.saveGameSettings(L)});let Zn=e.diffBtns;Zn.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Zn.forEach(i=>{i.classList.remove("active");let l=i.querySelector(".check-icon");l&&l.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let i=document.createElement("span");i.className="check-icon",i.textContent="\u2713",t.appendChild(i)}})}),_n.addEventListener("click",()=>{let i=!M.getSettings().soundsEnabled;M.updateSettings({soundsEnabled:i}),fe(),Fe()}),bn.addEventListener("click",()=>{let i=!M.getSettings().musicEnabled;M.updateSettings({musicEnabled:i}),fe(),Fe(),A!=="paused"&&(i?A==="playing"?M.startGameMusic():M.startMenuMusic():M.stopMusic())});for(let t=0;t<=4;t++){let i=e.soundVolBtns[t];i&&i.addEventListener("click",()=>{M.updateSettings({soundVolume:t}),fe(),M.play("turn")})}for(let t=0;t<=4;t++){let i=e.musicVolBtns[t];i&&i.addEventListener("click",()=>{M.updateSettings({musicVolume:t}),fe()})}fe();function Jn(){A==="playing"&&(Ct.pause(),ye=performance.now(),A="paused",M.musicAudio&&M.musicAudio.pause())}function on(){A==="paused"&&(Ct.resume(),Ft+=performance.now()-ye,ye=0,A="playing",In=performance.now(),M.getSettings().musicEnabled&&M.startGameMusic())}function Fe(){let t=M.getSettings();ue.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",ue.classList.toggle("off",!t.soundsEnabled),Be.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Be.classList.toggle("off",!t.musicEnabled)}function cs(){Rt.classList.remove("hidden"),Yt.classList.add("hidden");let t=p.loadHighscore(Wt);de.textContent=t.score?t.score.toLocaleString():"0",ne.textContent=t.time?sn(t.time):"0:00",pn.textContent=Wt==="30_24"?"High Tower":"Quick Tower",yn.textContent=J.toLocaleString(),We.textContent=sn(ft),x.textContent=Wt==="30_24"?"High Tower":"Quick Tower",Fe()}function Ne(){Rt.classList.add("hidden"),Yt.classList.remove("hidden")}Yt.addEventListener("click",()=>{Jn(),cs()}),we.addEventListener("click",()=>{Ne(),on()});let Tn=null;function jn(t,i){z.textContent=t,Tn=i,H.classList.remove("hidden")}function to(){H.classList.add("hidden"),Tn=null}j.addEventListener("click",()=>{to()}),Y.addEventListener("click",()=>{let t=Tn;to(),t&&t()}),Pe.addEventListener("click",()=>{jn("Restart game?",()=>{Ne(),it.applyCommand("start_game")})}),xe.addEventListener("click",()=>{jn("Exit to menu?",()=>{Ne(),Yt.classList.add("hidden"),A="intro",Ct.reset(),M.stopMusic(),M.getSettings().musicEnabled&&M.startMenuMusic(),He()})}),Le.addEventListener("click",()=>{st.classList.remove("hidden")}),ue.addEventListener("click",()=>{let t=M.getSettings();M.updateSettings({soundsEnabled:!t.soundsEnabled}),Fe(),fe()}),Be.addEventListener("click",()=>{let i=!M.getSettings().musicEnabled;M.updateSettings({musicEnabled:i}),Fe(),fe()}),Rt.addEventListener("click",t=>{t.target===Rt&&(Ne(),on())}),document.addEventListener("keydown",t=>{A==="paused"&&!Rt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Ne(),on())}),F.addEventListener("click",()=>{st.classList.add("hidden")}),st.addEventListener("click",t=>{t.target===st&&st.classList.add("hidden")});let Ln=!1;document.addEventListener("visibilitychange",()=>{document.hidden?A==="playing"&&(Jn(),Ln=!0):Ln&&A==="paused"&&(on(),Ln=!1)});let it=Ro({getN:()=>c,getH:()=>n,FALL_INTERVAL:kt,LOCK_DELAY_SEC:Gt,getKillRate:f,MATCH_HIGHLIGHT_SEC:$e,MAGIC_SHRINK_SEC:Xt,RING_HIGHLIGHT_SEC:be,getState:()=>({gameState:A,score:J,elapsedMs:ft,startTime:Vt,totalPausedMs:Ft,stats:q,activePiece:m,pieceY:C,targetRot:gt,rotFloat:ot,rotVel:yt,isGrounded:I,isHighlighting:ie,isMagicAnimation:Ce,isRingAnimation:Ge,highlightStartTime:ke,killLevel:G,grid:y,fallTimer:B,lockTimer:nt}),setState:t=>{"elapsedMs"in t&&(ft=t.elapsedMs),"killLevel"in t&&(G=t.killLevel),"fallTimer"in t&&(B=t.fallTimer),"lockTimer"in t&&(nt=t.lockTimer),"targetRot"in t&&(gt=t.targetRot),"rotFloat"in t&&(ot=t.rotFloat),"rotVel"in t&&(yt=t.rotVel)},funcs:{startGame:qo,endGame:Cn,rotatePieceByDir:Yo,tryMoveDown:es,canPlaceAtRot:$n,maybeResetLockDelay:Un,shootMagic:Ho,selectMagic:ko,updateGroundedState:Ko,lockPiece:jo,finishHighlight:Vo,finishRingHighlight:Jo},ui:{updateTimeHud:vn,updateRemainingHud:Xn}}),Bn=wo({canvas:o,canvasCtx:u,getN:()=>c,getH:()=>n,TOP_PAD_PX:S,BOTTOM_PAD_PX:R,SIDE_MARGIN_PX:O,MAX_RADIUS_X:X,RADIUS_X_FACTOR:k,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:$e,MATCH_SHRINK_PHASE:cn,MAGIC_SHRINK_SEC:Xt,RING_HIGHLIGHT_SEC:be,LOCK_DELAY_SEC:Gt,getKillRate:f,ELEMENT_COLORS:ae,ELEMENT_TO_COLOR:Dt,BLOCK_COLOR_FRONT:W,BLOCK_COLOR_BACK:pt,ACTIVE_COLOR_FRONT:Zt,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:w,GHOST_STROKE_WIDTH:at,MAGIC_DIM_DOT_ALPHA:Te,MAGIC_DIM_DOT_SCALE:Ue,MAGIC_TARGET_DOT_SCALE:an,getState:()=>({gameState:A,grid:y,activePiece:m,pieceY:C,rotFloat:ot,killLevel:G,isHighlighting:ie,highlightedCells:se,highlightStartTime:ke,isMagicAnimation:Ce,isRingAnimation:Ge,isGrounded:I,lockTimer:nt}),getVisualSettings:()=>({waterBubbles:pe,waterColor:Et}),funcs:{snappedRot:ze,computeGhostY:Wo,normSector:xn,getMagicTargetColor:()=>Kt.canUse()?Dt[Kt.active]:null}}),In=performance.now();function eo(t){let i=Math.min(.05,Math.max(.001,(t-In)/1e3));In=t,it.update(i,t),ot=gt,ot>1e6&&(ot%=c),ot<-1e6&&(ot%=c),Bn.render(i),requestAnimationFrame(eo)}ee.addEventListener("click",()=>{it.applyCommand("start_game")}),De.addEventListener("click",()=>{it.applyCommand("start_game")}),Tt.addEventListener("click",()=>{A="intro",Ct.reset(),M.stopMusic(),M.getSettings().musicEnabled&&M.startMenuMusic(),He()}),kn.forEach(t=>{t.addEventListener("click",()=>{kn.forEach(tt=>tt.classList.remove("active")),t.classList.add("active"),Wt=t.dataset.mode;let i=p.loadHighscore(Wt);i.score>0?(wt.textContent=i.score.toLocaleString(),Pt.textContent=`(${Ie(i.time)})`):(wt.textContent="0",Pt.textContent="");let l=a[Wt]||a["30_24"],E=Math.floor(l.survivalTime/60),$=l.survivalTime%60;me.textContent=`${E}:${$.toString().padStart(2,"0")}`,ee.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ee.classList.add("idlePulse"),2e3)})}),Po.addEventListener("click",()=>{let t=p.loadHighscore("30_24"),i=p.loadHighscore("25_20"),l=`Records

`;l+=`High Tower (30\xD724):
`,l+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ie(t.time)}
`:`  No record yet
`,l+=`
Quick Tower (25\xD720):
`,l+=i.score>0?`  Score: ${i.score.toLocaleString()}, Time: ${Ie(i.time)}
`:`  No record yet
`,alert(l)}),Oo.addEventListener("click",()=>{st.classList.remove("hidden")}),Do.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),En(),He(),M.startMenuMusic();let as=()=>{if(M.unlock(),!M.getSettings().musicEnabled)return;let t=M.musicAudio;!t||t.paused||t.ended?it.state==="playing"?M.startGameMusic():M.startMenuMusic():t.play().catch(i=>{console.debug("Music resume on interaction failed:",i)})},no=0,rs=10,ls=()=>{no>=rs||(no++,as())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ls,{passive:!0})}),requestAnimationFrame(eo)})();})();
