(()=>{var Ni=[0,.25,.5,.75,1],Gi=[0,.05,.15,.25,.5],Ui={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},So={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Eo="soundSettings";function Xi(){try{let e=localStorage.getItem(Eo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Yi(e){try{localStorage.setItem(Eo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function bo(){return{audioContext:null,buffers:{},settings:Xi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),r=this.audioContext.createBufferSource();r.buffer=n,r.connect(this.audioContext.destination),r.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Ni[this.settings.soundVolume]},getMusicVolume(){return Gi[this.settings.musicVolume]},async loadSound(n,r){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(r)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(d){console.debug(`Failed to load sound: ${n} from ${r}`,d)}},preload(){this.initContext();for(let[n,r]of Object.entries(Ui))this.loadSound(n,r)},play(n,r=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;r!==null&&(d=`${n}${r}`);let i=this.buffers[d];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let r=1+Math.floor(Math.random()*3);this.play(n,r)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(So.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(r=>{console.debug("Menu music autoplay blocked:",r)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(So.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(r=>{console.debug("Game music play failed:",r)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Yi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(r=>{console.debug("Music resume failed:",r)}):this.stopMusic()}catch(r){console.debug("Update music settings failed:",r)}},getSettings(){return{...this.settings}}}}var Mo="eb_highscore",xo="eb_highscore_quick",Co="eb_settings",To="eb_high_tower_rings",Wi={invertSwipe:!1,hapticsEnabled:!0};function _o(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?xo:Mo,r=localStorage.getItem(n);if(r)return JSON.parse(r)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,r="30_24"){try{let d=this.loadHighscore(r);if(e>d.score||e===d.score&&n>d.time){let i=r==="25_20"?xo:Mo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Wi}},saveGameSettings(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(To);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(To,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let r=this.loadHighTowerRings()+e;return this.saveHighTowerRings(r),r}}}function Lo(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Bo(e){return document.getElementById("tab-"+e)}var Vi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Ro(e={}){let{elementColors:n={}}=e,r=0;return{showBonus(d,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=d,s&&n[s]&&(c.style.color=n[s]);let f=window.innerWidth/2,m=window.innerHeight/2-40,g=(Math.random()-.5)*200,a=(Math.random()-.5)*100+r*36;c.style.left=`${f+g}px`,c.style.top=`${m+a}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),r++,setTimeout(()=>{r=Math.max(0,r-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(d){return Vi[d]||"\u2726"}}}var ws={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function wo(){return{spawnMagicOrb(e,n,r,d){if(!d)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=ws[e]||"\u2726";let s=d.getBoundingClientRect(),c=s.left+s.width/2-n,f=s.top+s.height/2-r,m=Math.hypot(c,f),g=Math.atan2(f,c),a=m*.35*(Math.random()>.5?1:-1),p=g+Math.PI/2,b=c*.5+Math.cos(p)*a,w=f*.5+Math.sin(p)*a;i.style.setProperty("--mid-x",`${b}px`),i.style.setProperty("--mid-y",`${w}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${f}px`),i.style.left=`${n}px`,i.style.top=`${r}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,r,d,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,f=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=ws[e]||"\u2726";let g=r-c,a=d-f;m.style.setProperty("--end-x",`${g}px`),m.style.setProperty("--end-y",`${a}px`),m.style.left=`${c}px`,m.style.top=`${f}px`,document.body.appendChild(m);let p=setInterval(()=>{let b=m.getBoundingClientRect();this.spawnTrailParticle(e,b.left+b.width/2,b.top+b.height/2)},40);setTimeout(()=>{clearInterval(p),m.remove(),this.spawnExplosion(e,r,d),i&&i()},300)},spawnTrailParticle(e,n,r){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${n}px`,d.style.top=`${r}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,n,r){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,f=40+Math.random()*40,m=Math.cos(c)*f,g=Math.sin(c)*f;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${r}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",r=18){if(!e)return;let d=n;typeof n=="number"&&(r=n,d="water"),ws[d]||(d="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,f=Math.max(8,Math.round(r));for(let m=0;m<f;m++){let g=document.createElement("div");g.className=`spell-bubble ${d}`,g.textContent="\u25CF";let a=m/f*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,b=Math.cos(a)*p,w=Math.sin(a)*p-20;g.style.setProperty("--px",`${b}px`),g.style.setProperty("--py",`${w}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,r){if(!r)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let i=r.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,f=Math.hypot(s,c),m=Math.atan2(c,s),g=f*.35*(Math.random()>.5?1:-1),a=m+Math.PI/2,p=s*.5+Math.cos(a)*g,b=c*.5+Math.sin(a)*g;d.style.setProperty("--mid-x",`${p}px`),d.style.setProperty("--mid-y",`${b}px`),d.style.setProperty("--end-x",`${s}px`),d.style.setProperty("--end-y",`${c}px`),d.style.left=`${e}px`,d.style.top=`${n}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}var Ki=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Ao=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,qi=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function zi(e){let n=e.querySelector(".ring"),r=e.querySelector(".falling-figure"),d=e.querySelector(".clock");if(!n||!r||!d)return()=>{};let i=!1,s=[],c=[],f=(K,q)=>{let it=setTimeout(()=>{i||K()},q);return s.push(it),it},m=(K,q)=>{let it=setInterval(()=>{if(i){clearInterval(it);return}K()},q);return c.push(it),it},g=48,a=.9,p=9,b=9,w=3,$=2,j=18,ft=-12,Gt=.5,ye=12,nt=10,F=["--fire","--water","--light","--earth"],pt=["--light","--fire","--water"],ee=3,Pt=Math.floor(p/2)-1,Yt=8e3,Rt=[];function wt(K,q){let it=(q-1)/2,Qt=Math.abs(K-it)/it;return 1-(1-Gt)*Qt}function R(K,q,it,Qt){let be=(q-1)/2,Q=Math.abs(K-be)/be;return Qt?Q*it:-Q*it}function Ct(){n.innerHTML="";let K=[],q=[];for(let tt=0;tt<b;tt++)q.push(g*a*wt(tt,b));let it=q.reduce((tt,_t)=>tt+_t,0)+(b-1)*$,Qt=[];for(let tt=0;tt<p;tt++)Qt.push(g*wt(tt,p));let be=Qt.reduce((tt,_t)=>tt+_t,0)+(p-1)*w,Q=-it/2;for(let tt=0;tt<b;tt++){let _t=q[tt],Ht=g*a,fe=p+tt,St=R(tt,b,nt,!0),ne=document.createElement("div");ne.className="block back",ne.style.cssText=`left:${Q.toFixed(1)}px;top:${(ft-Ht/2+St).toFixed(1)}px;width:${_t.toFixed(1)}px;height:${Ht.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let N=document.createElement("div");N.className="dot";let se=a*wt(tt,b);N.style.cssText=`--c:var(${F[fe%4]});transform:scale(${se.toFixed(2)});`,ne.appendChild(N),ne.dataset.index=fe,n.appendChild(ne),K[fe]=ne,Q+=_t+$}let J=-be/2;for(let tt=0;tt<p;tt++){let _t=Qt[tt],Ht=g,fe=tt,St=R(tt,p,ye,!1),ne=fe>=Pt&&fe<Pt+ee,N=document.createElement("div");N.className="block",ne&&N.classList.add("gap"),N.style.cssText=`left:${J.toFixed(1)}px;top:${(j-Ht/2+St).toFixed(1)}px;width:${_t.toFixed(1)}px;height:${Ht.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let se=document.createElement("div");se.className="dot";let Ce=wt(tt,p);se.style.cssText=`--c:var(${F[fe%4]});transform:scale(${Ce.toFixed(2)});`,N.appendChild(se),N.dataset.index=fe,n.appendChild(N),K[fe]=N,J+=_t+w}Rt=K}function Tt(){let K=[];for(let q=Pt-1;q>=0;q--)K.push(q);for(let q=0;q<b;q++)K.push(p+q);for(let q=p-1;q>=Pt;q--)K.push(q);return K}function yt(){Rt.forEach((K,q)=>{K&&(K.classList.remove("hi","vanish","gap"),K.style.opacity="",K.style.transform="",q>=Pt&&q<Pt+ee&&K.classList.add("gap"))})}function l(){for(let K=0;K<ee;K++){let q=Rt[Pt+K];if(q){q.classList.remove("gap");let it=q.querySelector(".dot");if(it){let Qt=wt(Pt+K,p);it.style.cssText=`--c:var(${pt[K]});transform:scale(${Qt.toFixed(2)});`}}}}function ot(K){let q=Tt(),it=0,Qt=q.length,be=m(()=>{if(it>0&&it<=Qt){let Q=Rt[q[it-1]];Q&&Q.classList.remove("hi")}if(it<Qt){let Q=Rt[q[it]];Q&&Q.classList.add("hi"),it++}else clearInterval(be),Rt.forEach(Q=>{Q&&Q.classList.add("hi")}),f(K,300)},30)}function Z(K){let q=Tt(),it=q.length;q.forEach((Qt,be)=>{let Q=Rt[Qt];Q&&f(()=>{Q.classList.add("vanish")},be*40)}),f(K,it*40+500)}function ue(){i||(yt(),r.classList.add("active"),f(()=>{l(),r.classList.remove("active"),r.style.opacity="0",f(()=>{ot(()=>{i||(d.classList.add("show"),f(()=>{Z(()=>{i||(d.classList.remove("show"),r.style.opacity="",f(ue,500))})},400))})},200)},Yt*.38))}return Ct(),ue(),()=>{i=!0,s.forEach(clearTimeout),c.forEach(clearInterval)}}var ji=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:Ki},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Ao},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:qi,onEnter:e=>zi(e)}];function Io(e={}){let{helpBtn:n,mount:r=document.body,combosTemplate:d}=e;if(!n||!r)return{open(){},close(){},setCombosTemplate(){}};let i=ji.map(R=>({...R}));typeof d=="string"&&d.trim()&&(i[1].illustrationHtml=d);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,r.appendChild(s);let c=s.querySelector(".help-next-btn"),f=s.querySelector(".help-slide-title"),m=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),a=s.querySelector(".help-dots"),p=i.map(()=>{let R=document.createElement("span");return R.className="help-dot",a.appendChild(R),R}),b=0,w=!1,$=null,j=null,ft=180,Gt=560,ye=460,nt=480,F=R=>{j&&(j(),j=null);let Ct=i[R];Ct&&(b=R,f.textContent=Ct.title,m.textContent=Ct.text,g.innerHTML=Ct.illustrationHtml||"",p.forEach((Tt,yt)=>{Tt.classList.toggle("active",yt===R)}),c.textContent=R===i.length-1?"Done":"Next",pt(),Ct.onEnter&&(j=Ct.onEnter(g)))},pt=()=>{if(!w||s.classList.contains("hidden"))return;let R=g.getBoundingClientRect();if(!R.width||!R.height)return;let Ct=g.querySelector(".help-combos");if(Ct){let l=Math.min(1,Math.min(R.width,R.height)/Gt);Ct.style.setProperty("--help-combos-scale",l.toFixed(3))}let Tt=g.querySelector(".help-controls");if(Tt){let l=Math.min(1,Math.min(R.width,R.height)/ye);Tt.style.setProperty("--help-controls-scale",l.toFixed(3))}let yt=g.querySelector(".help-rings");if(yt){let l=Math.min(1,Math.min(R.width,R.height)/nt);yt.style.setProperty("--help-rings-scale",l.toFixed(3))}},ee=()=>{w&&pt()},Pt=R=>{w&&R.stopPropagation()},Yt=R=>{if(w){if(R.key==="Escape"){R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.(),wt();return}R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.()}},Rt=()=>{w||(w=!0,$&&(clearTimeout($),$=null),F(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),pt()}),document.addEventListener("keydown",Yt,!0),window.addEventListener("resize",ee))},wt=()=>{w&&(w=!1,j&&(j(),j=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",Yt,!0),window.removeEventListener("resize",ee),$=window.setTimeout(()=>{s.classList.add("hidden")},ft))};return s.addEventListener("click",R=>{w&&(R.target===s&&wt(),R.stopPropagation())}),s.addEventListener("pointerdown",Pt),s.addEventListener("pointerup",Pt),s.addEventListener("touchstart",Pt,{passive:!0}),s.addEventListener("touchmove",R=>{w&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),s.addEventListener("wheel",R=>{w&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),c.addEventListener("click",R=>{R.stopPropagation(),b<i.length-1?F(b+1):wt()}),n.addEventListener("click",R=>{R.preventDefault(),Rt()}),{open:Rt,close:wt,setCombosTemplate(R){typeof R=="string"&&(i[1].illustrationHtml=R.trim()||Ao,w&&b===1&&F(1))}}}var Qi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function Zi(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var As=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let r=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return r?(navigator.vibrate(r),!0):!1}},Is=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Po({enabled:e=!0,patterns:n=Qi}={}){let r=Zi(),d=r?new Is(r):new As,i=d.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let f=n[c];return f?d.trigger({name:c,...f}):!1}}}function ko(e={}){let{buttons:n={},onActivate:r=null,onChange:d=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[m,g]of Object.entries(n)){if(!g)continue;let a=i[m],p=g.querySelector(".charges");p&&(p.textContent=a),g.classList.toggle("empty",a<=0),g.classList.toggle("active",s===m&&a>0)}d&&d({...i},s)}function f(m){let g=n[m];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(m){s=m},select(m){if(i[m]<=0)return!1;let g=s===m;return s=g?null:m,c(),!g&&s===m&&r&&r(),!g},useCharge(){if(!s||i[s]<=0)return!1;let m=s;return i[m]--,s=null,c(),f(m),!0},addCharges(m,g){i[m]!==void 0&&(i[m]+=g,c(),f(m))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(m){for(let[g,a]of Object.entries(n))a&&a.addEventListener("click",()=>{m&&m(g)})}}}var tn={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function Oo(e={}){let{button:n=null,onActivate:r=null,onProgress:d=null,onReady:i=null}=e,s="ice",c=0;function f(){return tn[s]||tn.ice}function m({silent:a=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=f(),b=Number.isFinite(p.maxProgress)?p.maxProgress:0,w=b>0?Math.min(c/b,1)*100:0,$=b>0&&c>=b;n.style.setProperty("--progress",`${w}%`);let j=n.querySelector(".spell-icon");j&&(j.textContent=p.icon);let ft=n.querySelector(".spell-counter");ft&&(ft.textContent=b>0?`${Math.min(c,b)}/${b}`:""),n.classList.toggle("ready",$),n.classList.toggle("charging",!$&&c>0),d&&!a&&b>0&&d(c,b)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return f().maxProgress??0},get isReady(){let a=f().maxProgress;return Number.isFinite(a)&&a>0&&c>=a},get effect(){return f().effect},getUnlockRings(a){return(tn[a]||tn.ice).unlockRings??0},getCost(a){return(tn[a]||tn.ice).cost??0},getDescription(a){return(tn[a]||tn.ice).description||""},getEffect(a){return(tn[a]||tn.ice).effect},get button(){return n},selectSpell(a){tn[a]&&(s=a,c=0,m())},addProgress(a=1){let p=f();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||c>=p.maxProgress)return!1;let b=c<p.maxProgress;return c=Math.min(c+a,p.maxProgress),m(),g(),b&&c>=p.maxProgress&&i&&i(),!0},setProgress(a,{silent:p=!1}={}){c=Math.max(0,a),m({silent:p})},canUse(){let a=f().maxProgress;return Number.isFinite(a)&&a>0&&c>=a},use(){if(!this.canUse())return null;let a=f().effect;return c=0,m(),g(),r&&r(s),a},reset(){c=0,m()},pulse(){g()},updateButton:m,initButton(a){n&&n.addEventListener("click",()=>{a&&a()})}}}function Ps({centerY:e,centerS:n,size:r,H:d,normSector:i}){let s=[],c=Math.floor(r/2);for(let f=-c;f<=c;f++)for(let m=-c;m<=c;m++){let g=e+f,a=i(n+m);if(g<0||g>=d)continue;let p=f*f+m*m;s.push({y:g,s:a,distSq:p})}return s}function us(e,n,r){return n.filter(d=>e[d.y][d.s]===r)}function fs(e,n){return[...e].sort((d,i)=>d.distSq!==i.distSq?d.distSq-i.distSq:d.y!==i.y?d.y-i.y:d.s-i.s).slice(0,n).map(d=>({y:d.y,s:d.s}))}function Do({centerY:e,centerS:n,beamLength:r,N:d,H:i,normSector:s}){if(e<0||e>=i||r<0||d<=0)return[];let c=[],f=new Set,m=(a,p)=>`${a},${p}`,g=s(n);c.push({y:e,s:g,dist:0}),f.add(m(e,g));for(let a=1;a<=r;a++){let p=s(n+a),b=m(e,p);f.has(b)||(c.push({y:e,s:p,dist:a}),f.add(b));let w=s(n-a),$=m(e,w);f.has($)||(c.push({y:e,s:w,dist:a}),f.add($))}for(let a=1;a<=r;a++){let p=s(n),b=e+a;if(b<i){let $=m(b,p);f.has($)||(c.push({y:b,s:p,dist:a}),f.add($))}let w=e-a;if(w>=0){let $=m(w,p);f.has($)||(c.push({y:w,s:p,dist:a}),f.add($))}}return c}function Ho(e){let{canvas:n,dom:r,getGrid:d,getN:i,getH:s,getRotFloat:c,constants:f,helpers:m,Spell:g,Magic:a,SoundModule:p,State:b,isGamePlaying:w,addPendingKzDrop:$,getKillRate:j,triggerSpellWave:ft,spawnSpellBubbles:Gt,spawnBonusBubbles:ye,getTransmuteEffect:nt,getLightningEffect:F,getFireEffect:pt,continueMatchProcessing:ee,updateScoreHud:Pt,showBonus:Yt,getSpellCost:Rt,getSpellElement:wt,onUltimateApplied:R,isSpellBlocked:Ct,setScore:Tt,setCascadeLevel:yt}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:ot,SIDE_MARGIN_PX:Z,MAX_RADIUS_X:ue,SCORE_MAGIC_DESTROY:K}=f,{normSector:q,levelYToScreenY:it,sectorCenterXY:Qt}=m,be=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],Q="idle",J=null,tt=null,_t=[],Ht=[],fe=0,St=null,ne=0,N="idle",se=null,Ce=[],oe=[],G=0,P=0,B="idle",I=null,_=[],h=[],st=0;function ct(S){if(typeof Rt!="function"||typeof wt!="function")return!1;let T=wt(S),M=Rt(S);return!T||!M?!1:(a.charges[T]??0)>=M}function Et(S){if(typeof Rt!="function"||typeof wt!="function")return!1;let T=wt(S),M=Rt(S);return!T||!M||(a.charges[T]??0)<M?!1:(a.charges[T]-=M,a.updateButtons(),g.pulse(),!0)}let Mt=0,C=350;function v(){return typeof Ct=="function"?Ct():!1}function A(){let S=performance.now();S-Mt<C||(Mt=S,p.play("cancel"))}function zt(){Q="selecting_source",J=null,tt=null,_t=[],Ht=[],N!=="idle"&&Ut(),B!=="idle"&&le(),a.deactivate(),p.play("ulta");let S=r.spellBtn;S&&S.classList.add("selecting")}function y(){Q!=="idle"&&p.play("cancel"),Q="idle",J=null,tt=null,_t=[],Ht=[],Ot();let S=r.spellBtn;S&&S.classList.remove("selecting")}function Lt(S,T){if(Q!=="selecting_source")return!1;if(v())return A(),!0;let M=V(S,T);if(!M)return y(),!0;let gt=d();J={y:M.y,s:M.s,color:gt[M.y][M.s]},_t=Ps({centerY:M.y,centerS:M.s,size:nt().areaSize,H:s(),normSector:q});let rt=J.color,Bt=us(gt,_t,rt);return Ht=fs(Bt,nt().maxBlocks),Wt(J.color,M.y),Q="selecting_target",!0}function V(S,T){let M=n.clientWidth,gt=n.clientHeight,rt=M*.5,Bt=(M-2*Z)/2,qt=gt-l-ot,Me=6,ie=s(),Pe=i(),qe=c(),xe=Pe*qt/(Me*ie),ce=gt-ot,pe,ze,je;xe<=Math.min(Bt,ue)?(pe=xe,ze=qt,je=l):(pe=Math.min(Bt,ue),ze=pe*Me*ie/Pe,je=ce-ze);let Xe=pe*.28,Qe=null,rn=1/0,an=d();for(let Jt=0;Jt<ie;Jt++){let pn=it(je,ze,Jt+.5);for(let ke=0;ke<Pe;ke++){if(!an[Jt][ke])continue;let Oe=Qt(rt,pn,pe,Xe,ke,qe);if(Math.sin(Oe.ang)<-.1)continue;let re=S-Oe.x,Sn=T-Oe.y,_e=Math.hypot(re,Sn),De=ze/ie*.9,x=De*1.2;Math.abs(re)<x/2&&Math.abs(Sn)<De/2&&_e<rn&&(rn=_e,Qe={y:Jt,s:ke})}}return Qe}function Wt(S,T){Ot();let M=document.createElement("div");M.className="transmute-popup";let gt=n.clientWidth,rt=n.clientHeight,Bt=(gt-2*Z)/2,qt=rt-l-ot,Me=6,ie=s(),Pe=i(),qe=Pe*qt/(Me*ie),xe=rt-ot,ce,pe;qe<=Math.min(Bt,ue)?(ce=qt,pe=l):(ce=Math.min(Bt,ue)*Me*ie/Pe,pe=xe-ce);let ze=it(pe,ce,T+.5),je=Math.floor(nt().areaSize/2),Xe=it(pe,ce,Math.min(ie,T+je)+.5),Qe=it(pe,ce,Math.max(0,T-je)+.5),rn=pe+ce/2,an=document.getElementById("gameContainer"),Jt=an?an.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},pn=160,ke=60,Oe=20,hn=Jt.left+Jt.width/2-pn/2,re;ze<rn?re=Jt.top+Qe+Oe:re=Jt.top+Xe-ke-Oe,re=Math.max(10,Math.min(window.innerHeight-ke-10,re)),M.style.left=`${hn}px`,M.style.top=`${re}px`,be.filter(_e=>_e.color!==S).forEach(_e=>{let De=document.createElement("button");De.className=`transmute-btn ${_e.name}`,De.innerHTML=_e.icon,De.setAttribute("data-color",_e.color),De.addEventListener("click",x=>{x.stopPropagation(),ge(_e.color)}),M.appendChild(De)}),document.body.appendChild(M),St=M,ne=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Vt)},50)}function Vt(S){performance.now()-ne<200||St&&!St.contains(S.target)&&y()}function Ot(){document.removeEventListener("pointerdown",Vt),St&&(St.remove(),St=null)}function ge(S){if(v()){A();return}if(!ct(g.currentSpell)){A();return}if(Ot(),tt=S,Ht.length===0){y();return}Te()}function Te(){if(!J){y();return}if(Ht.length===0){y();return}if(!Et(g.currentSpell)){A(),y();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),Q="animating",fe=performance.now(),p.play("esseffect")}function Mn(){if(Q!=="selecting_target"&&Q!=="animating"||!J||!_t||_t.length===0)return;let S=d(),T=S[J.y]?.[J.s]??0;if(!T||T!==J.color){y();return}let M=us(S,_t,T),gt=nt().maxBlocks??M.length;Ht=fs(M,gt),Ht.length===0&&y()}function bt(S){if(Q!=="animating")return!1;let T=(S-fe)/1e3;return Math.min(T/nt().animSec,1)>=1?(en(),!1):!0}function Ne(S){if(Q!=="animating")return null;let T=(S-fe)/1e3,M=Math.min(T/nt().animSec,1),gt="flash",rt=0,Bt=0;return M<.15?(gt="flash",Bt=1-M/.15):M<.55?(gt="shrink",rt=(M-.15)/.4):(gt="grow",rt=(M-.55)/.45),{phase:gt,progress:rt,areaFlash:Bt}}function en(){let S=d();for(let T of Ht)S[T.y][T.s]=tt;Q="idle",J=null,tt=null,_t=[],Ht=[],yt(1),ee(),typeof R=="function"&&R("earth")}function It(){p.play("ulta"),N="selecting_source",se=null,Ce=[],oe=[],P=0,Q!=="idle"&&(Q="idle",J=null,tt=null,_t=[],Ht=[],Ot()),B!=="idle"&&(B="idle",I=null,_=[],h=[],st=0),a.deactivate();let S=r.spellBtn;S&&S.classList.add("selecting")}function Ut(){N!=="idle"&&p.play("cancel"),N="idle",se=null,Ce=[],oe=[],P=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function Ge(){B="selecting_source",I=null,_=[],h=[],st=0,Q!=="idle"&&(Q="idle",J=null,tt=null,_t=[],Ht=[],Ot()),N!=="idle"&&(N="idle",se=null,Ce=[],oe=[],P=0),a.deactivate(),p.play("ulta");let S=r.spellBtn;S&&S.classList.add("selecting")}function le(){B!=="idle"&&p.play("cancel"),B="idle",I=null,_=[],h=[],st=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function O(S,T){if(N!=="selecting_source")return!1;if(v())return A(),!0;let M=V(S,T);if(!M)return Ut(),!0;let gt=d();se={y:M.y,s:M.s,color:gt[M.y][M.s]},Ce=Ps({centerY:M.y,centerS:M.s,size:F().areaSize,H:s(),normSector:q});let rt=se.color,Bt=us(gt,Ce,rt);return oe=fs(Bt,F().maxBlocks),oe.length===0?(Ut(),!0):ct(g.currentSpell)?(kt(),!0):(A(),!0)}function Kt(S,T){if(B!=="selecting_source")return!1;if(v())return A(),!0;let M=V(S,T);if(!M)return le(),!0;let gt=d();return I={y:M.y,s:M.s,color:gt[M.y][M.s]},_=Do({centerY:M.y,centerS:M.s,beamLength:pt().beamLength,N:i(),H:s(),normSector:q}),h=_.filter(rt=>gt[rt.y][rt.s]).sort((rt,Bt)=>rt.dist-Bt.dist),h.length===0?(le(),!0):ct(g.currentSpell)?(fn(),!0):(A(),!0)}function kt(){if(!se||oe.length===0){Ut();return}if(!Et(g.currentSpell)){A(),Ut();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),N="animating",G=performance.now(),P=0,p.play("asseffect")}function me(S){if(N!=="animating")return!1;let T=S-G,M=F().flashMs+oe.length*F().jumpMs;return T>=M?(Ke(),!1):!0}function xn(S){if(N!=="animating")return null;let T=S-G;if(T<F().flashMs)return{phase:"flash",flashProgress:1-T/F().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let M=T-F().flashMs,gt=Math.floor(M/F().jumpMs),rt=M%F().jumpMs/F().jumpMs,Bt=[];for(let qt=0;qt<Math.min(gt,oe.length);qt++)Bt.push(qt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(gt,oe.length-1),jumpProgress:rt,struckTargets:Bt}}function Ke(){let S=d(),T=oe.length,M=T*K;b.addScore(M),Tt(b.score),Pt(),Yt(`+${M}`,"score");for(let qt of oe)S[qt.y][qt.s]=0;let gt=F(),rt=Math.abs(gt.kzDropSecPerBlock??0),Bt=T*rt;Bt>0&&typeof $=="function"&&typeof j=="function"&&($(Bt*j()),Yt(`\u26A1 -${Bt}s`,"time")),N="idle",se=null,Ce=[],oe=[],P=0,yt(1),ee(),typeof R=="function"&&R("air")}function fn(){if(!I||h.length===0){le();return}if(!Et(g.currentSpell)){A(),le();return}let S=r.spellBtn;S&&S.classList.remove("selecting"),B="animating",st=performance.now(),p.play("fsseffect")}function gn(S){return B!=="animating"?!1:(S-st)/1e3>=pt().animSec?(lt(),!1):!0}function Ue(S){if(B!=="animating")return null;let T=pt(),M=Math.max(.001,T.animSec),gt=(S-st)/1e3,rt=Math.min(gt/M,1),Bt=.25,qt=rt<Bt?1-rt/Bt:0,Me=.6,ie=rt<Me?rt/Me*T.beamLength:T.beamLength;return{progress:rt,flashProgress:qt,beamLength:T.beamLength,beamReach:ie}}function lt(){let S=d(),T=h.length;if(T>0){let M=T*K;b.addScore(M),Tt(b.score),Pt(),Yt(`+${M}`,"score")}for(let M of h)S[M.y][M.s]=0;B="idle",I=null,_=[],h=[],st=0,yt(1),ee(),typeof R=="function"&&R("fire")}function de(){let S=typeof w=="function"?w():b.isPlaying(),T=g.currentSpell;if(!S)return!1;if(T==="ice"){if(v()||!ct(T)||!Et(g.currentSpell))return A(),!1;let M=g.effect;return typeof $=="function"&&typeof j=="function"&&$(M.duration*j()),p.play("wsseffect"),Yt(`\u{1F4A7} -${M.duration}s`,"time"),typeof ft=="function"&&ft(),typeof ye=="function"&&ye(M.duration),typeof R=="function"&&R(T),!0}return T==="earth"?Q==="selecting_source"||Q==="selecting_target"?(y(),!0):Q!=="idle"||v()||!ct(T)?(A(),!1):(Q==="idle"&&zt(),!0):T==="air"?N==="selecting_source"?(Ut(),!0):N!=="idle"||v()||!ct(T)?(A(),!1):(N==="idle"&&It(),!0):T==="fire"?B==="selecting_source"?(le(),!0):B!=="idle"||v()||!ct(T)?(A(),!1):(B==="idle"&&Ge(),!0):!1}function Cn(S){Mn(),bt(S),me(S),gn(S)}function Yn(S,T){return v()&&(Q==="selecting_source"||N==="selecting_source"||B==="selecting_source")?(A(),!0):Q==="selecting_source"?Lt(S,T):N==="selecting_source"?O(S,T):B==="selecting_source"?Kt(S,T):!1}function mn(){Q="idle",J=null,tt=null,_t=[],Ht=[],Ot(),N="idle",se=null,Ce=[],oe=[],P=0,B="idle",I=null,_=[],h=[],st=0;let S=r.spellBtn;S&&S.classList.remove("selecting")}function Zt(){return{transmuteState:Q,transmuteSourceBlock:J,transmuteTargetColor:tt,transmuteAreaCells:_t,transmuteBlocksToChange:Ht,lightningState:N,lightningSourceBlock:se,lightningAreaCells:Ce,lightningBlocksToHit:oe,fireState:B,fireSourceBlock:I,fireLineCells:_,fireTargets:h}}return{startTransmuteSourceSelection:zt,cancelTransmutation:y,startLightningSourceSelection:It,cancelLightning:Ut,startFireSourceSelection:Ge,cancelFire:le,handleTap:Yn,update:Cn,reset:mn,getRenderState:Zt,getTransmuteAnimState:Ne,getLightningAnimState:xn,getFireAnimState:Ue,handleSpellButtonClick:de,isTransmuteSelecting:()=>Q==="selecting_source",isLightningSelecting:()=>N==="selecting_source"}}var Ji={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function $o(e={}){let{canvas:n}=e,r=e.rotDir||1,d=!1,i=0,s=0,c=0,f=0,m=0,g=1,a=null,p=0,b=0,w=0,$=0,j=0,ft=0,Gt=0,ye=0,nt=Ji;return{get rotDir(){return r},set rotDir(F){r=F},get dragging(){return d},get dragMode(){return a},handlePointerDown(F,pt,ee){if(pt.onMagicTap&&pt.onMagicTap(F.clientX,F.clientY))return!0;let Pt=performance.now(),Yt=Pt-ft,Rt=F.clientX-Gt,wt=F.clientY-ye,R=Math.hypot(Rt,wt);return Yt<=nt.DOUBLE_TAP_MS&&R<=nt.DOUBLE_TAP_MAX_DIST?(pt.onDoubleTap&&pt.onDoubleTap(),ft=0):(ft=Pt,Gt=F.clientX,ye=F.clientY),d=!0,g=-1,i=F.clientX,s=F.clientY,c=ee,f=0,m=0,a=null,p=Pt,b=F.clientX,w=F.clientY,$=p,j=0,n&&n.setPointerCapture(F.pointerId),!1},handlePointerMove(F,pt,ee,Pt){if(!d)return null;let Yt=F.clientX-i,Rt=F.clientY-s,wt=performance.now();if(Math.abs(Yt)<nt.DEADZONE_PX&&Math.abs(Rt)<nt.DEADZONE_PX)return null;if(a){if(a==="rotate"){let Ct=Math.abs(Yt),Tt=Math.abs(Rt);if(Tt>=Ct*nt.AXIS_DOMINANCE&&Tt>=nt.DROP_SWIPE_MIN_DISTANCE){let yt=Math.max(1,wt-p);Tt/yt*1e3>=nt.DROP_SWIPE_MIN_SPEED&&(a="drop",m=0)}}}else{let Ct=Math.abs(Yt),Tt=Math.abs(Rt);if(Rt<0)Ct>=nt.DEADZONE_PX&&(a="rotate");else if(Tt>=Ct*nt.AXIS_DOMINANCE){if(Tt>=nt.DROP_SWIPE_MIN_DISTANCE){let yt=Math.max(1,wt-p);Tt/yt*1e3>=nt.DROP_SWIPE_MIN_SPEED?a="drop":a="rotate"}}else Ct>=Tt*nt.AXIS_DOMINANCE&&(a="rotate");if(!a)return null}let R=null;if(a==="rotate"&&Math.abs(Yt)>=nt.DEADZONE_PX){let Ct=Math.max(1,wt-$),Tt=F.clientX-b,yt=Math.max(1,Math.abs(Tt)/Ct*1e3),l=Math.max(nt.MIN_ROT_PX,Math.min(nt.MAX_ROT_PX,nt.PX_PER_STEP*(nt.SWIPE_SPEED_REF/yt)));j+=-Tt/l*r*g;let ot=Math.trunc(j);ot!==0&&(j-=ot);let Z=f+ot;if(Z!==f&&pt.canRotateTo){let ue=Math.sign(Z-f),K=c+f;for(;f!==Z;){let q=f+ue,it=c+q;if(!pt.canRotateTo(Math.floor(ee),it))break;f=q,K=it,pt.onRotateStep&&pt.onRotateStep(),Pt&&pt.onGroundedMove&&pt.onGroundedMove()}R={targetRot:K,rotFloat:K}}}if(a==="drop"&&Rt>=nt.DROP_SWIPE_MIN_DISTANCE&&pt.onDrop){let Ct=Math.max(1,wt-$),Tt=F.clientY-w,yt=Math.max(1,Tt/Ct*1e3),l=Math.max(nt.MIN_DROP_PX,Math.min(nt.MAX_DROP_PX,nt.PX_PER_DROP*(nt.SWIPE_SPEED_REF/yt))),ot=Math.trunc(Rt/l);if(ot>m){let Z=ot-m;for(let ue=0;ue<Z;ue++)pt.onDrop();m=ot}}return b=F.clientX,w=F.clientY,$=wt,R},handlePointerUp(F){if(d&&(d=!1,a=null,n&&F&&F.pointerId!==void 0))try{n.releasePointerCapture(F.pointerId)}catch{}},reset(){d=!1,a=null,f=0,m=0,j=0}}}var ks={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Fo(){let e="intro",n=0,r=0,d=0,i=0,s=0,c={...ks};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return r},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,r=performance.now(),d=0,i=0,s=0,c={...ks}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(f){n+=f},setScore(f){n=f},updateTime(){e==="playing"&&r>0&&(d=performance.now()-r-s)},getFormattedTime(){let f=Math.floor(d/1e3),m=Math.floor(f/60),g=f%60;return`${m}:${g.toString().padStart(2,"0")}`},incrementStat(f,m=1){f in c&&(c[f]+=m)},updateMaxStat(f,m){f in c&&m>c[f]&&(c[f]=m)},reset(){e="intro",n=0,r=0,d=0,i=0,s=0,c={...ks}}}}function An(e,n){return e%=n,e<0&&(e+=n),e}function No(e,n){return e[Math.min(n,e.length-1)]}function gs(e){let n=Math.max(0,Math.floor(e/1e3)),r=Math.floor(n/60),d=n%60;return`${r}:${d.toString().padStart(2,"0")}`}function Go(e,n){let r=e.map(({x:f,y:m},g)=>({x:m,y:-f,color:n[g]})),d=1/0,i=-1/0,s=1/0;for(let f of r)d=Math.min(d,f.x),i=Math.max(i,f.x),s=Math.min(s,f.y);let c=Math.round((d+i)/2);for(let f of r)f.x-=c,f.y-=s;return r.sort((f,m)=>f.y-m.y||f.x-m.x),{cells:r.map(f=>({x:f.x,y:f.y})),colors:r.map(f=>f.color)}}function Os(e,n,r,d){let i=[];return e+1<r&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:An(n-1,d)}),i.push({y:e,s:An(n+1,d)}),i}function Uo(e,n,r){let d=Array.from({length:n},()=>new Uint8Array(r)),i=[];for(let s=0;s<n;s++)for(let c=0;c<r;c++){if(!e[s][c]||d[s][c])continue;let f=[],m=[{y:s,s:c}];for(d[s][c]=1;m.length>0;){let g=m.shift();f.push(g);for(let a of Os(g.y,g.s,n,r))e[a.y][a.s]&&!d[a.y][a.s]&&(d[a.y][a.s]=1,m.push(a))}i.push(f)}return i}function Xo(e){return e.some(n=>n.y===0)}function Ds(e,n,r,d,i,s){if(!e)return!1;let c=An(r,s);for(let f of e.cells){let m=n+f.y,g=An(c+f.x,s);if(m<0)return!1;if(!(m>=i)&&d[m][g])return!1}return!0}function Yo(e,n,r,d,i,s){if(!e)return null;let c=Math.floor(n);for(;Ds(e,c-1,r,d,i,s);)c-=1;return c}function Wo(e,n,r){let d=[],i=[];for(let s=0;s<n;s++){let c=[],f=0,m=e[s][0],g=m?1:0;for(let a=1;a<=r;a++){let p=a<r?e[s][a]:0;p&&p===m?g++:(g>=1&&m&&c.push({start:f,length:g,color:m}),f=a,m=p,g=p?1:0)}if(c.length>=2){let a=c[0],p=c[c.length-1];if(a.start===0&&p.start+p.length===r&&a.color===p.color){let b=a.length+p.length;c[0]={start:p.start,length:b,color:a.color},c.pop()}}for(let a of c)if(a.length>=3){let p=[];for(let b=0;b<a.length;b++)p.push({y:s,s:(a.start+b)%r});d.push({color:a.color,length:a.length,cells:p})}}for(let s=0;s<r;s++){let c=0,f=e[0][s],m=f?1:0;for(let g=1;g<=n;g++){let a=g<n?e[g][s]:0;if(a&&a===f)m++;else{if(m>=3&&f){let p=[];for(let b=0;b<m;b++)p.push({y:c+b,s});d.push({color:f,length:m,cells:p})}c=g,f=a,m=a?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<r;c++){let f=e[s][c],m=e[s][(c+1)%r],g=e[s][(c+2)%r],a=e[s][(c+3)%r];f&&f===m&&g&&g===a&&f!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%r},{y:s,s:(c+2)%r},{y:s,s:(c+3)%r}]})}for(let s=0;s<r;s++)for(let c=0;c<n-3;c++){let f=e[c][s],m=e[c+1][s],g=e[c+2][s],a=e[c+3][s];f&&f===m&&g&&g===a&&f!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:d,pairMatches:i}}function Vo(e,n,r){let d=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<r;c++)if(!e[i][c]){s=!1;break}s&&d.push(i)}return d}function Ko(e,n){let r=new Map;e.forEach((d,i)=>r.set(`${d.x},${d.y}`,n[i]));for(let d=0;d<e.length;d++){let i=e[d],s=n[d],c=1;for(let ft=1;ft<=2&&r.get(`${i.x+ft},${i.y}`)===s;ft++)c++;if(c>=3)return!0;let f=1;for(let ft=1;ft<=2&&r.get(`${i.x},${i.y+ft}`)===s;ft++)f++;if(f>=3)return!0;let m=s,g=r.get(`${i.x+1},${i.y}`),a=r.get(`${i.x+2},${i.y}`),p=r.get(`${i.x+3},${i.y}`);if(m&&g&&a&&p&&m===g&&a===p&&m!==a)return!0;let b=s,w=r.get(`${i.x},${i.y+1}`),$=r.get(`${i.x},${i.y+2}`),j=r.get(`${i.x},${i.y+3}`);if(b&&w&&$&&j&&b===w&&$===j&&b!==$)return!0}return!1}function qo(e){let{getN:n,getH:r,FALL_INTERVAL:d,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:f,RING_HIGHLIGHT_SEC:m,getState:g,setState:a,funcs:p,ui:b}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(w,$={}){let j=g();if(w==="start_game")return j.gameState!=="playing"?(p.startGame(),!0):!1;if(j.gameState!=="playing")return!1;switch(w){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:ft}=$;return typeof ft=="number"&&p.canPlaceAtRot(Math.floor(j.pieceY),ft)?(a({targetRot:ft,rotFloat:ft,rotVel:0}),j.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ft,y:Gt}=$;return p.shootMagic(ft,Gt)}case"select_magic":{let{element:ft}=$;return p.selectMagic(ft),!0}default:return console.warn("GameEngine: unknown command",w),!1}},update(w,$){let j=g();if(j.gameState!=="playing")return;let ft=$-j.startTime-j.totalPausedMs;a({elapsedMs:ft}),b.updateTimeHud();let Gt=j.killLevel+s()*w;if(a({killLevel:Gt}),b.updateRemainingHud(),Gt>=r()){p.endGame();return}if(j.isHighlighting){let F=($-j.highlightStartTime)/1e3,pt;j.isRingAnimation?pt=m:j.isMagicAnimation?pt=f:pt=c,F>=pt&&(j.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let ye=j.fallTimer+w;if(ye>=d&&(ye-=d,p.tryMoveDown()),a({fallTimer:ye}),p.updateGroundedState()){let F=j.lockTimer+w;a({lockTimer:F}),F>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(w,$){return p.canPlaceAtRot(w,$)},getRotation(){let w=g();return{targetRot:w.targetRot,rotFloat:w.rotFloat,rotVel:w.rotVel}},setRotation(w){a({targetRot:w,rotFloat:w,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var Ve=Math.PI*2;function zo(e){let{canvas:n,canvasCtx:r,getN:d,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:f,MAX_RADIUS_X:m,RADIUS_X_FACTOR:g,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:b,MAGIC_SHRINK_SEC:w,RING_HIGHLIGHT_SEC:$,LOCK_DELAY_SEC:j,getKillRate:ft,ELEMENT_COLORS:Gt,ELEMENT_TO_COLOR:ye,BLOCK_COLOR_FRONT:nt,BLOCK_COLOR_BACK:F,ACTIVE_COLOR_FRONT:pt,GHOST_COLOR_FILL:ee,GHOST_COLOR_STROKE:Pt,GHOST_STROKE_WIDTH:Yt,MAGIC_DIM_DOT_ALPHA:Rt,MAGIC_DIM_DOT_SCALE:wt,MAGIC_TARGET_DOT_SCALE:R,getState:Ct,getVisualSettings:Tt,funcs:yt}=e,l=r,ot=d(),Z=i(),ue={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},K=[],q=40;function it(G,P,B,I,_){let h=Math.max(3,Math.round(G)),st=180;for(let ct=0;ct<h;ct++)setTimeout(()=>{let Et=Math.random()>.5?"left":"right",Mt=15,C=Et==="left"?Mt+Math.random()*Math.max(10,P-Mt*2):B+Mt+Math.random()*Math.max(10,_-B-Mt*2),v=I-10;K.push({x:C,baseX:C,y:v,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:Mt,maxX:_-Mt})},ct*st)}function Qt(G,P,B){K=K.filter(I=>I.y>G+I.size&&I.y>-20);for(let I of K){I.y-=q*B,I.wobble+=I.wobbleSpeed*B;let _=I.baseX+Math.sin(I.wobble)*I.wobbleAmp;I.x=Math.max(I.minX,Math.min(I.maxX,_))}}function be(G){if(K.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let P of K)P.y<G+P.size||(l.beginPath(),l.arc(P.x,P.y,P.size,0,Math.PI*2),l.fill(),l.stroke())}}let Q={left:0,right:0,h:0,w:0};function J(G,P,B){let I=1-B/Z;return G+I*P}function tt(G){return G=G%ot,G<0?G+ot:G}function _t(G,P,B,I,_,h){let st=tt(h),ct=(_-st)/ot*Ve+a;return{x:G+Math.cos(ct)*B,y:P+Math.sin(ct)*I,ang:ct}}let Ht=.52,fe=1.02;function St(G,P,B,I,_,h){let st=tt(h),ct=(_-st)/ot*Ve+a;return{x:G+Math.cos(ct)*B,y:P+Math.sin(ct)*I,ang:ct}}function ne(G,P,B,I,_,h,st,ct=1){let Et=St(G,P,B,I,_-Ht,h),Mt=St(G,P,B,I,_+Ht,h),C={x:Et.x,y:Et.y-st*.5},v={x:Et.x,y:Et.y+st*.5},A={x:Mt.x,y:Mt.y-st*.5},zt={x:Mt.x,y:Mt.y+st*.5},y=(C.x+A.x+zt.x+v.x)*.25,Lt=(C.y+A.y+zt.y+v.y)*.25,V=fe*ct,Wt=ct,Vt=[C,A,zt,v].map(Te=>({x:y+(Te.x-y)*V,y:Lt+(Te.y-Lt)*Wt})),Ot=Math.abs((Mt.x-Et.x)*V),ge=Math.abs(st*Wt);return{corners:Vt,cx:y,cy:Lt,wApprox:Ot,hApprox:ge,ang:St(G,P,B,I,_,h).ang}}function N(G,P,B,I,_,h,st,ct,Et=1,Mt=null,C=1,v=null,A=0,zt=1,y=1){let Lt=ne(G,P,B,I,_,h,st,y),[V,Wt,Vt,Ot]=Lt.corners;if(l.save(),l.globalAlpha=Et,l.fillStyle=ct,l.beginPath(),l.moveTo(V.x,V.y),l.lineTo(Wt.x,Wt.y),l.lineTo(Vt.x,Vt.y),l.lineTo(Ot.x,Ot.y),l.closePath(),l.fill(),v&&A>0&&(l.strokeStyle=v,l.lineWidth=A,l.stroke()),Mt){let ge=Math.min(Lt.wApprox,Lt.hApprox)*.28*zt;l.globalAlpha=Et*C,l.fillStyle=Mt,l.beginPath(),l.arc(Lt.cx,Lt.cy,ge,0,Ve),l.fill()}l.restore(),l.globalAlpha=1}function se(G,P,B,I,_,h){let st=_t(G,P,B,I,_,h),ct=_t(G,P,B,I,_+1,h),Et=_t(G,P,B,I,_-1,h),Mt=Math.abs(ct.x-st.x),C=Math.abs(st.x-Et.x),v=(Mt+C)*.5*1.06;return Math.max(1,v)}function Ce(G,P,B,I,_,h){let st=(_-h)/ot*Ve+a;return{x:G+Math.cos(st)*B,y:P+Math.sin(st)*I,ang:st}}function oe(G,P,B,I,_,h,st,ct=1,Et=null,Mt=1,C=null,v=0,A=1){l.save(),l.translate(G,P);let zt=Math.atan2(I,B);if(l.rotate(zt),l.globalAlpha=ct,l.fillStyle=st,l.fillRect(-_/2,-h/2,_,h),C&&v>0&&(l.strokeStyle=C,l.lineWidth=v,l.strokeRect(-_/2,-h/2,_,h)),Et){let y=Math.min(_,h)*.28*A;l.globalAlpha=ct*Mt,l.fillStyle=Et,l.beginPath(),l.arc(0,0,y,0,Ve),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let G=Math.max(1,Math.min(2,window.devicePixelRatio||1)),P=Math.floor(n.clientWidth*G),B=Math.floor(n.clientHeight*G);(n.width!==P||n.height!==B)&&(n.width=P,n.height=B,l.setTransform(G,0,0,G,0,0))},render(G=.016,P=performance.now()){this.resize();let B=Ct();ot=d(),Z=i();let I=n.clientWidth,_=n.clientHeight;l.clearRect(0,0,I,_),l.fillStyle="#0b0f14",l.fillRect(0,0,I,_);let h=I*.5,st=(I-2*f)/2,ct=_-s-c,Et=6,Mt=ot*ct/(Et*Z),C,v,A,zt;zt=_-c,Mt<=Math.min(st,m)?(C=Mt,v=ct,A=s):(C=Math.min(st,m),v=C*Et*Z/ot,A=zt-v);let y=C*.28,{killLevel:Lt,rotFloat:V,grid:Wt,gameState:Vt}=B,Ot=Tt?Tt():{},ge=Ot.waterColor||"blue",Te=Ot.waterBubbles||!1,Mn=ue[ge]||ue.blue,bt=J(A,v,Lt),Ne=.7,en=Lt/Z,It={...Mn.top},Ut={...Mn.bottom};if(en>Ne){let x=(en-Ne)/(1-Ne);It.r=Math.round(It.r+(255-It.r)*x*.5),It.g=Math.round(It.g+(150-It.g)*x*.5),It.b=Math.round(It.b+(150-It.b)*x*.5),Ut.r=Math.round(Ut.r+(180-Ut.r)*x),Ut.g=Math.round(Ut.g*(1-x*.6)),Ut.b=Math.round(Ut.b*(1-x*.6))}let Ge=h-C-8,le=h+C+8,O=A,Kt=zt+5,kt=l.createLinearGradient(0,bt,0,_);kt.addColorStop(0,`rgba(${It.r},${It.g},${It.b},0.5)`),kt.addColorStop(1,`rgba(${Ut.r},${Ut.g},${Ut.b},0.7)`),l.fillStyle=kt;let me=Math.round((It.r+Ut.r)/2),xn=Math.round((It.g+Ut.g)/2),Ke=Math.round((It.b+Ut.b)/2),fn=C+8,gn=y+4;l.fillRect(0,bt,Ge,_-bt),l.fillRect(le,bt,I-le,_-bt),l.beginPath();let Ue=Math.max(bt,Kt);l.moveTo(Ge,Ue),bt<=Kt+gn?l.ellipse(h,Kt,fn,gn,0,Math.PI,0,!1):l.lineTo(le,Ue),l.lineTo(le,_),l.lineTo(Ge,_),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(Ge,O),l.lineTo(Ge,Kt),l.stroke(),l.beginPath(),l.moveTo(le,O),l.lineTo(le,Kt),l.stroke(),l.beginPath(),l.ellipse(h,Kt,C+8,y+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(h,Kt,C+8,y+4,0,0,Ve),l.fill(),Lt>.5&&(l.strokeStyle=`rgba(${Math.min(255,me+60)},${Math.min(255,xn+40)},${Math.min(255,Ke+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,bt),l.lineTo(Ge,bt),l.moveTo(le,bt),l.lineTo(I,bt),l.stroke()),Q={left:Ge,right:le,h:_,w:I},(K.length>0||Te)&&(Qt(bt,_,G),be(bt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let lt=Ve*C,de=10,Cn=lt/de*.7,Yn=lt/de*.3;l.setLineDash([Cn,Yn]);let mn=lt/ot;l.lineDashOffset=tt(V)*mn;for(let x=0;x<=Z;x++){let D=J(A,v,x);l.beginPath(),l.ellipse(h,D,C,y,0,0,Ve),l.stroke()}l.setLineDash([]);let Zt=[],S=[];for(let x=0;x<Z;x++){let D=J(A,v,x+.5);for(let U=0;U<ot;U++){let X=Wt[x][U];if(!X)continue;let z=_t(h,D,C,y,U,V),Y=Math.sin(z.ang),k={y:x,s:U,yScr:D,p:z,depth:Y,color:X};Y<-.1?Zt.push(k):S.push(k)}}let T=yt.getMagicTargetColor(),{isHighlighting:M,highlightedCells:gt,highlightStartTime:rt,isMagicAnimation:Bt}=B,qt=null,Me=1,ie=1,Pe=!1;if(M&&gt.length>0){qt=new Set(gt.map(D=>`${D.y},${D.s}`));let x=(performance.now()-rt)/1e3;if(Bt){let D=Math.min(1,x/w);Me=1-D*.85,ie=1-D*.9,Pe=!0}else{let D=Math.min(1,x/p),U=1-b;if(D>U){let X=(D-U)/b;Me=1-X*.85,ie=1-X*.9,Pe=!0}}}Zt.sort((x,D)=>x.depth-D.depth);for(let x of Zt){let D=v/Z*.9,U=Gt[x.color]||null,X=.35,z=1,Y=`${x.y},${x.s}`;qt&&qt.has(Y)&&(X*=ie,z=Me),N(h,x.yScr,C,y,x.s,V,D,F,X,U,.5,null,0,1,z)}let{isRingAnimation:qe}=B;if(M&&gt.length>0&&!Bt){let x=(performance.now()-rt)/1e3,U=Math.min(1,x/(qe?$:p)),X=1-b,z=U>X,Y=z?(U-X)/b:0,k=qe?Math.floor(U*X*ot*2)%ot:-1,L=4+U/X*10,W=Math.sin(x*L*Ve),dt=z?1:.3+W*.3,ht=z?1-Y*.8:1,xt=z?1-Y:1;for(let vt of gt){let $t=J(A,v,vt.y+.5),ae=St(h,$t,C,y,vt.s,V);if(Math.sin(ae.ang)>=-.1)continue;let En=v/Z*.9,he,He,Be;if(qe){let nn=(vt.s-k+ot)%ot,Ft=nn<3?1-nn/3:0;he=(z?xt:.2+Ft*.5)*.5,He=`rgba(255, 159, 67, ${he})`,Be=z?ht:1+Ft*.15}else he=dt*xt,He=vt.isLine?`rgba(255, 255, 255, ${he*.5})`:`rgba(255, 220, 100, ${he*.4})`,Be=z?ht:1.1;N(h,$t,C,y,vt.s,V,En,He,1,null,1,null,0,1,Be)}}S.sort((x,D)=>x.depth-D.depth);for(let x of S){let D=v/Z*.9,U=Gt[x.color]||null,X=1,z=1,Y=1,k=1,L=`${x.y},${x.s}`,W=qt&&qt.has(L);W&&(X=ie,z=Me),T!==null&&!W&&(x.color!==T?(Y=Rt,k=wt):k=R),N(h,x.yScr,C,y,x.s,V,D,nt,X,U,Y,null,0,k,z)}if(M&&gt.length>0&&!Bt){let x=(performance.now()-rt)/1e3,U=Math.min(1,x/(qe?$:p)),X=1-b,z=U>X,Y=z?(U-X)/b:0,k=qe?Math.floor(U*X*ot*2)%ot:-1,L=4+U/X*10,W=Math.sin(x*L*Ve),dt=z?1:.5+W*.5,ht=z?1-Y*.8:1,xt=z?1-Y:1;for(let vt of gt){let $t=J(A,v,vt.y+.5),ae=St(h,$t,C,y,vt.s,V);if(Math.sin(ae.ang)<-.1)continue;let En=v/Z*.9,he,He,Be;if(qe){let nn=(vt.s-k+ot)%ot,Ft=nn<4?1-nn/4:0;he=z?xt:.3+Ft*.7,He=`rgba(255, 159, 67, ${he})`,Be=z?ht:1+Ft*.2}else he=dt*xt,He=vt.isLine?`rgba(255, 255, 255, ${he*.7})`:`rgba(255, 220, 100, ${he*.6})`,Be=z?ht:1.15;N(h,$t,C,y,vt.s,V,En,He,1,null,1,null,0,1,Be)}}let xe=B.spellState||B,{transmuteState:ce,transmuteSourceBlock:pe,transmuteTargetColor:ze,transmuteAreaCells:je,transmuteBlocksToChange:Xe}=xe;if(ce==="selecting_source"){let x=v/Z*.9,D=.35+Math.sin(P/150)*.15;for(let U of S){let X=J(A,v,U.y+.5);N(h,X,C,y,U.s,V,x,`rgba(0, 40, 20, ${D})`,1,null,1,null,0,1,1)}}if(ce==="selecting_target"&&Xe&&Xe.length>0){let x=v/Z*.9,D=.4+Math.sin(P/120)*.25,U=.6+Math.sin(P/120)*.4;for(let X of Xe){if(X.y<0||X.y>=Z)continue;let z=J(A,v,X.y+.5),Y=St(h,z,C,y,X.s,V);Math.sin(Y.ang)<-.1||(N(h,z,C,y,X.s,V,x,`rgba(0, 50, 30, ${D})`,1,null,1,null,0,1,1),N(h,z,C,y,X.s,V,x,"transparent",1,null,1,`rgba(100, 255, 150, ${U})`,3,1,1.02))}}if(ce==="animating"&&yt.getTransmuteAnimState){let x=yt.getTransmuteAnimState(P);if(x){let D=v/Z*.9,{phase:U,progress:X,areaFlash:z}=x;if(z>0&&je)for(let Y of je){if(Y.y<0||Y.y>=Z)continue;let k=J(A,v,Y.y+.5),L=St(h,k,C,y,Y.s,V);Math.sin(L.ang)<-.1||N(h,k,C,y,Y.s,V,D,`rgba(150, 255, 200, ${z*.4})`,1,null,1,null,0,1,1)}if(Xe&&Xe.length>0){let Y=pe?pe.color:1,k=ze||1;for(let L of Xe){if(L.y<0||L.y>=Z)continue;let W=J(A,v,L.y+.5),dt=St(h,W,C,y,L.s,V);if(Math.sin(dt.ang)<-.1)continue;let xt=1,vt=Gt[Y],$t=0;if(U==="shrink"?(xt=1-X*.95,vt=Gt[Y],$t=.5+X*.3):U==="grow"&&(xt=X,vt=Gt[k],$t=.8-X*.5),$t>0&&N(h,W,C,y,L.s,V,D,`rgba(200, 255, 220, ${$t})`,1,null,1,null,0,1,1),xt>.05){let ae=ne(h,W,C,y,L.s,V,D,1),Le=Math.min(ae.wApprox,ae.hApprox)*.28*xt;l.save(),l.globalAlpha=1,l.fillStyle=vt,l.beginPath(),l.arc(ae.cx,ae.cy,Le,0,Ve),l.fill(),l.restore()}}}}}let{lightningState:Qe,lightningSourceBlock:rn,lightningAreaCells:an,lightningBlocksToHit:Jt}=xe;if(Qe==="selecting_source"){let x=v/Z*.9,D=.35+Math.sin(P/150)*.15;for(let U of S){let X=J(A,v,U.y+.5);N(h,X,C,y,U.s,V,x,`rgba(20, 20, 60, ${D})`,1,null,1,null,0,1,1)}}if(Qe==="animating"&&yt.getLightningAnimState){let x=yt.getLightningAnimState(P);if(x&&Jt&&Jt.length>0){let D=v/Z*.9,{phase:U,flashProgress:X,currentTarget:z,jumpProgress:Y,struckTargets:k}=x;if(U==="flash"&&X>0&&an)for(let L of an){if(L.y<0||L.y>=Z)continue;let W=J(A,v,L.y+.5),dt=St(h,W,C,y,L.s,V);Math.sin(dt.ang)<-.1||N(h,W,C,y,L.s,V,D,`rgba(100, 150, 255, ${X*.5})`,1,null,1,null,0,1,1)}if(k&&k.length>0)for(let L of k){let W=Jt[L];if(!W||W.y<0||W.y>=Z)continue;let dt=J(A,v,W.y+.5),ht=St(h,dt,C,y,W.s,V);if(Math.sin(ht.ang)<-.1)continue;let vt=(k.length-1-k.indexOf(L))*.1,$t=Math.max(0,.8-vt);N(h,dt,C,y,W.s,V,D,`rgba(255, 255, 255, ${$t})`,1,null,1,`rgba(150, 200, 255, ${$t})`,2,1,1.05)}if(U==="chain"&&z>=0&&z<Jt.length){let L=Jt[z];if(L&&L.y>=0&&L.y<Z){let W=J(A,v,L.y+.5),dt=St(h,W,C,y,L.s,V);if(Math.sin(dt.ang)>=-.1){let xt=1-Y;N(h,W,C,y,L.s,V,D,`rgba(200, 220, 255, ${xt*.9})`,1,null,1,`rgba(100, 180, 255, ${xt})`,3,1,1.1-Y*.05)}}if(z>0){let W=Jt[z-1],dt=Jt[z];if(W&&dt){let ht=J(A,v,W.y+.5),xt=J(A,v,dt.y+.5),vt=ne(h,ht,C,y,W.s,V,D,1),$t=ne(h,xt,C,y,dt.s,V,D,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-Y*.5})`,l.lineWidth=2+(1-Y)*2,l.lineCap="round",l.beginPath();let ae=vt.cx,Le=vt.cy,En=$t.cx,he=$t.cy;l.moveTo(ae,Le);let He=4;for(let Be=1;Be<=He;Be++){let nn=Be/He,Ft=ae+(En-ae)*nn,ms=Le+(he-Le)*nn,Wn=Be<He?(Math.random()-.5)*8:0;l.lineTo(Ft+Wn,ms+Wn)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-Y)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:pn,fireSourceBlock:ke,fireLineCells:Oe,fireTargets:hn}=xe;if(pn==="selecting_source"){let x=v/Z*.9,D=.3+Math.sin(P/140)*.2;for(let U of S){let X=J(A,v,U.y+.5);N(h,X,C,y,U.s,V,x,`rgba(70, 25, 10, ${D})`,1,null,1,null,0,1,1)}}if(pn==="animating"&&yt.getFireAnimState){let x=yt.getFireAnimState(P);if(x&&Oe&&Oe.length>0){let D=v/Z*.9,{progress:U,flashProgress:X}=x,z=Math.sin(U*Math.PI);if(X>0)for(let Y of Oe){if(Y.y<0||Y.y>=Z)continue;let k=J(A,v,Y.y+.5),L=St(h,k,C,y,Y.s,V);Math.sin(L.ang)<-.1||N(h,k,C,y,Y.s,V,D,`rgba(255, 120, 50, ${X*.45})`,1,null,1,`rgba(255, 200, 140, ${X*.5})`,2,1,1.03)}if(ke){let Y=new Map;for(let L of Oe){if(L.y<0||L.y>=Z)continue;let W=J(A,v,L.y+.5),dt=St(h,W,C,y,L.s,V);if(Math.sin(dt.ang)<-.1)continue;let xt=ne(h,W,C,y,L.s,V,D,1),vt=L.s-ke.s;vt>ot/2&&(vt-=ot),vt<-ot/2&&(vt+=ot);let $t=L.y;Y.has($t)||Y.set($t,[]),Y.get($t).push({x:xt.cx,y:xt.cy,offset:vt})}let k=Array.from(Y.keys()).sort((L,W)=>W-L);if(k.length>0){let L=.35+.3*Math.sin(P/60)+z*.2;l.save(),l.lineCap="round";for(let W of k){let dt=Y.get(W)||[];if(dt.sort((ht,xt)=>ht.offset-xt.offset),dt.length!==0){l.beginPath(),l.moveTo(dt[0].x,dt[0].y);for(let ht=1;ht<dt.length;ht++)l.lineTo(dt[ht].x,dt[ht].y);l.strokeStyle=`rgba(255, 140, 60, ${L})`,l.lineWidth=Math.max(2,D*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${L*.35})`,l.lineWidth=Math.max(6,D*.35),l.stroke()}}l.restore()}}if(hn&&hn.length>0){let Y=.2+z*.6;for(let k of hn){if(k.y<0||k.y>=Z)continue;let L=J(A,v,k.y+.5),W=St(h,L,C,y,k.s,V);Math.sin(W.ang)<-.1||N(h,L,C,y,k.s,V,D,`rgba(255, 160, 70, ${Y})`,1,null,1,`rgba(255, 230, 180, ${z*.6})`,2,1,1.05)}}}}let{activePiece:re,pieceY:Sn,isGrounded:_e,lockTimer:De}=B;if(re){let x=yt.snappedRot(),D=x,U=yt.computeGhostY(),X=v/Z*.9;if(U!==null){let k=[];for(let L=0;L<re.cells.length;L++){let W=re.cells[L],dt=re.colors[L],ht=U+W.y,xt=yt.normSector(x+W.x);if(ht<0||ht>=Z)continue;let vt=J(A,v,ht+.5),$t=St(h,vt,C,y,xt,D);k.push({cy:ht,cs:xt,yScr:vt,depth:Math.sin($t.ang),color:dt})}k.sort((L,W)=>L.depth-W.depth);for(let L of k){let W=Gt[L.color]||null;N(h,L.yScr,C,y,L.cs,D,X,ee,1,W,.5,Pt,Yt,1,1)}}let z=pt;if(_e&&De>0){let k=Math.min(1,De/j),L=255,W=Math.round(170+85*k),dt=Math.round(180+75*k),ht=.75+(1-.75)*k;z=`rgba(${L},${W},${dt},${ht})`}let Y=[];for(let k=0;k<re.cells.length;k++){let L=re.cells[k],W=re.colors[k],dt=yt.normSector(x+L.x),ht=Sn+L.y;if(ht<0||ht>=Z)continue;let xt=J(A,v,ht+.5),vt=St(h,xt,C,y,dt,D);Y.push({cs:dt,yScr:xt,depth:Math.sin(vt.ang),color:W})}Y.sort((k,L)=>k.depth-L.depth);for(let k of Y){let L=Gt[k.color]||null;N(h,k.yScr,C,y,k.cs,D,X,z,1,L,1,null,0,1,1)}}},drawNextPreview(G,P){if(!G)return;let B=G.getContext("2d"),I=G.width,_=G.height;if(B.clearRect(0,0,I,_),!P)return;let h=1/0,st=-1/0,ct=1/0,Et=-1/0;for(let y of P.cells)h=Math.min(h,y.x),st=Math.max(st,y.x),ct=Math.min(ct,y.y),Et=Math.max(Et,y.y);let Mt=st-h+1,C=Et-ct+1,v=Math.min(I/(Mt+.5),_/(C+.5)),A=(I-Mt*v)/2,zt=(_-C*v)/2;B.fillStyle=nt;for(let y=0;y<P.cells.length;y++){let Lt=P.cells[y],V=A+(Lt.x-h)*v,Wt=zt+(C-1-(Lt.y-ct))*v;B.fillRect(V+1,Wt+1,v-2,v-2);let Vt=P.colors[y],Ot=Gt[Vt];if(Ot){let ge=(v-2)*.32;B.fillStyle=Ot,B.beginPath(),B.arc(V+v/2,Wt+v/2,ge,0,Ve),B.fill(),B.fillStyle=nt}}},spawnBonusBubbles(G){let{left:P,right:B,h:I,w:_}=Q;_>0&&it(G,P,B,I,_)}}}(()=>{let e=Lo(),n=e.canvas,r=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,i=30,s=24,c=120,f={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let o=f[t]||f["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let a=Math.PI/2,p=70,b=120,w=30,$=320,j=.42,ft="rgb(235,240,250)",Gt="rgb(55,62,75)",ye="rgba(255,170,180,0.75)",nt="rgba(110,255,150,0.15)",F="rgba(110,255,150,0.85)",pt=2,ee={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Pt={1:"fire",2:"water",3:"lightning",4:"earth"},Yt={fire:1,water:2,lightning:3,earth:4},Rt=1,wt=.58,R=!0,Ct=12,Tt=25,yt=1,l=2,ot=3,Z=1,ue=5,K=7,q=10,it=3,Qt=50,be=2,Q=.3,J=.5,tt=1,_t=.3,Ht=.5,fe=1.3,St=10,ne=1e3,N=[1,1.25,1.5,1.75,2],se=10,Ce=20,oe=5,G=[1,1.3,1.6,2,2.4,2.8],P=[1,1.1,1.2,1.3,1.4,1.5],B=[1,1.5,2,2.5,3,3.5],I=[1,1.3,1.6,2,2.4,2.8],_=_o(),h=_.loadGameSettings();h.hapticsEnabled===void 0&&(h.hapticsEnabled=!0);let st=h.invertSwipe?-1:1,Et=!1,Mt=-1,C=Po({enabled:h.hapticsEnabled}),v=Array.from({length:s},()=>new Uint8Array(i));function A(){v=Array.from({length:s},()=>new Uint8Array(i))}let zt=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,Lt=s+3,V=0,Wt=0,Vt=!1,Ot=0,ge=0,Te=0,Mn=3,bt=0,Ne=0,en=0,It=$o({canvas:n,rotDir:st}),Ut="0.17.2",Ge=!0,le="blue",O=bo();O.preload();let Kt=Fo(),kt="intro",me=0,xn=0,Ke=0,fn=0,gn=0,Ue=null,lt=Kt.stats,de=0,Cn=e.overlay,Yn=e.gameContainer,mn=Ro({elementColors:ee}),Zt=mn.showBonus.bind(mn),S=mn.getElementIcon.bind(mn),T=wo(),M=e.overlayTitle,gt=e.overlayStats,rt=e.startBtn,Bt=e.hud,qt=e.scoreHud,Me=e.timeHud,ie=e.remainingHud,Pe=e.nextCanvas,qe=Pe.getContext("2d"),xe=e.pauseBtn,ce=e.pauseOverlay,pe=e.resumeBtn,ze=e.restartBtn,je=e.exitToMenuBtn,Xe=e.pauseSettingsBtn,Qe=e.pauseSoundBtn,rn=e.pauseMusicBtn,an=e.pauseBestScore,Jt=e.pauseBestTime,pn=e.pauseBestMode,ke=e.pauseCurrentScore,Oe=e.pauseCurrentTime,hn=e.pauseCurrentMode,re=e.confirmDialog,Sn=e.confirmText,_e=e.confirmCancel,De=e.confirmOk,x=e.settingsOverlay,D=e.settingsClose,U=e.fullscreenBtn,X=e.rotateBtn,z=e.startPanel,Y=e.gameoverPanel,k=e.goScore,L=e.goTime,W=e.goRing,dt=e.goMatches,ht=e.goBonuses,xt=e.goNewRecord,vt=e.goRestartBtn,$t=e.goExitBtn,ae=e.bestScore,Le=e.bestTimeVal,En=e.startVersion,he=e.modeBtns,He=e.recordsBtn,Be=e.startSettingsBtn,nn=e.helpBtn;Io({helpBtn:nn});let Ft="25_20";function ms(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function Wn(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,E=f[u];if(!E)return;let H=o.querySelector(".mode-tag.time-tag");if(!H)return;let et=ms(E.survivalTime);et&&(H.textContent=et)})}Wn();let at=ko({buttons:e.magicBtns,onActivate:()=>O.play("spells"),onChange:(t,o)=>{vs()}}),In=e.magicBtns,ec=at.charges,jo=t=>$e()?at.select(t):!1,Pn=()=>at.updateButtons(),Hs=e.magicRow,Xt=e.magicActiveIndicator,$s=e.magicActiveIcon,Fs=e.magicActiveCost,Qo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ps={fire:"fire",water:"ice",lightning:"air",earth:"earth"},Zo=["ice","earth","air","fire"];de=_.loadHighTowerRings();function kn(t){return typeof ve?.getUnlockRings=="function"?ve.getUnlockRings(t):0}function Vn(t){let o=kn(t);return o===0||de>=o}let Ns=["fire","water","lightning","earth"],Tn=null,Kn=!1,Jo=500,ti=30,ei=220,_n=null,hs=null,Gs={fire:!1,water:!1,lightning:!1,earth:!1};function Us(){if(!Xt)return;let t=Xt.getBoundingClientRect();t.width>0&&t.height>0&&(hs=t)}function ni(){if(!Xt)return null;let t=Xt.getBoundingClientRect();return t.width>0&&t.height>0?Xt:hs?{getBoundingClientRect:()=>hs}:null}function On(t=at.active){if(!Xt||!$s)return;t?(Tn=t,Kn=!1):Kn||(Tn=null);let o=Tn;if(!o||!$e()||(at.charges[o]??0)<=0){Us(),Xt.classList.add("hidden"),Xt.classList.remove("active","ult-ready",...Ns),Xt.style.setProperty("--progress","0%"),_n&&clearTimeout(_n),_n=setTimeout(()=>{Xt.classList.add("gone")},ei);return}_n&&(clearTimeout(_n),_n=null),Xt.classList.remove("gone"),Xt.classList.contains("hidden")?requestAnimationFrame(()=>Xt.classList.remove("hidden")):Xt.classList.remove("hidden"),$s.textContent=S(o);let E=ps[o];E&&ve.selectSpell(E);let H=E?Hn(E):0,et=at.charges[o]??0,mt=!!E&&jn()&&Vn(E),te=!!E&&jn()&&!mt,Re=mt&&H>0?Math.min(et/H,1):0,Ze=mt&&H>0,Je=Ze&&et>=H;Fs&&(Fs.textContent=Ze?`-${H}`:te?"\u{1F512}":""),Xt.classList.toggle("no-cost",!Ze&&!te),Xt.classList.toggle("locked",te),Xt.classList.toggle("ult-ready",Je),Xt.style.setProperty("--progress",`${Math.round(Re*100)}%`),Xt.classList.remove("hidden",...Ns),Xt.classList.add("active",o),Us()}function si(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Jo))}function qn(){for(let[t,o]of Object.entries(In)){if(!o)continue;let u=ps[t],E=Hn(u),H=jn()&&$e()&&u,et=typeof Vn=="function"?Vn(u):!0,mt=H&&et&&E>0&&(at.charges[t]??0)>=E;o.classList.toggle("ult-ready",mt),mt&&!Gs[t]&&(si(o),kt==="playing"&&O.play("readysuper")),Gs[t]=mt}}function $e(t=Ft){return t==="30_24"?!0:Et}function vs(){On(at.active),qn()}function nc(t){Et=t,Ft==="25_20"&&(Et?at.reset():(at.deactivate(),Object.keys(at.charges).forEach(o=>{at.charges[o]=0})),Pn()),zn(),vs()}function zn(){Hs&&(Hs.style.display=$e()?"":"none",On(at.active),qn())}function sc(t){let o=Ln(t),u=Hn(t);return!o||u<=0?!1:at.charges[o]>=u}function oc(t){let o=Ln(t),u=Hn(t);return!o||u<=0||at.charges[o]<u?!1:(at.charges[o]-=u,at.updateButtons(),ve.pulse(),!0)}let Dn=e.spellWave;function oi(){Dn&&(Dn.classList.remove("active"),Dn.offsetWidth,Dn.classList.add("active"),setTimeout(()=>Dn.classList.remove("active"),1200))}let ln=null,ve=Oo({button:Xt,onReady:()=>{O.play("readysuper")}}),ii=()=>ve.getEffect("earth"),ci=()=>ve.getEffect("air"),ri=()=>ve.getEffect("fire"),Hn=t=>typeof ve?.getCost=="function"?ve.getCost(t):0,Ln=t=>Qo[t]??null;ln=Ho({canvas:n,dom:e,getGrid:()=>v,getN:()=>i,getH:()=>s,getRotFloat:()=>bt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:w,MAX_RADIUS_X:$,SCORE_MAGIC_DESTROY:oe},helpers:{normSector:es,levelYToScreenY:Zn,sectorCenterXY:Jn},Spell:ve,Magic:at,SoundModule:O,State:Kt,isGamePlaying:()=>kt==="playing",addPendingKzDrop:t=>{Te+=t},getKillRate:g,triggerSpellWave:oi,spawnSpellBubbles:t=>{let o=Ln(ve.currentSpell)??"water";T.spawnSpellBubbles(ve.button,o,t)},spawnBonusBubbles:t=>{wn.spawnBonusBubbles(t)},getTransmuteEffect:ii,getLightningEffect:ci,getFireEffect:ri,continueMatchProcessing:ts,updateScoreHud:Gn,showBonus:Zt,getSpellCost:Hn,getSpellElement:Ln,onUltimateApplied:t=>{let o=Ln(t)??Ln(ve.currentSpell)??"water";if(typeof T?.spawnSpellBubbles=="function"){let u=ni();u&&T.spawnSpellBubbles(u,o,ti)}Kn=!1,Tn=null,On(null),qn()},isSpellBlocked:ai,setScore:t=>{me=t},setCascadeLevel:t=>{cn=t}});function jn(){return Ft==="30_24"}function Qn(){On(at.active),qn()}let dn=[],$n=0,sn=!1,vn=!1,Bn=!1,Ye=0,on=0,cn=0,Rn=[];function ai(){return sn||vn||Bn}function Zn(t,o,u){let E=1-u/s;return t+E*o}function Jn(t,o,u,E,H,et){let mt=(H-et)/i*d+a;return{x:t+Math.cos(mt)*u,y:o+Math.sin(mt)*E,ang:mt}}function Xs(t,o){let u=n.clientWidth,E=n.clientHeight,H=u*.5,et=(u-2*w)/2,mt=E-p-b,te=6,Re=i*mt/(te*s),Ze=E-b,Je,we,Ae;Re<=Math.min(et,$)?(Je=Re,we=mt,Ae=p):(Je=Math.min(et,$),we=Je*te*s/i,Ae=Ze-we);let jt=Je*.28,At=Zn(Ae,we,t+.5),ut=Jn(H,At,Je,jt,o,bt),Nt=n.getBoundingClientRect();return{x:Nt.left+ut.x,y:Nt.top+ut.y}}function li(t,o){if(!$e()||!at.canUse()||sn)return!1;let u=Yt[at.active],E=n.clientWidth,H=n.clientHeight,et=E*.5,mt=(E-2*w)/2,te=H-p-b,Re=6,Ze=i*te/(Re*s),Je=H-b,we,Ae,jt;Ze<=Math.min(mt,$)?(we=Ze,Ae=te,jt=p):(we=Math.min(mt,$),Ae=we*Re*s/i,jt=Je-Ae);let At=we*.28,ut=null,Nt=1/0;for(let Se=0;Se<s;Se++){let Ie=Zn(jt,Ae,Se+.5);for(let Ee=0;Ee<i;Ee++){let Fe=v[Se][Ee];if(!Fe||Fe!==u)continue;let We=Jn(et,Ie,we,At,Ee,bt);if(Math.sin(We.ang)<-.1)continue;let ds=t-We.x,ho=o-We.y,vo=Math.hypot(ds,ho),yo=Ae/s*.9,Fi=yo*1.2;Math.abs(ds)<Fi/2&&Math.abs(ho)<yo/2&&vo<Nt&&(Nt=vo,ut={y:Se,s:Ee})}}if(ut){let Se=Zn(jt,Ae,ut.y+.5),Ie=Jn(et,Se,we,At,ut.s,bt),Ee=n.getBoundingClientRect(),Fe=Ee.left+Ie.x,We=Ee.top+Ie.y,po=In[at.active];return T.spawnMagicShot(at.active,po,Fe,We,()=>{let ds=v[ut.y][ut.s];dn=[{y:ut.y,s:ut.s,color:ds,isLine:!1,isMagic:!0}],$n=performance.now(),sn=!0,vn=!0,Ye=0,on=oe,Zt(`+${oe}`,"score")}),cn=0,at.useCharge(),lt.magicUsed++,!0}return!1}let ic=100;function cc(t,o){return Os(t,o,s,i)}function di(){return Uo(v,s,i)}let ui=Xo;function fi(t){let o=t.map(E=>({...E,color:v[E.y][E.s]}));for(let E of t)v[E.y][E.s]=0;let u=s;for(let E of t){let H=E.y;for(let et=1;et<=E.y;et++){let mt=E.y-et;if(v[mt][E.s]){H=et-1;break}}u=Math.min(u,H)}for(let E of o)v[E.y-u][E.s]=E.color;return u>0}function gi(){let t=!0;for(;t;){t=!1;let o=di();for(let u of o)ui(u)||fi(u)&&(t=!0)}}function mi(){ts()}let Fn=No;function Ys(t,o){let u=new Map,E=0,H=0,et=0,mt={},te=t.length+o.length;for(let At of t){let ut=Pt[At.color],Nt=0,Se=0;if(At.length>=5?(Nt=ot,Se=q,lt.lines5++):At.length===4?(Nt=l,Se=K,lt.lines4++):At.length===3&&(Nt=yt,Se=ue,lt.lines3++),$e()&&ut&&Nt>0){at.addCharges(ut,Nt),mt[ut]=(mt[ut]||0)+Nt;let Ie=At.cells[Math.floor(At.cells.length/2)],Ee=Xs(Ie.y,Ie.s),Fe=In[ut];for(let We=0;We<Nt;We++)setTimeout(()=>{T.spawnMagicOrb(ut,Ee.x,Ee.y,Fe)},We*100)}E+=Se*g(),et+=Se,H+=At.length*se;for(let Ie of At.cells){let Ee=`${Ie.y},${Ie.s}`;u.has(Ee)||u.set(Ee,{y:Ie.y,s:Ie.s,color:At.color,isLine:!0})}}for(let At of o){if(lt.pairs++,E+=it*g(),et+=it,H+=Ce,$e()){let ut=[...new Set(At.cells.map(Nt=>v[Nt.y][Nt.s]).filter(Boolean))];if(ut.length>0){let Nt=At.cells[Math.floor(At.cells.length/2)],Se=Xs(Nt.y,Nt.s);ut.forEach((Ie,Ee)=>{let Fe=Pt[Ie];if(!Fe)return;at.addCharges(Fe,Z),mt[Fe]=(mt[Fe]||0)+Z;let We=In[Fe];We&&setTimeout(()=>{T.spawnMagicOrb(Fe,Se.x,Se.y,We)},Ee*100)})}}for(let ut of At.cells){let Nt=`${ut.y},${ut.s}`;u.has(Nt)||u.set(Nt,{y:ut.y,s:ut.s,color:v[ut.y][ut.s],isLine:!1})}}let Re=Fn(G,te-1),Ze=Fn(P,te-1),Je=Fn(B,cn),we=Fn(I,cn),Ae=Math.round(H*Re*Je);et=Math.round(et*Ze*we),E=Math.round(E*Ze*we);let jt=0;te>1&&(lt.combos++,lt.maxCombo=Math.max(lt.maxCombo,te),setTimeout(()=>Zt(`COMBO \xD7${te}`,"combo"),jt),jt+=180,O.play("combo2")),cn>0&&(lt.cascades++,lt.maxCascade=Math.max(lt.maxCascade,cn),setTimeout(()=>Zt(`CASCADE \xD7${cn}`,"cascade"),jt),jt+=180,O.play("cascade")),(t.length>0||o.length>0)&&O.play("combo");for(let At of t){let ut=At.length,Nt=ut*se;setTimeout(()=>Zt(`Line-${ut} +${Nt}`,"line",At.color),jt),jt+=100}for(let At of o){let ut=At.cells.length>0?v[At.cells[0].y][At.cells[0].s]:null;setTimeout(()=>Zt(`Pair +${Ce}`,"pair",ut),jt),jt+=100}Ae>0&&(setTimeout(()=>Zt(`+${Ae}`,"score"),jt),jt+=120),et>0&&(setTimeout(()=>Zt(`+${et}s`,"time"),jt),jt+=120);for(let[At,ut]of Object.entries(mt))ut>0&&(setTimeout(()=>Zt(`+${ut}${S(At)}`,"charge"),jt),jt+=120);dn=Array.from(u.values()),$n=performance.now(),sn=!0,vn=!1,Ye=E,on=Ae,Pn()}function pi(){for(let t of dn)v[t.y][t.s]=0;if(dn.length>0&&O.playRandom("disappear"),Ye>0){Te+=Ye;let t=Ye/g();wn.spawnBonusBubbles(t)}Kt.addScore(on),me+=on,Gn(),dn=[],sn=!1,vn=!1,Ye=0,on=0,cn++,ts()}function ts(){gi();let{lineMatches:t,pairMatches:o}=Ti();if(t.length>0||o.length>0)Ys(t,o);else{let u=js();u.length>0?Mi(u):!y&&kt==="playing"&&zs()}}function rc(t,o){Ys(t,o)}function es(t){return An(t,i)}function ns(){return es(Math.round(bt))}function Ws(t,o){return Ds(y,t,o,v,s,i)}function ss(t){return Ws(t,ns())}let os=Go;function Vs(){R&&(Ct!==0&&Ot>=Ct||(Wt=0,Ot+=1))}function hi(){if(!y)return;let t=y.cells,o=y.colors,u={cells:t,colors:o};if(Mt>=0||(u=os(u.cells,u.colors),u=os(u.cells,u.colors)),u=os(u.cells,u.colors),y.cells=u.cells,y.colors=u.colors,!ss(Math.floor(Lt))){y.cells=t,y.colors=o;return}O.play("turn"),Vt&&Vs()}function vi(){return Yo(y,Lt,ns(),v,s,i)}function yi(){if(!y)return!1;let t=Math.floor(Lt)-1,o=!ss(t);return o&&!Vt?(Vt=!0,Wt=0,Ot=0):!o&&Vt&&(Vt=!1,Wt=0,Ot=0),o}let bn=gs;function Nn(){if(kt==="playing"){Cn.classList.add("hidden"),xe.classList.remove("hidden");return}if(Cn.classList.remove("hidden"),xe.classList.add("hidden"),kt==="intro"){z.classList.remove("hidden"),Y.classList.add("hidden");let t=_.loadHighscore(Ft);t.score>0?(ae.textContent=t.score.toLocaleString(),Le.textContent=bn(t.time)):(ae.textContent="0",Le.textContent="0:00"),Rs(),En.textContent=`v${Ut}`,rt.classList.remove("idlePulse"),rt.offsetWidth,rt.classList.add("idlePulse")}else{z.classList.add("hidden"),Y.classList.remove("hidden"),k.textContent=me.toLocaleString(),L.textContent=bn(Ke);let t=_.loadHighscore(Ft);me>0&&me>=t.score?xt.classList.remove("hidden"):xt.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${lt.rings}</span>
          <span class="count ring-max">${lt.maxRing>0?"max \xD7"+lt.maxRing:""}</span>
        </div>
      `;W.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${lt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${lt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${lt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${lt.pairs}</span>
        </div>
      `;dt.innerHTML=u;let E=$e()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${lt.magicUsed}</span>
        </div>
      `:"",H=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${lt.combos}</span>
          <span class="count max-combo">${lt.maxCombo>0?"max \xD7"+lt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${lt.cascades}</span>
          <span class="count max-cascade">${lt.maxCascade>0?"max \xD7"+lt.maxCascade:""}</span>
        </div>
        ${E}
      `;ht.innerHTML=H}}function Gn(){qt.textContent=`Score: ${me}`}function ys(){Me.textContent=`Time: ${bn(Ke)}`}function Ks(){let t=Math.max(0,(s-ge)/g()),o=Math.floor(t/60),u=Math.floor(t%60);ie.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?ie.classList.add("warning"):ie.classList.remove("warning")}function Si(){m(Ft),A(),ge=0,Te=0,bt=Ne=0,en=0,Kt.start(),lt=Kt.stats,me=0,xn=performance.now(),Ke=0,gn=0,fn=0,kt="playing",Ue=null,$e()?at.reset():(at.deactivate(),Object.keys(at.charges).forEach(t=>{at.charges[t]=0}),Pn()),ve.reset(),Qn(),dn=[],Rn=[],sn=!1,vn=!1,Bn=!1,Ye=0,on=0,cn=0,ln.reset(),Pn(),Gn(),ys(),Ks(),vs(),zs(),wn.drawNextPreview(Pe,Ue),Nn(),O.getSettings().musicEnabled&&O.startGameMusic()}function Ss(){Kt.gameOver(),kt="gameover",y=null,Vt=!1,Wt=0,Ot=0;let t=_.saveHighscore(me,Ke,Ft);O.stopMusic(),O.play("gameover"),ys(),Nn(),t&&me>0&&setTimeout(()=>{Zt("\u{1F3C6} NEW RECORD!","score")},500)}function Ei(t){for(let u=0;u<50;u++){let E=t.map(()=>1+(Math.random()*4|0));if(!bi(t,E))return E}return t.map((u,E)=>1+E%4)}let bi=Ko;function qs(t){let o=t.cells.map(E=>({x:E.x,y:E.y})),u=Ei(o);return{name:t.name,cells:o,colors:u}}function zs(){if(!Ue){let H=zt[Math.random()*zt.length|0];Ue=qs(H)}y=Ue;let t=zt[Math.random()*zt.length|0];Ue=qs(t),wn.drawNextPreview(Pe,Ue);let o=1/0,u=-1/0;for(let H of y.cells)H.x<o&&(o=H.x),H.x>u&&(u=H.x);let E=(o+u)/2;for(let H of y.cells)H.x=H.x-Math.round(E);Lt=s+3,V=0,Vt=!1,Wt=0,Ot=0,ss(Math.floor(Lt))?O.playRandom("appear"):Ss()}function js(){return Vo(v,s,i)}function Mi(t){if(t.length===0)return;let o=[];for(let te of t)for(let Re=0;Re<i;Re++)o.push({y:te,s:Re,color:v[te][Re],isLine:!1});Rn=t,dn=o,$n=performance.now(),sn=!0,Bn=!0,vn=!1;let u=t.length;lt.rings+=u,lt.maxRing=Math.max(lt.maxRing,u);let E=Fn(N,u-1),H=Math.round(ne*u*E),et=Qt*u;on=H,Ye=et*g(),O.play("ring");let mt=`RING \xD7${u}`;Zt(mt,"ring"),setTimeout(()=>Zt(`+${H}`,"score"),150),setTimeout(()=>Zt(`+${et}s`,"time"),300)}function xi(){let t=[...Rn].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<s-1;u++)v[u].set(v[u+1]);v[s-1].fill(0)}if(Ye>0){Te+=Ye;let o=Ye/g();wn.spawnBonusBubbles(o)}Kt.addScore(on),me+=on,Gn(),Ft==="30_24"&&Rn.length>0&&(de=_.addHighTowerRings(Rn.length)),dn=[],Rn=[],sn=!1,Bn=!1,Ye=0,on=0,ts()}function ac(){return js().length}function Ci(){if(!y)return;let t=ns();bt=t,Ne=t,en=0;let o=!1;for(let u=0;u<y.cells.length;u++){let E=y.cells[u],H=y.colors[u],et=Math.floor(Lt)+E.y,mt=es(t+E.x);et>=s&&(o=!0),et>=0&&et<s&&(v[et][mt]=H)}if(o){Ss();return}Kt.addScore(St),me+=St,Gn(),Zt(`+${St}`,"score"),O.playRandom("drop"),y=null,cn=0,mi()}function Ti(){return Wo(v,s,i)}function _i(){if(!y)return!1;let t=Math.floor(Lt)-1;return ss(t)?(Lt=t,Vt=!1,Wt=0,Ot=0,!0):(Vt=!0,!1)}n.addEventListener("pointerdown",t=>{if(Dt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),u=t.clientX-o.left,E=t.clientY-o.top;It.handlePointerDown(t,{onMagicTap:$e()?()=>ln.handleTap(u,E)?!0:Dt.applyCommand("magic_shoot",{x:u,y:E}):null,onDoubleTap:()=>Dt.applyCommand("rotate_piece")},Ne)||(en=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Dt.state!=="playing"||!It.dragging)return;t.preventDefault?.();let o=It.handlePointerMove(t,{canRotateTo:(u,E)=>Dt.canRotateTo(u,E),onDrop:()=>Dt.applyCommand("move_down"),onGroundedMove:()=>Dt.onGroundedMove(),onRotateStep:()=>C.trigger("tower_rotate")},Dt.pieceY,Dt.isGrounded);o&&Dt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Dt.state==="playing"&&It.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{It.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{It.dragging&&It.handlePointerUp(t)},{passive:!1}),X.addEventListener("click",()=>{Dt.state==="playing"&&Dt.applyCommand("rotate_piece")});let is=e.dropBtn,cs=null;function Li(){Dt.state==="playing"&&(Dt.applyCommand("move_down"),cs=setInterval(()=>{if(Dt.state!=="playing"){rs();return}Dt.applyCommand("move_down")},Tt))}function rs(){cs&&(clearInterval(cs),cs=null)}is.addEventListener("pointerdown",t=>{t.preventDefault(),Li()}),is.addEventListener("pointerup",rs),is.addEventListener("pointerleave",rs),is.addEventListener("pointercancel",rs);for(let[t,o]of Object.entries(In))o.addEventListener("click",()=>{Dt.state==="playing"&&$e()&&Dt.applyCommand("select_magic",{element:t})});Xt&&Xt.addEventListener("click",()=>{if(Dt.state!=="playing"||!jn()||!$e())return;let t=at.active??Tn;if(!t)return;let o=ps[t];!o||!Vn(o)||(ve.selectSpell(o),at.active&&(Tn=at.active,Kn=!0,at.deactivate()),ln.handleSpellButtonClick())});let Es=e.soundsToggle,bs=e.musicToggle;function yn(){let t=O.getSettings();t.soundsEnabled?Es.classList.add("active"):Es.classList.remove("active"),t.musicEnabled?bs.classList.add("active"):bs.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],E=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),E&&E.classList.toggle("active",t.musicVolume===o)}}let Qs=e.tabBtns,Bi=e.tabContents;Qs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;Qs.forEach(u=>u.classList.remove("active")),Bi.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Bo(o).classList.add("active"),o==="sounds"&&yn()})});let Zs=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Js=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Ri=e.iosHint,wi=e.standaloneBadge;function to(){let t=document.fullscreenElement||document.webkitFullscreenElement;U.textContent=t?"Disable":"Enable"}Zs&&(Js?(wi.style.display="block",U.style.display="none"):(Ri.style.display="block",U.textContent="Not supported",U.style.opacity="0.5",U.style.cursor="default")),U.addEventListener("click",()=>{if(Zs&&!Js)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",to),document.addEventListener("webkitfullscreenchange",to);let as=e.invertSwipeToggle,un=e.hapticsToggle;h.invertSwipe&&as.classList.add("active"),un&&(C.supports()?h.hapticsEnabled&&un.classList.add("active"):(un.classList.add("disabled"),un.classList.remove("active"),h.hapticsEnabled=!1,C.setEnabled(!1),_.saveGameSettings(h))),as.addEventListener("click",()=>{as.classList.toggle("active");let t=as.classList.contains("active");It.rotDir=t?-1:1,h.invertSwipe=t,_.saveGameSettings(h)}),un&&un.addEventListener("click",()=>{if(un.classList.contains("disabled"))return;un.classList.toggle("active");let t=un.classList.contains("active");h.hapticsEnabled=t,_.saveGameSettings(h),C.setEnabled(t)}),Es.addEventListener("click",()=>{let o=!O.getSettings().soundsEnabled;O.updateSettings({soundsEnabled:o}),yn(),Un()}),bs.addEventListener("click",()=>{let o=!O.getSettings().musicEnabled;O.updateSettings({musicEnabled:o}),yn(),Un(),kt!=="paused"&&(o?kt==="playing"?O.startGameMusic():O.startMenuMusic():O.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{O.updateSettings({soundVolume:t}),yn(),O.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{O.updateSettings({musicVolume:t}),yn()})}yn();function eo(){kt==="playing"&&(Kt.pause(),fn=performance.now(),kt="paused",O.musicAudio&&O.musicAudio.pause())}function ls(){kt==="paused"&&(Kt.resume(),gn+=performance.now()-fn,fn=0,kt="playing",Cs=performance.now(),O.getSettings().musicEnabled&&O.startGameMusic())}function Un(){let t=O.getSettings();Qe.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Qe.classList.toggle("off",!t.soundsEnabled),rn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",rn.classList.toggle("off",!t.musicEnabled)}function Ai(){ce.classList.remove("hidden"),xe.classList.add("hidden");let t=_.loadHighscore(Ft);if(an.textContent=t.score?t.score.toLocaleString():"0",Jt.textContent=t.time?gs(t.time):"0:00",pn.textContent=Ft==="30_24"?"High Tower":"Quick Tower",ke.textContent=me.toLocaleString(),Oe.textContent=gs(Ke),hn.textContent=Ft==="30_24"?"High Tower":"Quick Tower",Un(),co){let o=Ft==="30_24";co.style.display=o?"":"none",o&&Rs()}}function Xn(){ce.classList.add("hidden"),xe.classList.remove("hidden")}xe.addEventListener("click",()=>{eo(),Ai()}),pe.addEventListener("click",()=>{Xn(),ls()});let Ms=null;function no(t,o){Sn.textContent=t,Ms=o,re.classList.remove("hidden")}function so(){re.classList.add("hidden"),Ms=null}_e.addEventListener("click",()=>{so()}),De.addEventListener("click",()=>{let t=Ms;so(),t&&t()}),ze.addEventListener("click",()=>{no("Restart game?",()=>{Xn(),Dt.applyCommand("start_game")})}),je.addEventListener("click",()=>{no("Exit to menu?",()=>{Xn(),xe.classList.add("hidden"),kt="intro",Kt.reset(),O.stopMusic(),O.getSettings().musicEnabled&&O.startMenuMusic(),Nn()})}),Xe.addEventListener("click",()=>{x.classList.remove("hidden")}),Qe.addEventListener("click",()=>{let t=O.getSettings();O.updateSettings({soundsEnabled:!t.soundsEnabled}),Un(),yn()}),rn.addEventListener("click",()=>{let o=!O.getSettings().musicEnabled;O.updateSettings({musicEnabled:o}),Un(),yn()}),ce.addEventListener("click",t=>{t.target===ce&&(Xn(),ls())}),document.addEventListener("keydown",t=>{kt==="paused"&&!ce.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Xn(),ls())}),D.addEventListener("click",()=>{x.classList.add("hidden")}),x.addEventListener("click",t=>{t.target===x&&x.classList.add("hidden")});let xs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?kt==="playing"&&(eo(),xs=!0):xs&&kt==="paused"&&(ls(),xs=!1)});let Dt=qo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Rt,LOCK_DELAY_SEC:wt,getKillRate:g,MATCH_HIGHLIGHT_SEC:be,MAGIC_SHRINK_SEC:J,RING_HIGHLIGHT_SEC:tt,getState:()=>({gameState:kt,score:me,elapsedMs:Ke,startTime:xn,totalPausedMs:gn,stats:lt,activePiece:y,pieceY:Lt,targetRot:Ne,rotFloat:bt,rotVel:en,isGrounded:Vt,isHighlighting:sn,isMagicAnimation:vn,isRingAnimation:Bn,highlightStartTime:$n,killLevel:ge,grid:v,fallTimer:V,lockTimer:Wt}),setState:t=>{"elapsedMs"in t&&(Ke=t.elapsedMs),"killLevel"in t&&(ge=t.killLevel),"fallTimer"in t&&(V=t.fallTimer),"lockTimer"in t&&(Wt=t.lockTimer),"targetRot"in t&&(Ne=t.targetRot),"rotFloat"in t&&(bt=t.rotFloat),"rotVel"in t&&(en=t.rotVel)},funcs:{startGame:Si,endGame:Ss,rotatePieceByDir:hi,tryMoveDown:_i,canPlaceAtRot:Ws,maybeResetLockDelay:Vs,shootMagic:li,selectMagic:jo,updateGroundedState:yi,lockPiece:Ci,finishHighlight:pi,finishRingHighlight:xi},ui:{updateTimeHud:ys,updateRemainingHud:Ks}}),wn=zo({canvas:n,canvasCtx:r,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:w,MAX_RADIUS_X:$,RADIUS_X_FACTOR:j,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:be,MATCH_SHRINK_PHASE:Q,MAGIC_SHRINK_SEC:J,RING_HIGHLIGHT_SEC:tt,LOCK_DELAY_SEC:wt,getKillRate:g,ELEMENT_COLORS:ee,ELEMENT_TO_COLOR:Yt,BLOCK_COLOR_FRONT:ft,BLOCK_COLOR_BACK:Gt,ACTIVE_COLOR_FRONT:ye,GHOST_COLOR_FILL:nt,GHOST_COLOR_STROKE:F,GHOST_STROKE_WIDTH:pt,MAGIC_DIM_DOT_ALPHA:_t,MAGIC_DIM_DOT_SCALE:Ht,MAGIC_TARGET_DOT_SCALE:fe,getState:()=>({gameState:kt,grid:v,activePiece:y,pieceY:Lt,rotFloat:bt,killLevel:ge,isHighlighting:sn,highlightedCells:dn,highlightStartTime:$n,isMagicAnimation:vn,isRingAnimation:Bn,isGrounded:Vt,lockTimer:Wt,spellState:ln.getRenderState()}),getVisualSettings:()=>({waterBubbles:Ge,waterColor:le}),funcs:{snappedRot:ns,computeGhostY:vi,normSector:es,getMagicTargetColor:()=>$e()&&at.canUse()?Yt[at.active]:null,getTransmuteAnimState:t=>ln.getTransmuteAnimState(t),getLightningAnimState:t=>ln.getLightningAnimState(t),getFireAnimState:t=>ln.getFireAnimState(t)}}),Cs=performance.now();function oo(t){let o=Math.min(.05,Math.max(.001,(t-Cs)/1e3));if(Cs=t,Dt.update(o,t),ln.update(t),Te>0){let u=Math.min(Te,Mn*o);ge=Math.max(0,ge-u),Te-=u}bt=Ne,bt>1e6&&(bt%=i),bt<-1e6&&(bt%=i),wn.render(o,t),requestAnimationFrame(oo)}rt.addEventListener("click",()=>{Dt.applyCommand("start_game")}),vt.addEventListener("click",()=>{Dt.applyCommand("start_game")}),$t.addEventListener("click",()=>{kt="intro",Kt.reset(),O.stopMusic(),O.getSettings().musicEnabled&&O.startMenuMusic(),Nn()}),he.forEach(t=>{t.addEventListener("click",o=>{he.forEach(E=>E.classList.remove("active")),t.classList.add("active"),Ft=t.dataset.mode,Qn(),zn();let u=_.loadHighscore(Ft);u.score>0?(ae.textContent=u.score.toLocaleString(),Le.textContent=bn(u.time)):(ae.textContent="0",Le.textContent="0:00"),rt.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>rt.classList.add("idlePulse"),2e3)})});let Ts=document.querySelectorAll(".spell-select-btn"),_s=document.getElementById("spellDesc"),Ii=document.getElementById("spellProgressFill"),io=document.getElementById("spellProgressMarkers"),co=document.getElementById("pauseSpellProgress"),Pi=document.getElementById("pauseSpellProgressFill"),ro=document.getElementById("pauseSpellProgressMarkers"),ao=document.getElementById("pauseSpellProgressLabel");function Ls(){return Zo.map(t=>kn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Bs(t){return t.length?Math.max(...t):0}function ki(t){let o=Ls(),u=Bs(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function lo(t){if(!t)return;t.innerHTML="";let o=Ls(),u=Bs(o);o.forEach(E=>{let H=document.createElement("span");H.className="marker",H.dataset.threshold=E;let et=u>0?E/u*100:0;H.style.left=`${et}%`,t.appendChild(H)})}function uo(t,o){if(!t)return;let u=Oi(o);t.style.width=`${u}%`}function fo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(E=>{let H=parseInt(E.dataset.threshold,10)||0;E.classList.toggle("reached",o>=H)})}function Oi(t){let o=Ls(),u=Bs(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function go(t){if(!_s)return;let o=kn(t),u=ve.getDescription(t);o===0||de>=o?_s.innerHTML=u:_s.innerHTML=`${u} <span class="spell-progress-text">${de}/${o}</span>`}function Rs(){de=_.loadHighTowerRings(),Ts.forEach(o=>{let u=o.dataset.spell,E=kn(u),H=de>=E;o.classList.toggle("locked",!H);let et=o.querySelector(".spell-lock");et&&(et.style.display=H?"none":"")}),uo(Ii,de),uo(Pi,de),fo(io,de),fo(ro,de),ao&&(ao.textContent=ki(de));let t=document.querySelector(".spell-select-btn.active");t&&go(t.dataset.spell)}lo(io),lo(ro),Rs(),Ts.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){he.forEach(te=>te.classList.remove("active")),u.classList.add("active"),Ft="30_24",Qn(),zn();let mt=_.loadHighscore(Ft);mt.score>0?(ae.textContent=mt.score.toLocaleString(),Le.textContent=bn(mt.time)):(ae.textContent="0",Le.textContent="0:00")}let E=t.dataset.spell,H=kn(E),et=de>=H;go(E),et&&(Ts.forEach(mt=>mt.classList.remove("active")),t.classList.add("active"),ve.selectSpell(E),On(at.active))})}),He.addEventListener("click",()=>{let t=_.loadHighscore("30_24"),o=_.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${bn(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${bn(o.time)}
`:`  No record yet
`,alert(u)}),Be.addEventListener("click",()=>{x.classList.remove("hidden")}),Pn(),zn(),Qn(),Nn(),O.startMenuMusic();let Di=()=>{if(O.unlock(),!O.getSettings().musicEnabled)return;let t=O.musicAudio;!t||t.paused||t.ended?Dt.state==="playing"?O.startGameMusic():O.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},mo=0,Hi=10,$i=()=>{mo>=Hi||(mo++,Di())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,$i,{passive:!0})}),requestAnimationFrame(oo)})();})();
