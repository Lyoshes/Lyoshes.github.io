(()=>{var ri=[0,.25,.5,.75,1],li=[0,.05,.15,.25,.5],ui={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav"},Xs={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Ys="soundSettings";function di(){try{let e=localStorage.getItem(Ys);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function mi(e){try{localStorage.setItem(Ys,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Vs(){return{audioContext:null,buffers:{},settings:di(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=n,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ri[this.settings.soundVolume]},getMusicVolume(){return li[this.settings.musicVolume]},async loadSound(n,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(l)).arrayBuffer(),s=await this.audioContext.decodeAudioData(c);this.buffers[n]=s}catch(u){console.debug(`Failed to load sound: ${n} from ${l}`,u)}},preload(){this.initContext();for(let[n,l]of Object.entries(ui))this.loadSound(n,l)},play(n,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;l!==null&&(u=`${n}${l}`);let c=this.buffers[u];if(c)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let a=this.audioContext.createBufferSource();a.buffer=c,a.connect(s),a.start(0),a.onended=()=>{a.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(n,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Xs.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Xs.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},mi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var Ws="eb_highscore",Ks="eb_highscore_quick",qs="eb_settings",zs="eb_high_tower_rings",gi={invertSwipe:!1,difficulty:"easy"};function Qs(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Ks:Ws,l=localStorage.getItem(n);if(l)return JSON.parse(l)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,l="30_24"){try{let u=this.loadHighscore(l);if(e>u.score||e===u.score&&n>u.time){let c=l==="25_20"?Ks:Ws;return localStorage.setItem(c,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(qs);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...gi}},saveGameSettings(e){try{localStorage.setItem(qs,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(zs);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(zs,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let l=this.loadHighTowerRings()+e;return this.saveHighTowerRings(l),l}}}function Zs(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function js(e){return document.getElementById("tab-"+e)}var fi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Js(e={}){let{elementColors:n={}}=e,l=0;return{showBonus(u,c="score",s=null){let a=document.createElement("div");a.className=`bonus-popup ${c}`,a.textContent=u,s&&n[s]&&(a.style.color=n[s]);let r=window.innerWidth/2,m=window.innerHeight/2-40,f=(Math.random()-.5)*200,g=(Math.random()-.5)*100+l*36;a.style.left=`${r+f}px`,a.style.top=`${m+g}px`,a.style.transform="translate(-50%, -50%)",document.body.appendChild(a),l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{a.remove()},1800)},getElementIcon(u){return fi[u]||"\u2726"}}}var to={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function eo(){return{spawnMagicOrb(e,n,l,u){if(!u)return;let c=document.createElement("div");c.className=`magic-orb ${e}`,c.textContent=to[e]||"\u2726";let s=u.getBoundingClientRect(),a=s.left+s.width/2-n,r=s.top+s.height/2-l,m=Math.hypot(a,r),f=Math.atan2(r,a),g=m*.35*(Math.random()>.5?1:-1),h=f+Math.PI/2,T=a*.5+Math.cos(h)*g,G=r*.5+Math.sin(h)*g;c.style.setProperty("--mid-x",`${T}px`),c.style.setProperty("--mid-y",`${G}px`),c.style.setProperty("--end-x",`${a}px`),c.style.setProperty("--end-y",`${r}px`),c.style.left=`${n}px`,c.style.top=`${l}px`,document.body.appendChild(c),setTimeout(()=>{c.remove()},700)},spawnMagicShot(e,n,l,u,c){if(!n){c&&c();return}let s=n.getBoundingClientRect(),a=s.left+s.width/2,r=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=to[e]||"\u2726";let f=l-a,g=u-r;m.style.setProperty("--end-x",`${f}px`),m.style.setProperty("--end-y",`${g}px`),m.style.left=`${a}px`,m.style.top=`${r}px`,document.body.appendChild(m);let h=setInterval(()=>{let T=m.getBoundingClientRect();this.spawnTrailParticle(e,T.left+T.width/2,T.top+T.height/2)},40);setTimeout(()=>{clearInterval(h),m.remove(),this.spawnExplosion(e,l,u),c&&c()},300)},spawnTrailParticle(e,n,l){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${l}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,l){for(let c=0;c<12;c++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let a=c/12*Math.PI*2+(Math.random()-.5)*.5,r=40+Math.random()*40,m=Math.cos(a)*r,f=Math.sin(a)*r;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${l}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let l=e.getBoundingClientRect(),u=l.left+l.width/2,c=l.top+l.height/2,s=Math.max(8,Math.round(n));for(let a=0;a<s;a++){let r=document.createElement("div");r.className="spell-bubble",r.textContent="\u25CF";let m=a/s*Math.PI*2+(Math.random()-.5)*.6,f=50+Math.random()*60,g=Math.cos(m)*f,h=Math.sin(m)*f-20;r.style.setProperty("--px",`${g}px`),r.style.setProperty("--py",`${h}px`),r.style.left=`${u}px`,r.style.top=`${c}px`,r.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(r),setTimeout(()=>r.remove(),800)}},spawnSpellOrb(e,n,l){if(!l)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let c=l.getBoundingClientRect(),s=c.left+c.width/2-e,a=c.top+c.height/2-n,r=Math.hypot(s,a),m=Math.atan2(a,s),f=r*.35*(Math.random()>.5?1:-1),g=m+Math.PI/2,h=s*.5+Math.cos(g)*f,T=a*.5+Math.sin(g)*f;u.style.setProperty("--mid-x",`${h}px`),u.style.setProperty("--mid-y",`${T}px`),u.style.setProperty("--end-x",`${s}px`),u.style.setProperty("--end-y",`${a}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}function no(e={}){let{buttons:n={},onActivate:l=null}=e,u={fire:3,water:3,lightning:3,earth:3},c=null;function s(){for(let[r,m]of Object.entries(n)){if(!m)continue;let f=u[r],g=m.querySelector(".charges");g&&(g.textContent=f),m.classList.toggle("empty",f<=0),m.classList.toggle("active",c===r&&f>0)}}function a(r){let m=n[r];m&&(m.classList.remove("pulse"),m.offsetWidth,m.classList.add("pulse"),setTimeout(()=>m.classList.remove("pulse"),400))}return{get charges(){return u},get active(){return c},set active(r){c=r},select(r){if(u[r]<=0)return!1;let m=c===r;return c=m?null:r,s(),!m&&c===r&&l&&l(),!m},useCharge(){if(!c||u[c]<=0)return!1;let r=c;return u[r]--,c=null,s(),a(r),!0},addCharges(r,m){u[r]!==void 0&&(u[r]+=m,s(),a(r))},canUse(){return c!==null&&u[c]>0},deactivate(){c=null,s()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,c=null,s()},updateButtons:s,initButtons(r){for(let[m,f]of Object.entries(n))f&&f.addEventListener("click",()=>{r&&r(m)})}}}var ms={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:10,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:10,effect:{type:"chain_lightning"}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:10,effect:{type:"transmutation"}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:10,effect:{type:"horizontal_beam"}}};function so(e={}){let{button:n=null,onActivate:l=null,onProgress:u=null,onReady:c=null}=e,s="ice",a=0;function r(){return ms[s]||ms.ice}function m(){if(!n)return;let g=r(),h=Math.min(a/g.maxProgress,1)*100,T=a>=g.maxProgress;n.style.setProperty("--progress",`${h}%`);let G=n.querySelector(".spell-icon");G&&(G.textContent=g.icon);let V=n.querySelector(".spell-counter");V&&(V.textContent=`${Math.min(a,g.maxProgress)}/${g.maxProgress}`),n.classList.toggle("ready",T),n.classList.toggle("charging",!T&&a>0),u&&u(a,g.maxProgress)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return a},get maxProgress(){return r().maxProgress},get isReady(){return a>=r().maxProgress},get effect(){return r().effect},get button(){return n},selectSpell(g){ms[g]&&(s=g,a=0,m())},addProgress(g=1){let h=r();if(a>=h.maxProgress)return!1;let T=a<h.maxProgress;return a=Math.min(a+g,h.maxProgress),m(),f(),T&&a>=h.maxProgress&&c&&c(),!0},canUse(){return a>=r().maxProgress},use(){if(!this.canUse())return null;let g=r().effect;return a=0,m(),f(),l&&l(s),g},reset(){a=0,m()},updateButton:m,initButton(g){n&&n.addEventListener("click",()=>{g&&g()})}}}var pi={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function oo(e={}){let{canvas:n}=e,l=e.rotDir||1,u=!1,c=0,s=0,a=0,r=0,m=0,f=1,g=null,h=0,T=0,G=0,V=0,Z=0,ot=0,Et=0,de=0,st=pi;return{get rotDir(){return l},set rotDir(W){l=W},get dragging(){return u},get dragMode(){return g},handlePointerDown(W,ft,xe){if(ft.onMagicTap&&ft.onMagicTap(W.clientX,W.clientY))return!0;let me=performance.now(),jt=me-ot,Jt=W.clientX-Et,te=W.clientY-de,be=Math.hypot(Jt,te);return jt<=st.DOUBLE_TAP_MS&&be<=st.DOUBLE_TAP_MAX_DIST?(ft.onDoubleTap&&ft.onDoubleTap(),ot=0):(ot=me,Et=W.clientX,de=W.clientY),u=!0,f=-1,c=W.clientX,s=W.clientY,a=xe,r=0,m=0,g=null,h=me,T=W.clientX,G=W.clientY,V=h,Z=0,n&&n.setPointerCapture(W.pointerId),!1},handlePointerMove(W,ft,xe,me){if(!u)return null;let jt=W.clientX-c,Jt=W.clientY-s,te=performance.now();if(Math.abs(jt)<st.DEADZONE_PX&&Math.abs(Jt)<st.DEADZONE_PX)return null;if(!g){let Yt=Math.abs(jt),wt=Math.abs(Jt);if(Jt<0)Yt>=st.DEADZONE_PX&&(g="rotate");else if(wt>=Yt*st.AXIS_DOMINANCE){if(wt>=st.DROP_SWIPE_MIN_DISTANCE){let Lt=Math.max(1,te-h);wt/Lt*1e3>=st.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else Yt>=wt*st.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let be=null;if(g==="rotate"&&Math.abs(jt)>=st.DEADZONE_PX){let Yt=Math.max(1,te-V),wt=W.clientX-T,Lt=Math.max(1,Math.abs(wt)/Yt*1e3),d=Math.max(st.MIN_ROT_PX,Math.min(st.MAX_ROT_PX,st.PX_PER_STEP*(st.SWIPE_SPEED_REF/Lt)));Z+=-wt/d*l*f;let j=Math.trunc(Z);j!==0&&(Z-=j);let J=r+j;if(J!==r&&ft.canRotateTo){let ge=Math.sign(J-r),$t=a+r;for(;r!==J;){let Ie=r+ge,Fe=a+Ie;if(!ft.canRotateTo(Math.floor(xe),Fe))break;r=Ie,$t=Fe,me&&ft.onGroundedMove&&ft.onGroundedMove()}be={targetRot:$t,rotFloat:$t}}}if(g==="drop"&&Jt>st.DEADZONE_PX&&ft.onDrop){let Yt=Math.max(1,te-V),wt=W.clientY-G,Lt=Math.max(1,wt/Yt*1e3),d=Math.max(st.MIN_DROP_PX,Math.min(st.MAX_DROP_PX,st.PX_PER_DROP*(st.SWIPE_SPEED_REF/Lt))),j=Math.trunc(Jt/d);if(j>m){let J=j-m;for(let ge=0;ge<J;ge++)ft.onDrop();m=j}}return T=W.clientX,G=W.clientY,V=te,be},handlePointerUp(W){if(u&&(u=!1,g=null,n&&W&&W.pointerId!==void 0))try{n.releasePointerCapture(W.pointerId)}catch{}},reset(){u=!1,g=null,r=0,m=0,Z=0}}}var gs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function io(){let e="intro",n=0,l=0,u=0,c=0,s=0,a={...gs};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return l},get stats(){return a},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,l=performance.now(),u=0,c=0,s=0,a={...gs}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(s+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){n+=r},setScore(r){n=r},updateTime(){e==="playing"&&l>0&&(u=performance.now()-l-s)},getFormattedTime(){let r=Math.floor(u/1e3),m=Math.floor(r/60),f=r%60;return`${m}:${f.toString().padStart(2,"0")}`},incrementStat(r,m=1){r in a&&(a[r]+=m)},updateMaxStat(r,m){r in a&&m>a[r]&&(a[r]=m)},reset(){e="intro",n=0,l=0,u=0,c=0,s=0,a={...gs}}}}function je(e,n){return e%=n,e<0&&(e+=n),e}function co(e,n){return e[Math.min(n,e.length-1)]}function Xn(e){let n=Math.max(0,Math.floor(e/1e3)),l=Math.floor(n/60),u=n%60;return`${l}:${u.toString().padStart(2,"0")}`}function ao(e,n){let l=e.map(({x:r,y:m},f)=>({x:m,y:-r,color:n[f]})),u=1/0,c=-1/0,s=1/0;for(let r of l)u=Math.min(u,r.x),c=Math.max(c,r.x),s=Math.min(s,r.y);let a=Math.round((u+c)/2);for(let r of l)r.x-=a,r.y-=s;return l.sort((r,m)=>r.y-m.y||r.x-m.x),{cells:l.map(r=>({x:r.x,y:r.y})),colors:l.map(r=>r.color)}}function fs(e,n,l,u){let c=[];return e+1<l&&c.push({y:e+1,s:n}),e-1>=0&&c.push({y:e-1,s:n}),c.push({y:e,s:je(n-1,u)}),c.push({y:e,s:je(n+1,u)}),c}function ro(e,n,l){let u=Array.from({length:n},()=>new Uint8Array(l)),c=[];for(let s=0;s<n;s++)for(let a=0;a<l;a++){if(!e[s][a]||u[s][a])continue;let r=[],m=[{y:s,s:a}];for(u[s][a]=1;m.length>0;){let f=m.shift();r.push(f);for(let g of fs(f.y,f.s,n,l))e[g.y][g.s]&&!u[g.y][g.s]&&(u[g.y][g.s]=1,m.push(g))}c.push(r)}return c}function lo(e){return e.some(n=>n.y===0)}function ps(e,n,l,u,c,s){if(!e)return!1;let a=je(l,s);for(let r of e.cells){let m=n+r.y,f=je(a+r.x,s);if(m<0)return!1;if(!(m>=c)&&u[m][f])return!1}return!0}function uo(e,n,l,u,c,s){if(!e)return null;let a=Math.floor(n);for(;ps(e,a-1,l,u,c,s);)a-=1;return a}function mo(e,n,l){let u=[],c=[];for(let s=0;s<n;s++){let a=[],r=0,m=e[s][0],f=m?1:0;for(let g=1;g<=l;g++){let h=g<l?e[s][g]:0;h&&h===m?f++:(f>=1&&m&&a.push({start:r,length:f,color:m}),r=g,m=h,f=h?1:0)}if(a.length>=2){let g=a[0],h=a[a.length-1];if(g.start===0&&h.start+h.length===l&&g.color===h.color){let T=g.length+h.length;a[0]={start:h.start,length:T,color:g.color},a.pop()}}for(let g of a)if(g.length>=3){let h=[];for(let T=0;T<g.length;T++)h.push({y:s,s:(g.start+T)%l});u.push({color:g.color,length:g.length,cells:h})}}for(let s=0;s<l;s++){let a=0,r=e[0][s],m=r?1:0;for(let f=1;f<=n;f++){let g=f<n?e[f][s]:0;if(g&&g===r)m++;else{if(m>=3&&r){let h=[];for(let T=0;T<m;T++)h.push({y:a+T,s});u.push({color:r,length:m,cells:h})}a=f,r=g,m=g?1:0}}}for(let s=0;s<n;s++)for(let a=0;a<l;a++){let r=e[s][a],m=e[s][(a+1)%l],f=e[s][(a+2)%l],g=e[s][(a+3)%l];r&&r===m&&f&&f===g&&r!==f&&c.push({cells:[{y:s,s:a},{y:s,s:(a+1)%l},{y:s,s:(a+2)%l},{y:s,s:(a+3)%l}]})}for(let s=0;s<l;s++)for(let a=0;a<n-3;a++){let r=e[a][s],m=e[a+1][s],f=e[a+2][s],g=e[a+3][s];r&&r===m&&f&&f===g&&r!==f&&c.push({cells:[{y:a,s},{y:a+1,s},{y:a+2,s},{y:a+3,s}]})}return{lineMatches:u,pairMatches:c}}function go(e,n,l){let u=[];for(let c=0;c<n;c++){let s=!0;for(let a=0;a<l;a++)if(!e[c][a]){s=!1;break}s&&u.push(c)}return u}function fo(e,n){let l=new Map;e.forEach((u,c)=>l.set(`${u.x},${u.y}`,n[c]));for(let u=0;u<e.length;u++){let c=e[u],s=n[u],a=1;for(let ot=1;ot<=2&&l.get(`${c.x+ot},${c.y}`)===s;ot++)a++;if(a>=3)return!0;let r=1;for(let ot=1;ot<=2&&l.get(`${c.x},${c.y+ot}`)===s;ot++)r++;if(r>=3)return!0;let m=s,f=l.get(`${c.x+1},${c.y}`),g=l.get(`${c.x+2},${c.y}`),h=l.get(`${c.x+3},${c.y}`);if(m&&f&&g&&h&&m===f&&g===h&&m!==g)return!0;let T=s,G=l.get(`${c.x},${c.y+1}`),V=l.get(`${c.x},${c.y+2}`),Z=l.get(`${c.x},${c.y+3}`);if(T&&G&&V&&Z&&T===G&&V===Z&&T!==V)return!0}return!1}function po(e){let{getN:n,getH:l,FALL_INTERVAL:u,LOCK_DELAY_SEC:c,getKillRate:s,MATCH_HIGHLIGHT_SEC:a,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:m,getState:f,setState:g,funcs:h,ui:T}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(G,V={}){let Z=f();if(G==="start_game")return Z.gameState!=="playing"?(h.startGame(),!0):!1;if(Z.gameState!=="playing")return!1;switch(G){case"rotate_piece":return h.rotatePieceByDir(),!0;case"move_down":return h.tryMoveDown();case"rotate_cylinder":{let{rot:ot}=V;return typeof ot=="number"&&h.canPlaceAtRot(Math.floor(Z.pieceY),ot)?(g({targetRot:ot,rotFloat:ot,rotVel:0}),Z.isGrounded&&h.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ot,y:Et}=V;return h.shootMagic(ot,Et)}case"select_magic":{let{element:ot}=V;return h.selectMagic(ot),!0}default:return console.warn("GameEngine: unknown command",G),!1}},update(G,V){let Z=f();if(Z.gameState!=="playing")return;let ot=V-Z.startTime-Z.totalPausedMs;g({elapsedMs:ot}),T.updateTimeHud();let Et=Z.killLevel+s()*G;if(g({killLevel:Et}),T.updateRemainingHud(),Et>=l()){h.endGame();return}if(Z.isHighlighting){let W=(V-Z.highlightStartTime)/1e3,ft;Z.isRingAnimation?ft=m:Z.isMagicAnimation?ft=r:ft=a,W>=ft&&(Z.isRingAnimation?h.finishRingHighlight():h.finishHighlight())}let de=Z.fallTimer+G;if(de>=u&&(de-=u,h.tryMoveDown()),g({fallTimer:de}),h.updateGroundedState()){let W=Z.lockTimer+G;g({lockTimer:W}),W>=c&&h.lockPiece()}},reset(){h.startGame()},canRotateTo(G,V){return h.canPlaceAtRot(G,V)},getRotation(){let G=f();return{targetRot:G.targetRot,rotFloat:G.rotFloat,rotVel:G.rotVel}},setRotation(G){g({targetRot:G,rotFloat:G,rotVel:0})},onGroundedMove(){h.maybeResetLockDelay()}}}var Zt=Math.PI*2;function ho(e){let{canvas:n,canvasCtx:l,getN:u,getH:c,TOP_PAD_PX:s,BOTTOM_PAD_PX:a,SIDE_MARGIN_PX:r,MAX_RADIUS_X:m,RADIUS_X_FACTOR:f,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:h,MATCH_SHRINK_PHASE:T,MAGIC_SHRINK_SEC:G,RING_HIGHLIGHT_SEC:V,LOCK_DELAY_SEC:Z,getKillRate:ot,ELEMENT_COLORS:Et,ELEMENT_TO_COLOR:de,BLOCK_COLOR_FRONT:st,BLOCK_COLOR_BACK:W,ACTIVE_COLOR_FRONT:ft,GHOST_COLOR_FILL:xe,GHOST_COLOR_STROKE:me,GHOST_STROKE_WIDTH:jt,MAGIC_DIM_DOT_ALPHA:Jt,MAGIC_DIM_DOT_SCALE:te,MAGIC_TARGET_DOT_SCALE:be,getState:Yt,getVisualSettings:wt,funcs:Lt}=e,d=l,j=u(),J=c(),ge={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},$t=[],Ie=40;function Fe(R,A,I,_,M){let E=Math.max(3,Math.round(R)),q=180;for(let z=0;z<E;z++)setTimeout(()=>{let L=Math.random()>.5?"left":"right",nt=15,v=L==="left"?nt+Math.random()*Math.max(10,A-nt*2):I+nt+Math.random()*Math.max(10,M-I-nt*2),y=_-10;$t.push({x:v,baseX:v,y,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:nt,maxX:M-nt})},z*q)}function Sn(R,A,I){$t=$t.filter(_=>_.y>R+_.size&&_.y>-20);for(let _ of $t){_.y-=Ie*I,_.wobble+=_.wobbleSpeed*I;let M=_.baseX+Math.sin(_.wobble)*_.wobbleAmp;_.x=Math.max(_.minX,Math.min(_.maxX,M))}}function Yn(R){if($t.length!==0){d.fillStyle="rgba(255, 255, 255, 0.3)",d.strokeStyle="rgba(255, 255, 255, 0.5)",d.lineWidth=1;for(let A of $t)A.y<R+A.size||(d.beginPath(),d.arc(A.x,A.y,A.size,0,Math.PI*2),d.fill(),d.stroke())}}let Je={left:0,right:0,h:0,w:0};function Pt(R,A,I){let _=1-I/J;return R+_*A}function tn(R){return R=R%j,R<0?R+j:R}function Ue(R,A,I,_,M,E){let q=tn(E),z=(M-q)/j*Zt+g;return{x:R+Math.cos(z)*I,y:A+Math.sin(z)*_,ang:z}}let En=.52,en=1.02;function Vt(R,A,I,_,M,E){let q=tn(E),z=(M-q)/j*Zt+g;return{x:R+Math.cos(z)*I,y:A+Math.sin(z)*_,ang:z}}function Mn(R,A,I,_,M,E,q,z=1){let L=Vt(R,A,I,_,M-En,E),nt=Vt(R,A,I,_,M+En,E),v={x:L.x,y:L.y-q*.5},y={x:L.x,y:L.y+q*.5},N={x:nt.x,y:nt.y-q*.5},Tt={x:nt.x,y:nt.y+q*.5},C=(v.x+N.x+Tt.x+y.x)*.25,tt=(v.y+N.y+Tt.y+y.y)*.25,Y=en*z,Mt=z,Rt=[v,N,Tt,y].map(ee=>({x:C+(ee.x-C)*Y,y:tt+(ee.y-tt)*Mt})),Wt=Math.abs((nt.x-L.x)*Y),ut=Math.abs(q*Mt);return{corners:Rt,cx:C,cy:tt,wApprox:Wt,hApprox:ut,ang:Vt(R,A,I,_,M,E).ang}}function Ot(R,A,I,_,M,E,q,z,L=1,nt=null,v=1,y=null,N=0,Tt=1,C=1){let tt=Mn(R,A,I,_,M,E,q,C),[Y,Mt,Rt,Wt]=tt.corners;if(d.save(),d.globalAlpha=L,d.fillStyle=z,d.beginPath(),d.moveTo(Y.x,Y.y),d.lineTo(Mt.x,Mt.y),d.lineTo(Rt.x,Rt.y),d.lineTo(Wt.x,Wt.y),d.closePath(),d.fill(),y&&N>0&&(d.strokeStyle=y,d.lineWidth=N,d.stroke()),nt){let ut=Math.min(tt.wApprox,tt.hApprox)*.28*Tt;d.globalAlpha=L*v,d.fillStyle=nt,d.beginPath(),d.arc(tt.cx,tt.cy,ut,0,Zt),d.fill()}d.restore(),d.globalAlpha=1}function Vn(R,A,I,_,M,E){let q=Ue(R,A,I,_,M,E),z=Ue(R,A,I,_,M+1,E),L=Ue(R,A,I,_,M-1,E),nt=Math.abs(z.x-q.x),v=Math.abs(q.x-L.x),y=(nt+v)*.5*1.06;return Math.max(1,y)}function Wn(R,A,I,_,M,E){let q=(M-E)/j*Zt+g;return{x:R+Math.cos(q)*I,y:A+Math.sin(q)*_,ang:q}}function Kn(R,A,I,_,M,E,q,z=1,L=null,nt=1,v=null,y=0,N=1){d.save(),d.translate(R,A);let Tt=Math.atan2(_,I);if(d.rotate(Tt),d.globalAlpha=z,d.fillStyle=q,d.fillRect(-M/2,-E/2,M,E),v&&y>0&&(d.strokeStyle=v,d.lineWidth=y,d.strokeRect(-M/2,-E/2,M,E)),L){let C=Math.min(M,E)*.28*N;d.globalAlpha=z*nt,d.fillStyle=L,d.beginPath(),d.arc(0,0,C,0,Zt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let R=Math.max(1,Math.min(2,window.devicePixelRatio||1)),A=Math.floor(n.clientWidth*R),I=Math.floor(n.clientHeight*R);(n.width!==A||n.height!==I)&&(n.width=A,n.height=I,d.setTransform(R,0,0,R,0,0))},render(R=.016,A=performance.now()){this.resize();let I=Yt();j=u(),J=c();let _=n.clientWidth,M=n.clientHeight;d.clearRect(0,0,_,M),d.fillStyle="#0b0f14",d.fillRect(0,0,_,M);let E=_*.5,q=(_-2*r)/2,z=M-s-a,L=6,nt=j*z/(L*J),v,y,N,Tt;Tt=M-a,nt<=Math.min(q,m)?(v=nt,y=z,N=s):(v=Math.min(q,m),y=v*L*J/j,N=Tt-y);let C=v*.28,{killLevel:tt,rotFloat:Y,grid:Mt,gameState:Rt}=I,Wt=wt?wt():{},ut=Wt.waterColor||"blue",ee=Wt.waterBubbles||!1,ve=ge[ut]||ge.blue,dt=Pt(N,y,tt),nn=.7,xn=tt/J,_t={...ve.top},S={...ve.bottom};if(xn>nn){let x=(xn-nn)/(1-nn);_t.r=Math.round(_t.r+(255-_t.r)*x*.5),_t.g=Math.round(_t.g+(150-_t.g)*x*.5),_t.b=Math.round(_t.b+(150-_t.b)*x*.5),S.r=Math.round(S.r+(180-S.r)*x),S.g=Math.round(S.g*(1-x*.6)),S.b=Math.round(S.b*(1-x*.6))}let ht=E-v-8,et=E+v+8,At=N,ie=Tt+5,ne=d.createLinearGradient(0,dt,0,M);ne.addColorStop(0,`rgba(${_t.r},${_t.g},${_t.b},0.5)`),ne.addColorStop(1,`rgba(${S.r},${S.g},${S.b},0.7)`),d.fillStyle=ne;let Xe=Math.round((_t.r+S.r)/2),sn=Math.round((_t.g+S.g)/2),fe=Math.round((_t.b+S.b)/2),K=v+8,on=C+4;d.fillRect(0,dt,ht,M-dt),d.fillRect(et,dt,_-et,M-dt),d.beginPath();let we=Math.max(dt,ie);d.moveTo(ht,we),dt<=ie+on?d.ellipse(E,ie,K,on,0,Math.PI,0,!1):d.lineTo(et,we),d.lineTo(et,M),d.lineTo(ht,M),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(ht,At),d.lineTo(ht,ie),d.stroke(),d.beginPath(),d.moveTo(et,At),d.lineTo(et,ie),d.stroke(),d.beginPath(),d.ellipse(E,ie,v+8,C+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(E,ie,v+8,C+4,0,0,Zt),d.fill(),tt>.5&&(d.strokeStyle=`rgba(${Math.min(255,Xe+60)},${Math.min(255,sn+40)},${Math.min(255,fe+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,dt),d.lineTo(ht,dt),d.moveTo(et,dt),d.lineTo(_,dt),d.stroke()),Je={left:ht,right:et,h:M,w:_},($t.length>0||ee)&&(Sn(dt,M,R),Yn(dt)),d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let xt=Zt*v,bn=10,Ye=xt/bn*.7,hs=xt/bn*.3;d.setLineDash([Ye,hs]);let ys=xt/j;d.lineDashOffset=tn(Y)*ys;for(let x=0;x<=J;x++){let $=Pt(N,y,x);d.beginPath(),d.ellipse(E,$,v,C,0,0,Zt),d.stroke()}d.setLineDash([]);let ce=[],cn=[];for(let x=0;x<J;x++){let $=Pt(N,y,x+.5);for(let X=0;X<j;X++){let k=Mt[x][X];if(!k)continue;let O=Ue(E,$,v,C,X,Y),Q=Math.sin(O.ang),P={y:x,s:X,yScr:$,p:O,depth:Q,color:k};Q<-.1?ce.push(P):cn.push(P)}}let vn=Lt.getMagicTargetColor(),{isHighlighting:an,highlightedCells:ae,highlightStartTime:Pe,isMagicAnimation:Cn}=I,Kt=null,re=1,Ve=1,Tn=!1;if(an&&ae.length>0){Kt=new Set(ae.map($=>`${$.y},${$.s}`));let x=(performance.now()-Pe)/1e3;if(Cn){let $=Math.min(1,x/G);re=1-$*.85,Ve=1-$*.9,Tn=!0}else{let $=Math.min(1,x/h),X=1-T;if($>X){let k=($-X)/T;re=1-k*.85,Ve=1-k*.9,Tn=!0}}}ce.sort((x,$)=>x.depth-$.depth);for(let x of ce){let $=y/J*.9,X=Et[x.color]||null,k=.35,O=1,Q=`${x.y},${x.s}`;Kt&&Kt.has(Q)&&(k*=Ve,O=re),Ot(E,x.yScr,v,C,x.s,Y,$,W,k,X,.5,null,0,1,O)}let{isRingAnimation:Ce}=I;if(an&&ae.length>0&&!Cn){let x=(performance.now()-Pe)/1e3,X=Math.min(1,x/(Ce?V:h)),k=1-T,O=X>k,Q=O?(X-k)/T:0,P=Ce?Math.floor(X*k*j*2)%j:-1,F=4+X/k*10,it=Math.sin(x*F*Zt),It=O?1:.3+it*.3,yt=O?1-Q*.8:1,bt=O?1-Q:1;for(let mt of ae){let kt=Pt(N,y,mt.y+.5),le=Vt(E,kt,v,C,mt.s,Y);if(Math.sin(le.ang)>=-.1)continue;let un=y/J*.9,Gt,Dt,Ht;if(Ce){let Oe=(mt.s-P+j)%j,he=Oe<3?1-Oe/3:0;Gt=(O?bt:.2+he*.5)*.5,Dt=`rgba(255, 159, 67, ${Gt})`,Ht=O?yt:1+he*.15}else Gt=It*bt,Dt=mt.isLine?`rgba(255, 255, 255, ${Gt*.5})`:`rgba(255, 220, 100, ${Gt*.4})`,Ht=O?yt:1.1;Ot(E,kt,v,C,mt.s,Y,un,Dt,1,null,1,null,0,1,Ht)}}cn.sort((x,$)=>x.depth-$.depth);for(let x of cn){let $=y/J*.9,X=Et[x.color]||null,k=1,O=1,Q=1,P=1,F=`${x.y},${x.s}`,it=Kt&&Kt.has(F);it&&(k=Ve,O=re),vn!==null&&!it&&(x.color!==vn?(Q=Jt,P=te):P=be),Ot(E,x.yScr,v,C,x.s,Y,$,st,k,X,Q,null,0,P,O)}if(an&&ae.length>0&&!Cn){let x=(performance.now()-Pe)/1e3,X=Math.min(1,x/(Ce?V:h)),k=1-T,O=X>k,Q=O?(X-k)/T:0,P=Ce?Math.floor(X*k*j*2)%j:-1,F=4+X/k*10,it=Math.sin(x*F*Zt),It=O?1:.5+it*.5,yt=O?1-Q*.8:1,bt=O?1-Q:1;for(let mt of ae){let kt=Pt(N,y,mt.y+.5),le=Vt(E,kt,v,C,mt.s,Y);if(Math.sin(le.ang)<-.1)continue;let un=y/J*.9,Gt,Dt,Ht;if(Ce){let Oe=(mt.s-P+j)%j,he=Oe<4?1-Oe/4:0;Gt=O?bt:.3+he*.7,Dt=`rgba(255, 159, 67, ${Gt})`,Ht=O?yt:1+he*.2}else Gt=It*bt,Dt=mt.isLine?`rgba(255, 255, 255, ${Gt*.7})`:`rgba(255, 220, 100, ${Gt*.6})`,Ht=O?yt:1.15;Ot(E,kt,v,C,mt.s,Y,un,Dt,1,null,1,null,0,1,Ht)}}let{transmuteState:rn,transmuteSourceBlock:We,transmuteTargetColor:ln,transmuteAreaCells:_n,transmuteBlocksToChange:Te}=I;if(rn==="selecting_source"){let x=y/J*.9,$=.35+Math.sin(A/150)*.15;for(let X of cn){let k=Pt(N,y,X.y+.5);Ot(E,k,v,C,X.s,Y,x,`rgba(0, 40, 20, ${$})`,1,null,1,null,0,1,1)}}if(rn==="selecting_target"&&Te&&Te.length>0){let x=y/J*.9,$=.4+Math.sin(A/120)*.25,X=.6+Math.sin(A/120)*.4;for(let k of Te){if(k.y<0||k.y>=J)continue;let O=Pt(N,y,k.y+.5),Q=Vt(E,O,v,C,k.s,Y);Math.sin(Q.ang)<-.1||(Ot(E,O,v,C,k.s,Y,x,`rgba(0, 50, 30, ${$})`,1,null,1,null,0,1,1),Ot(E,O,v,C,k.s,Y,x,"transparent",1,null,1,`rgba(100, 255, 150, ${X})`,3,1,1.02))}}if(rn==="animating"&&Lt.getTransmuteAnimState){let x=Lt.getTransmuteAnimState(A);if(x){let $=y/J*.9,{phase:X,progress:k,areaFlash:O}=x;if(O>0&&_n)for(let Q of _n){if(Q.y<0||Q.y>=J)continue;let P=Pt(N,y,Q.y+.5),F=Vt(E,P,v,C,Q.s,Y);Math.sin(F.ang)<-.1||Ot(E,P,v,C,Q.s,Y,$,`rgba(150, 255, 200, ${O*.4})`,1,null,1,null,0,1,1)}if(Te&&Te.length>0){let Q=We?We.color:1,P=ln||1;for(let F of Te){if(F.y<0||F.y>=J)continue;let it=Pt(N,y,F.y+.5),It=Vt(E,it,v,C,F.s,Y);if(Math.sin(It.ang)<-.1)continue;let bt=1,mt=Et[Q],kt=0;if(X==="shrink"?(bt=1-k*.95,mt=Et[Q],kt=.5+k*.3):X==="grow"&&(bt=k,mt=Et[P],kt=.8-k*.5),kt>0&&Ot(E,it,v,C,F.s,Y,$,`rgba(200, 255, 220, ${kt})`,1,null,1,null,0,1,1),bt>.05){let le=Mn(E,it,v,C,F.s,Y,$,1),Ke=Math.min(le.wApprox,le.hApprox)*.28*bt;d.save(),d.globalAlpha=1,d.fillStyle=mt,d.beginPath(),d.arc(le.cx,le.cy,Ke,0,Zt),d.fill(),d.restore()}}}}}let{activePiece:pe,pieceY:qn,isGrounded:zn,lockTimer:Bn}=I;if(pe){let x=Lt.snappedRot(),$=x,X=Lt.computeGhostY(),k=y/J*.9;if(X!==null){let P=[];for(let F=0;F<pe.cells.length;F++){let it=pe.cells[F],It=pe.colors[F],yt=X+it.y,bt=Lt.normSector(x+it.x);if(yt<0||yt>=J)continue;let mt=Pt(N,y,yt+.5),kt=Vt(E,mt,v,C,bt,$);P.push({cy:yt,cs:bt,yScr:mt,depth:Math.sin(kt.ang),color:It})}P.sort((F,it)=>F.depth-it.depth);for(let F of P){let it=Et[F.color]||null;Ot(E,F.yScr,v,C,F.cs,$,k,xe,1,it,.5,me,jt,1,1)}}let O=ft;if(zn&&Bn>0){let P=Math.min(1,Bn/Z),F=255,it=Math.round(170+85*P),It=Math.round(180+75*P),yt=.75+(1-.75)*P;O=`rgba(${F},${it},${It},${yt})`}let Q=[];for(let P=0;P<pe.cells.length;P++){let F=pe.cells[P],it=pe.colors[P],It=Lt.normSector(x+F.x),yt=qn+F.y;if(yt<0||yt>=J)continue;let bt=Pt(N,y,yt+.5),mt=Vt(E,bt,v,C,It,$);Q.push({cs:It,yScr:bt,depth:Math.sin(mt.ang),color:it})}Q.sort((P,F)=>P.depth-F.depth);for(let P of Q){let F=Et[P.color]||null;Ot(E,P.yScr,v,C,P.cs,$,k,O,1,F,1,null,0,1,1)}}},drawNextPreview(R,A){if(!R)return;let I=R.getContext("2d"),_=R.width,M=R.height;if(I.clearRect(0,0,_,M),!A)return;let E=1/0,q=-1/0,z=1/0,L=-1/0;for(let C of A.cells)E=Math.min(E,C.x),q=Math.max(q,C.x),z=Math.min(z,C.y),L=Math.max(L,C.y);let nt=q-E+1,v=L-z+1,y=Math.min(_/(nt+.5),M/(v+.5)),N=(_-nt*y)/2,Tt=(M-v*y)/2;I.fillStyle=st;for(let C=0;C<A.cells.length;C++){let tt=A.cells[C],Y=N+(tt.x-E)*y,Mt=Tt+(v-1-(tt.y-z))*y;I.fillRect(Y+1,Mt+1,y-2,y-2);let Rt=A.colors[C],Wt=Et[Rt];if(Wt){let ut=(y-2)*.32;I.fillStyle=Wt,I.beginPath(),I.arc(Y+y/2,Mt+y/2,ut,0,Zt),I.fill(),I.fillStyle=st}}},spawnBonusBubbles(R){let{left:A,right:I,h:_,w:M}=Je;M>0&&Fe(R,A,I,_,M)}}}(()=>{let e=Zs(),n=e.canvas,l=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,c=30,s=24,a=120,r={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let o=r[t]||r["30_24"];c=o.N,s=o.H,a=o.survivalTime}function f(){return s/a}let g=Math.PI/2,h=70,T=120,G=30,V=320,Z=.42,ot="rgb(235,240,250)",Et="rgb(55,62,75)",de="rgba(255,170,180,0.75)",st="rgba(110,255,150,0.15)",W="rgba(110,255,150,0.85)",ft=2,xe={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},me={1:"fire",2:"water",3:"lightning",4:"earth"},jt={fire:1,water:2,lightning:3,earth:4},Jt=1,te=.58,be=!0,Yt=12,wt=25,Lt=1,d=2,j=3,J=5,ge=8,$t=10,Ie=15,Fe=30,Sn=2,Yn=.3,Je=.5,Pt=1,tn=.3,Ue=.5,En=1.3,en=10,Vt=500,Mn=[1,1.25,1.5,1.75,2],Ot=10,Vn=100,Wn=25,Kn=5,R=8,A=.35,I=[1,1.3,1.6,2],_=[1,1.5,2,2.5],M=Qs(),E=M.loadGameSettings(),q=E.invertSwipe?-1:1,z=-1,L=Array.from({length:s},()=>new Uint8Array(c));function nt(){L=Array.from({length:s},()=>new Uint8Array(c))}let v=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,N=s+3,Tt=0,C=0,tt=!1,Y=0,Mt=0,Rt=0,Wt=3,ut=0,ee=0,ve=0,dt=oo({canvas:n,rotDir:q}),nn="0.14.3",xn=!0,_t="blue",S=Vs();S.preload();let ht=io(),et="intro",At=0,ie=0,ne=0,Xe=0,sn=0,fe=null,K=ht.stats,on=e.overlay,we=Js({elementColors:xe}),xt=we.showBonus.bind(we),bn=we.getElementIcon.bind(we),Ye=eo(),hs=e.overlayTitle,ys=e.overlayStats,ce=e.startBtn,cn=e.hud,vn=e.scoreHud,an=e.timeHud,ae=e.remainingHud,Pe=e.nextCanvas,Cn=Pe.getContext("2d"),Kt=e.pauseBtn,re=e.pauseOverlay,Ve=e.resumeBtn,Tn=e.restartBtn,Ce=e.exitToMenuBtn,rn=e.pauseSettingsBtn,We=e.pauseSoundBtn,ln=e.pauseMusicBtn,_n=e.pauseBestScore,Te=e.pauseBestTime,pe=e.pauseBestMode,qn=e.pauseCurrentScore,zn=e.pauseCurrentTime,Bn=e.pauseCurrentMode,x=e.confirmDialog,$=e.confirmText,X=e.confirmCancel,k=e.confirmOk,O=e.settingsOverlay,Q=e.settingsClose,P=e.fullscreenBtn,F=e.rotateBtn,it=e.startPanel,It=e.gameoverPanel,yt=e.goScore,bt=e.goTime,mt=e.goRing,kt=e.goMatches,le=e.goBonuses,Ke=e.goNewRecord,un=e.goRestartBtn,Gt=e.goExitBtn,Dt=e.bestScore,Ht=e.bestTimeVal,Oe=e.startVersion,he=e.modeBtns,yo=e.recordsBtn,So=e.startSettingsBtn,Eo=e.helpBtn,Nt="25_20",Ft=no({buttons:e.magicBtns,onActivate:()=>S.play("spells")}),Qn=e.magicBtns,yi=Ft.charges,Mo=t=>Ft.select(t),Zn=()=>Ft.updateButtons(),dn=e.spellWave;function xo(){dn&&(dn.classList.remove("active"),dn.offsetWidth,dn.classList.add("active"),setTimeout(()=>dn.classList.remove("active"),1200))}let se=so({button:e.spellBtn,onActivate:t=>{if(t==="ice"){let o=se.effect;Rt+=o.duration*f(),S.play("wsseffect"),xt(`\u{1F4A7} -${o.duration}s`,"time"),xo(),Ye.spawnSpellBubbles(se.button,o.duration),Qe.spawnBonusBubbles(o.duration)}},onReady:()=>{S.play("readysuper")}});se.initButton(()=>{if(et==="playing"&&se.canUse()){if(se.currentSpell==="earth"){Ut==="idle"?vo():fn();return}se.use()}});function Ss(){return Nt==="30_24"}function Ln(){let t=e.spellBtn;t&&(t.style.display=Ss()?"":"none")}let ye=[],mn=0,Se=!1,ke=!1,gn=!1,qt=0,ue=0,Ee=0,qe=[],Ut="idle",Me=null,De=null,He=[],_e=[],jn=0,ze=null;function $e(t,o,i){let p=1-i/s;return t+p*o}function Rn(t,o,i,p,B,b){let w=(B-b)/c*u+g;return{x:t+Math.cos(w)*i,y:o+Math.sin(w)*p,ang:w}}function Es(t,o){let i=n.clientWidth,p=n.clientHeight,B=i*.5,b=(i-2*G)/2,w=p-h-T,ct=6,St=c*w/(ct*s),zt=p-T,at,D,H;St<=Math.min(b,V)?(at=St,D=w,H=h):(at=Math.min(b,V),D=at*ct*s/c,H=zt-D);let U=at*.28,rt=$e(H,D,t+.5),gt=Rn(B,rt,at,U,o,ut),pt=n.getBoundingClientRect();return{x:pt.left+gt.x,y:pt.top+gt.y}}function bo(t,o){if(!Ft.canUse()||Se)return!1;let i=jt[Ft.active],p=n.clientWidth,B=n.clientHeight,b=p*.5,w=(p-2*G)/2,ct=B-h-T,St=6,zt=c*ct/(St*s),at=B-T,D,H,U;zt<=Math.min(w,V)?(D=zt,H=ct,U=h):(D=Math.min(w,V),H=D*St*s/c,U=at-H);let rt=D*.28,gt=null,pt=1/0;for(let vt=0;vt<s;vt++){let Bt=$e(U,H,vt+.5);for(let Ct=0;Ct<c;Ct++){let Re=L[vt][Ct];if(!Re||Re!==i)continue;let oe=Rn(b,Bt,D,rt,Ct,ut);if(Math.sin(oe.ang)<-.1)continue;let Xt=t-oe.x,Ze=o-oe.y,Qt=Math.hypot(Xt,Ze),Ae=H/s*.9,ds=Ae*1.2;Math.abs(Xt)<ds/2&&Math.abs(Ze)<Ae/2&&Qt<pt&&(pt=Qt,gt={y:vt,s:Ct})}}if(gt){let vt=$e(U,H,gt.y+.5),Bt=Rn(b,vt,D,rt,gt.s,ut),Ct=n.getBoundingClientRect(),Re=Ct.left+Bt.x,oe=Ct.top+Bt.y,Ne=Qn[Ft.active];return Ye.spawnMagicShot(Ft.active,Ne,Re,oe,()=>{let Xt=L[gt.y][gt.s];ye=[{y:gt.y,s:gt.s,color:Xt,isLine:!1,isMagic:!0}],mn=performance.now(),Se=!0,ke=!0,qt=0,ue=Wn,xt(`+${Wn}`,"score")}),Ee=0,Ft.useCharge(),K.magicUsed++,!0}return!1}function vo(){Ut="selecting_source",Me=null,De=null,He=[],_e=[],Ft.deactivate(),S.play("ulta");let t=e.spellBtn;t&&t.classList.add("selecting")}function fn(){Ut!=="idle"&&S.play("cancel"),Ut="idle",Me=null,De=null,He=[],_e=[],An();let t=e.spellBtn;t&&t.classList.remove("selecting")}function Co(t,o){if(Ut!=="selecting_source")return!1;let i=To(t,o);if(!i)return fn(),!0;Me={y:i.y,s:i.s,color:L[i.y][i.s]},He=Ro(i.y,i.s,Kn);let p=Me.color,B=He.filter(b=>L[b.y][b.s]===p);return _e=Ao(B,i.y,i.s,R),_o(Me.color,i.y),Ut="selecting_target",!0}function To(t,o){let i=n.clientWidth,p=n.clientHeight,B=i*.5,b=(i-2*G)/2,w=p-h-T,ct=6,St=c*w/(ct*s),zt=p-T,at,D,H;St<=Math.min(b,V)?(at=St,D=w,H=h):(at=Math.min(b,V),D=at*ct*s/c,H=zt-D);let U=at*.28,rt=null,gt=1/0;for(let pt=0;pt<s;pt++){let vt=$e(H,D,pt+.5);for(let Bt=0;Bt<c;Bt++){if(!L[pt][Bt])continue;let Ct=Rn(B,vt,at,U,Bt,ut);if(Math.sin(Ct.ang)<-.1)continue;let oe=t-Ct.x,Ne=o-Ct.y,Xt=Math.hypot(oe,Ne),Ze=D/s*.9,Qt=Ze*1.2;Math.abs(oe)<Qt/2&&Math.abs(Ne)<Ze/2&&Xt<gt&&(gt=Xt,rt={y:pt,s:Bt})}}return rt}function _o(t,o){An();let i=document.createElement("div");i.className="transmute-popup";let p=n.clientWidth,B=n.clientHeight,b=(p-2*G)/2,w=B-h-T,ct=6,St=c*w/(ct*s),zt=B-T,at,D;St<=Math.min(b,V)?(at=w,D=h):(at=Math.min(b,V)*ct*s/c,D=zt-at);let H=$e(D,at,o+.5),U=Math.floor(Kn/2),rt=$e(D,at,Math.min(s,o+U)+.5),gt=$e(D,at,Math.max(0,o-U)+.5),pt=D+at/2,vt=document.getElementById("gameContainer"),Bt=vt?vt.getBoundingClientRect():{width:window.innerWidth,left:0},Ct=160,Re=60,oe=20,Ne=Bt.left+Bt.width/2-Ct/2,Xt;H<pt?Xt=Bt.top+gt+oe:Xt=Bt.top+rt-Re-oe,Xt=Math.max(10,Math.min(window.innerHeight-Re-10,Xt)),i.style.left=`${Ne}px`,i.style.top=`${Xt}px`,[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}].filter(Qt=>Qt.color!==t).forEach(Qt=>{let Ae=document.createElement("button");Ae.className=`transmute-btn ${Qt.name}`,Ae.innerHTML=Qt.icon,Ae.setAttribute("data-color",Qt.color),Ae.addEventListener("click",ds=>{ds.stopPropagation(),Bo(Qt.color)}),i.appendChild(Ae)}),document.body.appendChild(i),ze=i,Ms=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",xs)},50)}let Ms=0;function xs(t){performance.now()-Ms<200||ze&&!ze.contains(t.target)&&fn()}function An(){document.removeEventListener("pointerdown",xs),ze&&(ze.remove(),ze=null)}function Bo(t){An(),De=t,se.use(),Lo()}function Lo(){if(!Me){fn();return}if(_e.length===0){fn();return}let t=e.spellBtn;t&&t.classList.remove("selecting"),Ut="animating",jn=performance.now(),S.play("esseffect")}function Ro(t,o,i){let p=[],B=Math.floor(i/2);for(let b=-B;b<=B;b++)for(let w=-B;w<=B;w++){let ct=t+b,St=wn(o+w);if(ct<0||ct>=s)continue;let zt=b*b+w*w;p.push({y:ct,s:St,distSq:zt})}return p}function Ao(t,o,i,p){return[...t].sort((b,w)=>b.distSq!==w.distSq?b.distSq-w.distSq:b.y!==w.y?b.y-w.y:b.s-w.s).slice(0,p).map(b=>({y:b.y,s:b.s}))}function Io(t){if(Ut!=="animating")return!1;let o=(t-jn)/1e3;return Math.min(o/A,1)>=1?(Po(),!1):!0}function wo(t){if(Ut!=="animating")return null;let o=(t-jn)/1e3,i=Math.min(o/A,1),p="flash",B=0,b=0;return i<.15?(p="flash",b=1-i/.15):i<.55?(p="shrink",B=(i-.15)/.4):(p="grow",B=(i-.55)/.45),{phase:p,progress:B,areaFlash:b}}function Po(){for(let t of _e)L[t.y][t.s]=De;Ut="idle",Me=null,De=null,He=[],_e=[],Ee=0,In()}let Si=100;function Ei(t,o){return fs(t,o,s,c)}function Oo(){return ro(L,s,c)}let ko=lo;function Do(t){let o=t.map(p=>({...p,color:L[p.y][p.s]}));for(let p of t)L[p.y][p.s]=0;let i=s;for(let p of t){let B=p.y;for(let b=1;b<=p.y;b++){let w=p.y-b;if(L[w][p.s]){B=b-1;break}}i=Math.min(i,B)}for(let p of o)L[p.y-i][p.s]=p.color;return i>0}function Ho(){let t=!0;for(;t;){t=!1;let o=Oo();for(let i of o)ko(i)||Do(i)&&(t=!0)}}function $o(){In()}let Jn=co;function bs(t,o){let i=new Map,p=0,B=0,b=0,w={},ct=t.length+o.length;for(let H of t){let U=me[H.color],rt=0,gt=0;if(H.length>=5?(rt=j,gt=$t,K.lines5++):H.length===4?(rt=d,gt=ge,K.lines4++):H.length===3&&(rt=Lt,gt=J,K.lines3++),U&&rt>0){Ft.addCharges(U,rt),w[U]=(w[U]||0)+rt;let pt=H.cells[Math.floor(H.cells.length/2)],vt=Es(pt.y,pt.s),Bt=Qn[U];for(let Ct=0;Ct<rt;Ct++)setTimeout(()=>{Ye.spawnMagicOrb(U,vt.x,vt.y,Bt)},Ct*100)}p+=gt*f(),b+=gt,B+=H.length*Ot;for(let pt of H.cells){let vt=`${pt.y},${pt.s}`;i.has(vt)||i.set(vt,{y:pt.y,s:pt.s,color:H.color,isLine:!0})}}for(let H of o){if(K.pairs++,p+=Ie*f(),b+=Ie,B+=Vn,Ss()&&se.addProgress(1)){let U=H.cells[Math.floor(H.cells.length/2)],rt=Es(U.y,U.s);Ye.spawnSpellOrb(rt.x,rt.y,se.button)}for(let U of H.cells){let rt=`${U.y},${U.s}`;i.has(rt)||i.set(rt,{y:U.y,s:U.s,color:L[U.y][U.s],isLine:!1})}}let St=Jn(I,ct-1),zt=Jn(_,Ee),at=Math.round(B*St*zt),D=0;ct>1&&(K.combos++,K.maxCombo=Math.max(K.maxCombo,ct),setTimeout(()=>xt(`COMBO \xD7${ct}`,"combo"),D),D+=180,S.play("combo2")),Ee>0&&(K.cascades++,K.maxCascade=Math.max(K.maxCascade,Ee),setTimeout(()=>xt(`CASCADE \xD7${Ee}`,"cascade"),D),D+=180,S.play("cascade")),(t.length>0||o.length>0)&&S.play("combo");for(let H of t){let U=H.length,rt=U*Ot;setTimeout(()=>xt(`Line-${U} +${rt}`,"line",H.color),D),D+=100}for(let H of o){let U=H.cells.length>0?L[H.cells[0].y][H.cells[0].s]:null;setTimeout(()=>xt(`Pair +${Vn}`,"pair",U),D),D+=100}at>0&&(setTimeout(()=>xt(`+${at}`,"score"),D),D+=120),b>0&&(setTimeout(()=>xt(`+${b}s`,"time"),D),D+=120);for(let[H,U]of Object.entries(w))U>0&&(setTimeout(()=>xt(`+${U}${bn(H)}`,"charge"),D),D+=120);ye=Array.from(i.values()),mn=performance.now(),Se=!0,ke=!1,qt=p,ue=at,Zn()}function Go(){for(let t of ye)L[t.y][t.s]=0;if(ye.length>0&&S.playRandom("disappear"),qt>0){Rt+=qt;let t=qt/f();Qe.spawnBonusBubbles(t)}ht.addScore(ue),At+=ue,Dn(),ye=[],Se=!1,ke=!1,qt=0,ue=0,Ee++,In()}function In(){Ho();let{lineMatches:t,pairMatches:o}=zo();if(t.length>0||o.length>0)bs(t,o);else{let i=Ls();i.length>0?Wo(i):!y&&et==="playing"&&Bs()}}function Mi(t,o){bs(t,o)}function wn(t){return je(t,c)}function Pn(){return wn(Math.round(ut))}function vs(t,o){return ps(y,t,o,L,s,c)}function On(t){return vs(t,Pn())}let kn=ao;function Cs(){be&&(Yt!==0&&Y>=Yt||(C=0,Y+=1))}function No(){if(!y)return;let t=y.cells,o=y.colors,i={cells:t,colors:o};if(z>=0||(i=kn(i.cells,i.colors),i=kn(i.cells,i.colors)),i=kn(i.cells,i.colors),y.cells=i.cells,y.colors=i.colors,!On(Math.floor(N))){y.cells=t,y.colors=o;return}S.play("turn"),tt&&Cs()}function Fo(){return uo(y,N,Pn(),L,s,c)}function Uo(){if(!y)return!1;let t=Math.floor(N)-1,o=!On(t);return o&&!tt?(tt=!0,C=0,Y=0):!o&&tt&&(tt=!1,C=0,Y=0),o}let Ge=Xn;function pn(){if(et==="playing"){on.classList.add("hidden"),Kt.classList.remove("hidden");return}if(on.classList.remove("hidden"),Kt.classList.add("hidden"),et==="intro"){it.classList.remove("hidden"),It.classList.add("hidden");let t=M.loadHighscore(Nt);t.score>0?(Dt.textContent=t.score.toLocaleString(),Ht.textContent=Ge(t.time)):(Dt.textContent="0",Ht.textContent="0:00"),Fs(),Oe.textContent=`v${nn}`,ce.classList.remove("idlePulse"),ce.offsetWidth,ce.classList.add("idlePulse")}else{it.classList.add("hidden"),It.classList.remove("hidden"),yt.textContent=At.toLocaleString(),bt.textContent=Ge(ne);let t=M.loadHighscore(Nt);At>0&&At>=t.score?Ke.classList.remove("hidden"):Ke.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${K.rings}</span>
          <span class="count ring-max">${K.maxRing>0?"max \xD7"+K.maxRing:""}</span>
        </div>
      `;mt.innerHTML=o;let i=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${K.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${K.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${K.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${K.pairs}</span>
        </div>
      `;kt.innerHTML=i;let p=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${K.combos}</span>
          <span class="count max-combo">${K.maxCombo>0?"max \xD7"+K.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${K.cascades}</span>
          <span class="count max-cascade">${K.maxCascade>0?"max \xD7"+K.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${K.magicUsed}</span>
        </div>
      `;le.innerHTML=p}}function Dn(){vn.textContent=`Score: ${At}`}function ts(){an.textContent=`Time: ${Ge(ne)}`}function Ts(){let t=Math.max(0,(s-Mt)/f()),o=Math.floor(t/60),i=Math.floor(t%60);ae.textContent=`Left: ${o}:${i.toString().padStart(2,"0")}`,t<30?ae.classList.add("warning"):ae.classList.remove("warning")}function Xo(){m(Nt),nt(),Mt=0,Rt=0,ut=ee=0,ve=0,ht.start(),K=ht.stats,At=0,ie=performance.now(),ne=0,sn=0,Xe=0,et="playing",fe=null,Ft.reset(),se.reset(),Ln(),ye=[],qe=[],Se=!1,ke=!1,gn=!1,qt=0,ue=0,Ee=0,Ut="idle",Me=null,De=null,He=[],_e=[],An(),Zn(),Dn(),ts(),Ts(),Bs(),Qe.drawNextPreview(Pe,fe),pn(),S.getSettings().musicEnabled&&S.startGameMusic()}function es(){ht.gameOver(),et="gameover",y=null,tt=!1,C=0,Y=0;let t=M.saveHighscore(At,ne,Nt);S.stopMusic(),S.play("gameover"),ts(),pn(),t&&At>0&&setTimeout(()=>{xt("\u{1F3C6} NEW RECORD!","score")},500)}function Yo(t){for(let i=0;i<50;i++){let p=t.map(()=>1+(Math.random()*4|0));if(!Vo(t,p))return p}return t.map((i,p)=>1+p%4)}let Vo=fo;function _s(t){let o=t.cells.map(p=>({x:p.x,y:p.y})),i=Yo(o);return{name:t.name,cells:o,colors:i}}function Bs(){if(!fe){let B=v[Math.random()*v.length|0];fe=_s(B)}y=fe;let t=v[Math.random()*v.length|0];fe=_s(t),Qe.drawNextPreview(Pe,fe);let o=1/0,i=-1/0;for(let B of y.cells)B.x<o&&(o=B.x),B.x>i&&(i=B.x);let p=(o+i)/2;for(let B of y.cells)B.x=B.x-Math.round(p);N=s+3,Tt=0,tt=!1,C=0,Y=0,On(Math.floor(N))?S.playRandom("appear"):es()}function Ls(){return go(L,s,c)}function Wo(t){if(t.length===0)return;let o=[];for(let ct of t)for(let St=0;St<c;St++)o.push({y:ct,s:St,color:L[ct][St],isLine:!1});qe=t,ye=o,mn=performance.now(),Se=!0,gn=!0,ke=!1;let i=t.length;K.rings+=i,K.maxRing=Math.max(K.maxRing,i);let p=Jn(Mn,i-1),B=Math.round(Vt*i*p),b=Fe*i;ue=B,qt=b*f(),S.play("ring");let w=`RING \xD7${i}`;xt(w,"ring"),setTimeout(()=>xt(`+${B}`,"score"),150),setTimeout(()=>xt(`+${b}s`,"time"),300)}function Ko(){let t=[...qe].sort((o,i)=>i-o);for(let o of t){for(let i=o;i<s-1;i++)L[i].set(L[i+1]);L[s-1].fill(0)}if(qt>0){Rt+=qt;let o=qt/f();Qe.spawnBonusBubbles(o)}ht.addScore(ue),At+=ue,Dn(),Nt==="30_24"&&qe.length>0&&(Le=M.addHighTowerRings(qe.length)),ye=[],qe=[],Se=!1,gn=!1,qt=0,ue=0,In()}function xi(){return Ls().length}function qo(){if(!y)return;let t=Pn();ut=t,ee=t,ve=0;let o=!1;for(let i=0;i<y.cells.length;i++){let p=y.cells[i],B=y.colors[i],b=Math.floor(N)+p.y,w=wn(t+p.x);b>=s&&(o=!0),b>=0&&b<s&&(L[b][w]=B)}if(o){es();return}ht.addScore(en),At+=en,Dn(),xt(`+${en}`,"score"),S.playRandom("drop"),y=null,Ee=0,$o()}function zo(){return mo(L,s,c)}function Qo(){if(!y)return!1;let t=Math.floor(N)-1;return On(t)?(N=t,tt=!1,C=0,Y=0,!0):(tt=!0,!1)}n.addEventListener("pointerdown",t=>{if(lt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),i=t.clientX-o.left,p=t.clientY-o.top;dt.handlePointerDown(t,{onMagicTap:()=>Ut==="selecting_source"?Co(i,p):lt.applyCommand("magic_shoot",{x:i,y:p}),onDoubleTap:()=>lt.applyCommand("rotate_piece")},ee)||(ve=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(lt.state!=="playing"||!dt.dragging)return;t.preventDefault?.();let o=dt.handlePointerMove(t,{canRotateTo:(i,p)=>lt.canRotateTo(i,p),onDrop:()=>lt.applyCommand("move_down"),onGroundedMove:()=>lt.onGroundedMove()},lt.pieceY,lt.isGrounded);o&&lt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{lt.state==="playing"&&dt.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{dt.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{dt.dragging&&dt.handlePointerUp(t)},{passive:!1}),F.addEventListener("click",()=>{lt.state==="playing"&&lt.applyCommand("rotate_piece")});let Hn=e.dropBtn,$n=null;function Zo(){lt.state==="playing"&&(lt.applyCommand("move_down"),$n=setInterval(()=>{if(lt.state!=="playing"){Gn();return}lt.applyCommand("move_down")},wt))}function Gn(){$n&&(clearInterval($n),$n=null)}Hn.addEventListener("pointerdown",t=>{t.preventDefault(),Zo()}),Hn.addEventListener("pointerup",Gn),Hn.addEventListener("pointerleave",Gn),Hn.addEventListener("pointercancel",Gn);for(let[t,o]of Object.entries(Qn))o.addEventListener("click",()=>{lt.state==="playing"&&lt.applyCommand("select_magic",{element:t})});let ns=e.soundsToggle,ss=e.musicToggle;function Be(){let t=S.getSettings();t.soundsEnabled?ns.classList.add("active"):ns.classList.remove("active"),t.musicEnabled?ss.classList.add("active"):ss.classList.remove("active");for(let o=0;o<=4;o++){let i=e.soundVolBtns[o],p=e.musicVolBtns[o];i&&i.classList.toggle("active",t.soundVolume===o),p&&p.classList.toggle("active",t.musicVolume===o)}}let Rs=e.tabBtns,jo=e.tabContents;Rs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;Rs.forEach(i=>i.classList.remove("active")),jo.forEach(i=>i.classList.remove("active")),t.classList.add("active"),js(o).classList.add("active"),o==="sounds"&&Be()})});let As=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Is=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Jo=e.iosHint,ti=e.standaloneBadge;function ws(){let t=document.fullscreenElement||document.webkitFullscreenElement;P.textContent=t?"Disable":"Enable"}As&&(Is?(ti.style.display="block",P.style.display="none"):(Jo.style.display="block",P.textContent="Not supported",P.style.opacity="0.5",P.style.cursor="default")),P.addEventListener("click",()=>{if(As&&!Is)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",ws),document.addEventListener("webkitfullscreenchange",ws);let Nn=e.invertSwipeToggle;E.invertSwipe&&Nn.classList.add("active"),Nn.addEventListener("click",()=>{Nn.classList.toggle("active");let t=Nn.classList.contains("active");dt.rotDir=t?-1:1,E.invertSwipe=t,M.saveGameSettings(E)});let Ps=e.diffBtns;Ps.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(Ps.forEach(o=>{o.classList.remove("active");let i=o.querySelector(".check-icon");i&&i.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let o=document.createElement("span");o.className="check-icon",o.textContent="\u2713",t.appendChild(o)}})}),ns.addEventListener("click",()=>{let o=!S.getSettings().soundsEnabled;S.updateSettings({soundsEnabled:o}),Be(),hn()}),ss.addEventListener("click",()=>{let o=!S.getSettings().musicEnabled;S.updateSettings({musicEnabled:o}),Be(),hn(),et!=="paused"&&(o?et==="playing"?S.startGameMusic():S.startMenuMusic():S.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{S.updateSettings({soundVolume:t}),Be(),S.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{S.updateSettings({musicVolume:t}),Be()})}Be();function Os(){et==="playing"&&(ht.pause(),Xe=performance.now(),et="paused",S.musicAudio&&S.musicAudio.pause())}function Fn(){et==="paused"&&(ht.resume(),sn+=performance.now()-Xe,Xe=0,et="playing",cs=performance.now(),S.getSettings().musicEnabled&&S.startGameMusic())}function hn(){let t=S.getSettings();We.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",We.classList.toggle("off",!t.soundsEnabled),ln.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",ln.classList.toggle("off",!t.musicEnabled)}function ei(){re.classList.remove("hidden"),Kt.classList.add("hidden");let t=M.loadHighscore(Nt);_n.textContent=t.score?t.score.toLocaleString():"0",Te.textContent=t.time?Xn(t.time):"0:00",pe.textContent=Nt==="30_24"?"High Tower":"Quick Tower",qn.textContent=At.toLocaleString(),zn.textContent=Xn(ne),Bn.textContent=Nt==="30_24"?"High Tower":"Quick Tower",hn()}function yn(){re.classList.add("hidden"),Kt.classList.remove("hidden")}Kt.addEventListener("click",()=>{Os(),ei()}),Ve.addEventListener("click",()=>{yn(),Fn()});let os=null;function ks(t,o){$.textContent=t,os=o,x.classList.remove("hidden")}function Ds(){x.classList.add("hidden"),os=null}X.addEventListener("click",()=>{Ds()}),k.addEventListener("click",()=>{let t=os;Ds(),t&&t()}),Tn.addEventListener("click",()=>{ks("Restart game?",()=>{yn(),lt.applyCommand("start_game")})}),Ce.addEventListener("click",()=>{ks("Exit to menu?",()=>{yn(),Kt.classList.add("hidden"),et="intro",ht.reset(),S.stopMusic(),S.getSettings().musicEnabled&&S.startMenuMusic(),pn()})}),rn.addEventListener("click",()=>{O.classList.remove("hidden")}),We.addEventListener("click",()=>{let t=S.getSettings();S.updateSettings({soundsEnabled:!t.soundsEnabled}),hn(),Be()}),ln.addEventListener("click",()=>{let o=!S.getSettings().musicEnabled;S.updateSettings({musicEnabled:o}),hn(),Be()}),re.addEventListener("click",t=>{t.target===re&&(yn(),Fn())}),document.addEventListener("keydown",t=>{et==="paused"&&!re.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(yn(),Fn())}),Q.addEventListener("click",()=>{O.classList.add("hidden")}),O.addEventListener("click",t=>{t.target===O&&O.classList.add("hidden")});let is=!1;document.addEventListener("visibilitychange",()=>{document.hidden?et==="playing"&&(Os(),is=!0):is&&et==="paused"&&(Fn(),is=!1)});let lt=po({getN:()=>c,getH:()=>s,FALL_INTERVAL:Jt,LOCK_DELAY_SEC:te,getKillRate:f,MATCH_HIGHLIGHT_SEC:Sn,MAGIC_SHRINK_SEC:Je,RING_HIGHLIGHT_SEC:Pt,getState:()=>({gameState:et,score:At,elapsedMs:ne,startTime:ie,totalPausedMs:sn,stats:K,activePiece:y,pieceY:N,targetRot:ee,rotFloat:ut,rotVel:ve,isGrounded:tt,isHighlighting:Se,isMagicAnimation:ke,isRingAnimation:gn,highlightStartTime:mn,killLevel:Mt,grid:L,fallTimer:Tt,lockTimer:C}),setState:t=>{"elapsedMs"in t&&(ne=t.elapsedMs),"killLevel"in t&&(Mt=t.killLevel),"fallTimer"in t&&(Tt=t.fallTimer),"lockTimer"in t&&(C=t.lockTimer),"targetRot"in t&&(ee=t.targetRot),"rotFloat"in t&&(ut=t.rotFloat),"rotVel"in t&&(ve=t.rotVel)},funcs:{startGame:Xo,endGame:es,rotatePieceByDir:No,tryMoveDown:Qo,canPlaceAtRot:vs,maybeResetLockDelay:Cs,shootMagic:bo,selectMagic:Mo,updateGroundedState:Uo,lockPiece:qo,finishHighlight:Go,finishRingHighlight:Ko},ui:{updateTimeHud:ts,updateRemainingHud:Ts}}),Qe=ho({canvas:n,canvasCtx:l,getN:()=>c,getH:()=>s,TOP_PAD_PX:h,BOTTOM_PAD_PX:T,SIDE_MARGIN_PX:G,MAX_RADIUS_X:V,RADIUS_X_FACTOR:Z,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:Sn,MATCH_SHRINK_PHASE:Yn,MAGIC_SHRINK_SEC:Je,RING_HIGHLIGHT_SEC:Pt,LOCK_DELAY_SEC:te,getKillRate:f,ELEMENT_COLORS:xe,ELEMENT_TO_COLOR:jt,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:Et,ACTIVE_COLOR_FRONT:de,GHOST_COLOR_FILL:st,GHOST_COLOR_STROKE:W,GHOST_STROKE_WIDTH:ft,MAGIC_DIM_DOT_ALPHA:tn,MAGIC_DIM_DOT_SCALE:Ue,MAGIC_TARGET_DOT_SCALE:En,getState:()=>({gameState:et,grid:L,activePiece:y,pieceY:N,rotFloat:ut,killLevel:Mt,isHighlighting:Se,highlightedCells:ye,highlightStartTime:mn,isMagicAnimation:ke,isRingAnimation:gn,isGrounded:tt,lockTimer:C,transmuteState:Ut,transmuteSourceBlock:Me,transmuteTargetColor:De,transmuteAreaCells:He,transmuteBlocksToChange:_e}),getVisualSettings:()=>({waterBubbles:xn,waterColor:_t}),funcs:{snappedRot:Pn,computeGhostY:Fo,normSector:wn,getMagicTargetColor:()=>Ft.canUse()?jt[Ft.active]:null,getTransmuteAnimState:wo}}),cs=performance.now();function Hs(t){let o=Math.min(.05,Math.max(.001,(t-cs)/1e3));if(cs=t,lt.update(o,t),Io(t),Rt>0){let i=Math.min(Rt,Wt*o);Mt=Math.max(0,Mt-i),Rt-=i}ut=ee,ut>1e6&&(ut%=c),ut<-1e6&&(ut%=c),Qe.render(o,t),requestAnimationFrame(Hs)}ce.addEventListener("click",()=>{lt.applyCommand("start_game")}),un.addEventListener("click",()=>{lt.applyCommand("start_game")}),Gt.addEventListener("click",()=>{et="intro",ht.reset(),S.stopMusic(),S.getSettings().musicEnabled&&S.startMenuMusic(),pn()}),he.forEach(t=>{t.addEventListener("click",o=>{he.forEach(p=>p.classList.remove("active")),t.classList.add("active"),Nt=t.dataset.mode,Ln();let i=M.loadHighscore(Nt);i.score>0?(Dt.textContent=i.score.toLocaleString(),Ht.textContent=Ge(i.time)):(Dt.textContent="0",Ht.textContent="0:00"),ce.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ce.classList.add("idlePulse"),2e3)})});let as=document.querySelectorAll(".spell-select-btn"),rs=document.getElementById("spellDesc"),$s=document.getElementById("spellProgressFill"),ls=document.getElementById("spellProgressMarkers"),Un={ice:0,earth:10,air:25,fire:40},Gs=Object.values(Un).sort((t,o)=>t-o),us=Math.max(...Gs),ni={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"},Le=M.loadHighTowerRings();function si(){ls&&(ls.innerHTML="",Gs.forEach(t=>{let o=document.createElement("span");o.className="marker",o.dataset.threshold=t;let i=t/us*100;o.style.left=`${i}%`,ls.appendChild(o)}))}function oi(t){return t<=0?0:t>=us?100:t/us*100}function Ns(t){if(!rs)return;let o=Un[t]||0,i=ni[t]||"";o===0||Le>=o?rs.innerHTML=i:rs.innerHTML=`${i} <span class="spell-progress-text">${Le}/${o}</span>`}function Fs(){if(Le=M.loadHighTowerRings(),as.forEach(i=>{let p=i.dataset.spell,B=Un[p]||0,b=Le>=B;i.classList.toggle("locked",!b);let w=i.querySelector(".spell-lock");w&&(w.style.display=b?"none":"")}),$s){let i=oi(Le);$s.style.width=`${i}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(i=>{let p=parseInt(i.dataset.threshold,10)||0;i.classList.toggle("reached",Le>=p)});let o=document.querySelector(".spell-select-btn.active");o&&Ns(o.dataset.spell)}si(),Fs(),as.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let i=document.querySelector('.mode-btn[data-mode="30_24"]');if(i&&!i.classList.contains("active")){he.forEach(ct=>ct.classList.remove("active")),i.classList.add("active"),Nt="30_24",Ln();let w=M.loadHighscore(Nt);w.score>0?(Dt.textContent=w.score.toLocaleString(),Ht.textContent=Ge(w.time)):(Dt.textContent="0",Ht.textContent="0:00")}let p=t.dataset.spell,B=Un[p]||0,b=Le>=B;Ns(p),b&&(as.forEach(w=>w.classList.remove("active")),t.classList.add("active"),se.selectSpell(p))})}),yo.addEventListener("click",()=>{let t=M.loadHighscore("30_24"),o=M.loadHighscore("25_20"),i=`Records

`;i+=`High Tower (30\xD724):
`,i+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ge(t.time)}
`:`  No record yet
`,i+=`
Quick Tower (25\xD720):
`,i+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Ge(o.time)}
`:`  No record yet
`,alert(i)}),So.addEventListener("click",()=>{O.classList.remove("hidden")}),Eo.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),Zn(),Ln(),pn(),S.startMenuMusic();let ii=()=>{if(S.unlock(),!S.getSettings().musicEnabled)return;let t=S.musicAudio;!t||t.paused||t.ended?lt.state==="playing"?S.startGameMusic():S.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},Us=0,ci=10,ai=()=>{Us>=ci||(Us++,ii())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ai,{passive:!0})}),requestAnimationFrame(Hs)})();})();
