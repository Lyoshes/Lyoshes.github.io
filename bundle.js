(()=>{var zi=[0,.25,.5,.75,1],ji=[0,.05,.15,.25,.5],Qi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",impact:"sounds/impact.wav",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},Bo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Io="soundSettings";function Zi(){try{let e=localStorage.getItem(Io);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ji(e){try{localStorage.setItem(Io,JSON.stringify(e))}catch(s){console.debug("Failed to save sound settings:",s)}}function Ao(){return{audioContext:null,buffers:{},settings:Zi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let s=window.AudioContext||window.webkitAudioContext;this.audioContext=new s,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(s){console.debug("Failed to create AudioContext:",s)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(s){console.debug("Failed to resume AudioContext:",s)}if(!this.unlocked&&this.audioContext.state==="running"){let s=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=s,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return zi[this.settings.soundVolume]},getMusicVolume(){return ji[this.settings.musicVolume]},async loadSound(s,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(l)).arrayBuffer(),n=await this.audioContext.decodeAudioData(c);this.buffers[s]=n}catch(f){console.debug(`Failed to load sound: ${s} from ${l}`,f)}},preload(){this.initContext();for(let[s,l]of Object.entries(Qi))this.loadSound(s,l)},play(s,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let f=s;l!==null&&(f=`${s}${l}`);let c=this.buffers[f];if(c)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=c,r.connect(n),r.start(0),r.onended=()=>{r.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(s){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(s,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Bo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let s=this.musicAudio.play();s!==void 0&&s.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(s){console.debug("Menu music start failed:",s)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Bo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let s=this.musicAudio.play();s!==void 0&&s.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(s){console.debug("Game music start failed:",s)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(s){console.debug("Stop music failed:",s)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(s){if(this.settings={...this.settings,...s},Ji(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var wo="eb_highscore",Po="eb_highscore_quick",ko="eb_settings",Oo="eb_high_tower_rings",ta={invertSwipe:!1,hapticsEnabled:!0,showControls:!0,tapRotate:!1};function Do(){return{loadHighscore(e="30_24"){try{let s=e==="25_20"?Po:wo,l=localStorage.getItem(s);if(l)return JSON.parse(l)}catch(s){console.debug("Failed to load highscore:",s)}return{score:0,time:0}},saveHighscore(e,s,l="30_24"){try{let f=this.loadHighscore(l);if(e>f.score||e===f.score&&s>f.time){let c=l==="25_20"?Po:wo;return localStorage.setItem(c,JSON.stringify({score:e,time:s})),!0}}catch(f){console.debug("Failed to save highscore:",f)}return!1},loadGameSettings(){try{let e=localStorage.getItem(ko);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...ta}},saveGameSettings(e){try{localStorage.setItem(ko,JSON.stringify(e))}catch(s){console.debug("Failed to save game settings:",s)}},loadHighTowerRings(){try{let e=localStorage.getItem(Oo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Oo,String(e))}catch(s){console.debug("Failed to save High Tower rings:",s)}},addHighTowerRings(e){let l=this.loadHighTowerRings()+e;return this.saveHighTowerRings(l),l}}}function No(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),controlsRight:document.querySelector(".controls-right"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),showControlsToggle:document.getElementById("showControlsToggle"),tapRotateToggle:document.getElementById("tapRotateToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Ho(e){return document.getElementById("tab-"+e)}var ea={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Fo(e={}){let{elementColors:s={}}=e,l=0,f=new Set(["combo","cascade"]);function c(n,r,g){return Math.max(r,Math.min(g,n))}return{showBonus(n,r="score",g=null){let h=document.createElement("div");h.className=`bonus-popup ${r}`,h.textContent=n,g&&s[g]&&(h.style.color=s[g]),document.body.appendChild(h);let d=h.getBoundingClientRect(),a=12,m=window.innerWidth/2,b=window.innerHeight/2-40,O,G;if(f.has(r)){let Pt=r==="cascade"?34:0;O=m-d.width/2,G=b-d.height/2+Pt}else{let Pt=60+l%4*22,ne=Math.random()*Math.PI*2,Kt=(Math.random()-.5)*28,_t=(Math.random()-.5)*24,Yt=m+Math.cos(ne)*Pt+Kt,at=b+Math.sin(ne)*Pt*.75+_t;O=Yt-d.width/2,G=at-d.height/2}let Q=Math.max(a,window.innerWidth-d.width-a),vt=Math.max(a,window.innerHeight-d.height-a);h.style.left=`${c(O,a,Q)}px`,h.style.top=`${c(G,a,vt)}px`,h.style.transform="none",l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{h.remove()},1800)},getElementIcon(n){return ea[n]||"\u2726"}}}var Xs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Go(){return{spawnMagicOrb(e,s,l,f,c){if(!f)return;let n=document.createElement("div");n.className=`magic-orb ${e}`,n.textContent=Xs[e]||"\u2726";let r=f.getBoundingClientRect(),g=r.left+r.width/2-s,h=r.top+r.height/2-l,d=Math.hypot(g,h),a=Math.atan2(h,g),m=d*.35*(Math.random()>.5?1:-1),b=a+Math.PI/2,O=g*.5+Math.cos(b)*m,G=h*.5+Math.sin(b)*m;n.style.setProperty("--mid-x",`${O}px`),n.style.setProperty("--mid-y",`${G}px`),n.style.setProperty("--end-x",`${g}px`),n.style.setProperty("--end-y",`${h}px`),n.style.left=`${s}px`,n.style.top=`${l}px`,document.body.appendChild(n),setTimeout(()=>{c&&c(),n.remove()},700)},spawnMagicShot(e,s,l,f,c){if(!s){c&&c();return}let n=s.getBoundingClientRect(),r=n.left+n.width/2,g=n.top+n.height/2,h=document.createElement("div");h.className=`magic-shot ${e}`,h.textContent=Xs[e]||"\u2726";let d=l-r,a=f-g;h.style.setProperty("--end-x",`${d}px`),h.style.setProperty("--end-y",`${a}px`),h.style.left=`${r}px`,h.style.top=`${g}px`,document.body.appendChild(h);let m=setInterval(()=>{let b=h.getBoundingClientRect();this.spawnTrailParticle(e,b.left+b.width/2,b.top+b.height/2)},40);setTimeout(()=>{clearInterval(m),h.remove(),this.spawnExplosion(e,l,f),c&&c()},300)},spawnTrailParticle(e,s,l){let f=document.createElement("div");f.className=`magic-trail ${e}`,f.style.left=`${s}px`,f.style.top=`${l}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),400)},spawnExplosion(e,s,l){for(let c=0;c<12;c++){let n=document.createElement("div");n.className=`magic-explosion ${e}`;let r=c/12*Math.PI*2+(Math.random()-.5)*.5,g=40+Math.random()*40,h=Math.cos(r)*g,d=Math.sin(r)*g;n.style.setProperty("--px",`${h}px`),n.style.setProperty("--py",`${d}px`),n.style.left=`${s}px`,n.style.top=`${l}px`,document.body.appendChild(n),setTimeout(()=>n.remove(),500)}},spawnSpellBubbles(e,s="water",l=18){if(!e)return;let f=s;typeof s=="number"&&(l=s,f="water"),Xs[f]||(f="water");let c=e.getBoundingClientRect(),n=c.left+c.width/2,r=c.top+c.height/2,g=Math.max(8,Math.round(l));for(let h=0;h<g;h++){let d=document.createElement("div");d.className=`spell-bubble ${f}`,d.textContent="\u25CF";let a=h/g*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,b=Math.cos(a)*m,O=Math.sin(a)*m-20;d.style.setProperty("--px",`${b}px`),d.style.setProperty("--py",`${O}px`),d.style.left=`${n}px`,d.style.top=`${r}px`,d.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),800)}},spawnSpellOrb(e,s,l){if(!l)return;let f=document.createElement("div");f.className="spell-orb",f.textContent="\u2727";let c=l.getBoundingClientRect(),n=c.left+c.width/2-e,r=c.top+c.height/2-s,g=Math.hypot(n,r),h=Math.atan2(r,n),d=g*.35*(Math.random()>.5?1:-1),a=h+Math.PI/2,m=n*.5+Math.cos(a)*d,b=r*.5+Math.sin(a)*d;f.style.setProperty("--mid-x",`${m}px`),f.style.setProperty("--mid-y",`${b}px`),f.style.setProperty("--end-x",`${n}px`),f.style.setProperty("--end-y",`${r}px`),f.style.left=`${e}px`,f.style.top=`${s}px`,document.body.appendChild(f),setTimeout(()=>{f.remove()},700)}}}var na=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,$o=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,sa=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function oa(e){let s=e.querySelector(".ring"),l=e.querySelector(".falling-figure"),f=e.querySelector(".clock");if(!s||!l||!f)return()=>{};let c=!1,n=[],r=[],g=(V,K)=>{let $=setTimeout(()=>{c||V()},K);return n.push($),$},h=(V,K)=>{let $=setInterval(()=>{if(c){clearInterval($);return}V()},K);return r.push($),$},d=48,a=.9,m=9,b=9,O=3,G=2,Q=18,vt=-12,Pt=.5,ne=12,Kt=10,_t=["--fire","--water","--light","--earth"],Yt=["--light","--fire","--water"],at=3,Z=Math.floor(m/2)-1,Bt=8e3,$t=[];function kt(V,K){let $=(K-1)/2,H=Math.abs(V-$)/$;return 1-(1-Pt)*H}function I(V,K,$,H){let Wt=(K-1)/2,D=Math.abs(V-Wt)/Wt;return H?D*$:-D*$}function Ot(){s.innerHTML="";let V=[],K=[];for(let lt=0;lt<b;lt++)K.push(d*a*kt(lt,b));let $=K.reduce((lt,Ht)=>lt+Ht,0)+(b-1)*G,H=[];for(let lt=0;lt<m;lt++)H.push(d*kt(lt,m));let Wt=H.reduce((lt,Ht)=>lt+Ht,0)+(m-1)*O,D=-$/2;for(let lt=0;lt<b;lt++){let Ht=K[lt],Qt=d*a,ae=m+lt,bt=I(lt,b,Kt,!0),se=document.createElement("div");se.className="block back",se.style.cssText=`left:${D.toFixed(1)}px;top:${(vt-Qt/2+bt).toFixed(1)}px;width:${Ht.toFixed(1)}px;height:${Qt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let mt=document.createElement("div");mt.className="dot";let ee=a*kt(lt,b);mt.style.cssText=`--c:var(${_t[ae%4]});transform:scale(${ee.toFixed(2)});`,se.appendChild(mt),se.dataset.index=ae,s.appendChild(se),V[ae]=se,D+=Ht+G}let jt=-Wt/2;for(let lt=0;lt<m;lt++){let Ht=H[lt],Qt=d,ae=lt,bt=I(lt,m,ne,!1),se=ae>=Z&&ae<Z+at,mt=document.createElement("div");mt.className="block",se&&mt.classList.add("gap"),mt.style.cssText=`left:${jt.toFixed(1)}px;top:${(Q-Qt/2+bt).toFixed(1)}px;width:${Ht.toFixed(1)}px;height:${Qt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let ee=document.createElement("div");ee.className="dot";let Ce=kt(lt,m);ee.style.cssText=`--c:var(${_t[ae%4]});transform:scale(${Ce.toFixed(2)});`,mt.appendChild(ee),mt.dataset.index=ae,s.appendChild(mt),V[ae]=mt,jt+=Ht+O}$t=V}function zt(){let V=[];for(let K=Z-1;K>=0;K--)V.push(K);for(let K=0;K<b;K++)V.push(m+K);for(let K=m-1;K>=Z;K--)V.push(K);return V}function It(){$t.forEach((V,K)=>{V&&(V.classList.remove("hi","vanish","gap"),V.style.opacity="",V.style.transform="",K>=Z&&K<Z+at&&V.classList.add("gap"))})}function i(){for(let V=0;V<at;V++){let K=$t[Z+V];if(K){K.classList.remove("gap");let $=K.querySelector(".dot");if($){let H=kt(Z+V,m);$.style.cssText=`--c:var(${Yt[V]});transform:scale(${H.toFixed(2)});`}}}}function it(V){let K=zt(),$=0,H=K.length,Wt=h(()=>{if($>0&&$<=H){let D=$t[K[$-1]];D&&D.classList.remove("hi")}if($<H){let D=$t[K[$]];D&&D.classList.add("hi"),$++}else clearInterval(Wt),$t.forEach(D=>{D&&D.classList.add("hi")}),g(V,300)},30)}function st(V){let K=zt(),$=K.length;K.forEach((H,Wt)=>{let D=$t[H];D&&g(()=>{D.classList.add("vanish")},Wt*40)}),g(V,$*40+500)}function ie(){c||(It(),l.classList.add("active"),g(()=>{i(),l.classList.remove("active"),l.style.opacity="0",g(()=>{it(()=>{c||(f.classList.add("show"),g(()=>{st(()=>{c||(f.classList.remove("show"),l.style.opacity="",g(ie,500))})},400))})},200)},Bt*.38))}return Ot(),ie(),()=>{c=!0,n.forEach(clearTimeout),r.forEach(clearInterval)}}var ia=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:na},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:$o},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:sa,onEnter:e=>oa(e)}];function Uo(e={}){let{helpBtn:s,mount:l=document.body,combosTemplate:f}=e;if(!s||!l)return{open(){},close(){},setCombosTemplate(){}};let c=ia.map(I=>({...I}));typeof f=="string"&&f.trim()&&(c[1].illustrationHtml=f);let n=document.createElement("div");n.className="overlay hidden help-modal",n.id="helpOverlay",n.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,l.appendChild(n);let r=n.querySelector(".help-next-btn"),g=n.querySelector(".help-slide-title"),h=n.querySelector(".help-slide-text"),d=n.querySelector(".help-illustration"),a=n.querySelector(".help-dots"),m=c.map(()=>{let I=document.createElement("span");return I.className="help-dot",a.appendChild(I),I}),b=0,O=!1,G=null,Q=null,vt=180,Pt=560,ne=460,Kt=480,_t=I=>{Q&&(Q(),Q=null);let Ot=c[I];Ot&&(b=I,g.textContent=Ot.title,h.textContent=Ot.text,d.innerHTML=Ot.illustrationHtml||"",m.forEach((zt,It)=>{zt.classList.toggle("active",It===I)}),r.textContent=I===c.length-1?"Done":"Next",Yt(),Ot.onEnter&&(Q=Ot.onEnter(d)))},Yt=()=>{if(!O||n.classList.contains("hidden"))return;let I=d.getBoundingClientRect();if(!I.width||!I.height)return;let Ot=d.querySelector(".help-combos");if(Ot){let i=Math.min(1,Math.min(I.width,I.height)/Pt);Ot.style.setProperty("--help-combos-scale",i.toFixed(3))}let zt=d.querySelector(".help-controls");if(zt){let i=Math.min(1,Math.min(I.width,I.height)/ne);zt.style.setProperty("--help-controls-scale",i.toFixed(3))}let It=d.querySelector(".help-rings");if(It){let i=Math.min(1,Math.min(I.width,I.height)/Kt);It.style.setProperty("--help-rings-scale",i.toFixed(3))}},at=()=>{O&&Yt()},Z=I=>{O&&I.stopPropagation()},Bt=I=>{if(O){if(I.key==="Escape"){I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation?.(),kt();return}I.preventDefault(),I.stopPropagation(),I.stopImmediatePropagation?.()}},$t=()=>{O||(O=!0,G&&(clearTimeout(G),G=null),_t(0),n.classList.remove("hidden"),requestAnimationFrame(()=>{n.classList.add("is-visible"),Yt()}),document.addEventListener("keydown",Bt,!0),window.addEventListener("resize",at))},kt=()=>{O&&(O=!1,Q&&(Q(),Q=null),n.classList.remove("is-visible"),document.removeEventListener("keydown",Bt,!0),window.removeEventListener("resize",at),G=window.setTimeout(()=>{n.classList.add("hidden")},vt))};return n.addEventListener("click",I=>{O&&(I.target===n&&kt(),I.stopPropagation())}),n.addEventListener("pointerdown",Z),n.addEventListener("pointerup",Z),n.addEventListener("touchstart",Z,{passive:!0}),n.addEventListener("touchmove",I=>{O&&(I.preventDefault(),I.stopPropagation())},{passive:!1}),n.addEventListener("wheel",I=>{O&&(I.preventDefault(),I.stopPropagation())},{passive:!1}),r.addEventListener("click",I=>{I.stopPropagation(),b<c.length-1?_t(b+1):kt()}),s.addEventListener("click",I=>{I.preventDefault(),$t()}),{open:$t,close:kt,setCombosTemplate(I){typeof I=="string"&&(c[1].illustrationHtml=I.trim()||$o,O&&b===1&&_t(1))}}}var aa={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function ca(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Ys=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(s){if(!this.supports())return!1;let l=Array.isArray(s.pattern)?s.pattern:Number.isFinite(s.durationMs)?[s.durationMs]:null;return l?(navigator.vibrate(l),!0):!1}},Ws=class{constructor(s){this.bridge=s}supports(){return!0}trigger(s){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:s.name,strength:s.strength,durationMs:s.durationMs,pattern:s.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(s.name,s.strength,s.durationMs,s.pattern),!0}catch{}return!1}};function Xo({enabled:e=!0,patterns:s=aa}={}){let l=ca(),f=l?new Ws(l):new Ys,c=f.supports(),n=!!e&&c;return{supports:()=>c,isEnabled:()=>n,setEnabled(r){n=!!r&&c},trigger(r){if(!n)return!1;let g=s[r];return g?f.trigger({name:r,...g}):!1}}}function Yo(e={}){let{buttons:s={},onActivate:l=null,onChange:f=null}=e,c={fire:3,water:3,lightning:3,earth:3},n=null;function r(){for(let[d,a]of Object.entries(s)){if(!a)continue;let m=c[d],b=a.querySelector(".charges");b&&(b.textContent=m),a.classList.toggle("empty",m<=0),a.classList.toggle("active",n===d&&m>0)}f&&f({...c},n)}function g(d){let a=s[d];a&&(a.classList.remove("pulse"),a.offsetWidth,a.classList.add("pulse"),setTimeout(()=>a.classList.remove("pulse"),400))}function h(d){let a=s[d];a&&(a.classList.remove("charge-gain"),a.offsetWidth,a.classList.add("charge-gain"),setTimeout(()=>a.classList.remove("charge-gain"),520))}return{get charges(){return c},get active(){return n},set active(d){n=d},select(d){if(c[d]<=0)return!1;let a=n===d;return n=a?null:d,r(),!a&&n===d&&l&&l(),!a},useCharge(){if(!n||c[n]<=0)return!1;let d=n;return c[d]--,n=null,r(),g(d),!0},addCharges(d,a){c[d]!==void 0&&(c[d]+=a,r(),g(d))},onChargeArrive(d){h(d)},canUse(){return n!==null&&c[n]>0},deactivate(){n=null,r()},reset(){c.fire=3,c.water=3,c.lightning=3,c.earth=3,n=null,r()},updateButtons:r,initButtons(d){for(let[a,m]of Object.entries(s))m&&m.addEventListener("click",()=>{d&&d(a)})}}}var Je={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function Wo(e={}){let{button:s=null,onActivate:l=null,onProgress:f=null,onReady:c=null}=e,n="ice",r=0;function g(){return Je[n]||Je.ice}function h({silent:a=!1}={}){if(!s||!s.classList.contains("spell-btn"))return;let m=g(),b=Number.isFinite(m.maxProgress)?m.maxProgress:0,O=b>0?Math.min(r/b,1)*100:0,G=b>0&&r>=b;s.style.setProperty("--progress",`${O}%`);let Q=s.querySelector(".spell-icon");Q&&(Q.textContent=m.icon);let vt=s.querySelector(".spell-counter");vt&&(vt.textContent=b>0?`${Math.min(r,b)}/${b}`:""),s.classList.toggle("ready",G),s.classList.toggle("charging",!G&&r>0),f&&!a&&b>0&&f(r,b)}function d(){s&&(s.classList.remove("pulse"),s.offsetWidth,s.classList.add("pulse"),setTimeout(()=>s.classList.remove("pulse"),400))}return{get currentSpell(){return n},get progress(){return r},get maxProgress(){return g().maxProgress??0},get isReady(){let a=g().maxProgress;return Number.isFinite(a)&&a>0&&r>=a},get effect(){return g().effect},getUnlockRings(a){return(Je[a]||Je.ice).unlockRings??0},getCost(a){return(Je[a]||Je.ice).cost??0},getDescription(a){return(Je[a]||Je.ice).description||""},getEffect(a){return(Je[a]||Je.ice).effect},get button(){return s},selectSpell(a){Je[a]&&(n=a,r=0,h())},addProgress(a=1){let m=g();if(!Number.isFinite(m.maxProgress)||m.maxProgress<=0||r>=m.maxProgress)return!1;let b=r<m.maxProgress;return r=Math.min(r+a,m.maxProgress),h(),d(),b&&r>=m.maxProgress&&c&&c(),!0},setProgress(a,{silent:m=!1}={}){r=Math.max(0,a),h({silent:m})},canUse(){let a=g().maxProgress;return Number.isFinite(a)&&a>0&&r>=a},use(){if(!this.canUse())return null;let a=g().effect;return r=0,h(),d(),l&&l(n),a},reset(){r=0,h()},pulse(){d()},updateButton:h,initButton(a){s&&s.addEventListener("click",()=>{a&&a()})}}}function Vs({centerY:e,centerS:s,size:l,H:f,normSector:c}){let n=[],r=Math.floor(l/2);for(let g=-r;g<=r;g++)for(let h=-r;h<=r;h++){let d=e+g,a=c(s+h);if(d<0||d>=f)continue;let m=g*g+h*h;n.push({y:d,s:a,distSq:m})}return n}function Ts(e,s,l){return s.filter(f=>e[f.y][f.s]===l)}function xs(e,s){return[...e].sort((f,c)=>f.distSq!==c.distSq?f.distSq-c.distSq:f.y!==c.y?f.y-c.y:f.s-c.s).slice(0,s).map(f=>({y:f.y,s:f.s}))}function Vo({centerY:e,centerS:s,beamLength:l,N:f,H:c,normSector:n}){if(e<0||e>=c||l<0||f<=0)return[];let r=[],g=new Set,h=(a,m)=>`${a},${m}`,d=n(s);r.push({y:e,s:d,dist:0}),g.add(h(e,d));for(let a=1;a<=l;a++){let m=n(s+a),b=h(e,m);g.has(b)||(r.push({y:e,s:m,dist:a}),g.add(b));let O=n(s-a),G=h(e,O);g.has(G)||(r.push({y:e,s:O,dist:a}),g.add(G))}for(let a=1;a<=l;a++){let m=n(s),b=e+a;if(b<c){let G=h(b,m);g.has(G)||(r.push({y:b,s:m,dist:a}),g.add(G))}let O=e-a;if(O>=0){let G=h(O,m);g.has(G)||(r.push({y:O,s:m,dist:a}),g.add(G))}}return r}function qo(e){let{canvas:s,dom:l,getGrid:f,getN:c,getH:n,getRotFloat:r,constants:g,helpers:h,Spell:d,Magic:a,SoundModule:m,State:b,isGamePlaying:O,addPendingKzDrop:G,getKillRate:Q,triggerSpellWave:vt,spawnSpellBubbles:Pt,spawnBonusBubbles:ne,getTransmuteEffect:Kt,getLightningEffect:_t,getFireEffect:Yt,continueMatchProcessing:at,updateScoreHud:Z,showBonus:Bt,getSpellCost:$t,getSpellElement:kt,onUltimateApplied:I,isSpellBlocked:Ot,setScore:zt,setCascadeLevel:It}=e,{TOP_PAD_PX:i,BOTTOM_PAD_PX:it,SIDE_MARGIN_PX:st,MAX_RADIUS_X:ie,SCORE_MAGIC_DESTROY:V}=g,{normSector:K,levelYToScreenY:$,sectorCenterXY:H}=h,Wt=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],D="idle",jt=null,lt=null,Ht=[],Qt=[],ae=0,bt=null,se=0,mt="idle",ee=null,Ce=[],Tt=[],Re=0,Ft=0,Jt="idle",qe=null,Ke=[],pt=[],xt=0;function ze(S){if(typeof $t!="function"||typeof kt!="function")return!1;let L=kt(S),M=$t(S);return!L||!M?!1:(a.charges[L]??0)>=M}function tn(S){if(typeof $t!="function"||typeof kt!="function")return!1;let L=kt(S),M=$t(S);return!L||!M||(a.charges[L]??0)<M?!1:(a.charges[L]-=M,a.updateButtons(),d.pulse(),!0)}let en=0,Zn=350;function _e(){return typeof Ot=="function"?Ot():!1}function Dt(){let S=performance.now();S-en<Zn||(en=S,m.play("cancel"))}function ln(){D="selecting_source",jt=null,lt=null,Ht=[],Qt=[],mt!=="idle"&&j(),Jt!=="idle"&&T(),a.deactivate(),m.play("ulta");let S=l.spellBtn;S&&S.classList.add("selecting")}function yt(){D!=="idle"&&m.play("cancel"),D="idle",jt=null,lt=null,Ht=[],Qt=[],x();let S=l.spellBtn;S&&S.classList.remove("selecting")}function Hn(S,L){if(D!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return yt(),!0;let gt=f();jt={y:M.y,s:M.s,color:gt[M.y][M.s]},Ht=Vs({centerY:M.y,centerS:M.s,size:Kt().areaSize,H:n(),normSector:K});let ht=jt.color,Rt=Ts(gt,Ht,ht);return Qt=xs(Rt,Kt().maxBlocks),p(jt.color,M.y),D="selecting_target",!0}function E(S,L){let M=s.clientWidth,gt=s.clientHeight,ht=M*.5,Rt=(M-2*st)/2,oe=gt-i-it,le=6,Ne=n(),nn=c(),xn=r(),Qe=nn*oe/(le*Ne),Se=gt-it,de,ue,Le;Qe<=Math.min(Rt,ie)?(de=Qe,ue=oe,Le=i):(de=Math.min(Rt,ie),ue=de*le*Ne/nn,Le=Se-ue);let Cn=de*.28,Sn=null,sn=1/0,He=f();for(let fe=0;fe<Ne;fe++){let Ze=$(Le,ue,fe+.5);for(let ge=0;ge<nn;ge++){if(!He[fe][ge])continue;let $e=H(ht,Ze,de,Cn,ge,xn);if(Math.sin($e.ang)<-.1)continue;let Ee=S-$e.x,on=L-$e.y,me=Math.hypot(Ee,on),Be=ue/Ne*.9,Ue=Be*1.2;Math.abs(Ee)<Ue/2&&Math.abs(on)<Be/2&&me<sn&&(sn=me,Sn={y:fe,s:ge})}}return Sn}function p(S,L){x();let M=document.createElement("div");M.className="transmute-popup";let gt=s.clientWidth,ht=s.clientHeight,Rt=(gt-2*st)/2,oe=ht-i-it,le=6,Ne=n(),nn=c(),xn=nn*oe/(le*Ne),Qe=ht-it,Se,de;xn<=Math.min(Rt,ie)?(Se=oe,de=i):(Se=Math.min(Rt,ie)*le*Ne/nn,de=Qe-Se);let ue=$(de,Se,L+.5),Le=Math.floor(Kt().areaSize/2),Cn=$(de,Se,Math.min(Ne,L+Le)+.5),Sn=$(de,Se,Math.max(0,L-Le)+.5),sn=de+Se/2,He=document.getElementById("gameContainer"),fe=He?He.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},Ze=160,ge=60,$e=20,En=fe.left+fe.width/2-Ze/2,Ee;ue<sn?Ee=fe.top+Sn+$e:Ee=fe.top+Cn-ge-$e,Ee=Math.max(10,Math.min(window.innerHeight-ge-10,Ee)),M.style.left=`${En}px`,M.style.top=`${Ee}px`,Wt.filter(me=>me.color!==S).forEach(me=>{let Be=document.createElement("button");Be.className=`transmute-btn ${me.name}`,Be.innerHTML=me.icon,Be.setAttribute("data-color",me.color),Be.addEventListener("click",Ue=>{Ue.stopPropagation(),B(me.color)}),M.appendChild(Be)}),document.body.appendChild(M),bt=M,se=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",y)},50)}function y(S){performance.now()-se<200||bt&&!bt.contains(S.target)&&yt()}function x(){document.removeEventListener("pointerdown",y),bt&&(bt.remove(),bt=null)}function B(S){if(_e()){Dt();return}if(!ze(d.currentSpell)){Dt();return}if(x(),lt=S,Qt.length===0){yt();return}w()}function w(){if(!jt){yt();return}if(Qt.length===0){yt();return}if(!tn(d.currentSpell)){Dt(),yt();return}let S=l.spellBtn;S&&S.classList.remove("selecting"),D="animating",ae=performance.now(),m.play("esseffect")}function X(){if(D!=="selecting_target"&&D!=="animating"||!jt||!Ht||Ht.length===0)return;let S=f(),L=S[jt.y]?.[jt.s]??0;if(!L||L!==jt.color){yt();return}let M=Ts(S,Ht,L),gt=Kt().maxBlocks??M.length;Qt=xs(M,gt),Qt.length===0&&yt()}function Y(S){if(D!=="animating")return!1;let L=(S-ae)/1e3;return Math.min(L/Kt().animSec,1)>=1?(Et(),!1):!0}function R(S){if(D!=="animating")return null;let L=(S-ae)/1e3,M=Math.min(L/Kt().animSec,1),gt="flash",ht=0,Rt=0;return M<.15?(gt="flash",Rt=1-M/.15):M<.55?(gt="shrink",ht=(M-.15)/.4):(gt="grow",ht=(M-.55)/.45),{phase:gt,progress:ht,areaFlash:Rt}}function Et(){let S=f();for(let L of Qt)S[L.y][L.s]=lt;D="idle",jt=null,lt=null,Ht=[],Qt=[],It(1),at(),typeof I=="function"&&I("earth")}function z(){m.play("ulta"),mt="selecting_source",ee=null,Ce=[],Tt=[],Ft=0,D!=="idle"&&(D="idle",jt=null,lt=null,Ht=[],Qt=[],x()),Jt!=="idle"&&(Jt="idle",qe=null,Ke=[],pt=[],xt=0),a.deactivate();let S=l.spellBtn;S&&S.classList.add("selecting")}function j(){mt!=="idle"&&m.play("cancel"),mt="idle",ee=null,Ce=[],Tt=[],Ft=0;let S=l.spellBtn;S&&S.classList.remove("selecting")}function ft(){Jt="selecting_source",qe=null,Ke=[],pt=[],xt=0,D!=="idle"&&(D="idle",jt=null,lt=null,Ht=[],Qt=[],x()),mt!=="idle"&&(mt="idle",ee=null,Ce=[],Tt=[],Ft=0),a.deactivate(),m.play("ulta");let S=l.spellBtn;S&&S.classList.add("selecting")}function T(){Jt!=="idle"&&m.play("cancel"),Jt="idle",qe=null,Ke=[],pt=[],xt=0;let S=l.spellBtn;S&&S.classList.remove("selecting")}function N(S,L){if(mt!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return j(),!0;let gt=f();ee={y:M.y,s:M.s,color:gt[M.y][M.s]},Ce=Vs({centerY:M.y,centerS:M.s,size:_t().areaSize,H:n(),normSector:K});let ht=ee.color,Rt=Ts(gt,Ce,ht);return Tt=xs(Rt,_t().maxBlocks),Tt.length===0?(j(),!0):ze(d.currentSpell)?(ce(),!0):(Dt(),!0)}function ot(S,L){if(Jt!=="selecting_source")return!1;if(_e())return Dt(),!0;let M=E(S,L);if(!M)return T(),!0;let gt=f();return qe={y:M.y,s:M.s,color:gt[M.y][M.s]},Ke=Vo({centerY:M.y,centerS:M.s,beamLength:Yt().beamLength,N:c(),H:n(),normSector:K}),pt=Ke.filter(ht=>gt[ht.y][ht.s]).sort((ht,Rt)=>ht.dist-Rt.dist),pt.length===0?(T(),!0):ze(d.currentSpell)?(Gt(),!0):(Dt(),!0)}function ce(){if(!ee||Tt.length===0){j();return}if(!tn(d.currentSpell)){Dt(),j();return}let S=l.spellBtn;S&&S.classList.remove("selecting"),mt="animating",Re=performance.now(),Ft=0,m.play("asseffect")}function v(S){if(mt!=="animating")return!1;let L=S-Re,M=_t().flashMs+Tt.length*_t().jumpMs;return L>=M?(k(),!1):!0}function wt(S){if(mt!=="animating")return null;let L=S-Re;if(L<_t().flashMs)return{phase:"flash",flashProgress:1-L/_t().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let M=L-_t().flashMs,gt=Math.floor(M/_t().jumpMs),ht=M%_t().jumpMs/_t().jumpMs,Rt=[];for(let oe=0;oe<Math.min(gt,Tt.length);oe++)Rt.push(oe);return{phase:"chain",flashProgress:0,currentTarget:Math.min(gt,Tt.length-1),jumpProgress:ht,struckTargets:Rt}}function k(){let S=f(),L=Tt.length,M=L*V;b.addScore(M),zt(b.score),Z(),Bt(`+${M}`,"score");for(let oe of Tt)S[oe.y][oe.s]=0;let gt=_t(),ht=Math.abs(gt.kzDropSecPerBlock??0),Rt=L*ht;Rt>0&&typeof G=="function"&&typeof Q=="function"&&(G(Rt*Q()),Bt(`\u26A1 -${Rt}s`,"time")),mt="idle",ee=null,Ce=[],Tt=[],Ft=0,It(1),at(),typeof I=="function"&&I("air")}function Gt(){if(!qe||pt.length===0){T();return}if(!tn(d.currentSpell)){Dt(),T();return}let S=l.spellBtn;S&&S.classList.remove("selecting"),Jt="animating",xt=performance.now(),m.play("fsseffect")}function Ge(S){return Jt!=="animating"?!1:(S-xt)/1e3>=Yt().animSec?(je(),!1):!0}function ye(S){if(Jt!=="animating")return null;let L=Yt(),M=Math.max(.001,L.animSec),gt=(S-xt)/1e3,ht=Math.min(gt/M,1),Rt=.25,oe=ht<Rt?1-ht/Rt:0,le=.6,Ne=ht<le?ht/le*L.beamLength:L.beamLength;return{progress:ht,flashProgress:oe,beamLength:L.beamLength,beamReach:Ne}}function je(){let S=f(),L=pt.length;if(L>0){let M=L*V;b.addScore(M),zt(b.score),Z(),Bt(`+${M}`,"score")}for(let M of pt)S[M.y][M.s]=0;Jt="idle",qe=null,Ke=[],pt=[],xt=0,It(1),at(),typeof I=="function"&&I("fire")}function dn(){let S=typeof O=="function"?O():b.isPlaying(),L=d.currentSpell;if(!S)return!1;if(L==="ice"){if(_e()||!ze(L)||!tn(d.currentSpell))return Dt(),!1;let M=d.effect;return typeof G=="function"&&typeof Q=="function"&&G(M.duration*Q()),m.play("wsseffect"),Bt(`\u{1F4A7} -${M.duration}s`,"time"),typeof vt=="function"&&vt(),typeof ne=="function"&&ne(M.duration),typeof I=="function"&&I(L),!0}return L==="earth"?D==="selecting_source"||D==="selecting_target"?(yt(),!0):D!=="idle"||_e()||!ze(L)?(Dt(),!1):(D==="idle"&&ln(),!0):L==="air"?mt==="selecting_source"?(j(),!0):mt!=="idle"||_e()||!ze(L)?(Dt(),!1):(mt==="idle"&&z(),!0):L==="fire"?Jt==="selecting_source"?(T(),!0):Jt!=="idle"||_e()||!ze(L)?(Dt(),!1):(Jt==="idle"&&ft(),!0):!1}function re(S){X(),Y(S),v(S),Ge(S)}function J(S,L){return _e()&&(D==="selecting_source"||mt==="selecting_source"||Jt==="selecting_source")?(Dt(),!0):D==="selecting_source"?Hn(S,L):mt==="selecting_source"?N(S,L):Jt==="selecting_source"?ot(S,L):!1}function te(){D="idle",jt=null,lt=null,Ht=[],Qt=[],x(),mt="idle",ee=null,Ce=[],Tt=[],Ft=0,Jt="idle",qe=null,Ke=[],pt=[],xt=0;let S=l.spellBtn;S&&S.classList.remove("selecting")}function Tn(){return{transmuteState:D,transmuteSourceBlock:jt,transmuteTargetColor:lt,transmuteAreaCells:Ht,transmuteBlocksToChange:Qt,lightningState:mt,lightningSourceBlock:ee,lightningAreaCells:Ce,lightningBlocksToHit:Tt,fireState:Jt,fireSourceBlock:qe,fireLineCells:Ke,fireTargets:pt}}return{startTransmuteSourceSelection:ln,cancelTransmutation:yt,startLightningSourceSelection:z,cancelLightning:j,startFireSourceSelection:ft,cancelFire:T,handleTap:J,update:re,reset:te,getRenderState:Tn,getTransmuteAnimState:R,getLightningAnimState:wt,getFireAnimState:ye,handleSpellButtonClick:dn,isTransmuteSelecting:()=>D==="selecting_source",isLightningSelecting:()=>mt==="selecting_source"}}var ra={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Ko(e={}){let{canvas:s}=e,l=e.rotDir||1,f=!1,c=0,n=0,r=0,g=0,h=0,d=1,a=null,m=0,b=0,O=0,G=0,Q=0,vt=0,Pt=0,ne=0,Kt=!1,_t=!1,Yt=!1,at=ra;return{get tapRotateEnabled(){return Kt},set tapRotateEnabled(Z){Kt=Z},get rotDir(){return l},set rotDir(Z){l=Z},get dragging(){return f},get dragMode(){return a},handlePointerDown(Z,Bt,$t){if(Bt.onMagicTap&&Bt.onMagicTap(Z.clientX,Z.clientY))return _t=!0,!0;_t=!1,Yt=!1;let kt=performance.now(),I=kt-vt,Ot=Z.clientX-Pt,zt=Z.clientY-ne,It=Math.hypot(Ot,zt);return I<=at.DOUBLE_TAP_MS&&It<=at.DOUBLE_TAP_MAX_DIST?(Bt.onDoubleTap&&Bt.onDoubleTap(),Yt=!0,vt=0):(vt=kt,Pt=Z.clientX,ne=Z.clientY),f=!0,d=-1,c=Z.clientX,n=Z.clientY,r=$t,g=0,h=0,a=null,m=kt,b=Z.clientX,O=Z.clientY,G=m,Q=0,s&&s.setPointerCapture(Z.pointerId),!1},handlePointerMove(Z,Bt,$t,kt){if(!f)return null;let I=Z.clientX-c,Ot=Z.clientY-n,zt=performance.now();if(Math.abs(I)<at.DEADZONE_PX&&Math.abs(Ot)<at.DEADZONE_PX)return null;if(a){if(a==="rotate"){let i=Math.abs(I),it=Math.abs(Ot);if(it>=i*at.AXIS_DOMINANCE&&it>=at.DROP_SWIPE_MIN_DISTANCE){let st=Math.max(1,zt-m);it/st*1e3>=at.DROP_SWIPE_MIN_SPEED&&(a="drop",h=0)}}}else{let i=Math.abs(I),it=Math.abs(Ot);if(Ot<0)i>=at.DEADZONE_PX&&(a="rotate");else if(it>=i*at.AXIS_DOMINANCE){if(it>=at.DROP_SWIPE_MIN_DISTANCE){let st=Math.max(1,zt-m);it/st*1e3>=at.DROP_SWIPE_MIN_SPEED?a="drop":a="rotate"}}else i>=it*at.AXIS_DOMINANCE&&(a="rotate");if(!a)return null}let It=null;if(a==="rotate"&&Math.abs(I)>=at.DEADZONE_PX){let i=Math.max(1,zt-G),it=Z.clientX-b,st=Math.max(1,Math.abs(it)/i*1e3),ie=Math.max(at.MIN_ROT_PX,Math.min(at.MAX_ROT_PX,at.PX_PER_STEP*(at.SWIPE_SPEED_REF/st)));Q+=-it/ie*l*d;let V=Math.trunc(Q);V!==0&&(Q-=V);let K=g+V;if(K!==g&&Bt.canRotateTo){let $=Math.sign(K-g),H=r+g;for(;g!==K;){let Wt=g+$,D=r+Wt;if(!Bt.canRotateTo(Math.floor($t),D))break;g=Wt,H=D,Bt.onRotateStep&&Bt.onRotateStep(),kt&&Bt.onGroundedMove&&Bt.onGroundedMove()}It={targetRot:H,rotFloat:H}}}if(a==="drop"&&Ot>=at.DROP_SWIPE_MIN_DISTANCE&&Bt.onDrop){let i=Math.max(1,zt-G),it=Z.clientY-O,st=Math.max(1,it/i*1e3),ie=Math.max(at.MIN_DROP_PX,Math.min(at.MAX_DROP_PX,at.PX_PER_DROP*(at.SWIPE_SPEED_REF/st))),V=Math.trunc(Ot/ie);if(V>h){let K=V-h;for(let $=0;$<K;$++)Bt.onDrop();h=V}}return b=Z.clientX,O=Z.clientY,G=zt,It},handlePointerUp(Z,Bt){if(f){if(Kt&&!_t&&!Yt&&!a&&Bt?.onSingleTap){let $t=Math.abs(Z.clientX-c),kt=Math.abs(Z.clientY-n),I=performance.now()-m;$t<at.DEADZONE_PX&&kt<at.DEADZONE_PX&&I<300&&Bt.onSingleTap()}if(f=!1,a=null,s&&Z&&Z.pointerId!==void 0)try{s.releasePointerCapture(Z.pointerId)}catch{}}},reset(){f=!1,a=null,g=0,h=0,Q=0}}}var qs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function zo(){let e="intro",s=0,l=0,f=0,c=0,n=0,r={...qs};return{get state(){return e},get score(){return s},get elapsedMs(){return f},get startTime(){return l},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",s=0,l=performance.now(),f=0,c=0,n=0,r={...qs}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(n+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(g){s+=g},setScore(g){s=g},updateTime(){e==="playing"&&l>0&&(f=performance.now()-l-n)},getFormattedTime(){let g=Math.floor(f/1e3),h=Math.floor(g/60),d=g%60;return`${h}:${d.toString().padStart(2,"0")}`},incrementStat(g,h=1){g in r&&(r[g]+=h)},updateMaxStat(g,h){g in r&&h>r[g]&&(r[g]=h)},reset(){e="intro",s=0,l=0,f=0,c=0,n=0,r={...qs}}}}function Nn(e,s){return e%=s,e<0&&(e+=s),e}function jo(e,s){return e[Math.min(s,e.length-1)]}function Cs(e){let s=Math.max(0,Math.floor(e/1e3)),l=Math.floor(s/60),f=s%60;return`${l}:${f.toString().padStart(2,"0")}`}function Qo(e,s){let l=e.map(({x:g,y:h},d)=>({x:h,y:-g,color:s[d]})),f=1/0,c=-1/0,n=1/0;for(let g of l)f=Math.min(f,g.x),c=Math.max(c,g.x),n=Math.min(n,g.y);let r=Math.round((f+c)/2);for(let g of l)g.x-=r,g.y-=n;return l.sort((g,h)=>g.y-h.y||g.x-h.x),{cells:l.map(g=>({x:g.x,y:g.y})),colors:l.map(g=>g.color)}}function Ks(e,s,l,f){let c=[];return e+1<l&&c.push({y:e+1,s}),e-1>=0&&c.push({y:e-1,s}),c.push({y:e,s:Nn(s-1,f)}),c.push({y:e,s:Nn(s+1,f)}),c}function Zo(e,s,l){let f=Array.from({length:s},()=>new Uint8Array(l)),c=[];for(let n=0;n<s;n++)for(let r=0;r<l;r++){if(!e[n][r]||f[n][r])continue;let g=[],h=[{y:n,s:r}];for(f[n][r]=1;h.length>0;){let d=h.shift();g.push(d);for(let a of Ks(d.y,d.s,s,l))e[a.y][a.s]&&!f[a.y][a.s]&&(f[a.y][a.s]=1,h.push(a))}c.push(g)}return c}function Jo(e){return e.some(s=>s.y===0)}function zs(e,s,l,f,c,n){if(!e)return!1;let r=Nn(l,n);for(let g of e.cells){let h=s+g.y,d=Nn(r+g.x,n);if(h<0)return!1;if(!(h>=c)&&f[h][d])return!1}return!0}function ti(e,s,l,f,c,n){if(!e)return null;let r=Math.floor(s);for(;zs(e,r-1,l,f,c,n);)r-=1;return r}function ei(e,s,l){let f=[],c=[];for(let n=0;n<s;n++){let r=[],g=0,h=e[n][0],d=h?1:0;for(let a=1;a<=l;a++){let m=a<l?e[n][a]:0;m&&m===h?d++:(d>=1&&h&&r.push({start:g,length:d,color:h}),g=a,h=m,d=m?1:0)}if(r.length>=2){let a=r[0],m=r[r.length-1];if(a.start===0&&m.start+m.length===l&&a.color===m.color){let b=a.length+m.length;r[0]={start:m.start,length:b,color:a.color},r.pop()}}for(let a of r)if(a.length>=3){let m=[];for(let b=0;b<a.length;b++)m.push({y:n,s:(a.start+b)%l});f.push({color:a.color,length:a.length,cells:m})}}for(let n=0;n<l;n++){let r=0,g=e[0][n],h=g?1:0;for(let d=1;d<=s;d++){let a=d<s?e[d][n]:0;if(a&&a===g)h++;else{if(h>=3&&g){let m=[];for(let b=0;b<h;b++)m.push({y:r+b,s:n});f.push({color:g,length:h,cells:m})}r=d,g=a,h=a?1:0}}}for(let n=0;n<s;n++)for(let r=0;r<l;r++){let g=e[n][r],h=e[n][(r+1)%l],d=e[n][(r+2)%l],a=e[n][(r+3)%l];g&&g===h&&d&&d===a&&g!==d&&c.push({cells:[{y:n,s:r},{y:n,s:(r+1)%l},{y:n,s:(r+2)%l},{y:n,s:(r+3)%l}]})}for(let n=0;n<l;n++)for(let r=0;r<s-3;r++){let g=e[r][n],h=e[r+1][n],d=e[r+2][n],a=e[r+3][n];g&&g===h&&d&&d===a&&g!==d&&c.push({cells:[{y:r,s:n},{y:r+1,s:n},{y:r+2,s:n},{y:r+3,s:n}]})}return{lineMatches:f,pairMatches:c}}function ni(e,s,l){let f=[];for(let c=0;c<s;c++){let n=!0;for(let r=0;r<l;r++)if(!e[c][r]){n=!1;break}n&&f.push(c)}return f}function si(e,s){let l=new Map;e.forEach((f,c)=>l.set(`${f.x},${f.y}`,s[c]));for(let f=0;f<e.length;f++){let c=e[f],n=s[f],r=1;for(let vt=1;vt<=2&&l.get(`${c.x+vt},${c.y}`)===n;vt++)r++;if(r>=3)return!0;let g=1;for(let vt=1;vt<=2&&l.get(`${c.x},${c.y+vt}`)===n;vt++)g++;if(g>=3)return!0;let h=n,d=l.get(`${c.x+1},${c.y}`),a=l.get(`${c.x+2},${c.y}`),m=l.get(`${c.x+3},${c.y}`);if(h&&d&&a&&m&&h===d&&a===m&&h!==a)return!0;let b=n,O=l.get(`${c.x},${c.y+1}`),G=l.get(`${c.x},${c.y+2}`),Q=l.get(`${c.x},${c.y+3}`);if(b&&O&&G&&Q&&b===O&&G===Q&&b!==G)return!0}return!1}function oi(e){let{getN:s,getH:l,FALL_INTERVAL:f,LOCK_DELAY_SEC:c,getKillRate:n,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:g,RING_HIGHLIGHT_SEC:h,getState:d,setState:a,funcs:m,ui:b}=e;return{get state(){return d().gameState},get score(){return d().score},get elapsedMs(){return d().elapsedMs},get stats(){return d().stats},get activePiece(){return d().activePiece},get pieceY(){return d().pieceY},get targetRot(){return d().targetRot},get isGrounded(){return d().isGrounded},get isHighlighting(){return d().isHighlighting},get killLevel(){return d().killLevel},get grid(){return d().grid},applyCommand(O,G={}){let Q=d();if(O==="start_game")return Q.gameState!=="playing"?(m.startGame(),!0):!1;if(Q.gameState!=="playing")return!1;switch(O){case"rotate_piece":return m.rotatePieceByDir(),!0;case"move_down":return m.tryMoveDown();case"rotate_cylinder":{let{rot:vt}=G;return typeof vt=="number"&&m.canPlaceAtRot(Math.floor(Q.pieceY),vt)?(a({targetRot:vt,rotFloat:vt,rotVel:0}),Q.isGrounded&&m.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:vt,y:Pt}=G;return m.shootMagic(vt,Pt)}case"select_magic":{let{element:vt}=G;return m.selectMagic(vt),!0}default:return console.warn("GameEngine: unknown command",O),!1}},update(O,G){let Q=d();if(Q.gameState!=="playing")return;let vt=G-Q.startTime-Q.totalPausedMs;a({elapsedMs:vt}),b.updateTimeHud();let Pt=Q.killLevel+n()*O;if(a({killLevel:Pt}),b.updateRemainingHud(),Pt>=l()){m.endGame();return}if(Q.isHighlighting){let _t=(G-Q.highlightStartTime)/1e3,Yt;Q.isRingAnimation?Yt=h:Q.isMagicAnimation?Yt=g:Yt=r,_t>=Yt&&(Q.isRingAnimation?m.finishRingHighlight():m.finishHighlight())}let ne=Q.fallTimer+O;if(ne>=f&&(ne-=f,m.tryMoveDown()),a({fallTimer:ne}),m.updateGroundedState()){let _t=Q.lockTimer+O;a({lockTimer:_t}),_t>=c&&m.lockPiece()}},reset(){m.startGame()},canRotateTo(O,G){return m.canPlaceAtRot(O,G)},getRotation(){let O=d();return{targetRot:O.targetRot,rotFloat:O.rotFloat,rotVel:O.rotVel}},setRotation(O){a({targetRot:O,rotFloat:O,rotVel:0})},onGroundedMove(){m.maybeResetLockDelay()}}}var Ve=Math.PI*2;function ii(e){let{canvas:s,canvasCtx:l,getN:f,getH:c,TOP_PAD_PX:n,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:g,MAX_RADIUS_X:h,RADIUS_X_FACTOR:d,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:b,MAGIC_SHRINK_SEC:O,RING_HIGHLIGHT_SEC:G,LOCK_DELAY_SEC:Q,getKillRate:vt,ELEMENT_COLORS:Pt,ELEMENT_TO_COLOR:ne,BLOCK_COLOR_FRONT:Kt,BLOCK_COLOR_BACK:_t,ACTIVE_COLOR_FRONT:Yt,GHOST_COLOR_FILL:at,GHOST_COLOR_STROKE:Z,GHOST_STROKE_WIDTH:Bt,MAGIC_DIM_DOT_ALPHA:$t,MAGIC_DIM_DOT_SCALE:kt,MAGIC_TARGET_DOT_SCALE:I,getState:Ot,getVisualSettings:zt,funcs:It}=e,i=l,it=f(),st=c(),ie={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},V=[],K=40,$={ENABLED:!0,SPEED_THRESHOLD:30,SPEED_NORMALIZER:24,BRUSH_SPEED_NORMALIZER:26,MIN_DISTANCE_CELLS:3.2,MIN_CONFIRMED_FRAMES:3,DISTANCE_DECAY_PER_SEC:12,STRENGTH_DECAY_PER_SEC:3.8,STRENGTH_IDLE_DECAY_PER_SEC:6,STRENGTH_BLEND:.55,STRENGTH_GAIN:.9,MIN_RENDER_STRENGTH:.12,RECENT_VISIBLE_WINDOW_SEC:.2},H={prevPieceRef:null,prevPieceY:0,prevPieceSampleTs:0,brushStrength:0,speedCellsPerSec:0,distanceCells:0,confirmedFrames:0,recentVisibleTimerSec:0},Wt={ENABLED:!0,TRIGGER_TRAIL_STRENGTH:.16,MAX_OFFSET_PX:10,DOWN_DURATION_SEC:.055,RETURN_DURATION_SEC:.17,RESPECT_REDUCED_MOTION:!0},D={active:!1,startTs:0,amplitudePx:0,prevPieceRef:null,prevGrounded:!1},jt=typeof window<"u"&&typeof window.matchMedia=="function"?window.matchMedia("(prefers-reduced-motion: reduce)"):null;function lt(E,p,y,x,B){let w=Math.max(3,Math.round(E)),X=180;for(let Y=0;Y<w;Y++)setTimeout(()=>{let R=Math.random()>.5?"left":"right",Et=15,z=R==="left"?Et+Math.random()*Math.max(10,p-Et*2):y+Et+Math.random()*Math.max(10,B-y-Et*2),j=x-10;V.push({x:z,baseX:z,y:j,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:Et,maxX:B-Et})},Y*X)}function Ht(E,p,y){V=V.filter(x=>x.y>E+x.size&&x.y>-20);for(let x of V){x.y-=K*y,x.wobble+=x.wobbleSpeed*y;let B=x.baseX+Math.sin(x.wobble)*x.wobbleAmp;x.x=Math.max(x.minX,Math.min(x.maxX,B))}}function Qt(E){if(V.length!==0){i.fillStyle="rgba(255, 255, 255, 0.3)",i.strokeStyle="rgba(255, 255, 255, 0.5)",i.lineWidth=1;for(let p of V)p.y<E+p.size||(i.beginPath(),i.arc(p.x,p.y,p.size,0,Math.PI*2),i.fill(),i.stroke())}}let ae={left:0,right:0,h:0,w:0};function bt(E,p,y){let x=1-y/st;return E+x*p}function se(E){return E=E%it,E<0?E+it:E}function mt(E,p,y,x,B,w){let X=se(w),Y=(B-X)/it*Ve+a;return{x:E+Math.cos(Y)*y,y:p+Math.sin(Y)*x,ang:Y}}let ee=.52,Ce=1.02;function Tt(E,p,y,x,B,w){let X=se(w),Y=(B-X)/it*Ve+a;return{x:E+Math.cos(Y)*y,y:p+Math.sin(Y)*x,ang:Y}}function Re(E,p,y,x,B,w,X,Y=1){let R=Tt(E,p,y,x,B-ee,w),Et=Tt(E,p,y,x,B+ee,w),z={x:R.x,y:R.y-X*.5},j={x:R.x,y:R.y+X*.5},ft={x:Et.x,y:Et.y-X*.5},T={x:Et.x,y:Et.y+X*.5},N=(z.x+ft.x+T.x+j.x)*.25,ot=(z.y+ft.y+T.y+j.y)*.25,ce=Ce*Y,v=Y,wt=[z,ft,T,j].map(Ge=>({x:N+(Ge.x-N)*ce,y:ot+(Ge.y-ot)*v})),k=Math.abs((Et.x-R.x)*ce),Gt=Math.abs(X*v);return{corners:wt,cx:N,cy:ot,wApprox:k,hApprox:Gt,ang:Tt(E,p,y,x,B,w).ang}}function Ft(E,p,y,x,B,w,X,Y,R=1,Et=null,z=1,j=null,ft=0,T=1,N=1){let ot=Re(E,p,y,x,B,w,X,N),[ce,v,wt,k]=ot.corners;if(i.save(),i.globalAlpha=R,i.fillStyle=Y,i.beginPath(),i.moveTo(ce.x,ce.y),i.lineTo(v.x,v.y),i.lineTo(wt.x,wt.y),i.lineTo(k.x,k.y),i.closePath(),i.fill(),j&&ft>0&&(i.strokeStyle=j,i.lineWidth=ft,i.stroke()),Et){let Gt=Math.min(ot.wApprox,ot.hApprox)*.28*T;i.globalAlpha=R*z,i.fillStyle=Et,i.beginPath(),i.arc(ot.cx,ot.cy,Gt,0,Ve),i.fill()}i.restore(),i.globalAlpha=1}function Jt(E,p,y,x,B,w){let X=mt(E,p,y,x,B,w),Y=mt(E,p,y,x,B+1,w),R=mt(E,p,y,x,B-1,w),Et=Math.abs(Y.x-X.x),z=Math.abs(X.x-R.x),j=(Et+z)*.5*1.06;return Math.max(1,j)}function qe(E,p,y,x,B,w){let X=(B-w)/it*Ve+a;return{x:E+Math.cos(X)*y,y:p+Math.sin(X)*x,ang:X}}function Ke(E,p,y,x,B,w,X,Y=1,R=null,Et=1,z=null,j=0,ft=1){i.save(),i.translate(E,p);let T=Math.atan2(x,y);if(i.rotate(T),i.globalAlpha=Y,i.fillStyle=X,i.fillRect(-B/2,-w/2,B,w),z&&j>0&&(i.strokeStyle=z,i.lineWidth=j,i.strokeRect(-B/2,-w/2,B,w)),R){let N=Math.min(B,w)*.28*ft;i.globalAlpha=Y*Et,i.fillStyle=R,i.beginPath(),i.arc(0,0,N,0,Ve),i.fill()}i.restore(),i.globalAlpha=1}function pt(E){return Math.max(0,Math.min(1,E))}function xt(E,p){if(typeof E!="string"||E.length===0)return`rgba(255, 200, 180, ${p})`;if(E.startsWith("#")){let y=E.slice(1);if(y.length===3&&(y=y.split("").map(x=>x+x).join("")),y.length===6){let x=parseInt(y.slice(0,2),16),B=parseInt(y.slice(2,4),16),w=parseInt(y.slice(4,6),16);return`rgba(${x}, ${B}, ${w}, ${p})`}}if(E.startsWith("rgb")){let y=E.match(/[\d.]+/g);if(y&&y.length>=3){let x=Number(y[0]),B=Number(y[1]),w=Number(y[2]);return`rgba(${x}, ${B}, ${w}, ${p})`}}return`rgba(255, 200, 180, ${p})`}function ze(E,p,y,x,B,w,X,Y=0){if(B<=0)return;let R=pt((w-$.SPEED_THRESHOLD)/$.BRUSH_SPEED_NORMALIZER),Et=y*(4.6+R*4.4)*(.78+B*.22),z=Math.max(Y,y*(.58+B*.14)),j=Math.max(y*.06,z*(.09+(1-R)*.03)),ft=Math.sin(X*.01+E*.02)*y*.04*B,T=p-Et;i.save(),i.globalCompositeOperation="screen",i.beginPath(),i.moveTo(E-z,p),i.lineTo(E+z,p),i.lineTo(E+ft+j,T),i.lineTo(E+ft-j,T),i.closePath(),i.clip();let N=i.createLinearGradient(E,p,E+ft,T);N.addColorStop(0,xt(x,.62*B+.16)),N.addColorStop(.38,xt(x,.36*B+.09)),N.addColorStop(.7,xt(x,.14*B+.03)),N.addColorStop(1,xt(x,0)),i.fillStyle=N,i.fillRect(E-z-y,T-y,(z+y)*2,Et+y*2);let ot=Math.max(4,y*.22),ce=Math.max(1.15,ot*.22),v=Math.ceil((p-T)/ot)+1;for(let wt=0;wt<v;wt++){let k=p-wt*ot;if(k<T)break;let Gt=pt((k-T)/(p-T)),Ge=E+ft*(1-Gt),ye=j+(z-j)*Gt,je=ot,dn=Ge-ye+wt%2*je*.5;for(let re=dn;re<=Ge+ye;re+=je){let J=1-Math.abs(re-Ge)/Math.max(1,ye);if(J<=0)continue;let te=(.08+.62*Math.pow(Gt,1.55))*Math.pow(J,.65)*B;i.fillStyle=xt(x,te),i.beginPath(),i.arc(re,k,ce,0,Math.PI*2),i.fill()}}i.strokeStyle=xt(x,.2*B),i.lineWidth=Math.max(1,y*.05),i.beginPath(),i.moveTo(E+ft-j*.6,T+y*.05),i.lineTo(E-z*.72,p),i.moveTo(E+ft+j*.2,T+y*.08),i.lineTo(E+z*.35,p),i.stroke(),i.restore()}function tn(){H.prevPieceRef=null,H.prevPieceY=0,H.prevPieceSampleTs=0,H.speedCellsPerSec=0,H.distanceCells=0,H.confirmedFrames=0,H.recentVisibleTimerSec=0}function en(E,p=!1){let y=p?$.STRENGTH_IDLE_DECAY_PER_SEC:$.STRENGTH_DECAY_PER_SEC;H.brushStrength=Math.max(0,H.brushStrength-E*y)}function Zn(E,p,y,x){if(!$.ENABLED)return en(x,!1),{dropSpeed:0};let B=0,w=0;if(H.prevPieceRef===E&&H.prevPieceSampleTs>0){let Et=Math.max(.001,(y-H.prevPieceSampleTs)/1e3);w=H.prevPieceY-p,w>0&&(B=w/Et)}let X=pt((B-$.SPEED_THRESHOLD)/$.SPEED_NORMALIZER);X>0&&w>0?(H.confirmedFrames+=1,H.confirmedFrames>=$.MIN_CONFIRMED_FRAMES&&(H.distanceCells+=w)):(H.confirmedFrames=0,H.distanceCells=Math.max(0,H.distanceCells-x*$.DISTANCE_DECAY_PER_SEC));let Y=pt((H.distanceCells-$.MIN_DISTANCE_CELLS)/$.MIN_DISTANCE_CELLS),R=X*Y;return R>0?(H.brushStrength=Math.min(1,H.brushStrength*$.STRENGTH_BLEND+R*$.STRENGTH_GAIN),H.speedCellsPerSec=B):en(x,!1),H.brushStrength>$.MIN_RENDER_STRENGTH?H.recentVisibleTimerSec=$.RECENT_VISIBLE_WINDOW_SEC:H.recentVisibleTimerSec=Math.max(0,H.recentVisibleTimerSec-x),H.prevPieceRef=E,H.prevPieceY=p,H.prevPieceSampleTs=y,{dropSpeed:B}}function _e(E,p,y,x){if(!$.ENABLED||H.brushStrength<=$.MIN_RENDER_STRENGTH||E.length===0)return;let B=Math.max(...E.map(ft=>ft.cy)),w=E.filter(ft=>ft.cy===B),X=Math.min(...w.map(ft=>ft.topLeftX)),Y=Math.max(...w.map(ft=>ft.topRightX)),R=(X+Y)*.5,Et=Math.max(...w.map(ft=>ft.topY))+p*.03,z=Math.max(p*.45,(Y-X)*.5+p*.04),j=Pt[w[0].color]||"#ffd8a8";ze(R,Et,p,j,H.brushStrength,Math.max(H.speedCellsPerSec,y),x,z)}function Dt(){return!!(Wt.RESPECT_REDUCED_MOTION&&jt&&jt.matches)}function ln(E,p=1){!Wt.ENABLED||Dt()||(D.active=!0,D.startTs=E,D.amplitudePx=Wt.MAX_OFFSET_PX*pt(p),It&&typeof It.playImpact=="function"&&It.playImpact())}function yt(E,p,y){if(!Wt.ENABLED){D.prevPieceRef=E,D.prevGrounded=!!p;return}if(D.prevPieceRef!==E&&(D.prevGrounded=!1),!!E&&!!p&&!D.prevGrounded&&$.ENABLED){let B=Wt.TRIGGER_TRAIL_STRENGTH,w=H.recentVisibleTimerSec>0;if(H.brushStrength>=B||w){let X=Math.max(H.brushStrength,$.MIN_RENDER_STRENGTH),R=.72+pt((X-B)/Math.max(.001,1-B))*.28;ln(y,R)}}D.prevPieceRef=E,D.prevGrounded=!!p}function Hn(E){if(!Wt.ENABLED||!D.active||Dt())return 0;let p=Math.max(0,(E-D.startTs)/1e3),y=Wt.DOWN_DURATION_SEC,x=Wt.RETURN_DURATION_SEC;if(p<=y){let w=pt(p/y);return D.amplitudePx*(1-Math.pow(1-w,3))}let B=p-y;if(B<=x){let w=pt(B/x),X=Math.exp(-5.2*w);return D.amplitudePx*X*Math.cos(w*Math.PI*1.35)}return D.active=!1,0}return{resize(){let E=Math.max(1,Math.min(2,window.devicePixelRatio||1)),p=Math.floor(s.clientWidth*E),y=Math.floor(s.clientHeight*E);(s.width!==p||s.height!==y)&&(s.width=p,s.height=y,i.setTransform(E,0,0,E,0,0))},render(E=.016,p=performance.now()){this.resize();let y=Ot(),{activePiece:x,isGrounded:B}=y,w=Hn(p);it=f(),st=c();let X=s.clientWidth,Y=s.clientHeight;i.clearRect(0,0,X,Y),i.save(),w!==0&&i.translate(0,w),i.fillStyle="#0b0f14",i.fillRect(0,0,X,Y);let R=X*.5,Et=(X-2*g)/2,z=Y-n-r,j=6,ft=it*z/(j*st),T,N,ot,ce;ce=Y-r,ft<=Math.min(Et,h)?(T=ft,N=z,ot=n):(T=Math.min(Et,h),N=T*j*st/it,ot=ce-N);let v=T*.28,{killLevel:wt,rotFloat:k,grid:Gt,gameState:Ge}=y,ye=zt?zt():{},je=ye.waterColor||"blue",dn=ye.waterBubbles||!1,re=ie[je]||ie.blue,J=bt(ot,N,wt),te=.7,Tn=wt/st,S={...re.top},L={...re.bottom};if(Tn>te){let P=(Tn-te)/(1-te);S.r=Math.round(S.r+(255-S.r)*P*.5),S.g=Math.round(S.g+(150-S.g)*P*.5),S.b=Math.round(S.b+(150-S.b)*P*.5),L.r=Math.round(L.r+(180-L.r)*P),L.g=Math.round(L.g*(1-P*.6)),L.b=Math.round(L.b*(1-P*.6))}let M=R-T-8,gt=R+T+8,ht=ot,Rt=ce+5,oe=i.createLinearGradient(0,J,0,Y);oe.addColorStop(0,`rgba(${S.r},${S.g},${S.b},0.5)`),oe.addColorStop(1,`rgba(${L.r},${L.g},${L.b},0.7)`),i.fillStyle=oe;let le=Math.round((S.r+L.r)/2),Ne=Math.round((S.g+L.g)/2),nn=Math.round((S.b+L.b)/2),xn=T+8,Qe=v+4;i.fillRect(0,J,M,Y-J),i.fillRect(gt,J,X-gt,Y-J),i.beginPath();let Se=Math.max(J,Rt);i.moveTo(M,Se),J<=Rt+Qe?i.ellipse(R,Rt,xn,Qe,0,Math.PI,0,!1):i.lineTo(gt,Se),i.lineTo(gt,Y),i.lineTo(M,Y),i.closePath(),i.fill(),i.strokeStyle="rgba(100,180,255,0.6)",i.lineWidth=3,i.lineCap="round",i.beginPath(),i.moveTo(M,ht),i.lineTo(M,Rt),i.stroke(),i.beginPath(),i.moveTo(gt,ht),i.lineTo(gt,Rt),i.stroke(),i.beginPath(),i.ellipse(R,Rt,T+8,v+4,0,0,Math.PI),i.stroke(),i.fillStyle="#0b0f14",i.beginPath(),i.ellipse(R,Rt,T+8,v+4,0,0,Ve),i.fill(),wt>.5&&(i.strokeStyle=`rgba(${Math.min(255,le+60)},${Math.min(255,Ne+40)},${Math.min(255,nn+40)},0.6)`,i.lineWidth=2,i.beginPath(),i.moveTo(0,J),i.lineTo(M,J),i.moveTo(gt,J),i.lineTo(X,J),i.stroke()),ae={left:M,right:gt,h:Y,w:X},(V.length>0||dn)&&(Ht(J,Y,E),Qt(J)),i.strokeStyle="rgba(160,190,220,0.3)",i.lineWidth=1;let de=Ve*T,ue=10,Le=de/ue*.7,Cn=de/ue*.3;i.setLineDash([Le,Cn]);let Sn=de/it;i.lineDashOffset=se(k)*Sn;for(let P=0;P<=st;P++){let U=bt(ot,N,P);i.beginPath(),i.ellipse(R,U,T,v,0,0,Ve),i.stroke()}i.setLineDash([]);let sn=[],He=[];for(let P=0;P<st;P++){let U=bt(ot,N,P+.5);for(let tt=0;tt<it;tt++){let q=Gt[P][tt];if(!q)continue;let et=mt(R,U,T,v,tt,k),nt=Math.sin(et.ang),rt={y:P,s:tt,yScr:U,p:et,depth:nt,color:q};nt<-.1?sn.push(rt):He.push(rt)}}let fe=It.getMagicTargetColor(),{isHighlighting:Ze,highlightedCells:ge,highlightStartTime:$e,isMagicAnimation:En}=y,Ee=null,on=1,me=1,Be=!1;if(Ze&&ge.length>0){Ee=new Set(ge.map(U=>`${U.y},${U.s}`));let P=(performance.now()-$e)/1e3;if(En){let U=Math.min(1,P/O);on=1-U*.85,me=1-U*.9,Be=!0}else{let U=Math.min(1,P/m),tt=1-b;if(U>tt){let q=(U-tt)/b;on=1-q*.85,me=1-q*.9,Be=!0}}}sn.sort((P,U)=>P.depth-U.depth);for(let P of sn){let U=N/st*.9,tt=Pt[P.color]||null,q=.35,et=1,nt=`${P.y},${P.s}`;Ee&&Ee.has(nt)&&(q*=me,et=on),Ft(R,P.yScr,T,v,P.s,k,U,_t,q,tt,.5,null,0,1,et)}let{isRingAnimation:Ue}=y;if(Ze&&ge.length>0&&!En){let P=(performance.now()-$e)/1e3,tt=Math.min(1,P/(Ue?G:m)),q=1-b,et=tt>q,nt=et?(tt-q)/b:0,rt=Ue?Math.floor(tt*q*it*2)%it:-1,_=4+tt/q*10,F=Math.sin(P*_*Ve),dt=et?1:.3+F*.3,A=et?1-nt*.8:1,ut=et?1-nt:1;for(let Ct of ge){let Nt=bt(ot,N,Ct.y+.5),Zt=Tt(R,Nt,T,v,Ct.s,k);if(Math.sin(Zt.ang)>=-.1)continue;let Lt=N/st*.9,Me,Ae,we;if(Ue){let Xe=(Ct.s-rt+it)%it,mn=Xe<3?1-Xe/3:0;Me=(et?ut:.2+mn*.5)*.5,Ae=`rgba(255, 159, 67, ${Me})`,we=et?A:1+mn*.15}else Me=dt*ut,Ae=Ct.isLine?`rgba(255, 255, 255, ${Me*.5})`:`rgba(255, 220, 100, ${Me*.4})`,we=et?A:1.1;Ft(R,Nt,T,v,Ct.s,k,Lt,Ae,1,null,1,null,0,1,we)}}He.sort((P,U)=>P.depth-U.depth);for(let P of He){let U=N/st*.9,tt=Pt[P.color]||null,q=1,et=1,nt=1,rt=1,_=`${P.y},${P.s}`,F=Ee&&Ee.has(_);F&&(q=me,et=on),fe!==null&&!F&&(P.color!==fe?(nt=$t,rt=kt):rt=I),Ft(R,P.yScr,T,v,P.s,k,U,Kt,q,tt,nt,null,0,rt,et)}if(Ze&&ge.length>0&&!En){let P=(performance.now()-$e)/1e3,tt=Math.min(1,P/(Ue?G:m)),q=1-b,et=tt>q,nt=et?(tt-q)/b:0,rt=Ue?Math.floor(tt*q*it*2)%it:-1,_=4+tt/q*10,F=Math.sin(P*_*Ve),dt=et?1:.5+F*.5,A=et?1-nt*.8:1,ut=et?1-nt:1;for(let Ct of ge){let Nt=bt(ot,N,Ct.y+.5),Zt=Tt(R,Nt,T,v,Ct.s,k);if(Math.sin(Zt.ang)<-.1)continue;let Lt=N/st*.9,Me,Ae,we;if(Ue){let Xe=(Ct.s-rt+it)%it,mn=Xe<4?1-Xe/4:0;Me=et?ut:.3+mn*.7,Ae=`rgba(255, 159, 67, ${Me})`,we=et?A:1+mn*.2}else Me=dt*ut,Ae=Ct.isLine?`rgba(255, 255, 255, ${Me*.7})`:`rgba(255, 220, 100, ${Me*.6})`,we=et?A:1.15;Ft(R,Nt,T,v,Ct.s,k,Lt,Ae,1,null,1,null,0,1,we)}}let Fn=y.spellState||y,{transmuteState:Gn,transmuteSourceBlock:un,transmuteTargetColor:_s,transmuteAreaCells:fn,transmuteBlocksToChange:Mn}=Fn;if(Gn==="selecting_source"){let P=N/st*.9,U=.35+Math.sin(p/150)*.15;for(let tt of He){let q=bt(ot,N,tt.y+.5);Ft(R,q,T,v,tt.s,k,P,`rgba(0, 40, 20, ${U})`,1,null,1,null,0,1,1)}}if(Gn==="selecting_target"&&Mn&&Mn.length>0){let P=N/st*.9,U=.4+Math.sin(p/120)*.25,tt=.6+Math.sin(p/120)*.4;for(let q of Mn){if(q.y<0||q.y>=st)continue;let et=bt(ot,N,q.y+.5),nt=Tt(R,et,T,v,q.s,k);Math.sin(nt.ang)<-.1||(Ft(R,et,T,v,q.s,k,P,`rgba(0, 50, 30, ${U})`,1,null,1,null,0,1,1),Ft(R,et,T,v,q.s,k,P,"transparent",1,null,1,`rgba(100, 255, 150, ${tt})`,3,1,1.02))}}if(Gn==="animating"&&It.getTransmuteAnimState){let P=It.getTransmuteAnimState(p);if(P){let U=N/st*.9,{phase:tt,progress:q,areaFlash:et}=P;if(et>0&&fn)for(let nt of fn){if(nt.y<0||nt.y>=st)continue;let rt=bt(ot,N,nt.y+.5),_=Tt(R,rt,T,v,nt.s,k);Math.sin(_.ang)<-.1||Ft(R,rt,T,v,nt.s,k,U,`rgba(150, 255, 200, ${et*.4})`,1,null,1,null,0,1,1)}if(Mn&&Mn.length>0){let nt=un?un.color:1,rt=_s||1;for(let _ of Mn){if(_.y<0||_.y>=st)continue;let F=bt(ot,N,_.y+.5),dt=Tt(R,F,T,v,_.s,k);if(Math.sin(dt.ang)<-.1)continue;let ut=1,Ct=Pt[nt],Nt=0;if(tt==="shrink"?(ut=1-q*.95,Ct=Pt[nt],Nt=.5+q*.3):tt==="grow"&&(ut=q,Ct=Pt[rt],Nt=.8-q*.5),Nt>0&&Ft(R,F,T,v,_.s,k,U,`rgba(200, 255, 220, ${Nt})`,1,null,1,null,0,1,1),ut>.05){let Zt=Re(R,F,T,v,_.s,k,U,1),Ie=Math.min(Zt.wApprox,Zt.hApprox)*.28*ut;i.save(),i.globalAlpha=1,i.fillStyle=Ct,i.beginPath(),i.arc(Zt.cx,Zt.cy,Ie,0,Ve),i.fill(),i.restore()}}}}}let{lightningState:$n,lightningSourceBlock:Rs,lightningAreaCells:Jn,lightningBlocksToHit:gn}=Fn;if($n==="selecting_source"){let P=N/st*.9,U=.35+Math.sin(p/150)*.15;for(let tt of He){let q=bt(ot,N,tt.y+.5);Ft(R,q,T,v,tt.s,k,P,`rgba(20, 20, 60, ${U})`,1,null,1,null,0,1,1)}}if($n==="animating"&&It.getLightningAnimState){let P=It.getLightningAnimState(p);if(P&&gn&&gn.length>0){let U=N/st*.9,{phase:tt,flashProgress:q,currentTarget:et,jumpProgress:nt,struckTargets:rt}=P;if(tt==="flash"&&q>0&&Jn)for(let _ of Jn){if(_.y<0||_.y>=st)continue;let F=bt(ot,N,_.y+.5),dt=Tt(R,F,T,v,_.s,k);Math.sin(dt.ang)<-.1||Ft(R,F,T,v,_.s,k,U,`rgba(100, 150, 255, ${q*.5})`,1,null,1,null,0,1,1)}if(rt&&rt.length>0)for(let _ of rt){let F=gn[_];if(!F||F.y<0||F.y>=st)continue;let dt=bt(ot,N,F.y+.5),A=Tt(R,dt,T,v,F.s,k);if(Math.sin(A.ang)<-.1)continue;let Ct=(rt.length-1-rt.indexOf(_))*.1,Nt=Math.max(0,.8-Ct);Ft(R,dt,T,v,F.s,k,U,`rgba(255, 255, 255, ${Nt})`,1,null,1,`rgba(150, 200, 255, ${Nt})`,2,1,1.05)}if(tt==="chain"&&et>=0&&et<gn.length){let _=gn[et];if(_&&_.y>=0&&_.y<st){let F=bt(ot,N,_.y+.5),dt=Tt(R,F,T,v,_.s,k);if(Math.sin(dt.ang)>=-.1){let ut=1-nt;Ft(R,F,T,v,_.s,k,U,`rgba(200, 220, 255, ${ut*.9})`,1,null,1,`rgba(100, 180, 255, ${ut})`,3,1,1.1-nt*.05)}}if(et>0){let F=gn[et-1],dt=gn[et];if(F&&dt){let A=bt(ot,N,F.y+.5),ut=bt(ot,N,dt.y+.5),Ct=Re(R,A,T,v,F.s,k,U,1),Nt=Re(R,ut,T,v,dt.s,k,U,1);i.save(),i.strokeStyle=`rgba(150, 200, 255, ${1-nt*.5})`,i.lineWidth=2+(1-nt)*2,i.lineCap="round",i.beginPath();let Zt=Ct.cx,Ie=Ct.cy,Lt=Nt.cx,Me=Nt.cy;i.moveTo(Zt,Ie);let Ae=4;for(let we=1;we<=Ae;we++){let Xe=we/Ae,mn=Zt+(Lt-Zt)*Xe,_n=Ie+(Me-Ie)*Xe,Rn=we<Ae?(Math.random()-.5)*8:0;i.lineTo(mn+Rn,_n+Rn)}i.stroke(),i.strokeStyle=`rgba(100, 150, 255, ${(1-nt)*.3})`,i.lineWidth=6,i.stroke(),i.restore()}}}}}let{fireState:ts,fireSourceBlock:es,fireLineCells:Bn,fireTargets:In}=Fn;if(ts==="selecting_source"){let P=N/st*.9,U=.3+Math.sin(p/140)*.2;for(let tt of He){let q=bt(ot,N,tt.y+.5);Ft(R,q,T,v,tt.s,k,P,`rgba(70, 25, 10, ${U})`,1,null,1,null,0,1,1)}}if(ts==="animating"&&It.getFireAnimState){let P=It.getFireAnimState(p);if(P&&Bn&&Bn.length>0){let U=N/st*.9,{progress:tt,flashProgress:q}=P,et=Math.sin(tt*Math.PI);if(q>0)for(let nt of Bn){if(nt.y<0||nt.y>=st)continue;let rt=bt(ot,N,nt.y+.5),_=Tt(R,rt,T,v,nt.s,k);Math.sin(_.ang)<-.1||Ft(R,rt,T,v,nt.s,k,U,`rgba(255, 120, 50, ${q*.45})`,1,null,1,`rgba(255, 200, 140, ${q*.5})`,2,1,1.03)}if(es){let nt=new Map;for(let _ of Bn){if(_.y<0||_.y>=st)continue;let F=bt(ot,N,_.y+.5),dt=Tt(R,F,T,v,_.s,k);if(Math.sin(dt.ang)<-.1)continue;let ut=Re(R,F,T,v,_.s,k,U,1),Ct=_.s-es.s;Ct>it/2&&(Ct-=it),Ct<-it/2&&(Ct+=it);let Nt=_.y;nt.has(Nt)||nt.set(Nt,[]),nt.get(Nt).push({x:ut.cx,y:ut.cy,offset:Ct})}let rt=Array.from(nt.keys()).sort((_,F)=>F-_);if(rt.length>0){let _=.35+.3*Math.sin(p/60)+et*.2;i.save(),i.lineCap="round";for(let F of rt){let dt=nt.get(F)||[];if(dt.sort((A,ut)=>A.offset-ut.offset),dt.length!==0){i.beginPath(),i.moveTo(dt[0].x,dt[0].y);for(let A=1;A<dt.length;A++)i.lineTo(dt[A].x,dt[A].y);i.strokeStyle=`rgba(255, 140, 60, ${_})`,i.lineWidth=Math.max(2,U*.15),i.stroke(),i.strokeStyle=`rgba(255, 210, 140, ${_*.35})`,i.lineWidth=Math.max(6,U*.35),i.stroke()}}i.restore()}}if(In&&In.length>0){let nt=.2+et*.6;for(let rt of In){if(rt.y<0||rt.y>=st)continue;let _=bt(ot,N,rt.y+.5),F=Tt(R,_,T,v,rt.s,k);Math.sin(F.ang)<-.1||Ft(R,_,T,v,rt.s,k,U,`rgba(255, 160, 70, ${nt})`,1,null,1,`rgba(255, 230, 180, ${et*.6})`,2,1,1.05)}}}}let{pieceY:ns,lockTimer:ss}=y;if(x){let{dropSpeed:P}=Zn(x,ns,p,E),U=It.snappedRot(),tt=U,q=It.computeGhostY(),et=N/st*.9;if(q!==null){let _=[];for(let F=0;F<x.cells.length;F++){let dt=x.cells[F],A=x.colors[F],ut=q+dt.y,Ct=It.normSector(U+dt.x);if(ut<0||ut>=st)continue;let Nt=bt(ot,N,ut+.5),Zt=Tt(R,Nt,T,v,Ct,tt);_.push({cy:ut,cs:Ct,yScr:Nt,depth:Math.sin(Zt.ang),color:A})}_.sort((F,dt)=>F.depth-dt.depth);for(let F of _){let dt=Pt[F.color]||null;Ft(R,F.yScr,T,v,F.cs,tt,et,at,1,dt,.5,Z,Bt,1,1)}}let nt=Yt;if(B&&ss>0){let _=Math.min(1,ss/Q),F=255,dt=Math.round(170+85*_),A=Math.round(180+75*_),ut=.75+(1-.75)*_;nt=`rgba(${F},${dt},${A},${ut})`}let rt=[];for(let _=0;_<x.cells.length;_++){let F=x.cells[_],dt=x.colors[_],A=It.normSector(U+F.x),ut=ns+F.y;if(ut<0||ut>=st)continue;let Ct=bt(ot,N,ut+.5),Nt=Tt(R,Ct,T,v,A,tt),Zt=Re(R,Ct,T,v,A,tt,et,1),[Ie,Lt]=Zt.corners;rt.push({cs:A,yScr:Ct,x:Nt.x,depth:Math.sin(Nt.ang),color:dt,cy:ut,topY:Math.max(Ie.y,Lt.y),topLeftX:Math.min(Ie.x,Lt.x),topRightX:Math.max(Ie.x,Lt.x)})}_e(rt,et,P,p),rt.sort((_,F)=>_.depth-F.depth);for(let _ of rt){let F=Pt[_.color]||null;Ft(R,_.yScr,T,v,_.cs,tt,et,nt,1,F,1,null,0,1,1)}}else tn(),en(E,!0);yt(x,B,p),i.restore()},drawNextPreview(E,p){if(!E)return;let y=E.getContext("2d"),x=E.width,B=E.height;if(y.clearRect(0,0,x,B),!p)return;let w=1/0,X=-1/0,Y=1/0,R=-1/0;for(let N of p.cells)w=Math.min(w,N.x),X=Math.max(X,N.x),Y=Math.min(Y,N.y),R=Math.max(R,N.y);let Et=X-w+1,z=R-Y+1,j=Math.min(x/(Et+.5),B/(z+.5)),ft=(x-Et*j)/2,T=(B-z*j)/2;y.fillStyle=Kt;for(let N=0;N<p.cells.length;N++){let ot=p.cells[N],ce=ft+(ot.x-w)*j,v=T+(z-1-(ot.y-Y))*j;y.fillRect(ce+1,v+1,j-2,j-2);let wt=p.colors[N],k=Pt[wt];if(k){let Gt=(j-2)*.32;y.fillStyle=k,y.beginPath(),y.arc(ce+j/2,v+j/2,Gt,0,Ve),y.fill(),y.fillStyle=Kt}}},spawnBonusBubbles(E){let{left:p,right:y,h:x,w:B}=ae;B>0&&lt(E,p,y,x,B)}}}(()=>{let e=No(),s=e.canvas,l=s.getContext("2d");s.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let f=Math.PI*2,c=30,n=24,r=120,g={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function h(t){let o=g[t]||g["30_24"];c=o.N,n=o.H,r=o.survivalTime}function d(){return n/r}let a=Math.PI/2,m=70,b=120,O=30,G=320,Q=.42,vt="rgb(235,240,250)",Pt="rgb(55,62,75)",ne="rgba(255,170,180,0.75)",Kt="rgba(110,255,150,0.15)",_t="rgba(110,255,150,0.85)",Yt=2,at={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Z={1:"fire",2:"water",3:"lightning",4:"earth"},Bt={fire:1,water:2,lightning:3,earth:4},$t=1,kt=.58,I=!0,Ot=12,zt=25,It=1,i=2,it=3,st=1,ie={fire:1,water:1,lightning:1,earth:1},V=5,K=7,$=10,H=3,Wt=50,D=2,jt=.3,lt=.5,Ht=1,Qt=.3,ae=.5,bt=1.3,se=10,mt=1e3,ee=[1,1.25,1.5,1.75,2],Ce=10,Tt=20,Re=5,Ft=[1,1.3,1.6,2,2.4,2.8],Jt=[1,1.1,1.2,1.3,1.4,1.5],qe=[1,1.5,2,2.5,3,3.5],Ke=[1,1.3,1.6,2,2.4,2.8],pt=Do(),xt=pt.loadGameSettings();xt.hapticsEnabled===void 0&&(xt.hapticsEnabled=!0);let ze=xt.invertSwipe?-1:1,tn=xt.showControls!==!1,en=xt.tapRotate===!0,_e=!1,Dt=-1,ln=Xo({enabled:xt.hapticsEnabled}),yt=Array.from({length:n},()=>new Uint8Array(c));function Hn(){yt=Array.from({length:n},()=>new Uint8Array(c))}let E=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],p=null,y=n+3,x=0,B=0,w=!1,X=0,Y=0,R=0,Et=3,z=0,j=0,ft=0,T=Ko({canvas:s,rotDir:ze}),N="0.18.3",ot=!0,ce="blue",v=Ao();v.preload();let wt=zo(),k="intro",Gt=0,Ge=0,ye=0,je=0,dn=0,re=null,J=wt.stats,te=0,Tn=e.overlay,S=e.gameContainer,L=Fo({elementColors:at}),M=L.showBonus.bind(L),gt=L.getElementIcon.bind(L),ht=Go(),Rt=e.overlayTitle,oe=e.overlayStats,le=e.startBtn,Ne=e.hud,nn=e.scoreHud,xn=e.timeHud,Qe=e.remainingHud,Se=e.nextCanvas,de=Se.getContext("2d"),ue=e.pauseBtn,Le=e.pauseOverlay,Cn=e.resumeBtn,Sn=e.restartBtn,sn=e.exitToMenuBtn,He=e.pauseSettingsBtn,fe=e.pauseSoundBtn,Ze=e.pauseMusicBtn,ge=e.pauseBestScore,$e=e.pauseBestTime,En=e.pauseBestMode,Ee=e.pauseCurrentScore,on=e.pauseCurrentTime,me=e.pauseCurrentMode,Be=e.confirmDialog,Ue=e.confirmText,Fn=e.confirmCancel,Gn=e.confirmOk,un=e.settingsOverlay,_s=e.settingsClose,fn=e.fullscreenBtn,Mn=e.rotateBtn,$n=e.startPanel,Rs=e.gameoverPanel,Jn=e.goScore,gn=e.goTime,ts=e.goRing,es=e.goMatches,Bn=e.goBonuses,In=e.goNewRecord,ns=e.goRestartBtn,ss=e.goExitBtn,P=e.bestScore,U=e.bestTimeVal,tt=e.startVersion,q=e.modeBtns,et=e.recordsBtn,nt=e.startSettingsBtn,rt=e.helpBtn;Uo({helpBtn:rt});let _="25_20";function F(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function dt(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,C=g[u];if(!C)return;let W=o.querySelector(".mode-tag.time-tag");if(!W)return;let ct=F(C.survivalTime);ct&&(W.textContent=ct)})}dt();let A=Yo({buttons:e.magicBtns,onActivate:()=>v.play("spells"),onChange:(t,o)=>{Bs()}}),ut=e.magicBtns,Ct=A.charges,Nt=t=>Pe()?A.select(t):!1,Zt=()=>A.updateButtons(),Ie=e.magicRow,Lt=e.magicActiveIndicator,Me=e.magicActiveIcon,Ae=e.magicActiveCost,we={ice:"water",air:"lightning",earth:"earth",fire:"fire"},Xe={fire:"fire",water:"ice",lightning:"air",earth:"earth"},mn=["ice","earth","air","fire"];te=pt.loadHighTowerRings();function _n(t){return typeof pe?.getUnlockRings=="function"?pe.getUnlockRings(t):0}function Rn(t){let o=_n(t);return o===0||te>=o}let js=["fire","water","lightning","earth"],An=null,os=!1,ai=500,ci=30,ri=220,wn=null,Ls=null,Qs={fire:!1,water:!1,lightning:!1,earth:!1};function Zs(){if(!Lt)return;let t=Lt.getBoundingClientRect();t.width>0&&t.height>0&&(Ls=t)}function li(){if(!Lt)return null;let t=Lt.getBoundingClientRect();return t.width>0&&t.height>0?Lt:Ls?{getBoundingClientRect:()=>Ls}:null}function Un(t=A.active){if(!Lt||!Me)return;t?(An=t,os=!1):os||(An=null);let o=An;if(!o||!Pe()||(A.charges[o]??0)<=0){Zs(),Lt.classList.add("hidden"),Lt.classList.remove("active","ult-ready",...js),Lt.style.setProperty("--progress","0%"),wn&&clearTimeout(wn),wn=setTimeout(()=>{Lt.classList.add("gone")},ri);return}wn&&(clearTimeout(wn),wn=null),Lt.classList.remove("gone"),Lt.classList.contains("hidden")?requestAnimationFrame(()=>Lt.classList.remove("hidden")):Lt.classList.remove("hidden"),Me.textContent=gt(o);let C=Xe[o];C&&pe.selectSpell(C);let W=C?Yn(C):0,ct=A.charges[o]??0,Mt=!!C&&cs()&&Rn(C),Xt=!!C&&cs()&&!Mt,he=Mt&&W>0?Math.min(ct/W,1):0,ke=Mt&&W>0,Fe=ke&&ct>=W;Ae&&(Ae.textContent=ke?`-${W}`:Xt?"\u{1F512}":""),Lt.classList.toggle("no-cost",!ke&&!Xt),Lt.classList.toggle("locked",Xt),Lt.classList.toggle("ult-ready",Fe),Lt.style.setProperty("--progress",`${Math.round(he*100)}%`),Lt.classList.remove("hidden",...js),Lt.classList.add("active",o),Zs()}function di(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),ai))}function is(){for(let[t,o]of Object.entries(ut)){if(!o)continue;let u=Xe[t],C=Yn(u),W=cs()&&Pe()&&u,ct=typeof Rn=="function"?Rn(u):!0,Mt=W&&ct&&C>0&&(A.charges[t]??0)>=C;o.classList.toggle("ult-ready",Mt),Mt&&!Qs[t]&&(di(o),k==="playing"&&v.play("readysuper")),Qs[t]=Mt}}function Pe(t=_){return t==="30_24"?!0:_e}function Bs(){Un(A.active),is()}function da(t){_e=t,_==="25_20"&&(_e?A.reset():(A.deactivate(),Object.keys(A.charges).forEach(o=>{A.charges[o]=0})),Zt()),as(),Bs()}function as(){Ie&&(Ie.style.display=Pe()?"":"none",Un(A.active),is())}function ua(t){let o=Pn(t),u=Yn(t);return!o||u<=0?!1:A.charges[o]>=u}function fa(t){let o=Pn(t),u=Yn(t);return!o||u<=0||A.charges[o]<u?!1:(A.charges[o]-=u,A.updateButtons(),pe.pulse(),!0)}let Xn=e.spellWave;function ui(){Xn&&(Xn.classList.remove("active"),Xn.offsetWidth,Xn.classList.add("active"),setTimeout(()=>Xn.classList.remove("active"),1200))}let pn=null,pe=Wo({button:Lt,onReady:()=>{v.play("readysuper")}}),fi=()=>pe.getEffect("earth"),gi=()=>pe.getEffect("air"),mi=()=>pe.getEffect("fire"),Yn=t=>typeof pe?.getCost=="function"?pe.getCost(t):0,Pn=t=>we[t]??null;pn=qo({canvas:s,dom:e,getGrid:()=>yt,getN:()=>c,getH:()=>n,getRotFloat:()=>z,constants:{TOP_PAD_PX:m,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:O,MAX_RADIUS_X:G,SCORE_MAGIC_DESTROY:Re},helpers:{normSector:fs,levelYToScreenY:ls,sectorCenterXY:ds},Spell:pe,Magic:A,SoundModule:v,State:wt,isGamePlaying:()=>k==="playing",addPendingKzDrop:t=>{R+=t},getKillRate:d,triggerSpellWave:ui,spawnSpellBubbles:t=>{let o=Pn(pe.currentSpell)??"water";ht.spawnSpellBubbles(pe.button,o,t)},spawnBonusBubbles:t=>{Dn.spawnBonusBubbles(t)},getTransmuteEffect:fi,getLightningEffect:gi,getFireEffect:mi,continueMatchProcessing:us,updateScoreHud:Kn,showBonus:M,getSpellCost:Yn,getSpellElement:Pn,onUltimateApplied:t=>{let o=Pn(t)??Pn(pe.currentSpell)??"water";if(typeof ht?.spawnSpellBubbles=="function"){let u=li();u&&ht.spawnSpellBubbles(u,o,ci)}os=!1,An=null,Un(null),is()},isSpellBlocked:pi,setScore:t=>{Gt=t},setCascadeLevel:t=>{rn=t}});function cs(){return _==="30_24"}function rs(){Un(A.active),is()}let hn=[],Wn=0,an=!1,vn=!1,kn=!1,Ye=0,cn=0,rn=0,On=[];function pi(){return an||vn||kn}function ls(t,o,u){let C=1-u/n;return t+C*o}function ds(t,o,u,C,W,ct){let Mt=(W-ct)/c*f+a;return{x:t+Math.cos(Mt)*u,y:o+Math.sin(Mt)*C,ang:Mt}}function Is(t,o){let u=s.clientWidth,C=s.clientHeight,W=u*.5,ct=(u-2*O)/2,Mt=C-m-b,Xt=6,he=c*Mt/(Xt*n),ke=C-b,Fe,be,ve;he<=Math.min(ct,G)?(Fe=he,be=Mt,ve=m):(Fe=Math.min(ct,G),be=Fe*Xt*n/c,ve=ke-be);let Vt=Fe*.28,At=ls(ve,be,t+.5),St=ds(W,At,Fe,Vt,o,z),qt=s.getBoundingClientRect();return{x:qt.left+St.x,y:qt.top+St.y}}function hi(t,o){if(!Pe()||!A.canUse()||an)return!1;let u=Bt[A.active],C=s.clientWidth,W=s.clientHeight,ct=C*.5,Mt=(C-2*O)/2,Xt=W-m-b,he=6,ke=c*Xt/(he*n),Fe=W-b,be,ve,Vt;ke<=Math.min(Mt,G)?(be=ke,ve=Xt,Vt=m):(be=Math.min(Mt,G),ve=be*he*n/c,Vt=Fe-ve);let At=be*.28,St=null,qt=1/0;for(let Te=0;Te<n;Te++){let Oe=ls(Vt,ve,Te+.5);for(let xe=0;xe<c;xe++){let De=yt[Te][xe];if(!De||De!==u)continue;let We=ds(ct,Oe,be,At,xe,z);if(Math.sin(We.ang)<-.1)continue;let bs=t-We.x,_o=o-We.y,Ro=Math.hypot(bs,_o),Lo=ve/n*.9,Ki=Lo*1.2;Math.abs(bs)<Ki/2&&Math.abs(_o)<Lo/2&&Ro<qt&&(qt=Ro,St={y:Te,s:xe})}}if(St){let Te=ls(Vt,ve,St.y+.5),Oe=ds(ct,Te,be,At,St.s,z),xe=s.getBoundingClientRect(),De=xe.left+Oe.x,We=xe.top+Oe.y,Co=ut[A.active];return ht.spawnMagicShot(A.active,Co,De,We,()=>{let bs=yt[St.y][St.s];hn=[{y:St.y,s:St.s,color:bs,isLine:!1,isMagic:!0}],Wn=performance.now(),an=!0,vn=!0,Ye=0,cn=Re,M(`+${Re}`,"score")}),rn=1,A.useCharge(),J.magicUsed++,!0}return!1}let ga=100;function ma(t,o){return Ks(t,o,n,c)}function vi(){return Zo(yt,n,c)}let yi=Jo;function Si(t){let o=t.map(C=>({...C,color:yt[C.y][C.s]}));for(let C of t)yt[C.y][C.s]=0;let u=n;for(let C of t){let W=C.y;for(let ct=1;ct<=C.y;ct++){let Mt=C.y-ct;if(yt[Mt][C.s]){W=ct-1;break}}u=Math.min(u,W)}for(let C of o)yt[C.y-u][C.s]=C.color;return u>0}function Ei(){let t=!0;for(;t;){t=!1;let o=vi();for(let u of o)yi(u)||Si(u)&&(t=!0)}}function Mi(){us()}let Vn=jo;function Js(t,o){let u=new Map,C=0,W=0,ct=0,Mt={},Xt=t.length+o.length;for(let At of t){let St=Z[At.color],qt=0,Te=0;if(At.length>=5?(qt=it,Te=$,J.lines5++):At.length===4?(qt=i,Te=K,J.lines4++):At.length===3&&(qt=It,Te=V,J.lines3++),Pe()&&St&&qt>0){A.addCharges(St,qt),Mt[St]=(Mt[St]||0)+qt;let Oe=At.cells[Math.floor(At.cells.length/2)],xe=Is(Oe.y,Oe.s),De=ut[St];for(let We=0;We<qt;We++)setTimeout(()=>{ht.spawnMagicOrb(St,xe.x,xe.y,De,()=>{A.onChargeArrive(St)})},We*100)}C+=Te*d(),ct+=Te,W+=At.length*Ce;for(let Oe of At.cells){let xe=`${Oe.y},${Oe.s}`;u.has(xe)||u.set(xe,{y:Oe.y,s:Oe.s,color:At.color,isLine:!0})}}for(let At of o){if(J.pairs++,C+=H*d(),ct+=H,W+=Tt,Pe()){let St=[...new Set(At.cells.map(qt=>yt[qt.y][qt.s]).filter(Boolean))];if(St.length>0){let qt=At.cells[Math.floor(At.cells.length/2)],Te=Is(qt.y,qt.s);St.forEach((Oe,xe)=>{let De=Z[Oe];if(!De)return;A.addCharges(De,st),Mt[De]=(Mt[De]||0)+st;let We=ut[De];We&&setTimeout(()=>{ht.spawnMagicOrb(De,Te.x,Te.y,We,()=>{A.onChargeArrive(De)})},xe*100)})}}for(let St of At.cells){let qt=`${St.y},${St.s}`;u.has(qt)||u.set(qt,{y:St.y,s:St.s,color:yt[St.y][St.s],isLine:!1})}}let he=Vn(Ft,Xt-1),ke=Vn(Jt,Xt-1),Fe=Vn(qe,rn),be=Vn(Ke,rn),ve=Math.round(W*he*Fe);ct=Math.round(ct*ke*be),C=Math.round(C*ke*be);let Vt=0;Xt>1&&(J.combos++,J.maxCombo=Math.max(J.maxCombo,Xt),setTimeout(()=>M(`COMBO \xD7${Xt}`,"combo"),Vt),Vt+=180,v.play("combo2")),rn>0&&(J.cascades++,J.maxCascade=Math.max(J.maxCascade,rn),setTimeout(()=>M(`CASCADE \xD7${rn}`,"cascade"),Vt),Vt+=180,v.play("cascade")),(t.length>0||o.length>0)&&v.play("combo");for(let At of t){let St=At.length,qt=St*Ce;setTimeout(()=>M(`Line-${St} +${qt}`,"line",At.color),Vt),Vt+=100}for(let At of o){let St=At.cells.length>0?yt[At.cells[0].y][At.cells[0].s]:null;setTimeout(()=>M(`Pair +${Tt}`,"pair",St),Vt),Vt+=100}ve>0&&(setTimeout(()=>M(`+${ve}`,"score"),Vt),Vt+=120),ct>0&&(setTimeout(()=>M(`+${ct}s`,"time"),Vt),Vt+=120);for(let[At,St]of Object.entries(Mt))St>0&&(setTimeout(()=>M(`+${St}${gt(At)}`,"charge"),Vt),Vt+=120);hn=Array.from(u.values()),Wn=performance.now(),an=!0,vn=!1,Ye=C,cn=ve,Zt()}function bi(){let t=vn;for(let o of hn)yt[o.y][o.s]=0;if(hn.length>0&&v.playRandom("disappear"),Ye>0){R+=Ye;let o=Ye/d();Dn.spawnBonusBubbles(o)}wt.addScore(cn),Gt+=cn,Kn(),hn=[],an=!1,vn=!1,Ye=0,cn=0,t||rn++,us()}function us(){Ei();let{lineMatches:t,pairMatches:o}=wi();if(t.length>0||o.length>0)Js(t,o);else{let u=io();u.length>0?Bi(u):!p&&k==="playing"&&oo()}}function pa(t,o){Js(t,o)}function fs(t){return Nn(t,c)}function gs(){return fs(Math.round(z))}function to(t,o){return zs(p,t,o,yt,n,c)}function ms(t){return to(t,gs())}let ps=Qo;function eo(){I&&(Ot!==0&&X>=Ot||(B=0,X+=1))}function Ti(){if(!p)return;let t=p.cells,o=p.colors,u={cells:t,colors:o};if(Dt>=0||(u=ps(u.cells,u.colors),u=ps(u.cells,u.colors)),u=ps(u.cells,u.colors),p.cells=u.cells,p.colors=u.colors,!ms(Math.floor(y))){p.cells=t,p.colors=o;return}v.play("turn"),w&&eo()}function xi(){return ti(p,y,gs(),yt,n,c)}function Ci(){if(!p)return!1;let t=Math.floor(y)-1,o=!ms(t);return o&&!w?(w=!0,B=0,X=0):!o&&w&&(w=!1,B=0,X=0),o}let Ln=Cs;function qn(){if(k==="playing"){Tn.classList.add("hidden"),ue.classList.remove("hidden");return}if(Tn.classList.remove("hidden"),ue.classList.add("hidden"),k==="intro"){$n.classList.remove("hidden"),Rs.classList.add("hidden");let t=pt.loadHighscore(_);t.score>0?(P.textContent=t.score.toLocaleString(),U.textContent=Ln(t.time)):(P.textContent="0",U.textContent="0:00"),Us(),tt.textContent=`v${N}`,le.classList.remove("idlePulse"),le.offsetWidth,le.classList.add("idlePulse")}else{$n.classList.add("hidden"),Rs.classList.remove("hidden"),Jn.textContent=Gt.toLocaleString(),gn.textContent=Ln(ye);let t=pt.loadHighscore(_);Gt>0&&Gt>=t.score?In.classList.remove("hidden"):In.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${J.rings}</span>
          <span class="count ring-max">${J.maxRing>0?"max \xD7"+J.maxRing:""}</span>
        </div>
      `;ts.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${J.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${J.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${J.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${J.pairs}</span>
        </div>
      `;es.innerHTML=u;let C=Pe()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${J.magicUsed}</span>
        </div>
      `:"",W=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${J.combos}</span>
          <span class="count max-combo">${J.maxCombo>0?"max \xD7"+J.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${J.cascades}</span>
          <span class="count max-cascade">${J.maxCascade>0?"max \xD7"+J.maxCascade:""}</span>
        </div>
        ${C}
      `;Bn.innerHTML=W}}function Kn(){nn.textContent=`Score: ${Gt}`}function As(){xn.textContent=`Time: ${Ln(ye)}`}function no(){let t=Math.max(0,(n-Y)/d()),o=Math.floor(t/60),u=Math.floor(t%60);Qe.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?Qe.classList.add("warning"):Qe.classList.remove("warning")}function _i(){h(_),Hn(),Y=0,R=0,z=j=0,ft=0,wt.start(),J=wt.stats,Gt=0,Ge=performance.now(),ye=0,dn=0,je=0,k="playing",re=null,Pe()?A.reset():(A.deactivate(),Object.keys(A.charges).forEach(t=>{A.charges[t]=0}),Zt()),pe.reset(),rs(),hn=[],On=[],an=!1,vn=!1,kn=!1,Ye=0,cn=0,rn=0,pn.reset(),Zt(),Kn(),As(),no(),Bs(),oo(),Dn.drawNextPreview(Se,re),qn(),v.getSettings().musicEnabled&&v.startGameMusic()}function ws(){wt.gameOver(),k="gameover",p=null,w=!1,B=0,X=0;let t=pt.saveHighscore(Gt,ye,_);v.stopMusic(),v.play("gameover"),As(),qn(),t&&Gt>0&&setTimeout(()=>{M("\u{1F3C6} NEW RECORD!","score")},500)}function Ri(t){for(let u=0;u<50;u++){let C=t.map(()=>1+(Math.random()*4|0));if(!Li(t,C))return C}return t.map((u,C)=>1+C%4)}let Li=si;function so(t){let o=t.cells.map(C=>({x:C.x,y:C.y})),u=Ri(o);return{name:t.name,cells:o,colors:u}}function oo(){if(!re){let W=E[Math.random()*E.length|0];re=so(W)}p=re;let t=E[Math.random()*E.length|0];re=so(t),Dn.drawNextPreview(Se,re);let o=1/0,u=-1/0;for(let W of p.cells)W.x<o&&(o=W.x),W.x>u&&(u=W.x);let C=(o+u)/2;for(let W of p.cells)W.x=W.x-Math.round(C);y=n+3,x=0,w=!1,B=0,X=0,ms(Math.floor(y))||ws()}function io(){return ni(yt,n,c)}function Bi(t){if(t.length===0)return;let o=[];for(let Xt of t)for(let he=0;he<c;he++)o.push({y:Xt,s:he,color:yt[Xt][he],isLine:!1});On=t,hn=o,Wn=performance.now(),an=!0,kn=!0,vn=!1;let u=t.length;J.rings+=u,J.maxRing=Math.max(J.maxRing,u);let C=Vn(ee,u-1),W=Math.round(mt*u*C),ct=Wt*u;if(cn=W,Ye=ct*d(),Pe()){for(let[Xt,he]of Object.entries(ie))if(he>0){let ke=he*u;A.addCharges(Xt,ke);let Fe=Math.floor(c/2),be=t[0],ve=Is(be,Fe),Vt=ut[Xt];if(Vt)for(let At=0;At<ke;At++)setTimeout(()=>{ht.spawnMagicOrb(Xt,ve.x,ve.y,Vt,()=>{A.onChargeArrive(Xt)})},At*100)}}v.play("ring");let Mt=`RING \xD7${u}`;M(Mt,"ring"),setTimeout(()=>M(`+${W}`,"score"),150),setTimeout(()=>M(`+${ct}s`,"time"),300)}function Ii(){let t=[...On].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<n-1;u++)yt[u].set(yt[u+1]);yt[n-1].fill(0)}if(Ye>0){R+=Ye;let o=Ye/d();Dn.spawnBonusBubbles(o)}wt.addScore(cn),Gt+=cn,Kn(),_==="30_24"&&On.length>0&&(te=pt.addHighTowerRings(On.length)),hn=[],On=[],an=!1,kn=!1,Ye=0,cn=0,us()}function ha(){return io().length}function Ai(){if(!p)return;let t=gs();z=t,j=t,ft=0;let o=!1;for(let u=0;u<p.cells.length;u++){let C=p.cells[u],W=p.colors[u],ct=Math.floor(y)+C.y,Mt=fs(t+C.x);ct>=n&&(o=!0),ct>=0&&ct<n&&(yt[ct][Mt]=W)}if(o){ws();return}wt.addScore(se),Gt+=se,Kn(),M(`+${se}`,"score"),v.playRandom("drop"),p=null,rn=0,Mi()}function wi(){return ei(yt,n,c)}function Pi(){if(!p)return!1;let t=Math.floor(y)-1;return ms(t)?(y=t,w=!1,B=0,X=0,!0):(w=!0,!1)}s.addEventListener("pointerdown",t=>{if(Ut.state!=="playing")return;t.preventDefault?.();let o=s.getBoundingClientRect(),u=t.clientX-o.left,C=t.clientY-o.top;T.handlePointerDown(t,{onMagicTap:Pe()?()=>pn.handleTap(u,C)?!0:Ut.applyCommand("magic_shoot",{x:u,y:C}):null,onDoubleTap:()=>Ut.applyCommand("rotate_piece")},j)||(ft=0)},{passive:!1}),s.addEventListener("pointermove",t=>{if(Ut.state!=="playing"||!T.dragging)return;t.preventDefault?.();let o=T.handlePointerMove(t,{canRotateTo:(u,C)=>Ut.canRotateTo(u,C),onDrop:()=>Ut.applyCommand("move_down"),onGroundedMove:()=>Ut.onGroundedMove(),onRotateStep:()=>ln.trigger("tower_rotate")},Ut.pieceY,Ut.isGrounded);o&&Ut.setRotation(o.targetRot)},{passive:!1}),s.addEventListener("pointerup",t=>{Ut.state==="playing"&&T.handlePointerUp(t,{onSingleTap:()=>Ut.applyCommand("rotate_piece")})},{passive:!1}),s.addEventListener("pointercancel",t=>{T.handlePointerUp(t)},{passive:!1}),s.addEventListener("pointerleave",t=>{T.dragging&&T.handlePointerUp(t)},{passive:!1}),Mn.addEventListener("click",()=>{Ut.state==="playing"&&Ut.applyCommand("rotate_piece")});let hs=e.dropBtn,vs=null;function ki(){Ut.state==="playing"&&(Ut.applyCommand("move_down"),vs=setInterval(()=>{if(Ut.state!=="playing"){ys();return}Ut.applyCommand("move_down")},zt))}function ys(){vs&&(clearInterval(vs),vs=null)}hs.addEventListener("pointerdown",t=>{t.preventDefault(),ki()}),hs.addEventListener("pointerup",ys),hs.addEventListener("pointerleave",ys),hs.addEventListener("pointercancel",ys);for(let[t,o]of Object.entries(ut))o.addEventListener("click",()=>{Ut.state==="playing"&&Pe()&&Ut.applyCommand("select_magic",{element:t})});Lt&&Lt.addEventListener("click",()=>{if(Ut.state!=="playing"||!cs()||!Pe())return;let t=A.active??An;if(!t)return;let o=Xe[t];!o||!Rn(o)||(pe.selectSpell(o),A.active&&(An=A.active,os=!0,A.deactivate()),pn.handleSpellButtonClick())});let Ps=e.soundsToggle,ks=e.musicToggle;function bn(){let t=v.getSettings();t.soundsEnabled?Ps.classList.add("active"):Ps.classList.remove("active"),t.musicEnabled?ks.classList.add("active"):ks.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],C=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),C&&C.classList.toggle("active",t.musicVolume===o)}}let ao=e.tabBtns,Oi=e.tabContents;ao.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;ao.forEach(u=>u.classList.remove("active")),Oi.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Ho(o).classList.add("active"),o==="sounds"&&bn()})});let co=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,ro=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Di=e.iosHint,Ni=e.standaloneBadge;function lo(){let t=document.fullscreenElement||document.webkitFullscreenElement;fn.textContent=t?"Disable":"Enable"}co&&(ro?(Ni.style.display="block",fn.style.display="none"):(Di.style.display="block",fn.textContent="Not supported",fn.style.opacity="0.5",fn.style.cursor="default")),fn.addEventListener("click",()=>{if(co&&!ro)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",()=>{lo();let t=document.fullscreenElement||document.webkitFullscreenElement;document.documentElement.classList.toggle("is-fullscreen",!!t)}),document.addEventListener("webkitfullscreenchange",()=>{lo();let t=document.fullscreenElement||document.webkitFullscreenElement;document.documentElement.classList.toggle("is-fullscreen",!!t)});let Ss=e.invertSwipeToggle,yn=e.hapticsToggle;xt.invertSwipe&&Ss.classList.add("active"),yn&&(ln.supports()?xt.hapticsEnabled&&yn.classList.add("active"):(yn.classList.add("disabled"),yn.classList.remove("active"),xt.hapticsEnabled=!1,ln.setEnabled(!1),pt.saveGameSettings(xt))),Ss.addEventListener("click",()=>{Ss.classList.toggle("active");let t=Ss.classList.contains("active");T.rotDir=t?-1:1,xt.invertSwipe=t,pt.saveGameSettings(xt)}),yn&&yn.addEventListener("click",()=>{if(yn.classList.contains("disabled"))return;yn.classList.toggle("active");let t=yn.classList.contains("active");xt.hapticsEnabled=t,pt.saveGameSettings(xt),ln.setEnabled(t)});let zn=e.showControlsToggle,Hi=e.controlsRight;function uo(t){Hi.style.display=t?"":"none",tn=t}tn?zn.classList.add("active"):zn.classList.remove("active"),uo(tn),zn.addEventListener("click",()=>{zn.classList.toggle("active");let t=zn.classList.contains("active");uo(t),xt.showControls=t,pt.saveGameSettings(xt)});let Es=e.tapRotateToggle;en&&Es.classList.add("active"),T.tapRotateEnabled=en,Es.addEventListener("click",()=>{Es.classList.toggle("active");let t=Es.classList.contains("active");en=t,T.tapRotateEnabled=t,xt.tapRotate=t,pt.saveGameSettings(xt)}),Ps.addEventListener("click",()=>{let o=!v.getSettings().soundsEnabled;v.updateSettings({soundsEnabled:o}),bn(),jn()}),ks.addEventListener("click",()=>{let o=!v.getSettings().musicEnabled;v.updateSettings({musicEnabled:o}),bn(),jn(),k!=="paused"&&(o?k==="playing"?v.startGameMusic():v.startMenuMusic():v.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{v.updateSettings({soundVolume:t}),bn(),v.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{v.updateSettings({musicVolume:t}),bn()})}bn();function fo(){k==="playing"&&(wt.pause(),je=performance.now(),k="paused",v.musicAudio&&v.musicAudio.pause())}function Ms(){k==="paused"&&(wt.resume(),dn+=performance.now()-je,je=0,k="playing",Ns=performance.now(),v.getSettings().musicEnabled&&v.startGameMusic())}function jn(){let t=v.getSettings();fe.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",fe.classList.toggle("off",!t.soundsEnabled),Ze.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Ze.classList.toggle("off",!t.musicEnabled)}function Fi(){Le.classList.remove("hidden"),ue.classList.add("hidden");let t=pt.loadHighscore(_);if(ge.textContent=t.score?t.score.toLocaleString():"0",$e.textContent=t.time?Cs(t.time):"0:00",En.textContent=_==="30_24"?"High Tower":"Quick Tower",Ee.textContent=Gt.toLocaleString(),on.textContent=Cs(ye),me.textContent=_==="30_24"?"High Tower":"Quick Tower",jn(),vo){let o=_==="30_24";vo.style.display=o?"":"none",o&&Us()}}function Qn(){Le.classList.add("hidden"),ue.classList.remove("hidden")}ue.addEventListener("click",()=>{fo(),Fi()}),Cn.addEventListener("click",()=>{Qn(),Ms()});let Os=null;function go(t,o){Ue.textContent=t,Os=o,Be.classList.remove("hidden")}function mo(){Be.classList.add("hidden"),Os=null}Fn.addEventListener("click",()=>{mo()}),Gn.addEventListener("click",()=>{let t=Os;mo(),t&&t()}),Sn.addEventListener("click",()=>{go("Restart game?",()=>{Qn(),Ut.applyCommand("start_game")})}),sn.addEventListener("click",()=>{go("Exit to menu?",()=>{Qn(),ue.classList.add("hidden"),k="intro",wt.reset(),v.stopMusic(),v.getSettings().musicEnabled&&v.startMenuMusic(),qn()})}),He.addEventListener("click",()=>{un.classList.remove("hidden")}),fe.addEventListener("click",()=>{let t=v.getSettings();v.updateSettings({soundsEnabled:!t.soundsEnabled}),jn(),bn()}),Ze.addEventListener("click",()=>{let o=!v.getSettings().musicEnabled;v.updateSettings({musicEnabled:o}),jn(),bn()}),Le.addEventListener("click",t=>{t.target===Le&&(Qn(),Ms())}),document.addEventListener("keydown",t=>{k==="paused"&&!Le.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Qn(),Ms())}),_s.addEventListener("click",()=>{un.classList.add("hidden")}),un.addEventListener("click",t=>{t.target===un&&un.classList.add("hidden")});let Ds=!1;document.addEventListener("visibilitychange",()=>{document.hidden?k==="playing"&&(fo(),Ds=!0):Ds&&k==="paused"&&(Ms(),Ds=!1)});let Ut=oi({getN:()=>c,getH:()=>n,FALL_INTERVAL:$t,LOCK_DELAY_SEC:kt,getKillRate:d,MATCH_HIGHLIGHT_SEC:D,MAGIC_SHRINK_SEC:lt,RING_HIGHLIGHT_SEC:Ht,getState:()=>({gameState:k,score:Gt,elapsedMs:ye,startTime:Ge,totalPausedMs:dn,stats:J,activePiece:p,pieceY:y,targetRot:j,rotFloat:z,rotVel:ft,isGrounded:w,isHighlighting:an,isMagicAnimation:vn,isRingAnimation:kn,highlightStartTime:Wn,killLevel:Y,grid:yt,fallTimer:x,lockTimer:B}),setState:t=>{"elapsedMs"in t&&(ye=t.elapsedMs),"killLevel"in t&&(Y=t.killLevel),"fallTimer"in t&&(x=t.fallTimer),"lockTimer"in t&&(B=t.lockTimer),"targetRot"in t&&(j=t.targetRot),"rotFloat"in t&&(z=t.rotFloat),"rotVel"in t&&(ft=t.rotVel)},funcs:{startGame:_i,endGame:ws,rotatePieceByDir:Ti,tryMoveDown:Pi,canPlaceAtRot:to,maybeResetLockDelay:eo,shootMagic:hi,selectMagic:Nt,updateGroundedState:Ci,lockPiece:Ai,finishHighlight:bi,finishRingHighlight:Ii},ui:{updateTimeHud:As,updateRemainingHud:no}}),Dn=ii({canvas:s,canvasCtx:l,getN:()=>c,getH:()=>n,TOP_PAD_PX:m,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:O,MAX_RADIUS_X:G,RADIUS_X_FACTOR:Q,ANG_OFFSET:a,MATCH_HIGHLIGHT_SEC:D,MATCH_SHRINK_PHASE:jt,MAGIC_SHRINK_SEC:lt,RING_HIGHLIGHT_SEC:Ht,LOCK_DELAY_SEC:kt,getKillRate:d,ELEMENT_COLORS:at,ELEMENT_TO_COLOR:Bt,BLOCK_COLOR_FRONT:vt,BLOCK_COLOR_BACK:Pt,ACTIVE_COLOR_FRONT:ne,GHOST_COLOR_FILL:Kt,GHOST_COLOR_STROKE:_t,GHOST_STROKE_WIDTH:Yt,MAGIC_DIM_DOT_ALPHA:Qt,MAGIC_DIM_DOT_SCALE:ae,MAGIC_TARGET_DOT_SCALE:bt,getState:()=>({gameState:k,grid:yt,activePiece:p,pieceY:y,rotFloat:z,killLevel:Y,isHighlighting:an,highlightedCells:hn,highlightStartTime:Wn,isMagicAnimation:vn,isRingAnimation:kn,isGrounded:w,lockTimer:B,spellState:pn.getRenderState()}),getVisualSettings:()=>({waterBubbles:ot,waterColor:ce}),funcs:{snappedRot:gs,computeGhostY:xi,normSector:fs,playImpact:()=>v.play("impact"),getMagicTargetColor:()=>Pe()&&A.canUse()?Bt[A.active]:null,getTransmuteAnimState:t=>pn.getTransmuteAnimState(t),getLightningAnimState:t=>pn.getLightningAnimState(t),getFireAnimState:t=>pn.getFireAnimState(t)}}),Ns=performance.now();function po(t){let o=Math.min(.05,Math.max(.001,(t-Ns)/1e3));if(Ns=t,Ut.update(o,t),pn.update(t),R>0){let u=Math.min(R,Et*o);Y=Math.max(0,Y-u),R-=u}z=j,z>1e6&&(z%=c),z<-1e6&&(z%=c),Dn.render(o,t),requestAnimationFrame(po)}le.addEventListener("click",()=>{Ut.applyCommand("start_game")}),ns.addEventListener("click",()=>{Ut.applyCommand("start_game")});function Gi(){k="intro",wt.reset(),v.stopMusic(),v.getSettings().musicEnabled&&v.startMenuMusic(),qn()}ss.addEventListener("click",()=>{Gi()}),q.forEach(t=>{t.addEventListener("click",o=>{q.forEach(C=>C.classList.remove("active")),t.classList.add("active"),_=t.dataset.mode,rs(),as();let u=pt.loadHighscore(_);u.score>0?(P.textContent=u.score.toLocaleString(),U.textContent=Ln(u.time)):(P.textContent="0",U.textContent="0:00"),le.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>le.classList.add("idlePulse"),2e3)})});let Hs=document.querySelectorAll(".spell-select-btn"),Fs=document.getElementById("spellDesc"),$i=document.getElementById("spellProgressFill"),ho=document.getElementById("spellProgressMarkers"),vo=document.getElementById("pauseSpellProgress"),Ui=document.getElementById("pauseSpellProgressFill"),yo=document.getElementById("pauseSpellProgressMarkers"),So=document.getElementById("pauseSpellProgressLabel");function Gs(){return mn.map(t=>_n(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function $s(t){return t.length?Math.max(...t):0}function Xi(t){let o=Gs(),u=$s(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function Eo(t){if(!t)return;t.innerHTML="";let o=Gs(),u=$s(o);o.forEach(C=>{let W=document.createElement("span");W.className="marker",W.dataset.threshold=C;let ct=u>0?C/u*100:0;W.style.left=`${ct}%`,t.appendChild(W)})}function Mo(t,o){if(!t)return;let u=Yi(o);t.style.width=`${u}%`}function bo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(C=>{let W=parseInt(C.dataset.threshold,10)||0;C.classList.toggle("reached",o>=W)})}function Yi(t){let o=Gs(),u=$s(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function To(t){if(!Fs)return;let o=_n(t),u=pe.getDescription(t);o===0||te>=o?Fs.innerHTML=u:Fs.innerHTML=`${u} <span class="spell-progress-text">${te}/${o}</span>`}function Us(){te=pt.loadHighTowerRings(),Hs.forEach(o=>{let u=o.dataset.spell,C=_n(u),W=te>=C;o.classList.toggle("locked",!W);let ct=o.querySelector(".spell-lock");ct&&(ct.style.display=W?"none":"")}),Mo($i,te),Mo(Ui,te),bo(ho,te),bo(yo,te),So&&(So.textContent=Xi(te));let t=document.querySelector(".spell-select-btn.active");t&&To(t.dataset.spell)}Eo(ho),Eo(yo),Us(),Hs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){q.forEach(Xt=>Xt.classList.remove("active")),u.classList.add("active"),_="30_24",rs(),as();let Mt=pt.loadHighscore(_);Mt.score>0?(P.textContent=Mt.score.toLocaleString(),U.textContent=Ln(Mt.time)):(P.textContent="0",U.textContent="0:00")}let C=t.dataset.spell,W=_n(C),ct=te>=W;To(C),ct&&(Hs.forEach(Mt=>Mt.classList.remove("active")),t.classList.add("active"),pe.selectSpell(C),Un(A.active))})}),et.addEventListener("click",()=>{let t=pt.loadHighscore("30_24"),o=pt.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ln(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Ln(o.time)}
`:`  No record yet
`,alert(u)}),nt.addEventListener("click",()=>{un.classList.remove("hidden")}),Zt(),as(),rs(),qn(),v.startMenuMusic();let Wi=()=>{if(v.unlock(),!v.getSettings().musicEnabled)return;let t=v.musicAudio;!t||t.paused||t.ended?Ut.state==="playing"?v.startGameMusic():v.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},xo=0,Vi=10,qi=()=>{xo>=Vi||(xo++,Wi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,qi,{passive:!0})}),requestAnimationFrame(po)})();})();
