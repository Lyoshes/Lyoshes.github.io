(()=>{var ri=[0,.25,.5,.75,1],li=[0,.05,.15,.25,.5],ui={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav"},Us={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Xs="soundSettings";function di(){try{let e=localStorage.getItem(Xs);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function mi(e){try{localStorage.setItem(Xs,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function Ys(){return{audioContext:null,buffers:{},settings:di(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),l=this.audioContext.createBufferSource();l.buffer=n,l.connect(this.audioContext.destination),l.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ri[this.settings.soundVolume]},getMusicVolume(){return li[this.settings.musicVolume]},async loadSound(n,l){if(this.audioContext||this.initContext(),!!this.audioContext)try{let c=await(await fetch(l)).arrayBuffer(),o=await this.audioContext.decodeAudioData(c);this.buffers[n]=o}catch(u){console.debug(`Failed to load sound: ${n} from ${l}`,u)}},preload(){this.initContext();for(let[n,l]of Object.entries(ui))this.loadSound(n,l)},play(n,l=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=n;l!==null&&(u=`${n}${l}`);let c=this.buffers[u];if(c)try{let o=this.audioContext.createGain();o.gain.value=this.getSoundVolume(),o.connect(this.audioContext.destination);let a=this.audioContext.createBufferSource();a.buffer=c,a.connect(o),a.start(0),a.onended=()=>{a.disconnect(),o.disconnect()}}catch(o){console.debug("Sound play failed:",o)}},playRandom(n){if(!this.settings.soundsEnabled)return;let l=1+Math.floor(Math.random()*3);this.play(n,l)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Us.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(l=>{console.debug("Menu music autoplay blocked:",l)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(Us.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(l=>{console.debug("Game music play failed:",l)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},mi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(l=>{console.debug("Music resume failed:",l)}):this.stopMusic()}catch(l){console.debug("Update music settings failed:",l)}},getSettings(){return{...this.settings}}}}var Vs="eb_highscore",Ws="eb_highscore_quick",Ks="eb_settings",qs="eb_high_tower_rings",gi={invertSwipe:!1,difficulty:"easy"};function zs(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Ws:Vs,l=localStorage.getItem(n);if(l)return JSON.parse(l)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,l="30_24"){try{let u=this.loadHighscore(l);if(e>u.score||e===u.score&&n>u.time){let c=l==="25_20"?Ws:Vs;return localStorage.setItem(c,JSON.stringify({score:e,time:n})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Ks);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...gi}},saveGameSettings(e){try{localStorage.setItem(Ks,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(qs);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(qs,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let l=this.loadHighTowerRings()+e;return this.saveHighTowerRings(l),l}}}function Qs(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("spellBtn"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Zs(e){return document.getElementById("tab-"+e)}var fi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function js(e={}){let{elementColors:n={}}=e,l=0;return{showBonus(u,c="score",o=null){let a=document.createElement("div");a.className=`bonus-popup ${c}`,a.textContent=u,o&&n[o]&&(a.style.color=n[o]);let r=window.innerWidth/2,m=window.innerHeight/2-40,f=(Math.random()-.5)*200,g=(Math.random()-.5)*100+l*36;a.style.left=`${r+f}px`,a.style.top=`${m+g}px`,a.style.transform="translate(-50%, -50%)",document.body.appendChild(a),l++,setTimeout(()=>{l=Math.max(0,l-1)},200),setTimeout(()=>{a.remove()},1800)},getElementIcon(u){return fi[u]||"\u2726"}}}var Js={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function to(){return{spawnMagicOrb(e,n,l,u){if(!u)return;let c=document.createElement("div");c.className=`magic-orb ${e}`,c.textContent=Js[e]||"\u2726";let o=u.getBoundingClientRect(),a=o.left+o.width/2-n,r=o.top+o.height/2-l,m=Math.hypot(a,r),f=Math.atan2(r,a),g=m*.35*(Math.random()>.5?1:-1),y=f+Math.PI/2,_=a*.5+Math.cos(y)*g,F=r*.5+Math.sin(y)*g;c.style.setProperty("--mid-x",`${_}px`),c.style.setProperty("--mid-y",`${F}px`),c.style.setProperty("--end-x",`${a}px`),c.style.setProperty("--end-y",`${r}px`),c.style.left=`${n}px`,c.style.top=`${l}px`,document.body.appendChild(c),setTimeout(()=>{c.remove()},700)},spawnMagicShot(e,n,l,u,c){if(!n){c&&c();return}let o=n.getBoundingClientRect(),a=o.left+o.width/2,r=o.top+o.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Js[e]||"\u2726";let f=l-a,g=u-r;m.style.setProperty("--end-x",`${f}px`),m.style.setProperty("--end-y",`${g}px`),m.style.left=`${a}px`,m.style.top=`${r}px`,document.body.appendChild(m);let y=setInterval(()=>{let _=m.getBoundingClientRect();this.spawnTrailParticle(e,_.left+_.width/2,_.top+_.height/2)},40);setTimeout(()=>{clearInterval(y),m.remove(),this.spawnExplosion(e,l,u),c&&c()},300)},spawnTrailParticle(e,n,l){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${n}px`,u.style.top=`${l}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,n,l){for(let c=0;c<12;c++){let o=document.createElement("div");o.className=`magic-explosion ${e}`;let a=c/12*Math.PI*2+(Math.random()-.5)*.5,r=40+Math.random()*40,m=Math.cos(a)*r,f=Math.sin(a)*r;o.style.setProperty("--px",`${m}px`),o.style.setProperty("--py",`${f}px`),o.style.left=`${n}px`,o.style.top=`${l}px`,document.body.appendChild(o),setTimeout(()=>o.remove(),500)}},spawnSpellBubbles(e,n=18){if(!e)return;let l=e.getBoundingClientRect(),u=l.left+l.width/2,c=l.top+l.height/2,o=Math.max(8,Math.round(n));for(let a=0;a<o;a++){let r=document.createElement("div");r.className="spell-bubble",r.textContent="\u25CF";let m=a/o*Math.PI*2+(Math.random()-.5)*.6,f=50+Math.random()*60,g=Math.cos(m)*f,y=Math.sin(m)*f-20;r.style.setProperty("--px",`${g}px`),r.style.setProperty("--py",`${y}px`),r.style.left=`${u}px`,r.style.top=`${c}px`,r.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(r),setTimeout(()=>r.remove(),800)}},spawnSpellOrb(e,n,l){if(!l)return;let u=document.createElement("div");u.className="spell-orb",u.textContent="\u2727";let c=l.getBoundingClientRect(),o=c.left+c.width/2-e,a=c.top+c.height/2-n,r=Math.hypot(o,a),m=Math.atan2(a,o),f=r*.35*(Math.random()>.5?1:-1),g=m+Math.PI/2,y=o*.5+Math.cos(g)*f,_=a*.5+Math.sin(g)*f;u.style.setProperty("--mid-x",`${y}px`),u.style.setProperty("--mid-y",`${_}px`),u.style.setProperty("--end-x",`${o}px`),u.style.setProperty("--end-y",`${a}px`),u.style.left=`${e}px`,u.style.top=`${n}px`,document.body.appendChild(u),setTimeout(()=>{u.remove()},700)}}}function eo(e={}){let{buttons:n={},onActivate:l=null}=e,u={fire:3,water:3,lightning:3,earth:3},c=null;function o(){for(let[r,m]of Object.entries(n)){if(!m)continue;let f=u[r],g=m.querySelector(".charges");g&&(g.textContent=f),m.classList.toggle("empty",f<=0),m.classList.toggle("active",c===r&&f>0)}}function a(r){let m=n[r];m&&(m.classList.remove("pulse"),m.offsetWidth,m.classList.add("pulse"),setTimeout(()=>m.classList.remove("pulse"),400))}return{get charges(){return u},get active(){return c},set active(r){c=r},select(r){if(u[r]<=0)return!1;let m=c===r;return c=m?null:r,o(),!m&&c===r&&l&&l(),!m},useCharge(){if(!c||u[c]<=0)return!1;let r=c;return u[r]--,c=null,o(),a(r),!0},addCharges(r,m){u[r]!==void 0&&(u[r]+=m,o(),a(r))},canUse(){return c!==null&&u[c]>0},deactivate(){c=null,o()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,c=null,o()},updateButtons:o,initButtons(r){for(let[m,f]of Object.entries(n))f&&f.addEventListener("click",()=>{r&&r(m)})}}}var ls={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",maxProgress:10,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",maxProgress:15,effect:{type:"chain_lightning"}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",maxProgress:1,effect:{type:"transmutation"}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",maxProgress:15,effect:{type:"horizontal_beam"}}};function no(e={}){let{button:n=null,onActivate:l=null,onProgress:u=null,onReady:c=null}=e,o="ice",a=0;function r(){return ls[o]||ls.ice}function m(){if(!n)return;let g=r(),y=Math.min(a/g.maxProgress,1)*100,_=a>=g.maxProgress;n.style.setProperty("--progress",`${y}%`);let F=n.querySelector(".spell-icon");F&&(F.textContent=g.icon);let W=n.querySelector(".spell-counter");W&&(W.textContent=`${Math.min(a,g.maxProgress)}/${g.maxProgress}`),n.classList.toggle("ready",_),n.classList.toggle("charging",!_&&a>0),u&&u(a,g.maxProgress)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return o},get progress(){return a},get maxProgress(){return r().maxProgress},get isReady(){return a>=r().maxProgress},get effect(){return r().effect},get button(){return n},selectSpell(g){ls[g]&&(o=g,a=0,m())},addProgress(g=1){let y=r();if(a>=y.maxProgress)return!1;let _=a<y.maxProgress;return a=Math.min(a+g,y.maxProgress),m(),f(),_&&a>=y.maxProgress&&c&&c(),!0},canUse(){return a>=r().maxProgress},use(){if(!this.canUse())return null;let g=r().effect;return a=0,m(),f(),l&&l(o),g},reset(){a=0,m()},updateButton:m,initButton(g){n&&n.addEventListener("click",()=>{g&&g()})}}}var pi={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function so(e={}){let{canvas:n}=e,l=e.rotDir||1,u=!1,c=0,o=0,a=0,r=0,m=0,f=1,g=null,y=0,_=0,F=0,W=0,Q=0,ot=0,Et=0,re=0,st=pi;return{get rotDir(){return l},set rotDir(U){l=U},get dragging(){return u},get dragMode(){return g},handlePointerDown(U,mt,ye){if(mt.onMagicTap&&mt.onMagicTap(U.clientX,U.clientY))return!0;let le=performance.now(),zt=le-ot,Qt=U.clientX-Et,Zt=U.clientY-re,Ee=Math.hypot(Qt,Zt);return zt<=st.DOUBLE_TAP_MS&&Ee<=st.DOUBLE_TAP_MAX_DIST?(mt.onDoubleTap&&mt.onDoubleTap(),ot=0):(ot=le,Et=U.clientX,re=U.clientY),u=!0,f=-1,c=U.clientX,o=U.clientY,a=ye,r=0,m=0,g=null,y=le,_=U.clientX,F=U.clientY,W=y,Q=0,n&&n.setPointerCapture(U.pointerId),!1},handlePointerMove(U,mt,ye,le){if(!u)return null;let zt=U.clientX-c,Qt=U.clientY-o,Zt=performance.now();if(Math.abs(zt)<st.DEADZONE_PX&&Math.abs(Qt)<st.DEADZONE_PX)return null;if(!g){let Gt=Math.abs(zt),wt=Math.abs(Qt);if(Qt<0)Gt>=st.DEADZONE_PX&&(g="rotate");else if(wt>=Gt*st.AXIS_DOMINANCE){if(wt>=st.DROP_SWIPE_MIN_DISTANCE){let Bt=Math.max(1,Zt-y);wt/Bt*1e3>=st.DROP_SWIPE_MIN_SPEED?g="drop":g="rotate"}}else Gt>=wt*st.AXIS_DOMINANCE&&(g="rotate");if(!g)return null}let Ee=null;if(g==="rotate"&&Math.abs(zt)>=st.DEADZONE_PX){let Gt=Math.max(1,Zt-W),wt=U.clientX-_,Bt=Math.max(1,Math.abs(wt)/Gt*1e3),d=Math.max(st.MIN_ROT_PX,Math.min(st.MAX_ROT_PX,st.PX_PER_STEP*(st.SWIPE_SPEED_REF/Bt)));Q+=-wt/d*l*f;let j=Math.trunc(Q);j!==0&&(Q-=j);let J=r+j;if(J!==r&&mt.canRotateTo){let ue=Math.sign(J-r),kt=a+r;for(;r!==J;){let _e=r+ue,ke=a+_e;if(!mt.canRotateTo(Math.floor(ye),ke))break;r=_e,kt=ke,le&&mt.onGroundedMove&&mt.onGroundedMove()}Ee={targetRot:kt,rotFloat:kt}}}if(g==="drop"&&Qt>st.DEADZONE_PX&&mt.onDrop){let Gt=Math.max(1,Zt-W),wt=U.clientY-F,Bt=Math.max(1,wt/Gt*1e3),d=Math.max(st.MIN_DROP_PX,Math.min(st.MAX_DROP_PX,st.PX_PER_DROP*(st.SWIPE_SPEED_REF/Bt))),j=Math.trunc(Qt/d);if(j>m){let J=j-m;for(let ue=0;ue<J;ue++)mt.onDrop();m=j}}return _=U.clientX,F=U.clientY,W=Zt,Ee},handlePointerUp(U){if(u&&(u=!1,g=null,n&&U&&U.pointerId!==void 0))try{n.releasePointerCapture(U.pointerId)}catch{}},reset(){u=!1,g=null,r=0,m=0,Q=0}}}var us={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function oo(){let e="intro",n=0,l=0,u=0,c=0,o=0,a={...us};return{get state(){return e},get score(){return n},get elapsedMs(){return u},get startTime(){return l},get stats(){return a},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,l=performance.now(),u=0,c=0,o=0,a={...us}},pause(){return e!=="playing"?!1:(e="paused",c=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",c>0&&(o+=performance.now()-c,c=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(r){n+=r},setScore(r){n=r},updateTime(){e==="playing"&&l>0&&(u=performance.now()-l-o)},getFormattedTime(){let r=Math.floor(u/1e3),m=Math.floor(r/60),f=r%60;return`${m}:${f.toString().padStart(2,"0")}`},incrementStat(r,m=1){r in a&&(a[r]+=m)},updateMaxStat(r,m){r in a&&m>a[r]&&(a[r]=m)},reset(){e="intro",n=0,l=0,u=0,c=0,o=0,a={...us}}}}function We(e,n){return e%=n,e<0&&(e+=n),e}function io(e,n){return e[Math.min(n,e.length-1)]}function Nn(e){let n=Math.max(0,Math.floor(e/1e3)),l=Math.floor(n/60),u=n%60;return`${l}:${u.toString().padStart(2,"0")}`}function co(e,n){let l=e.map(({x:r,y:m},f)=>({x:m,y:-r,color:n[f]})),u=1/0,c=-1/0,o=1/0;for(let r of l)u=Math.min(u,r.x),c=Math.max(c,r.x),o=Math.min(o,r.y);let a=Math.round((u+c)/2);for(let r of l)r.x-=a,r.y-=o;return l.sort((r,m)=>r.y-m.y||r.x-m.x),{cells:l.map(r=>({x:r.x,y:r.y})),colors:l.map(r=>r.color)}}function ds(e,n,l,u){let c=[];return e+1<l&&c.push({y:e+1,s:n}),e-1>=0&&c.push({y:e-1,s:n}),c.push({y:e,s:We(n-1,u)}),c.push({y:e,s:We(n+1,u)}),c}function ao(e,n,l){let u=Array.from({length:n},()=>new Uint8Array(l)),c=[];for(let o=0;o<n;o++)for(let a=0;a<l;a++){if(!e[o][a]||u[o][a])continue;let r=[],m=[{y:o,s:a}];for(u[o][a]=1;m.length>0;){let f=m.shift();r.push(f);for(let g of ds(f.y,f.s,n,l))e[g.y][g.s]&&!u[g.y][g.s]&&(u[g.y][g.s]=1,m.push(g))}c.push(r)}return c}function ro(e){return e.some(n=>n.y===0)}function ms(e,n,l,u,c,o){if(!e)return!1;let a=We(l,o);for(let r of e.cells){let m=n+r.y,f=We(a+r.x,o);if(m<0)return!1;if(!(m>=c)&&u[m][f])return!1}return!0}function lo(e,n,l,u,c,o){if(!e)return null;let a=Math.floor(n);for(;ms(e,a-1,l,u,c,o);)a-=1;return a}function uo(e,n,l){let u=[],c=[];for(let o=0;o<n;o++){let a=[],r=0,m=e[o][0],f=m?1:0;for(let g=1;g<=l;g++){let y=g<l?e[o][g]:0;y&&y===m?f++:(f>=1&&m&&a.push({start:r,length:f,color:m}),r=g,m=y,f=y?1:0)}if(a.length>=2){let g=a[0],y=a[a.length-1];if(g.start===0&&y.start+y.length===l&&g.color===y.color){let _=g.length+y.length;a[0]={start:y.start,length:_,color:g.color},a.pop()}}for(let g of a)if(g.length>=3){let y=[];for(let _=0;_<g.length;_++)y.push({y:o,s:(g.start+_)%l});u.push({color:g.color,length:g.length,cells:y})}}for(let o=0;o<l;o++){let a=0,r=e[0][o],m=r?1:0;for(let f=1;f<=n;f++){let g=f<n?e[f][o]:0;if(g&&g===r)m++;else{if(m>=3&&r){let y=[];for(let _=0;_<m;_++)y.push({y:a+_,s:o});u.push({color:r,length:m,cells:y})}a=f,r=g,m=g?1:0}}}for(let o=0;o<n;o++)for(let a=0;a<l;a++){let r=e[o][a],m=e[o][(a+1)%l],f=e[o][(a+2)%l],g=e[o][(a+3)%l];r&&r===m&&f&&f===g&&r!==f&&c.push({cells:[{y:o,s:a},{y:o,s:(a+1)%l},{y:o,s:(a+2)%l},{y:o,s:(a+3)%l}]})}for(let o=0;o<l;o++)for(let a=0;a<n-3;a++){let r=e[a][o],m=e[a+1][o],f=e[a+2][o],g=e[a+3][o];r&&r===m&&f&&f===g&&r!==f&&c.push({cells:[{y:a,s:o},{y:a+1,s:o},{y:a+2,s:o},{y:a+3,s:o}]})}return{lineMatches:u,pairMatches:c}}function mo(e,n,l){let u=[];for(let c=0;c<n;c++){let o=!0;for(let a=0;a<l;a++)if(!e[c][a]){o=!1;break}o&&u.push(c)}return u}function go(e,n){let l=new Map;e.forEach((u,c)=>l.set(`${u.x},${u.y}`,n[c]));for(let u=0;u<e.length;u++){let c=e[u],o=n[u],a=1;for(let ot=1;ot<=2&&l.get(`${c.x+ot},${c.y}`)===o;ot++)a++;if(a>=3)return!0;let r=1;for(let ot=1;ot<=2&&l.get(`${c.x},${c.y+ot}`)===o;ot++)r++;if(r>=3)return!0;let m=o,f=l.get(`${c.x+1},${c.y}`),g=l.get(`${c.x+2},${c.y}`),y=l.get(`${c.x+3},${c.y}`);if(m&&f&&g&&y&&m===f&&g===y&&m!==g)return!0;let _=o,F=l.get(`${c.x},${c.y+1}`),W=l.get(`${c.x},${c.y+2}`),Q=l.get(`${c.x},${c.y+3}`);if(_&&F&&W&&Q&&_===F&&W===Q&&_!==W)return!0}return!1}function fo(e){let{getN:n,getH:l,FALL_INTERVAL:u,LOCK_DELAY_SEC:c,getKillRate:o,MATCH_HIGHLIGHT_SEC:a,MAGIC_SHRINK_SEC:r,RING_HIGHLIGHT_SEC:m,getState:f,setState:g,funcs:y,ui:_}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(F,W={}){let Q=f();if(F==="start_game")return Q.gameState!=="playing"?(y.startGame(),!0):!1;if(Q.gameState!=="playing")return!1;switch(F){case"rotate_piece":return y.rotatePieceByDir(),!0;case"move_down":return y.tryMoveDown();case"rotate_cylinder":{let{rot:ot}=W;return typeof ot=="number"&&y.canPlaceAtRot(Math.floor(Q.pieceY),ot)?(g({targetRot:ot,rotFloat:ot,rotVel:0}),Q.isGrounded&&y.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ot,y:Et}=W;return y.shootMagic(ot,Et)}case"select_magic":{let{element:ot}=W;return y.selectMagic(ot),!0}default:return console.warn("GameEngine: unknown command",F),!1}},update(F,W){let Q=f();if(Q.gameState!=="playing")return;let ot=W-Q.startTime-Q.totalPausedMs;g({elapsedMs:ot}),_.updateTimeHud();let Et=Q.killLevel+o()*F;if(g({killLevel:Et}),_.updateRemainingHud(),Et>=l()){y.endGame();return}if(Q.isHighlighting){let U=(W-Q.highlightStartTime)/1e3,mt;Q.isRingAnimation?mt=m:Q.isMagicAnimation?mt=r:mt=a,U>=mt&&(Q.isRingAnimation?y.finishRingHighlight():y.finishHighlight())}let re=Q.fallTimer+F;if(re>=u&&(re-=u,y.tryMoveDown()),g({fallTimer:re}),y.updateGroundedState()){let U=Q.lockTimer+F;g({lockTimer:U}),U>=c&&y.lockPiece()}},reset(){y.startGame()},canRotateTo(F,W){return y.canPlaceAtRot(F,W)},getRotation(){let F=f();return{targetRot:F.targetRot,rotFloat:F.rotFloat,rotVel:F.rotVel}},setRotation(F){g({targetRot:F,rotFloat:F,rotVel:0})},onGroundedMove(){y.maybeResetLockDelay()}}}var qt=Math.PI*2;function po(e){let{canvas:n,canvasCtx:l,getN:u,getH:c,TOP_PAD_PX:o,BOTTOM_PAD_PX:a,SIDE_MARGIN_PX:r,MAX_RADIUS_X:m,RADIUS_X_FACTOR:f,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:y,MATCH_SHRINK_PHASE:_,MAGIC_SHRINK_SEC:F,RING_HIGHLIGHT_SEC:W,LOCK_DELAY_SEC:Q,getKillRate:ot,ELEMENT_COLORS:Et,ELEMENT_TO_COLOR:re,BLOCK_COLOR_FRONT:st,BLOCK_COLOR_BACK:U,ACTIVE_COLOR_FRONT:mt,GHOST_COLOR_FILL:ye,GHOST_COLOR_STROKE:le,GHOST_STROKE_WIDTH:zt,MAGIC_DIM_DOT_ALPHA:Qt,MAGIC_DIM_DOT_SCALE:Zt,MAGIC_TARGET_DOT_SCALE:Ee,getState:Gt,getVisualSettings:wt,funcs:Bt}=e,d=l,j=u(),J=c(),ue={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},kt=[],_e=40;function ke(L,I,R,C,S){let M=Math.max(3,Math.round(L)),K=180;for(let q=0;q<M;q++)setTimeout(()=>{let B=Math.random()>.5?"left":"right",nt=15,v=B==="left"?nt+Math.random()*Math.max(10,I-nt*2):R+nt+Math.random()*Math.max(10,S-R-nt*2),h=C-10;kt.push({x:v,baseX:v,y:h,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:nt,maxX:S-nt})},q*K)}function pn(L,I,R){kt=kt.filter(C=>C.y>L+C.size&&C.y>-20);for(let C of kt){C.y-=_e*R,C.wobble+=C.wobbleSpeed*R;let S=C.baseX+Math.sin(C.wobble)*C.wobbleAmp;C.x=Math.max(C.minX,Math.min(C.maxX,S))}}function Fn(L){if(kt.length!==0){d.fillStyle="rgba(255, 255, 255, 0.3)",d.strokeStyle="rgba(255, 255, 255, 0.5)",d.lineWidth=1;for(let I of kt)I.y<L+I.size||(d.beginPath(),d.arc(I.x,I.y,I.size,0,Math.PI*2),d.fill(),d.stroke())}}let Ke={left:0,right:0,h:0,w:0};function Pt(L,I,R){let C=1-R/J;return L+C*I}function qe(L){return L=L%j,L<0?L+j:L}function De(L,I,R,C,S,M){let K=qe(M),q=(S-K)/j*qt+g;return{x:L+Math.cos(q)*R,y:I+Math.sin(q)*C,ang:q}}let hn=.52,ze=1.02;function Nt(L,I,R,C,S,M){let K=qe(M),q=(S-K)/j*qt+g;return{x:L+Math.cos(q)*R,y:I+Math.sin(q)*C,ang:q}}function yn(L,I,R,C,S,M,K,q=1){let B=Nt(L,I,R,C,S-hn,M),nt=Nt(L,I,R,C,S+hn,M),v={x:B.x,y:B.y-K*.5},h={x:B.x,y:B.y+K*.5},$={x:nt.x,y:nt.y-K*.5},vt={x:nt.x,y:nt.y+K*.5},T=(v.x+$.x+vt.x+h.x)*.25,tt=(v.y+$.y+vt.y+h.y)*.25,X=ze*q,St=q,Lt=[v,$,vt,h].map(jt=>({x:T+(jt.x-T)*X,y:tt+(jt.y-tt)*St})),Ft=Math.abs((nt.x-B.x)*X),rt=Math.abs(K*St);return{corners:Lt,cx:T,cy:tt,wApprox:Ft,hApprox:rt,ang:Nt(L,I,R,C,S,M).ang}}function Dt(L,I,R,C,S,M,K,q,B=1,nt=null,v=1,h=null,$=0,vt=1,T=1){let tt=yn(L,I,R,C,S,M,K,T),[X,St,Lt,Ft]=tt.corners;if(d.save(),d.globalAlpha=B,d.fillStyle=q,d.beginPath(),d.moveTo(X.x,X.y),d.lineTo(St.x,St.y),d.lineTo(Lt.x,Lt.y),d.lineTo(Ft.x,Ft.y),d.closePath(),d.fill(),h&&$>0&&(d.strokeStyle=h,d.lineWidth=$,d.stroke()),nt){let rt=Math.min(tt.wApprox,tt.hApprox)*.28*vt;d.globalAlpha=B*v,d.fillStyle=nt,d.beginPath(),d.arc(tt.cx,tt.cy,rt,0,qt),d.fill()}d.restore(),d.globalAlpha=1}function Un(L,I,R,C,S,M){let K=De(L,I,R,C,S,M),q=De(L,I,R,C,S+1,M),B=De(L,I,R,C,S-1,M),nt=Math.abs(q.x-K.x),v=Math.abs(K.x-B.x),h=(nt+v)*.5*1.06;return Math.max(1,h)}function Xn(L,I,R,C,S,M){let K=(S-M)/j*qt+g;return{x:L+Math.cos(K)*R,y:I+Math.sin(K)*C,ang:K}}function gs(L,I,R,C,S,M,K,q=1,B=null,nt=1,v=null,h=0,$=1){d.save(),d.translate(L,I);let vt=Math.atan2(C,R);if(d.rotate(vt),d.globalAlpha=q,d.fillStyle=K,d.fillRect(-S/2,-M/2,S,M),v&&h>0&&(d.strokeStyle=v,d.lineWidth=h,d.strokeRect(-S/2,-M/2,S,M)),B){let T=Math.min(S,M)*.28*$;d.globalAlpha=q*nt,d.fillStyle=B,d.beginPath(),d.arc(0,0,T,0,qt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let L=Math.max(1,Math.min(2,window.devicePixelRatio||1)),I=Math.floor(n.clientWidth*L),R=Math.floor(n.clientHeight*L);(n.width!==I||n.height!==R)&&(n.width=I,n.height=R,d.setTransform(L,0,0,L,0,0))},render(L=.016,I=performance.now()){this.resize();let R=Gt();j=u(),J=c();let C=n.clientWidth,S=n.clientHeight;d.clearRect(0,0,C,S),d.fillStyle="#0b0f14",d.fillRect(0,0,C,S);let M=C*.5,K=(C-2*r)/2,q=S-o-a,B=6,nt=j*q/(B*J),v,h,$,vt;vt=S-a,nt<=Math.min(K,m)?(v=nt,h=q,$=o):(v=Math.min(K,m),h=v*B*J/j,$=vt-h);let T=v*.28,{killLevel:tt,rotFloat:X,grid:St,gameState:Lt}=R,Ft=wt?wt():{},rt=Ft.waterColor||"blue",jt=Ft.waterBubbles||!1,Se=ue[rt]||ue.blue,ut=Pt($,h,tt),Qe=.7,En=tt/J,Ct={...Se.top},E={...Se.bottom};if(En>Qe){let x=(En-Qe)/(1-Qe);Ct.r=Math.round(Ct.r+(255-Ct.r)*x*.5),Ct.g=Math.round(Ct.g+(150-Ct.g)*x*.5),Ct.b=Math.round(Ct.b+(150-Ct.b)*x*.5),E.r=Math.round(E.r+(180-E.r)*x),E.g=Math.round(E.g*(1-x*.6)),E.b=Math.round(E.b*(1-x*.6))}let Mt=M-v-8,et=M+v+8,Rt=$,ne=vt+5,Jt=d.createLinearGradient(0,ut,0,S);Jt.addColorStop(0,`rgba(${Ct.r},${Ct.g},${Ct.b},0.5)`),Jt.addColorStop(1,`rgba(${E.r},${E.g},${E.b},0.7)`),d.fillStyle=Jt;let He=Math.round((Ct.r+E.r)/2),Ze=Math.round((Ct.g+E.g)/2),de=Math.round((Ct.b+E.b)/2),z=v+8,je=T+4;d.fillRect(0,ut,Mt,S-ut),d.fillRect(et,ut,C-et,S-ut),d.beginPath();let Be=Math.max(ut,ne);d.moveTo(Mt,Be),ut<=ne+je?d.ellipse(M,ne,z,je,0,Math.PI,0,!1):d.lineTo(et,Be),d.lineTo(et,S),d.lineTo(Mt,S),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(Mt,Rt),d.lineTo(Mt,ne),d.stroke(),d.beginPath(),d.moveTo(et,Rt),d.lineTo(et,ne),d.stroke(),d.beginPath(),d.ellipse(M,ne,v+8,T+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(M,ne,v+8,T+4,0,0,qt),d.fill(),tt>.5&&(d.strokeStyle=`rgba(${Math.min(255,He+60)},${Math.min(255,Ze+40)},${Math.min(255,de+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,ut),d.lineTo(Mt,ut),d.moveTo(et,ut),d.lineTo(C,ut),d.stroke()),Ke={left:Mt,right:et,h:S,w:C},(kt.length>0||jt)&&(pn(ut,S,L),Fn(ut)),d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let xt=qt*v,Sn=10,$e=xt/Sn*.7,fs=xt/Sn*.3;d.setLineDash([$e,fs]);let ps=xt/j;d.lineDashOffset=qe(X)*ps;for(let x=0;x<=J;x++){let D=Pt($,h,x);d.beginPath(),d.ellipse(M,D,v,T,0,0,qt),d.stroke()}d.setLineDash([]);let se=[],Je=[];for(let x=0;x<J;x++){let D=Pt($,h,x+.5);for(let P=0;P<j;P++){let G=St[x][P];if(!G)continue;let O=De(M,D,v,T,P,X),Z=Math.sin(O.ang),w={y:x,s:P,yScr:D,p:O,depth:Z,color:G};Z<-.1?se.push(w):Je.push(w)}}let Mn=Bt.getMagicTargetColor(),{isHighlighting:tn,highlightedCells:oe,highlightStartTime:Le,isMagicAnimation:xn}=R,Ut=null,ie=1,Ge=1,bn=!1;if(tn&&oe.length>0){Ut=new Set(oe.map(D=>`${D.y},${D.s}`));let x=(performance.now()-Le)/1e3;if(xn){let D=Math.min(1,x/F);ie=1-D*.85,Ge=1-D*.9,bn=!0}else{let D=Math.min(1,x/y),P=1-_;if(D>P){let G=(D-P)/_;ie=1-G*.85,Ge=1-G*.9,bn=!0}}}se.sort((x,D)=>x.depth-D.depth);for(let x of se){let D=h/J*.9,P=Et[x.color]||null,G=.35,O=1,Z=`${x.y},${x.s}`;Ut&&Ut.has(Z)&&(G*=Ge,O=ie),Dt(M,x.yScr,v,T,x.s,X,D,U,G,P,.5,null,0,1,O)}let{isRingAnimation:Me}=R;if(tn&&oe.length>0&&!xn){let x=(performance.now()-Le)/1e3,P=Math.min(1,x/(Me?W:y)),G=1-_,O=P>G,Z=O?(P-G)/_:0,w=Me?Math.floor(P*G*j*2)%j:-1,N=4+P/G*10,it=Math.sin(x*N*qt),It=O?1:.3+it*.3,pt=O?1-Z*.8:1,bt=O?1-Z:1;for(let dt of oe){let Ot=Pt($,h,dt.y+.5),ce=Nt(M,Ot,v,T,dt.s,X);if(Math.sin(ce.ang)>=-.1)continue;let sn=h/J*.9,Ht,Xt,Yt;if(Me){let Re=(dt.s-w+j)%j,be=Re<3?1-Re/3:0;Ht=(O?bt:.2+be*.5)*.5,Xt=`rgba(255, 159, 67, ${Ht})`,Yt=O?pt:1+be*.15}else Ht=It*bt,Xt=dt.isLine?`rgba(255, 255, 255, ${Ht*.5})`:`rgba(255, 220, 100, ${Ht*.4})`,Yt=O?pt:1.1;Dt(M,Ot,v,T,dt.s,X,sn,Xt,1,null,1,null,0,1,Yt)}}Je.sort((x,D)=>x.depth-D.depth);for(let x of Je){let D=h/J*.9,P=Et[x.color]||null,G=1,O=1,Z=1,w=1,N=`${x.y},${x.s}`,it=Ut&&Ut.has(N);it&&(G=Ge,O=ie),Mn!==null&&!it&&(x.color!==Mn?(Z=Qt,w=Zt):w=Ee),Dt(M,x.yScr,v,T,x.s,X,D,st,G,P,Z,null,0,w,O)}if(tn&&oe.length>0&&!xn){let x=(performance.now()-Le)/1e3,P=Math.min(1,x/(Me?W:y)),G=1-_,O=P>G,Z=O?(P-G)/_:0,w=Me?Math.floor(P*G*j*2)%j:-1,N=4+P/G*10,it=Math.sin(x*N*qt),It=O?1:.5+it*.5,pt=O?1-Z*.8:1,bt=O?1-Z:1;for(let dt of oe){let Ot=Pt($,h,dt.y+.5),ce=Nt(M,Ot,v,T,dt.s,X);if(Math.sin(ce.ang)<-.1)continue;let sn=h/J*.9,Ht,Xt,Yt;if(Me){let Re=(dt.s-w+j)%j,be=Re<4?1-Re/4:0;Ht=O?bt:.3+be*.7,Xt=`rgba(255, 159, 67, ${Ht})`,Yt=O?pt:1+be*.2}else Ht=It*bt,Xt=dt.isLine?`rgba(255, 255, 255, ${Ht*.7})`:`rgba(255, 220, 100, ${Ht*.6})`,Yt=O?pt:1.15;Dt(M,Ot,v,T,dt.s,X,sn,Xt,1,null,1,null,0,1,Yt)}}let{transmuteState:en,transmuteSourceBlock:Ne,transmuteTargetColor:nn,transmuteAreaCells:vn,transmuteBlocksToChange:xe}=R;if(en==="selecting_source"){let x=h/J*.9,D=.3+Math.sin(I/200)*.15;for(let P of Je){let G=Pt($,h,P.y+.5);Dt(M,G,v,T,P.s,X,x,`rgba(100, 255, 150, ${D})`,1,null,1,null,0,1,1.05)}}if(en==="selecting_target"&&xe&&xe.length>0){let x=h/J*.9,D=.3+Math.sin(I/200)*.15;for(let P of xe){if(P.y<0||P.y>=J)continue;let G=Pt($,h,P.y+.5),O=Nt(M,G,v,T,P.s,X);Math.sin(O.ang)<-.1||Dt(M,G,v,T,P.s,X,x,`rgba(100, 255, 150, ${D})`,1,null,1,null,0,1,1.05)}}if(en==="animating"&&Bt.getTransmuteAnimState){let x=Bt.getTransmuteAnimState(I);if(x){let D=h/J*.9,{phase:P,progress:G,areaFlash:O}=x;if(O>0&&vn)for(let Z of vn){if(Z.y<0||Z.y>=J)continue;let w=Pt($,h,Z.y+.5),N=Nt(M,w,v,T,Z.s,X);Math.sin(N.ang)<-.1||Dt(M,w,v,T,Z.s,X,D,`rgba(150, 255, 200, ${O*.4})`,1,null,1,null,0,1,1)}if(xe&&xe.length>0){let Z=Ne?Ne.color:1,w=nn||1;for(let N of xe){if(N.y<0||N.y>=J)continue;let it=Pt($,h,N.y+.5),It=Nt(M,it,v,T,N.s,X);if(Math.sin(It.ang)<-.1)continue;let bt=1,dt=Et[Z],Ot=0;if(P==="shrink"?(bt=1-G*.95,dt=Et[Z],Ot=.5+G*.3):P==="grow"&&(bt=G,dt=Et[w],Ot=.8-G*.5),Ot>0&&Dt(M,it,v,T,N.s,X,D,`rgba(200, 255, 220, ${Ot})`,1,null,1,null,0,1,1),bt>.05){let ce=yn(M,it,v,T,N.s,X,D,1),Fe=Math.min(ce.wApprox,ce.hApprox)*.28*bt;d.save(),d.globalAlpha=1,d.fillStyle=dt,d.beginPath(),d.arc(ce.cx,ce.cy,Fe,0,qt),d.fill(),d.restore()}}}}}let{activePiece:me,pieceY:Yn,isGrounded:Vn,lockTimer:Cn}=R;if(me){let x=Bt.snappedRot(),D=x,P=Bt.computeGhostY(),G=h/J*.9;if(P!==null){let w=[];for(let N=0;N<me.cells.length;N++){let it=me.cells[N],It=me.colors[N],pt=P+it.y,bt=Bt.normSector(x+it.x);if(pt<0||pt>=J)continue;let dt=Pt($,h,pt+.5),Ot=Nt(M,dt,v,T,bt,D);w.push({cy:pt,cs:bt,yScr:dt,depth:Math.sin(Ot.ang),color:It})}w.sort((N,it)=>N.depth-it.depth);for(let N of w){let it=Et[N.color]||null;Dt(M,N.yScr,v,T,N.cs,D,G,ye,1,it,.5,le,zt,1,1)}}let O=mt;if(Vn&&Cn>0){let w=Math.min(1,Cn/Q),N=255,it=Math.round(170+85*w),It=Math.round(180+75*w),pt=.75+(1-.75)*w;O=`rgba(${N},${it},${It},${pt})`}let Z=[];for(let w=0;w<me.cells.length;w++){let N=me.cells[w],it=me.colors[w],It=Bt.normSector(x+N.x),pt=Yn+N.y;if(pt<0||pt>=J)continue;let bt=Pt($,h,pt+.5),dt=Nt(M,bt,v,T,It,D);Z.push({cs:It,yScr:bt,depth:Math.sin(dt.ang),color:it})}Z.sort((w,N)=>w.depth-N.depth);for(let w of Z){let N=Et[w.color]||null;Dt(M,w.yScr,v,T,w.cs,D,G,O,1,N,1,null,0,1,1)}}},drawNextPreview(L,I){if(!L)return;let R=L.getContext("2d"),C=L.width,S=L.height;if(R.clearRect(0,0,C,S),!I)return;let M=1/0,K=-1/0,q=1/0,B=-1/0;for(let T of I.cells)M=Math.min(M,T.x),K=Math.max(K,T.x),q=Math.min(q,T.y),B=Math.max(B,T.y);let nt=K-M+1,v=B-q+1,h=Math.min(C/(nt+.5),S/(v+.5)),$=(C-nt*h)/2,vt=(S-v*h)/2;R.fillStyle=st;for(let T=0;T<I.cells.length;T++){let tt=I.cells[T],X=$+(tt.x-M)*h,St=vt+(v-1-(tt.y-q))*h;R.fillRect(X+1,St+1,h-2,h-2);let Lt=I.colors[T],Ft=Et[Lt];if(Ft){let rt=(h-2)*.32;R.fillStyle=Ft,R.beginPath(),R.arc(X+h/2,St+h/2,rt,0,qt),R.fill(),R.fillStyle=st}}},spawnBonusBubbles(L){let{left:I,right:R,h:C,w:S}=Ke;S>0&&ke(L,I,R,C,S)}}}(()=>{let e=Qs(),n=e.canvas,l=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,c=30,o=24,a=120,r={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let s=r[t]||r["30_24"];c=s.N,o=s.H,a=s.survivalTime}function f(){return o/a}let g=Math.PI/2,y=70,_=120,F=30,W=320,Q=.42,ot="rgb(235,240,250)",Et="rgb(55,62,75)",re="rgba(255,170,180,0.75)",st="rgba(110,255,150,0.15)",U="rgba(110,255,150,0.85)",mt=2,ye={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},le={1:"fire",2:"water",3:"lightning",4:"earth"},zt={fire:1,water:2,lightning:3,earth:4},Qt=1,Zt=.58,Ee=!0,Gt=12,wt=25,Bt=1,d=2,j=3,J=5,ue=8,kt=10,_e=15,ke=30,pn=2,Fn=.3,Ke=.5,Pt=1,qe=.3,De=.5,hn=1.3,ze=10,Nt=500,yn=[1,1.25,1.5,1.75,2],Dt=10,Un=100,Xn=25,gs=5,L=8,I=.35,R=[1,1.3,1.6,2],C=[1,1.5,2,2.5],S=zs(),M=S.loadGameSettings(),K=M.invertSwipe?-1:1,q=-1,B=Array.from({length:o},()=>new Uint8Array(c));function nt(){B=Array.from({length:o},()=>new Uint8Array(c))}let v=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],h=null,$=o+3,vt=0,T=0,tt=!1,X=0,St=0,Lt=0,Ft=3,rt=0,jt=0,Se=0,ut=so({canvas:n,rotDir:K}),Qe="0.14.1",En=!0,Ct="blue",E=Ys();E.preload();let Mt=oo(),et="intro",Rt=0,ne=0,Jt=0,He=0,Ze=0,de=null,z=Mt.stats,je=e.overlay,Be=js({elementColors:ye}),xt=Be.showBonus.bind(Be),Sn=Be.getElementIcon.bind(Be),$e=to(),fs=e.overlayTitle,ps=e.overlayStats,se=e.startBtn,Je=e.hud,Mn=e.scoreHud,tn=e.timeHud,oe=e.remainingHud,Le=e.nextCanvas,xn=Le.getContext("2d"),Ut=e.pauseBtn,ie=e.pauseOverlay,Ge=e.resumeBtn,bn=e.restartBtn,Me=e.exitToMenuBtn,en=e.pauseSettingsBtn,Ne=e.pauseSoundBtn,nn=e.pauseMusicBtn,vn=e.pauseBestScore,xe=e.pauseBestTime,me=e.pauseBestMode,Yn=e.pauseCurrentScore,Vn=e.pauseCurrentTime,Cn=e.pauseCurrentMode,x=e.confirmDialog,D=e.confirmText,P=e.confirmCancel,G=e.confirmOk,O=e.settingsOverlay,Z=e.settingsClose,w=e.fullscreenBtn,N=e.rotateBtn,it=e.startPanel,It=e.gameoverPanel,pt=e.goScore,bt=e.goTime,dt=e.goRing,Ot=e.goMatches,ce=e.goBonuses,Fe=e.goNewRecord,sn=e.goRestartBtn,Ht=e.goExitBtn,Xt=e.bestScore,Yt=e.bestTimeVal,Re=e.startVersion,be=e.modeBtns,ho=e.recordsBtn,yo=e.startSettingsBtn,Eo=e.helpBtn,te="25_20",Vt=eo({buttons:e.magicBtns,onActivate:()=>E.play("spells")}),Wn=e.magicBtns,yi=Vt.charges,So=t=>Vt.select(t),Kn=()=>Vt.updateButtons(),on=e.spellWave;function Mo(){on&&(on.classList.remove("active"),on.offsetWidth,on.classList.add("active"),setTimeout(()=>on.classList.remove("active"),1200))}let ee=no({button:e.spellBtn,onActivate:t=>{if(t==="ice"){let s=ee.effect;Lt+=s.duration*f(),E.play("wsseffect"),xt(`\u{1F4A7} -${s.duration}s`,"time"),Mo(),$e.spawnSpellBubbles(ee.button,s.duration),Ve.spawnBonusBubbles(s.duration)}},onReady:()=>{E.play("readysuper")}});ee.initButton(()=>{if(et==="playing"&&ee.canUse()){if(ee.currentSpell==="earth"){$t==="idle"?bo():rn();return}ee.use()}});function hs(){return te==="30_24"}function qn(){let t=e.spellBtn;t&&(t.style.display=hs()?"":"none")}let ge=[],cn=0,fe=!1,Ie=!1,an=!1,Wt=0,ae=0,pe=0,Ue=[],$t="idle",he=null,Ae=null,we=[],ve=[],zn=0,Xe=null;function Tn(t,s,i){let p=1-i/o;return t+p*s}function _n(t,s,i,p,A,b){let k=(A-b)/c*u+g;return{x:t+Math.cos(k)*i,y:s+Math.sin(k)*p,ang:k}}function ys(t,s){let i=n.clientWidth,p=n.clientHeight,A=i*.5,b=(i-2*F)/2,k=p-y-_,gt=6,at=c*k/(gt*o),Tt=p-_,ht,V,H;at<=Math.min(b,W)?(ht=at,V=k,H=y):(ht=Math.min(b,W),V=ht*gt*o/c,H=Tt-V);let Y=ht*.28,lt=Tn(H,V,t+.5),ft=_n(A,lt,ht,Y,s,rt),yt=n.getBoundingClientRect();return{x:yt.left+ft.x,y:yt.top+ft.y}}function xo(t,s){if(!Vt.canUse()||fe)return!1;let i=zt[Vt.active],p=n.clientWidth,A=n.clientHeight,b=p*.5,k=(p-2*F)/2,gt=A-y-_,at=6,Tt=c*gt/(at*o),ht=A-_,V,H,Y;Tt<=Math.min(k,W)?(V=Tt,H=gt,Y=y):(V=Math.min(k,W),H=V*at*o/c,Y=ht-H);let lt=V*.28,ft=null,yt=1/0;for(let At=0;At<o;At++){let Kt=Tn(Y,H,At+.5);for(let _t=0;_t<c;_t++){let mn=B[At][_t];if(!mn||mn!==i)continue;let Te=_n(b,Kt,V,lt,_t,rt);if(Math.sin(Te.ang)<-.1)continue;let Oe=t-Te.x,fn=s-Te.y,Gn=Math.hypot(Oe,fn),Fs=H/o*.9,ai=Fs*1.2;Math.abs(Oe)<ai/2&&Math.abs(fn)<Fs/2&&Gn<yt&&(yt=Gn,ft={y:At,s:_t})}}if(ft){let At=Tn(Y,H,ft.y+.5),Kt=_n(b,At,V,lt,ft.s,rt),_t=n.getBoundingClientRect(),mn=_t.left+Kt.x,Te=_t.top+Kt.y,gn=Wn[Vt.active];return $e.spawnMagicShot(Vt.active,gn,mn,Te,()=>{let Oe=B[ft.y][ft.s];ge=[{y:ft.y,s:ft.s,color:Oe,isLine:!1,isMagic:!0}],cn=performance.now(),fe=!0,Ie=!0,Wt=0,ae=Xn,xt(`+${Xn}`,"score")}),pe=0,Vt.useCharge(),z.magicUsed++,!0}return!1}function bo(){$t="selecting_source",he=null,Ae=null,we=[],ve=[],E.play("ulta");let t=e.spellBtn;t&&t.classList.add("selecting")}function rn(){$t!=="idle"&&E.play("cancel"),$t="idle",he=null,Ae=null,we=[],ve=[],Bn();let t=e.spellBtn;t&&t.classList.remove("selecting")}function vo(t,s){if($t!=="selecting_source")return!1;let i=Co(t,s);if(!i)return rn(),!0;he={y:i.y,s:i.s,color:B[i.y][i.s]},we=Lo(i.y,i.s,gs);let p=he.color,A=we.filter(b=>B[b.y][b.s]===p);return ve=Ro(A,i.y,i.s,L),To(he.color),$t="selecting_target",!0}function Co(t,s){let i=n.clientWidth,p=n.clientHeight,A=i*.5,b=(i-2*F)/2,k=p-y-_,gt=6,at=c*k/(gt*o),Tt=p-_,ht,V,H;at<=Math.min(b,W)?(ht=at,V=k,H=y):(ht=Math.min(b,W),V=ht*gt*o/c,H=Tt-V);let Y=ht*.28,lt=null,ft=1/0;for(let yt=0;yt<o;yt++){let At=Tn(H,V,yt+.5);for(let Kt=0;Kt<c;Kt++){if(!B[yt][Kt])continue;let _t=_n(A,At,ht,Y,Kt,rt);if(Math.sin(_t.ang)<-.1)continue;let Te=t-_t.x,gn=s-_t.y,Oe=Math.hypot(Te,gn),fn=V/o*.9,Gn=fn*1.2;Math.abs(Te)<Gn/2&&Math.abs(gn)<fn/2&&Oe<ft&&(ft=Oe,lt={y:yt,s:Kt})}}return lt}function To(t){Bn();let s=document.createElement("div");s.className="transmute-popup";let i=document.getElementById("gameContainer"),p=i?i.getBoundingClientRect():{width:window.innerWidth,left:0},b=p.left+p.width/2-160/2,k=window.innerHeight*.7;s.style.left=`${b}px`,s.style.top=`${k}px`,[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}].filter(at=>at.color!==t).forEach(at=>{let Tt=document.createElement("button");Tt.className=`transmute-btn ${at.name}`,Tt.innerHTML=at.icon,Tt.setAttribute("data-color",at.color),Tt.addEventListener("click",ht=>{ht.stopPropagation(),_o(at.color)}),s.appendChild(Tt)}),document.body.appendChild(s),Xe=s,Es=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Ss)},50)}let Es=0;function Ss(t){performance.now()-Es<200||Xe&&!Xe.contains(t.target)&&rn()}function Bn(){document.removeEventListener("pointerdown",Ss),Xe&&(Xe.remove(),Xe=null)}function _o(t){Bn(),Ae=t,ee.use(),Bo()}function Bo(){if(!he){rn();return}if(ve.length===0){rn();return}let t=e.spellBtn;t&&t.classList.remove("selecting"),$t="animating",zn=performance.now(),E.play("esseffect")}function Lo(t,s,i){let p=[],A=Math.floor(i/2);for(let b=-A;b<=A;b++)for(let k=-A;k<=A;k++){let gt=t+b,at=Rn(s+k);if(gt<0||gt>=o)continue;let Tt=b*b+k*k;p.push({y:gt,s:at,distSq:Tt})}return p}function Ro(t,s,i,p){return[...t].sort((b,k)=>b.distSq!==k.distSq?b.distSq-k.distSq:b.y!==k.y?b.y-k.y:b.s-k.s).slice(0,p).map(b=>({y:b.y,s:b.s}))}function Io(t){if($t!=="animating")return!1;let s=(t-zn)/1e3;return Math.min(s/I,1)>=1?(wo(),!1):!0}function Ao(t){if($t!=="animating")return null;let s=(t-zn)/1e3,i=Math.min(s/I,1),p="flash",A=0,b=0;return i<.15?(p="flash",b=1-i/.15):i<.55?(p="shrink",A=(i-.15)/.4):(p="grow",A=(i-.55)/.45),{phase:p,progress:A,areaFlash:b}}function wo(){for(let t of ve)B[t.y][t.s]=Ae;$t="idle",he=null,Ae=null,we=[],ve=[],pe=0,Ln()}let Ei=100;function Si(t,s){return ds(t,s,o,c)}function Po(){return ao(B,o,c)}let Oo=ro;function ko(t){let s=t.map(p=>({...p,color:B[p.y][p.s]}));for(let p of t)B[p.y][p.s]=0;let i=o;for(let p of t){let A=p.y;for(let b=1;b<=p.y;b++){let k=p.y-b;if(B[k][p.s]){A=b-1;break}}i=Math.min(i,A)}for(let p of s)B[p.y-i][p.s]=p.color;return i>0}function Do(){let t=!0;for(;t;){t=!1;let s=Po();for(let i of s)Oo(i)||ko(i)&&(t=!0)}}function Ho(){Ln()}let Qn=io;function Ms(t,s){let i=new Map,p=0,A=0,b=0,k={},gt=t.length+s.length;for(let H of t){let Y=le[H.color],lt=0,ft=0;if(H.length>=5?(lt=j,ft=kt,z.lines5++):H.length===4?(lt=d,ft=ue,z.lines4++):H.length===3&&(lt=Bt,ft=J,z.lines3++),Y&&lt>0){Vt.addCharges(Y,lt),k[Y]=(k[Y]||0)+lt;let yt=H.cells[Math.floor(H.cells.length/2)],At=ys(yt.y,yt.s),Kt=Wn[Y];for(let _t=0;_t<lt;_t++)setTimeout(()=>{$e.spawnMagicOrb(Y,At.x,At.y,Kt)},_t*100)}p+=ft*f(),b+=ft,A+=H.length*Dt;for(let yt of H.cells){let At=`${yt.y},${yt.s}`;i.has(At)||i.set(At,{y:yt.y,s:yt.s,color:H.color,isLine:!0})}}for(let H of s){if(z.pairs++,p+=_e*f(),b+=_e,A+=Un,hs()&&ee.addProgress(1)){let Y=H.cells[Math.floor(H.cells.length/2)],lt=ys(Y.y,Y.s);$e.spawnSpellOrb(lt.x,lt.y,ee.button)}for(let Y of H.cells){let lt=`${Y.y},${Y.s}`;i.has(lt)||i.set(lt,{y:Y.y,s:Y.s,color:B[Y.y][Y.s],isLine:!1})}}let at=Qn(R,gt-1),Tt=Qn(C,pe),ht=Math.round(A*at*Tt),V=0;gt>1&&(z.combos++,z.maxCombo=Math.max(z.maxCombo,gt),setTimeout(()=>xt(`COMBO \xD7${gt}`,"combo"),V),V+=180,E.play("combo2")),pe>0&&(z.cascades++,z.maxCascade=Math.max(z.maxCascade,pe),setTimeout(()=>xt(`CASCADE \xD7${pe}`,"cascade"),V),V+=180,E.play("cascade")),(t.length>0||s.length>0)&&E.play("combo");for(let H of t){let Y=H.length,lt=Y*Dt;setTimeout(()=>xt(`Line-${Y} +${lt}`,"line",H.color),V),V+=100}for(let H of s){let Y=H.cells.length>0?B[H.cells[0].y][H.cells[0].s]:null;setTimeout(()=>xt(`Pair +${Un}`,"pair",Y),V),V+=100}ht>0&&(setTimeout(()=>xt(`+${ht}`,"score"),V),V+=120),b>0&&(setTimeout(()=>xt(`+${b}s`,"time"),V),V+=120);for(let[H,Y]of Object.entries(k))Y>0&&(setTimeout(()=>xt(`+${Y}${Sn(H)}`,"charge"),V),V+=120);ge=Array.from(i.values()),cn=performance.now(),fe=!0,Ie=!1,Wt=p,ae=ht,Kn()}function $o(){for(let t of ge)B[t.y][t.s]=0;if(ge.length>0&&E.playRandom("disappear"),Wt>0){Lt+=Wt;let t=Wt/f();Ve.spawnBonusBubbles(t)}Mt.addScore(ae),Rt+=ae,Pn(),ge=[],fe=!1,Ie=!1,Wt=0,ae=0,pe++,Ln()}function Ln(){Do();let{lineMatches:t,pairMatches:s}=qo();if(t.length>0||s.length>0)Ms(t,s);else{let i=_s();i.length>0?Vo(i):!h&&et==="playing"&&Ts()}}function Mi(t,s){Ms(t,s)}function Rn(t){return We(t,c)}function In(){return Rn(Math.round(rt))}function xs(t,s){return ms(h,t,s,B,o,c)}function An(t){return xs(t,In())}let wn=co;function bs(){Ee&&(Gt!==0&&X>=Gt||(T=0,X+=1))}function Go(){if(!h)return;let t=h.cells,s=h.colors,i={cells:t,colors:s};if(q>=0||(i=wn(i.cells,i.colors),i=wn(i.cells,i.colors)),i=wn(i.cells,i.colors),h.cells=i.cells,h.colors=i.colors,!An(Math.floor($))){h.cells=t,h.colors=s;return}E.play("turn"),tt&&bs()}function No(){return lo(h,$,In(),B,o,c)}function Fo(){if(!h)return!1;let t=Math.floor($)-1,s=!An(t);return s&&!tt?(tt=!0,T=0,X=0):!s&&tt&&(tt=!1,T=0,X=0),s}let Ye=Nn;function ln(){if(et==="playing"){je.classList.add("hidden"),Ut.classList.remove("hidden");return}if(je.classList.remove("hidden"),Ut.classList.add("hidden"),et==="intro"){it.classList.remove("hidden"),It.classList.add("hidden");let t=S.loadHighscore(te);t.score>0?(Xt.textContent=t.score.toLocaleString(),Yt.textContent=Ye(t.time)):(Xt.textContent="0",Yt.textContent="0:00"),Gs(),Re.textContent=`v${Qe}`,se.classList.remove("idlePulse"),se.offsetWidth,se.classList.add("idlePulse")}else{it.classList.add("hidden"),It.classList.remove("hidden"),pt.textContent=Rt.toLocaleString(),bt.textContent=Ye(Jt);let t=S.loadHighscore(te);Rt>0&&Rt>=t.score?Fe.classList.remove("hidden"):Fe.classList.add("hidden");let s=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${z.rings}</span>
          <span class="count ring-max">${z.maxRing>0?"max \xD7"+z.maxRing:""}</span>
        </div>
      `;dt.innerHTML=s;let i=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${z.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${z.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${z.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${z.pairs}</span>
        </div>
      `;Ot.innerHTML=i;let p=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${z.combos}</span>
          <span class="count max-combo">${z.maxCombo>0?"max \xD7"+z.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${z.cascades}</span>
          <span class="count max-cascade">${z.maxCascade>0?"max \xD7"+z.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${z.magicUsed}</span>
        </div>
      `;ce.innerHTML=p}}function Pn(){Mn.textContent=`Score: ${Rt}`}function Zn(){tn.textContent=`Time: ${Ye(Jt)}`}function vs(){let t=Math.max(0,(o-St)/f()),s=Math.floor(t/60),i=Math.floor(t%60);oe.textContent=`Left: ${s}:${i.toString().padStart(2,"0")}`,t<30?oe.classList.add("warning"):oe.classList.remove("warning")}function Uo(){m(te),nt(),St=0,Lt=0,rt=jt=0,Se=0,Mt.start(),Rt=0,ne=performance.now(),Jt=0,Ze=0,He=0,et="playing",de=null,Vt.reset(),ee.reset(),qn(),ge=[],Ue=[],fe=!1,Ie=!1,an=!1,Wt=0,ae=0,pe=0,$t="idle",he=null,Ae=null,we=[],ve=[],Bn(),Kn(),Pn(),Zn(),vs(),Ts(),Ve.drawNextPreview(Le,de),ln(),E.getSettings().musicEnabled&&E.startGameMusic()}function jn(){Mt.gameOver(),et="gameover",h=null,tt=!1,T=0,X=0;let t=S.saveHighscore(Rt,Jt,te);E.stopMusic(),E.play("gameover"),Zn(),ln(),t&&Rt>0&&setTimeout(()=>{xt("\u{1F3C6} NEW RECORD!","score")},500)}function Xo(t){for(let i=0;i<50;i++){let p=t.map(()=>1+(Math.random()*4|0));if(!Yo(t,p))return p}return t.map((i,p)=>1+p%4)}let Yo=go;function Cs(t){let s=t.cells.map(p=>({x:p.x,y:p.y})),i=Xo(s);return{name:t.name,cells:s,colors:i}}function Ts(){if(!de){let A=v[Math.random()*v.length|0];de=Cs(A)}h=de;let t=v[Math.random()*v.length|0];de=Cs(t),Ve.drawNextPreview(Le,de);let s=1/0,i=-1/0;for(let A of h.cells)A.x<s&&(s=A.x),A.x>i&&(i=A.x);let p=(s+i)/2;for(let A of h.cells)A.x=A.x-Math.round(p);$=o+3,vt=0,tt=!1,T=0,X=0,An(Math.floor($))?E.playRandom("appear"):jn()}function _s(){return mo(B,o,c)}function Vo(t){if(t.length===0)return;let s=[];for(let gt of t)for(let at=0;at<c;at++)s.push({y:gt,s:at,color:B[gt][at],isLine:!1});Ue=t,ge=s,cn=performance.now(),fe=!0,an=!0,Ie=!1;let i=t.length;z.rings+=i,z.maxRing=Math.max(z.maxRing,i);let p=Qn(yn,i-1),A=Math.round(Nt*i*p),b=ke*i;ae=A,Wt=b*f(),E.play("ring");let k=`RING \xD7${i}`;xt(k,"ring"),setTimeout(()=>xt(`+${A}`,"score"),150),setTimeout(()=>xt(`+${b}s`,"time"),300)}function Wo(){let t=[...Ue].sort((s,i)=>i-s);for(let s of t){for(let i=s;i<o-1;i++)B[i].set(B[i+1]);B[o-1].fill(0)}if(Wt>0){Lt+=Wt;let s=Wt/f();Ve.spawnBonusBubbles(s)}Mt.addScore(ae),Rt+=ae,Pn(),te==="30_24"&&Ue.length>0&&(Pe=S.addHighTowerRings(Ue.length)),ge=[],Ue=[],fe=!1,an=!1,Wt=0,ae=0,Ln()}function xi(){return _s().length}function Ko(){if(!h)return;let t=In();rt=t,jt=t,Se=0;let s=!1;for(let i=0;i<h.cells.length;i++){let p=h.cells[i],A=h.colors[i],b=Math.floor($)+p.y,k=Rn(t+p.x);b>=o&&(s=!0),b>=0&&b<o&&(B[b][k]=A)}if(s){jn();return}Mt.addScore(ze),Rt+=ze,Pn(),xt(`+${ze}`,"score"),E.playRandom("drop"),h=null,pe=0,Ho()}function qo(){return uo(B,o,c)}function zo(){if(!h)return!1;let t=Math.floor($)-1;return An(t)?($=t,tt=!1,T=0,X=0,!0):(tt=!0,!1)}n.addEventListener("pointerdown",t=>{if(ct.state!=="playing")return;t.preventDefault?.();let s=n.getBoundingClientRect(),i=t.clientX-s.left,p=t.clientY-s.top;ut.handlePointerDown(t,{onMagicTap:()=>$t==="selecting_source"?vo(i,p):ct.applyCommand("magic_shoot",{x:i,y:p}),onDoubleTap:()=>ct.applyCommand("rotate_piece")},jt)||(Se=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(ct.state!=="playing"||!ut.dragging)return;t.preventDefault?.();let s=ut.handlePointerMove(t,{canRotateTo:(i,p)=>ct.canRotateTo(i,p),onDrop:()=>ct.applyCommand("move_down"),onGroundedMove:()=>ct.onGroundedMove()},ct.pieceY,ct.isGrounded);s&&ct.setRotation(s.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{ct.state==="playing"&&ut.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{ut.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{ut.dragging&&ut.handlePointerUp(t)},{passive:!1}),N.addEventListener("click",()=>{ct.state==="playing"&&ct.applyCommand("rotate_piece")});let On=e.dropBtn,kn=null;function Qo(){ct.state==="playing"&&(ct.applyCommand("move_down"),kn=setInterval(()=>{if(ct.state!=="playing"){Dn();return}ct.applyCommand("move_down")},wt))}function Dn(){kn&&(clearInterval(kn),kn=null)}On.addEventListener("pointerdown",t=>{t.preventDefault(),Qo()}),On.addEventListener("pointerup",Dn),On.addEventListener("pointerleave",Dn),On.addEventListener("pointercancel",Dn);for(let[t,s]of Object.entries(Wn))s.addEventListener("click",()=>{ct.state==="playing"&&ct.applyCommand("select_magic",{element:t})});let Jn=e.soundsToggle,ts=e.musicToggle;function Ce(){let t=E.getSettings();t.soundsEnabled?Jn.classList.add("active"):Jn.classList.remove("active"),t.musicEnabled?ts.classList.add("active"):ts.classList.remove("active");for(let s=0;s<=4;s++){let i=e.soundVolBtns[s],p=e.musicVolBtns[s];i&&i.classList.toggle("active",t.soundVolume===s),p&&p.classList.toggle("active",t.musicVolume===s)}}let Bs=e.tabBtns,Zo=e.tabContents;Bs.forEach(t=>{t.addEventListener("click",()=>{let s=t.dataset.tab;Bs.forEach(i=>i.classList.remove("active")),Zo.forEach(i=>i.classList.remove("active")),t.classList.add("active"),Zs(s).classList.add("active"),s==="sounds"&&Ce()})});let Ls=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Rs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,jo=e.iosHint,Jo=e.standaloneBadge;function Is(){let t=document.fullscreenElement||document.webkitFullscreenElement;w.textContent=t?"Disable":"Enable"}Ls&&(Rs?(Jo.style.display="block",w.style.display="none"):(jo.style.display="block",w.textContent="Not supported",w.style.opacity="0.5",w.style.cursor="default")),w.addEventListener("click",()=>{if(Ls&&!Rs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let s=document.documentElement;s.requestFullscreen?s.requestFullscreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Is),document.addEventListener("webkitfullscreenchange",Is);let Hn=e.invertSwipeToggle;M.invertSwipe&&Hn.classList.add("active"),Hn.addEventListener("click",()=>{Hn.classList.toggle("active");let t=Hn.classList.contains("active");ut.rotDir=t?-1:1,M.invertSwipe=t,S.saveGameSettings(M)});let As=e.diffBtns;As.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(As.forEach(s=>{s.classList.remove("active");let i=s.querySelector(".check-icon");i&&i.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let s=document.createElement("span");s.className="check-icon",s.textContent="\u2713",t.appendChild(s)}})}),Jn.addEventListener("click",()=>{let s=!E.getSettings().soundsEnabled;E.updateSettings({soundsEnabled:s}),Ce(),un()}),ts.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),Ce(),un(),et!=="paused"&&(s?et==="playing"?E.startGameMusic():E.startMenuMusic():E.stopMusic())});for(let t=0;t<=4;t++){let s=e.soundVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({soundVolume:t}),Ce(),E.play("turn")})}for(let t=0;t<=4;t++){let s=e.musicVolBtns[t];s&&s.addEventListener("click",()=>{E.updateSettings({musicVolume:t}),Ce()})}Ce();function ws(){et==="playing"&&(Mt.pause(),He=performance.now(),et="paused",E.musicAudio&&E.musicAudio.pause())}function $n(){et==="paused"&&(Mt.resume(),Ze+=performance.now()-He,He=0,et="playing",ss=performance.now(),E.getSettings().musicEnabled&&E.startGameMusic())}function un(){let t=E.getSettings();Ne.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Ne.classList.toggle("off",!t.soundsEnabled),nn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",nn.classList.toggle("off",!t.musicEnabled)}function ti(){ie.classList.remove("hidden"),Ut.classList.add("hidden");let t=S.loadHighscore(te);vn.textContent=t.score?t.score.toLocaleString():"0",xe.textContent=t.time?Nn(t.time):"0:00",me.textContent=te==="30_24"?"High Tower":"Quick Tower",Yn.textContent=Rt.toLocaleString(),Vn.textContent=Nn(Jt),Cn.textContent=te==="30_24"?"High Tower":"Quick Tower",un()}function dn(){ie.classList.add("hidden"),Ut.classList.remove("hidden")}Ut.addEventListener("click",()=>{ws(),ti()}),Ge.addEventListener("click",()=>{dn(),$n()});let es=null;function Ps(t,s){D.textContent=t,es=s,x.classList.remove("hidden")}function Os(){x.classList.add("hidden"),es=null}P.addEventListener("click",()=>{Os()}),G.addEventListener("click",()=>{let t=es;Os(),t&&t()}),bn.addEventListener("click",()=>{Ps("Restart game?",()=>{dn(),ct.applyCommand("start_game")})}),Me.addEventListener("click",()=>{Ps("Exit to menu?",()=>{dn(),Ut.classList.add("hidden"),et="intro",Mt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),ln()})}),en.addEventListener("click",()=>{O.classList.remove("hidden")}),Ne.addEventListener("click",()=>{let t=E.getSettings();E.updateSettings({soundsEnabled:!t.soundsEnabled}),un(),Ce()}),nn.addEventListener("click",()=>{let s=!E.getSettings().musicEnabled;E.updateSettings({musicEnabled:s}),un(),Ce()}),ie.addEventListener("click",t=>{t.target===ie&&(dn(),$n())}),document.addEventListener("keydown",t=>{et==="paused"&&!ie.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(dn(),$n())}),Z.addEventListener("click",()=>{O.classList.add("hidden")}),O.addEventListener("click",t=>{t.target===O&&O.classList.add("hidden")});let ns=!1;document.addEventListener("visibilitychange",()=>{document.hidden?et==="playing"&&(ws(),ns=!0):ns&&et==="paused"&&($n(),ns=!1)});let ct=fo({getN:()=>c,getH:()=>o,FALL_INTERVAL:Qt,LOCK_DELAY_SEC:Zt,getKillRate:f,MATCH_HIGHLIGHT_SEC:pn,MAGIC_SHRINK_SEC:Ke,RING_HIGHLIGHT_SEC:Pt,getState:()=>({gameState:et,score:Rt,elapsedMs:Jt,startTime:ne,totalPausedMs:Ze,stats:z,activePiece:h,pieceY:$,targetRot:jt,rotFloat:rt,rotVel:Se,isGrounded:tt,isHighlighting:fe,isMagicAnimation:Ie,isRingAnimation:an,highlightStartTime:cn,killLevel:St,grid:B,fallTimer:vt,lockTimer:T}),setState:t=>{"elapsedMs"in t&&(Jt=t.elapsedMs),"killLevel"in t&&(St=t.killLevel),"fallTimer"in t&&(vt=t.fallTimer),"lockTimer"in t&&(T=t.lockTimer),"targetRot"in t&&(jt=t.targetRot),"rotFloat"in t&&(rt=t.rotFloat),"rotVel"in t&&(Se=t.rotVel)},funcs:{startGame:Uo,endGame:jn,rotatePieceByDir:Go,tryMoveDown:zo,canPlaceAtRot:xs,maybeResetLockDelay:bs,shootMagic:xo,selectMagic:So,updateGroundedState:Fo,lockPiece:Ko,finishHighlight:$o,finishRingHighlight:Wo},ui:{updateTimeHud:Zn,updateRemainingHud:vs}}),Ve=po({canvas:n,canvasCtx:l,getN:()=>c,getH:()=>o,TOP_PAD_PX:y,BOTTOM_PAD_PX:_,SIDE_MARGIN_PX:F,MAX_RADIUS_X:W,RADIUS_X_FACTOR:Q,ANG_OFFSET:g,MATCH_HIGHLIGHT_SEC:pn,MATCH_SHRINK_PHASE:Fn,MAGIC_SHRINK_SEC:Ke,RING_HIGHLIGHT_SEC:Pt,LOCK_DELAY_SEC:Zt,getKillRate:f,ELEMENT_COLORS:ye,ELEMENT_TO_COLOR:zt,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:Et,ACTIVE_COLOR_FRONT:re,GHOST_COLOR_FILL:st,GHOST_COLOR_STROKE:U,GHOST_STROKE_WIDTH:mt,MAGIC_DIM_DOT_ALPHA:qe,MAGIC_DIM_DOT_SCALE:De,MAGIC_TARGET_DOT_SCALE:hn,getState:()=>({gameState:et,grid:B,activePiece:h,pieceY:$,rotFloat:rt,killLevel:St,isHighlighting:fe,highlightedCells:ge,highlightStartTime:cn,isMagicAnimation:Ie,isRingAnimation:an,isGrounded:tt,lockTimer:T,transmuteState:$t,transmuteSourceBlock:he,transmuteTargetColor:Ae,transmuteAreaCells:we,transmuteBlocksToChange:ve}),getVisualSettings:()=>({waterBubbles:En,waterColor:Ct}),funcs:{snappedRot:In,computeGhostY:No,normSector:Rn,getMagicTargetColor:()=>Vt.canUse()?zt[Vt.active]:null,getTransmuteAnimState:Ao}}),ss=performance.now();function ks(t){let s=Math.min(.05,Math.max(.001,(t-ss)/1e3));if(ss=t,ct.update(s,t),Io(t),Lt>0){let i=Math.min(Lt,Ft*s);St=Math.max(0,St-i),Lt-=i}rt=jt,rt>1e6&&(rt%=c),rt<-1e6&&(rt%=c),Ve.render(s,t),requestAnimationFrame(ks)}se.addEventListener("click",()=>{ct.applyCommand("start_game")}),sn.addEventListener("click",()=>{ct.applyCommand("start_game")}),Ht.addEventListener("click",()=>{et="intro",Mt.reset(),E.stopMusic(),E.getSettings().musicEnabled&&E.startMenuMusic(),ln()}),be.forEach(t=>{t.addEventListener("click",s=>{if(s.target.closest(".spell-select-btn"))return;be.forEach(p=>p.classList.remove("active")),t.classList.add("active"),te=t.dataset.mode,qn();let i=S.loadHighscore(te);i.score>0?(Xt.textContent=i.score.toLocaleString(),Yt.textContent=Ye(i.time)):(Xt.textContent="0",Yt.textContent="0:00"),se.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>se.classList.add("idlePulse"),2e3)})});let os=document.querySelectorAll(".spell-select-btn"),is=document.getElementById("spellDesc"),Ds=document.getElementById("spellProgressFill"),cs=document.getElementById("spellProgressMarkers"),as={ice:0,earth:10,air:25,fire:40},Hs=Object.values(as).sort((t,s)=>t-s),rs=Math.max(...Hs),ei={ice:"Lowers kill zone",air:"Chain lightning",earth:"Transmutation",fire:"Horizontal beam"};S.saveHighTowerRings(15);let Pe=S.loadHighTowerRings();function ni(){cs&&(cs.innerHTML="",Hs.forEach(t=>{let s=document.createElement("span");s.className="marker",s.dataset.threshold=t;let i=t/rs*100;s.style.left=`${i}%`,cs.appendChild(s)}))}function si(t){return t<=0?0:t>=rs?100:t/rs*100}function $s(t){if(!is)return;let s=as[t]||0,i=ei[t]||"";s===0||Pe>=s?is.innerHTML=i:is.innerHTML=`${i} <span class="spell-progress-text">${Pe}/${s}</span>`}function Gs(){if(Pe=S.loadHighTowerRings(),os.forEach(i=>{let p=i.dataset.spell,A=as[p]||0,b=Pe>=A;i.classList.toggle("locked",!b);let k=i.querySelector(".spell-lock");k&&(k.style.display=b?"none":"")}),Ds){let i=si(Pe);Ds.style.width=`${i}%`}document.querySelectorAll(".spell-progress-markers .marker").forEach(i=>{let p=parseInt(i.dataset.threshold,10)||0;i.classList.toggle("reached",Pe>=p)});let s=document.querySelector(".spell-select-btn.active");s&&$s(s.dataset.spell)}ni(),Gs(),os.forEach(t=>{t.addEventListener("click",s=>{s.stopPropagation(),os.forEach(p=>p.classList.remove("active")),t.classList.add("active");let i=t.dataset.spell;ee.selectSpell(i),$s(i)})}),ho.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),s=S.loadHighscore("25_20"),i=`Records

`;i+=`High Tower (30\xD724):
`,i+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Ye(t.time)}
`:`  No record yet
`,i+=`
Quick Tower (25\xD720):
`,i+=s.score>0?`  Score: ${s.score.toLocaleString()}, Time: ${Ye(s.time)}
`:`  No record yet
`,alert(i)}),yo.addEventListener("click",()=>{O.classList.remove("hidden")}),Eo.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),Kn(),qn(),ln(),E.startMenuMusic();let oi=()=>{if(E.unlock(),!E.getSettings().musicEnabled)return;let t=E.musicAudio;!t||t.paused||t.ended?ct.state==="playing"?E.startGameMusic():E.startMenuMusic():t.play().catch(s=>{console.debug("Music resume on interaction failed:",s)})},Ns=0,ii=10,ci=()=>{Ns>=ii||(Ns++,oi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ci,{passive:!0})}),requestAnimationFrame(ks)})();})();
