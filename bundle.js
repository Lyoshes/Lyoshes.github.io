(()=>{var Fi=[0,.25,.5,.75,1],$i=[0,.05,.15,.25,.5],Ni={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},vo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},yo="soundSettings";function Gi(){try{let e=localStorage.getItem(yo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Ui(e){try{localStorage.setItem(yo,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function So(){return{audioContext:null,buffers:{},settings:Gi(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),c=this.audioContext.createBufferSource();c.buffer=n,c.connect(this.audioContext.destination),c.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Fi[this.settings.soundVolume]},getMusicVolume(){return $i[this.settings.musicVolume]},async loadSound(n,c){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(c)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(l){console.debug(`Failed to load sound: ${n} from ${c}`,l)}},preload(){this.initContext();for(let[n,c]of Object.entries(Ni))this.loadSound(n,c)},play(n,c=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let l=n;c!==null&&(l=`${n}${c}`);let i=this.buffers[l];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let r=this.audioContext.createBufferSource();r.buffer=i,r.connect(s),r.start(0),r.onended=()=>{r.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let c=1+Math.floor(Math.random()*3);this.play(n,c)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(vo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(c=>{console.debug("Menu music autoplay blocked:",c)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(vo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(c=>{console.debug("Game music play failed:",c)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Ui(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(c=>{console.debug("Music resume failed:",c)}):this.stopMusic()}catch(c){console.debug("Update music settings failed:",c)}},getSettings(){return{...this.settings}}}}var Eo="eb_highscore",bo="eb_highscore_quick",Mo="eb_settings",xo="eb_high_tower_rings",Xi={invertSwipe:!1,hapticsEnabled:!0};function Co(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?bo:Eo,c=localStorage.getItem(n);if(c)return JSON.parse(c)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,c="30_24"){try{let l=this.loadHighscore(c);if(e>l.score||e===l.score&&n>l.time){let i=c==="25_20"?bo:Eo;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(l){console.debug("Failed to save highscore:",l)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Mo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Xi}},saveGameSettings(e){try{localStorage.setItem(Mo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(xo);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(xo,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let c=this.loadHighTowerRings()+e;return this.saveHighTowerRings(c),c}}}function To(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function _o(e){return document.getElementById("tab-"+e)}var Yi={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Lo(e={}){let{elementColors:n={}}=e,c=0;return{showBonus(l,i="score",s=null){let r=document.createElement("div");r.className=`bonus-popup ${i}`,r.textContent=l,s&&n[s]&&(r.style.color=n[s]);let g=window.innerWidth/2,m=window.innerHeight/2-40,f=(Math.random()-.5)*200,u=(Math.random()-.5)*100+c*36;r.style.left=`${g+f}px`,r.style.top=`${m+u}px`,r.style.transform="translate(-50%, -50%)",document.body.appendChild(r),c++,setTimeout(()=>{c=Math.max(0,c-1)},200),setTimeout(()=>{r.remove()},1800)},getElementIcon(l){return Yi[l]||"\u2726"}}}var Bs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Bo(){return{spawnMagicOrb(e,n,c,l){if(!l)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=Bs[e]||"\u2726";let s=l.getBoundingClientRect(),r=s.left+s.width/2-n,g=s.top+s.height/2-c,m=Math.hypot(r,g),f=Math.atan2(g,r),u=m*.35*(Math.random()>.5?1:-1),p=f+Math.PI/2,M=r*.5+Math.cos(p)*u,P=g*.5+Math.sin(p)*u;i.style.setProperty("--mid-x",`${M}px`),i.style.setProperty("--mid-y",`${P}px`),i.style.setProperty("--end-x",`${r}px`),i.style.setProperty("--end-y",`${g}px`),i.style.left=`${n}px`,i.style.top=`${c}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,c,l,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),r=s.left+s.width/2,g=s.top+s.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Bs[e]||"\u2726";let f=c-r,u=l-g;m.style.setProperty("--end-x",`${f}px`),m.style.setProperty("--end-y",`${u}px`),m.style.left=`${r}px`,m.style.top=`${g}px`,document.body.appendChild(m);let p=setInterval(()=>{let M=m.getBoundingClientRect();this.spawnTrailParticle(e,M.left+M.width/2,M.top+M.height/2)},40);setTimeout(()=>{clearInterval(p),m.remove(),this.spawnExplosion(e,c,l),i&&i()},300)},spawnTrailParticle(e,n,c){let l=document.createElement("div");l.className=`magic-trail ${e}`,l.style.left=`${n}px`,l.style.top=`${c}px`,document.body.appendChild(l),setTimeout(()=>l.remove(),400)},spawnExplosion(e,n,c){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let r=i/12*Math.PI*2+(Math.random()-.5)*.5,g=40+Math.random()*40,m=Math.cos(r)*g,f=Math.sin(r)*g;s.style.setProperty("--px",`${m}px`),s.style.setProperty("--py",`${f}px`),s.style.left=`${n}px`,s.style.top=`${c}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",c=18){if(!e)return;let l=n;typeof n=="number"&&(c=n,l="water"),Bs[l]||(l="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,r=i.top+i.height/2,g=Math.max(8,Math.round(c));for(let m=0;m<g;m++){let f=document.createElement("div");f.className=`spell-bubble ${l}`,f.textContent="\u25CF";let u=m/g*Math.PI*2+(Math.random()-.5)*.6,p=50+Math.random()*60,M=Math.cos(u)*p,P=Math.sin(u)*p-20;f.style.setProperty("--px",`${M}px`),f.style.setProperty("--py",`${P}px`),f.style.left=`${s}px`,f.style.top=`${r}px`,f.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(f),setTimeout(()=>f.remove(),800)}},spawnSpellOrb(e,n,c){if(!c)return;let l=document.createElement("div");l.className="spell-orb",l.textContent="\u2727";let i=c.getBoundingClientRect(),s=i.left+i.width/2-e,r=i.top+i.height/2-n,g=Math.hypot(s,r),m=Math.atan2(r,s),f=g*.35*(Math.random()>.5?1:-1),u=m+Math.PI/2,p=s*.5+Math.cos(u)*f,M=r*.5+Math.sin(u)*f;l.style.setProperty("--mid-x",`${p}px`),l.style.setProperty("--mid-y",`${M}px`),l.style.setProperty("--end-x",`${s}px`),l.style.setProperty("--end-y",`${r}px`),l.style.left=`${e}px`,l.style.top=`${n}px`,document.body.appendChild(l),setTimeout(()=>{l.remove()},700)}}}var Wi=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></div>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Ro=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Vi=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function Ki(e){let n=e.querySelector(".ring"),c=e.querySelector(".falling-figure"),l=e.querySelector(".clock");if(!n||!c||!l)return()=>{};let i=!1,s=[],r=[],g=(q,z)=>{let rt=setTimeout(()=>{i||q()},z);return s.push(rt),rt},m=(q,z)=>{let rt=setInterval(()=>{if(i){clearInterval(rt);return}q()},z);return r.push(rt),rt},f=48,u=.9,p=9,M=9,P=3,I=2,H=18,ot=-12,gt=.5,re=12,J=10,U=["--fire","--water","--light","--earth"],ht=["--light","--fire","--water"],ee=3,Dt=Math.floor(p/2)-1,Vt=8e3,wt=[];function At(q,z){let rt=(z-1)/2,jt=Math.abs(q-rt)/rt;return 1-(1-gt)*jt}function R(q,z,rt,jt){let ye=(z-1)/2,j=Math.abs(q-ye)/ye;return jt?j*rt:-j*rt}function xt(){n.innerHTML="";let q=[],z=[];for(let nt=0;nt<M;nt++)z.push(f*u*At(nt,M));let rt=z.reduce((nt,Tt)=>nt+Tt,0)+(M-1)*I,jt=[];for(let nt=0;nt<p;nt++)jt.push(f*At(nt,p));let ye=jt.reduce((nt,Tt)=>nt+Tt,0)+(p-1)*P,j=-rt/2;for(let nt=0;nt<M;nt++){let Tt=z[nt],Gt=f*u,ge=p+nt,bt=R(nt,M,J,!0),ne=document.createElement("div");ne.className="block back",ne.style.cssText=`left:${j.toFixed(1)}px;top:${(ot-Gt/2+bt).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Gt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let X=document.createElement("div");X.className="dot";let se=u*At(nt,M);X.style.cssText=`--c:var(${U[ge%4]});transform:scale(${se.toFixed(2)});`,ne.appendChild(X),ne.dataset.index=ge,n.appendChild(ne),q[ge]=ne,j+=Tt+I}let et=-ye/2;for(let nt=0;nt<p;nt++){let Tt=jt[nt],Gt=f,ge=nt,bt=R(nt,p,re,!1),ne=ge>=Dt&&ge<Dt+ee,X=document.createElement("div");X.className="block",ne&&X.classList.add("gap"),X.style.cssText=`left:${et.toFixed(1)}px;top:${(H-Gt/2+bt).toFixed(1)}px;width:${Tt.toFixed(1)}px;height:${Gt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let se=document.createElement("div");se.className="dot";let Ce=At(nt,p);se.style.cssText=`--c:var(${U[ge%4]});transform:scale(${Ce.toFixed(2)});`,X.appendChild(se),X.dataset.index=ge,n.appendChild(X),q[ge]=X,et+=Tt+P}wt=q}function Ct(){let q=[];for(let z=Dt-1;z>=0;z--)q.push(z);for(let z=0;z<M;z++)q.push(p+z);for(let z=p-1;z>=Dt;z--)q.push(z);return q}function St(){wt.forEach((q,z)=>{q&&(q.classList.remove("hi","vanish","gap"),q.style.opacity="",q.style.transform="",z>=Dt&&z<Dt+ee&&q.classList.add("gap"))})}function a(){for(let q=0;q<ee;q++){let z=wt[Dt+q];if(z){z.classList.remove("gap");let rt=z.querySelector(".dot");if(rt){let jt=At(Dt+q,p);rt.style.cssText=`--c:var(${ht[q]});transform:scale(${jt.toFixed(2)});`}}}}function ct(q){let z=Ct(),rt=0,jt=z.length,ye=m(()=>{if(rt>0&&rt<=jt){let j=wt[z[rt-1]];j&&j.classList.remove("hi")}if(rt<jt){let j=wt[z[rt]];j&&j.classList.add("hi"),rt++}else clearInterval(ye),wt.forEach(j=>{j&&j.classList.add("hi")}),g(q,300)},30)}function tt(q){let z=Ct(),rt=z.length;z.forEach((jt,ye)=>{let j=wt[jt];j&&g(()=>{j.classList.add("vanish")},ye*40)}),g(q,rt*40+500)}function fe(){i||(St(),c.classList.add("active"),g(()=>{a(),c.classList.remove("active"),c.style.opacity="0",g(()=>{ct(()=>{i||(l.classList.add("show"),g(()=>{tt(()=>{i||(l.classList.remove("show"),c.style.opacity="",g(fe,500))})},400))})},200)},Vt*.38))}return xt(),fe(),()=>{i=!0,s.forEach(clearTimeout),r.forEach(clearInterval)}}var qi=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:Wi},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Ro},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:Vi,onEnter:e=>Ki(e)}];function wo(e={}){let{helpBtn:n,mount:c=document.body,combosTemplate:l}=e;if(!n||!c)return{open(){},close(){},setCombosTemplate(){}};let i=qi.map(R=>({...R}));typeof l=="string"&&l.trim()&&(i[1].illustrationHtml=l);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,c.appendChild(s);let r=s.querySelector(".help-next-btn"),g=s.querySelector(".help-slide-title"),m=s.querySelector(".help-slide-text"),f=s.querySelector(".help-illustration"),u=s.querySelector(".help-dots"),p=i.map(()=>{let R=document.createElement("span");return R.className="help-dot",u.appendChild(R),R}),M=0,P=!1,I=null,H=null,ot=180,gt=560,re=460,J=480,U=R=>{H&&(H(),H=null);let xt=i[R];xt&&(M=R,g.textContent=xt.title,m.textContent=xt.text,f.innerHTML=xt.illustrationHtml||"",p.forEach((Ct,St)=>{Ct.classList.toggle("active",St===R)}),r.textContent=R===i.length-1?"Done":"Next",ht(),xt.onEnter&&(H=xt.onEnter(f)))},ht=()=>{if(!P||s.classList.contains("hidden"))return;let R=f.getBoundingClientRect();if(!R.width||!R.height)return;let xt=f.querySelector(".help-combos");if(xt){let a=Math.min(1,Math.min(R.width,R.height)/gt);xt.style.setProperty("--help-combos-scale",a.toFixed(3))}let Ct=f.querySelector(".help-controls");if(Ct){let a=Math.min(1,Math.min(R.width,R.height)/re);Ct.style.setProperty("--help-controls-scale",a.toFixed(3))}let St=f.querySelector(".help-rings");if(St){let a=Math.min(1,Math.min(R.width,R.height)/J);St.style.setProperty("--help-rings-scale",a.toFixed(3))}},ee=()=>{P&&ht()},Dt=R=>{P&&R.stopPropagation()},Vt=R=>{if(P){if(R.key==="Escape"){R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.(),At();return}R.preventDefault(),R.stopPropagation(),R.stopImmediatePropagation?.()}},wt=()=>{P||(P=!0,I&&(clearTimeout(I),I=null),U(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),ht()}),document.addEventListener("keydown",Vt,!0),window.addEventListener("resize",ee))},At=()=>{P&&(P=!1,H&&(H(),H=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",Vt,!0),window.removeEventListener("resize",ee),I=window.setTimeout(()=>{s.classList.add("hidden")},ot))};return s.addEventListener("click",R=>{P&&(R.target===s&&At(),R.stopPropagation())}),s.addEventListener("pointerdown",Dt),s.addEventListener("pointerup",Dt),s.addEventListener("touchstart",Dt,{passive:!0}),s.addEventListener("touchmove",R=>{P&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),s.addEventListener("wheel",R=>{P&&(R.preventDefault(),R.stopPropagation())},{passive:!1}),r.addEventListener("click",R=>{R.stopPropagation(),M<i.length-1?U(M+1):At()}),n.addEventListener("click",R=>{R.preventDefault(),wt()}),{open:wt,close:At,setCombosTemplate(R){typeof R=="string"&&(i[1].illustrationHtml=R.trim()||Ro,P&&M===1&&U(1))}}}var zi={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function ji(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Rs=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let c=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return c?(navigator.vibrate(c),!0):!1}},ws=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Ao({enabled:e=!0,patterns:n=zi}={}){let c=ji(),l=c?new ws(c):new Rs,i=l.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(r){s=!!r&&i},trigger(r){if(!s)return!1;let g=n[r];return g?l.trigger({name:r,...g}):!1}}}function Io(e={}){let{buttons:n={},onActivate:c=null,onChange:l=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function r(){for(let[m,f]of Object.entries(n)){if(!f)continue;let u=i[m],p=f.querySelector(".charges");p&&(p.textContent=u),f.classList.toggle("empty",u<=0),f.classList.toggle("active",s===m&&u>0)}l&&l({...i},s)}function g(m){let f=n[m];f&&(f.classList.remove("pulse"),f.offsetWidth,f.classList.add("pulse"),setTimeout(()=>f.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(m){s=m},select(m){if(i[m]<=0)return!1;let f=s===m;return s=f?null:m,r(),!f&&s===m&&c&&c(),!f},useCharge(){if(!s||i[s]<=0)return!1;let m=s;return i[m]--,s=null,r(),g(m),!0},addCharges(m,f){i[m]!==void 0&&(i[m]+=f,r(),g(m))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,r()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,r()},updateButtons:r,initButtons(m){for(let[f,u]of Object.entries(n))u&&u.addEventListener("click",()=>{m&&m(f)})}}}var qe={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Horizontal beam - limited area clear",cost:12,unlockRings:40,effect:{type:"horizontal_beam",beamLength:4,beamWidth:2,animSec:.4}}};function Po(e={}){let{button:n=null,onActivate:c=null,onProgress:l=null,onReady:i=null}=e,s="ice",r=0;function g(){return qe[s]||qe.ice}function m({silent:u=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let p=g(),M=Number.isFinite(p.maxProgress)?p.maxProgress:0,P=M>0?Math.min(r/M,1)*100:0,I=M>0&&r>=M;n.style.setProperty("--progress",`${P}%`);let H=n.querySelector(".spell-icon");H&&(H.textContent=p.icon);let ot=n.querySelector(".spell-counter");ot&&(ot.textContent=M>0?`${Math.min(r,M)}/${M}`:""),n.classList.toggle("ready",I),n.classList.toggle("charging",!I&&r>0),l&&!u&&M>0&&l(r,M)}function f(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return r},get maxProgress(){return g().maxProgress??0},get isReady(){let u=g().maxProgress;return Number.isFinite(u)&&u>0&&r>=u},get effect(){return g().effect},getUnlockRings(u){return(qe[u]||qe.ice).unlockRings??0},getCost(u){return(qe[u]||qe.ice).cost??0},getDescription(u){return(qe[u]||qe.ice).description||""},getEffect(u){return(qe[u]||qe.ice).effect},get button(){return n},selectSpell(u){qe[u]&&(s=u,r=0,m())},addProgress(u=1){let p=g();if(!Number.isFinite(p.maxProgress)||p.maxProgress<=0||r>=p.maxProgress)return!1;let M=r<p.maxProgress;return r=Math.min(r+u,p.maxProgress),m(),f(),M&&r>=p.maxProgress&&i&&i(),!0},setProgress(u,{silent:p=!1}={}){r=Math.max(0,u),m({silent:p})},canUse(){let u=g().maxProgress;return Number.isFinite(u)&&u>0&&r>=u},use(){if(!this.canUse())return null;let u=g().effect;return r=0,m(),f(),c&&c(s),u},reset(){r=0,m()},pulse(){f()},updateButton:m,initButton(u){n&&n.addEventListener("click",()=>{u&&u()})}}}function As({centerY:e,centerS:n,size:c,H:l,normSector:i}){let s=[],r=Math.floor(c/2);for(let g=-r;g<=r;g++)for(let m=-r;m<=r;m++){let f=e+g,u=i(n+m);if(f<0||f>=l)continue;let p=g*g+m*m;s.push({y:f,s:u,distSq:p})}return s}function ls(e,n,c){return n.filter(l=>e[l.y][l.s]===c)}function ds(e,n){return[...e].sort((l,i)=>l.distSq!==i.distSq?l.distSq-i.distSq:l.y!==i.y?l.y-i.y:l.s-i.s).slice(0,n).map(l=>({y:l.y,s:l.s}))}function ko({centerY:e,centerS:n,beamLength:c,beamWidth:l,N:i,H:s,normSector:r}){if(e<0||e>=s||l<=0||c<0||i<=0)return[];let g=Math.min(l,s),m=[],f=new Set,u=I=>I<0||I>=s||f.has(I)?!1:(f.add(I),m.push(I),!0);u(e);for(let I=1;m.length<g&&(e+I<s||e-I>=0)&&(u(e+I),!(m.length>=g));I++)u(e-I);m.sort((I,H)=>H-I);let p=Math.min(i,c*2+1),M=c%2===0,P=[];for(let I of m){let H=new Set,ot=(gt,re)=>{let J=r(gt);return H.has(J)?!1:(H.add(J),P.push({y:I,s:J,dist:re}),!0)};ot(n,0);for(let gt=1;H.size<p&&gt<i;gt++)if(M){if(ot(n+gt,gt),H.size>=p)break;ot(n-gt,gt)}else{if(ot(n-gt,gt),H.size>=p)break;ot(n+gt,gt)}}return P}function Oo(e){let{canvas:n,dom:c,getGrid:l,getN:i,getH:s,getRotFloat:r,constants:g,helpers:m,Spell:f,Magic:u,SoundModule:p,State:M,isGamePlaying:P,addPendingKzDrop:I,getKillRate:H,triggerSpellWave:ot,spawnSpellBubbles:gt,spawnBonusBubbles:re,getTransmuteEffect:J,getLightningEffect:U,getFireEffect:ht,continueMatchProcessing:ee,updateScoreHud:Dt,showBonus:Vt,getSpellCost:wt,getSpellElement:At,onUltimateApplied:R,isSpellBlocked:xt,setScore:Ct,setCascadeLevel:St}=e,{TOP_PAD_PX:a,BOTTOM_PAD_PX:ct,SIDE_MARGIN_PX:tt,MAX_RADIUS_X:fe,SCORE_MAGIC_DESTROY:q}=g,{normSector:z,levelYToScreenY:rt,sectorCenterXY:jt}=m,ye=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],j="idle",et=null,nt=null,Tt=[],Gt=[],ge=0,bt=null,ne=0,X="idle",se=null,Ce=[],oe=[],W=0,k=0,b="idle",_=null,D=[],v=[],st=0;function at(h){if(typeof wt!="function"||typeof At!="function")return!1;let w=At(h),E=wt(h);return!w||!E?!1:(u.charges[w]??0)>=E}function Et(h){if(typeof wt!="function"||typeof At!="function")return!1;let w=At(h),E=wt(h);return!w||!E||(u.charges[w]??0)<E?!1:(u.charges[w]-=E,u.updateButtons(),f.pulse(),!0)}let G=0,B=350;function x(){return typeof xt=="function"?xt():!1}function y(){let h=performance.now();h-G<B||(G=h,p.play("cancel"))}function kt(){j="selecting_source",et=null,nt=null,Tt=[],Gt=[],X!=="idle"&&Ut(),b!=="idle"&&_t(),u.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function T(){j!=="idle"&&p.play("cancel"),j="idle",et=null,nt=null,Tt=[],Gt=[],Ft();let h=c.spellBtn;h&&h.classList.remove("selecting")}function It(h,w){if(j!=="selecting_source")return!1;if(x())return y(),!0;let E=O(h,w);if(!E)return T(),!0;let ut=l();et={y:E.y,s:E.s,color:ut[E.y][E.s]},Tt=As({centerY:E.y,centerS:E.s,size:J().areaSize,H:s(),normSector:z});let Pt=et.color,Ot=ls(ut,Tt,Pt);return Gt=ds(Ot,J().maxBlocks),Qt(et.color,E.y),j="selecting_target",!0}function O(h,w){let E=n.clientWidth,ut=n.clientHeight,Pt=E*.5,Ot=(E-2*tt)/2,qt=ut-a-ct,_e=6,Le=s(),he=i(),ve=r(),ze=he*qt/(_e*Le),Se=ut-ct,me,Ve,Ie;ze<=Math.min(Ot,fe)?(me=ze,Ve=qt,Ie=a):(me=Math.min(Ot,fe),Ve=me*_e*Le/he,Ie=Se-Ve);let Be=me*.28,tn=null,yn=1/0,en=l();for(let Jt=0;Jt<Le;Jt++){let fn=rt(Ie,Ve,Jt+.5);for(let Pe=0;Pe<he;Pe++){if(!en[Jt][Pe])continue;let Re=jt(Pt,fn,me,Be,Pe,ve);if(Math.sin(Re.ang)<-.1)continue;let ue=h-Re.x,Sn=w-Re.y,ie=Math.hypot(ue,Sn),ke=Ve/Le*.9,C=ke*1.2;Math.abs(ue)<C/2&&Math.abs(Sn)<ke/2&&ie<yn&&(yn=ie,tn={y:Jt,s:Pe})}}return tn}function Qt(h,w){Ft();let E=document.createElement("div");E.className="transmute-popup";let ut=n.clientWidth,Pt=n.clientHeight,Ot=(ut-2*tt)/2,qt=Pt-a-ct,_e=6,Le=s(),he=i(),ve=he*qt/(_e*Le),ze=Pt-ct,Se,me;ve<=Math.min(Ot,fe)?(Se=qt,me=a):(Se=Math.min(Ot,fe)*_e*Le/he,me=ze-Se);let Ve=rt(me,Se,w+.5),Ie=Math.floor(J().areaSize/2),Be=rt(me,Se,Math.min(Le,w+Ie)+.5),tn=rt(me,Se,Math.max(0,w-Ie)+.5),yn=me+Se/2,en=document.getElementById("gameContainer"),Jt=en?en.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},fn=160,Pe=60,Re=20,gn=Jt.left+Jt.width/2-fn/2,ue;Ve<yn?ue=Jt.top+tn+Re:ue=Jt.top+Be-Pe-Re,ue=Math.max(10,Math.min(window.innerHeight-Pe-10,ue)),E.style.left=`${gn}px`,E.style.top=`${ue}px`,ye.filter(ie=>ie.color!==h).forEach(ie=>{let ke=document.createElement("button");ke.className=`transmute-btn ${ie.name}`,ke.innerHTML=ie.icon,ke.setAttribute("data-color",ie.color),ke.addEventListener("click",C=>{C.stopPropagation(),Ue(ie.color)}),E.appendChild(ke)}),document.body.appendChild(E),bt=E,ne=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",ae)},50)}function ae(h){performance.now()-ne<200||bt&&!bt.contains(h.target)&&T()}function Ft(){document.removeEventListener("pointerdown",ae),bt&&(bt.remove(),bt=null)}function Ue(h){if(x()){y();return}if(!at(f.currentSpell)){y();return}if(Ft(),nt=h,Gt.length===0){T();return}Kt()}function Kt(){if(!et){T();return}if(Gt.length===0){T();return}if(!Et(f.currentSpell)){y(),T();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),j="animating",ge=performance.now(),p.play("esseffect")}function Xe(){if(j!=="selecting_target"&&j!=="animating"||!et||!Tt||Tt.length===0)return;let h=l(),w=h[et.y]?.[et.s]??0;if(!w||w!==et.color){T();return}let E=ls(h,Tt,w),ut=J().maxBlocks??E.length;Gt=ds(E,ut),Gt.length===0&&T()}function zt(h){if(j!=="animating")return!1;let w=(h-ge)/1e3;return Math.min(w/J().animSec,1)>=1?(Mn(),!1):!0}function Te(h){if(j!=="animating")return null;let w=(h-ge)/1e3,E=Math.min(w/J().animSec,1),ut="flash",Pt=0,Ot=0;return E<.15?(ut="flash",Ot=1-E/.15):E<.55?(ut="shrink",Pt=(E-.15)/.4):(ut="grow",Pt=(E-.55)/.45),{phase:ut,progress:Pt,areaFlash:Ot}}function Mn(){let h=l();for(let w of Gt)h[w.y][w.s]=nt;j="idle",et=null,nt=null,Tt=[],Gt=[],St(0),ee(),typeof R=="function"&&R("earth")}function Zt(){p.play("ulta"),X="selecting_source",se=null,Ce=[],oe=[],k=0,j!=="idle"&&(j="idle",et=null,nt=null,Tt=[],Gt=[],Ft()),b!=="idle"&&(b="idle",_=null,D=[],v=[],st=0),u.deactivate();let h=c.spellBtn;h&&h.classList.add("selecting")}function Ut(){X!=="idle"&&p.play("cancel"),X="idle",se=null,Ce=[],oe=[],k=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function A(){b="selecting_source",_=null,D=[],v=[],st=0,j!=="idle"&&(j="idle",et=null,nt=null,Tt=[],Gt=[],Ft()),X!=="idle"&&(X="idle",se=null,Ce=[],oe=[],k=0),u.deactivate(),p.play("ulta");let h=c.spellBtn;h&&h.classList.add("selecting")}function _t(){b!=="idle"&&p.play("cancel"),b="idle",_=null,D=[],v=[],st=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function $t(h,w){if(X!=="selecting_source")return!1;if(x())return y(),!0;let E=O(h,w);if(!E)return Ut(),!0;let ut=l();se={y:E.y,s:E.s,color:ut[E.y][E.s]},Ce=As({centerY:E.y,centerS:E.s,size:U().areaSize,H:s(),normSector:z});let Pt=se.color,Ot=ls(ut,Ce,Pt);return oe=ds(Ot,U().maxBlocks),oe.length===0?(Ut(),!0):at(f.currentSpell)?(an(),!0):(y(),!0)}function Xt(h,w){if(b!=="selecting_source")return!1;if(x())return y(),!0;let E=O(h,w);if(!E)return _t(),!0;let ut=l();return _={y:E.y,s:E.s,color:ut[E.y][E.s]},D=ko({centerY:E.y,centerS:E.s,beamLength:ht().beamLength,beamWidth:ht().beamWidth,N:i(),H:s(),normSector:z}),v=D.filter(Pt=>ut[Pt.y][Pt.s]),v.length===0?(_t(),!0):at(f.currentSpell)?(We(),!0):(y(),!0)}function an(){if(!se||oe.length===0){Ut();return}if(!Et(f.currentSpell)){y(),Ut();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),X="animating",W=performance.now(),k=0,p.play("asseffect")}function Ye(h){if(X!=="animating")return!1;let w=h-W,E=U().flashMs+oe.length*U().jumpMs;return w>=E?(vn(),!1):!0}function ln(h){if(X!=="animating")return null;let w=h-W;if(w<U().flashMs)return{phase:"flash",flashProgress:1-w/U().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let E=w-U().flashMs,ut=Math.floor(E/U().jumpMs),Pt=E%U().jumpMs/U().jumpMs,Ot=[];for(let qt=0;qt<Math.min(ut,oe.length);qt++)Ot.push(qt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(ut,oe.length-1),jumpProgress:Pt,struckTargets:Ot}}function vn(){let h=l(),w=oe.length,E=w*q;M.addScore(E),Ct(M.score),Dt(),Vt(`+${E}`,"score");for(let qt of oe)h[qt.y][qt.s]=0;let ut=U(),Pt=Math.abs(ut.kzDropSecPerBlock??0),Ot=w*Pt;Ot>0&&typeof I=="function"&&typeof H=="function"&&(I(Ot*H()),Vt(`\u26A1 -${Ot}s`,"time")),X="idle",se=null,Ce=[],oe=[],k=0,St(0),ee(),typeof R=="function"&&R("air")}function We(){if(!_||v.length===0){_t();return}if(!Et(f.currentSpell)){y(),_t();return}let h=c.spellBtn;h&&h.classList.remove("selecting"),b="animating",st=performance.now(),p.play("fsseffect")}function mt(h){return b!=="animating"?!1:(h-st)/1e3>=ht().animSec?(dn(),!1):!0}function le(h){if(b!=="animating")return null;let w=Math.max(.001,ht().animSec),E=(h-st)/1e3,ut=Math.min(E/w,1),Pt=.25,Ot=ut<Pt?1-ut/Pt:0;return{progress:ut,flashProgress:Ot}}function dn(){let h=l(),w=v.length;if(w>0){let E=w*q;M.addScore(E),Ct(M.score),Dt(),Vt(`+${E}`,"score")}for(let E of v)h[E.y][E.s]=0;b="idle",_=null,D=[],v=[],st=0,St(0),ee(),typeof R=="function"&&R("fire")}function An(){let h=typeof P=="function"?P():M.isPlaying(),w=f.currentSpell;if(!h)return!1;if(w==="ice"){if(x()||!at(w)||!Et(f.currentSpell))return y(),!1;let E=f.effect;return typeof I=="function"&&typeof H=="function"&&I(E.duration*H()),p.play("wsseffect"),Vt(`\u{1F4A7} -${E.duration}s`,"time"),typeof ot=="function"&&ot(),typeof re=="function"&&re(E.duration),typeof R=="function"&&R(w),!0}return w==="earth"?j==="selecting_source"||j==="selecting_target"?(T(),!0):j!=="idle"||x()||!at(w)?(y(),!1):(j==="idle"&&kt(),!0):w==="air"?X==="selecting_source"?(Ut(),!0):X!=="idle"||x()||!at(w)?(y(),!1):(X==="idle"&&Zt(),!0):w==="fire"?b==="selecting_source"?(_t(),!0):b!=="idle"||x()||!at(w)?(y(),!1):(b==="idle"&&A(),!0):!1}function un(h){Xe(),zt(h),Ye(h),mt(h)}function de(h,w){return x()&&(j==="selecting_source"||X==="selecting_source"||b==="selecting_source")?(y(),!0):j==="selecting_source"?It(h,w):X==="selecting_source"?$t(h,w):b==="selecting_source"?Xt(h,w):!1}function xn(){j="idle",et=null,nt=null,Tt=[],Gt=[],Ft(),X="idle",se=null,Ce=[],oe=[],k=0,b="idle",_=null,D=[],v=[],st=0;let h=c.spellBtn;h&&h.classList.remove("selecting")}function $e(){return{transmuteState:j,transmuteSourceBlock:et,transmuteTargetColor:nt,transmuteAreaCells:Tt,transmuteBlocksToChange:Gt,lightningState:X,lightningSourceBlock:se,lightningAreaCells:Ce,lightningBlocksToHit:oe,fireState:b,fireSourceBlock:_,fireLineCells:D,fireTargets:v}}return{startTransmuteSourceSelection:kt,cancelTransmutation:T,startLightningSourceSelection:Zt,cancelLightning:Ut,startFireSourceSelection:A,cancelFire:_t,handleTap:de,update:un,reset:xn,getRenderState:$e,getTransmuteAnimState:Te,getLightningAnimState:ln,getFireAnimState:le,handleSpellButtonClick:An,isTransmuteSelecting:()=>j==="selecting_source",isLightningSelecting:()=>X==="selecting_source"}}var Qi={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Do(e={}){let{canvas:n}=e,c=e.rotDir||1,l=!1,i=0,s=0,r=0,g=0,m=0,f=1,u=null,p=0,M=0,P=0,I=0,H=0,ot=0,gt=0,re=0,J=Qi;return{get rotDir(){return c},set rotDir(U){c=U},get dragging(){return l},get dragMode(){return u},handlePointerDown(U,ht,ee){if(ht.onMagicTap&&ht.onMagicTap(U.clientX,U.clientY))return!0;let Dt=performance.now(),Vt=Dt-ot,wt=U.clientX-gt,At=U.clientY-re,R=Math.hypot(wt,At);return Vt<=J.DOUBLE_TAP_MS&&R<=J.DOUBLE_TAP_MAX_DIST?(ht.onDoubleTap&&ht.onDoubleTap(),ot=0):(ot=Dt,gt=U.clientX,re=U.clientY),l=!0,f=-1,i=U.clientX,s=U.clientY,r=ee,g=0,m=0,u=null,p=Dt,M=U.clientX,P=U.clientY,I=p,H=0,n&&n.setPointerCapture(U.pointerId),!1},handlePointerMove(U,ht,ee,Dt){if(!l)return null;let Vt=U.clientX-i,wt=U.clientY-s,At=performance.now();if(Math.abs(Vt)<J.DEADZONE_PX&&Math.abs(wt)<J.DEADZONE_PX)return null;if(u){if(u==="rotate"){let xt=Math.abs(Vt),Ct=Math.abs(wt);if(Ct>=xt*J.AXIS_DOMINANCE&&Ct>=J.DROP_SWIPE_MIN_DISTANCE){let St=Math.max(1,At-p);Ct/St*1e3>=J.DROP_SWIPE_MIN_SPEED&&(u="drop",m=0)}}}else{let xt=Math.abs(Vt),Ct=Math.abs(wt);if(wt<0)xt>=J.DEADZONE_PX&&(u="rotate");else if(Ct>=xt*J.AXIS_DOMINANCE){if(Ct>=J.DROP_SWIPE_MIN_DISTANCE){let St=Math.max(1,At-p);Ct/St*1e3>=J.DROP_SWIPE_MIN_SPEED?u="drop":u="rotate"}}else xt>=Ct*J.AXIS_DOMINANCE&&(u="rotate");if(!u)return null}let R=null;if(u==="rotate"&&Math.abs(Vt)>=J.DEADZONE_PX){let xt=Math.max(1,At-I),Ct=U.clientX-M,St=Math.max(1,Math.abs(Ct)/xt*1e3),a=Math.max(J.MIN_ROT_PX,Math.min(J.MAX_ROT_PX,J.PX_PER_STEP*(J.SWIPE_SPEED_REF/St)));H+=-Ct/a*c*f;let ct=Math.trunc(H);ct!==0&&(H-=ct);let tt=g+ct;if(tt!==g&&ht.canRotateTo){let fe=Math.sign(tt-g),q=r+g;for(;g!==tt;){let z=g+fe,rt=r+z;if(!ht.canRotateTo(Math.floor(ee),rt))break;g=z,q=rt,ht.onRotateStep&&ht.onRotateStep(),Dt&&ht.onGroundedMove&&ht.onGroundedMove()}R={targetRot:q,rotFloat:q}}}if(u==="drop"&&wt>=J.DROP_SWIPE_MIN_DISTANCE&&ht.onDrop){let xt=Math.max(1,At-I),Ct=U.clientY-P,St=Math.max(1,Ct/xt*1e3),a=Math.max(J.MIN_DROP_PX,Math.min(J.MAX_DROP_PX,J.PX_PER_DROP*(J.SWIPE_SPEED_REF/St))),ct=Math.trunc(wt/a);if(ct>m){let tt=ct-m;for(let fe=0;fe<tt;fe++)ht.onDrop();m=ct}}return M=U.clientX,P=U.clientY,I=At,R},handlePointerUp(U){if(l&&(l=!1,u=null,n&&U&&U.pointerId!==void 0))try{n.releasePointerCapture(U.pointerId)}catch{}},reset(){l=!1,u=null,g=0,m=0,H=0}}}var Is={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Ho(){let e="intro",n=0,c=0,l=0,i=0,s=0,r={...Is};return{get state(){return e},get score(){return n},get elapsedMs(){return l},get startTime(){return c},get stats(){return r},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,c=performance.now(),l=0,i=0,s=0,r={...Is}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(g){n+=g},setScore(g){n=g},updateTime(){e==="playing"&&c>0&&(l=performance.now()-c-s)},getFormattedTime(){let g=Math.floor(l/1e3),m=Math.floor(g/60),f=g%60;return`${m}:${f.toString().padStart(2,"0")}`},incrementStat(g,m=1){g in r&&(r[g]+=m)},updateMaxStat(g,m){g in r&&m>r[g]&&(r[g]=m)},reset(){e="intro",n=0,c=0,l=0,i=0,s=0,r={...Is}}}}function wn(e,n){return e%=n,e<0&&(e+=n),e}function Fo(e,n){return e[Math.min(n,e.length-1)]}function us(e){let n=Math.max(0,Math.floor(e/1e3)),c=Math.floor(n/60),l=n%60;return`${c}:${l.toString().padStart(2,"0")}`}function $o(e,n){let c=e.map(({x:g,y:m},f)=>({x:m,y:-g,color:n[f]})),l=1/0,i=-1/0,s=1/0;for(let g of c)l=Math.min(l,g.x),i=Math.max(i,g.x),s=Math.min(s,g.y);let r=Math.round((l+i)/2);for(let g of c)g.x-=r,g.y-=s;return c.sort((g,m)=>g.y-m.y||g.x-m.x),{cells:c.map(g=>({x:g.x,y:g.y})),colors:c.map(g=>g.color)}}function Ps(e,n,c,l){let i=[];return e+1<c&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:wn(n-1,l)}),i.push({y:e,s:wn(n+1,l)}),i}function No(e,n,c){let l=Array.from({length:n},()=>new Uint8Array(c)),i=[];for(let s=0;s<n;s++)for(let r=0;r<c;r++){if(!e[s][r]||l[s][r])continue;let g=[],m=[{y:s,s:r}];for(l[s][r]=1;m.length>0;){let f=m.shift();g.push(f);for(let u of Ps(f.y,f.s,n,c))e[u.y][u.s]&&!l[u.y][u.s]&&(l[u.y][u.s]=1,m.push(u))}i.push(g)}return i}function Go(e){return e.some(n=>n.y===0)}function ks(e,n,c,l,i,s){if(!e)return!1;let r=wn(c,s);for(let g of e.cells){let m=n+g.y,f=wn(r+g.x,s);if(m<0)return!1;if(!(m>=i)&&l[m][f])return!1}return!0}function Uo(e,n,c,l,i,s){if(!e)return null;let r=Math.floor(n);for(;ks(e,r-1,c,l,i,s);)r-=1;return r}function Xo(e,n,c){let l=[],i=[];for(let s=0;s<n;s++){let r=[],g=0,m=e[s][0],f=m?1:0;for(let u=1;u<=c;u++){let p=u<c?e[s][u]:0;p&&p===m?f++:(f>=1&&m&&r.push({start:g,length:f,color:m}),g=u,m=p,f=p?1:0)}if(r.length>=2){let u=r[0],p=r[r.length-1];if(u.start===0&&p.start+p.length===c&&u.color===p.color){let M=u.length+p.length;r[0]={start:p.start,length:M,color:u.color},r.pop()}}for(let u of r)if(u.length>=3){let p=[];for(let M=0;M<u.length;M++)p.push({y:s,s:(u.start+M)%c});l.push({color:u.color,length:u.length,cells:p})}}for(let s=0;s<c;s++){let r=0,g=e[0][s],m=g?1:0;for(let f=1;f<=n;f++){let u=f<n?e[f][s]:0;if(u&&u===g)m++;else{if(m>=3&&g){let p=[];for(let M=0;M<m;M++)p.push({y:r+M,s});l.push({color:g,length:m,cells:p})}r=f,g=u,m=u?1:0}}}for(let s=0;s<n;s++)for(let r=0;r<c;r++){let g=e[s][r],m=e[s][(r+1)%c],f=e[s][(r+2)%c],u=e[s][(r+3)%c];g&&g===m&&f&&f===u&&g!==f&&i.push({cells:[{y:s,s:r},{y:s,s:(r+1)%c},{y:s,s:(r+2)%c},{y:s,s:(r+3)%c}]})}for(let s=0;s<c;s++)for(let r=0;r<n-3;r++){let g=e[r][s],m=e[r+1][s],f=e[r+2][s],u=e[r+3][s];g&&g===m&&f&&f===u&&g!==f&&i.push({cells:[{y:r,s},{y:r+1,s},{y:r+2,s},{y:r+3,s}]})}return{lineMatches:l,pairMatches:i}}function Yo(e,n,c){let l=[];for(let i=0;i<n;i++){let s=!0;for(let r=0;r<c;r++)if(!e[i][r]){s=!1;break}s&&l.push(i)}return l}function Wo(e,n){let c=new Map;e.forEach((l,i)=>c.set(`${l.x},${l.y}`,n[i]));for(let l=0;l<e.length;l++){let i=e[l],s=n[l],r=1;for(let ot=1;ot<=2&&c.get(`${i.x+ot},${i.y}`)===s;ot++)r++;if(r>=3)return!0;let g=1;for(let ot=1;ot<=2&&c.get(`${i.x},${i.y+ot}`)===s;ot++)g++;if(g>=3)return!0;let m=s,f=c.get(`${i.x+1},${i.y}`),u=c.get(`${i.x+2},${i.y}`),p=c.get(`${i.x+3},${i.y}`);if(m&&f&&u&&p&&m===f&&u===p&&m!==u)return!0;let M=s,P=c.get(`${i.x},${i.y+1}`),I=c.get(`${i.x},${i.y+2}`),H=c.get(`${i.x},${i.y+3}`);if(M&&P&&I&&H&&M===P&&I===H&&M!==I)return!0}return!1}function Vo(e){let{getN:n,getH:c,FALL_INTERVAL:l,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:r,MAGIC_SHRINK_SEC:g,RING_HIGHLIGHT_SEC:m,getState:f,setState:u,funcs:p,ui:M}=e;return{get state(){return f().gameState},get score(){return f().score},get elapsedMs(){return f().elapsedMs},get stats(){return f().stats},get activePiece(){return f().activePiece},get pieceY(){return f().pieceY},get targetRot(){return f().targetRot},get isGrounded(){return f().isGrounded},get isHighlighting(){return f().isHighlighting},get killLevel(){return f().killLevel},get grid(){return f().grid},applyCommand(P,I={}){let H=f();if(P==="start_game")return H.gameState!=="playing"?(p.startGame(),!0):!1;if(H.gameState!=="playing")return!1;switch(P){case"rotate_piece":return p.rotatePieceByDir(),!0;case"move_down":return p.tryMoveDown();case"rotate_cylinder":{let{rot:ot}=I;return typeof ot=="number"&&p.canPlaceAtRot(Math.floor(H.pieceY),ot)?(u({targetRot:ot,rotFloat:ot,rotVel:0}),H.isGrounded&&p.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:ot,y:gt}=I;return p.shootMagic(ot,gt)}case"select_magic":{let{element:ot}=I;return p.selectMagic(ot),!0}default:return console.warn("GameEngine: unknown command",P),!1}},update(P,I){let H=f();if(H.gameState!=="playing")return;let ot=I-H.startTime-H.totalPausedMs;u({elapsedMs:ot}),M.updateTimeHud();let gt=H.killLevel+s()*P;if(u({killLevel:gt}),M.updateRemainingHud(),gt>=c()){p.endGame();return}if(H.isHighlighting){let U=(I-H.highlightStartTime)/1e3,ht;H.isRingAnimation?ht=m:H.isMagicAnimation?ht=g:ht=r,U>=ht&&(H.isRingAnimation?p.finishRingHighlight():p.finishHighlight())}let re=H.fallTimer+P;if(re>=l&&(re-=l,p.tryMoveDown()),u({fallTimer:re}),p.updateGroundedState()){let U=H.lockTimer+P;u({lockTimer:U}),U>=i&&p.lockPiece()}},reset(){p.startGame()},canRotateTo(P,I){return p.canPlaceAtRot(P,I)},getRotation(){let P=f();return{targetRot:P.targetRot,rotFloat:P.rotFloat,rotVel:P.rotVel}},setRotation(P){u({targetRot:P,rotFloat:P,rotVel:0})},onGroundedMove(){p.maybeResetLockDelay()}}}var Ge=Math.PI*2;function Ko(e){let{canvas:n,canvasCtx:c,getN:l,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:r,SIDE_MARGIN_PX:g,MAX_RADIUS_X:m,RADIUS_X_FACTOR:f,ANG_OFFSET:u,MATCH_HIGHLIGHT_SEC:p,MATCH_SHRINK_PHASE:M,MAGIC_SHRINK_SEC:P,RING_HIGHLIGHT_SEC:I,LOCK_DELAY_SEC:H,getKillRate:ot,ELEMENT_COLORS:gt,ELEMENT_TO_COLOR:re,BLOCK_COLOR_FRONT:J,BLOCK_COLOR_BACK:U,ACTIVE_COLOR_FRONT:ht,GHOST_COLOR_FILL:ee,GHOST_COLOR_STROKE:Dt,GHOST_STROKE_WIDTH:Vt,MAGIC_DIM_DOT_ALPHA:wt,MAGIC_DIM_DOT_SCALE:At,MAGIC_TARGET_DOT_SCALE:R,getState:xt,getVisualSettings:Ct,funcs:St}=e,a=c,ct=l(),tt=i(),fe={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},q=[],z=40;function rt(W,k,b,_,D){let v=Math.max(3,Math.round(W)),st=180;for(let at=0;at<v;at++)setTimeout(()=>{let Et=Math.random()>.5?"left":"right",G=15,B=Et==="left"?G+Math.random()*Math.max(10,k-G*2):b+G+Math.random()*Math.max(10,D-b-G*2),x=_-10;q.push({x:B,baseX:B,y:x,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:G,maxX:D-G})},at*st)}function jt(W,k,b){q=q.filter(_=>_.y>W+_.size&&_.y>-20);for(let _ of q){_.y-=z*b,_.wobble+=_.wobbleSpeed*b;let D=_.baseX+Math.sin(_.wobble)*_.wobbleAmp;_.x=Math.max(_.minX,Math.min(_.maxX,D))}}function ye(W){if(q.length!==0){a.fillStyle="rgba(255, 255, 255, 0.3)",a.strokeStyle="rgba(255, 255, 255, 0.5)",a.lineWidth=1;for(let k of q)k.y<W+k.size||(a.beginPath(),a.arc(k.x,k.y,k.size,0,Math.PI*2),a.fill(),a.stroke())}}let j={left:0,right:0,h:0,w:0};function et(W,k,b){let _=1-b/tt;return W+_*k}function nt(W){return W=W%ct,W<0?W+ct:W}function Tt(W,k,b,_,D,v){let st=nt(v),at=(D-st)/ct*Ge+u;return{x:W+Math.cos(at)*b,y:k+Math.sin(at)*_,ang:at}}let Gt=.52,ge=1.02;function bt(W,k,b,_,D,v){let st=nt(v),at=(D-st)/ct*Ge+u;return{x:W+Math.cos(at)*b,y:k+Math.sin(at)*_,ang:at}}function ne(W,k,b,_,D,v,st,at=1){let Et=bt(W,k,b,_,D-Gt,v),G=bt(W,k,b,_,D+Gt,v),B={x:Et.x,y:Et.y-st*.5},x={x:Et.x,y:Et.y+st*.5},y={x:G.x,y:G.y-st*.5},kt={x:G.x,y:G.y+st*.5},T=(B.x+y.x+kt.x+x.x)*.25,It=(B.y+y.y+kt.y+x.y)*.25,O=ge*at,Qt=at,ae=[B,y,kt,x].map(Kt=>({x:T+(Kt.x-T)*O,y:It+(Kt.y-It)*Qt})),Ft=Math.abs((G.x-Et.x)*O),Ue=Math.abs(st*Qt);return{corners:ae,cx:T,cy:It,wApprox:Ft,hApprox:Ue,ang:bt(W,k,b,_,D,v).ang}}function X(W,k,b,_,D,v,st,at,Et=1,G=null,B=1,x=null,y=0,kt=1,T=1){let It=ne(W,k,b,_,D,v,st,T),[O,Qt,ae,Ft]=It.corners;if(a.save(),a.globalAlpha=Et,a.fillStyle=at,a.beginPath(),a.moveTo(O.x,O.y),a.lineTo(Qt.x,Qt.y),a.lineTo(ae.x,ae.y),a.lineTo(Ft.x,Ft.y),a.closePath(),a.fill(),x&&y>0&&(a.strokeStyle=x,a.lineWidth=y,a.stroke()),G){let Ue=Math.min(It.wApprox,It.hApprox)*.28*kt;a.globalAlpha=Et*B,a.fillStyle=G,a.beginPath(),a.arc(It.cx,It.cy,Ue,0,Ge),a.fill()}a.restore(),a.globalAlpha=1}function se(W,k,b,_,D,v){let st=Tt(W,k,b,_,D,v),at=Tt(W,k,b,_,D+1,v),Et=Tt(W,k,b,_,D-1,v),G=Math.abs(at.x-st.x),B=Math.abs(st.x-Et.x),x=(G+B)*.5*1.06;return Math.max(1,x)}function Ce(W,k,b,_,D,v){let st=(D-v)/ct*Ge+u;return{x:W+Math.cos(st)*b,y:k+Math.sin(st)*_,ang:st}}function oe(W,k,b,_,D,v,st,at=1,Et=null,G=1,B=null,x=0,y=1){a.save(),a.translate(W,k);let kt=Math.atan2(_,b);if(a.rotate(kt),a.globalAlpha=at,a.fillStyle=st,a.fillRect(-D/2,-v/2,D,v),B&&x>0&&(a.strokeStyle=B,a.lineWidth=x,a.strokeRect(-D/2,-v/2,D,v)),Et){let T=Math.min(D,v)*.28*y;a.globalAlpha=at*G,a.fillStyle=Et,a.beginPath(),a.arc(0,0,T,0,Ge),a.fill()}a.restore(),a.globalAlpha=1}return{resize(){let W=Math.max(1,Math.min(2,window.devicePixelRatio||1)),k=Math.floor(n.clientWidth*W),b=Math.floor(n.clientHeight*W);(n.width!==k||n.height!==b)&&(n.width=k,n.height=b,a.setTransform(W,0,0,W,0,0))},render(W=.016,k=performance.now()){this.resize();let b=xt();ct=l(),tt=i();let _=n.clientWidth,D=n.clientHeight;a.clearRect(0,0,_,D),a.fillStyle="#0b0f14",a.fillRect(0,0,_,D);let v=_*.5,st=(_-2*g)/2,at=D-s-r,Et=6,G=ct*at/(Et*tt),B,x,y,kt;kt=D-r,G<=Math.min(st,m)?(B=G,x=at,y=s):(B=Math.min(st,m),x=B*Et*tt/ct,y=kt-x);let T=B*.28,{killLevel:It,rotFloat:O,grid:Qt,gameState:ae}=b,Ft=Ct?Ct():{},Ue=Ft.waterColor||"blue",Kt=Ft.waterBubbles||!1,Xe=fe[Ue]||fe.blue,zt=et(y,x,It),Te=.7,Mn=It/tt,Zt={...Xe.top},Ut={...Xe.bottom};if(Mn>Te){let C=(Mn-Te)/(1-Te);Zt.r=Math.round(Zt.r+(255-Zt.r)*C*.5),Zt.g=Math.round(Zt.g+(150-Zt.g)*C*.5),Zt.b=Math.round(Zt.b+(150-Zt.b)*C*.5),Ut.r=Math.round(Ut.r+(180-Ut.r)*C),Ut.g=Math.round(Ut.g*(1-C*.6)),Ut.b=Math.round(Ut.b*(1-C*.6))}let A=v-B-8,_t=v+B+8,$t=y,Xt=kt+5,an=a.createLinearGradient(0,zt,0,D);an.addColorStop(0,`rgba(${Zt.r},${Zt.g},${Zt.b},0.5)`),an.addColorStop(1,`rgba(${Ut.r},${Ut.g},${Ut.b},0.7)`),a.fillStyle=an;let Ye=Math.round((Zt.r+Ut.r)/2),ln=Math.round((Zt.g+Ut.g)/2),vn=Math.round((Zt.b+Ut.b)/2),We=B+8,mt=T+4;a.fillRect(0,zt,A,D-zt),a.fillRect(_t,zt,_-_t,D-zt),a.beginPath();let le=Math.max(zt,Xt);a.moveTo(A,le),zt<=Xt+mt?a.ellipse(v,Xt,We,mt,0,Math.PI,0,!1):a.lineTo(_t,le),a.lineTo(_t,D),a.lineTo(A,D),a.closePath(),a.fill(),a.strokeStyle="rgba(100,180,255,0.6)",a.lineWidth=3,a.lineCap="round",a.beginPath(),a.moveTo(A,$t),a.lineTo(A,Xt),a.stroke(),a.beginPath(),a.moveTo(_t,$t),a.lineTo(_t,Xt),a.stroke(),a.beginPath(),a.ellipse(v,Xt,B+8,T+4,0,0,Math.PI),a.stroke(),a.fillStyle="#0b0f14",a.beginPath(),a.ellipse(v,Xt,B+8,T+4,0,0,Ge),a.fill(),It>.5&&(a.strokeStyle=`rgba(${Math.min(255,Ye+60)},${Math.min(255,ln+40)},${Math.min(255,vn+40)},0.6)`,a.lineWidth=2,a.beginPath(),a.moveTo(0,zt),a.lineTo(A,zt),a.moveTo(_t,zt),a.lineTo(_,zt),a.stroke()),j={left:A,right:_t,h:D,w:_},(q.length>0||Kt)&&(jt(zt,D,W),ye(zt)),a.strokeStyle="rgba(160,190,220,0.3)",a.lineWidth=1;let dn=Ge*B,An=10,un=dn/An*.7,de=dn/An*.3;a.setLineDash([un,de]);let xn=dn/ct;a.lineDashOffset=nt(O)*xn;for(let C=0;C<=tt;C++){let $=et(y,x,C);a.beginPath(),a.ellipse(v,$,B,T,0,0,Ge),a.stroke()}a.setLineDash([]);let $e=[],h=[];for(let C=0;C<tt;C++){let $=et(y,x,C+.5);for(let Q=0;Q<ct;Q++){let Y=Qt[C][Q];if(!Y)continue;let Z=Tt(v,$,B,T,Q,O),K=Math.sin(Z.ang),F={y:C,s:Q,yScr:$,p:Z,depth:K,color:Y};K<-.1?$e.push(F):h.push(F)}}let w=St.getMagicTargetColor(),{isHighlighting:E,highlightedCells:ut,highlightStartTime:Pt,isMagicAnimation:Ot}=b,qt=null,_e=1,Le=1,he=!1;if(E&&ut.length>0){qt=new Set(ut.map($=>`${$.y},${$.s}`));let C=(performance.now()-Pt)/1e3;if(Ot){let $=Math.min(1,C/P);_e=1-$*.85,Le=1-$*.9,he=!0}else{let $=Math.min(1,C/p),Q=1-M;if($>Q){let Y=($-Q)/M;_e=1-Y*.85,Le=1-Y*.9,he=!0}}}$e.sort((C,$)=>C.depth-$.depth);for(let C of $e){let $=x/tt*.9,Q=gt[C.color]||null,Y=.35,Z=1,K=`${C.y},${C.s}`;qt&&qt.has(K)&&(Y*=Le,Z=_e),X(v,C.yScr,B,T,C.s,O,$,U,Y,Q,.5,null,0,1,Z)}let{isRingAnimation:ve}=b;if(E&&ut.length>0&&!Ot){let C=(performance.now()-Pt)/1e3,Q=Math.min(1,C/(ve?I:p)),Y=1-M,Z=Q>Y,K=Z?(Q-Y)/M:0,F=ve?Math.floor(Q*Y*ct*2)%ct:-1,L=4+Q/Y*10,V=Math.sin(C*L*Ge),ft=Z?1:.3+V*.3,yt=Z?1-K*.8:1,Lt=Z?1-K:1;for(let dt of ut){let Bt=et(y,x,dt.y+.5),we=bt(v,Bt,B,T,dt.s,O);if(Math.sin(we.ang)>=-.1)continue;let En=x/tt*.9,Ee,Oe,Rt;if(ve){let je=(dt.s-F+ct)%ct,nn=je<3?1-je/3:0;Ee=(Z?Lt:.2+nn*.5)*.5,Oe=`rgba(255, 159, 67, ${Ee})`,Rt=Z?yt:1+nn*.15}else Ee=ft*Lt,Oe=dt.isLine?`rgba(255, 255, 255, ${Ee*.5})`:`rgba(255, 220, 100, ${Ee*.4})`,Rt=Z?yt:1.1;X(v,Bt,B,T,dt.s,O,En,Oe,1,null,1,null,0,1,Rt)}}h.sort((C,$)=>C.depth-$.depth);for(let C of h){let $=x/tt*.9,Q=gt[C.color]||null,Y=1,Z=1,K=1,F=1,L=`${C.y},${C.s}`,V=qt&&qt.has(L);V&&(Y=Le,Z=_e),w!==null&&!V&&(C.color!==w?(K=wt,F=At):F=R),X(v,C.yScr,B,T,C.s,O,$,J,Y,Q,K,null,0,F,Z)}if(E&&ut.length>0&&!Ot){let C=(performance.now()-Pt)/1e3,Q=Math.min(1,C/(ve?I:p)),Y=1-M,Z=Q>Y,K=Z?(Q-Y)/M:0,F=ve?Math.floor(Q*Y*ct*2)%ct:-1,L=4+Q/Y*10,V=Math.sin(C*L*Ge),ft=Z?1:.5+V*.5,yt=Z?1-K*.8:1,Lt=Z?1-K:1;for(let dt of ut){let Bt=et(y,x,dt.y+.5),we=bt(v,Bt,B,T,dt.s,O);if(Math.sin(we.ang)<-.1)continue;let En=x/tt*.9,Ee,Oe,Rt;if(ve){let je=(dt.s-F+ct)%ct,nn=je<4?1-je/4:0;Ee=Z?Lt:.3+nn*.7,Oe=`rgba(255, 159, 67, ${Ee})`,Rt=Z?yt:1+nn*.2}else Ee=ft*Lt,Oe=dt.isLine?`rgba(255, 255, 255, ${Ee*.7})`:`rgba(255, 220, 100, ${Ee*.6})`,Rt=Z?yt:1.15;X(v,Bt,B,T,dt.s,O,En,Oe,1,null,1,null,0,1,Rt)}}let ze=b.spellState||b,{transmuteState:Se,transmuteSourceBlock:me,transmuteTargetColor:Ve,transmuteAreaCells:Ie,transmuteBlocksToChange:Be}=ze;if(Se==="selecting_source"){let C=x/tt*.9,$=.35+Math.sin(k/150)*.15;for(let Q of h){let Y=et(y,x,Q.y+.5);X(v,Y,B,T,Q.s,O,C,`rgba(0, 40, 20, ${$})`,1,null,1,null,0,1,1)}}if(Se==="selecting_target"&&Be&&Be.length>0){let C=x/tt*.9,$=.4+Math.sin(k/120)*.25,Q=.6+Math.sin(k/120)*.4;for(let Y of Be){if(Y.y<0||Y.y>=tt)continue;let Z=et(y,x,Y.y+.5),K=bt(v,Z,B,T,Y.s,O);Math.sin(K.ang)<-.1||(X(v,Z,B,T,Y.s,O,C,`rgba(0, 50, 30, ${$})`,1,null,1,null,0,1,1),X(v,Z,B,T,Y.s,O,C,"transparent",1,null,1,`rgba(100, 255, 150, ${Q})`,3,1,1.02))}}if(Se==="animating"&&St.getTransmuteAnimState){let C=St.getTransmuteAnimState(k);if(C){let $=x/tt*.9,{phase:Q,progress:Y,areaFlash:Z}=C;if(Z>0&&Ie)for(let K of Ie){if(K.y<0||K.y>=tt)continue;let F=et(y,x,K.y+.5),L=bt(v,F,B,T,K.s,O);Math.sin(L.ang)<-.1||X(v,F,B,T,K.s,O,$,`rgba(150, 255, 200, ${Z*.4})`,1,null,1,null,0,1,1)}if(Be&&Be.length>0){let K=me?me.color:1,F=Ve||1;for(let L of Be){if(L.y<0||L.y>=tt)continue;let V=et(y,x,L.y+.5),ft=bt(v,V,B,T,L.s,O);if(Math.sin(ft.ang)<-.1)continue;let Lt=1,dt=gt[K],Bt=0;if(Q==="shrink"?(Lt=1-Y*.95,dt=gt[K],Bt=.5+Y*.3):Q==="grow"&&(Lt=Y,dt=gt[F],Bt=.8-Y*.5),Bt>0&&X(v,V,B,T,L.s,O,$,`rgba(200, 255, 220, ${Bt})`,1,null,1,null,0,1,1),Lt>.05){let we=ne(v,V,B,T,L.s,O,$,1),Ke=Math.min(we.wApprox,we.hApprox)*.28*Lt;a.save(),a.globalAlpha=1,a.fillStyle=dt,a.beginPath(),a.arc(we.cx,we.cy,Ke,0,Ge),a.fill(),a.restore()}}}}}let{lightningState:tn,lightningSourceBlock:yn,lightningAreaCells:en,lightningBlocksToHit:Jt}=ze;if(tn==="selecting_source"){let C=x/tt*.9,$=.35+Math.sin(k/150)*.15;for(let Q of h){let Y=et(y,x,Q.y+.5);X(v,Y,B,T,Q.s,O,C,`rgba(20, 20, 60, ${$})`,1,null,1,null,0,1,1)}}if(tn==="animating"&&St.getLightningAnimState){let C=St.getLightningAnimState(k);if(C&&Jt&&Jt.length>0){let $=x/tt*.9,{phase:Q,flashProgress:Y,currentTarget:Z,jumpProgress:K,struckTargets:F}=C;if(Q==="flash"&&Y>0&&en)for(let L of en){if(L.y<0||L.y>=tt)continue;let V=et(y,x,L.y+.5),ft=bt(v,V,B,T,L.s,O);Math.sin(ft.ang)<-.1||X(v,V,B,T,L.s,O,$,`rgba(100, 150, 255, ${Y*.5})`,1,null,1,null,0,1,1)}if(F&&F.length>0)for(let L of F){let V=Jt[L];if(!V||V.y<0||V.y>=tt)continue;let ft=et(y,x,V.y+.5),yt=bt(v,ft,B,T,V.s,O);if(Math.sin(yt.ang)<-.1)continue;let dt=(F.length-1-F.indexOf(L))*.1,Bt=Math.max(0,.8-dt);X(v,ft,B,T,V.s,O,$,`rgba(255, 255, 255, ${Bt})`,1,null,1,`rgba(150, 200, 255, ${Bt})`,2,1,1.05)}if(Q==="chain"&&Z>=0&&Z<Jt.length){let L=Jt[Z];if(L&&L.y>=0&&L.y<tt){let V=et(y,x,L.y+.5),ft=bt(v,V,B,T,L.s,O);if(Math.sin(ft.ang)>=-.1){let Lt=1-K;X(v,V,B,T,L.s,O,$,`rgba(200, 220, 255, ${Lt*.9})`,1,null,1,`rgba(100, 180, 255, ${Lt})`,3,1,1.1-K*.05)}}if(Z>0){let V=Jt[Z-1],ft=Jt[Z];if(V&&ft){let yt=et(y,x,V.y+.5),Lt=et(y,x,ft.y+.5),dt=ne(v,yt,B,T,V.s,O,$,1),Bt=ne(v,Lt,B,T,ft.s,O,$,1);a.save(),a.strokeStyle=`rgba(150, 200, 255, ${1-K*.5})`,a.lineWidth=2+(1-K)*2,a.lineCap="round",a.beginPath();let we=dt.cx,Ke=dt.cy,En=Bt.cx,Ee=Bt.cy;a.moveTo(we,Ke);let Oe=4;for(let Rt=1;Rt<=Oe;Rt++){let je=Rt/Oe,nn=we+(En-we)*je,lt=Ke+(Ee-Ke)*je,mn=Rt<Oe?(Math.random()-.5)*8:0;a.lineTo(nn+mn,lt+mn)}a.stroke(),a.strokeStyle=`rgba(100, 150, 255, ${(1-K)*.3})`,a.lineWidth=6,a.stroke(),a.restore()}}}}}let{fireState:fn,fireSourceBlock:Pe,fireLineCells:Re,fireTargets:gn}=ze;if(fn==="selecting_source"){let C=x/tt*.9,$=.3+Math.sin(k/140)*.2;for(let Q of h){let Y=et(y,x,Q.y+.5);X(v,Y,B,T,Q.s,O,C,`rgba(70, 25, 10, ${$})`,1,null,1,null,0,1,1)}}if(fn==="animating"&&St.getFireAnimState){let C=St.getFireAnimState(k);if(C&&Re&&Re.length>0){let $=x/tt*.9,{progress:Q,flashProgress:Y}=C,Z=Math.sin(Q*Math.PI);if(Y>0)for(let K of Re){if(K.y<0||K.y>=tt)continue;let F=et(y,x,K.y+.5),L=bt(v,F,B,T,K.s,O);Math.sin(L.ang)<-.1||X(v,F,B,T,K.s,O,$,`rgba(255, 120, 50, ${Y*.45})`,1,null,1,`rgba(255, 200, 140, ${Y*.5})`,2,1,1.03)}if(Pe){let K=new Map;for(let L of Re){if(L.y<0||L.y>=tt)continue;let V=et(y,x,L.y+.5),ft=bt(v,V,B,T,L.s,O);if(Math.sin(ft.ang)<-.1)continue;let Lt=ne(v,V,B,T,L.s,O,$,1),dt=L.s-Pe.s;dt>ct/2&&(dt-=ct),dt<-ct/2&&(dt+=ct);let Bt=L.y;K.has(Bt)||K.set(Bt,[]),K.get(Bt).push({x:Lt.cx,y:Lt.cy,offset:dt})}let F=Array.from(K.keys()).sort((L,V)=>V-L);if(F.length>0){let L=.35+.3*Math.sin(k/60)+Z*.2;a.save(),a.lineCap="round";for(let V of F){let ft=K.get(V)||[];if(ft.sort((yt,Lt)=>yt.offset-Lt.offset),ft.length!==0){a.beginPath(),a.moveTo(ft[0].x,ft[0].y);for(let yt=1;yt<ft.length;yt++)a.lineTo(ft[yt].x,ft[yt].y);a.strokeStyle=`rgba(255, 140, 60, ${L})`,a.lineWidth=Math.max(2,$*.15),a.stroke(),a.strokeStyle=`rgba(255, 210, 140, ${L*.35})`,a.lineWidth=Math.max(6,$*.35),a.stroke()}}a.restore()}}if(gn&&gn.length>0){let K=.2+Z*.6;for(let F of gn){if(F.y<0||F.y>=tt)continue;let L=et(y,x,F.y+.5),V=bt(v,L,B,T,F.s,O);Math.sin(V.ang)<-.1||X(v,L,B,T,F.s,O,$,`rgba(255, 160, 70, ${K})`,1,null,1,`rgba(255, 230, 180, ${Z*.6})`,2,1,1.05)}}}}let{activePiece:ue,pieceY:Sn,isGrounded:ie,lockTimer:ke}=b;if(ue){let C=St.snappedRot(),$=C,Q=St.computeGhostY(),Y=x/tt*.9;if(Q!==null){let F=[];for(let L=0;L<ue.cells.length;L++){let V=ue.cells[L],ft=ue.colors[L],yt=Q+V.y,Lt=St.normSector(C+V.x);if(yt<0||yt>=tt)continue;let dt=et(y,x,yt+.5),Bt=bt(v,dt,B,T,Lt,$);F.push({cy:yt,cs:Lt,yScr:dt,depth:Math.sin(Bt.ang),color:ft})}F.sort((L,V)=>L.depth-V.depth);for(let L of F){let V=gt[L.color]||null;X(v,L.yScr,B,T,L.cs,$,Y,ee,1,V,.5,Dt,Vt,1,1)}}let Z=ht;if(ie&&ke>0){let F=Math.min(1,ke/H),L=255,V=Math.round(170+85*F),ft=Math.round(180+75*F),yt=.75+(1-.75)*F;Z=`rgba(${L},${V},${ft},${yt})`}let K=[];for(let F=0;F<ue.cells.length;F++){let L=ue.cells[F],V=ue.colors[F],ft=St.normSector(C+L.x),yt=Sn+L.y;if(yt<0||yt>=tt)continue;let Lt=et(y,x,yt+.5),dt=bt(v,Lt,B,T,ft,$);K.push({cs:ft,yScr:Lt,depth:Math.sin(dt.ang),color:V})}K.sort((F,L)=>F.depth-L.depth);for(let F of K){let L=gt[F.color]||null;X(v,F.yScr,B,T,F.cs,$,Y,Z,1,L,1,null,0,1,1)}}},drawNextPreview(W,k){if(!W)return;let b=W.getContext("2d"),_=W.width,D=W.height;if(b.clearRect(0,0,_,D),!k)return;let v=1/0,st=-1/0,at=1/0,Et=-1/0;for(let T of k.cells)v=Math.min(v,T.x),st=Math.max(st,T.x),at=Math.min(at,T.y),Et=Math.max(Et,T.y);let G=st-v+1,B=Et-at+1,x=Math.min(_/(G+.5),D/(B+.5)),y=(_-G*x)/2,kt=(D-B*x)/2;b.fillStyle=J;for(let T=0;T<k.cells.length;T++){let It=k.cells[T],O=y+(It.x-v)*x,Qt=kt+(B-1-(It.y-at))*x;b.fillRect(O+1,Qt+1,x-2,x-2);let ae=k.colors[T],Ft=gt[ae];if(Ft){let Ue=(x-2)*.32;b.fillStyle=Ft,b.beginPath(),b.arc(O+x/2,Qt+x/2,Ue,0,Ge),b.fill(),b.fillStyle=J}}},spawnBonusBubbles(W){let{left:k,right:b,h:_,w:D}=j;D>0&&rt(W,k,b,_,D)}}}(()=>{let e=To(),n=e.canvas,c=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let l=Math.PI*2,i=30,s=24,r=120,g={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let o=g[t]||g["30_24"];i=o.N,s=o.H,r=o.survivalTime}function f(){return s/r}let u=Math.PI/2,p=70,M=120,P=30,I=320,H=.42,ot="rgb(235,240,250)",gt="rgb(55,62,75)",re="rgba(255,170,180,0.75)",J="rgba(110,255,150,0.15)",U="rgba(110,255,150,0.85)",ht=2,ee={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},Dt={1:"fire",2:"water",3:"lightning",4:"earth"},Vt={fire:1,water:2,lightning:3,earth:4},wt=1,At=.58,R=!0,xt=12,Ct=25,St=1,a=2,ct=3,tt=1,fe=5,q=7,z=10,rt=3,jt=50,ye=2,j=.3,et=.5,nt=1,Tt=.3,Gt=.5,ge=1.3,bt=10,ne=1e3,X=[1,1.25,1.5,1.75,2],se=10,Ce=20,oe=5,W=[1,1.3,1.6,2],k=[1,1.5,2,2.5],b=Co(),_=b.loadGameSettings();_.hapticsEnabled===void 0&&(_.hapticsEnabled=!0);let D=_.invertSwipe?-1:1,st=!1,at=-1,Et=Ao({enabled:_.hapticsEnabled}),G=Array.from({length:s},()=>new Uint8Array(i));function B(){G=Array.from({length:s},()=>new Uint8Array(i))}let x=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],y=null,kt=s+3,T=0,It=0,O=!1,Qt=0,ae=0,Ft=0,Ue=3,Kt=0,Xe=0,zt=0,Te=Do({canvas:n,rotDir:D}),Mn="0.16.9",Zt=!0,Ut="blue",A=So();A.preload();let _t=Ho(),$t="intro",Xt=0,an=0,Ye=0,ln=0,vn=0,We=null,mt=_t.stats,le=0,dn=e.overlay,An=e.gameContainer,un=Lo({elementColors:ee}),de=un.showBonus.bind(un),xn=un.getElementIcon.bind(un),$e=Bo(),h=e.overlayTitle,w=e.overlayStats,E=e.startBtn,ut=e.hud,Pt=e.scoreHud,Ot=e.timeHud,qt=e.remainingHud,_e=e.nextCanvas,Le=_e.getContext("2d"),he=e.pauseBtn,ve=e.pauseOverlay,ze=e.resumeBtn,Se=e.restartBtn,me=e.exitToMenuBtn,Ve=e.pauseSettingsBtn,Ie=e.pauseSoundBtn,Be=e.pauseMusicBtn,tn=e.pauseBestScore,yn=e.pauseBestTime,en=e.pauseBestMode,Jt=e.pauseCurrentScore,fn=e.pauseCurrentTime,Pe=e.pauseCurrentMode,Re=e.confirmDialog,gn=e.confirmText,ue=e.confirmCancel,Sn=e.confirmOk,ie=e.settingsOverlay,ke=e.settingsClose,C=e.fullscreenBtn,$=e.rotateBtn,Q=e.startPanel,Y=e.gameoverPanel,Z=e.goScore,K=e.goTime,F=e.goRing,L=e.goMatches,V=e.goBonuses,ft=e.goNewRecord,yt=e.goRestartBtn,Lt=e.goExitBtn,dt=e.bestScore,Bt=e.bestTimeVal,we=e.startVersion,Ke=e.modeBtns,En=e.recordsBtn,Ee=e.startSettingsBtn,Oe=e.helpBtn;wo({helpBtn:Oe});let Rt="25_20";function je(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function nn(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let d=o.dataset.mode,S=g[d];if(!S)return;let N=o.querySelector(".mode-tag.time-tag");if(!N)return;let it=je(S.survivalTime);it&&(N.textContent=it)})}nn();let lt=Io({buttons:e.magicBtns,onActivate:()=>A.play("spells"),onChange:(t,o)=>{ms()}}),mn=e.magicBtns,Ji=lt.charges,qo=t=>De()?lt.select(t):!1,In=()=>lt.updateButtons(),Os=e.magicRow,Yt=e.magicActiveIndicator,Ds=e.magicActiveIcon,Hs=e.magicActiveCost,zo={ice:"water",air:"lightning",earth:"earth",fire:"fire"},fs={fire:"fire",water:"ice",lightning:"air",earth:"earth"},jo=["ice","earth","air","fire"];le=b.loadHighTowerRings();function Pn(t){return typeof pe?.getUnlockRings=="function"?pe.getUnlockRings(t):0}function Xn(t){let o=Pn(t);return o===0||le>=o}let Fs=["fire","water","lightning","earth"],Cn=null,Yn=!1,Qo=500,Zo=30,Jo=220,Tn=null,gs=null,$s={fire:!1,water:!1,lightning:!1,earth:!1};function Ns(){if(!Yt)return;let t=Yt.getBoundingClientRect();t.width>0&&t.height>0&&(gs=t)}function ti(){if(!Yt)return null;let t=Yt.getBoundingClientRect();return t.width>0&&t.height>0?Yt:gs?{getBoundingClientRect:()=>gs}:null}function kn(t=lt.active){if(!Yt||!Ds)return;t?(Cn=t,Yn=!1):Yn||(Cn=null);let o=Cn;if(!o||!De()||(lt.charges[o]??0)<=0){Ns(),Yt.classList.add("hidden"),Yt.classList.remove("active","ult-ready",...Fs),Yt.style.setProperty("--progress","0%"),Tn&&clearTimeout(Tn),Tn=setTimeout(()=>{Yt.classList.add("gone")},Jo);return}Tn&&(clearTimeout(Tn),Tn=null),Yt.classList.remove("gone"),Yt.classList.contains("hidden")?requestAnimationFrame(()=>Yt.classList.remove("hidden")):Yt.classList.remove("hidden"),Ds.textContent=xn(o);let S=fs[o];S&&pe.selectSpell(S);let N=S?Dn(S):0,it=lt.charges[o]??0,pt=!!S&&Kn()&&Xn(S),ce=!!S&&Kn()&&!pt,Ae=pt&&N>0?Math.min(it/N,1):0,Je=pt&&N>0,He=Je&&it>=N;Hs&&(Hs.textContent=Je?`-${N}`:ce?"\u{1F512}":""),Yt.classList.toggle("no-cost",!Je&&!ce),Yt.classList.toggle("locked",ce),Yt.classList.toggle("ult-ready",He),Yt.style.setProperty("--progress",`${Math.round(Ae*100)}%`),Yt.classList.remove("hidden",...Fs),Yt.classList.add("active",o),Ns()}function ei(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),Qo))}function Wn(){for(let[t,o]of Object.entries(mn)){if(!o)continue;let d=fs[t],S=Dn(d),N=Kn()&&De()&&d,it=typeof Xn=="function"?Xn(d):!0,pt=N&&it&&S>0&&(lt.charges[t]??0)>=S;o.classList.toggle("ult-ready",pt),pt&&!$s[t]&&(ei(o),$t==="playing"&&A.play("readysuper")),$s[t]=pt}}function De(t=Rt){return t==="30_24"?!0:st}function ms(){kn(lt.active),Wn()}function tc(t){st=t,Rt==="25_20"&&(st?lt.reset():(lt.deactivate(),Object.keys(lt.charges).forEach(o=>{lt.charges[o]=0})),In()),Vn(),ms()}function Vn(){Os&&(Os.style.display=De()?"":"none",kn(lt.active),Wn())}function ec(t){let o=_n(t),d=Dn(t);return!o||d<=0?!1:lt.charges[o]>=d}function nc(t){let o=_n(t),d=Dn(t);return!o||d<=0||lt.charges[o]<d?!1:(lt.charges[o]-=d,lt.updateButtons(),pe.pulse(),!0)}let On=e.spellWave;function ni(){On&&(On.classList.remove("active"),On.offsetWidth,On.classList.add("active"),setTimeout(()=>On.classList.remove("active"),1200))}let sn=null,pe=Po({button:Yt,onReady:()=>{A.play("readysuper")}}),si=()=>pe.getEffect("earth"),oi=()=>pe.getEffect("air"),ii=()=>pe.getEffect("fire"),Dn=t=>typeof pe?.getCost=="function"?pe.getCost(t):0,_n=t=>zo[t]??null;sn=Oo({canvas:n,dom:e,getGrid:()=>G,getN:()=>i,getH:()=>s,getRotFloat:()=>Kt,constants:{TOP_PAD_PX:p,BOTTOM_PAD_PX:M,SIDE_MARGIN_PX:P,MAX_RADIUS_X:I,SCORE_MAGIC_DESTROY:oe},helpers:{normSector:Zn,levelYToScreenY:zn,sectorCenterXY:jn},Spell:pe,Magic:lt,SoundModule:A,State:_t,isGamePlaying:()=>$t==="playing",addPendingKzDrop:t=>{Ft+=t},getKillRate:f,triggerSpellWave:ni,spawnSpellBubbles:t=>{let o=_n(pe.currentSpell)??"water";$e.spawnSpellBubbles(pe.button,o,t)},spawnBonusBubbles:t=>{Rn.spawnBonusBubbles(t)},getTransmuteEffect:si,getLightningEffect:oi,getFireEffect:ii,continueMatchProcessing:Qn,updateScoreHud:$n,showBonus:de,getSpellCost:Dn,getSpellElement:_n,onUltimateApplied:t=>{let o=_n(t)??_n(pe.currentSpell)??"water";if(typeof $e?.spawnSpellBubbles=="function"){let d=ti();d&&$e.spawnSpellBubbles(d,o,Zo)}Yn=!1,Cn=null,kn(null),Wn()},isSpellBlocked:ci,setScore:t=>{Xt=t},setCascadeLevel:t=>{cn=t}});function Kn(){return Rt==="30_24"}function qn(){kn(lt.active),Wn()}let on=[],Hn=0,Qe=!1,pn=!1,Ln=!1,Ne=0,Ze=0,cn=0,Bn=[];function ci(){return Qe||pn||Ln}function zn(t,o,d){let S=1-d/s;return t+S*o}function jn(t,o,d,S,N,it){let pt=(N-it)/i*l+u;return{x:t+Math.cos(pt)*d,y:o+Math.sin(pt)*S,ang:pt}}function Gs(t,o){let d=n.clientWidth,S=n.clientHeight,N=d*.5,it=(d-2*P)/2,pt=S-p-M,ce=6,Ae=i*pt/(ce*s),Je=S-M,He,Ht,vt;Ae<=Math.min(it,I)?(He=Ae,Ht=pt,vt=p):(He=Math.min(it,I),Ht=He*ce*s/i,vt=Je-Ht);let Mt=He*.28,Wt=zn(vt,Ht,t+.5),te=jn(N,Wt,He,Mt,o,Kt),be=n.getBoundingClientRect();return{x:be.left+te.x,y:be.top+te.y}}function ri(t,o){if(!De()||!lt.canUse()||Qe)return!1;let d=Vt[lt.active],S=n.clientWidth,N=n.clientHeight,it=S*.5,pt=(S-2*P)/2,ce=N-p-M,Ae=6,Je=i*ce/(Ae*s),He=N-M,Ht,vt,Mt;Je<=Math.min(pt,I)?(Ht=Je,vt=ce,Mt=p):(Ht=Math.min(pt,I),vt=Ht*Ae*s/i,Mt=He-vt);let Wt=Ht*.28,te=null,be=1/0;for(let Me=0;Me<s;Me++){let Fe=zn(Mt,vt,Me+.5);for(let xe=0;xe<i;xe++){let rs=G[Me][xe];if(!rs||rs!==d)continue;let Un=jn(it,Fe,Ht,Wt,xe,Kt);if(Math.sin(Un.ang)<-.1)continue;let as=t-Un.x,mo=o-Un.y,po=Math.hypot(as,mo),ho=vt/s*.9,Hi=ho*1.2;Math.abs(as)<Hi/2&&Math.abs(mo)<ho/2&&po<be&&(be=po,te={y:Me,s:xe})}}if(te){let Me=zn(Mt,vt,te.y+.5),Fe=jn(it,Me,Ht,Wt,te.s,Kt),xe=n.getBoundingClientRect(),rs=xe.left+Fe.x,Un=xe.top+Fe.y,go=mn[lt.active];return $e.spawnMagicShot(lt.active,go,rs,Un,()=>{let as=G[te.y][te.s];on=[{y:te.y,s:te.s,color:as,isLine:!1,isMagic:!0}],Hn=performance.now(),Qe=!0,pn=!0,Ne=0,Ze=oe,de(`+${oe}`,"score")}),cn=0,lt.useCharge(),mt.magicUsed++,!0}return!1}let sc=100;function oc(t,o){return Ps(t,o,s,i)}function ai(){return No(G,s,i)}let li=Go;function di(t){let o=t.map(S=>({...S,color:G[S.y][S.s]}));for(let S of t)G[S.y][S.s]=0;let d=s;for(let S of t){let N=S.y;for(let it=1;it<=S.y;it++){let pt=S.y-it;if(G[pt][S.s]){N=it-1;break}}d=Math.min(d,N)}for(let S of o)G[S.y-d][S.s]=S.color;return d>0}function ui(){let t=!0;for(;t;){t=!1;let o=ai();for(let d of o)li(d)||di(d)&&(t=!0)}}function fi(){Qn()}let ps=Fo;function Us(t,o){let d=new Map,S=0,N=0,it=0,pt={},ce=t.length+o.length;for(let vt of t){let Mt=Dt[vt.color],Wt=0,te=0;if(vt.length>=5?(Wt=ct,te=z,mt.lines5++):vt.length===4?(Wt=a,te=q,mt.lines4++):vt.length===3&&(Wt=St,te=fe,mt.lines3++),De()&&Mt&&Wt>0){lt.addCharges(Mt,Wt),pt[Mt]=(pt[Mt]||0)+Wt;let be=vt.cells[Math.floor(vt.cells.length/2)],Me=Gs(be.y,be.s),Fe=mn[Mt];for(let xe=0;xe<Wt;xe++)setTimeout(()=>{$e.spawnMagicOrb(Mt,Me.x,Me.y,Fe)},xe*100)}S+=te*f(),it+=te,N+=vt.length*se;for(let be of vt.cells){let Me=`${be.y},${be.s}`;d.has(Me)||d.set(Me,{y:be.y,s:be.s,color:vt.color,isLine:!0})}}for(let vt of o){if(mt.pairs++,S+=rt*f(),it+=rt,N+=Ce,De()){let Mt=[...new Set(vt.cells.map(Wt=>G[Wt.y][Wt.s]).filter(Boolean))];if(Mt.length>0){let Wt=vt.cells[Math.floor(vt.cells.length/2)],te=Gs(Wt.y,Wt.s);Mt.forEach((be,Me)=>{let Fe=Dt[be];if(!Fe)return;lt.addCharges(Fe,tt),pt[Fe]=(pt[Fe]||0)+tt;let xe=mn[Fe];xe&&setTimeout(()=>{$e.spawnMagicOrb(Fe,te.x,te.y,xe)},Me*100)})}}for(let Mt of vt.cells){let Wt=`${Mt.y},${Mt.s}`;d.has(Wt)||d.set(Wt,{y:Mt.y,s:Mt.s,color:G[Mt.y][Mt.s],isLine:!1})}}let Ae=ps(W,ce-1),Je=ps(k,cn),He=Math.round(N*Ae*Je),Ht=0;ce>1&&(mt.combos++,mt.maxCombo=Math.max(mt.maxCombo,ce),setTimeout(()=>de(`COMBO \xD7${ce}`,"combo"),Ht),Ht+=180,A.play("combo2")),cn>0&&(mt.cascades++,mt.maxCascade=Math.max(mt.maxCascade,cn),setTimeout(()=>de(`CASCADE \xD7${cn}`,"cascade"),Ht),Ht+=180,A.play("cascade")),(t.length>0||o.length>0)&&A.play("combo");for(let vt of t){let Mt=vt.length,Wt=Mt*se;setTimeout(()=>de(`Line-${Mt} +${Wt}`,"line",vt.color),Ht),Ht+=100}for(let vt of o){let Mt=vt.cells.length>0?G[vt.cells[0].y][vt.cells[0].s]:null;setTimeout(()=>de(`Pair +${Ce}`,"pair",Mt),Ht),Ht+=100}He>0&&(setTimeout(()=>de(`+${He}`,"score"),Ht),Ht+=120),it>0&&(setTimeout(()=>de(`+${it}s`,"time"),Ht),Ht+=120);for(let[vt,Mt]of Object.entries(pt))Mt>0&&(setTimeout(()=>de(`+${Mt}${xn(vt)}`,"charge"),Ht),Ht+=120);on=Array.from(d.values()),Hn=performance.now(),Qe=!0,pn=!1,Ne=S,Ze=He,In()}function gi(){for(let t of on)G[t.y][t.s]=0;if(on.length>0&&A.playRandom("disappear"),Ne>0){Ft+=Ne;let t=Ne/f();Rn.spawnBonusBubbles(t)}_t.addScore(Ze),Xt+=Ze,$n(),on=[],Qe=!1,pn=!1,Ne=0,Ze=0,cn++,Qn()}function Qn(){ui();let{lineMatches:t,pairMatches:o}=xi();if(t.length>0||o.length>0)Us(t,o);else{let d=qs();d.length>0?Ei(d):!y&&$t==="playing"&&Ks()}}function ic(t,o){Us(t,o)}function Zn(t){return wn(t,i)}function Jn(){return Zn(Math.round(Kt))}function Xs(t,o){return ks(y,t,o,G,s,i)}function ts(t){return Xs(t,Jn())}let es=$o;function Ys(){R&&(xt!==0&&Qt>=xt||(It=0,Qt+=1))}function mi(){if(!y)return;let t=y.cells,o=y.colors,d={cells:t,colors:o};if(at>=0||(d=es(d.cells,d.colors),d=es(d.cells,d.colors)),d=es(d.cells,d.colors),y.cells=d.cells,y.colors=d.colors,!ts(Math.floor(kt))){y.cells=t,y.colors=o;return}A.play("turn"),O&&Ys()}function pi(){return Uo(y,kt,Jn(),G,s,i)}function hi(){if(!y)return!1;let t=Math.floor(kt)-1,o=!ts(t);return o&&!O?(O=!0,It=0,Qt=0):!o&&O&&(O=!1,It=0,Qt=0),o}let bn=us;function Fn(){if($t==="playing"){dn.classList.add("hidden"),he.classList.remove("hidden");return}if(dn.classList.remove("hidden"),he.classList.add("hidden"),$t==="intro"){Q.classList.remove("hidden"),Y.classList.add("hidden");let t=b.loadHighscore(Rt);t.score>0?(dt.textContent=t.score.toLocaleString(),Bt.textContent=bn(t.time)):(dt.textContent="0",Bt.textContent="0:00"),Ls(),we.textContent=`v${Mn}`,E.classList.remove("idlePulse"),E.offsetWidth,E.classList.add("idlePulse")}else{Q.classList.add("hidden"),Y.classList.remove("hidden"),Z.textContent=Xt.toLocaleString(),K.textContent=bn(Ye);let t=b.loadHighscore(Rt);Xt>0&&Xt>=t.score?ft.classList.remove("hidden"):ft.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${mt.rings}</span>
          <span class="count ring-max">${mt.maxRing>0?"max \xD7"+mt.maxRing:""}</span>
        </div>
      `;F.innerHTML=o;let d=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${mt.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${mt.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${mt.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${mt.pairs}</span>
        </div>
      `;L.innerHTML=d;let S=De()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${mt.magicUsed}</span>
        </div>
      `:"",N=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${mt.combos}</span>
          <span class="count max-combo">${mt.maxCombo>0?"max \xD7"+mt.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${mt.cascades}</span>
          <span class="count max-cascade">${mt.maxCascade>0?"max \xD7"+mt.maxCascade:""}</span>
        </div>
        ${S}
      `;V.innerHTML=N}}function $n(){Pt.textContent=`Score: ${Xt}`}function hs(){Ot.textContent=`Time: ${bn(Ye)}`}function Ws(){let t=Math.max(0,(s-ae)/f()),o=Math.floor(t/60),d=Math.floor(t%60);qt.textContent=`Left: ${o}:${d.toString().padStart(2,"0")}`,t<30?qt.classList.add("warning"):qt.classList.remove("warning")}function vi(){m(Rt),B(),ae=0,Ft=0,Kt=Xe=0,zt=0,_t.start(),mt=_t.stats,Xt=0,an=performance.now(),Ye=0,vn=0,ln=0,$t="playing",We=null,De()?lt.reset():(lt.deactivate(),Object.keys(lt.charges).forEach(t=>{lt.charges[t]=0}),In()),pe.reset(),qn(),on=[],Bn=[],Qe=!1,pn=!1,Ln=!1,Ne=0,Ze=0,cn=0,sn.reset(),In(),$n(),hs(),Ws(),ms(),Ks(),Rn.drawNextPreview(_e,We),Fn(),A.getSettings().musicEnabled&&A.startGameMusic()}function vs(){_t.gameOver(),$t="gameover",y=null,O=!1,It=0,Qt=0;let t=b.saveHighscore(Xt,Ye,Rt);A.stopMusic(),A.play("gameover"),hs(),Fn(),t&&Xt>0&&setTimeout(()=>{de("\u{1F3C6} NEW RECORD!","score")},500)}function yi(t){for(let d=0;d<50;d++){let S=t.map(()=>1+(Math.random()*4|0));if(!Si(t,S))return S}return t.map((d,S)=>1+S%4)}let Si=Wo;function Vs(t){let o=t.cells.map(S=>({x:S.x,y:S.y})),d=yi(o);return{name:t.name,cells:o,colors:d}}function Ks(){if(!We){let N=x[Math.random()*x.length|0];We=Vs(N)}y=We;let t=x[Math.random()*x.length|0];We=Vs(t),Rn.drawNextPreview(_e,We);let o=1/0,d=-1/0;for(let N of y.cells)N.x<o&&(o=N.x),N.x>d&&(d=N.x);let S=(o+d)/2;for(let N of y.cells)N.x=N.x-Math.round(S);kt=s+3,T=0,O=!1,It=0,Qt=0,ts(Math.floor(kt))?A.playRandom("appear"):vs()}function qs(){return Yo(G,s,i)}function Ei(t){if(t.length===0)return;let o=[];for(let ce of t)for(let Ae=0;Ae<i;Ae++)o.push({y:ce,s:Ae,color:G[ce][Ae],isLine:!1});Bn=t,on=o,Hn=performance.now(),Qe=!0,Ln=!0,pn=!1;let d=t.length;mt.rings+=d,mt.maxRing=Math.max(mt.maxRing,d);let S=ps(X,d-1),N=Math.round(ne*d*S),it=jt*d;Ze=N,Ne=it*f(),A.play("ring");let pt=`RING \xD7${d}`;de(pt,"ring"),setTimeout(()=>de(`+${N}`,"score"),150),setTimeout(()=>de(`+${it}s`,"time"),300)}function bi(){let t=[...Bn].sort((o,d)=>d-o);for(let o of t){for(let d=o;d<s-1;d++)G[d].set(G[d+1]);G[s-1].fill(0)}if(Ne>0){Ft+=Ne;let o=Ne/f();Rn.spawnBonusBubbles(o)}_t.addScore(Ze),Xt+=Ze,$n(),Rt==="30_24"&&Bn.length>0&&(le=b.addHighTowerRings(Bn.length)),on=[],Bn=[],Qe=!1,Ln=!1,Ne=0,Ze=0,Qn()}function cc(){return qs().length}function Mi(){if(!y)return;let t=Jn();Kt=t,Xe=t,zt=0;let o=!1;for(let d=0;d<y.cells.length;d++){let S=y.cells[d],N=y.colors[d],it=Math.floor(kt)+S.y,pt=Zn(t+S.x);it>=s&&(o=!0),it>=0&&it<s&&(G[it][pt]=N)}if(o){vs();return}_t.addScore(bt),Xt+=bt,$n(),de(`+${bt}`,"score"),A.playRandom("drop"),y=null,cn=0,fi()}function xi(){return Xo(G,s,i)}function Ci(){if(!y)return!1;let t=Math.floor(kt)-1;return ts(t)?(kt=t,O=!1,It=0,Qt=0,!0):(O=!0,!1)}n.addEventListener("pointerdown",t=>{if(Nt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),d=t.clientX-o.left,S=t.clientY-o.top;Te.handlePointerDown(t,{onMagicTap:De()?()=>sn.handleTap(d,S)?!0:Nt.applyCommand("magic_shoot",{x:d,y:S}):null,onDoubleTap:()=>Nt.applyCommand("rotate_piece")},Xe)||(zt=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(Nt.state!=="playing"||!Te.dragging)return;t.preventDefault?.();let o=Te.handlePointerMove(t,{canRotateTo:(d,S)=>Nt.canRotateTo(d,S),onDrop:()=>Nt.applyCommand("move_down"),onGroundedMove:()=>Nt.onGroundedMove(),onRotateStep:()=>Et.trigger("tower_rotate")},Nt.pieceY,Nt.isGrounded);o&&Nt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{Nt.state==="playing"&&Te.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointercancel",t=>{Te.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{Te.dragging&&Te.handlePointerUp(t)},{passive:!1}),$.addEventListener("click",()=>{Nt.state==="playing"&&Nt.applyCommand("rotate_piece")});let ns=e.dropBtn,ss=null;function Ti(){Nt.state==="playing"&&(Nt.applyCommand("move_down"),ss=setInterval(()=>{if(Nt.state!=="playing"){os();return}Nt.applyCommand("move_down")},Ct))}function os(){ss&&(clearInterval(ss),ss=null)}ns.addEventListener("pointerdown",t=>{t.preventDefault(),Ti()}),ns.addEventListener("pointerup",os),ns.addEventListener("pointerleave",os),ns.addEventListener("pointercancel",os);for(let[t,o]of Object.entries(mn))o.addEventListener("click",()=>{Nt.state==="playing"&&De()&&Nt.applyCommand("select_magic",{element:t})});Yt&&Yt.addEventListener("click",()=>{if(Nt.state!=="playing"||!Kn()||!De())return;let t=lt.active??Cn;if(!t)return;let o=fs[t];!o||!Xn(o)||(pe.selectSpell(o),lt.active&&(Cn=lt.active,Yn=!0,lt.deactivate()),sn.handleSpellButtonClick())});let ys=e.soundsToggle,Ss=e.musicToggle;function hn(){let t=A.getSettings();t.soundsEnabled?ys.classList.add("active"):ys.classList.remove("active"),t.musicEnabled?Ss.classList.add("active"):Ss.classList.remove("active");for(let o=0;o<=4;o++){let d=e.soundVolBtns[o],S=e.musicVolBtns[o];d&&d.classList.toggle("active",t.soundVolume===o),S&&S.classList.toggle("active",t.musicVolume===o)}}let zs=e.tabBtns,_i=e.tabContents;zs.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;zs.forEach(d=>d.classList.remove("active")),_i.forEach(d=>d.classList.remove("active")),t.classList.add("active"),_o(o).classList.add("active"),o==="sounds"&&hn()})});let js=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,Qs=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Li=e.iosHint,Bi=e.standaloneBadge;function Zs(){let t=document.fullscreenElement||document.webkitFullscreenElement;C.textContent=t?"Disable":"Enable"}js&&(Qs?(Bi.style.display="block",C.style.display="none"):(Li.style.display="block",C.textContent="Not supported",C.style.opacity="0.5",C.style.cursor="default")),C.addEventListener("click",()=>{if(js&&!Qs)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",Zs),document.addEventListener("webkitfullscreenchange",Zs);let is=e.invertSwipeToggle,rn=e.hapticsToggle;_.invertSwipe&&is.classList.add("active"),rn&&(Et.supports()?_.hapticsEnabled&&rn.classList.add("active"):(rn.classList.add("disabled"),rn.classList.remove("active"),_.hapticsEnabled=!1,Et.setEnabled(!1),b.saveGameSettings(_))),is.addEventListener("click",()=>{is.classList.toggle("active");let t=is.classList.contains("active");Te.rotDir=t?-1:1,_.invertSwipe=t,b.saveGameSettings(_)}),rn&&rn.addEventListener("click",()=>{if(rn.classList.contains("disabled"))return;rn.classList.toggle("active");let t=rn.classList.contains("active");_.hapticsEnabled=t,b.saveGameSettings(_),Et.setEnabled(t)}),ys.addEventListener("click",()=>{let o=!A.getSettings().soundsEnabled;A.updateSettings({soundsEnabled:o}),hn(),Nn()}),Ss.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),hn(),Nn(),$t!=="paused"&&(o?$t==="playing"?A.startGameMusic():A.startMenuMusic():A.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({soundVolume:t}),hn(),A.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{A.updateSettings({musicVolume:t}),hn()})}hn();function Js(){$t==="playing"&&(_t.pause(),ln=performance.now(),$t="paused",A.musicAudio&&A.musicAudio.pause())}function cs(){$t==="paused"&&(_t.resume(),vn+=performance.now()-ln,ln=0,$t="playing",Ms=performance.now(),A.getSettings().musicEnabled&&A.startGameMusic())}function Nn(){let t=A.getSettings();Ie.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Ie.classList.toggle("off",!t.soundsEnabled),Be.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",Be.classList.toggle("off",!t.musicEnabled)}function Ri(){ve.classList.remove("hidden"),he.classList.add("hidden");let t=b.loadHighscore(Rt);if(tn.textContent=t.score?t.score.toLocaleString():"0",yn.textContent=t.time?us(t.time):"0:00",en.textContent=Rt==="30_24"?"High Tower":"Quick Tower",Jt.textContent=Xt.toLocaleString(),fn.textContent=us(Ye),Pe.textContent=Rt==="30_24"?"High Tower":"Quick Tower",Nn(),oo){let o=Rt==="30_24";oo.style.display=o?"":"none",o&&Ls()}}function Gn(){ve.classList.add("hidden"),he.classList.remove("hidden")}he.addEventListener("click",()=>{Js(),Ri()}),ze.addEventListener("click",()=>{Gn(),cs()});let Es=null;function to(t,o){gn.textContent=t,Es=o,Re.classList.remove("hidden")}function eo(){Re.classList.add("hidden"),Es=null}ue.addEventListener("click",()=>{eo()}),Sn.addEventListener("click",()=>{let t=Es;eo(),t&&t()}),Se.addEventListener("click",()=>{to("Restart game?",()=>{Gn(),Nt.applyCommand("start_game")})}),me.addEventListener("click",()=>{to("Exit to menu?",()=>{Gn(),he.classList.add("hidden"),$t="intro",_t.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),Fn()})}),Ve.addEventListener("click",()=>{ie.classList.remove("hidden")}),Ie.addEventListener("click",()=>{let t=A.getSettings();A.updateSettings({soundsEnabled:!t.soundsEnabled}),Nn(),hn()}),Be.addEventListener("click",()=>{let o=!A.getSettings().musicEnabled;A.updateSettings({musicEnabled:o}),Nn(),hn()}),ve.addEventListener("click",t=>{t.target===ve&&(Gn(),cs())}),document.addEventListener("keydown",t=>{$t==="paused"&&!ve.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Gn(),cs())}),ke.addEventListener("click",()=>{ie.classList.add("hidden")}),ie.addEventListener("click",t=>{t.target===ie&&ie.classList.add("hidden")});let bs=!1;document.addEventListener("visibilitychange",()=>{document.hidden?$t==="playing"&&(Js(),bs=!0):bs&&$t==="paused"&&(cs(),bs=!1)});let Nt=Vo({getN:()=>i,getH:()=>s,FALL_INTERVAL:wt,LOCK_DELAY_SEC:At,getKillRate:f,MATCH_HIGHLIGHT_SEC:ye,MAGIC_SHRINK_SEC:et,RING_HIGHLIGHT_SEC:nt,getState:()=>({gameState:$t,score:Xt,elapsedMs:Ye,startTime:an,totalPausedMs:vn,stats:mt,activePiece:y,pieceY:kt,targetRot:Xe,rotFloat:Kt,rotVel:zt,isGrounded:O,isHighlighting:Qe,isMagicAnimation:pn,isRingAnimation:Ln,highlightStartTime:Hn,killLevel:ae,grid:G,fallTimer:T,lockTimer:It}),setState:t=>{"elapsedMs"in t&&(Ye=t.elapsedMs),"killLevel"in t&&(ae=t.killLevel),"fallTimer"in t&&(T=t.fallTimer),"lockTimer"in t&&(It=t.lockTimer),"targetRot"in t&&(Xe=t.targetRot),"rotFloat"in t&&(Kt=t.rotFloat),"rotVel"in t&&(zt=t.rotVel)},funcs:{startGame:vi,endGame:vs,rotatePieceByDir:mi,tryMoveDown:Ci,canPlaceAtRot:Xs,maybeResetLockDelay:Ys,shootMagic:ri,selectMagic:qo,updateGroundedState:hi,lockPiece:Mi,finishHighlight:gi,finishRingHighlight:bi},ui:{updateTimeHud:hs,updateRemainingHud:Ws}}),Rn=Ko({canvas:n,canvasCtx:c,getN:()=>i,getH:()=>s,TOP_PAD_PX:p,BOTTOM_PAD_PX:M,SIDE_MARGIN_PX:P,MAX_RADIUS_X:I,RADIUS_X_FACTOR:H,ANG_OFFSET:u,MATCH_HIGHLIGHT_SEC:ye,MATCH_SHRINK_PHASE:j,MAGIC_SHRINK_SEC:et,RING_HIGHLIGHT_SEC:nt,LOCK_DELAY_SEC:At,getKillRate:f,ELEMENT_COLORS:ee,ELEMENT_TO_COLOR:Vt,BLOCK_COLOR_FRONT:ot,BLOCK_COLOR_BACK:gt,ACTIVE_COLOR_FRONT:re,GHOST_COLOR_FILL:J,GHOST_COLOR_STROKE:U,GHOST_STROKE_WIDTH:ht,MAGIC_DIM_DOT_ALPHA:Tt,MAGIC_DIM_DOT_SCALE:Gt,MAGIC_TARGET_DOT_SCALE:ge,getState:()=>({gameState:$t,grid:G,activePiece:y,pieceY:kt,rotFloat:Kt,killLevel:ae,isHighlighting:Qe,highlightedCells:on,highlightStartTime:Hn,isMagicAnimation:pn,isRingAnimation:Ln,isGrounded:O,lockTimer:It,spellState:sn.getRenderState()}),getVisualSettings:()=>({waterBubbles:Zt,waterColor:Ut}),funcs:{snappedRot:Jn,computeGhostY:pi,normSector:Zn,getMagicTargetColor:()=>De()&&lt.canUse()?Vt[lt.active]:null,getTransmuteAnimState:t=>sn.getTransmuteAnimState(t),getLightningAnimState:t=>sn.getLightningAnimState(t),getFireAnimState:t=>sn.getFireAnimState(t)}}),Ms=performance.now();function no(t){let o=Math.min(.05,Math.max(.001,(t-Ms)/1e3));if(Ms=t,Nt.update(o,t),sn.update(t),Ft>0){let d=Math.min(Ft,Ue*o);ae=Math.max(0,ae-d),Ft-=d}Kt=Xe,Kt>1e6&&(Kt%=i),Kt<-1e6&&(Kt%=i),Rn.render(o,t),requestAnimationFrame(no)}E.addEventListener("click",()=>{Nt.applyCommand("start_game")}),yt.addEventListener("click",()=>{Nt.applyCommand("start_game")}),Lt.addEventListener("click",()=>{$t="intro",_t.reset(),A.stopMusic(),A.getSettings().musicEnabled&&A.startMenuMusic(),Fn()}),Ke.forEach(t=>{t.addEventListener("click",o=>{Ke.forEach(S=>S.classList.remove("active")),t.classList.add("active"),Rt=t.dataset.mode,qn(),Vn();let d=b.loadHighscore(Rt);d.score>0?(dt.textContent=d.score.toLocaleString(),Bt.textContent=bn(d.time)):(dt.textContent="0",Bt.textContent="0:00"),E.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>E.classList.add("idlePulse"),2e3)})});let xs=document.querySelectorAll(".spell-select-btn"),Cs=document.getElementById("spellDesc"),wi=document.getElementById("spellProgressFill"),so=document.getElementById("spellProgressMarkers"),oo=document.getElementById("pauseSpellProgress"),Ai=document.getElementById("pauseSpellProgressFill"),io=document.getElementById("pauseSpellProgressMarkers"),co=document.getElementById("pauseSpellProgressLabel");function Ts(){return jo.map(t=>Pn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function _s(t){return t.length?Math.max(...t):0}function Ii(t){let o=Ts(),d=_s(o);return d<=0?"":`${Math.min(t,d)}/${d}`}function ro(t){if(!t)return;t.innerHTML="";let o=Ts(),d=_s(o);o.forEach(S=>{let N=document.createElement("span");N.className="marker",N.dataset.threshold=S;let it=d>0?S/d*100:0;N.style.left=`${it}%`,t.appendChild(N)})}function ao(t,o){if(!t)return;let d=Pi(o);t.style.width=`${d}%`}function lo(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(S=>{let N=parseInt(S.dataset.threshold,10)||0;S.classList.toggle("reached",o>=N)})}function Pi(t){let o=Ts(),d=_s(o);return t<=0||d<=0?0:t>=d?100:t/d*100}function uo(t){if(!Cs)return;let o=Pn(t),d=pe.getDescription(t);o===0||le>=o?Cs.innerHTML=d:Cs.innerHTML=`${d} <span class="spell-progress-text">${le}/${o}</span>`}function Ls(){le=b.loadHighTowerRings(),xs.forEach(o=>{let d=o.dataset.spell,S=Pn(d),N=le>=S;o.classList.toggle("locked",!N);let it=o.querySelector(".spell-lock");it&&(it.style.display=N?"none":"")}),ao(wi,le),ao(Ai,le),lo(so,le),lo(io,le),co&&(co.textContent=Ii(le));let t=document.querySelector(".spell-select-btn.active");t&&uo(t.dataset.spell)}ro(so),ro(io),Ls(),xs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let d=document.querySelector('.mode-btn[data-mode="30_24"]');if(d&&!d.classList.contains("active")){Ke.forEach(ce=>ce.classList.remove("active")),d.classList.add("active"),Rt="30_24",qn(),Vn();let pt=b.loadHighscore(Rt);pt.score>0?(dt.textContent=pt.score.toLocaleString(),Bt.textContent=bn(pt.time)):(dt.textContent="0",Bt.textContent="0:00")}let S=t.dataset.spell,N=Pn(S),it=le>=N;uo(S),it&&(xs.forEach(pt=>pt.classList.remove("active")),t.classList.add("active"),pe.selectSpell(S),kn(lt.active))})}),En.addEventListener("click",()=>{let t=b.loadHighscore("30_24"),o=b.loadHighscore("25_20"),d=`Records

`;d+=`High Tower (30\xD724):
`,d+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${bn(t.time)}
`:`  No record yet
`,d+=`
Quick Tower (25\xD720):
`,d+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${bn(o.time)}
`:`  No record yet
`,alert(d)}),Ee.addEventListener("click",()=>{ie.classList.remove("hidden")}),In(),Vn(),qn(),Fn(),A.startMenuMusic();let ki=()=>{if(A.unlock(),!A.getSettings().musicEnabled)return;let t=A.musicAudio;!t||t.paused||t.ended?Nt.state==="playing"?A.startGameMusic():A.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},fo=0,Oi=10,Di=()=>{fo>=Oi||(fo++,ki())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Di,{passive:!0})}),requestAnimationFrame(no)})();})();
