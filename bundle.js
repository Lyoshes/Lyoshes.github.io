(()=>{var ys=[0,.25,.5,.75,1],Es=[0,.05,.15,.25,.5],Ss={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.mp3",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav"},go={menu:"music/mm.mp3",game:"sounds/amb1.wav"},fo="soundSettings";function Ms(){try{let e=localStorage.getItem(fo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function xs(e){try{localStorage.setItem(fo,JSON.stringify(e))}catch(o){console.debug("Failed to save sound settings:",o)}}function po(){return{audioContext:null,buffers:{},settings:Ms(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let o=window.AudioContext||window.webkitAudioContext;this.audioContext=new o,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(o){console.debug("Failed to create AudioContext:",o)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(o){console.debug("Failed to resume AudioContext:",o)}if(!this.unlocked&&this.audioContext.state==="running"){let o=this.audioContext.createBuffer(1,1,22050),a=this.audioContext.createBufferSource();a.buffer=o,a.connect(this.audioContext.destination),a.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return ys[this.settings.soundVolume]},getMusicVolume(){return Es[this.settings.musicVolume]},async loadSound(o,a){if(this.audioContext||this.initContext(),!!this.audioContext)try{let s=await(await fetch(a)).arrayBuffer(),n=await this.audioContext.decodeAudioData(s);this.buffers[o]=n}catch(u){console.debug(`Failed to load sound: ${o} from ${a}`,u)}},preload(){this.initContext();for(let[o,a]of Object.entries(Ss))this.loadSound(o,a)},play(o,a=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let u=o;a!==null&&(u=`${o}${a}`);let s=this.buffers[u];if(s)try{let n=this.audioContext.createGain();n.gain.value=this.getSoundVolume(),n.connect(this.audioContext.destination);let i=this.audioContext.createBufferSource();i.buffer=s,i.connect(n),i.start(0),i.onended=()=>{i.disconnect(),n.disconnect()}}catch(n){console.debug("Sound play failed:",n)}},playRandom(o){if(!this.settings.soundsEnabled)return;let a=1+Math.floor(Math.random()*3);this.play(o,a)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(go.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Menu music started")}).catch(a=>{console.debug("Menu music autoplay blocked:",a)})}catch(o){console.debug("Menu music start failed:",o)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(go.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let o=this.musicAudio.play();o!==void 0&&o.then(()=>{console.debug("Game music started")}).catch(a=>{console.debug("Game music play failed:",a)})}catch(o){console.debug("Game music start failed:",o)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(o){console.debug("Stop music failed:",o)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(o){if(this.settings={...this.settings,...o},xs(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(a=>{console.debug("Music resume failed:",a)}):this.stopMusic()}catch(a){console.debug("Update music settings failed:",a)}},getSettings(){return{...this.settings}}}}var ho="eb_highscore",yo="eb_highscore_quick",Eo="eb_settings",vs={invertSwipe:!1,difficulty:"easy"};function So(){return{loadHighscore(e="30_24"){try{let o=e==="25_20"?yo:ho,a=localStorage.getItem(o);if(a)return JSON.parse(a)}catch(o){console.debug("Failed to load highscore:",o)}return{score:0,time:0}},saveHighscore(e,o,a="30_24"){try{let u=this.loadHighscore(a);if(e>u.score||e===u.score&&o>u.time){let s=a==="25_20"?yo:ho;return localStorage.setItem(s,JSON.stringify({score:e,time:o})),!0}}catch(u){console.debug("Failed to save highscore:",u)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Eo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...vs}},saveGameSettings(e){try{localStorage.setItem(Eo,JSON.stringify(e))}catch(o){console.debug("Failed to save game settings:",o)}}}}function Mo(){return{canvas:document.getElementById("c"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestExtra:document.getElementById("bestExtra"),surviveVal:document.getElementById("surviveVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),diffBtns:document.querySelectorAll(".diff-btn"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function xo(e){return document.getElementById("tab-"+e)}var Cs={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function vo(e={}){let{elementColors:o={}}=e,a=0;return{showBonus(u,s="score",n=null){let i=document.createElement("div");i.className=`bonus-popup ${s}`,i.textContent=u,n&&o[n]&&(i.style.color=o[n]);let l=window.innerWidth/2,m=window.innerHeight/2-40,p=(Math.random()-.5)*200,f=(Math.random()-.5)*100+a*36;i.style.left=`${l+p}px`,i.style.top=`${m+f}px`,i.style.transform="translate(-50%, -50%)",document.body.appendChild(i),a++,setTimeout(()=>{a=Math.max(0,a-1)},200),setTimeout(()=>{i.remove()},1800)},getElementIcon(u){return Cs[u]||"\u2726"}}}var Co={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function _o(){return{spawnMagicOrb(e,o,a,u){if(!u)return;let s=document.createElement("div");s.className=`magic-orb ${e}`,s.textContent=Co[e]||"\u2726";let n=u.getBoundingClientRect(),i=n.left+n.width/2-o,l=n.top+n.height/2-a,m=Math.hypot(i,l),p=Math.atan2(l,i),f=m*.35*(Math.random()>.5?1:-1),y=p+Math.PI/2,B=i*.5+Math.cos(y)*f,P=l*.5+Math.sin(y)*f;s.style.setProperty("--mid-x",`${B}px`),s.style.setProperty("--mid-y",`${P}px`),s.style.setProperty("--end-x",`${i}px`),s.style.setProperty("--end-y",`${l}px`),s.style.left=`${o}px`,s.style.top=`${a}px`,document.body.appendChild(s),setTimeout(()=>{s.remove(),u&&(u.classList.remove("pulse"),u.offsetWidth,u.classList.add("pulse"),setTimeout(()=>u.classList.remove("pulse"),400))},700)},spawnMagicShot(e,o,a,u,s){if(!o){s&&s();return}let n=o.getBoundingClientRect(),i=n.left+n.width/2,l=n.top+n.height/2,m=document.createElement("div");m.className=`magic-shot ${e}`,m.textContent=Co[e]||"\u2726";let p=a-i,f=u-l;m.style.setProperty("--end-x",`${p}px`),m.style.setProperty("--end-y",`${f}px`),m.style.left=`${i}px`,m.style.top=`${l}px`,document.body.appendChild(m);let y=setInterval(()=>{let B=m.getBoundingClientRect();this.spawnTrailParticle(e,B.left+B.width/2,B.top+B.height/2)},40);setTimeout(()=>{clearInterval(y),m.remove(),this.spawnExplosion(e,a,u),s&&s()},300)},spawnTrailParticle(e,o,a){let u=document.createElement("div");u.className=`magic-trail ${e}`,u.style.left=`${o}px`,u.style.top=`${a}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),400)},spawnExplosion(e,o,a){for(let s=0;s<12;s++){let n=document.createElement("div");n.className=`magic-explosion ${e}`;let i=s/12*Math.PI*2+(Math.random()-.5)*.5,l=40+Math.random()*40,m=Math.cos(i)*l,p=Math.sin(i)*l;n.style.setProperty("--px",`${m}px`),n.style.setProperty("--py",`${p}px`),n.style.left=`${o}px`,n.style.top=`${a}px`,document.body.appendChild(n),setTimeout(()=>n.remove(),500)}}}}function bo(e={}){let{buttons:o={},onActivate:a=null}=e,u={fire:3,water:3,lightning:3,earth:3},s=null;function n(){for(let[i,l]of Object.entries(o)){if(!l)continue;let m=u[i],p=l.querySelector(".charges");p&&(p.textContent=m),l.classList.toggle("empty",m<=0),l.classList.toggle("active",s===i&&m>0)}}return{get charges(){return u},get active(){return s},set active(i){s=i},select(i){if(u[i]<=0)return!1;let l=s===i;return s=l?null:i,n(),!l&&s===i&&a&&a(),!l},useCharge(){return!s||u[s]<=0?!1:(u[s]--,s=null,n(),!0)},addCharges(i,l){u[i]!==void 0&&(u[i]+=l,n())},canUse(){return s!==null&&u[s]>0},deactivate(){s=null,n()},reset(){u.fire=3,u.water=3,u.lightning=3,u.earth=3,s=null,n()},updateButtons:n,initButtons(i){for(let[l,m]of Object.entries(o))m&&m.addEventListener("click",()=>{i&&i(l)})}}}var _s={PX_PER_STEP:16,DEADZONE_PX:6,PX_PER_DROP:18,AXIS_DOMINANCE:1.3,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:22,MIN_ROT_PX:3,MAX_ROT_PX:22,DROP_SWIPE_MIN_SPEED:700,DROP_SWIPE_MIN_DISTANCE:25,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function To(e={}){let{canvas:o}=e,a=e.rotDir||1,u=!1,s=0,n=0,i=0,l=0,m=0,p=1,f=null,y=0,B=0,P=0,z=0,F=0,Q=0,Et=0,jt=0,Z=_s;return{get rotDir(){return a},set rotDir(A){a=A},get dragging(){return u},get dragMode(){return f},handlePointerDown(A,rt,ce){if(rt.onMagicTap&&rt.onMagicTap(A.clientX,A.clientY))return!0;let te=performance.now(),Dt=te-Q,kt=A.clientX-Et,Gt=A.clientY-jt,ae=Math.hypot(kt,Gt);return Dt<=Z.DOUBLE_TAP_MS&&ae<=Z.DOUBLE_TAP_MAX_DIST?(rt.onDoubleTap&&rt.onDoubleTap(),Q=0):(Q=te,Et=A.clientX,jt=A.clientY),u=!0,p=-1,s=A.clientX,n=A.clientY,i=ce,l=0,m=0,f=null,y=te,B=A.clientX,P=A.clientY,z=y,F=0,o&&o.setPointerCapture(A.pointerId),!1},handlePointerMove(A,rt,ce,te){if(!u)return null;let Dt=A.clientX-s,kt=A.clientY-n,Gt=performance.now();if(Math.abs(Dt)<Z.DEADZONE_PX&&Math.abs(kt)<Z.DEADZONE_PX)return null;if(!f){let Rt=Math.abs(Dt),xt=Math.abs(kt);if(kt<0)Rt>=Z.DEADZONE_PX&&(f="rotate");else if(xt>=Rt*Z.AXIS_DOMINANCE){if(xt>=Z.DROP_SWIPE_MIN_DISTANCE){let Ct=Math.max(1,Gt-y);xt/Ct*1e3>=Z.DROP_SWIPE_MIN_SPEED?f="drop":f="rotate"}}else Rt>=xt*Z.AXIS_DOMINANCE&&(f="rotate");if(!f)return null}let ae=null;if(f==="rotate"&&Math.abs(Dt)>=Z.DEADZONE_PX){let Rt=Math.max(1,Gt-z),xt=A.clientX-B,Ct=Math.max(1,Math.abs(xt)/Rt*1e3),d=Math.max(Z.MIN_ROT_PX,Math.min(Z.MAX_ROT_PX,Z.PX_PER_STEP*(Z.SWIPE_SPEED_REF/Ct)));F+=-xt/d*a*p;let V=Math.trunc(F);V!==0&&(F-=V);let ct=l+V;if(ct!==l&&rt.canRotateTo){let ee=Math.sign(ct-l),It=i+l;for(;l!==ct;){let fe=l+ee,Me=i+fe;if(!rt.canRotateTo(Math.floor(ce),Me))break;l=fe,It=Me,te&&rt.onGroundedMove&&rt.onGroundedMove()}ae={targetRot:It,rotFloat:It}}}if(f==="drop"&&kt>Z.DEADZONE_PX&&rt.onDrop){let Rt=Math.max(1,Gt-z),xt=A.clientY-P,Ct=Math.max(1,xt/Rt*1e3),d=Math.max(Z.MIN_DROP_PX,Math.min(Z.MAX_DROP_PX,Z.PX_PER_DROP*(Z.SWIPE_SPEED_REF/Ct))),V=Math.trunc(kt/d);if(V>m){let ct=V-m;for(let ee=0;ee<ct;ee++)rt.onDrop();m=V}}return B=A.clientX,P=A.clientY,z=Gt,ae},handlePointerUp(A){if(u&&(u=!1,f=null,o&&A&&A.pointerId!==void 0))try{o.releasePointerCapture(A.pointerId)}catch{}},reset(){u=!1,f=null,l=0,m=0,F=0}}}var Hn={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Lo(){let e="intro",o=0,a=0,u=0,s=0,n=0,i={...Hn};return{get state(){return e},get score(){return o},get elapsedMs(){return u},get startTime(){return a},get stats(){return i},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",o=0,a=performance.now(),u=0,s=0,n=0,i={...Hn}},pause(){return e!=="playing"?!1:(e="paused",s=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",s>0&&(n+=performance.now()-s,s=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(l){o+=l},setScore(l){o=l},updateTime(){e==="playing"&&a>0&&(u=performance.now()-a-n)},getFormattedTime(){let l=Math.floor(u/1e3),m=Math.floor(l/60),p=l%60;return`${m}:${p.toString().padStart(2,"0")}`},incrementStat(l,m=1){l in i&&(i[l]+=m)},updateMaxStat(l,m){l in i&&m>i[l]&&(i[l]=m)},reset(){e="intro",o=0,a=0,u=0,s=0,n=0,i={...Hn}}}}function Be(e,o){return e%=o,e<0&&(e+=o),e}function Bo(e,o){return e[Math.min(o,e.length-1)]}function fn(e){let o=Math.max(0,Math.floor(e/1e3)),a=Math.floor(o/60),u=o%60;return`${a}:${u.toString().padStart(2,"0")}`}function Ro(e,o){let a=e.map(({x:l,y:m},p)=>({x:m,y:-l,color:o[p]})),u=1/0,s=-1/0,n=1/0;for(let l of a)u=Math.min(u,l.x),s=Math.max(s,l.x),n=Math.min(n,l.y);let i=Math.round((u+s)/2);for(let l of a)l.x-=i,l.y-=n;return a.sort((l,m)=>l.y-m.y||l.x-m.x),{cells:a.map(l=>({x:l.x,y:l.y})),colors:a.map(l=>l.color)}}function $n(e,o,a,u){let s=[];return e+1<a&&s.push({y:e+1,s:o}),e-1>=0&&s.push({y:e-1,s:o}),s.push({y:e,s:Be(o-1,u)}),s.push({y:e,s:Be(o+1,u)}),s}function Io(e,o,a){let u=Array.from({length:o},()=>new Uint8Array(a)),s=[];for(let n=0;n<o;n++)for(let i=0;i<a;i++){if(!e[n][i]||u[n][i])continue;let l=[],m=[{y:n,s:i}];for(u[n][i]=1;m.length>0;){let p=m.shift();l.push(p);for(let f of $n(p.y,p.s,o,a))e[f.y][f.s]&&!u[f.y][f.s]&&(u[f.y][f.s]=1,m.push(f))}s.push(l)}return s}function Ao(e){return e.some(o=>o.y===0)}function Nn(e,o,a,u,s,n){if(!e)return!1;let i=Be(a,n);for(let l of e.cells){let m=o+l.y,p=Be(i+l.x,n);if(m<0)return!1;if(!(m>=s)&&u[m][p])return!1}return!0}function wo(e,o,a,u,s,n){if(!e)return null;let i=Math.floor(o);for(;Nn(e,i-1,a,u,s,n);)i-=1;return i}function Po(e,o,a){let u=[],s=[];for(let n=0;n<o;n++){let i=[],l=0,m=e[n][0],p=m?1:0;for(let f=1;f<=a;f++){let y=f<a?e[n][f]:0;y&&y===m?p++:(p>=1&&m&&i.push({start:l,length:p,color:m}),l=f,m=y,p=y?1:0)}if(i.length>=2){let f=i[0],y=i[i.length-1];if(f.start===0&&y.start+y.length===a&&f.color===y.color){let B=f.length+y.length;i[0]={start:y.start,length:B,color:f.color},i.pop()}}for(let f of i)if(f.length>=3){let y=[];for(let B=0;B<f.length;B++)y.push({y:n,s:(f.start+B)%a});u.push({color:f.color,length:f.length,cells:y})}}for(let n=0;n<a;n++){let i=0,l=e[0][n],m=l?1:0;for(let p=1;p<=o;p++){let f=p<o?e[p][n]:0;if(f&&f===l)m++;else{if(m>=3&&l){let y=[];for(let B=0;B<m;B++)y.push({y:i+B,s:n});u.push({color:l,length:m,cells:y})}i=p,l=f,m=f?1:0}}}for(let n=0;n<o;n++)for(let i=0;i<a;i++){let l=e[n][i],m=e[n][(i+1)%a],p=e[n][(i+2)%a],f=e[n][(i+3)%a];l&&l===m&&p&&p===f&&l!==p&&s.push({cells:[{y:n,s:i},{y:n,s:(i+1)%a},{y:n,s:(i+2)%a},{y:n,s:(i+3)%a}]})}for(let n=0;n<a;n++)for(let i=0;i<o-3;i++){let l=e[i][n],m=e[i+1][n],p=e[i+2][n],f=e[i+3][n];l&&l===m&&p&&p===f&&l!==p&&s.push({cells:[{y:i,s:n},{y:i+1,s:n},{y:i+2,s:n},{y:i+3,s:n}]})}return{lineMatches:u,pairMatches:s}}function Oo(e,o,a){let u=[];for(let s=0;s<o;s++){let n=!0;for(let i=0;i<a;i++)if(!e[s][i]){n=!1;break}n&&u.push(s)}return u}function Do(e,o){let a=new Map;e.forEach((u,s)=>a.set(`${u.x},${u.y}`,o[s]));for(let u=0;u<e.length;u++){let s=e[u],n=o[u],i=1;for(let Q=1;Q<=2&&a.get(`${s.x+Q},${s.y}`)===n;Q++)i++;if(i>=3)return!0;let l=1;for(let Q=1;Q<=2&&a.get(`${s.x},${s.y+Q}`)===n;Q++)l++;if(l>=3)return!0;let m=n,p=a.get(`${s.x+1},${s.y}`),f=a.get(`${s.x+2},${s.y}`),y=a.get(`${s.x+3},${s.y}`);if(m&&p&&f&&y&&m===p&&f===y&&m!==f)return!0;let B=n,P=a.get(`${s.x},${s.y+1}`),z=a.get(`${s.x},${s.y+2}`),F=a.get(`${s.x},${s.y+3}`);if(B&&P&&z&&F&&B===P&&z===F&&B!==z)return!0}return!1}function ko(e){let{getN:o,getH:a,FALL_INTERVAL:u,LOCK_DELAY_SEC:s,getKillRate:n,MATCH_HIGHLIGHT_SEC:i,MAGIC_SHRINK_SEC:l,RING_HIGHLIGHT_SEC:m,getState:p,setState:f,funcs:y,ui:B}=e;return{get state(){return p().gameState},get score(){return p().score},get elapsedMs(){return p().elapsedMs},get stats(){return p().stats},get activePiece(){return p().activePiece},get pieceY(){return p().pieceY},get targetRot(){return p().targetRot},get isGrounded(){return p().isGrounded},get isHighlighting(){return p().isHighlighting},get killLevel(){return p().killLevel},get grid(){return p().grid},applyCommand(P,z={}){let F=p();if(P==="start_game")return F.gameState!=="playing"?(y.startGame(),!0):!1;if(F.gameState!=="playing")return!1;switch(P){case"rotate_piece":return y.rotatePieceByDir(),!0;case"move_down":return y.tryMoveDown();case"rotate_cylinder":{let{rot:Q}=z;return typeof Q=="number"&&y.canPlaceAtRot(Math.floor(F.pieceY),Q)?(f({targetRot:Q,rotFloat:Q,rotVel:0}),F.isGrounded&&y.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:Q,y:Et}=z;return y.shootMagic(Q,Et)}case"select_magic":{let{element:Q}=z;return y.selectMagic(Q),!0}default:return console.warn("GameEngine: unknown command",P),!1}},update(P,z){let F=p();if(F.gameState!=="playing")return;let Q=z-F.startTime-F.totalPausedMs;f({elapsedMs:Q}),B.updateTimeHud();let Et=F.killLevel+n()*P;if(f({killLevel:Et}),B.updateRemainingHud(),Et>=a()){y.endGame();return}if(F.isHighlighting){let A=(z-F.highlightStartTime)/1e3,rt;F.isRingAnimation?rt=m:F.isMagicAnimation?rt=l:rt=i,A>=rt&&(F.isRingAnimation?y.finishRingHighlight():y.finishHighlight())}let jt=F.fallTimer+P;if(jt>=u&&(jt-=u,y.tryMoveDown()),f({fallTimer:jt}),y.updateGroundedState()){let A=F.lockTimer+P;f({lockTimer:A}),A>=s&&y.lockPiece()}},reset(){y.startGame()},canRotateTo(P,z){return y.canPlaceAtRot(P,z)},getRotation(){let P=p();return{targetRot:P.targetRot,rotFloat:P.rotFloat,rotVel:P.rotVel}},setRotation(P){f({targetRot:P,rotFloat:P,rotVel:0})},onGroundedMove(){y.maybeResetLockDelay()}}}var Xt=Math.PI*2;function Go(e){let{canvas:o,canvasCtx:a,getN:u,getH:s,TOP_PAD_PX:n,BOTTOM_PAD_PX:i,SIDE_MARGIN_PX:l,MAX_RADIUS_X:m,RADIUS_X_FACTOR:p,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:y,MATCH_SHRINK_PHASE:B,MAGIC_SHRINK_SEC:P,RING_HIGHLIGHT_SEC:z,LOCK_DELAY_SEC:F,getKillRate:Q,ELEMENT_COLORS:Et,ELEMENT_TO_COLOR:jt,BLOCK_COLOR_FRONT:Z,BLOCK_COLOR_BACK:A,ACTIVE_COLOR_FRONT:rt,GHOST_COLOR_FILL:ce,GHOST_COLOR_STROKE:te,GHOST_STROKE_WIDTH:Dt,MAGIC_DIM_DOT_ALPHA:kt,MAGIC_DIM_DOT_SCALE:Gt,MAGIC_TARGET_DOT_SCALE:ae,getState:Rt,getVisualSettings:xt,funcs:Ct}=e,d=a,V=u(),ct=s(),ee={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},It=[],fe=15,Me=2;function Ve(T,_,S,L,v,w,M){for(It=It.filter(b=>b.y>T+b.size);It.length<fe;){let b=Math.random()>.5?"left":"right",g=10,C=b==="left"?g+Math.random()*(_-g*2):S+g+Math.random()*(v-S-g*2),R=L+20+Math.random()*100;It.push({x:C,baseX:C,y:R,size:1.5+Math.random()*3,speedFactor:.9+Math.random()*.2,wobble:Math.random()*Math.PI*2,wobbleSpeed:.4+Math.random()*.4,wobbleAmp:3+Math.random()*4,side:b,minX:b==="left"?g:S+g,maxX:b==="left"?_-g:v-g})}let U=w*Me;for(let b of It){b.y-=U*b.speedFactor*M,b.wobble+=b.wobbleSpeed*M;let g=b.baseX+Math.sin(b.wobble)*b.wobbleAmp;b.x=Math.max(b.minX,Math.min(b.maxX,g))}}function pn(T){d.fillStyle="rgba(255, 255, 255, 0.25)",d.strokeStyle="rgba(255, 255, 255, 0.4)",d.lineWidth=1;for(let _ of It)_.y<T+_.size||(d.beginPath(),d.arc(_.x,_.y,_.size,0,Math.PI*2),d.fill(),d.stroke())}function Vt(T,_,S){let L=1-S/ct;return T+L*_}function xe(T){return T=T%V,T<0?T+V:T}function ve(T,_,S,L,v,w){let M=xe(w),U=(v-M)/V*Xt+f;return{x:T+Math.cos(U)*S,y:_+Math.sin(U)*L,ang:U}}let Ye=.52,hn=1.02;function Ht(T,_,S,L,v,w){let M=xe(w),U=(v-M)/V*Xt+f;return{x:T+Math.cos(U)*S,y:_+Math.sin(U)*L,ang:U}}function yn(T,_,S,L,v,w,M,U=1){let b=Ht(T,_,S,L,v-Ye,w),g=Ht(T,_,S,L,v+Ye,w),C={x:b.x,y:b.y-M*.5},R={x:b.x,y:b.y+M*.5},et={x:g.x,y:g.y-M*.5},I={x:g.x,y:g.y+M*.5},G=(C.x+et.x+I.x+R.x)*.25,X=(C.y+et.y+I.y+R.y)*.25,gt=hn*U,$t=U,nt=[C,et,I,R].map(vt=>({x:G+(vt.x-G)*gt,y:X+(vt.y-X)*$t})),ht=Math.abs((g.x-b.x)*gt),_t=Math.abs(M*$t);return{corners:nt,cx:G,cy:X,wApprox:ht,hApprox:_t,ang:Ht(T,_,S,L,v,w).ang}}function re(T,_,S,L,v,w,M,U,b=1,g=null,C=1,R=null,et=0,I=1,G=1){let X=yn(T,_,S,L,v,w,M,G),[gt,$t,nt,ht]=X.corners;if(d.save(),d.globalAlpha=b,d.fillStyle=U,d.beginPath(),d.moveTo(gt.x,gt.y),d.lineTo($t.x,$t.y),d.lineTo(nt.x,nt.y),d.lineTo(ht.x,ht.y),d.closePath(),d.fill(),R&&et>0&&(d.strokeStyle=R,d.lineWidth=et,d.stroke()),g){let _t=Math.min(X.wApprox,X.hApprox)*.28*I;d.globalAlpha=b*C,d.fillStyle=g,d.beginPath(),d.arc(X.cx,X.cy,_t,0,Xt),d.fill()}d.restore(),d.globalAlpha=1}function En(T,_,S,L,v,w){let M=ve(T,_,S,L,v,w),U=ve(T,_,S,L,v+1,w),b=ve(T,_,S,L,v-1,w),g=Math.abs(U.x-M.x),C=Math.abs(M.x-b.x),R=(g+C)*.5*1.06;return Math.max(1,R)}function Sn(T,_,S,L,v,w){let M=(v-w)/V*Xt+f;return{x:T+Math.cos(M)*S,y:_+Math.sin(M)*L,ang:M}}function Mn(T,_,S,L,v,w,M,U=1,b=null,g=1,C=null,R=0,et=1){d.save(),d.translate(T,_);let I=Math.atan2(L,S);if(d.rotate(I),d.globalAlpha=U,d.fillStyle=M,d.fillRect(-v/2,-w/2,v,w),C&&R>0&&(d.strokeStyle=C,d.lineWidth=R,d.strokeRect(-v/2,-w/2,v,w)),b){let G=Math.min(v,w)*.28*et;d.globalAlpha=U*g,d.fillStyle=b,d.beginPath(),d.arc(0,0,G,0,Xt),d.fill()}d.restore(),d.globalAlpha=1}return{resize(){let T=Math.max(1,Math.min(2,window.devicePixelRatio||1)),_=Math.floor(o.clientWidth*T),S=Math.floor(o.clientHeight*T);(o.width!==_||o.height!==S)&&(o.width=_,o.height=S,d.setTransform(T,0,0,T,0,0))},render(T=.016){this.resize();let _=Rt();V=u(),ct=s();let S=o.clientWidth,L=o.clientHeight;d.clearRect(0,0,S,L),d.fillStyle="#0b0f14",d.fillRect(0,0,S,L);let v=S*.5,w=(S-2*l)/2,M=L-n-i,U=6,b=V*M/(U*ct),g,C,R,et;et=L-i,b<=Math.min(w,m)?(g=b,C=M,R=n):(g=Math.min(w,m),C=g*U*ct/V,R=et-C);let I=g*.28,{killLevel:G,rotFloat:X,grid:gt,gameState:$t}=_,nt=xt?xt():{},ht=nt.waterColor||"blue",_t=nt.waterBubbles||!1,vt=ee[ht]||ee.blue,St=Vt(R,C,G),Re=.7,We=G/ct,h={...vt.top},ot={...vt.bottom};if(We>Re){let x=(We-Re)/(1-Re);h.r=Math.round(h.r+(255-h.r)*x*.5),h.g=Math.round(h.g+(150-h.g)*x*.5),h.b=Math.round(h.b+(150-h.b)*x*.5),ot.r=Math.round(ot.r+(180-ot.r)*x),ot.g=Math.round(ot.g*(1-x*.6)),ot.b=Math.round(ot.b*(1-x*.6))}let J=v-g-8,lt=v+g+8,Ie=R,Mt=et+5,le=d.createLinearGradient(0,St,0,L);le.addColorStop(0,`rgba(${h.r},${h.g},${h.b},0.5)`),le.addColorStop(1,`rgba(${ot.r},${ot.g},${ot.b},0.7)`),d.fillStyle=le;let Ae=Math.round((h.r+ot.r)/2),ne=Math.round((h.g+ot.g)/2),O=Math.round((h.b+ot.b)/2),Ke=g+8,pe=I+4;d.fillRect(0,St,J,L-St),d.fillRect(lt,St,S-lt,L-St),d.beginPath();let yt=Math.max(St,Mt);if(d.moveTo(J,yt),St<=Mt+pe?d.ellipse(v,Mt,Ke,pe,0,Math.PI,0,!1):d.lineTo(lt,yt),d.lineTo(lt,L),d.lineTo(J,L),d.closePath(),d.fill(),d.strokeStyle="rgba(100,180,255,0.6)",d.lineWidth=3,d.lineCap="round",d.beginPath(),d.moveTo(J,Ie),d.lineTo(J,Mt),d.stroke(),d.beginPath(),d.moveTo(lt,Ie),d.lineTo(lt,Mt),d.stroke(),d.beginPath(),d.ellipse(v,Mt,g+8,I+4,0,0,Math.PI),d.stroke(),d.fillStyle="#0b0f14",d.beginPath(),d.ellipse(v,Mt,g+8,I+4,0,0,Xt),d.fill(),G>.5&&(d.strokeStyle=`rgba(${Math.min(255,Ae+60)},${Math.min(255,ne+40)},${Math.min(255,O+40)},0.6)`,d.lineWidth=2,d.beginPath(),d.moveTo(0,St),d.lineTo(J,St),d.moveTo(lt,St),d.lineTo(S,St),d.stroke()),_t&&G>.5){let x=Q()*C/ct;Ve(St,J,lt,L,S,x,T),pn(St)}d.strokeStyle="rgba(160,190,220,0.3)",d.lineWidth=1;let we=Xt*g,Pe=10,Fn=we/Pe*.7,Un=we/Pe*.3;d.setLineDash([Fn,Un]);let ue=we/V;d.lineDashOffset=xe(X)*ue;for(let x=0;x<=ct;x++){let H=Vt(R,C,x);d.beginPath(),d.ellipse(v,H,g,I,0,0,Xt),d.stroke()}d.setLineDash([]);let qe=[],Oe=[];for(let x=0;x<ct;x++){let H=Vt(R,C,x+.5);for(let W=0;W<V;W++){let j=gt[x][W];if(!j)continue;let $=ve(v,H,g,I,W,X),ut=Math.sin($.ang),D={y:x,s:W,yScr:H,p:$,depth:ut,color:j};ut<-.1?qe.push(D):Oe.push(D)}}let ze=Ct.getMagicTargetColor(),{isHighlighting:he,highlightedCells:Yt,highlightStartTime:Qe,isMagicAnimation:Wt}=_,Nt=null,Ce=1,_e=1,Ze=!1;if(he&&Yt.length>0){Nt=new Set(Yt.map(H=>`${H.y},${H.s}`));let x=(performance.now()-Qe)/1e3;if(Wt){let H=Math.min(1,x/P);Ce=1-H*.85,_e=1-H*.9,Ze=!0}else{let H=Math.min(1,x/y),W=1-B;if(H>W){let j=(H-W)/B;Ce=1-j*.85,_e=1-j*.9,Ze=!0}}}qe.sort((x,H)=>x.depth-H.depth);for(let x of qe){let H=C/ct*.9,W=Et[x.color]||null,j=.35,$=1,ut=`${x.y},${x.s}`;Nt&&Nt.has(ut)&&(j*=_e,$=Ce),re(v,x.yScr,g,I,x.s,X,H,A,j,W,.5,null,0,1,$)}let{isRingAnimation:de}=_;if(he&&Yt.length>0&&!Wt){let x=(performance.now()-Qe)/1e3,W=Math.min(1,x/(de?z:y)),j=1-B,$=W>j,ut=$?(W-j)/B:0,D=de?Math.floor(W*j*V*2)%V:-1,K=4+W/j*10,st=Math.sin(x*K*Xt),At=$?1:.3+st*.3,at=$?1-ut*.8:1,bt=$?1-ut:1;for(let dt of Yt){let Kt=Vt(R,C,dt.y+.5),ke=Ht(v,Kt,g,I,dt.s,X);if(Math.sin(ke.ang)>=-.1)continue;let Ge=C/ct*.9,Tt,oe,qt;if(de){let ye=(dt.s-D+V)%V,Ee=ye<3?1-ye/3:0;Tt=($?bt:.2+Ee*.5)*.5,oe=`rgba(255, 159, 67, ${Tt})`,qt=$?at:1+Ee*.15}else Tt=At*bt,oe=dt.isLine?`rgba(255, 255, 255, ${Tt*.5})`:`rgba(255, 220, 100, ${Tt*.4})`,qt=$?at:1.1;re(v,Kt,g,I,dt.s,X,Ge,oe,1,null,1,null,0,1,qt)}}Oe.sort((x,H)=>x.depth-H.depth);for(let x of Oe){let H=C/ct*.9,W=Et[x.color]||null,j=1,$=1,ut=1,D=1,K=`${x.y},${x.s}`,st=Nt&&Nt.has(K);st&&(j=_e,$=Ce),ze!==null&&!st&&(x.color!==ze?(ut=kt,D=Gt):D=ae),re(v,x.yScr,g,I,x.s,X,H,Z,j,W,ut,null,0,D,$)}if(he&&Yt.length>0&&!Wt){let x=(performance.now()-Qe)/1e3,W=Math.min(1,x/(de?z:y)),j=1-B,$=W>j,ut=$?(W-j)/B:0,D=de?Math.floor(W*j*V*2)%V:-1,K=4+W/j*10,st=Math.sin(x*K*Xt),At=$?1:.5+st*.5,at=$?1-ut*.8:1,bt=$?1-ut:1;for(let dt of Yt){let Kt=Vt(R,C,dt.y+.5),ke=Ht(v,Kt,g,I,dt.s,X);if(Math.sin(ke.ang)<-.1)continue;let Ge=C/ct*.9,Tt,oe,qt;if(de){let ye=(dt.s-D+V)%V,Ee=ye<4?1-ye/4:0;Tt=$?bt:.3+Ee*.7,oe=`rgba(255, 159, 67, ${Tt})`,qt=$?at:1+Ee*.2}else Tt=At*bt,oe=dt.isLine?`rgba(255, 255, 255, ${Tt*.7})`:`rgba(255, 220, 100, ${Tt*.6})`,qt=$?at:1.15;re(v,Kt,g,I,dt.s,X,Ge,oe,1,null,1,null,0,1,qt)}}let{activePiece:Ft,pieceY:De,isGrounded:xn,lockTimer:Je}=_;if(Ft){let x=Ct.snappedRot(),H=x,W=Ct.computeGhostY(),j=C/ct*.9;if(W!==null){let D=[];for(let K=0;K<Ft.cells.length;K++){let st=Ft.cells[K],At=Ft.colors[K],at=W+st.y,bt=Ct.normSector(x+st.x);if(at<0||at>=ct)continue;let dt=Vt(R,C,at+.5),Kt=Ht(v,dt,g,I,bt,H);D.push({cy:at,cs:bt,yScr:dt,depth:Math.sin(Kt.ang),color:At})}D.sort((K,st)=>K.depth-st.depth);for(let K of D){let st=Et[K.color]||null;re(v,K.yScr,g,I,K.cs,H,j,ce,1,st,.5,te,Dt,1,1)}}let $=rt;if(xn&&Je>0){let D=Math.min(1,Je/F),K=255,st=Math.round(170+85*D),At=Math.round(180+75*D),at=.75+(1-.75)*D;$=`rgba(${K},${st},${At},${at})`}let ut=[];for(let D=0;D<Ft.cells.length;D++){let K=Ft.cells[D],st=Ft.colors[D],At=Ct.normSector(x+K.x),at=De+K.y;if(at<0||at>=ct)continue;let bt=Vt(R,C,at+.5),dt=Ht(v,bt,g,I,At,H);ut.push({cs:At,yScr:bt,depth:Math.sin(dt.ang),color:st})}ut.sort((D,K)=>D.depth-K.depth);for(let D of ut){let K=Et[D.color]||null;re(v,D.yScr,g,I,D.cs,H,j,$,1,K,1,null,0,1,1)}}},drawNextPreview(T,_){if(!T)return;let S=T.getContext("2d"),L=T.width,v=T.height;if(S.clearRect(0,0,L,v),!_)return;let w=1/0,M=-1/0,U=1/0,b=-1/0;for(let G of _.cells)w=Math.min(w,G.x),M=Math.max(M,G.x),U=Math.min(U,G.y),b=Math.max(b,G.y);let g=M-w+1,C=b-U+1,R=Math.min(L/(g+.5),v/(C+.5)),et=(L-g*R)/2,I=(v-C*R)/2;S.fillStyle=Z;for(let G=0;G<_.cells.length;G++){let X=_.cells[G],gt=et+(X.x-w)*R,$t=I+(C-1-(X.y-U))*R;S.fillRect(gt+1,$t+1,R-2,R-2);let nt=_.colors[G],ht=Et[nt];if(ht){let _t=(R-2)*.32;S.fillStyle=ht,S.beginPath(),S.arc(gt+R/2,$t+R/2,_t,0,Xt),S.fill(),S.fillStyle=Z}}}}}(()=>{let e=Mo(),o=e.canvas,a=o.getContext("2d");o.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let u=Math.PI*2,s=30,n=24,i=120,l={"30_24":{N:30,H:24,survivalTime:120,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function m(t){let c=l[t]||l["30_24"];s=c.N,n=c.H,i=c.survivalTime}function p(){return n/i}let f=Math.PI/2,y=70,B=120,P=30,z=320,F=.42,Q="rgb(235,240,250)",Et="rgb(55,62,75)",jt="rgba(255,170,180,0.75)",Z="rgba(110,255,150,0.15)",A="rgba(110,255,150,0.85)",rt=2,ce={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},te={1:"fire",2:"water",3:"lightning",4:"earth"},Dt={fire:1,water:2,lightning:3,earth:4},kt=1,Gt=.58,ae=!0,Rt=12,xt=25,Ct=1,d=2,V=3,ct=5,ee=8,It=10,fe=15,Me=30,Ve=2,pn=.3,Vt=.5,xe=1,ve=.3,Ye=.5,hn=1.3,Ht=10,yn=500,re=[1,1.25,1.5,1.75,2],En=10,Sn=100,Mn=25,T=[1,1.3,1.6,2],_=[1,1.5,2,2.5],S=So(),L=S.loadGameSettings(),v=L.invertSwipe?-1:1,w=-1,M=Array.from({length:n},()=>new Uint8Array(s));function U(){M=Array.from({length:n},()=>new Uint8Array(s))}let b=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],g=null,C=n+3,R=0,et=0,I=!1,G=0,X=0,gt=0,$t=3,nt=0,ht=0,_t=0,vt=To({canvas:o,rotDir:v}),St="0.13.2",Re=!0,We="blue",h=po();h.preload();let ot=Lo(),J="intro",lt=0,Ie=0,Mt=0,le=0,Ae=0,ne=null,O=ot.stats,Ke=e.overlay,pe=vo({elementColors:ce}),yt=pe.showBonus.bind(pe),we=pe.getElementIcon.bind(pe),Pe=_o(),Fn=e.overlayTitle,Un=e.overlayStats,ue=e.startBtn,qe=e.hud,Oe=e.scoreHud,ze=e.timeHud,he=e.remainingHud,Yt=e.nextCanvas,Qe=Yt.getContext("2d"),Wt=e.pauseBtn,Nt=e.pauseOverlay,Ce=e.resumeBtn,_e=e.restartBtn,Ze=e.exitToMenuBtn,de=e.pauseSettingsBtn,Ft=e.pauseSoundBtn,De=e.pauseMusicBtn,xn=e.pauseBestScore,Je=e.pauseBestTime,x=e.pauseBestMode,H=e.pauseCurrentScore,W=e.pauseCurrentTime,j=e.pauseCurrentMode,$=e.confirmDialog,ut=e.confirmText,D=e.confirmCancel,K=e.confirmOk,st=e.settingsOverlay,At=e.settingsClose,at=e.fullscreenBtn,bt=e.rotateBtn,dt=e.startPanel,Kt=e.gameoverPanel,ke=e.goScore,vn=e.goTime,Ge=e.goRing,Tt=e.goMatches,oe=e.goBonuses,qt=e.goNewRecord,ye=e.goRestartBtn,Ee=e.goExitBtn,je=e.bestScore,tn=e.bestExtra,Xn=e.surviveVal,Ho=e.startVersion,Vn=e.modeBtns,$o=e.recordsBtn,No=e.startSettingsBtn,Fo=e.helpBtn,zt="25_20",wt=bo({buttons:e.magicBtns,onActivate:()=>h.play("spells")}),Cn=e.magicBtns,Ts=wt.charges,Uo=t=>wt.select(t),_n=()=>wt.updateButtons(),se=[],He=0,ie=!1,Se=!1,$e=!1,Qt=0,Zt=0,me=0,en=[];function bn(t,c,r){let E=1-r/n;return t+E*c}function Tn(t,c,r,E,N,q){let mt=(N-q)/s*u+f;return{x:t+Math.cos(mt)*r,y:c+Math.sin(mt)*E,ang:mt}}function Xo(t,c){let r=o.clientWidth,E=o.clientHeight,N=r*.5,q=(r-2*P)/2,mt=E-y-B,Lt=6,Pt=s*mt/(Lt*n),Te=E-B,Ut,tt,k;Pt<=Math.min(q,z)?(Ut=Pt,tt=mt,k=y):(Ut=Math.min(q,z),tt=Ut*Lt*n/s,k=Te-tt);let Y=Ut*.28,ft=bn(k,tt,t+.5),pt=Tn(N,ft,Ut,Y,c,nt);return{x:pt.x,y:pt.y}}function Vo(t,c){if(!wt.canUse()||ie)return!1;let r=Dt[wt.active],E=o.clientWidth,N=o.clientHeight,q=E*.5,mt=(E-2*P)/2,Lt=N-y-B,Pt=6,Te=s*Lt/(Pt*n),Ut=N-B,tt,k,Y;Te<=Math.min(mt,z)?(tt=Te,k=Lt,Y=y):(tt=Math.min(mt,z),k=tt*Pt*n/s,Y=Ut-k);let ft=tt*.28,pt=null,Jt=1/0;for(let Bt=0;Bt<n;Bt++){let Le=bn(Y,k,Bt+.5);for(let Ot=0;Ot<s;Ot++){let mn=M[Bt][Ot];if(!mn||mn!==r)continue;let Xe=Tn(q,Le,tt,ft,Ot,nt);if(Math.sin(Xe.ang)<-.1)continue;let gn=t-Xe.x,lo=c-Xe.y,uo=Math.hypot(gn,lo),mo=k/n*.9,hs=mo*1.2;Math.abs(gn)<hs/2&&Math.abs(lo)<mo/2&&uo<Jt&&(Jt=uo,pt={y:Bt,s:Ot})}}if(pt){let Bt=bn(Y,k,pt.y+.5),Le=Tn(q,Bt,tt,ft,pt.s,nt),Ot=o.getBoundingClientRect(),mn=Ot.left+Le.x,Xe=Ot.top+Le.y,ro=Cn[wt.active];return Pe.spawnMagicShot(wt.active,ro,mn,Xe,()=>{let gn=M[pt.y][pt.s];se=[{y:pt.y,s:pt.s,color:gn,isLine:!1,isMagic:!0}],He=performance.now(),ie=!0,Se=!0,Qt=0,Zt=Mn,yt(`+${Mn}`,"score")}),me=0,wt.useCharge(),O.magicUsed++,!0}return!1}let Ls=100;function Bs(t,c){return $n(t,c,n,s)}function Yo(){return Io(M,n,s)}let Wo=Ao;function Ko(t){let c=t.map(E=>({...E,color:M[E.y][E.s]}));for(let E of t)M[E.y][E.s]=0;let r=n;for(let E of t){let N=E.y;for(let q=1;q<=E.y;q++){let mt=E.y-q;if(M[mt][E.s]){N=q-1;break}}r=Math.min(r,N)}for(let E of c)M[E.y-r][E.s]=E.color;return r>0}function qo(){let t=!0;for(;t;){t=!1;let c=Yo();for(let r of c)Wo(r)||Ko(r)&&(t=!0)}}function zo(){Bn()}let Ln=Bo;function Yn(t,c){let r=new Map,E=0,N=0,q=0,mt={},Lt=t.length+c.length;for(let k of t){let Y=te[k.color],ft=0,pt=0;if(k.length>=5?(ft=V,pt=It,O.lines5++):k.length===4?(ft=d,pt=ee,O.lines4++):k.length===3&&(ft=Ct,pt=ct,O.lines3++),Y&&ft>0){wt.addCharges(Y,ft),mt[Y]=(mt[Y]||0)+ft;let Jt=k.cells[Math.floor(k.cells.length/2)],Bt=Xo(Jt.y,Jt.s),Le=Cn[Y];for(let Ot=0;Ot<ft;Ot++)setTimeout(()=>{Pe.spawnMagicOrb(Y,Bt.x,Bt.y,Le)},Ot*100)}E+=pt*p(),q+=pt,N+=k.length*En;for(let Jt of k.cells){let Bt=`${Jt.y},${Jt.s}`;r.has(Bt)||r.set(Bt,{y:Jt.y,s:Jt.s,color:k.color,isLine:!0})}}for(let k of c){O.pairs++,E+=fe*p(),q+=fe,N+=Sn;for(let Y of k.cells){let ft=`${Y.y},${Y.s}`;r.has(ft)||r.set(ft,{y:Y.y,s:Y.s,color:M[Y.y][Y.s],isLine:!1})}}let Pt=Ln(T,Lt-1),Te=Ln(_,me),Ut=Math.round(N*Pt*Te),tt=0;Lt>1&&(O.combos++,O.maxCombo=Math.max(O.maxCombo,Lt),setTimeout(()=>yt(`COMBO \xD7${Lt}`,"combo"),tt),tt+=180,h.play("combo2")),me>0&&(O.cascades++,O.maxCascade=Math.max(O.maxCascade,me),setTimeout(()=>yt(`CASCADE \xD7${me}`,"cascade"),tt),tt+=180,h.play("cascade")),(t.length>0||c.length>0)&&h.play("combo");for(let k of t){let Y=k.length,ft=Y*En;setTimeout(()=>yt(`Line-${Y} +${ft}`,"line",k.color),tt),tt+=100}for(let k of c){let Y=k.cells.length>0?M[k.cells[0].y][k.cells[0].s]:null;setTimeout(()=>yt(`Pair +${Sn}`,"pair",Y),tt),tt+=100}Ut>0&&(setTimeout(()=>yt(`+${Ut}`,"score"),tt),tt+=120),q>0&&(setTimeout(()=>yt(`+${q}s`,"time"),tt),tt+=120);for(let[k,Y]of Object.entries(mt))Y>0&&(setTimeout(()=>yt(`+${Y}${we(k)}`,"charge"),tt),tt+=120);se=Array.from(r.values()),He=performance.now(),ie=!0,Se=!1,Qt=E,Zt=Ut,_n()}function Qo(){for(let t of se)M[t.y][t.s]=0;se.length>0&&h.playRandom("disappear"),Qt>0&&(gt+=Qt),ot.addScore(Zt),lt+=Zt,cn(),se=[],ie=!1,Se=!1,Qt=0,Zt=0,me++,Bn()}function Bn(){qo();let{lineMatches:t,pairMatches:c}=cs();if(t.length>0||c.length>0)Yn(t,c);else{let r=Zn();r.length>0?os(r):!g&&J==="playing"&&Qn()}}function Rs(t,c){Yn(t,c)}function Rn(t){return Be(t,s)}function nn(){return Rn(Math.round(nt))}function Wn(t,c){return Nn(g,t,c,M,n,s)}function on(t){return Wn(t,nn())}let sn=Ro;function Kn(){ae&&(Rt!==0&&G>=Rt||(et=0,G+=1))}function Zo(){if(!g)return;let t=g.cells,c=g.colors,r={cells:t,colors:c};if(w>=0||(r=sn(r.cells,r.colors),r=sn(r.cells,r.colors)),r=sn(r.cells,r.colors),g.cells=r.cells,g.colors=r.colors,!on(Math.floor(C))){g.cells=t,g.colors=c;return}h.play("turn"),I&&Kn()}function Jo(){return wo(g,C,nn(),M,n,s)}function jo(){if(!g)return!1;let t=Math.floor(C)-1,c=!on(t);return c&&!I?(I=!0,et=0,G=0):!c&&I&&(I=!1,et=0,G=0),c}let be=fn;function Ne(){if(J==="playing"){Ke.classList.add("hidden"),Wt.classList.remove("hidden");return}if(Ke.classList.remove("hidden"),Wt.classList.add("hidden"),J==="intro"){dt.classList.remove("hidden"),Kt.classList.add("hidden");let t=Math.floor(i/60),c=i%60;Xn.textContent=`${t}:${c.toString().padStart(2,"0")}`;let r=S.loadHighscore(zt);r.score>0?(je.textContent=r.score.toLocaleString(),tn.textContent=`(${be(r.time)})`):(je.textContent="0",tn.textContent=""),Ho.textContent=`v${St}`,ue.classList.remove("idlePulse"),ue.offsetWidth,ue.classList.add("idlePulse")}else{dt.classList.add("hidden"),Kt.classList.remove("hidden"),ke.textContent=lt.toLocaleString(),vn.textContent=be(Mt);let t=S.loadHighscore(zt);lt>0&&lt>=t.score?qt.classList.remove("hidden"):qt.classList.add("hidden");let c=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${O.rings}</span>
          <span class="count ring-max">${O.maxRing>0?"max \xD7"+O.maxRing:""}</span>
        </div>
      `;Ge.innerHTML=c;let r=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${O.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${O.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${O.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${O.pairs}</span>
        </div>
      `;Tt.innerHTML=r;let E=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${O.combos}</span>
          <span class="count max-combo">${O.maxCombo>0?"max \xD7"+O.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${O.cascades}</span>
          <span class="count max-cascade">${O.maxCascade>0?"max \xD7"+O.maxCascade:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${O.magicUsed}</span>
        </div>
      `;oe.innerHTML=E}}function cn(){Oe.textContent=`Score: ${lt}`}function In(){ze.textContent=`Time: ${be(Mt)}`}function qn(){let t=Math.max(0,(n-X)/p()),c=Math.floor(t/60),r=Math.floor(t%60);he.textContent=`Left: ${c}:${r.toString().padStart(2,"0")}`,t<30?he.classList.add("warning"):he.classList.remove("warning")}function ts(){m(zt),U(),X=0,gt=0,nt=ht=0,_t=0,ot.start(),lt=0,Ie=performance.now(),Mt=0,Ae=0,le=0,J="playing",ne=null,wt.reset(),se=[],en=[],ie=!1,Se=!1,$e=!1,Qt=0,Zt=0,me=0,_n(),cn(),In(),qn(),Qn(),kn.drawNextPreview(Yt,ne),Ne(),h.getSettings().musicEnabled&&h.startGameMusic()}function An(){ot.gameOver(),J="gameover",g=null,I=!1,et=0,G=0;let t=S.saveHighscore(lt,Mt,zt);h.stopMusic(),h.play("gameover"),In(),Ne(),t&&lt>0&&setTimeout(()=>{yt("\u{1F3C6} NEW RECORD!","score")},500)}function es(t){for(let r=0;r<50;r++){let E=t.map(()=>1+(Math.random()*4|0));if(!ns(t,E))return E}return t.map((r,E)=>1+E%4)}let ns=Do;function zn(t){let c=t.cells.map(E=>({x:E.x,y:E.y})),r=es(c);return{name:t.name,cells:c,colors:r}}function Qn(){if(!ne){let N=b[Math.random()*b.length|0];ne=zn(N)}g=ne;let t=b[Math.random()*b.length|0];ne=zn(t),kn.drawNextPreview(Yt,ne);let c=1/0,r=-1/0;for(let N of g.cells)N.x<c&&(c=N.x),N.x>r&&(r=N.x);let E=(c+r)/2;for(let N of g.cells)N.x=N.x-Math.round(E);C=n+3,R=0,I=!1,et=0,G=0,on(Math.floor(C))?h.playRandom("appear"):An()}function Zn(){return Oo(M,n,s)}function os(t){if(t.length===0)return;let c=[];for(let Lt of t)for(let Pt=0;Pt<s;Pt++)c.push({y:Lt,s:Pt,color:M[Lt][Pt],isLine:!1});en=t,se=c,He=performance.now(),ie=!0,$e=!0,Se=!1;let r=t.length;O.rings+=r,O.maxRing=Math.max(O.maxRing,r);let E=Ln(re,r-1),N=Math.round(yn*r*E),q=Me*r;Zt=N,Qt=q*p(),h.play("ring");let mt=`RING \xD7${r}`;yt(mt,"ring"),setTimeout(()=>yt(`+${N}`,"score"),150),setTimeout(()=>yt(`+${q}s`,"time"),300)}function ss(){let t=[...en].sort((c,r)=>r-c);for(let c of t){for(let r=c;r<n-1;r++)M[r].set(M[r+1]);M[n-1].fill(0)}Qt>0&&(gt+=Qt),ot.addScore(Zt),lt+=Zt,cn(),se=[],en=[],ie=!1,$e=!1,Qt=0,Zt=0,Bn()}function Is(){return Zn().length}function is(){if(!g)return;let t=nn();nt=t,ht=t,_t=0;let c=!1;for(let r=0;r<g.cells.length;r++){let E=g.cells[r],N=g.colors[r],q=Math.floor(C)+E.y,mt=Rn(t+E.x);q>=n&&(c=!0),q>=0&&q<n&&(M[q][mt]=N)}if(c){An();return}ot.addScore(Ht),lt+=Ht,cn(),yt(`+${Ht}`,"score"),h.playRandom("drop"),g=null,me=0,zo()}function cs(){return Po(M,n,s)}function as(){if(!g)return!1;let t=Math.floor(C)-1;return on(t)?(C=t,I=!1,et=0,G=0,!0):(I=!0,!1)}o.addEventListener("pointerdown",t=>{if(it.state!=="playing")return;t.preventDefault?.(),vt.handlePointerDown(t,{onMagicTap:(r,E)=>it.applyCommand("magic_shoot",{x:r,y:E}),onDoubleTap:()=>it.applyCommand("rotate_piece")},ht)||(_t=0)},{passive:!1}),o.addEventListener("pointermove",t=>{if(it.state!=="playing"||!vt.dragging)return;t.preventDefault?.();let c=vt.handlePointerMove(t,{canRotateTo:(r,E)=>it.canRotateTo(r,E),onDrop:()=>it.applyCommand("move_down"),onGroundedMove:()=>it.onGroundedMove()},it.pieceY,it.isGrounded);c&&it.setRotation(c.targetRot)},{passive:!1}),o.addEventListener("pointerup",t=>{it.state==="playing"&&vt.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointercancel",t=>{vt.handlePointerUp(t)},{passive:!1}),o.addEventListener("pointerleave",t=>{vt.dragging&&vt.handlePointerUp(t)},{passive:!1}),bt.addEventListener("click",()=>{it.state==="playing"&&it.applyCommand("rotate_piece")});let an=e.dropBtn,rn=null;function rs(){it.state==="playing"&&(it.applyCommand("move_down"),rn=setInterval(()=>{if(it.state!=="playing"){ln();return}it.applyCommand("move_down")},xt))}function ln(){rn&&(clearInterval(rn),rn=null)}an.addEventListener("pointerdown",t=>{t.preventDefault(),rs()}),an.addEventListener("pointerup",ln),an.addEventListener("pointerleave",ln),an.addEventListener("pointercancel",ln);for(let[t,c]of Object.entries(Cn))c.addEventListener("click",()=>{it.state==="playing"&&it.applyCommand("select_magic",{element:t})});let wn=e.soundsToggle,Pn=e.musicToggle;function ge(){let t=h.getSettings();t.soundsEnabled?wn.classList.add("active"):wn.classList.remove("active"),t.musicEnabled?Pn.classList.add("active"):Pn.classList.remove("active");for(let c=0;c<=4;c++){let r=e.soundVolBtns[c],E=e.musicVolBtns[c];r&&r.classList.toggle("active",t.soundVolume===c),E&&E.classList.toggle("active",t.musicVolume===c)}}let Jn=e.tabBtns,ls=e.tabContents;Jn.forEach(t=>{t.addEventListener("click",()=>{let c=t.dataset.tab;Jn.forEach(r=>r.classList.remove("active")),ls.forEach(r=>r.classList.remove("active")),t.classList.add("active"),xo(c).classList.add("active"),c==="sounds"&&ge()})});let jn=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,to=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,us=e.iosHint,ds=e.standaloneBadge;function eo(){let t=document.fullscreenElement||document.webkitFullscreenElement;at.textContent=t?"Disable":"Enable"}jn&&(to?(ds.style.display="block",at.style.display="none"):(us.style.display="block",at.textContent="Not supported",at.style.opacity="0.5",at.style.cursor="default")),at.addEventListener("click",()=>{if(jn&&!to)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let c=document.documentElement;c.requestFullscreen?c.requestFullscreen():c.webkitRequestFullscreen&&c.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",eo),document.addEventListener("webkitfullscreenchange",eo);let un=e.invertSwipeToggle;L.invertSwipe&&un.classList.add("active"),un.addEventListener("click",()=>{un.classList.toggle("active");let t=un.classList.contains("active");vt.rotDir=t?-1:1,L.invertSwipe=t,S.saveGameSettings(L)});let no=e.diffBtns;no.forEach(t=>{t.addEventListener("click",()=>{if(!t.classList.contains("locked")&&(no.forEach(c=>{c.classList.remove("active");let r=c.querySelector(".check-icon");r&&r.remove()}),t.classList.add("active"),!t.querySelector(".check-icon"))){let c=document.createElement("span");c.className="check-icon",c.textContent="\u2713",t.appendChild(c)}})}),wn.addEventListener("click",()=>{let c=!h.getSettings().soundsEnabled;h.updateSettings({soundsEnabled:c}),ge(),Fe()}),Pn.addEventListener("click",()=>{let c=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:c}),ge(),Fe(),J!=="paused"&&(c?J==="playing"?h.startGameMusic():h.startMenuMusic():h.stopMusic())});for(let t=0;t<=4;t++){let c=e.soundVolBtns[t];c&&c.addEventListener("click",()=>{h.updateSettings({soundVolume:t}),ge(),h.play("turn")})}for(let t=0;t<=4;t++){let c=e.musicVolBtns[t];c&&c.addEventListener("click",()=>{h.updateSettings({musicVolume:t}),ge()})}ge();function oo(){J==="playing"&&(ot.pause(),le=performance.now(),J="paused",h.musicAudio&&h.musicAudio.pause())}function dn(){J==="paused"&&(ot.resume(),Ae+=performance.now()-le,le=0,J="playing",Gn=performance.now(),h.getSettings().musicEnabled&&h.startGameMusic())}function Fe(){let t=h.getSettings();Ft.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Ft.classList.toggle("off",!t.soundsEnabled),De.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",De.classList.toggle("off",!t.musicEnabled)}function ms(){Nt.classList.remove("hidden"),Wt.classList.add("hidden");let t=S.loadHighscore(zt);xn.textContent=t.score?t.score.toLocaleString():"0",Je.textContent=t.time?fn(t.time):"0:00",x.textContent=zt==="30_24"?"High Tower":"Quick Tower",H.textContent=lt.toLocaleString(),W.textContent=fn(Mt),j.textContent=zt==="30_24"?"High Tower":"Quick Tower",Fe()}function Ue(){Nt.classList.add("hidden"),Wt.classList.remove("hidden")}Wt.addEventListener("click",()=>{oo(),ms()}),Ce.addEventListener("click",()=>{Ue(),dn()});let On=null;function so(t,c){ut.textContent=t,On=c,$.classList.remove("hidden")}function io(){$.classList.add("hidden"),On=null}D.addEventListener("click",()=>{io()}),K.addEventListener("click",()=>{let t=On;io(),t&&t()}),_e.addEventListener("click",()=>{so("Restart game?",()=>{Ue(),it.applyCommand("start_game")})}),Ze.addEventListener("click",()=>{so("Exit to menu?",()=>{Ue(),Wt.classList.add("hidden"),J="intro",ot.reset(),h.stopMusic(),h.getSettings().musicEnabled&&h.startMenuMusic(),Ne()})}),de.addEventListener("click",()=>{st.classList.remove("hidden")}),Ft.addEventListener("click",()=>{let t=h.getSettings();h.updateSettings({soundsEnabled:!t.soundsEnabled}),Fe(),ge()}),De.addEventListener("click",()=>{let c=!h.getSettings().musicEnabled;h.updateSettings({musicEnabled:c}),Fe(),ge()}),Nt.addEventListener("click",t=>{t.target===Nt&&(Ue(),dn())}),document.addEventListener("keydown",t=>{J==="paused"&&!Nt.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Ue(),dn())}),At.addEventListener("click",()=>{st.classList.add("hidden")}),st.addEventListener("click",t=>{t.target===st&&st.classList.add("hidden")});let Dn=!1;document.addEventListener("visibilitychange",()=>{document.hidden?J==="playing"&&(oo(),Dn=!0):Dn&&J==="paused"&&(dn(),Dn=!1)});let it=ko({getN:()=>s,getH:()=>n,FALL_INTERVAL:kt,LOCK_DELAY_SEC:Gt,getKillRate:p,MATCH_HIGHLIGHT_SEC:Ve,MAGIC_SHRINK_SEC:Vt,RING_HIGHLIGHT_SEC:xe,getState:()=>({gameState:J,score:lt,elapsedMs:Mt,startTime:Ie,totalPausedMs:Ae,stats:O,activePiece:g,pieceY:C,targetRot:ht,rotFloat:nt,rotVel:_t,isGrounded:I,isHighlighting:ie,isMagicAnimation:Se,isRingAnimation:$e,highlightStartTime:He,killLevel:X,grid:M,fallTimer:R,lockTimer:et}),setState:t=>{"elapsedMs"in t&&(Mt=t.elapsedMs),"killLevel"in t&&(X=t.killLevel),"fallTimer"in t&&(R=t.fallTimer),"lockTimer"in t&&(et=t.lockTimer),"targetRot"in t&&(ht=t.targetRot),"rotFloat"in t&&(nt=t.rotFloat),"rotVel"in t&&(_t=t.rotVel)},funcs:{startGame:ts,endGame:An,rotatePieceByDir:Zo,tryMoveDown:as,canPlaceAtRot:Wn,maybeResetLockDelay:Kn,shootMagic:Vo,selectMagic:Uo,updateGroundedState:jo,lockPiece:is,finishHighlight:Qo,finishRingHighlight:ss},ui:{updateTimeHud:In,updateRemainingHud:qn}}),kn=Go({canvas:o,canvasCtx:a,getN:()=>s,getH:()=>n,TOP_PAD_PX:y,BOTTOM_PAD_PX:B,SIDE_MARGIN_PX:P,MAX_RADIUS_X:z,RADIUS_X_FACTOR:F,ANG_OFFSET:f,MATCH_HIGHLIGHT_SEC:Ve,MATCH_SHRINK_PHASE:pn,MAGIC_SHRINK_SEC:Vt,RING_HIGHLIGHT_SEC:xe,LOCK_DELAY_SEC:Gt,getKillRate:p,ELEMENT_COLORS:ce,ELEMENT_TO_COLOR:Dt,BLOCK_COLOR_FRONT:Q,BLOCK_COLOR_BACK:Et,ACTIVE_COLOR_FRONT:jt,GHOST_COLOR_FILL:Z,GHOST_COLOR_STROKE:A,GHOST_STROKE_WIDTH:rt,MAGIC_DIM_DOT_ALPHA:ve,MAGIC_DIM_DOT_SCALE:Ye,MAGIC_TARGET_DOT_SCALE:hn,getState:()=>({gameState:J,grid:M,activePiece:g,pieceY:C,rotFloat:nt,killLevel:X,isHighlighting:ie,highlightedCells:se,highlightStartTime:He,isMagicAnimation:Se,isRingAnimation:$e,isGrounded:I,lockTimer:et}),getVisualSettings:()=>({waterBubbles:Re,waterColor:We}),funcs:{snappedRot:nn,computeGhostY:Jo,normSector:Rn,getMagicTargetColor:()=>wt.canUse()?Dt[wt.active]:null}}),Gn=performance.now();function co(t){let c=Math.min(.05,Math.max(.001,(t-Gn)/1e3));if(Gn=t,it.update(c,t),gt>0){let r=Math.min(gt,$t*c);X=Math.max(0,X-r),gt-=r}nt=ht,nt>1e6&&(nt%=s),nt<-1e6&&(nt%=s),kn.render(c),requestAnimationFrame(co)}ue.addEventListener("click",()=>{it.applyCommand("start_game")}),ye.addEventListener("click",()=>{it.applyCommand("start_game")}),Ee.addEventListener("click",()=>{J="intro",ot.reset(),h.stopMusic(),h.getSettings().musicEnabled&&h.startMenuMusic(),Ne()}),Vn.forEach(t=>{t.addEventListener("click",()=>{Vn.forEach(q=>q.classList.remove("active")),t.classList.add("active"),zt=t.dataset.mode;let c=S.loadHighscore(zt);c.score>0?(je.textContent=c.score.toLocaleString(),tn.textContent=`(${be(c.time)})`):(je.textContent="0",tn.textContent="");let r=l[zt]||l["30_24"],E=Math.floor(r.survivalTime/60),N=r.survivalTime%60;Xn.textContent=`${E}:${N.toString().padStart(2,"0")}`,ue.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ue.classList.add("idlePulse"),2e3)})}),$o.addEventListener("click",()=>{let t=S.loadHighscore("30_24"),c=S.loadHighscore("25_20"),r=`Records

`;r+=`High Tower (30\xD724):
`,r+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${be(t.time)}
`:`  No record yet
`,r+=`
Quick Tower (25\xD720):
`,r+=c.score>0?`  Score: ${c.score.toLocaleString()}, Time: ${be(c.time)}
`:`  No record yet
`,alert(r)}),No.addEventListener("click",()=>{st.classList.remove("hidden")}),Fo.addEventListener("click",()=>{alert(`How to play

1) Swipe left/right to rotate the cylinder
2) Swipe down for faster drop
3) Double tap or press \u27F3 to rotate piece
4) Match 3+ blocks of same color in a line
5) Close complete rings to rise higher
6) Use magic: tap element button, then tap matching block

Survive as long as you can!`)}),_n(),Ne(),h.startMenuMusic();let gs=()=>{if(h.unlock(),!h.getSettings().musicEnabled)return;let t=h.musicAudio;!t||t.paused||t.ended?it.state==="playing"?h.startGameMusic():h.startMenuMusic():t.play().catch(c=>{console.debug("Music resume on interaction failed:",c)})},ao=0,fs=10,ps=()=>{ao>=fs||(ao++,gs())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,ps,{passive:!0})}),requestAnimationFrame(co)})();})();
