(()=>{var Ki=[0,.25,.5,.75,1],qi=[0,.05,.15,.25,.5],zi={appear1:"sounds/figure/FigureAppear_1.wav",appear2:"sounds/figure/FigureAppear_2.wav",appear3:"sounds/figure/FigureAppear_3.wav",drop1:"sounds/figure/FigureDrop_1.wav",drop2:"sounds/figure/FigureDrop_2.wav",drop3:"sounds/figure/FigureDrop_3.wav",turn:"sounds/figure/FigureTurn.wav",disappear1:"sounds/figure/FigureDisappear_1_old.wav",disappear2:"sounds/figure/FigureDisappear_2_old.wav",disappear3:"sounds/figure/FigureDisappear_3_old.wav",combo:"sounds/combo/combo.wav",combo2:"sounds/combo/combo2.wav",cascade:"sounds/combo/cascade.mp3",ring:"sounds/combo/ring.wav",gameover:"sounds/gameover.mp3",spells:"sounds/spells.wav",readysuper:"sounds/spell/readysuper.mp3",ulta:"sounds/ulta.wav",cancel:"sounds/cancel.wav",wsseffect:"sounds/spell/wsseffect.wav",esseffect:"sounds/spell/esseffect.wav",asseffect:"sounds/spell/asseffect.wav",fsseffect:"sounds/spell/fsseffect.wav"},xo={menu:"music/mm.mp3",game:"sounds/amb1.wav"},Co="soundSettings";function ji(){try{let e=localStorage.getItem(Co);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load sound settings:",e)}return{soundsEnabled:!0,musicEnabled:!0,soundVolume:3,musicVolume:2}}function Qi(e){try{localStorage.setItem(Co,JSON.stringify(e))}catch(n){console.debug("Failed to save sound settings:",n)}}function To(){return{audioContext:null,buffers:{},settings:ji(),musicAudio:null,musicGain:null,musicSource:null,unlocked:!1,initContext(){if(!this.audioContext)try{let n=window.AudioContext||window.webkitAudioContext;this.audioContext=new n,this.musicGain=this.audioContext.createGain(),this.musicGain.connect(this.audioContext.destination),this.musicGain.gain.value=this.getMusicVolume(),console.debug("AudioContext initialized, state:",this.audioContext.state)}catch(n){console.debug("Failed to create AudioContext:",n)}},async unlock(){if(!this.unlocked&&(this.initContext(),!!this.audioContext)){if(this.audioContext.state==="suspended")try{await this.audioContext.resume(),console.debug("AudioContext resumed")}catch(n){console.debug("Failed to resume AudioContext:",n)}if(!this.unlocked&&this.audioContext.state==="running"){let n=this.audioContext.createBuffer(1,1,22050),a=this.audioContext.createBufferSource();a.buffer=n,a.connect(this.audioContext.destination),a.start(0),this.unlocked=!0,console.debug("AudioContext unlocked")}}},getSoundVolume(){return Ki[this.settings.soundVolume]},getMusicVolume(){return qi[this.settings.musicVolume]},async loadSound(n,a){if(this.audioContext||this.initContext(),!!this.audioContext)try{let i=await(await fetch(a)).arrayBuffer(),s=await this.audioContext.decodeAudioData(i);this.buffers[n]=s}catch(d){console.debug(`Failed to load sound: ${n} from ${a}`,d)}},preload(){this.initContext();for(let[n,a]of Object.entries(zi))this.loadSound(n,a)},play(n,a=null){if(!this.settings.soundsEnabled||!this.audioContext||this.audioContext.state!=="running")return;let d=n;a!==null&&(d=`${n}${a}`);let i=this.buffers[d];if(i)try{let s=this.audioContext.createGain();s.gain.value=this.getSoundVolume(),s.connect(this.audioContext.destination);let c=this.audioContext.createBufferSource();c.buffer=i,c.connect(s),c.start(0),c.onended=()=>{c.disconnect(),s.disconnect()}}catch(s){console.debug("Sound play failed:",s)}},playRandom(n){if(!this.settings.soundsEnabled)return;let a=1+Math.floor(Math.random()*3);this.play(n,a)},startMenuMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.menu),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Menu music started")}).catch(a=>{console.debug("Menu music autoplay blocked:",a)})}catch(n){console.debug("Menu music start failed:",n)}}},startGameMusic(){if(this.settings.musicEnabled){this.stopMusic();try{this.musicAudio=new Audio(xo.game),this.musicAudio.loop=!0,this.musicAudio.volume=this.getMusicVolume();let n=this.musicAudio.play();n!==void 0&&n.then(()=>{console.debug("Game music started")}).catch(a=>{console.debug("Game music play failed:",a)})}catch(n){console.debug("Game music start failed:",n)}}},stopMusic(){if(this.musicAudio)try{this.musicAudio.pause(),this.musicAudio.currentTime=0,this.musicAudio=null}catch(n){console.debug("Stop music failed:",n)}},startMusic(){this.startMenuMusic()},startAmbient(){this.startGameMusic()},stopAmbient(){this.stopMusic()},updateSettings(n){if(this.settings={...this.settings,...n},Qi(this.settings),this.musicAudio)try{this.musicAudio.volume=this.getMusicVolume(),this.settings.musicEnabled?this.musicAudio.paused&&this.musicAudio.play().catch(a=>{console.debug("Music resume failed:",a)}):this.stopMusic()}catch(a){console.debug("Update music settings failed:",a)}},getSettings(){return{...this.settings}}}}var _o="eb_highscore",Lo="eb_highscore_quick",Bo="eb_settings",Ro="eb_high_tower_rings",Zi={invertSwipe:!1,hapticsEnabled:!0,showControls:!0,tapRotate:!1};function wo(){return{loadHighscore(e="30_24"){try{let n=e==="25_20"?Lo:_o,a=localStorage.getItem(n);if(a)return JSON.parse(a)}catch(n){console.debug("Failed to load highscore:",n)}return{score:0,time:0}},saveHighscore(e,n,a="30_24"){try{let d=this.loadHighscore(a);if(e>d.score||e===d.score&&n>d.time){let i=a==="25_20"?Lo:_o;return localStorage.setItem(i,JSON.stringify({score:e,time:n})),!0}}catch(d){console.debug("Failed to save highscore:",d)}return!1},loadGameSettings(){try{let e=localStorage.getItem(Bo);if(e)return JSON.parse(e)}catch(e){console.debug("Failed to load game settings:",e)}return{...Zi}},saveGameSettings(e){try{localStorage.setItem(Bo,JSON.stringify(e))}catch(n){console.debug("Failed to save game settings:",n)}},loadHighTowerRings(){try{let e=localStorage.getItem(Ro);if(e)return parseInt(e,10)||0}catch(e){console.debug("Failed to load High Tower rings:",e)}return 0},saveHighTowerRings(e){try{localStorage.setItem(Ro,String(e))}catch(n){console.debug("Failed to save High Tower rings:",n)}},addHighTowerRings(e){let a=this.loadHighTowerRings()+e;return this.saveHighTowerRings(a),a}}}function Ao(){return{canvas:document.getElementById("c"),gameContainer:document.getElementById("gameContainer"),hud:document.getElementById("hud"),scoreHud:document.getElementById("scoreHud"),timeHud:document.getElementById("timeHud"),remainingHud:document.getElementById("remainingHud"),nextCanvas:document.getElementById("nextCanvas"),overlay:document.getElementById("overlay"),overlayTitle:document.getElementById("overlayTitle"),overlayStats:document.getElementById("overlayStats"),startBtn:document.getElementById("startBtn"),startPanel:document.getElementById("startPanel"),gameoverPanel:document.getElementById("gameoverPanel"),goScore:document.getElementById("goScore"),goTime:document.getElementById("goTime"),goRing:document.getElementById("goRing"),goMatches:document.getElementById("goMatches"),goBonuses:document.getElementById("goBonuses"),goNewRecord:document.getElementById("goNewRecord"),goRestartBtn:document.getElementById("goRestartBtn"),goExitBtn:document.getElementById("goExitBtn"),bestScore:document.getElementById("bestScore"),bestTimeVal:document.getElementById("bestTimeVal"),startVersion:document.getElementById("startVersion"),modeGrid:document.getElementById("modeGrid"),modeBtns:document.querySelectorAll(".mode-btn"),recordsBtn:document.getElementById("recordsBtn"),startSettingsBtn:document.getElementById("startSettingsBtn"),helpBtn:document.getElementById("helpBtn"),pauseBtn:document.getElementById("pauseBtn"),pauseOverlay:document.getElementById("pauseOverlay"),resumeBtn:document.getElementById("resumeBtn"),restartBtn:document.getElementById("restartBtn"),exitToMenuBtn:document.getElementById("exitToMenuBtn"),pauseSettingsBtn:document.getElementById("pauseSettingsBtn"),pauseSoundBtn:document.getElementById("pauseSoundBtn"),pauseMusicBtn:document.getElementById("pauseMusicBtn"),pauseBestScore:document.getElementById("pauseBestScore"),pauseBestTime:document.getElementById("pauseBestTime"),pauseBestMode:document.getElementById("pauseBestMode"),pauseCurrentScore:document.getElementById("pauseCurrentScore"),pauseCurrentTime:document.getElementById("pauseCurrentTime"),pauseCurrentMode:document.getElementById("pauseCurrentMode"),confirmDialog:document.getElementById("confirmDialog"),confirmText:document.getElementById("confirmText"),confirmCancel:document.getElementById("confirmCancel"),confirmOk:document.getElementById("confirmOk"),settingsOverlay:document.getElementById("settingsOverlay"),settingsClose:document.getElementById("settingsClose"),rotateBtn:document.getElementById("rotateBtn"),dropBtn:document.getElementById("dropBtn"),controlsRight:document.querySelector(".controls-right"),magicRow:document.getElementById("magicRow"),magicBtns:{fire:document.getElementById("magicRed"),water:document.getElementById("magicBlue"),lightning:document.getElementById("magicYellow"),earth:document.getElementById("magicGreen")},spellBtn:document.getElementById("magicActiveIndicator"),magicActiveIndicator:document.getElementById("magicActiveIndicator"),magicActiveIcon:document.getElementById("magicActiveIcon"),magicActiveCost:document.getElementById("magicActiveCost"),spellWave:document.getElementById("spellWave"),fullscreenBtn:document.getElementById("fullscreenBtn"),iosHint:document.getElementById("iosHint"),standaloneBadge:document.getElementById("standaloneBadge"),invertSwipeToggle:document.getElementById("invertSwipeToggle"),hapticsToggle:document.getElementById("hapticsToggle"),showControlsToggle:document.getElementById("showControlsToggle"),tapRotateToggle:document.getElementById("tapRotateToggle"),soundsToggle:document.getElementById("soundsToggle"),musicToggle:document.getElementById("musicToggle"),soundVolBtns:[document.getElementById("soundVol0"),document.getElementById("soundVol1"),document.getElementById("soundVol2"),document.getElementById("soundVol3"),document.getElementById("soundVol4")],musicVolBtns:[document.getElementById("musicVol0"),document.getElementById("musicVol1"),document.getElementById("musicVol2"),document.getElementById("musicVol3"),document.getElementById("musicVol4")],tabBtns:document.querySelectorAll(".tab-btn"),tabContents:document.querySelectorAll(".tab-content")}}function Io(e){return document.getElementById("tab-"+e)}var Ji={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function Po(e={}){let{elementColors:n={}}=e,a=0;return{showBonus(d,i="score",s=null){let c=document.createElement("div");c.className=`bonus-popup ${i}`,c.textContent=d,s&&n[s]&&(c.style.color=n[s]);let f=window.innerWidth/2,p=window.innerHeight/2-40,g=(Math.random()-.5)*200,r=(Math.random()-.5)*100+a*36;c.style.left=`${f+g}px`,c.style.top=`${p+r}px`,c.style.transform="translate(-50%, -50%)",document.body.appendChild(c),a++,setTimeout(()=>{a=Math.max(0,a-1)},200),setTimeout(()=>{c.remove()},1800)},getElementIcon(d){return Ji[d]||"\u2726"}}}var ks={fire:"\u{1F525}",water:"\u{1F4A7}",lightning:"\u26A1",earth:"\u{1F33F}"};function ko(){return{spawnMagicOrb(e,n,a,d){if(!d)return;let i=document.createElement("div");i.className=`magic-orb ${e}`,i.textContent=ks[e]||"\u2726";let s=d.getBoundingClientRect(),c=s.left+s.width/2-n,f=s.top+s.height/2-a,p=Math.hypot(c,f),g=Math.atan2(f,c),r=p*.35*(Math.random()>.5?1:-1),m=g+Math.PI/2,b=c*.5+Math.cos(m)*r,R=f*.5+Math.sin(m)*r;i.style.setProperty("--mid-x",`${b}px`),i.style.setProperty("--mid-y",`${R}px`),i.style.setProperty("--end-x",`${c}px`),i.style.setProperty("--end-y",`${f}px`),i.style.left=`${n}px`,i.style.top=`${a}px`,document.body.appendChild(i),setTimeout(()=>{i.remove()},700)},spawnMagicShot(e,n,a,d,i){if(!n){i&&i();return}let s=n.getBoundingClientRect(),c=s.left+s.width/2,f=s.top+s.height/2,p=document.createElement("div");p.className=`magic-shot ${e}`,p.textContent=ks[e]||"\u2726";let g=a-c,r=d-f;p.style.setProperty("--end-x",`${g}px`),p.style.setProperty("--end-y",`${r}px`),p.style.left=`${c}px`,p.style.top=`${f}px`,document.body.appendChild(p);let m=setInterval(()=>{let b=p.getBoundingClientRect();this.spawnTrailParticle(e,b.left+b.width/2,b.top+b.height/2)},40);setTimeout(()=>{clearInterval(m),p.remove(),this.spawnExplosion(e,a,d),i&&i()},300)},spawnTrailParticle(e,n,a){let d=document.createElement("div");d.className=`magic-trail ${e}`,d.style.left=`${n}px`,d.style.top=`${a}px`,document.body.appendChild(d),setTimeout(()=>d.remove(),400)},spawnExplosion(e,n,a){for(let i=0;i<12;i++){let s=document.createElement("div");s.className=`magic-explosion ${e}`;let c=i/12*Math.PI*2+(Math.random()-.5)*.5,f=40+Math.random()*40,p=Math.cos(c)*f,g=Math.sin(c)*f;s.style.setProperty("--px",`${p}px`),s.style.setProperty("--py",`${g}px`),s.style.left=`${n}px`,s.style.top=`${a}px`,document.body.appendChild(s),setTimeout(()=>s.remove(),500)}},spawnSpellBubbles(e,n="water",a=18){if(!e)return;let d=n;typeof n=="number"&&(a=n,d="water"),ks[d]||(d="water");let i=e.getBoundingClientRect(),s=i.left+i.width/2,c=i.top+i.height/2,f=Math.max(8,Math.round(a));for(let p=0;p<f;p++){let g=document.createElement("div");g.className=`spell-bubble ${d}`,g.textContent="\u25CF";let r=p/f*Math.PI*2+(Math.random()-.5)*.6,m=50+Math.random()*60,b=Math.cos(r)*m,R=Math.sin(r)*m-20;g.style.setProperty("--px",`${b}px`),g.style.setProperty("--py",`${R}px`),g.style.left=`${s}px`,g.style.top=`${c}px`,g.style.fontSize=`${8+Math.random()*10}px`,document.body.appendChild(g),setTimeout(()=>g.remove(),800)}},spawnSpellOrb(e,n,a){if(!a)return;let d=document.createElement("div");d.className="spell-orb",d.textContent="\u2727";let i=a.getBoundingClientRect(),s=i.left+i.width/2-e,c=i.top+i.height/2-n,f=Math.hypot(s,c),p=Math.atan2(c,s),g=f*.35*(Math.random()>.5?1:-1),r=p+Math.PI/2,m=s*.5+Math.cos(r)*g,b=c*.5+Math.sin(r)*g;d.style.setProperty("--mid-x",`${m}px`),d.style.setProperty("--mid-y",`${b}px`),d.style.setProperty("--end-x",`${s}px`),d.style.setProperty("--end-y",`${c}px`),d.style.left=`${e}px`,d.style.top=`${n}px`,document.body.appendChild(d),setTimeout(()=>{d.remove()},700)}}}var tc=`
  <div class="help-controls" aria-hidden="true">
    <div class="stage">
      <div class="gesture-layer" aria-hidden="true">
        <div class="gesture-anchor">
          <div class="gesture g-right"></div>
          <div class="gesture g-left1"></div>
          <div class="gesture g-left2"></div>
          <div class="gesture g-tap"></di\u0410v>
          <div class="gesture g-down"></div>
        </div>
      </div>

      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghostY">
            <div class="ghostRot">
              <div class="ghostFade">
                <div class="ghost">
                  <div class="g a"></div>
                  <div class="g b"></div>
                  <div class="g c"></div>
                  <div class="g t"></div>
                  <div class="g r"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="lock-wrap" aria-hidden="true">
          <div class="lockY">
            <div class="lockDrop">
              <div class="lockRot">
                <div class="lock">
                  <div class="d a"><div class="dot" style="--c:var(--earth)"></div></div>
                  <div class="d b"><div class="dot" style="--c:var(--water)"></div></div>
                  <div class="d c"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d t"><div class="dot" style="--c:var(--light)"></div></div>
                  <div class="d r"><div class="dot" style="--c:var(--earth)"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="placed-wrap" aria-hidden="true">
          <div class="placed">
            <div class="p t0"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b0"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="p b1"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="p b2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="p b4"><div class="dot" style="--c:var(--earth)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,Oo=`
  <div class="help-combos" aria-hidden="true">
    <div class="viewport">
      <div class="layer current">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4 match1"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="clock time1" aria-hidden="true">
            <span class="plus"></span>
          </div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0 grav12"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1 grav12"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2 gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r gravPair"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3 match1"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG grav2"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1 grav2"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0 pair2"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1 pair2"><div class="dot" style="--c:var(--water)"></div></div>
          </div>

          <div class="clock time2" aria-hidden="true">
            <span class="plus"></span>
          </div>
        </div>
      </div>

      <div class="layer next">
        <div class="stage">
          <div class="b s1"><div class="dot" style="--c:var(--water)"></div></div>
          <div class="b s2"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="b s22"><div class="dot" style="--c:var(--earth)"></div></div>

          <div class="b s3"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="b s4"><div class="dot" style="--c:var(--fire)"></div></div>

          <div class="fall1" aria-hidden="true">
            <div class="b f0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b f1"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b f2"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f2r"><div class="dot" style="--c:var(--light)"></div></div>
            <div class="b f3"><div class="dot" style="--c:var(--fire)"></div></div>
          </div>

          <div class="pack" aria-hidden="true">
            <div class="b pG"><div class="dot" style="--c:var(--earth)"></div></div>
            <div class="b pR0"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pR1"><div class="dot" style="--c:var(--fire)"></div></div>
            <div class="b pB0"><div class="dot" style="--c:var(--water)"></div></div>
            <div class="b pB1"><div class="dot" style="--c:var(--water)"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
`,ec=`
  <div class="help-rings" aria-hidden="true">
    <div class="stage">
      <div class="tower">
        <div class="wall left"></div>
        <div class="wall right"></div>
        <div class="platform"></div>

        <div class="ring-wrap">
          <div class="ring"></div>
        </div>

        <div class="clock"><div class="plus"></div></div>

        <div class="falling-figure">
          <div class="block"><div class="dot" style="--c:var(--light)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--fire)"></div></div>
          <div class="block"><div class="dot" style="--c:var(--water)"></div></div>
        </div>
      </div>
    </div>
  </div>
`;function nc(e){let n=e.querySelector(".ring"),a=e.querySelector(".falling-figure"),d=e.querySelector(".clock");if(!n||!a||!d)return()=>{};let i=!1,s=[],c=[],f=(N,V)=>{let it=setTimeout(()=>{i||N()},V);return s.push(it),it},p=(N,V)=>{let it=setInterval(()=>{if(i){clearInterval(it);return}N()},V);return c.push(it),it},g=48,r=.9,m=9,b=9,R=3,X=2,j=18,gt=-12,Ut=.5,ye=12,qt=10,Mt=["--fire","--water","--light","--earth"],Vt=["--light","--fire","--water"],ot=3,z=Math.floor(m/2)-1,St=8e3,Pt=[];function Rt(N,V){let it=(V-1)/2,Ot=Math.abs(N-it)/it;return 1-(1-Ut)*Ot}function C(N,V,it,Ot){let de=(V-1)/2,K=Math.abs(N-de)/de;return Ot?K*it:-K*it}function wt(){n.innerHTML="";let N=[],V=[];for(let nt=0;nt<b;nt++)V.push(g*r*Rt(nt,b));let it=V.reduce((nt,Ct)=>nt+Ct,0)+(b-1)*X,Ot=[];for(let nt=0;nt<m;nt++)Ot.push(g*Rt(nt,m));let de=Ot.reduce((nt,Ct)=>nt+Ct,0)+(m-1)*R,K=-it/2;for(let nt=0;nt<b;nt++){let Ct=V[nt],Dt=g*r,ue=m+nt,_t=C(nt,b,qt,!0),zt=document.createElement("div");zt.className="block back",zt.style.cssText=`left:${K.toFixed(1)}px;top:${(gt-Dt/2+_t).toFixed(1)}px;width:${Ct.toFixed(1)}px;height:${Dt.toFixed(1)}px;z-index:5;--pos:translate(0,0);`;let Y=document.createElement("div");Y.className="dot";let ie=r*Rt(nt,b);Y.style.cssText=`--c:var(${Mt[ue%4]});transform:scale(${ie.toFixed(2)});`,zt.appendChild(Y),zt.dataset.index=ue,n.appendChild(zt),N[ue]=zt,K+=Ct+X}let et=-de/2;for(let nt=0;nt<m;nt++){let Ct=Ot[nt],Dt=g,ue=nt,_t=C(nt,m,ye,!1),zt=ue>=z&&ue<z+ot,Y=document.createElement("div");Y.className="block",zt&&Y.classList.add("gap"),Y.style.cssText=`left:${et.toFixed(1)}px;top:${(j-Dt/2+_t).toFixed(1)}px;width:${Ct.toFixed(1)}px;height:${Dt.toFixed(1)}px;z-index:15;--pos:translate(0,0);`;let ie=document.createElement("div");ie.className="dot";let we=Rt(nt,m);ie.style.cssText=`--c:var(${Mt[ue%4]});transform:scale(${we.toFixed(2)});`,Y.appendChild(ie),Y.dataset.index=ue,n.appendChild(Y),N[ue]=Y,et+=Ct+R}Pt=N}function Xt(){let N=[];for(let V=z-1;V>=0;V--)N.push(V);for(let V=0;V<b;V++)N.push(m+V);for(let V=m-1;V>=z;V--)N.push(V);return N}function Tt(){Pt.forEach((N,V)=>{N&&(N.classList.remove("hi","vanish","gap"),N.style.opacity="",N.style.transform="",V>=z&&V<z+ot&&N.classList.add("gap"))})}function l(){for(let N=0;N<ot;N++){let V=Pt[z+N];if(V){V.classList.remove("gap");let it=V.querySelector(".dot");if(it){let Ot=Rt(z+N,m);it.style.cssText=`--c:var(${Vt[N]});transform:scale(${Ot.toFixed(2)});`}}}}function tt(N){let V=Xt(),it=0,Ot=V.length,de=p(()=>{if(it>0&&it<=Ot){let K=Pt[V[it-1]];K&&K.classList.remove("hi")}if(it<Ot){let K=Pt[V[it]];K&&K.classList.add("hi"),it++}else clearInterval(de),Pt.forEach(K=>{K&&K.classList.add("hi")}),f(N,300)},30)}function Z(N){let V=Xt(),it=V.length;V.forEach((Ot,de)=>{let K=Pt[Ot];K&&f(()=>{K.classList.add("vanish")},de*40)}),f(N,it*40+500)}function oe(){i||(Tt(),a.classList.add("active"),f(()=>{l(),a.classList.remove("active"),a.style.opacity="0",f(()=>{tt(()=>{i||(d.classList.add("show"),f(()=>{Z(()=>{i||(d.classList.remove("show"),a.style.opacity="",f(oe,500))})},400))})},200)},St*.38))}return wt(),oe(),()=>{i=!0,s.forEach(clearTimeout),c.forEach(clearInterval)}}var sc=[{title:"Rotate the Tower",text:`Swipe left and right to rotate the tower.
Double tap rotates the piece.
Swipe down to speed up the falling piece.`,illustrationHtml:tc},{title:"Build Combos",text:`Three in a row and pairs give points and add time.
The bigger the combo, the bigger the reward.`,illustrationHtml:Oo},{title:"Close the Rings",text:`A fully closed ring gives lots of points
and a big time boost.`,illustrationHtml:ec,onEnter:e=>nc(e)}];function Do(e={}){let{helpBtn:n,mount:a=document.body,combosTemplate:d}=e;if(!n||!a)return{open(){},close(){},setCombosTemplate(){}};let i=sc.map(C=>({...C}));typeof d=="string"&&d.trim()&&(i[1].illustrationHtml=d);let s=document.createElement("div");s.className="overlay hidden help-modal",s.id="helpOverlay",s.innerHTML=`
    <div class="panel help-panel" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="help-header">
        <div class="help-title" id="helpTitle">HOW TO PLAY</div>
      </div>
      <div class="help-body">
        <div class="help-illustration" aria-hidden="true"></div>
        <div class="help-slide-title"></div>
        <div class="help-slide-text"></div>
      </div>
      <div class="help-footer">
        <div class="help-dots" aria-hidden="true"></div>
        <button class="panel-btn help-next-btn" type="button">Next</button>
      </div>
    </div>
  `,a.appendChild(s);let c=s.querySelector(".help-next-btn"),f=s.querySelector(".help-slide-title"),p=s.querySelector(".help-slide-text"),g=s.querySelector(".help-illustration"),r=s.querySelector(".help-dots"),m=i.map(()=>{let C=document.createElement("span");return C.className="help-dot",r.appendChild(C),C}),b=0,R=!1,X=null,j=null,gt=180,Ut=560,ye=460,qt=480,Mt=C=>{j&&(j(),j=null);let wt=i[C];wt&&(b=C,f.textContent=wt.title,p.textContent=wt.text,g.innerHTML=wt.illustrationHtml||"",m.forEach((Xt,Tt)=>{Xt.classList.toggle("active",Tt===C)}),c.textContent=C===i.length-1?"Done":"Next",Vt(),wt.onEnter&&(j=wt.onEnter(g)))},Vt=()=>{if(!R||s.classList.contains("hidden"))return;let C=g.getBoundingClientRect();if(!C.width||!C.height)return;let wt=g.querySelector(".help-combos");if(wt){let l=Math.min(1,Math.min(C.width,C.height)/Ut);wt.style.setProperty("--help-combos-scale",l.toFixed(3))}let Xt=g.querySelector(".help-controls");if(Xt){let l=Math.min(1,Math.min(C.width,C.height)/ye);Xt.style.setProperty("--help-controls-scale",l.toFixed(3))}let Tt=g.querySelector(".help-rings");if(Tt){let l=Math.min(1,Math.min(C.width,C.height)/qt);Tt.style.setProperty("--help-rings-scale",l.toFixed(3))}},ot=()=>{R&&Vt()},z=C=>{R&&C.stopPropagation()},St=C=>{if(R){if(C.key==="Escape"){C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation?.(),Rt();return}C.preventDefault(),C.stopPropagation(),C.stopImmediatePropagation?.()}},Pt=()=>{R||(R=!0,X&&(clearTimeout(X),X=null),Mt(0),s.classList.remove("hidden"),requestAnimationFrame(()=>{s.classList.add("is-visible"),Vt()}),document.addEventListener("keydown",St,!0),window.addEventListener("resize",ot))},Rt=()=>{R&&(R=!1,j&&(j(),j=null),s.classList.remove("is-visible"),document.removeEventListener("keydown",St,!0),window.removeEventListener("resize",ot),X=window.setTimeout(()=>{s.classList.add("hidden")},gt))};return s.addEventListener("click",C=>{R&&(C.target===s&&Rt(),C.stopPropagation())}),s.addEventListener("pointerdown",z),s.addEventListener("pointerup",z),s.addEventListener("touchstart",z,{passive:!0}),s.addEventListener("touchmove",C=>{R&&(C.preventDefault(),C.stopPropagation())},{passive:!1}),s.addEventListener("wheel",C=>{R&&(C.preventDefault(),C.stopPropagation())},{passive:!1}),c.addEventListener("click",C=>{C.stopPropagation(),b<i.length-1?Mt(b+1):Rt()}),n.addEventListener("click",C=>{C.preventDefault(),Pt()}),{open:Pt,close:Rt,setCombosTemplate(C){typeof C=="string"&&(i[1].illustrationHtml=C.trim()||Oo,R&&b===1&&Mt(1))}}}var oc={tower_rotate:{strength:"light",durationMs:8,pattern:[8]},confirm:{strength:"medium",durationMs:20,pattern:[20]},cancel:{strength:"light",durationMs:12,pattern:[12]}};function ic(){let e=typeof globalThis<"u"?globalThis:null;return e?.webkit?.messageHandlers?.haptics?.postMessage?{type:"ios"}:e?.AndroidHaptics?.trigger?{type:"android"}:null}var Os=class{supports(){return typeof navigator<"u"&&typeof navigator.vibrate=="function"}trigger(n){if(!this.supports())return!1;let a=Array.isArray(n.pattern)?n.pattern:Number.isFinite(n.durationMs)?[n.durationMs]:null;return a?(navigator.vibrate(a),!0):!1}},Ds=class{constructor(n){this.bridge=n}supports(){return!0}trigger(n){try{if(this.bridge.type==="ios")return globalThis.webkit.messageHandlers.haptics.postMessage({name:n.name,strength:n.strength,durationMs:n.durationMs,pattern:n.pattern}),!0;if(this.bridge.type==="android")return globalThis.AndroidHaptics.trigger(n.name,n.strength,n.durationMs,n.pattern),!0}catch{}return!1}};function Ho({enabled:e=!0,patterns:n=oc}={}){let a=ic(),d=a?new Ds(a):new Os,i=d.supports(),s=!!e&&i;return{supports:()=>i,isEnabled:()=>s,setEnabled(c){s=!!c&&i},trigger(c){if(!s)return!1;let f=n[c];return f?d.trigger({name:c,...f}):!1}}}function Fo(e={}){let{buttons:n={},onActivate:a=null,onChange:d=null}=e,i={fire:3,water:3,lightning:3,earth:3},s=null;function c(){for(let[p,g]of Object.entries(n)){if(!g)continue;let r=i[p],m=g.querySelector(".charges");m&&(m.textContent=r),g.classList.toggle("empty",r<=0),g.classList.toggle("active",s===p&&r>0)}d&&d({...i},s)}function f(p){let g=n[p];g&&(g.classList.remove("pulse"),g.offsetWidth,g.classList.add("pulse"),setTimeout(()=>g.classList.remove("pulse"),400))}return{get charges(){return i},get active(){return s},set active(p){s=p},select(p){if(i[p]<=0)return!1;let g=s===p;return s=g?null:p,c(),!g&&s===p&&a&&a(),!g},useCharge(){if(!s||i[s]<=0)return!1;let p=s;return i[p]--,s=null,c(),f(p),!0},addCharges(p,g){i[p]!==void 0&&(i[p]+=g,c(),f(p))},canUse(){return s!==null&&i[s]>0},deactivate(){s=null,c()},reset(){i.fire=3,i.water=3,i.lightning=3,i.earth=3,s=null,c()},updateButtons:c,initButtons(p){for(let[g,r]of Object.entries(n))r&&r.addEventListener("click",()=>{p&&p(g)})}}}var tn={ice:{name:"Water",icon:"\u{1F4A7}",description:"Lowers the kill zone",cost:6,unlockRings:0,effect:{type:"lower_kz",duration:30}},air:{name:"Lightning",icon:"\u26A1",description:"Chain lightning - clears element in area",cost:8,unlockRings:25,effect:{type:"chain_lightning",areaSize:6,maxBlocks:8,jumpMs:180,flashMs:250,kzDropSecPerBlock:2}},earth:{name:"Earth",icon:"\u{1F33F}",description:"Transmutation - replaces element in area",cost:10,unlockRings:10,effect:{type:"transmutation",areaSize:6,maxBlocks:8,animSec:.4}},fire:{name:"Fire",icon:"\u{1F525}",description:"Cross beam - clears blocks in cross pattern",cost:12,unlockRings:40,effect:{type:"cross_beam",beamLength:4,animSec:.4}}};function $o(e={}){let{button:n=null,onActivate:a=null,onProgress:d=null,onReady:i=null}=e,s="ice",c=0;function f(){return tn[s]||tn.ice}function p({silent:r=!1}={}){if(!n||!n.classList.contains("spell-btn"))return;let m=f(),b=Number.isFinite(m.maxProgress)?m.maxProgress:0,R=b>0?Math.min(c/b,1)*100:0,X=b>0&&c>=b;n.style.setProperty("--progress",`${R}%`);let j=n.querySelector(".spell-icon");j&&(j.textContent=m.icon);let gt=n.querySelector(".spell-counter");gt&&(gt.textContent=b>0?`${Math.min(c,b)}/${b}`:""),n.classList.toggle("ready",X),n.classList.toggle("charging",!X&&c>0),d&&!r&&b>0&&d(c,b)}function g(){n&&(n.classList.remove("pulse"),n.offsetWidth,n.classList.add("pulse"),setTimeout(()=>n.classList.remove("pulse"),400))}return{get currentSpell(){return s},get progress(){return c},get maxProgress(){return f().maxProgress??0},get isReady(){let r=f().maxProgress;return Number.isFinite(r)&&r>0&&c>=r},get effect(){return f().effect},getUnlockRings(r){return(tn[r]||tn.ice).unlockRings??0},getCost(r){return(tn[r]||tn.ice).cost??0},getDescription(r){return(tn[r]||tn.ice).description||""},getEffect(r){return(tn[r]||tn.ice).effect},get button(){return n},selectSpell(r){tn[r]&&(s=r,c=0,p())},addProgress(r=1){let m=f();if(!Number.isFinite(m.maxProgress)||m.maxProgress<=0||c>=m.maxProgress)return!1;let b=c<m.maxProgress;return c=Math.min(c+r,m.maxProgress),p(),g(),b&&c>=m.maxProgress&&i&&i(),!0},setProgress(r,{silent:m=!1}={}){c=Math.max(0,r),p({silent:m})},canUse(){let r=f().maxProgress;return Number.isFinite(r)&&r>0&&c>=r},use(){if(!this.canUse())return null;let r=f().effect;return c=0,p(),g(),a&&a(s),r},reset(){c=0,p()},pulse(){g()},updateButton:p,initButton(r){n&&n.addEventListener("click",()=>{r&&r()})}}}function Hs({centerY:e,centerS:n,size:a,H:d,normSector:i}){let s=[],c=Math.floor(a/2);for(let f=-c;f<=c;f++)for(let p=-c;p<=c;p++){let g=e+f,r=i(n+p);if(g<0||g>=d)continue;let m=f*f+p*p;s.push({y:g,s:r,distSq:m})}return s}function ps(e,n,a){return n.filter(d=>e[d.y][d.s]===a)}function ms(e,n){return[...e].sort((d,i)=>d.distSq!==i.distSq?d.distSq-i.distSq:d.y!==i.y?d.y-i.y:d.s-i.s).slice(0,n).map(d=>({y:d.y,s:d.s}))}function No({centerY:e,centerS:n,beamLength:a,N:d,H:i,normSector:s}){if(e<0||e>=i||a<0||d<=0)return[];let c=[],f=new Set,p=(r,m)=>`${r},${m}`,g=s(n);c.push({y:e,s:g,dist:0}),f.add(p(e,g));for(let r=1;r<=a;r++){let m=s(n+r),b=p(e,m);f.has(b)||(c.push({y:e,s:m,dist:r}),f.add(b));let R=s(n-r),X=p(e,R);f.has(X)||(c.push({y:e,s:R,dist:r}),f.add(X))}for(let r=1;r<=a;r++){let m=s(n),b=e+r;if(b<i){let X=p(b,m);f.has(X)||(c.push({y:b,s:m,dist:r}),f.add(X))}let R=e-r;if(R>=0){let X=p(R,m);f.has(X)||(c.push({y:R,s:m,dist:r}),f.add(X))}}return c}function Go(e){let{canvas:n,dom:a,getGrid:d,getN:i,getH:s,getRotFloat:c,constants:f,helpers:p,Spell:g,Magic:r,SoundModule:m,State:b,isGamePlaying:R,addPendingKzDrop:X,getKillRate:j,triggerSpellWave:gt,spawnSpellBubbles:Ut,spawnBonusBubbles:ye,getTransmuteEffect:qt,getLightningEffect:Mt,getFireEffect:Vt,continueMatchProcessing:ot,updateScoreHud:z,showBonus:St,getSpellCost:Pt,getSpellElement:Rt,onUltimateApplied:C,isSpellBlocked:wt,setScore:Xt,setCascadeLevel:Tt}=e,{TOP_PAD_PX:l,BOTTOM_PAD_PX:tt,SIDE_MARGIN_PX:Z,MAX_RADIUS_X:oe,SCORE_MAGIC_DESTROY:N}=f,{normSector:V,levelYToScreenY:it,sectorCenterXY:Ot}=p,de=[{color:1,name:"fire",icon:"\u{1F525}"},{color:2,name:"water",icon:"\u{1F4A7}"},{color:3,name:"lightning",icon:"\u26A1"},{color:4,name:"earth",icon:"\u{1F33F}"}],K="idle",et=null,nt=null,Ct=[],Dt=[],ue=0,_t=null,zt=0,Y="idle",ie=null,we=[],ce=[],G=0,I=0,B="idle",A=null,k=[],h=[],P=0;function ct(y){if(typeof Pt!="function"||typeof Rt!="function")return!1;let _=Rt(y),S=Pt(y);return!_||!S?!1:(r.charges[_]??0)>=S}function xt(y){if(typeof Pt!="function"||typeof Rt!="function")return!1;let _=Rt(y),S=Pt(y);return!_||!S||(r.charges[_]??0)<S?!1:(r.charges[_]-=S,r.updateButtons(),g.pulse(),!0)}let Et=0,L=350;function M(){return typeof wt=="function"?wt():!1}function w(){let y=performance.now();y-Et<L||(Et=y,m.play("cancel"))}function jt(){K="selecting_source",et=null,nt=null,Ct=[],Dt=[],Y!=="idle"&&At(),B!=="idle"&&It(),r.deactivate(),m.play("ulta");let y=a.spellBtn;y&&y.classList.add("selecting")}function v(){K!=="idle"&&m.play("cancel"),K="idle",et=null,nt=null,Ct=[],Dt=[],Zt();let y=a.spellBtn;y&&y.classList.remove("selecting")}function te(y,_){if(K!=="selecting_source")return!1;if(M())return w(),!0;let S=q(y,_);if(!S)return v(),!0;let lt=d();et={y:S.y,s:S.s,color:lt[S.y][S.s]},Ct=Hs({centerY:S.y,centerS:S.s,size:qt().areaSize,H:s(),normSector:V});let at=et.color,Lt=ps(lt,Ct,at);return Dt=ms(Lt,qt().maxBlocks),dt(et.color,S.y),K="selecting_target",!0}function q(y,_){let S=n.clientWidth,lt=n.clientHeight,at=S*.5,Lt=(S-2*Z)/2,Jt=lt-l-tt,ee=6,be=s(),Je=i(),Ye=c(),We=Je*Jt/(ee*be),pe=lt-tt,Me,xe,Be;We<=Math.min(Lt,oe)?(Me=We,xe=Jt,Be=l):(Me=Math.min(Lt,oe),xe=Me*ee*be/Je,Be=pe-xe);let Ve=Me*.28,an=null,bn=1/0,rn=d();for(let Kt=0;Kt<be;Kt++){let nn=it(Be,xe,Kt+.5);for(let Fe=0;Fe<Je;Fe++){if(!rn[Kt][Fe])continue;let $e=Ot(at,nn,Me,Ve,Fe,Ye);if(Math.sin($e.ang)<-.1)continue;let re=y-$e.x,Mn=_-$e.y,Ae=Math.hypot(re,Mn),Ie=xe/be*.9,T=Ie*1.2;Math.abs(re)<T/2&&Math.abs(Mn)<Ie/2&&Ae<bn&&(bn=Ae,an={y:Kt,s:Fe})}}return an}function dt(y,_){Zt();let S=document.createElement("div");S.className="transmute-popup";let lt=n.clientWidth,at=n.clientHeight,Lt=(lt-2*Z)/2,Jt=at-l-tt,ee=6,be=s(),Je=i(),Ye=Je*Jt/(ee*be),We=at-tt,pe,Me;Ye<=Math.min(Lt,oe)?(pe=Jt,Me=l):(pe=Math.min(Lt,oe)*ee*be/Je,Me=We-pe);let xe=it(Me,pe,_+.5),Be=Math.floor(qt().areaSize/2),Ve=it(Me,pe,Math.min(be,_+Be)+.5),an=it(Me,pe,Math.max(0,_-Be)+.5),bn=Me+pe/2,rn=document.getElementById("gameContainer"),Kt=rn?rn.getBoundingClientRect():{width:window.innerWidth,left:0,top:0},nn=160,Fe=60,$e=20,hn=Kt.left+Kt.width/2-nn/2,re;xe<bn?re=Kt.top+an+$e:re=Kt.top+Ve-Fe-$e,re=Math.max(10,Math.min(window.innerHeight-Fe-10,re)),S.style.left=`${hn}px`,S.style.top=`${re}px`,de.filter(Ae=>Ae.color!==y).forEach(Ae=>{let Ie=document.createElement("button");Ie.className=`transmute-btn ${Ae.name}`,Ie.innerHTML=Ae.icon,Ie.setAttribute("data-color",Ae.color),Ie.addEventListener("click",T=>{T.stopPropagation(),se(Ae.color)}),S.appendChild(Ie)}),document.body.appendChild(S),_t=S,zt=performance.now(),setTimeout(()=>{document.addEventListener("pointerdown",Qt)},50)}function Qt(y){performance.now()-zt<200||_t&&!_t.contains(y.target)&&v()}function Zt(){document.removeEventListener("pointerdown",Qt),_t&&(_t.remove(),_t=null)}function se(y){if(M()){w();return}if(!ct(g.currentSpell)){w();return}if(Zt(),nt=y,Dt.length===0){v();return}ae()}function ae(){if(!et){v();return}if(Dt.length===0){v();return}if(!xt(g.currentSpell)){w(),v();return}let y=a.spellBtn;y&&y.classList.remove("selecting"),K="animating",ue=performance.now(),m.play("esseffect")}function Ue(){if(K!=="selecting_target"&&K!=="animating"||!et||!Ct||Ct.length===0)return;let y=d(),_=y[et.y]?.[et.s]??0;if(!_||_!==et.color){v();return}let S=ps(y,Ct,_),lt=qt().maxBlocks??S.length;Dt=ms(S,lt),Dt.length===0&&v()}function Yt(y){if(K!=="animating")return!1;let _=(y-ue)/1e3;return Math.min(_/qt().animSec,1)>=1?(Tn(),!1):!0}function He(y){if(K!=="animating")return null;let _=(y-ue)/1e3,S=Math.min(_/qt().animSec,1),lt="flash",at=0,Lt=0;return S<.15?(lt="flash",Lt=1-S/.15):S<.55?(lt="shrink",at=(S-.15)/.4):(lt="grow",at=(S-.55)/.45),{phase:lt,progress:at,areaFlash:Lt}}function Tn(){let y=d();for(let _ of Dt)y[_.y][_.s]=nt;K="idle",et=null,nt=null,Ct=[],Dt=[],Tt(1),ot(),typeof C=="function"&&C("earth")}function mt(){m.play("ulta"),Y="selecting_source",ie=null,we=[],ce=[],I=0,K!=="idle"&&(K="idle",et=null,nt=null,Ct=[],Dt=[],Zt()),B!=="idle"&&(B="idle",A=null,k=[],h=[],P=0),r.deactivate();let y=a.spellBtn;y&&y.classList.add("selecting")}function At(){Y!=="idle"&&m.play("cancel"),Y="idle",ie=null,we=[],ce=[],I=0;let y=a.spellBtn;y&&y.classList.remove("selecting")}function Se(){B="selecting_source",A=null,k=[],h=[],P=0,K!=="idle"&&(K="idle",et=null,nt=null,Ct=[],Dt=[],Zt()),Y!=="idle"&&(Y="idle",ie=null,we=[],ce=[],I=0),r.deactivate(),m.play("ulta");let y=a.spellBtn;y&&y.classList.add("selecting")}function It(){B!=="idle"&&m.play("cancel"),B="idle",A=null,k=[],h=[],P=0;let y=a.spellBtn;y&&y.classList.remove("selecting")}function _n(y,_){if(Y!=="selecting_source")return!1;if(M())return w(),!0;let S=q(y,_);if(!S)return At(),!0;let lt=d();ie={y:S.y,s:S.s,color:lt[S.y][S.s]},we=Hs({centerY:S.y,centerS:S.s,size:Mt().areaSize,H:s(),normSector:V});let at=ie.color,Lt=ps(lt,we,at);return ce=ms(Lt,Mt().maxBlocks),ce.length===0?(At(),!0):ct(g.currentSpell)?(Sn(),!0):(w(),!0)}function Qe(y,_){if(B!=="selecting_source")return!1;if(M())return w(),!0;let S=q(y,_);if(!S)return It(),!0;let lt=d();return A={y:S.y,s:S.s,color:lt[S.y][S.s]},k=No({centerY:S.y,centerS:S.s,beamLength:Vt().beamLength,N:i(),H:s(),normSector:V}),h=k.filter(at=>lt[at.y][at.s]).sort((at,Lt)=>at.dist-Lt.dist),h.length===0?(It(),!0):ct(g.currentSpell)?(fe(),!0):(w(),!0)}function Sn(){if(!ie||ce.length===0){At();return}if(!xt(g.currentSpell)){w(),At();return}let y=a.spellBtn;y&&y.classList.remove("selecting"),Y="animating",G=performance.now(),I=0,m.play("asseffect")}function U(y){if(Y!=="animating")return!1;let _=y-G,S=Mt().flashMs+ce.length*Mt().jumpMs;return _>=S?(Ht(),!1):!0}function Ee(y){if(Y!=="animating")return null;let _=y-G;if(_<Mt().flashMs)return{phase:"flash",flashProgress:1-_/Mt().flashMs,currentTarget:-1,jumpProgress:0,struckTargets:[]};let S=_-Mt().flashMs,lt=Math.floor(S/Mt().jumpMs),at=S%Mt().jumpMs/Mt().jumpMs,Lt=[];for(let Jt=0;Jt<Math.min(lt,ce.length);Jt++)Lt.push(Jt);return{phase:"chain",flashProgress:0,currentTarget:Math.min(lt,ce.length-1),jumpProgress:at,struckTargets:Lt}}function Ht(){let y=d(),_=ce.length,S=_*N;b.addScore(S),Xt(b.score),z(),St(`+${S}`,"score");for(let Jt of ce)y[Jt.y][Jt.s]=0;let lt=Mt(),at=Math.abs(lt.kzDropSecPerBlock??0),Lt=_*at;Lt>0&&typeof X=="function"&&typeof j=="function"&&(X(Lt*j()),St(`\u26A1 -${Lt}s`,"time")),Y="idle",ie=null,we=[],ce=[],I=0,Tt(1),ot(),typeof C=="function"&&C("air")}function fe(){if(!A||h.length===0){It();return}if(!xt(g.currentSpell)){w(),It();return}let y=a.spellBtn;y&&y.classList.remove("selecting"),B="animating",P=performance.now(),m.play("fsseffect")}function En(y){return B!=="animating"?!1:(y-P)/1e3>=Vt().animSec?(en(),!1):!0}function Xe(y){if(B!=="animating")return null;let _=Vt(),S=Math.max(.001,_.animSec),lt=(y-P)/1e3,at=Math.min(lt/S,1),Lt=.25,Jt=at<Lt?1-at/Lt:0,ee=.6,be=at<ee?at/ee*_.beamLength:_.beamLength;return{progress:at,flashProgress:Jt,beamLength:_.beamLength,beamReach:be}}function en(){let y=d(),_=h.length;if(_>0){let S=_*N;b.addScore(S),Xt(b.score),z(),St(`+${S}`,"score")}for(let S of h)y[S.y][S.s]=0;B="idle",A=null,k=[],h=[],P=0,Tt(1),ot(),typeof C=="function"&&C("fire")}function pn(){let y=typeof R=="function"?R():b.isPlaying(),_=g.currentSpell;if(!y)return!1;if(_==="ice"){if(M()||!ct(_)||!xt(g.currentSpell))return w(),!1;let S=g.effect;return typeof X=="function"&&typeof j=="function"&&X(S.duration*j()),m.play("wsseffect"),St(`\u{1F4A7} -${S.duration}s`,"time"),typeof gt=="function"&&gt(),typeof ye=="function"&&ye(S.duration),typeof C=="function"&&C(_),!0}return _==="earth"?K==="selecting_source"||K==="selecting_target"?(v(),!0):K!=="idle"||M()||!ct(_)?(w(),!1):(K==="idle"&&jt(),!0):_==="air"?Y==="selecting_source"?(At(),!0):Y!=="idle"||M()||!ct(_)?(w(),!1):(Y==="idle"&&mt(),!0):_==="fire"?B==="selecting_source"?(It(),!0):B!=="idle"||M()||!ct(_)?(w(),!1):(B==="idle"&&Se(),!0):!1}function Ze(y){Ue(),Yt(y),U(y),En(y)}function ht(y,_){return M()&&(K==="selecting_source"||Y==="selecting_source"||B==="selecting_source")?(w(),!0):K==="selecting_source"?te(y,_):Y==="selecting_source"?_n(y,_):B==="selecting_source"?Qe(y,_):!1}function ge(){K="idle",et=null,nt=null,Ct=[],Dt=[],Zt(),Y="idle",ie=null,we=[],ce=[],I=0,B="idle",A=null,k=[],h=[],P=0;let y=a.spellBtn;y&&y.classList.remove("selecting")}function mn(){return{transmuteState:K,transmuteSourceBlock:et,transmuteTargetColor:nt,transmuteAreaCells:Ct,transmuteBlocksToChange:Dt,lightningState:Y,lightningSourceBlock:ie,lightningAreaCells:we,lightningBlocksToHit:ce,fireState:B,fireSourceBlock:A,fireLineCells:k,fireTargets:h}}return{startTransmuteSourceSelection:jt,cancelTransmutation:v,startLightningSourceSelection:mt,cancelLightning:At,startFireSourceSelection:Se,cancelFire:It,handleTap:ht,update:Ze,reset:ge,getRenderState:mn,getTransmuteAnimState:He,getLightningAnimState:Ee,getFireAnimState:Xe,handleSpellButtonClick:pn,isTransmuteSelecting:()=>K==="selecting_source",isLightningSelecting:()=>Y==="selecting_source"}}var cc={PX_PER_STEP:12,DEADZONE_PX:5,PX_PER_DROP:17,AXIS_DOMINANCE:1.15,SWIPE_SPEED_REF:650,MIN_DROP_PX:6,MAX_DROP_PX:24,MIN_ROT_PX:8,MAX_ROT_PX:18,DROP_SWIPE_MIN_SPEED:450,DROP_SWIPE_MIN_DISTANCE:20,DOUBLE_TAP_MS:220,DOUBLE_TAP_MAX_DIST:15};function Uo(e={}){let{canvas:n}=e,a=e.rotDir||1,d=!1,i=0,s=0,c=0,f=0,p=0,g=1,r=null,m=0,b=0,R=0,X=0,j=0,gt=0,Ut=0,ye=0,qt=!1,Mt=!1,Vt=!1,ot=cc;return{get tapRotateEnabled(){return qt},set tapRotateEnabled(z){qt=z},get rotDir(){return a},set rotDir(z){a=z},get dragging(){return d},get dragMode(){return r},handlePointerDown(z,St,Pt){if(St.onMagicTap&&St.onMagicTap(z.clientX,z.clientY))return Mt=!0,!0;Mt=!1,Vt=!1;let Rt=performance.now(),C=Rt-gt,wt=z.clientX-Ut,Xt=z.clientY-ye,Tt=Math.hypot(wt,Xt);return C<=ot.DOUBLE_TAP_MS&&Tt<=ot.DOUBLE_TAP_MAX_DIST?(St.onDoubleTap&&St.onDoubleTap(),Vt=!0,gt=0):(gt=Rt,Ut=z.clientX,ye=z.clientY),d=!0,g=-1,i=z.clientX,s=z.clientY,c=Pt,f=0,p=0,r=null,m=Rt,b=z.clientX,R=z.clientY,X=m,j=0,n&&n.setPointerCapture(z.pointerId),!1},handlePointerMove(z,St,Pt,Rt){if(!d)return null;let C=z.clientX-i,wt=z.clientY-s,Xt=performance.now();if(Math.abs(C)<ot.DEADZONE_PX&&Math.abs(wt)<ot.DEADZONE_PX)return null;if(r){if(r==="rotate"){let l=Math.abs(C),tt=Math.abs(wt);if(tt>=l*ot.AXIS_DOMINANCE&&tt>=ot.DROP_SWIPE_MIN_DISTANCE){let Z=Math.max(1,Xt-m);tt/Z*1e3>=ot.DROP_SWIPE_MIN_SPEED&&(r="drop",p=0)}}}else{let l=Math.abs(C),tt=Math.abs(wt);if(wt<0)l>=ot.DEADZONE_PX&&(r="rotate");else if(tt>=l*ot.AXIS_DOMINANCE){if(tt>=ot.DROP_SWIPE_MIN_DISTANCE){let Z=Math.max(1,Xt-m);tt/Z*1e3>=ot.DROP_SWIPE_MIN_SPEED?r="drop":r="rotate"}}else l>=tt*ot.AXIS_DOMINANCE&&(r="rotate");if(!r)return null}let Tt=null;if(r==="rotate"&&Math.abs(C)>=ot.DEADZONE_PX){let l=Math.max(1,Xt-X),tt=z.clientX-b,Z=Math.max(1,Math.abs(tt)/l*1e3),oe=Math.max(ot.MIN_ROT_PX,Math.min(ot.MAX_ROT_PX,ot.PX_PER_STEP*(ot.SWIPE_SPEED_REF/Z)));j+=-tt/oe*a*g;let N=Math.trunc(j);N!==0&&(j-=N);let V=f+N;if(V!==f&&St.canRotateTo){let it=Math.sign(V-f),Ot=c+f;for(;f!==V;){let de=f+it,K=c+de;if(!St.canRotateTo(Math.floor(Pt),K))break;f=de,Ot=K,St.onRotateStep&&St.onRotateStep(),Rt&&St.onGroundedMove&&St.onGroundedMove()}Tt={targetRot:Ot,rotFloat:Ot}}}if(r==="drop"&&wt>=ot.DROP_SWIPE_MIN_DISTANCE&&St.onDrop){let l=Math.max(1,Xt-X),tt=z.clientY-R,Z=Math.max(1,tt/l*1e3),oe=Math.max(ot.MIN_DROP_PX,Math.min(ot.MAX_DROP_PX,ot.PX_PER_DROP*(ot.SWIPE_SPEED_REF/Z))),N=Math.trunc(wt/oe);if(N>p){let V=N-p;for(let it=0;it<V;it++)St.onDrop();p=N}}return b=z.clientX,R=z.clientY,X=Xt,Tt},handlePointerUp(z,St){if(d){if(qt&&!Mt&&!Vt&&!r&&St?.onSingleTap){let Pt=Math.abs(z.clientX-i),Rt=Math.abs(z.clientY-s),C=performance.now()-m;Pt<ot.DEADZONE_PX&&Rt<ot.DEADZONE_PX&&C<300&&St.onSingleTap()}if(d=!1,r=null,n&&z&&z.pointerId!==void 0)try{n.releasePointerCapture(z.pointerId)}catch{}}},reset(){d=!1,r=null,f=0,p=0,j=0}}}var Fs={lines3:0,lines4:0,lines5:0,pairs:0,rings:0,maxRing:0,magicUsed:0,combos:0,cascades:0,maxCombo:0,maxCascade:0};function Xo(){let e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs};return{get state(){return e},get score(){return n},get elapsedMs(){return d},get startTime(){return a},get stats(){return c},isPlaying(){return e==="playing"},isPaused(){return e==="paused"},isGameOver(){return e==="gameover"},isIntro(){return e==="intro"},start(){e="playing",n=0,a=performance.now(),d=0,i=0,s=0,c={...Fs}},pause(){return e!=="playing"?!1:(e="paused",i=performance.now(),!0)},resume(){return e!=="paused"?!1:(e="playing",i>0&&(s+=performance.now()-i,i=0),!0)},gameOver(){e="gameover"},toIntro(){e="intro"},addScore(f){n+=f},setScore(f){n=f},updateTime(){e==="playing"&&a>0&&(d=performance.now()-a-s)},getFormattedTime(){let f=Math.floor(d/1e3),p=Math.floor(f/60),g=f%60;return`${p}:${g.toString().padStart(2,"0")}`},incrementStat(f,p=1){f in c&&(c[f]+=p)},updateMaxStat(f,p){f in c&&p>c[f]&&(c[f]=p)},reset(){e="intro",n=0,a=0,d=0,i=0,s=0,c={...Fs}}}}function kn(e,n){return e%=n,e<0&&(e+=n),e}function Yo(e,n){return e[Math.min(n,e.length-1)]}function hs(e){let n=Math.max(0,Math.floor(e/1e3)),a=Math.floor(n/60),d=n%60;return`${a}:${d.toString().padStart(2,"0")}`}function Wo(e,n){let a=e.map(({x:f,y:p},g)=>({x:p,y:-f,color:n[g]})),d=1/0,i=-1/0,s=1/0;for(let f of a)d=Math.min(d,f.x),i=Math.max(i,f.x),s=Math.min(s,f.y);let c=Math.round((d+i)/2);for(let f of a)f.x-=c,f.y-=s;return a.sort((f,p)=>f.y-p.y||f.x-p.x),{cells:a.map(f=>({x:f.x,y:f.y})),colors:a.map(f=>f.color)}}function $s(e,n,a,d){let i=[];return e+1<a&&i.push({y:e+1,s:n}),e-1>=0&&i.push({y:e-1,s:n}),i.push({y:e,s:kn(n-1,d)}),i.push({y:e,s:kn(n+1,d)}),i}function Vo(e,n,a){let d=Array.from({length:n},()=>new Uint8Array(a)),i=[];for(let s=0;s<n;s++)for(let c=0;c<a;c++){if(!e[s][c]||d[s][c])continue;let f=[],p=[{y:s,s:c}];for(d[s][c]=1;p.length>0;){let g=p.shift();f.push(g);for(let r of $s(g.y,g.s,n,a))e[r.y][r.s]&&!d[r.y][r.s]&&(d[r.y][r.s]=1,p.push(r))}i.push(f)}return i}function Ko(e){return e.some(n=>n.y===0)}function Ns(e,n,a,d,i,s){if(!e)return!1;let c=kn(a,s);for(let f of e.cells){let p=n+f.y,g=kn(c+f.x,s);if(p<0)return!1;if(!(p>=i)&&d[p][g])return!1}return!0}function qo(e,n,a,d,i,s){if(!e)return null;let c=Math.floor(n);for(;Ns(e,c-1,a,d,i,s);)c-=1;return c}function zo(e,n,a){let d=[],i=[];for(let s=0;s<n;s++){let c=[],f=0,p=e[s][0],g=p?1:0;for(let r=1;r<=a;r++){let m=r<a?e[s][r]:0;m&&m===p?g++:(g>=1&&p&&c.push({start:f,length:g,color:p}),f=r,p=m,g=m?1:0)}if(c.length>=2){let r=c[0],m=c[c.length-1];if(r.start===0&&m.start+m.length===a&&r.color===m.color){let b=r.length+m.length;c[0]={start:m.start,length:b,color:r.color},c.pop()}}for(let r of c)if(r.length>=3){let m=[];for(let b=0;b<r.length;b++)m.push({y:s,s:(r.start+b)%a});d.push({color:r.color,length:r.length,cells:m})}}for(let s=0;s<a;s++){let c=0,f=e[0][s],p=f?1:0;for(let g=1;g<=n;g++){let r=g<n?e[g][s]:0;if(r&&r===f)p++;else{if(p>=3&&f){let m=[];for(let b=0;b<p;b++)m.push({y:c+b,s});d.push({color:f,length:p,cells:m})}c=g,f=r,p=r?1:0}}}for(let s=0;s<n;s++)for(let c=0;c<a;c++){let f=e[s][c],p=e[s][(c+1)%a],g=e[s][(c+2)%a],r=e[s][(c+3)%a];f&&f===p&&g&&g===r&&f!==g&&i.push({cells:[{y:s,s:c},{y:s,s:(c+1)%a},{y:s,s:(c+2)%a},{y:s,s:(c+3)%a}]})}for(let s=0;s<a;s++)for(let c=0;c<n-3;c++){let f=e[c][s],p=e[c+1][s],g=e[c+2][s],r=e[c+3][s];f&&f===p&&g&&g===r&&f!==g&&i.push({cells:[{y:c,s},{y:c+1,s},{y:c+2,s},{y:c+3,s}]})}return{lineMatches:d,pairMatches:i}}function jo(e,n,a){let d=[];for(let i=0;i<n;i++){let s=!0;for(let c=0;c<a;c++)if(!e[i][c]){s=!1;break}s&&d.push(i)}return d}function Qo(e,n){let a=new Map;e.forEach((d,i)=>a.set(`${d.x},${d.y}`,n[i]));for(let d=0;d<e.length;d++){let i=e[d],s=n[d],c=1;for(let gt=1;gt<=2&&a.get(`${i.x+gt},${i.y}`)===s;gt++)c++;if(c>=3)return!0;let f=1;for(let gt=1;gt<=2&&a.get(`${i.x},${i.y+gt}`)===s;gt++)f++;if(f>=3)return!0;let p=s,g=a.get(`${i.x+1},${i.y}`),r=a.get(`${i.x+2},${i.y}`),m=a.get(`${i.x+3},${i.y}`);if(p&&g&&r&&m&&p===g&&r===m&&p!==r)return!0;let b=s,R=a.get(`${i.x},${i.y+1}`),X=a.get(`${i.x},${i.y+2}`),j=a.get(`${i.x},${i.y+3}`);if(b&&R&&X&&j&&b===R&&X===j&&b!==X)return!0}return!1}function Zo(e){let{getN:n,getH:a,FALL_INTERVAL:d,LOCK_DELAY_SEC:i,getKillRate:s,MATCH_HIGHLIGHT_SEC:c,MAGIC_SHRINK_SEC:f,RING_HIGHLIGHT_SEC:p,getState:g,setState:r,funcs:m,ui:b}=e;return{get state(){return g().gameState},get score(){return g().score},get elapsedMs(){return g().elapsedMs},get stats(){return g().stats},get activePiece(){return g().activePiece},get pieceY(){return g().pieceY},get targetRot(){return g().targetRot},get isGrounded(){return g().isGrounded},get isHighlighting(){return g().isHighlighting},get killLevel(){return g().killLevel},get grid(){return g().grid},applyCommand(R,X={}){let j=g();if(R==="start_game")return j.gameState!=="playing"?(m.startGame(),!0):!1;if(j.gameState!=="playing")return!1;switch(R){case"rotate_piece":return m.rotatePieceByDir(),!0;case"move_down":return m.tryMoveDown();case"rotate_cylinder":{let{rot:gt}=X;return typeof gt=="number"&&m.canPlaceAtRot(Math.floor(j.pieceY),gt)?(r({targetRot:gt,rotFloat:gt,rotVel:0}),j.isGrounded&&m.maybeResetLockDelay(),!0):!1}case"magic_shoot":{let{x:gt,y:Ut}=X;return m.shootMagic(gt,Ut)}case"select_magic":{let{element:gt}=X;return m.selectMagic(gt),!0}default:return console.warn("GameEngine: unknown command",R),!1}},update(R,X){let j=g();if(j.gameState!=="playing")return;let gt=X-j.startTime-j.totalPausedMs;r({elapsedMs:gt}),b.updateTimeHud();let Ut=j.killLevel+s()*R;if(r({killLevel:Ut}),b.updateRemainingHud(),Ut>=a()){m.endGame();return}if(j.isHighlighting){let Mt=(X-j.highlightStartTime)/1e3,Vt;j.isRingAnimation?Vt=p:j.isMagicAnimation?Vt=f:Vt=c,Mt>=Vt&&(j.isRingAnimation?m.finishRingHighlight():m.finishHighlight())}let ye=j.fallTimer+R;if(ye>=d&&(ye-=d,m.tryMoveDown()),r({fallTimer:ye}),m.updateGroundedState()){let Mt=j.lockTimer+R;r({lockTimer:Mt}),Mt>=i&&m.lockPiece()}},reset(){m.startGame()},canRotateTo(R,X){return m.canPlaceAtRot(R,X)},getRotation(){let R=g();return{targetRot:R.targetRot,rotFloat:R.rotFloat,rotVel:R.rotVel}},setRotation(R){r({targetRot:R,rotFloat:R,rotVel:0})},onGroundedMove(){m.maybeResetLockDelay()}}}var je=Math.PI*2;function Jo(e){let{canvas:n,canvasCtx:a,getN:d,getH:i,TOP_PAD_PX:s,BOTTOM_PAD_PX:c,SIDE_MARGIN_PX:f,MAX_RADIUS_X:p,RADIUS_X_FACTOR:g,ANG_OFFSET:r,MATCH_HIGHLIGHT_SEC:m,MATCH_SHRINK_PHASE:b,MAGIC_SHRINK_SEC:R,RING_HIGHLIGHT_SEC:X,LOCK_DELAY_SEC:j,getKillRate:gt,ELEMENT_COLORS:Ut,ELEMENT_TO_COLOR:ye,BLOCK_COLOR_FRONT:qt,BLOCK_COLOR_BACK:Mt,ACTIVE_COLOR_FRONT:Vt,GHOST_COLOR_FILL:ot,GHOST_COLOR_STROKE:z,GHOST_STROKE_WIDTH:St,MAGIC_DIM_DOT_ALPHA:Pt,MAGIC_DIM_DOT_SCALE:Rt,MAGIC_TARGET_DOT_SCALE:C,getState:wt,getVisualSettings:Xt,funcs:Tt}=e,l=a,tt=d(),Z=i(),oe={cyan:{top:{r:180,g:230,b:230},bottom:{r:60,g:140,b:150}},green:{top:{r:200,g:230,b:150},bottom:{r:80,g:150,b:60}},blue:{top:{r:160,g:200,b:240},bottom:{r:60,g:100,b:180}},red:{top:{r:240,g:180,b:160},bottom:{r:160,g:60,b:50}}},N=[],V=40;function it(G,I,B,A,k){let h=Math.max(3,Math.round(G)),P=180;for(let ct=0;ct<h;ct++)setTimeout(()=>{let xt=Math.random()>.5?"left":"right",Et=15,L=xt==="left"?Et+Math.random()*Math.max(10,I-Et*2):B+Et+Math.random()*Math.max(10,k-B-Et*2),M=A-10;N.push({x:L,baseX:L,y:M,size:2+Math.random()*4,wobble:Math.random()*Math.PI*2,wobbleSpeed:.5+Math.random()*.5,wobbleAmp:4+Math.random()*5,minX:Et,maxX:k-Et})},ct*P)}function Ot(G,I,B){N=N.filter(A=>A.y>G+A.size&&A.y>-20);for(let A of N){A.y-=V*B,A.wobble+=A.wobbleSpeed*B;let k=A.baseX+Math.sin(A.wobble)*A.wobbleAmp;A.x=Math.max(A.minX,Math.min(A.maxX,k))}}function de(G){if(N.length!==0){l.fillStyle="rgba(255, 255, 255, 0.3)",l.strokeStyle="rgba(255, 255, 255, 0.5)",l.lineWidth=1;for(let I of N)I.y<G+I.size||(l.beginPath(),l.arc(I.x,I.y,I.size,0,Math.PI*2),l.fill(),l.stroke())}}let K={left:0,right:0,h:0,w:0};function et(G,I,B){let A=1-B/Z;return G+A*I}function nt(G){return G=G%tt,G<0?G+tt:G}function Ct(G,I,B,A,k,h){let P=nt(h),ct=(k-P)/tt*je+r;return{x:G+Math.cos(ct)*B,y:I+Math.sin(ct)*A,ang:ct}}let Dt=.52,ue=1.02;function _t(G,I,B,A,k,h){let P=nt(h),ct=(k-P)/tt*je+r;return{x:G+Math.cos(ct)*B,y:I+Math.sin(ct)*A,ang:ct}}function zt(G,I,B,A,k,h,P,ct=1){let xt=_t(G,I,B,A,k-Dt,h),Et=_t(G,I,B,A,k+Dt,h),L={x:xt.x,y:xt.y-P*.5},M={x:xt.x,y:xt.y+P*.5},w={x:Et.x,y:Et.y-P*.5},jt={x:Et.x,y:Et.y+P*.5},v=(L.x+w.x+jt.x+M.x)*.25,te=(L.y+w.y+jt.y+M.y)*.25,q=ue*ct,dt=ct,Qt=[L,w,jt,M].map(ae=>({x:v+(ae.x-v)*q,y:te+(ae.y-te)*dt})),Zt=Math.abs((Et.x-xt.x)*q),se=Math.abs(P*dt);return{corners:Qt,cx:v,cy:te,wApprox:Zt,hApprox:se,ang:_t(G,I,B,A,k,h).ang}}function Y(G,I,B,A,k,h,P,ct,xt=1,Et=null,L=1,M=null,w=0,jt=1,v=1){let te=zt(G,I,B,A,k,h,P,v),[q,dt,Qt,Zt]=te.corners;if(l.save(),l.globalAlpha=xt,l.fillStyle=ct,l.beginPath(),l.moveTo(q.x,q.y),l.lineTo(dt.x,dt.y),l.lineTo(Qt.x,Qt.y),l.lineTo(Zt.x,Zt.y),l.closePath(),l.fill(),M&&w>0&&(l.strokeStyle=M,l.lineWidth=w,l.stroke()),Et){let se=Math.min(te.wApprox,te.hApprox)*.28*jt;l.globalAlpha=xt*L,l.fillStyle=Et,l.beginPath(),l.arc(te.cx,te.cy,se,0,je),l.fill()}l.restore(),l.globalAlpha=1}function ie(G,I,B,A,k,h){let P=Ct(G,I,B,A,k,h),ct=Ct(G,I,B,A,k+1,h),xt=Ct(G,I,B,A,k-1,h),Et=Math.abs(ct.x-P.x),L=Math.abs(P.x-xt.x),M=(Et+L)*.5*1.06;return Math.max(1,M)}function we(G,I,B,A,k,h){let P=(k-h)/tt*je+r;return{x:G+Math.cos(P)*B,y:I+Math.sin(P)*A,ang:P}}function ce(G,I,B,A,k,h,P,ct=1,xt=null,Et=1,L=null,M=0,w=1){l.save(),l.translate(G,I);let jt=Math.atan2(A,B);if(l.rotate(jt),l.globalAlpha=ct,l.fillStyle=P,l.fillRect(-k/2,-h/2,k,h),L&&M>0&&(l.strokeStyle=L,l.lineWidth=M,l.strokeRect(-k/2,-h/2,k,h)),xt){let v=Math.min(k,h)*.28*w;l.globalAlpha=ct*Et,l.fillStyle=xt,l.beginPath(),l.arc(0,0,v,0,je),l.fill()}l.restore(),l.globalAlpha=1}return{resize(){let G=Math.max(1,Math.min(2,window.devicePixelRatio||1)),I=Math.floor(n.clientWidth*G),B=Math.floor(n.clientHeight*G);(n.width!==I||n.height!==B)&&(n.width=I,n.height=B,l.setTransform(G,0,0,G,0,0))},render(G=.016,I=performance.now()){this.resize();let B=wt();tt=d(),Z=i();let A=n.clientWidth,k=n.clientHeight;l.clearRect(0,0,A,k),l.fillStyle="#0b0f14",l.fillRect(0,0,A,k);let h=A*.5,P=(A-2*f)/2,ct=k-s-c,xt=6,Et=tt*ct/(xt*Z),L,M,w,jt;jt=k-c,Et<=Math.min(P,p)?(L=Et,M=ct,w=s):(L=Math.min(P,p),M=L*xt*Z/tt,w=jt-M);let v=L*.28,{killLevel:te,rotFloat:q,grid:dt,gameState:Qt}=B,Zt=Xt?Xt():{},se=Zt.waterColor||"blue",ae=Zt.waterBubbles||!1,Ue=oe[se]||oe.blue,Yt=et(w,M,te),He=.7,Tn=te/Z,mt={...Ue.top},At={...Ue.bottom};if(Tn>He){let T=(Tn-He)/(1-He);mt.r=Math.round(mt.r+(255-mt.r)*T*.5),mt.g=Math.round(mt.g+(150-mt.g)*T*.5),mt.b=Math.round(mt.b+(150-mt.b)*T*.5),At.r=Math.round(At.r+(180-At.r)*T),At.g=Math.round(At.g*(1-T*.6)),At.b=Math.round(At.b*(1-T*.6))}let Se=h-L-8,It=h+L+8,_n=w,Qe=jt+5,Sn=l.createLinearGradient(0,Yt,0,k);Sn.addColorStop(0,`rgba(${mt.r},${mt.g},${mt.b},0.5)`),Sn.addColorStop(1,`rgba(${At.r},${At.g},${At.b},0.7)`),l.fillStyle=Sn;let U=Math.round((mt.r+At.r)/2),Ee=Math.round((mt.g+At.g)/2),Ht=Math.round((mt.b+At.b)/2),fe=L+8,En=v+4;l.fillRect(0,Yt,Se,k-Yt),l.fillRect(It,Yt,A-It,k-Yt),l.beginPath();let Xe=Math.max(Yt,Qe);l.moveTo(Se,Xe),Yt<=Qe+En?l.ellipse(h,Qe,fe,En,0,Math.PI,0,!1):l.lineTo(It,Xe),l.lineTo(It,k),l.lineTo(Se,k),l.closePath(),l.fill(),l.strokeStyle="rgba(100,180,255,0.6)",l.lineWidth=3,l.lineCap="round",l.beginPath(),l.moveTo(Se,_n),l.lineTo(Se,Qe),l.stroke(),l.beginPath(),l.moveTo(It,_n),l.lineTo(It,Qe),l.stroke(),l.beginPath(),l.ellipse(h,Qe,L+8,v+4,0,0,Math.PI),l.stroke(),l.fillStyle="#0b0f14",l.beginPath(),l.ellipse(h,Qe,L+8,v+4,0,0,je),l.fill(),te>.5&&(l.strokeStyle=`rgba(${Math.min(255,U+60)},${Math.min(255,Ee+40)},${Math.min(255,Ht+40)},0.6)`,l.lineWidth=2,l.beginPath(),l.moveTo(0,Yt),l.lineTo(Se,Yt),l.moveTo(It,Yt),l.lineTo(A,Yt),l.stroke()),K={left:Se,right:It,h:k,w:A},(N.length>0||ae)&&(Ot(Yt,k,G),de(Yt)),l.strokeStyle="rgba(160,190,220,0.3)",l.lineWidth=1;let en=je*L,pn=10,Ze=en/pn*.7,ht=en/pn*.3;l.setLineDash([Ze,ht]);let ge=en/tt;l.lineDashOffset=nt(q)*ge;for(let T=0;T<=Z;T++){let F=et(w,M,T);l.beginPath(),l.ellipse(h,F,L,v,0,0,je),l.stroke()}l.setLineDash([]);let mn=[],y=[];for(let T=0;T<Z;T++){let F=et(w,M,T+.5);for(let J=0;J<tt;J++){let O=dt[T][J];if(!O)continue;let Q=Ct(h,F,L,v,J,q),D=Math.sin(Q.ang),H={y:T,s:J,yScr:F,p:Q,depth:D,color:O};D<-.1?mn.push(H):y.push(H)}}let _=Tt.getMagicTargetColor(),{isHighlighting:S,highlightedCells:lt,highlightStartTime:at,isMagicAnimation:Lt}=B,Jt=null,ee=1,be=1,Je=!1;if(S&&lt.length>0){Jt=new Set(lt.map(F=>`${F.y},${F.s}`));let T=(performance.now()-at)/1e3;if(Lt){let F=Math.min(1,T/R);ee=1-F*.85,be=1-F*.9,Je=!0}else{let F=Math.min(1,T/m),J=1-b;if(F>J){let O=(F-J)/b;ee=1-O*.85,be=1-O*.9,Je=!0}}}mn.sort((T,F)=>T.depth-F.depth);for(let T of mn){let F=M/Z*.9,J=Ut[T.color]||null,O=.35,Q=1,D=`${T.y},${T.s}`;Jt&&Jt.has(D)&&(O*=be,Q=ee),Y(h,T.yScr,L,v,T.s,q,F,Mt,O,J,.5,null,0,1,Q)}let{isRingAnimation:Ye}=B;if(S&&lt.length>0&&!Lt){let T=(performance.now()-at)/1e3,J=Math.min(1,T/(Ye?X:m)),O=1-b,Q=J>O,D=Q?(J-O)/b:0,H=Ye?Math.floor(J*O*tt*2)%tt:-1,x=4+J/O*10,W=Math.sin(T*x*je),ut=Q?1:.3+W*.3,vt=Q?1-D*.8:1,Bt=Q?1-D:1;for(let yt of lt){let Ft=et(w,M,yt.y+.5),Re=_t(h,Ft,L,v,yt.s,q);if(Math.sin(Re.ang)>=-.1)continue;let xn=M/Z*.9,ne,le,Pe;if(Ye){let Ke=(yt.s-H+tt)%tt,dn=Ke<3?1-Ke/3:0;ne=(Q?Bt:.2+dn*.5)*.5,le=`rgba(255, 159, 67, ${ne})`,Pe=Q?vt:1+dn*.15}else ne=ut*Bt,le=yt.isLine?`rgba(255, 255, 255, ${ne*.5})`:`rgba(255, 220, 100, ${ne*.4})`,Pe=Q?vt:1.1;Y(h,Ft,L,v,yt.s,q,xn,le,1,null,1,null,0,1,Pe)}}y.sort((T,F)=>T.depth-F.depth);for(let T of y){let F=M/Z*.9,J=Ut[T.color]||null,O=1,Q=1,D=1,H=1,x=`${T.y},${T.s}`,W=Jt&&Jt.has(x);W&&(O=be,Q=ee),_!==null&&!W&&(T.color!==_?(D=Pt,H=Rt):H=C),Y(h,T.yScr,L,v,T.s,q,F,qt,O,J,D,null,0,H,Q)}if(S&&lt.length>0&&!Lt){let T=(performance.now()-at)/1e3,J=Math.min(1,T/(Ye?X:m)),O=1-b,Q=J>O,D=Q?(J-O)/b:0,H=Ye?Math.floor(J*O*tt*2)%tt:-1,x=4+J/O*10,W=Math.sin(T*x*je),ut=Q?1:.5+W*.5,vt=Q?1-D*.8:1,Bt=Q?1-D:1;for(let yt of lt){let Ft=et(w,M,yt.y+.5),Re=_t(h,Ft,L,v,yt.s,q);if(Math.sin(Re.ang)<-.1)continue;let xn=M/Z*.9,ne,le,Pe;if(Ye){let Ke=(yt.s-H+tt)%tt,dn=Ke<4?1-Ke/4:0;ne=Q?Bt:.3+dn*.7,le=`rgba(255, 159, 67, ${ne})`,Pe=Q?vt:1+dn*.2}else ne=ut*Bt,le=yt.isLine?`rgba(255, 255, 255, ${ne*.7})`:`rgba(255, 220, 100, ${ne*.6})`,Pe=Q?vt:1.15;Y(h,Ft,L,v,yt.s,q,xn,le,1,null,1,null,0,1,Pe)}}let We=B.spellState||B,{transmuteState:pe,transmuteSourceBlock:Me,transmuteTargetColor:xe,transmuteAreaCells:Be,transmuteBlocksToChange:Ve}=We;if(pe==="selecting_source"){let T=M/Z*.9,F=.35+Math.sin(I/150)*.15;for(let J of y){let O=et(w,M,J.y+.5);Y(h,O,L,v,J.s,q,T,`rgba(0, 40, 20, ${F})`,1,null,1,null,0,1,1)}}if(pe==="selecting_target"&&Ve&&Ve.length>0){let T=M/Z*.9,F=.4+Math.sin(I/120)*.25,J=.6+Math.sin(I/120)*.4;for(let O of Ve){if(O.y<0||O.y>=Z)continue;let Q=et(w,M,O.y+.5),D=_t(h,Q,L,v,O.s,q);Math.sin(D.ang)<-.1||(Y(h,Q,L,v,O.s,q,T,`rgba(0, 50, 30, ${F})`,1,null,1,null,0,1,1),Y(h,Q,L,v,O.s,q,T,"transparent",1,null,1,`rgba(100, 255, 150, ${J})`,3,1,1.02))}}if(pe==="animating"&&Tt.getTransmuteAnimState){let T=Tt.getTransmuteAnimState(I);if(T){let F=M/Z*.9,{phase:J,progress:O,areaFlash:Q}=T;if(Q>0&&Be)for(let D of Be){if(D.y<0||D.y>=Z)continue;let H=et(w,M,D.y+.5),x=_t(h,H,L,v,D.s,q);Math.sin(x.ang)<-.1||Y(h,H,L,v,D.s,q,F,`rgba(150, 255, 200, ${Q*.4})`,1,null,1,null,0,1,1)}if(Ve&&Ve.length>0){let D=Me?Me.color:1,H=xe||1;for(let x of Ve){if(x.y<0||x.y>=Z)continue;let W=et(w,M,x.y+.5),ut=_t(h,W,L,v,x.s,q);if(Math.sin(ut.ang)<-.1)continue;let Bt=1,yt=Ut[D],Ft=0;if(J==="shrink"?(Bt=1-O*.95,yt=Ut[D],Ft=.5+O*.3):J==="grow"&&(Bt=O,yt=Ut[H],Ft=.8-O*.5),Ft>0&&Y(h,W,L,v,x.s,q,F,`rgba(200, 255, 220, ${Ft})`,1,null,1,null,0,1,1),Bt>.05){let Re=zt(h,W,L,v,x.s,q,F,1),ln=Math.min(Re.wApprox,Re.hApprox)*.28*Bt;l.save(),l.globalAlpha=1,l.fillStyle=yt,l.beginPath(),l.arc(Re.cx,Re.cy,ln,0,je),l.fill(),l.restore()}}}}}let{lightningState:an,lightningSourceBlock:bn,lightningAreaCells:rn,lightningBlocksToHit:Kt}=We;if(an==="selecting_source"){let T=M/Z*.9,F=.35+Math.sin(I/150)*.15;for(let J of y){let O=et(w,M,J.y+.5);Y(h,O,L,v,J.s,q,T,`rgba(20, 20, 60, ${F})`,1,null,1,null,0,1,1)}}if(an==="animating"&&Tt.getLightningAnimState){let T=Tt.getLightningAnimState(I);if(T&&Kt&&Kt.length>0){let F=M/Z*.9,{phase:J,flashProgress:O,currentTarget:Q,jumpProgress:D,struckTargets:H}=T;if(J==="flash"&&O>0&&rn)for(let x of rn){if(x.y<0||x.y>=Z)continue;let W=et(w,M,x.y+.5),ut=_t(h,W,L,v,x.s,q);Math.sin(ut.ang)<-.1||Y(h,W,L,v,x.s,q,F,`rgba(100, 150, 255, ${O*.5})`,1,null,1,null,0,1,1)}if(H&&H.length>0)for(let x of H){let W=Kt[x];if(!W||W.y<0||W.y>=Z)continue;let ut=et(w,M,W.y+.5),vt=_t(h,ut,L,v,W.s,q);if(Math.sin(vt.ang)<-.1)continue;let yt=(H.length-1-H.indexOf(x))*.1,Ft=Math.max(0,.8-yt);Y(h,ut,L,v,W.s,q,F,`rgba(255, 255, 255, ${Ft})`,1,null,1,`rgba(150, 200, 255, ${Ft})`,2,1,1.05)}if(J==="chain"&&Q>=0&&Q<Kt.length){let x=Kt[Q];if(x&&x.y>=0&&x.y<Z){let W=et(w,M,x.y+.5),ut=_t(h,W,L,v,x.s,q);if(Math.sin(ut.ang)>=-.1){let Bt=1-D;Y(h,W,L,v,x.s,q,F,`rgba(200, 220, 255, ${Bt*.9})`,1,null,1,`rgba(100, 180, 255, ${Bt})`,3,1,1.1-D*.05)}}if(Q>0){let W=Kt[Q-1],ut=Kt[Q];if(W&&ut){let vt=et(w,M,W.y+.5),Bt=et(w,M,ut.y+.5),yt=zt(h,vt,L,v,W.s,q,F,1),Ft=zt(h,Bt,L,v,ut.s,q,F,1);l.save(),l.strokeStyle=`rgba(150, 200, 255, ${1-D*.5})`,l.lineWidth=2+(1-D)*2,l.lineCap="round",l.beginPath();let Re=yt.cx,ln=yt.cy,xn=Ft.cx,ne=Ft.cy;l.moveTo(Re,ln);let le=4;for(let Pe=1;Pe<=le;Pe++){let Ke=Pe/le,dn=Re+(xn-Re)*Ke,vs=ln+(ne-ln)*Ke,Kn=Pe<le?(Math.random()-.5)*8:0;l.lineTo(dn+Kn,vs+Kn)}l.stroke(),l.strokeStyle=`rgba(100, 150, 255, ${(1-D)*.3})`,l.lineWidth=6,l.stroke(),l.restore()}}}}}let{fireState:nn,fireSourceBlock:Fe,fireLineCells:$e,fireTargets:hn}=We;if(nn==="selecting_source"){let T=M/Z*.9,F=.3+Math.sin(I/140)*.2;for(let J of y){let O=et(w,M,J.y+.5);Y(h,O,L,v,J.s,q,T,`rgba(70, 25, 10, ${F})`,1,null,1,null,0,1,1)}}if(nn==="animating"&&Tt.getFireAnimState){let T=Tt.getFireAnimState(I);if(T&&$e&&$e.length>0){let F=M/Z*.9,{progress:J,flashProgress:O}=T,Q=Math.sin(J*Math.PI);if(O>0)for(let D of $e){if(D.y<0||D.y>=Z)continue;let H=et(w,M,D.y+.5),x=_t(h,H,L,v,D.s,q);Math.sin(x.ang)<-.1||Y(h,H,L,v,D.s,q,F,`rgba(255, 120, 50, ${O*.45})`,1,null,1,`rgba(255, 200, 140, ${O*.5})`,2,1,1.03)}if(Fe){let D=new Map;for(let x of $e){if(x.y<0||x.y>=Z)continue;let W=et(w,M,x.y+.5),ut=_t(h,W,L,v,x.s,q);if(Math.sin(ut.ang)<-.1)continue;let Bt=zt(h,W,L,v,x.s,q,F,1),yt=x.s-Fe.s;yt>tt/2&&(yt-=tt),yt<-tt/2&&(yt+=tt);let Ft=x.y;D.has(Ft)||D.set(Ft,[]),D.get(Ft).push({x:Bt.cx,y:Bt.cy,offset:yt})}let H=Array.from(D.keys()).sort((x,W)=>W-x);if(H.length>0){let x=.35+.3*Math.sin(I/60)+Q*.2;l.save(),l.lineCap="round";for(let W of H){let ut=D.get(W)||[];if(ut.sort((vt,Bt)=>vt.offset-Bt.offset),ut.length!==0){l.beginPath(),l.moveTo(ut[0].x,ut[0].y);for(let vt=1;vt<ut.length;vt++)l.lineTo(ut[vt].x,ut[vt].y);l.strokeStyle=`rgba(255, 140, 60, ${x})`,l.lineWidth=Math.max(2,F*.15),l.stroke(),l.strokeStyle=`rgba(255, 210, 140, ${x*.35})`,l.lineWidth=Math.max(6,F*.35),l.stroke()}}l.restore()}}if(hn&&hn.length>0){let D=.2+Q*.6;for(let H of hn){if(H.y<0||H.y>=Z)continue;let x=et(w,M,H.y+.5),W=_t(h,x,L,v,H.s,q);Math.sin(W.ang)<-.1||Y(h,x,L,v,H.s,q,F,`rgba(255, 160, 70, ${D})`,1,null,1,`rgba(255, 230, 180, ${Q*.6})`,2,1,1.05)}}}}let{activePiece:re,pieceY:Mn,isGrounded:Ae,lockTimer:Ie}=B;if(re){let T=Tt.snappedRot(),F=T,J=Tt.computeGhostY(),O=M/Z*.9;if(J!==null){let H=[];for(let x=0;x<re.cells.length;x++){let W=re.cells[x],ut=re.colors[x],vt=J+W.y,Bt=Tt.normSector(T+W.x);if(vt<0||vt>=Z)continue;let yt=et(w,M,vt+.5),Ft=_t(h,yt,L,v,Bt,F);H.push({cy:vt,cs:Bt,yScr:yt,depth:Math.sin(Ft.ang),color:ut})}H.sort((x,W)=>x.depth-W.depth);for(let x of H){let W=Ut[x.color]||null;Y(h,x.yScr,L,v,x.cs,F,O,ot,1,W,.5,z,St,1,1)}}let Q=Vt;if(Ae&&Ie>0){let H=Math.min(1,Ie/j),x=255,W=Math.round(170+85*H),ut=Math.round(180+75*H),vt=.75+(1-.75)*H;Q=`rgba(${x},${W},${ut},${vt})`}let D=[];for(let H=0;H<re.cells.length;H++){let x=re.cells[H],W=re.colors[H],ut=Tt.normSector(T+x.x),vt=Mn+x.y;if(vt<0||vt>=Z)continue;let Bt=et(w,M,vt+.5),yt=_t(h,Bt,L,v,ut,F);D.push({cs:ut,yScr:Bt,depth:Math.sin(yt.ang),color:W})}D.sort((H,x)=>H.depth-x.depth);for(let H of D){let x=Ut[H.color]||null;Y(h,H.yScr,L,v,H.cs,F,O,Q,1,x,1,null,0,1,1)}}},drawNextPreview(G,I){if(!G)return;let B=G.getContext("2d"),A=G.width,k=G.height;if(B.clearRect(0,0,A,k),!I)return;let h=1/0,P=-1/0,ct=1/0,xt=-1/0;for(let v of I.cells)h=Math.min(h,v.x),P=Math.max(P,v.x),ct=Math.min(ct,v.y),xt=Math.max(xt,v.y);let Et=P-h+1,L=xt-ct+1,M=Math.min(A/(Et+.5),k/(L+.5)),w=(A-Et*M)/2,jt=(k-L*M)/2;B.fillStyle=qt;for(let v=0;v<I.cells.length;v++){let te=I.cells[v],q=w+(te.x-h)*M,dt=jt+(L-1-(te.y-ct))*M;B.fillRect(q+1,dt+1,M-2,M-2);let Qt=I.colors[v],Zt=Ut[Qt];if(Zt){let se=(M-2)*.32;B.fillStyle=Zt,B.beginPath(),B.arc(q+M/2,dt+M/2,se,0,je),B.fill(),B.fillStyle=qt}}},spawnBonusBubbles(G){let{left:I,right:B,h:A,w:k}=K;k>0&&it(G,I,B,A,k)}}}(()=>{let e=Ao(),n=e.canvas,a=n.getContext("2d");n.style.touchAction="none",document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault());let d=Math.PI*2,i=30,s=24,c=120,f={"30_24":{N:30,H:24,survivalTime:60,name:"High Tower"},"25_20":{N:25,H:20,survivalTime:120,name:"Quick Tower"}};function p(t){let o=f[t]||f["30_24"];i=o.N,s=o.H,c=o.survivalTime}function g(){return s/c}let r=Math.PI/2,m=70,b=120,R=30,X=320,j=.42,gt="rgb(235,240,250)",Ut="rgb(55,62,75)",ye="rgba(255,170,180,0.75)",qt="rgba(110,255,150,0.15)",Mt="rgba(110,255,150,0.85)",Vt=2,ot={1:"#ff4d4d",2:"#4da6ff",3:"#ffd84d",4:"#47d16a"},z={1:"fire",2:"water",3:"lightning",4:"earth"},St={fire:1,water:2,lightning:3,earth:4},Pt=1,Rt=.58,C=!0,wt=12,Xt=25,Tt=1,l=2,tt=3,Z=1,oe={fire:1,water:1,lightning:1,earth:1},N=5,V=7,it=10,Ot=3,de=50,K=2,et=.3,nt=.5,Ct=1,Dt=.3,ue=.5,_t=1.3,zt=10,Y=1e3,ie=[1,1.25,1.5,1.75,2],we=10,ce=20,G=5,I=[1,1.3,1.6,2,2.4,2.8],B=[1,1.1,1.2,1.3,1.4,1.5],A=[1,1.5,2,2.5,3,3.5],k=[1,1.3,1.6,2,2.4,2.8],h=wo(),P=h.loadGameSettings();P.hapticsEnabled===void 0&&(P.hapticsEnabled=!0);let ct=P.invertSwipe?-1:1,xt=P.showControls!==!1,Et=P.tapRotate===!0,M=!1,w=-1,jt=Ho({enabled:P.hapticsEnabled}),v=Array.from({length:s},()=>new Uint8Array(i));function te(){v=Array.from({length:s},()=>new Uint8Array(i))}let q=[{name:"F",cells:[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]},{name:"I",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{name:"L",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:0}]},{name:"P",cells:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]},{name:"N",cells:[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:1,y:3}]},{name:"T",cells:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}]},{name:"U",cells:[{x:0,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}]},{name:"V",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{name:"W",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}]},{name:"X",cells:[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}]},{name:"Y",cells:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:1,y:1}]},{name:"Z",cells:[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}]}],dt=null,Qt=s+3,Zt=0,se=0,ae=!1,Ue=0,Yt=0,He=0,Tn=3,mt=0,At=0,Se=0,It=Uo({canvas:n,rotDir:ct}),_n="0.17.12",Qe=!0,Sn="blue",U=To();U.preload();let Ee=Xo(),Ht="intro",fe=0,En=0,Xe=0,en=0,pn=0,Ze=null,ht=Ee.stats,ge=0,mn=e.overlay,y=e.gameContainer,_=Po({elementColors:ot}),S=_.showBonus.bind(_),lt=_.getElementIcon.bind(_),at=ko(),Lt=e.overlayTitle,Jt=e.overlayStats,ee=e.startBtn,be=e.hud,Je=e.scoreHud,Ye=e.timeHud,We=e.remainingHud,pe=e.nextCanvas,Me=pe.getContext("2d"),xe=e.pauseBtn,Be=e.pauseOverlay,Ve=e.resumeBtn,an=e.restartBtn,bn=e.exitToMenuBtn,rn=e.pauseSettingsBtn,Kt=e.pauseSoundBtn,nn=e.pauseMusicBtn,Fe=e.pauseBestScore,$e=e.pauseBestTime,hn=e.pauseBestMode,re=e.pauseCurrentScore,Mn=e.pauseCurrentTime,Ae=e.pauseCurrentMode,Ie=e.confirmDialog,T=e.confirmText,F=e.confirmCancel,J=e.confirmOk,O=e.settingsOverlay,Q=e.settingsClose,D=e.fullscreenBtn,H=e.rotateBtn,x=e.startPanel,W=e.gameoverPanel,ut=e.goScore,vt=e.goTime,Bt=e.goRing,yt=e.goMatches,Ft=e.goBonuses,Re=e.goNewRecord,ln=e.goRestartBtn,xn=e.goExitBtn,ne=e.bestScore,le=e.bestTimeVal,Pe=e.startVersion,Ke=e.modeBtns,dn=e.recordsBtn,vs=e.startSettingsBtn,Kn=e.helpBtn;Do({helpBtn:Kn});let Ce="25_20";function ti(t){if(!Number.isFinite(t)||t<=0)return"";let o=t/60;return Number.isInteger(o)?`${o} min`:`${o.toFixed(1)} min`}function ei(){document.querySelectorAll(".mode-btn[data-mode]").forEach(o=>{let u=o.dataset.mode,E=f[u];if(!E)return;let $=o.querySelector(".mode-tag.time-tag");if(!$)return;let st=ti(E.survivalTime);st&&($.textContent=st)})}ei();let rt=Fo({buttons:e.magicBtns,onActivate:()=>U.play("spells"),onChange:(t,o)=>{Es()}}),Ln=e.magicBtns,rc=rt.charges,ni=t=>ke()?rt.select(t):!1,On=()=>rt.updateButtons(),Gs=e.magicRow,Wt=e.magicActiveIndicator,Us=e.magicActiveIcon,Xs=e.magicActiveCost,si={ice:"water",air:"lightning",earth:"earth",fire:"fire"},ys={fire:"fire",water:"ice",lightning:"air",earth:"earth"},oi=["ice","earth","air","fire"];ge=h.loadHighTowerRings();function Dn(t){return typeof me?.getUnlockRings=="function"?me.getUnlockRings(t):0}function qn(t){let o=Dn(t);return o===0||ge>=o}let Ys=["fire","water","lightning","earth"],Bn=null,zn=!1,ii=500,ci=30,ai=220,Rn=null,Ss=null,Ws={fire:!1,water:!1,lightning:!1,earth:!1};function Vs(){if(!Wt)return;let t=Wt.getBoundingClientRect();t.width>0&&t.height>0&&(Ss=t)}function ri(){if(!Wt)return null;let t=Wt.getBoundingClientRect();return t.width>0&&t.height>0?Wt:Ss?{getBoundingClientRect:()=>Ss}:null}function Hn(t=rt.active){if(!Wt||!Us)return;t?(Bn=t,zn=!1):zn||(Bn=null);let o=Bn;if(!o||!ke()||(rt.charges[o]??0)<=0){Vs(),Wt.classList.add("hidden"),Wt.classList.remove("active","ult-ready",...Ys),Wt.style.setProperty("--progress","0%"),Rn&&clearTimeout(Rn),Rn=setTimeout(()=>{Wt.classList.add("gone")},ai);return}Rn&&(clearTimeout(Rn),Rn=null),Wt.classList.remove("gone"),Wt.classList.contains("hidden")?requestAnimationFrame(()=>Wt.classList.remove("hidden")):Wt.classList.remove("hidden"),Us.textContent=lt(o);let E=ys[o];E&&me.selectSpell(E);let $=E?$n(E):0,st=rt.charges[o]??0,pt=!!E&&Zn()&&qn(E),$t=!!E&&Zn()&&!pt,he=pt&&$>0?Math.min(st/$,1):0,Oe=pt&&$>0,Ne=Oe&&st>=$;Xs&&(Xs.textContent=Oe?`-${$}`:$t?"\u{1F512}":""),Wt.classList.toggle("no-cost",!Oe&&!$t),Wt.classList.toggle("locked",$t),Wt.classList.toggle("ult-ready",Ne),Wt.style.setProperty("--progress",`${Math.round(he*100)}%`),Wt.classList.remove("hidden",...Ys),Wt.classList.add("active",o),Vs()}function li(t){t&&(t.classList.remove("ult-flash"),t.offsetWidth,t.classList.add("ult-flash"),setTimeout(()=>t.classList.remove("ult-flash"),ii))}function jn(){for(let[t,o]of Object.entries(Ln)){if(!o)continue;let u=ys[t],E=$n(u),$=Zn()&&ke()&&u,st=typeof qn=="function"?qn(u):!0,pt=$&&st&&E>0&&(rt.charges[t]??0)>=E;o.classList.toggle("ult-ready",pt),pt&&!Ws[t]&&(li(o),Ht==="playing"&&U.play("readysuper")),Ws[t]=pt}}function ke(t=Ce){return t==="30_24"?!0:M}function Es(){Hn(rt.active),jn()}function lc(t){M=t,Ce==="25_20"&&(M?rt.reset():(rt.deactivate(),Object.keys(rt.charges).forEach(o=>{rt.charges[o]=0})),On()),Qn(),Es()}function Qn(){Gs&&(Gs.style.display=ke()?"":"none",Hn(rt.active),jn())}function dc(t){let o=wn(t),u=$n(t);return!o||u<=0?!1:rt.charges[o]>=u}function uc(t){let o=wn(t),u=$n(t);return!o||u<=0||rt.charges[o]<u?!1:(rt.charges[o]-=u,rt.updateButtons(),me.pulse(),!0)}let Fn=e.spellWave;function di(){Fn&&(Fn.classList.remove("active"),Fn.offsetWidth,Fn.classList.add("active"),setTimeout(()=>Fn.classList.remove("active"),1200))}let un=null,me=$o({button:Wt,onReady:()=>{U.play("readysuper")}}),ui=()=>me.getEffect("earth"),fi=()=>me.getEffect("air"),gi=()=>me.getEffect("fire"),$n=t=>typeof me?.getCost=="function"?me.getCost(t):0,wn=t=>si[t]??null;un=Go({canvas:n,dom:e,getGrid:()=>v,getN:()=>i,getH:()=>s,getRotFloat:()=>mt,constants:{TOP_PAD_PX:m,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:R,MAX_RADIUS_X:X,SCORE_MAGIC_DESTROY:G},helpers:{normSector:ss,levelYToScreenY:ts,sectorCenterXY:es},Spell:me,Magic:rt,SoundModule:U,State:Ee,isGamePlaying:()=>Ht==="playing",addPendingKzDrop:t=>{He+=t},getKillRate:g,triggerSpellWave:di,spawnSpellBubbles:t=>{let o=wn(me.currentSpell)??"water";at.spawnSpellBubbles(me.button,o,t)},spawnBonusBubbles:t=>{Pn.spawnBonusBubbles(t)},getTransmuteEffect:ui,getLightningEffect:fi,getFireEffect:gi,continueMatchProcessing:ns,updateScoreHud:Xn,showBonus:S,getSpellCost:$n,getSpellElement:wn,onUltimateApplied:t=>{let o=wn(t)??wn(me.currentSpell)??"water";if(typeof at?.spawnSpellBubbles=="function"){let u=ri();u&&at.spawnSpellBubbles(u,o,ci)}zn=!1,Bn=null,Hn(null),jn()},isSpellBlocked:pi,setScore:t=>{fe=t},setCascadeLevel:t=>{cn=t}});function Zn(){return Ce==="30_24"}function Jn(){Hn(rt.active),jn()}let fn=[],Nn=0,sn=!1,vn=!1,An=!1,qe=0,on=0,cn=0,In=[];function pi(){return sn||vn||An}function ts(t,o,u){let E=1-u/s;return t+E*o}function es(t,o,u,E,$,st){let pt=($-st)/i*d+r;return{x:t+Math.cos(pt)*u,y:o+Math.sin(pt)*E,ang:pt}}function bs(t,o){let u=n.clientWidth,E=n.clientHeight,$=u*.5,st=(u-2*R)/2,pt=E-m-b,$t=6,he=i*pt/($t*s),Oe=E-b,Ne,Te,ve;he<=Math.min(st,X)?(Ne=he,Te=pt,ve=m):(Ne=Math.min(st,X),Te=Ne*$t*s/i,ve=Oe-Te);let Nt=Ne*.28,bt=ts(ve,Te,t+.5),ft=es($,bt,Ne,Nt,o,mt),Gt=n.getBoundingClientRect();return{x:Gt.left+ft.x,y:Gt.top+ft.y}}function mi(t,o){if(!ke()||!rt.canUse()||sn)return!1;let u=St[rt.active],E=n.clientWidth,$=n.clientHeight,st=E*.5,pt=(E-2*R)/2,$t=$-m-b,he=6,Oe=i*$t/(he*s),Ne=$-b,Te,ve,Nt;Oe<=Math.min(pt,X)?(Te=Oe,ve=$t,Nt=m):(Te=Math.min(pt,X),ve=Te*he*s/i,Nt=Ne-ve);let bt=Te*.28,ft=null,Gt=1/0;for(let _e=0;_e<s;_e++){let De=ts(Nt,ve,_e+.5);for(let Le=0;Le<i;Le++){let Ge=v[_e][Le];if(!Ge||Ge!==u)continue;let ze=es(st,De,Te,bt,Le,mt);if(Math.sin(ze.ang)<-.1)continue;let gs=t-ze.x,Eo=o-ze.y,bo=Math.hypot(gs,Eo),Mo=ve/s*.9,Vi=Mo*1.2;Math.abs(gs)<Vi/2&&Math.abs(Eo)<Mo/2&&bo<Gt&&(Gt=bo,ft={y:_e,s:Le})}}if(ft){let _e=ts(Nt,ve,ft.y+.5),De=es(st,_e,Te,bt,ft.s,mt),Le=n.getBoundingClientRect(),Ge=Le.left+De.x,ze=Le.top+De.y,So=Ln[rt.active];return at.spawnMagicShot(rt.active,So,Ge,ze,()=>{let gs=v[ft.y][ft.s];fn=[{y:ft.y,s:ft.s,color:gs,isLine:!1,isMagic:!0}],Nn=performance.now(),sn=!0,vn=!0,qe=0,on=G,S(`+${G}`,"score")}),cn=0,rt.useCharge(),ht.magicUsed++,!0}return!1}let fc=100;function gc(t,o){return $s(t,o,s,i)}function hi(){return Vo(v,s,i)}let vi=Ko;function yi(t){let o=t.map(E=>({...E,color:v[E.y][E.s]}));for(let E of t)v[E.y][E.s]=0;let u=s;for(let E of t){let $=E.y;for(let st=1;st<=E.y;st++){let pt=E.y-st;if(v[pt][E.s]){$=st-1;break}}u=Math.min(u,$)}for(let E of o)v[E.y-u][E.s]=E.color;return u>0}function Si(){let t=!0;for(;t;){t=!1;let o=hi();for(let u of o)vi(u)||yi(u)&&(t=!0)}}function Ei(){ns()}let Gn=Yo;function Ks(t,o){let u=new Map,E=0,$=0,st=0,pt={},$t=t.length+o.length;for(let bt of t){let ft=z[bt.color],Gt=0,_e=0;if(bt.length>=5?(Gt=tt,_e=it,ht.lines5++):bt.length===4?(Gt=l,_e=V,ht.lines4++):bt.length===3&&(Gt=Tt,_e=N,ht.lines3++),ke()&&ft&&Gt>0){rt.addCharges(ft,Gt),pt[ft]=(pt[ft]||0)+Gt;let De=bt.cells[Math.floor(bt.cells.length/2)],Le=bs(De.y,De.s),Ge=Ln[ft];for(let ze=0;ze<Gt;ze++)setTimeout(()=>{at.spawnMagicOrb(ft,Le.x,Le.y,Ge)},ze*100)}E+=_e*g(),st+=_e,$+=bt.length*we;for(let De of bt.cells){let Le=`${De.y},${De.s}`;u.has(Le)||u.set(Le,{y:De.y,s:De.s,color:bt.color,isLine:!0})}}for(let bt of o){if(ht.pairs++,E+=Ot*g(),st+=Ot,$+=ce,ke()){let ft=[...new Set(bt.cells.map(Gt=>v[Gt.y][Gt.s]).filter(Boolean))];if(ft.length>0){let Gt=bt.cells[Math.floor(bt.cells.length/2)],_e=bs(Gt.y,Gt.s);ft.forEach((De,Le)=>{let Ge=z[De];if(!Ge)return;rt.addCharges(Ge,Z),pt[Ge]=(pt[Ge]||0)+Z;let ze=Ln[Ge];ze&&setTimeout(()=>{at.spawnMagicOrb(Ge,_e.x,_e.y,ze)},Le*100)})}}for(let ft of bt.cells){let Gt=`${ft.y},${ft.s}`;u.has(Gt)||u.set(Gt,{y:ft.y,s:ft.s,color:v[ft.y][ft.s],isLine:!1})}}let he=Gn(I,$t-1),Oe=Gn(B,$t-1),Ne=Gn(A,cn),Te=Gn(k,cn),ve=Math.round($*he*Ne);st=Math.round(st*Oe*Te),E=Math.round(E*Oe*Te);let Nt=0;$t>1&&(ht.combos++,ht.maxCombo=Math.max(ht.maxCombo,$t),setTimeout(()=>S(`COMBO \xD7${$t}`,"combo"),Nt),Nt+=180,U.play("combo2")),cn>0&&(ht.cascades++,ht.maxCascade=Math.max(ht.maxCascade,cn),setTimeout(()=>S(`CASCADE \xD7${cn}`,"cascade"),Nt),Nt+=180,U.play("cascade")),(t.length>0||o.length>0)&&U.play("combo");for(let bt of t){let ft=bt.length,Gt=ft*we;setTimeout(()=>S(`Line-${ft} +${Gt}`,"line",bt.color),Nt),Nt+=100}for(let bt of o){let ft=bt.cells.length>0?v[bt.cells[0].y][bt.cells[0].s]:null;setTimeout(()=>S(`Pair +${ce}`,"pair",ft),Nt),Nt+=100}ve>0&&(setTimeout(()=>S(`+${ve}`,"score"),Nt),Nt+=120),st>0&&(setTimeout(()=>S(`+${st}s`,"time"),Nt),Nt+=120);for(let[bt,ft]of Object.entries(pt))ft>0&&(setTimeout(()=>S(`+${ft}${lt(bt)}`,"charge"),Nt),Nt+=120);fn=Array.from(u.values()),Nn=performance.now(),sn=!0,vn=!1,qe=E,on=ve,On()}function bi(){for(let t of fn)v[t.y][t.s]=0;if(fn.length>0&&U.playRandom("disappear"),qe>0){He+=qe;let t=qe/g();Pn.spawnBonusBubbles(t)}Ee.addScore(on),fe+=on,Xn(),fn=[],sn=!1,vn=!1,qe=0,on=0,cn++,ns()}function ns(){Si();let{lineMatches:t,pairMatches:o}=Ai();if(t.length>0||o.length>0)Ks(t,o);else{let u=Js();u.length>0?Bi(u):!dt&&Ht==="playing"&&Zs()}}function pc(t,o){Ks(t,o)}function ss(t){return kn(t,i)}function os(){return ss(Math.round(mt))}function qs(t,o){return Ns(dt,t,o,v,s,i)}function is(t){return qs(t,os())}let cs=Wo;function zs(){C&&(wt!==0&&Ue>=wt||(se=0,Ue+=1))}function Mi(){if(!dt)return;let t=dt.cells,o=dt.colors,u={cells:t,colors:o};if(w>=0||(u=cs(u.cells,u.colors),u=cs(u.cells,u.colors)),u=cs(u.cells,u.colors),dt.cells=u.cells,dt.colors=u.colors,!is(Math.floor(Qt))){dt.cells=t,dt.colors=o;return}U.play("turn"),ae&&zs()}function xi(){return qo(dt,Qt,os(),v,s,i)}function Ci(){if(!dt)return!1;let t=Math.floor(Qt)-1,o=!is(t);return o&&!ae?(ae=!0,se=0,Ue=0):!o&&ae&&(ae=!1,se=0,Ue=0),o}let Cn=hs;function Un(){if(Ht==="playing"){mn.classList.add("hidden"),xe.classList.remove("hidden");return}if(mn.classList.remove("hidden"),xe.classList.add("hidden"),Ht==="intro"){x.classList.remove("hidden"),W.classList.add("hidden");let t=h.loadHighscore(Ce);t.score>0?(ne.textContent=t.score.toLocaleString(),le.textContent=Cn(t.time)):(ne.textContent="0",le.textContent="0:00"),Ps(),Pe.textContent=`v${_n}`,ee.classList.remove("idlePulse"),ee.offsetWidth,ee.classList.add("idlePulse")}else{x.classList.add("hidden"),W.classList.remove("hidden"),ut.textContent=fe.toLocaleString(),vt.textContent=Cn(Xe);let t=h.loadHighscore(Ce);fe>0&&fe>=t.score?Re.classList.remove("hidden"):Re.classList.add("hidden");let o=`
        <div class="gameover-stat-row">
          <span class="dots"><span class="ring-icon"></span></span>
          <span class="name">\xD7${ht.rings}</span>
          <span class="count ring-max">${ht.maxRing>0?"max \xD7"+ht.maxRing:""}</span>
        </div>
      `;Bt.innerHTML=o;let u=`
        <div class="gameover-stat-row">
          <span class="dots">\u{1F534}\u{1F534}\u{1F534}</span>
          <span class="name">Line-3</span>
          <span class="count">\xD7${ht.lines3}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F535}\u{1F535}\u{1F535}\u{1F535}</span>
          <span class="name">Line-4</span>
          <span class="count">\xD7${ht.lines4}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}\u{1F7E1}</span>
          <span class="name">Line-5</span>
          <span class="count">\xD7${ht.lines5}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots">\u{1F7E2}\u{1F7E2}\u{1F534}\u{1F534}</span>
          <span class="name">Pair</span>
          <span class="count">\xD7${ht.pairs}</span>
        </div>
      `;yt.innerHTML=u;let E=ke()?`
        <div class="gameover-stat-row">
          <span class="dots">\u2726</span>
          <span class="name">Magic</span>
          <span class="count">\xD7${ht.magicUsed}</span>
        </div>
      `:"",$=`
        <div class="gameover-stat-row">
          <span class="dots bonus-combo">COMBO</span>
          <span class="name">\xD7${ht.combos}</span>
          <span class="count max-combo">${ht.maxCombo>0?"max \xD7"+ht.maxCombo:""}</span>
        </div>
        <div class="gameover-stat-row">
          <span class="dots bonus-cascade">CASCADE</span>
          <span class="name">\xD7${ht.cascades}</span>
          <span class="count max-cascade">${ht.maxCascade>0?"max \xD7"+ht.maxCascade:""}</span>
        </div>
        ${E}
      `;Ft.innerHTML=$}}function Xn(){Je.textContent=`Score: ${fe}`}function Ms(){Ye.textContent=`Time: ${Cn(Xe)}`}function js(){let t=Math.max(0,(s-Yt)/g()),o=Math.floor(t/60),u=Math.floor(t%60);We.textContent=`Left: ${o}:${u.toString().padStart(2,"0")}`,t<30?We.classList.add("warning"):We.classList.remove("warning")}function Ti(){p(Ce),te(),Yt=0,He=0,mt=At=0,Se=0,Ee.start(),ht=Ee.stats,fe=0,En=performance.now(),Xe=0,pn=0,en=0,Ht="playing",Ze=null,ke()?rt.reset():(rt.deactivate(),Object.keys(rt.charges).forEach(t=>{rt.charges[t]=0}),On()),me.reset(),Jn(),fn=[],In=[],sn=!1,vn=!1,An=!1,qe=0,on=0,cn=0,un.reset(),On(),Xn(),Ms(),js(),Es(),Zs(),Pn.drawNextPreview(pe,Ze),Un(),U.getSettings().musicEnabled&&U.startGameMusic()}function xs(){Ee.gameOver(),Ht="gameover",dt=null,ae=!1,se=0,Ue=0;let t=h.saveHighscore(fe,Xe,Ce);U.stopMusic(),U.play("gameover"),Ms(),Un(),t&&fe>0&&setTimeout(()=>{S("\u{1F3C6} NEW RECORD!","score")},500)}function _i(t){for(let u=0;u<50;u++){let E=t.map(()=>1+(Math.random()*4|0));if(!Li(t,E))return E}return t.map((u,E)=>1+E%4)}let Li=Qo;function Qs(t){let o=t.cells.map(E=>({x:E.x,y:E.y})),u=_i(o);return{name:t.name,cells:o,colors:u}}function Zs(){if(!Ze){let $=q[Math.random()*q.length|0];Ze=Qs($)}dt=Ze;let t=q[Math.random()*q.length|0];Ze=Qs(t),Pn.drawNextPreview(pe,Ze);let o=1/0,u=-1/0;for(let $ of dt.cells)$.x<o&&(o=$.x),$.x>u&&(u=$.x);let E=(o+u)/2;for(let $ of dt.cells)$.x=$.x-Math.round(E);Qt=s+3,Zt=0,ae=!1,se=0,Ue=0,is(Math.floor(Qt))?U.playRandom("appear"):xs()}function Js(){return jo(v,s,i)}function Bi(t){if(t.length===0)return;let o=[];for(let $t of t)for(let he=0;he<i;he++)o.push({y:$t,s:he,color:v[$t][he],isLine:!1});In=t,fn=o,Nn=performance.now(),sn=!0,An=!0,vn=!1;let u=t.length;ht.rings+=u,ht.maxRing=Math.max(ht.maxRing,u);let E=Gn(ie,u-1),$=Math.round(Y*u*E),st=de*u;if(on=$,qe=st*g(),ke()){for(let[$t,he]of Object.entries(oe))if(he>0){let Oe=he*u;rt.addCharges($t,Oe);let Ne=Math.floor(i/2),Te=t[0],ve=bs(Te,Ne),Nt=Ln[$t];if(Nt)for(let bt=0;bt<Oe;bt++)setTimeout(()=>{at.spawnMagicOrb($t,ve.x,ve.y,Nt)},bt*100)}}U.play("ring");let pt=`RING \xD7${u}`;S(pt,"ring"),setTimeout(()=>S(`+${$}`,"score"),150),setTimeout(()=>S(`+${st}s`,"time"),300)}function Ri(){let t=[...In].sort((o,u)=>u-o);for(let o of t){for(let u=o;u<s-1;u++)v[u].set(v[u+1]);v[s-1].fill(0)}if(qe>0){He+=qe;let o=qe/g();Pn.spawnBonusBubbles(o)}Ee.addScore(on),fe+=on,Xn(),Ce==="30_24"&&In.length>0&&(ge=h.addHighTowerRings(In.length)),fn=[],In=[],sn=!1,An=!1,qe=0,on=0,ns()}function mc(){return Js().length}function wi(){if(!dt)return;let t=os();mt=t,At=t,Se=0;let o=!1;for(let u=0;u<dt.cells.length;u++){let E=dt.cells[u],$=dt.colors[u],st=Math.floor(Qt)+E.y,pt=ss(t+E.x);st>=s&&(o=!0),st>=0&&st<s&&(v[st][pt]=$)}if(o){xs();return}Ee.addScore(zt),fe+=zt,Xn(),S(`+${zt}`,"score"),U.playRandom("drop"),dt=null,cn=0,Ei()}function Ai(){return zo(v,s,i)}function Ii(){if(!dt)return!1;let t=Math.floor(Qt)-1;return is(t)?(Qt=t,ae=!1,se=0,Ue=0,!0):(ae=!0,!1)}n.addEventListener("pointerdown",t=>{if(kt.state!=="playing")return;t.preventDefault?.();let o=n.getBoundingClientRect(),u=t.clientX-o.left,E=t.clientY-o.top;It.handlePointerDown(t,{onMagicTap:ke()?()=>un.handleTap(u,E)?!0:kt.applyCommand("magic_shoot",{x:u,y:E}):null,onDoubleTap:()=>kt.applyCommand("rotate_piece")},At)||(Se=0)},{passive:!1}),n.addEventListener("pointermove",t=>{if(kt.state!=="playing"||!It.dragging)return;t.preventDefault?.();let o=It.handlePointerMove(t,{canRotateTo:(u,E)=>kt.canRotateTo(u,E),onDrop:()=>kt.applyCommand("move_down"),onGroundedMove:()=>kt.onGroundedMove(),onRotateStep:()=>jt.trigger("tower_rotate")},kt.pieceY,kt.isGrounded);o&&kt.setRotation(o.targetRot)},{passive:!1}),n.addEventListener("pointerup",t=>{kt.state==="playing"&&It.handlePointerUp(t,{onSingleTap:()=>kt.applyCommand("rotate_piece")})},{passive:!1}),n.addEventListener("pointercancel",t=>{It.handlePointerUp(t)},{passive:!1}),n.addEventListener("pointerleave",t=>{It.dragging&&It.handlePointerUp(t)},{passive:!1}),H.addEventListener("click",()=>{kt.state==="playing"&&kt.applyCommand("rotate_piece")});let as=e.dropBtn,rs=null;function Pi(){kt.state==="playing"&&(kt.applyCommand("move_down"),rs=setInterval(()=>{if(kt.state!=="playing"){ls();return}kt.applyCommand("move_down")},Xt))}function ls(){rs&&(clearInterval(rs),rs=null)}as.addEventListener("pointerdown",t=>{t.preventDefault(),Pi()}),as.addEventListener("pointerup",ls),as.addEventListener("pointerleave",ls),as.addEventListener("pointercancel",ls);for(let[t,o]of Object.entries(Ln))o.addEventListener("click",()=>{kt.state==="playing"&&ke()&&kt.applyCommand("select_magic",{element:t})});Wt&&Wt.addEventListener("click",()=>{if(kt.state!=="playing"||!Zn()||!ke())return;let t=rt.active??Bn;if(!t)return;let o=ys[t];!o||!qn(o)||(me.selectSpell(o),rt.active&&(Bn=rt.active,zn=!0,rt.deactivate()),un.handleSpellButtonClick())});let Cs=e.soundsToggle,Ts=e.musicToggle;function yn(){let t=U.getSettings();t.soundsEnabled?Cs.classList.add("active"):Cs.classList.remove("active"),t.musicEnabled?Ts.classList.add("active"):Ts.classList.remove("active");for(let o=0;o<=4;o++){let u=e.soundVolBtns[o],E=e.musicVolBtns[o];u&&u.classList.toggle("active",t.soundVolume===o),E&&E.classList.toggle("active",t.musicVolume===o)}}let to=e.tabBtns,ki=e.tabContents;to.forEach(t=>{t.addEventListener("click",()=>{let o=t.dataset.tab;to.forEach(u=>u.classList.remove("active")),ki.forEach(u=>u.classList.remove("active")),t.classList.add("active"),Io(o).classList.add("active"),o==="sounds"&&yn()})});let eo=/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,no=window.navigator.standalone===!0||window.matchMedia("(display-mode: standalone)").matches,Oi=e.iosHint,Di=e.standaloneBadge;function so(){let t=document.fullscreenElement||document.webkitFullscreenElement;D.textContent=t?"Disable":"Enable"}eo&&(no?(Di.style.display="block",D.style.display="none"):(Oi.style.display="block",D.textContent="Not supported",D.style.opacity="0.5",D.style.cursor="default")),D.addEventListener("click",()=>{if(eo&&!no)return;if(document.fullscreenElement||document.webkitFullscreenElement)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let o=document.documentElement;o.requestFullscreen?o.requestFullscreen():o.webkitRequestFullscreen&&o.webkitRequestFullscreen()}}),document.addEventListener("fullscreenchange",so),document.addEventListener("webkitfullscreenchange",so);let ds=e.invertSwipeToggle,gn=e.hapticsToggle;P.invertSwipe&&ds.classList.add("active"),gn&&(jt.supports()?P.hapticsEnabled&&gn.classList.add("active"):(gn.classList.add("disabled"),gn.classList.remove("active"),P.hapticsEnabled=!1,jt.setEnabled(!1),h.saveGameSettings(P))),ds.addEventListener("click",()=>{ds.classList.toggle("active");let t=ds.classList.contains("active");It.rotDir=t?-1:1,P.invertSwipe=t,h.saveGameSettings(P)}),gn&&gn.addEventListener("click",()=>{if(gn.classList.contains("disabled"))return;gn.classList.toggle("active");let t=gn.classList.contains("active");P.hapticsEnabled=t,h.saveGameSettings(P),jt.setEnabled(t)});let Yn=e.showControlsToggle,Hi=e.controlsRight;function oo(t){Hi.style.display=t?"":"none",xt=t}xt?Yn.classList.add("active"):Yn.classList.remove("active"),oo(xt),Yn.addEventListener("click",()=>{Yn.classList.toggle("active");let t=Yn.classList.contains("active");oo(t),P.showControls=t,h.saveGameSettings(P)});let us=e.tapRotateToggle;Et&&us.classList.add("active"),It.tapRotateEnabled=Et,us.addEventListener("click",()=>{us.classList.toggle("active");let t=us.classList.contains("active");Et=t,It.tapRotateEnabled=t,P.tapRotate=t,h.saveGameSettings(P)}),Cs.addEventListener("click",()=>{let o=!U.getSettings().soundsEnabled;U.updateSettings({soundsEnabled:o}),yn(),Wn()}),Ts.addEventListener("click",()=>{let o=!U.getSettings().musicEnabled;U.updateSettings({musicEnabled:o}),yn(),Wn(),Ht!=="paused"&&(o?Ht==="playing"?U.startGameMusic():U.startMenuMusic():U.stopMusic())});for(let t=0;t<=4;t++){let o=e.soundVolBtns[t];o&&o.addEventListener("click",()=>{U.updateSettings({soundVolume:t}),yn(),U.play("turn")})}for(let t=0;t<=4;t++){let o=e.musicVolBtns[t];o&&o.addEventListener("click",()=>{U.updateSettings({musicVolume:t}),yn()})}yn();function io(){Ht==="playing"&&(Ee.pause(),en=performance.now(),Ht="paused",U.musicAudio&&U.musicAudio.pause())}function fs(){Ht==="paused"&&(Ee.resume(),pn+=performance.now()-en,en=0,Ht="playing",Bs=performance.now(),U.getSettings().musicEnabled&&U.startGameMusic())}function Wn(){let t=U.getSettings();Kt.textContent=t.soundsEnabled?"\u{1F50A}":"\u{1F507}",Kt.classList.toggle("off",!t.soundsEnabled),nn.textContent=t.musicEnabled?"\u{1F3B5}":"\u{1F507}",nn.classList.toggle("off",!t.musicEnabled)}function Fi(){Be.classList.remove("hidden"),xe.classList.add("hidden");let t=h.loadHighscore(Ce);if(Fe.textContent=t.score?t.score.toLocaleString():"0",$e.textContent=t.time?hs(t.time):"0:00",hn.textContent=Ce==="30_24"?"High Tower":"Quick Tower",re.textContent=fe.toLocaleString(),Mn.textContent=hs(Xe),Ae.textContent=Ce==="30_24"?"High Tower":"Quick Tower",Wn(),uo){let o=Ce==="30_24";uo.style.display=o?"":"none",o&&Ps()}}function Vn(){Be.classList.add("hidden"),xe.classList.remove("hidden")}xe.addEventListener("click",()=>{io(),Fi()}),Ve.addEventListener("click",()=>{Vn(),fs()});let _s=null;function co(t,o){T.textContent=t,_s=o,Ie.classList.remove("hidden")}function ao(){Ie.classList.add("hidden"),_s=null}F.addEventListener("click",()=>{ao()}),J.addEventListener("click",()=>{let t=_s;ao(),t&&t()}),an.addEventListener("click",()=>{co("Restart game?",()=>{Vn(),kt.applyCommand("start_game")})}),bn.addEventListener("click",()=>{co("Exit to menu?",()=>{Vn(),xe.classList.add("hidden"),Ht="intro",Ee.reset(),U.stopMusic(),U.getSettings().musicEnabled&&U.startMenuMusic(),Un()})}),rn.addEventListener("click",()=>{O.classList.remove("hidden")}),Kt.addEventListener("click",()=>{let t=U.getSettings();U.updateSettings({soundsEnabled:!t.soundsEnabled}),Wn(),yn()}),nn.addEventListener("click",()=>{let o=!U.getSettings().musicEnabled;U.updateSettings({musicEnabled:o}),Wn(),yn()}),Be.addEventListener("click",t=>{t.target===Be&&(Vn(),fs())}),document.addEventListener("keydown",t=>{Ht==="paused"&&!Be.classList.contains("hidden")&&(t.key==="Escape"||t.key.toLowerCase()==="x")&&(Vn(),fs())}),Q.addEventListener("click",()=>{O.classList.add("hidden")}),O.addEventListener("click",t=>{t.target===O&&O.classList.add("hidden")});let Ls=!1;document.addEventListener("visibilitychange",()=>{document.hidden?Ht==="playing"&&(io(),Ls=!0):Ls&&Ht==="paused"&&(fs(),Ls=!1)});let kt=Zo({getN:()=>i,getH:()=>s,FALL_INTERVAL:Pt,LOCK_DELAY_SEC:Rt,getKillRate:g,MATCH_HIGHLIGHT_SEC:K,MAGIC_SHRINK_SEC:nt,RING_HIGHLIGHT_SEC:Ct,getState:()=>({gameState:Ht,score:fe,elapsedMs:Xe,startTime:En,totalPausedMs:pn,stats:ht,activePiece:dt,pieceY:Qt,targetRot:At,rotFloat:mt,rotVel:Se,isGrounded:ae,isHighlighting:sn,isMagicAnimation:vn,isRingAnimation:An,highlightStartTime:Nn,killLevel:Yt,grid:v,fallTimer:Zt,lockTimer:se}),setState:t=>{"elapsedMs"in t&&(Xe=t.elapsedMs),"killLevel"in t&&(Yt=t.killLevel),"fallTimer"in t&&(Zt=t.fallTimer),"lockTimer"in t&&(se=t.lockTimer),"targetRot"in t&&(At=t.targetRot),"rotFloat"in t&&(mt=t.rotFloat),"rotVel"in t&&(Se=t.rotVel)},funcs:{startGame:Ti,endGame:xs,rotatePieceByDir:Mi,tryMoveDown:Ii,canPlaceAtRot:qs,maybeResetLockDelay:zs,shootMagic:mi,selectMagic:ni,updateGroundedState:Ci,lockPiece:wi,finishHighlight:bi,finishRingHighlight:Ri},ui:{updateTimeHud:Ms,updateRemainingHud:js}}),Pn=Jo({canvas:n,canvasCtx:a,getN:()=>i,getH:()=>s,TOP_PAD_PX:m,BOTTOM_PAD_PX:b,SIDE_MARGIN_PX:R,MAX_RADIUS_X:X,RADIUS_X_FACTOR:j,ANG_OFFSET:r,MATCH_HIGHLIGHT_SEC:K,MATCH_SHRINK_PHASE:et,MAGIC_SHRINK_SEC:nt,RING_HIGHLIGHT_SEC:Ct,LOCK_DELAY_SEC:Rt,getKillRate:g,ELEMENT_COLORS:ot,ELEMENT_TO_COLOR:St,BLOCK_COLOR_FRONT:gt,BLOCK_COLOR_BACK:Ut,ACTIVE_COLOR_FRONT:ye,GHOST_COLOR_FILL:qt,GHOST_COLOR_STROKE:Mt,GHOST_STROKE_WIDTH:Vt,MAGIC_DIM_DOT_ALPHA:Dt,MAGIC_DIM_DOT_SCALE:ue,MAGIC_TARGET_DOT_SCALE:_t,getState:()=>({gameState:Ht,grid:v,activePiece:dt,pieceY:Qt,rotFloat:mt,killLevel:Yt,isHighlighting:sn,highlightedCells:fn,highlightStartTime:Nn,isMagicAnimation:vn,isRingAnimation:An,isGrounded:ae,lockTimer:se,spellState:un.getRenderState()}),getVisualSettings:()=>({waterBubbles:Qe,waterColor:Sn}),funcs:{snappedRot:os,computeGhostY:xi,normSector:ss,getMagicTargetColor:()=>ke()&&rt.canUse()?St[rt.active]:null,getTransmuteAnimState:t=>un.getTransmuteAnimState(t),getLightningAnimState:t=>un.getLightningAnimState(t),getFireAnimState:t=>un.getFireAnimState(t)}}),Bs=performance.now();function ro(t){let o=Math.min(.05,Math.max(.001,(t-Bs)/1e3));if(Bs=t,kt.update(o,t),un.update(t),He>0){let u=Math.min(He,Tn*o);Yt=Math.max(0,Yt-u),He-=u}mt=At,mt>1e6&&(mt%=i),mt<-1e6&&(mt%=i),Pn.render(o,t),requestAnimationFrame(ro)}ee.addEventListener("click",()=>{kt.applyCommand("start_game")}),ln.addEventListener("click",()=>{kt.applyCommand("start_game")}),xn.addEventListener("click",()=>{Ht="intro",Ee.reset(),U.stopMusic(),U.getSettings().musicEnabled&&U.startMenuMusic(),Un()}),Ke.forEach(t=>{t.addEventListener("click",o=>{Ke.forEach(E=>E.classList.remove("active")),t.classList.add("active"),Ce=t.dataset.mode,Jn(),Qn();let u=h.loadHighscore(Ce);u.score>0?(ne.textContent=u.score.toLocaleString(),le.textContent=Cn(u.time)):(ne.textContent="0",le.textContent="0:00"),ee.classList.remove("idlePulse"),clearTimeout(window.__pulseT),window.__pulseT=setTimeout(()=>ee.classList.add("idlePulse"),2e3)})});let Rs=document.querySelectorAll(".spell-select-btn"),ws=document.getElementById("spellDesc"),$i=document.getElementById("spellProgressFill"),lo=document.getElementById("spellProgressMarkers"),uo=document.getElementById("pauseSpellProgress"),Ni=document.getElementById("pauseSpellProgressFill"),fo=document.getElementById("pauseSpellProgressMarkers"),go=document.getElementById("pauseSpellProgressLabel");function As(){return oi.map(t=>Dn(t)).filter(t=>Number.isFinite(t)).sort((t,o)=>t-o)}function Is(t){return t.length?Math.max(...t):0}function Gi(t){let o=As(),u=Is(o);return u<=0?"":`${Math.min(t,u)}/${u}`}function po(t){if(!t)return;t.innerHTML="";let o=As(),u=Is(o);o.forEach(E=>{let $=document.createElement("span");$.className="marker",$.dataset.threshold=E;let st=u>0?E/u*100:0;$.style.left=`${st}%`,t.appendChild($)})}function mo(t,o){if(!t)return;let u=Ui(o);t.style.width=`${u}%`}function ho(t,o){if(!t)return;t.querySelectorAll(".marker").forEach(E=>{let $=parseInt(E.dataset.threshold,10)||0;E.classList.toggle("reached",o>=$)})}function Ui(t){let o=As(),u=Is(o);return t<=0||u<=0?0:t>=u?100:t/u*100}function vo(t){if(!ws)return;let o=Dn(t),u=me.getDescription(t);o===0||ge>=o?ws.innerHTML=u:ws.innerHTML=`${u} <span class="spell-progress-text">${ge}/${o}</span>`}function Ps(){ge=h.loadHighTowerRings(),Rs.forEach(o=>{let u=o.dataset.spell,E=Dn(u),$=ge>=E;o.classList.toggle("locked",!$);let st=o.querySelector(".spell-lock");st&&(st.style.display=$?"none":"")}),mo($i,ge),mo(Ni,ge),ho(lo,ge),ho(fo,ge),go&&(go.textContent=Gi(ge));let t=document.querySelector(".spell-select-btn.active");t&&vo(t.dataset.spell)}po(lo),po(fo),Ps(),Rs.forEach(t=>{t.addEventListener("click",o=>{o.stopPropagation();let u=document.querySelector('.mode-btn[data-mode="30_24"]');if(u&&!u.classList.contains("active")){Ke.forEach($t=>$t.classList.remove("active")),u.classList.add("active"),Ce="30_24",Jn(),Qn();let pt=h.loadHighscore(Ce);pt.score>0?(ne.textContent=pt.score.toLocaleString(),le.textContent=Cn(pt.time)):(ne.textContent="0",le.textContent="0:00")}let E=t.dataset.spell,$=Dn(E),st=ge>=$;vo(E),st&&(Rs.forEach(pt=>pt.classList.remove("active")),t.classList.add("active"),me.selectSpell(E),Hn(rt.active))})}),dn.addEventListener("click",()=>{let t=h.loadHighscore("30_24"),o=h.loadHighscore("25_20"),u=`Records

`;u+=`High Tower (30\xD724):
`,u+=t.score>0?`  Score: ${t.score.toLocaleString()}, Time: ${Cn(t.time)}
`:`  No record yet
`,u+=`
Quick Tower (25\xD720):
`,u+=o.score>0?`  Score: ${o.score.toLocaleString()}, Time: ${Cn(o.time)}
`:`  No record yet
`,alert(u)}),vs.addEventListener("click",()=>{O.classList.remove("hidden")}),On(),Qn(),Jn(),Un(),U.startMenuMusic();let Xi=()=>{if(U.unlock(),!U.getSettings().musicEnabled)return;let t=U.musicAudio;!t||t.paused||t.ended?kt.state==="playing"?U.startGameMusic():U.startMenuMusic():t.play().catch(o=>{console.debug("Music resume on interaction failed:",o)})},yo=0,Yi=10,Wi=()=>{yo>=Yi||(yo++,Xi())};["click","touchstart","keydown","mousedown"].forEach(t=>{document.addEventListener(t,Wi,{passive:!0})}),requestAnimationFrame(ro)})();})();
