<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="manifest.json" />
  <script>
    // Fix iOS standalone PWA viewport + Android fullscreen nav bar
    (function(){
      var isStandalone = (window.navigator.standalone === true) || window.matchMedia('(display-mode: standalone)').matches;
      var isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
      function getH(){
        if(isIOS && isStandalone){
          var isPortrait = window.innerHeight > window.innerWidth;
          return isPortrait ? screen.height : screen.width;
        }
        return window.innerHeight;
      }
      function update(){
        var h = getH();
        var root = document.documentElement;
        root.style.setProperty('--vh', h*0.01+'px');
        // On iOS standalone, --nav-bottom = 0 (env(safe-area-inset-bottom) handles it via CSS)
        // On Android fullscreen, --nav-bottom = screen gap behind nav buttons
        if(!isIOS){
          // Android fullscreen: screen.height may equal innerHeight even when
          // system nav bar overlays content. Use visualViewport if available.
          var visH = (window.visualViewport) ? window.visualViewport.height : window.innerHeight;
          var gap = window.innerHeight - visH;
          // If visualViewport doesn't help, detect standalone and add safe fallback
          if(gap <= 0 && isStandalone) gap = 48;
          root.style.setProperty('--nav-bottom', (gap > 0 ? gap : 0) + 'px');
        }
        var gc = document.getElementById('gameContainer');
        if(gc) gc.style.height = h + 'px';
      }
      update();
      window.addEventListener('resize', update);
      if(window.visualViewport) window.visualViewport.addEventListener('resize', update);
      setTimeout(update,50);setTimeout(update,150);
      document.addEventListener('DOMContentLoaded', update);
    })();
  </script>
  <title>Elemental Blocks MVP</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="helpModal.css" />
  <link rel="icon" href="favicon.ico" />
</head>
<body>
<!-- Game container (sized like other panels on desktop) -->
<div class="game-container" id="gameContainer">
  <canvas id="c"></canvas>
  <!-- Spell wave effect overlay -->
  <div class="spell-wave" id="spellWave"></div>
  <div class="hud" id="hud"></div>
  <div id="remainingHud">Left: 2:00</div>
  <div class="hud-right">
    <div id="scoreHud">Score: 0</div>
    <div id="timeHud">Time: 0:00</div>
    <div id="nextLabel">Next</div>
    <canvas id="nextCanvas" width="72" height="72"></canvas>
  </div>
  <!-- Pause button (replaces settings button during game) -->
  <button class="pause-btn hidden" id="pauseBtn" aria-label="Pause">‚è∏</button>
  <!-- Control buttons -->
  <div class="controls-right">
    <button class="control-btn" id="dropBtn" aria-label="Drop">‚ñº</button>
    <button class="control-btn" id="rotateBtn" aria-label="Rotate">‚ü≥</button>
  </div>
  <!-- Magic buttons -->
  <div class="color-row" id="magicRow" aria-label="Magic">
    <button class="color-btn" id="magicBlue" data-element="water" style="background:radial-gradient(circle, #4da6ff 40%, rgba(14,20,28,0.85) 70%);"><span class="charges">3</span></button>
    <button class="color-btn" id="magicGreen" data-element="earth" style="background:radial-gradient(circle, #47d16a 40%, rgba(14,20,28,0.85) 70%);"><span class="charges">3</span></button>
    <button class="color-btn" id="magicYellow" data-element="lightning" style="background:radial-gradient(circle, #ffd84d 40%, rgba(14,20,28,0.85) 70%);"><span class="charges">3</span></button>
    <button class="color-btn" id="magicRed" data-element="fire" style="background:radial-gradient(circle, #ff4d4d 40%, rgba(14,20,28,0.85) 70%);"><span class="charges">3</span></button>
    <button class="magic-active-indicator hidden" id="magicActiveIndicator" type="button" aria-label="Active magic indicator">
      <div class="magic-active-progress"></div>
      <span class="magic-active-icon" id="magicActiveIcon">üíß</span>
      <span class="magic-active-cost" id="magicActiveCost"></span>
    </button>
  </div>
</div>
<div class="overlay" id="overlay">
  <div class="panel start-panel" id="startPanel">
    <!-- Animated aura background -->
    <div class="menu-aura" aria-hidden="true"></div>
    <!-- Spark layer -->
    <div class="spark-layer" aria-hidden="true"></div>
    
    <!-- Side menu buttons -->
    <div class="side-menu">
      <button class="side-btn" id="startSettingsBtn" aria-label="Settings">‚öô</button>
      <button class="side-btn" id="recordsBtn" aria-label="Records">üèÜ</button>
      <button class="side-btn" id="helpBtn" aria-label="How to play">?</button>
    </div>
    
    <!-- Title -->
    <div class="start-title">
      <h1><span class="title-elemental">Elemental</span><br><span class="title-blocks">Blocks</span></h1>
      <div class="start-subtitle">Close the ring ¬∑ Rise higher</div>
    </div>

    <!-- Stats -->
    <div class="start-stats" id="startStats">
      <div class="stat-row">
        <span class="stat-icon">üèÜ</span>
        <span class="stat-label best-label">Best:</span>
        <span class="stat-value best-value" id="bestScore">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-icon">‚è±</span>
        <span class="stat-label">Survived:</span>
        <span class="stat-value" id="bestTimeVal">0:00</span>
      </div>
    </div>

    <!-- Mode selection -->
    <div class="section-title">Choose tower</div>
    <div class="mode-grid" id="modeGrid">
      <button class="mode-btn active" data-mode="25_20" style="--accRGB:255,216,77">
        <div class="mode-glow" aria-hidden="true"></div>
        <div class="mode-top">
          <div class="mode-name">Quick Tower</div>
        </div>
        <div class="mode-sub">
          <span class="mode-tag acc">25√ó20</span>
          <span class="mode-tag time-tag">3 min</span>
          <span class="mode-tag">Classic</span>
        </div>
      </button>
      <div class="mode-btn mode-btn-extended" data-mode="30_24" style="--accRGB:77,166,255">
        <div class="mode-glow" aria-hidden="true"></div>
        <div class="mode-top">
          <div class="mode-name">High Tower</div>
        </div>
        <div class="mode-sub">
          <span class="mode-tag acc">30√ó24</span>
          <span class="mode-tag time-tag">2 min</span>
          <span class="mode-tag">Magic</span>
        </div>
        <div class="spell-select">
          <button class="spell-select-btn active" data-spell="ice" data-unlock="0" title="Water">
            <span class="spell-select-icon">üíß</span>
          </button>
          <button class="spell-select-btn locked" data-spell="earth" data-unlock="10" title="Earth">
            <span class="spell-select-icon">üåø</span>
            <span class="spell-lock">üîí</span>
          </button>
          <button class="spell-select-btn locked" data-spell="air" data-unlock="30" title="Lightning">
            <span class="spell-select-icon">‚ö°</span>
            <span class="spell-lock">üîí</span>
          </button>
          <button class="spell-select-btn locked" data-spell="fire" data-unlock="40" title="Fire">
            <span class="spell-select-icon">üî•</span>
            <span class="spell-lock">üîí</span>
          </button>
        </div>
        <div class="spell-progress-bar">
          <div class="spell-progress-track">
            <div class="spell-progress-fill" id="spellProgressFill"></div>
          </div>
          <div class="spell-progress-markers" id="spellProgressMarkers">
            <!-- Markers generated dynamically from SPELL_UNLOCK_THRESHOLDS -->
          </div>
        </div>
        <div class="spell-hint">Close rings to unlock spells</div>
        <div class="spell-info">
          <div class="spell-desc" id="spellDesc">Lowers kill zone</div>
        </div>
      </div>
    </div>

    <!-- Start button -->
    <div class="start-actions">
      <button class="start-btn idlePulse" id="startBtn">
        <span class="start-glow"></span>
        <span class="start-text">Start</span>
      </button>
    </div>

    <!-- Version -->
    <div class="start-version" id="startVersion">v0.14.0</div>
  </div>

  <!-- Game Over panel (styled like pause) -->
  <div class="panel gameover-panel hidden" id="gameoverPanel">
    <div class="menu-aura" aria-hidden="true"></div>
    <div class="ringlines" aria-hidden="true"></div>
    
    <div class="gameover-content">
      <div class="gameover-title">GAME OVER</div>
      
      <div class="gameover-score-grid">
        <!-- Final score card -->
        <div class="gameover-score-card final">
          <div class="gameover-score-top">
            <div class="gameover-label">Score</div>
            <div class="gameover-pill">‚è± <span id="goTime">0:00</span></div>
          </div>
          <div class="gameover-big-score" id="goScore">0</div>
          <div class="gameover-record hidden" id="goNewRecord">üèÜ NEW RECORD!</div>
        </div>
        
        <!-- Rings card -->
        <div class="gameover-score-card stats">
          <div class="gameover-stats-title">RINGS</div>
          <div class="gameover-stats-grid" id="goRing"></div>
        </div>
        
        <!-- Matches card -->
        <div class="gameover-score-card stats">
          <div class="gameover-stats-title">MATCHES</div>
          <div class="gameover-stats-grid" id="goMatches"></div>
        </div>
        
        <!-- Bonuses card -->
        <div class="gameover-score-card stats">
          <div class="gameover-stats-title">BONUSES</div>
          <div class="gameover-stats-grid" id="goBonuses"></div>
        </div>
      </div>
      
    </div>
    
    <!-- Bottom action buttons -->
    <div class="gameover-actions">
      <button class="gameover-action-btn" id="goExitBtn" aria-label="Exit to Menu" title="Exit to Menu">‚Üê</button>
      <button class="gameover-action-btn" id="goRestartBtn" aria-label="Restart" title="Restart">‚Üª</button>
    </div>
  </div>
</div>

<!-- Pause overlay -->
<div class="overlay hidden" id="pauseOverlay">
  <div class="panel pause-panel">
    <div class="menu-aura" aria-hidden="true"></div>
    <div class="ringlines" aria-hidden="true"></div>
    
    <!-- Left side buttons (settings, sound, music) -->
    <div class="pause-side-btns">
      <button class="pause-circle" id="pauseSettingsBtn" aria-label="Settings" title="Settings">‚öô</button>
      <button class="pause-circle" id="pauseSoundBtn" aria-label="Sound" title="Sound">üîä</button>
      <button class="pause-circle" id="pauseMusicBtn" aria-label="Music" title="Music">üéµ</button>
    </div>
    
    <!-- Content -->
    <div class="pause-content">
      <div class="pause-title">PAUSED</div>
      
      <div class="pause-score-grid">
        <!-- Best score card -->
        <div class="pause-score-card best">
          <div class="pause-score-top">
            <div class="pause-label">Best</div>
            <div class="pause-pill best">‚è± <span id="pauseBestTime">0:00</span></div>
          </div>
          <div class="pause-big-score" id="pauseBestScore">0</div>
          <div class="pause-meta-row">
            <span>Mode: <small id="pauseBestMode">High Tower</small></span>
          </div>
        </div>
        
        <!-- Current score card -->
        <div class="pause-score-card current">
          <div class="pause-score-top">
            <div class="pause-label">Current</div>
            <div class="pause-pill cur">‚è± <span id="pauseCurrentTime">0:00</span></div>
          </div>
          <div class="pause-big-score" id="pauseCurrentScore">0</div>
          <div class="pause-meta-row">
            <span>Mode: <small id="pauseCurrentMode">High Tower</small></span>
          </div>

          <div class="pause-spell-progress" id="pauseSpellProgress">
            <div class="spell-progress-bar">
              <div class="spell-progress-track">
                <div class="spell-progress-fill" id="pauseSpellProgressFill"></div>
              </div>
              <div class="spell-progress-markers" id="pauseSpellProgressMarkers"></div>
              <div class="spell-progress-label" id="pauseSpellProgressLabel"></div>
            </div>
            <div class="spell-hint">Close rings to unlock spells</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bottom action buttons (positioned absolute to panel) -->
    <div class="pause-actions">
      <button class="pause-action-btn" id="exitToMenuBtn" aria-label="Exit to Menu" title="Exit to Menu">‚Üê</button>
      <button class="pause-action-btn" id="restartBtn" aria-label="Restart" title="Restart">‚Üª</button>
      <button class="pause-action-btn" id="resumeBtn" aria-label="Resume" title="Resume">‚ñ∂</button>
    </div>
    
    <!-- Confirmation dialog -->
    <div class="confirm-dialog hidden" id="confirmDialog">
      <div class="confirm-box">
        <div class="confirm-text" id="confirmText">Are you sure?</div>
        <div class="confirm-buttons">
          <button class="confirm-btn cancel" id="confirmCancel" aria-label="Cancel">‚úï</button>
          <button class="confirm-btn ok" id="confirmOk" aria-label="Confirm">‚úì</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings overlay -->
<div class="overlay hidden" id="settingsOverlay">
  <div class="panel settings-panel">
    <div class="menu-aura" aria-hidden="true"></div>
    <div class="ringlines" aria-hidden="true"></div>
    
    <div class="settings-content">
      <div class="settings-title">SETTINGS</div>
      
      <div class="settings-tabs">
        <button class="tab-btn active" data-tab="controls">General</button>
        <button class="tab-btn" data-tab="sounds">Sounds</button>
      </div>

      <div class="tab-content active" id="tab-controls">
        <div class="settings-row">
          <span class="settings-label">Show control buttons</span>
          <div class="toggle-switch active" id="showControlsToggle"></div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Single tap to rotate block</span>
          <div class="toggle-switch" id="tapRotateToggle"></div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Invert swipe direction</span>
          <div class="toggle-switch" id="invertSwipeToggle"></div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Vibration</span>
          <div class="toggle-switch" id="hapticsToggle"></div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Fullscreen mode</span>
          <button class="settings-action-btn" id="fullscreenBtn">Enable</button>
        </div>
        <div id="iosHint" class="ios-hint" style="display:none;">
          <b>üì± iOS Safari:</b> Tap <b>Share</b> ‚Üí <b>Add to Home Screen</b> to run in fullscreen mode.
        </div>
        <div id="standaloneBadge" class="standalone-badge" style="display:none;">
          ‚úì Running in standalone mode
        </div>
      </div>

      <div class="tab-content" id="tab-sounds">
        <div class="settings-row">
          <span class="settings-label">Sounds</span>
          <div class="toggle-switch" id="soundsToggle"></div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Music</span>
          <div class="toggle-switch" id="musicToggle"></div>
        </div>
        <div class="settings-row settings-row-sep">
          <span class="settings-label">Sound Volume</span>
          <div class="volume-control">
            <button class="volume-btn" data-volume="0" id="soundVol0">0</button>
            <button class="volume-btn" data-volume="1" id="soundVol1">1</button>
            <button class="volume-btn" data-volume="2" id="soundVol2">2</button>
            <button class="volume-btn" data-volume="3" id="soundVol3">3</button>
            <button class="volume-btn" data-volume="4" id="soundVol4">4</button>
          </div>
        </div>
        <div class="settings-row">
          <span class="settings-label">Music Volume</span>
          <div class="volume-control">
            <button class="volume-btn" data-volume="0" id="musicVol0">0</button>
            <button class="volume-btn" data-volume="1" id="musicVol1">1</button>
            <button class="volume-btn" data-volume="2" id="musicVol2">2</button>
            <button class="volume-btn" data-volume="3" id="musicVol3">3</button>
            <button class="volume-btn" data-volume="4" id="musicVol4">4</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Close button at bottom -->
    <div class="settings-actions">
      <button class="settings-action-circle" id="settingsClose" aria-label="Close" title="Close">‚úï</button>
    </div>
  </div>
</div>

<script src="bundle.js"></script>
</body>
</html>
